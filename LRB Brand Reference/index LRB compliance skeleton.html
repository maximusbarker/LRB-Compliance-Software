<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LRB Compliance Database</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="Pictures/lrb-circle-outlined.png" data-static="true">
            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #00B0F0;
            --primary-blue-dark: #00B0F0;
            --primary-blue-light: #00B0F0;
            --secondary-blue: #00B0F0;
            --accent-blue: #00B0F0;
            --success-green: #10b981;
            --warning-yellow: #f59e0b;
            --error-red: #ef4444;
            --neutral-gray: #6b7280;
            --light-gray: #f3f4f6;
            --border-gray: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #374151;
            --text-muted: #6b7280;
            --bg-primary: #ffffff;
            --bg-secondary: #eef1f4;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --border-radius: 8px;
            --border-radius-lg: 12px;
            --font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            height: 100%;
            background: transparent;
        }

        body {
            font-family: var(--font-family);
            background: transparent !important;
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 14px;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        
        header {
            background: transparent !important;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
            background: transparent;
        }

        .header .container {
            max-width: none;
            margin: 0;
            padding: 0 24px;
            background: transparent !important;
        }

        .header-wrapper {
            position: sticky;
            top: 0;
            z-index: 500;
            background: #fff;
            box-shadow: 0 6px 18px rgb(15 23 42 / 0.08);
        }
        .header {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }
        .header-wrapper.hidden {
            display: none;
        }
        .header.hidden {
            display: none;
        }
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: nowrap;
            width: 100%;
        }
        .header-tabs {
            flex: 1 1 auto;
            display: flex;
            justify-content: center;
            min-width: 0;
        }

        .title-banner {
            background: var(--bg-secondary);
            border-radius: var(--border-radius-lg);
            padding: 32px;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
            background: transparent;
            margin: 0;
        }
        
        .logo {
            background: transparent !important;
        }
        
        /* Ensure no white space from header */
        .header * {
            background: transparent !important;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo img {
            height: 48px;
            width: auto;
            border-radius: 0;
            object-fit: contain;
        }

        .logo-text {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .main-content {
            padding: 110px 0 32px;
            min-height: 100vh;
            position: relative;
            margin-bottom: 0;
            background: transparent;
        }
        
        .profile-control {
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            min-width: 120px;
            justify-content: flex-end;
        }
        .profile-control.hidden {
            display: none;
        }
        .profile-dot {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 1px solid rgba(15, 23, 42, 0.12);
            background: #fff;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 10px 25px rgb(15 23 42 / 0.15);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .profile-dot:hover {
            transform: translateY(-1px);
            box-shadow: 0 15px 30px rgb(15 23 42 / 0.2);
        }
        .profile-tooltip {
            background: rgba(17, 24, 39, 0.9);
            color: #fff;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.4;
            box-shadow: 0 10px 30px rgb(0 0 0 / 0.25);
            opacity: 0;
            transform: translateY(-8px);
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            position: absolute;
            top: -52px;
            right: 0;
        }
        .profile-tooltip span {
            display: block;
            font-weight: 500;
            margin-top: 2px;
        }
        .profile-control:hover .profile-tooltip {
            opacity: 1;
            transform: translateY(0);
        }
        .profile-menu {
            position: absolute;
            top: 56px;
            right: 0;
            background: #fff;
            border-radius: 16px;
            border: 1px solid rgba(15, 23, 42, 0.08);
            box-shadow: 0 25px 45px rgb(15 23 42 / 0.18);
            width: 240px;
            overflow: hidden;
        }
        .profile-menu.hidden {
            display: none;
        }
        .profile-menu-header {
            display: flex;
            gap: 12px;
            padding: 16px;
            border-bottom: 1px solid rgba(15, 23, 42, 0.08);
            background: var(--bg-secondary);
        }
        .profile-initial {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(0, 176, 240, 0.15);
            color: var(--primary-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 18px;
        }
        .profile-menu-title {
            font-weight: 600;
            color: var(--text-primary);
        }
        .profile-menu-email {
            font-size: 13px;
            color: var(--text-secondary);
        }
        .profile-menu-body {
            display: flex;
            flex-direction: column;
            padding: 8px;
            gap: 8px;
        }
        .profile-menu-btn {
            border: none;
            border-radius: 10px;
            padding: 10px 14px;
            text-align: left;
            cursor: pointer;
            font-weight: 500;
            background: rgba(15, 23, 42, 0.04);
            transition: background 0.2s ease, color 0.2s ease;
        }
        .profile-menu-btn:hover {
            background: rgba(0, 176, 240, 0.15);
            color: var(--primary-blue);
        }
        .profile-menu-btn.danger {
            background: rgba(220, 38, 38, 0.08);
            color: #b91c1c;
        }
        .profile-menu-btn.danger:hover {
            background: rgba(220, 38, 38, 0.18);
        }

        .landing-video-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .landing-video-background.visible {
            opacity: 1;
        }

        .main-content.landing-background {
            background: transparent;
        }

        .main-content > .container {
            position: relative;
            z-index: 2;
            background: transparent;
        }

        .card {
            background: var(--bg-primary);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-gray);
            overflow: hidden;
        }

        .card-header {
            padding: 24px 32px;
            border-bottom: 1px solid var(--border-gray);
            background: var(--bg-secondary);
        }

        .card-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .card-body {
            padding: 32px;
        }

        /* Full-width section headers and bodies */
        .main-container .card-header,
        .internal-container .card-header,
        .internal-data-request-container .card-header,
        #account-management-container .card-header {
            padding: 24px 40px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-gray);
            margin: 0;
        }

        .main-container .card-body,
        .internal-container .card-body,
        .internal-data-request-container .card-body,
        #account-management-container .card-body {
            padding: 32px 40px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            font-weight: 500;
            font-size: 14px;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-blue-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-gray);
        }

        .btn-secondary:hover {
            background: var(--light-gray);
            border-color: var(--neutral-gray);
        }

        .btn-success {
            background: var(--success-green);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--error-red);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-gray);
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: all 0.2s ease;
            background: var(--bg-primary);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px var(--primary-blue-light);
        }

        /* Accessible focus states */
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible,
        button:focus-visible,
        a:focus-visible {
            outline: 2px solid var(--primary-blue);
            outline-offset: 2px;
            box-shadow: none;
        }


        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        .table-container {
            background: var(--bg-primary);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-gray);
            max-height: 600px;
            position: relative;
        }
        
        .table-container table {
            width: 100%;
            display: table;
        }
        
        .table-container > div:has(table) {
            max-height: 600px;
            overflow-y: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: var(--primary-blue);
            color: white;
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid var(--border-gray);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table td {
            padding: 16px 12px;
            border-bottom: 1px solid var(--border-gray);
            color: var(--text-secondary);
            font-size: 14px;
        }

        .table.master-rates-table {
            table-layout: fixed;
        }

        .table.master-rates-table th,
        .table.master-rates-table td {
            padding: 10px 12px;
            font-size: 13px;
            white-space: normal;
            word-break: break-word;
        }

        .table.master-rates-table td.numeric {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .project-group-header td {
            background: #f1f5f9;
            font-weight: 600;
            color: var(--text-primary);
        }

        .project-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .project-meta span {
            color: var(--text-secondary);
        }

        .project-meta strong {
            color: var(--text-primary);
            font-size: 12px;
        }

        .master-filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
        }

        .master-filter {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: #fff;
            border: 1px solid var(--border-gray);
            border-radius: 999px;
            padding: 6px 14px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            color: var(--text-secondary);
        }

        .master-filter select {
            border: none;
            background: transparent;
            font-size: 14px;
            color: var(--text-primary);
            padding-right: 18px;
            appearance: none;
            min-width: 150px;
        }

        .master-filter select:focus {
            outline: none;
        }

        .master-filter .caret {
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 6px solid var(--text-secondary);
            pointer-events: none;
            margin-left: -14px;
        }

        .table tbody tr:hover {
            background: var(--light-gray);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-ready {
            background: #dcfce7;
            color: #166534;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-needed {
            background: #fee2e2;
            color: #991b1b;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            max-width: 400px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .password-input {
            width: 100%;
            max-width: 250px;
            margin: 0 auto 24px auto;
            display: block;
        }

        .modal-login-btn {
            padding: 12px 32px;
            font-size: 16px;
            font-weight: 600;
            min-width: 120px;
        }

        /* Human check puzzle */
        .puzzle-wrapper {
            margin-top: 12px;
            padding: 12px;
            border: 1px solid var(--border-gray);
            border-radius: 8px;
            background: #f8fafc;
        }
        .puzzle-stage {
            position: relative;
            width: 320px;
            height: 120px;
            border: 1px dashed var(--border-gray);
            border-radius: 8px;
            margin: 8px 0 12px 0;
            overflow: hidden;
            background: #e5f5ff;
        }
        .puzzle-bg, .puzzle-piece {
            position: absolute;
            top: 0;
            left: 0;
            width: 320px;
            height: 120px;
            background-image: url('Pictures/LRB White Out.png');
            background-repeat: no-repeat;
            background-size: 220px auto;
            background-position: center;
            opacity: 0.9;
            z-index: 1;
        }
        .puzzle-piece {
            width: 100px;
            height: 120px;
            background-size: 220px auto;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            border-radius: 6px;
            background-color: rgba(255,255,255,0.8);
            mix-blend-mode: multiply;
            z-index: 2;
        }
        .puzzle-flash {
            position: absolute;
            inset: 0;
            background: rgba(255,215,0,0.9);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.18s ease;
            z-index: 3;
        }
        .puzzle-flash.visible {
            opacity: 1;
        }
        .puzzle-flash.fade {
            opacity: 0;
        }
        .puzzle-status {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .puzzle-toast {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #b45309;
            background: rgba(255, 215, 0, 0.18);
            border-radius: 8px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.18s ease;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            z-index: 4;
        }
        .puzzle-toast.visible {
            opacity: 1;
        }

        .modal-header {
            padding: 24px 32px;
            border-bottom: 1px solid var(--border-gray);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-body {
            padding: 32px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--primary-blue);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius);
        }

        .modal-close:hover {
            background: var(--primary-blue-light);
            color: var(--primary-blue-dark);
        }

        .tabs {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            border-radius: 999px;
            padding: 6px;
            gap: 8px;
            box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.08), 0 6px 15px rgba(15, 23, 42, 0.08);
        }

        .tab {
            padding: 12px 28px;
            border-radius: 999px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: none;
            color: var(--text-secondary);
            border: 1px solid transparent;
            min-width: 180px;
            text-align: center;
        }

        .tab.active {
            background: var(--primary-blue) !important;
            color: #fff !important;
            box-shadow: 0 12px 30px rgb(0 176 240 / 0.35);
            border-color: transparent;
        }

        .tab:hover:not(.active) {
            background: rgba(15, 23, 42, 0.08);
            color: var(--text-primary);
            border-color: rgba(15, 23, 42, 0.08);
        }

        .controls {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
        }

        .filter-group {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .hidden {
            display: none !important;
        }

        /* Legacy compatibility styles */
        .landing-container, .login-container {
            max-width: 900px;
            margin: 60px auto;
            background: var(--bg-primary);
            padding: 40px 30px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-gray);
        }

        .landing-container {
            text-align: center;
            padding: 64px 32px;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            position: relative;
        }

        /* Ensure text remains readable */
        .landing-container h1,
        .landing-container h2,
        .landing-container p {
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }

        /* Ensure buttons remain prominent */
        .landing-container .landing-btn {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 1;
        }

        .main-container, .internal-container, .internal-data-request-container, #account-management-container {
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 0;
            background: transparent;
            border: none;
            box-shadow: none;
        }
        
        /* Ensure content is visible when container is shown */
        .internal-data-request-container:not(.hidden),
        #account-management-container:not(.hidden) {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            min-height: 200px;
        }
        
        .internal-data-request-container:not(.hidden) .card-body,
        #account-management-container:not(.hidden) .card-body {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .internal-data-request-container:not(.hidden) form,
        #account-management-container:not(.hidden) .card-body > * {
            display: block !important;
            visibility: visible !important;
        }

        .accounts-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .accounts-table th,
        .accounts-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-gray);
        }

        .accounts-table th {
            background-color: var(--primary-blue);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .accounts-table tr:hover {
            background-color: var(--bg-secondary);
        }

        .password-display {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .password-masked {
            font-family: monospace;
            letter-spacing: 2px;
        }

        .account-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .account-details-section {
            margin-bottom: 32px;
        }

        .account-details-section h4 {
            margin-bottom: 16px;
            color: var(--primary-blue);
        }

        .submission-item,
        .draft-item {
            padding: 12px;
            border: 1px solid var(--border-gray);
            border-radius: 4px;
            margin-bottom: 8px;
            background: var(--bg-primary);
        }

        .submission-item:hover,
        .draft-item:hover {
            background: var(--bg-secondary);
        }

        .landing-container h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .landing-container p {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 48px;
        }

        .landing-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            letter-spacing: 0.5px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 220px;
            display: inline-block;
            box-shadow: 0 4px 14px rgba(0, 176, 240, 0.3), 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .landing-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .landing-btn:hover::before {
            left: 100%;
        }

        .landing-btn:hover {
            background: var(--primary-blue);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 24px rgba(0, 176, 240, 0.4), 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .landing-btn:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 2px 8px rgba(0, 176, 240, 0.3);
        }

        .tab-bar {
            display: flex;
            justify-content: flex-end;
            gap: 16px;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .site-logo {
            position: absolute;
            top: 18px;
            left: 24px;
            max-width: 48px;
            max-height: 48px;
            width: 48px;
            height: 48px;
            z-index: 100;
            background: var(--bg-primary);
            border-radius: 50%;
            box-shadow: var(--shadow-md);
            object-fit: contain;
        }

        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            background: var(--primary-blue);
            color: white;
            padding: 18px 32px;
            border-radius: var(--border-radius);
            font-size: 16px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: none;
        }

        /* Form styling */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px 16px;
        }

        /* Compact grid for small numeric fields */
        .compact-grid {
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px 12px;
        }

        .project-grid .full-span {
            grid-column: 1 / -1;
        }

        .project-grid-two {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 12px 16px;
            margin-bottom: 12px;
        }

        .development-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px 16px;
        }

        .compact-grid .form-row input,
        .compact-grid .form-row select {
            max-width: 100%;
        }

        .form-row {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        input[type="text"], input[type="number"], input[type="url"], textarea, select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-gray);
            border-radius: var(--border-radius);
            margin-bottom: 0;
            font-size: 14px;
            background: var(--bg-primary);
            transition: all 0.2s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px var(--primary-blue-light);
        }

        textarea {
            min-height: 60px;
            resize: vertical;
        }

        select {
            background-image: url('data:image/svg+xml;utf8,<svg fill="%236b7280" height="20" viewBox="0 0 20 20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M7.293 7.293a1 1 0 011.414 0L10 8.586l1.293-1.293a1 1 0 111.414 1.414l-2 2a1 1 0 01-1.414 0l-2-2a1 1 0 010-1.414z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 18px 18px;
            padding-right: 40px;
            appearance: none;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0 0 0;
        }

        /* Project area styling */
        .project-area {
            background: #eef1f4; /* darker for contrast */
            border: 1px solid var(--border-gray);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-sm);
            padding: 32px 24px;
            margin-bottom: 30px;
        }

        .section-title {
            font-family: 'Open Sans', sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-blue);
            margin: 30px 0 15px 0;
            border-bottom: 1px solid var(--primary-blue);
            padding-bottom: 8px;
        }

        /* Input styles */
        input, textarea, select {
            font-family: 'Open Sans', sans-serif;
        }

        /* Button styles */
        .btn, .add-btn, .save-btn, .logout-btn, .internal-btn, .back-btn, .landing-btn, .internal-db-action-btn, .internal-db-actions-btn, .view-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin: 30px 0 0 0;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn:hover, .add-btn:hover, .save-btn:hover, .logout-btn:hover, .internal-btn:hover, .back-btn:hover, .landing-btn:hover, .internal-db-action-btn:hover, .internal-db-actions-btn:hover, .view-btn:hover {
            background: var(--primary-blue-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .logout-btn, .internal-btn {
            float: right;
            margin: 0 0 20px 10px;
            padding: 10px 24px;
            font-size: 14px;
        }

        /* Status styles */
        .internal-db-status {
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 20px;
            display: inline-block;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .internal-db-status-pending { background: #fef3c7; color: #92400e; }
        .internal-db-status-approved, .internal-db-status-ready { background: #dcfce7; color: #166534; }
        .internal-db-status-rejected, .internal-db-status-internal-needed { background: #fee2e2; color: #991b1b; }
        .internal-db-status-multiple { background: #fef3c7; color: #92400e; }
        .internal-db-status-none { background: var(--neutral-gray); color: white; }
        .status-submitted { background: #dcfce7; color: #166534; }
        .status-ready { background: #dcfce7; color: #166534; }
        .status-internal-needed { background: #fee2e2; color: #991b1b; }
        .status-external-needed { background: #fef3c7; color: #92400e; }

        /* Table styles */
        .table-container {
            margin-top: 40px;
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--bg-primary);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        th, td {
            border-bottom: 1px solid var(--border-gray);
            padding: 16px 12px;
            text-align: left;
        }

        th {
            background: var(--primary-blue);
            color: white;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* Internal database controls */
        .internal-db-controls {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        #internal-db-filter-year {
            width: 160px;
            min-width: 160px;
            max-width: 160px;
        }

        #internal-db-search {
            width: 320px;
            min-width: 120px;
            max-width: 340px;
        }

        #internal-db-filter-status {
            width: 180px;
            min-width: 90px;
            max-width: 180px;
        }

        .internal-db-controls input[type="text"],
        .internal-db-controls select {
            height: 44px;
            padding: 12px 16px;
            font-size: 14px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-gray);
            background: var(--bg-primary);
            box-sizing: border-box;
            margin-bottom: 0;
            display: inline-block;
            vertical-align: middle;
        }

        .internal-db-controls select {
            background-position: right 12px center;
            padding-right: 40px;
        }

        /* External table container */
        .external-table-container {
            overflow-x: auto;
            max-width: 100%;
        }

        #project-table {
            min-width: 1200px;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: 0 16px;
            }
            
            .card-body {
                padding: 24px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                min-width: auto;
            }

            .site-logo { 
                left: 8px; 
                top: 8px; 
                max-width: 36px; 
                max-height: 36px; 
                width: 36px; 
                height: 36px; 
            }

            .landing-container { 
                padding: 24px 16px; 
            }

            .main-container .card-header,
            .internal-container .card-header,
            .internal-data-request-container .card-header,
            #account-management-container .card-header {
                padding: 20px 16px;
            }

            .main-container .card-body,
            .internal-container .card-body,
            .internal-data-request-container .card-body,
            #account-management-container .card-body {
                padding: 24px 16px;
            }
            
            .form-grid { 
                grid-template-columns: 1fr; 
                gap: 18px; 
            }
        }

        /* ðŸŽ¨ MODERN PDF REPORT STYLES */
        .pdf-report {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: #ffffff;
            max-width: 8.5in;
            margin: 0 auto;
            padding: 0;
        }

        /* Cover Page Styles */
        .pdf-cover {
            background: #00B0F0;
            color: white;
            padding: 60px 40px;
            text-align: center;
            min-height: 11in;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .pdf-cover::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .pdf-cover-content {
            position: relative;
            z-index: 2;
        }

        .pdf-logo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 40px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 4px solid rgba(255,255,255,0.2);
        }

        .pdf-title {
            font-size: 3rem;
            font-weight: 700;
            margin: 0 0 20px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .pdf-subtitle {
            font-size: 1.5rem;
            font-weight: 300;
            margin: 0 0 40px;
            opacity: 0.9;
        }

        .pdf-entity {
            font-size: 2rem;
            font-weight: 600;
            margin: 0 0 30px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .pdf-date {
            font-size: 1rem;
            opacity: 0.8;
            margin: 40px 0 0;
        }

        /* Page Styles */
        .pdf-page {
            background: white;
            padding: 40px;
            min-height: 11in;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* Section Headers */
        .pdf-section-header {
            background: #00B0F0;
            color: white;
            padding: 20px 30px;
            margin: -40px -40px 30px -40px;
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .pdf-section-icon {
            font-size: 1.8rem;
        }

        /* Data Cards */
        .pdf-data-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }

        .pdf-data-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .pdf-card-header {
            font-size: 1.2rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pdf-card-icon {
            width: 24px;
            height: 24px;
            background: #00B0F0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        /* Tables */
        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .pdf-table th {
            background: #00B0F0;
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .pdf-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.85rem;
        }

        .pdf-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .pdf-table tr:hover {
            background: #00B0F0;
        }

        /* Typography */
        .pdf-h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 0 0 20px;
            line-height: 1.2;
        }

        .pdf-h2 {
            font-size: 2rem;
            font-weight: 600;
            color: #34495e;
            margin: 30px 0 15px;
            line-height: 1.3;
        }

        .pdf-h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #495057;
            margin: 25px 0 10px;
            line-height: 1.4;
        }

        .pdf-text {
            font-size: 0.95rem;
            line-height: 1.6;
            margin: 0 0 15px;
            color: #6c757d;
        }

        /* Status Badges */
        .pdf-status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pdf-status-ready {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .pdf-status-pending {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: white;
        }

        .pdf-status-error {
            background: linear-gradient(135deg, #dc3545, #e74c3c);
            color: white;
        }

        /* Footer */
        .pdf-footer {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 40px;
            margin: 40px -40px -40px -40px;
            text-align: center;
            font-size: 0.9rem;
        }

        /* Print Styles */
        @media print {
            .pdf-report {
                max-width: none;
                margin: 0;
                padding: 0;
            }
            
            .pdf-page {
                page-break-after: always;
                box-shadow: none;
                margin: 0;
                padding: 40px;
            }
            
            .pdf-page:last-child {
                page-break-after: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="header-wrapper hidden">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <img src="Pictures/LRB White Out.png" alt="LRB Logo">
                </div>
                <div class="header-tabs">
                    <div id="tab-bar" class="tabs hidden">
                        <button id="external-tab-btn" class="tab">External Data Request</button>
                        <button id="internal-tab-btn" class="tab">Internal Database</button>
                        <button id="internal-data-tab-btn" class="tab">Internal Data Request</button>
                        <button id="account-management-tab-btn" class="tab" style="display: none;">Account Management</button>
                    </div>
                </div>
                <div id="profile-control" class="profile-control hidden">
                    <div class="profile-tooltip" id="profile-tooltip">
                        <strong>LRB Account</strong>
                        <span id="profile-tooltip-email">user@example.com</span>
                    </div>
                    <button id="profile-button" class="profile-dot" aria-label="LRB Account"></button>
                    <div id="profile-menu" class="profile-menu hidden">
                        <div class="profile-menu-header">
                            <div class="profile-initial" id="profile-initial">R</div>
                            <div>
                                <div class="profile-menu-title">LRB Account</div>
                                <div class="profile-menu-email" id="profile-menu-email">user@example.com</div>
                            </div>
                        </div>
                        <div class="profile-menu-body">
                            <button type="button" id="profile-edit-email-btn" class="profile-menu-btn">Edit Email</button>
                            <button type="button" id="profile-change-password-btn" class="profile-menu-btn">Change Password</button>
                            <button type="button" id="profile-logout-btn" class="profile-menu-btn danger">Logout</button>
                        </div>
                    </div>
                </div>
            </div>
        </header>
    </div>

    <main class="main-content">
        <video id="landing-video" class="landing-video-background" autoplay muted playsinline>
            <source src="Pictures/LRB Transparent Video.mp4" type="video/mp4">
        </video>
        <div class="container">
            <!-- Landing Page -->
            <div id="landing-container" class="landing-container">
                <div style="display:flex; flex-direction:column; align-items:center; gap:24px; margin-bottom:32px;">
                    <img src="Pictures/lrb_public_finance_advisors_logo.jpg" alt="LRB" style="width:80px; height:80px; border-radius:50%; object-fit:cover; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <h2 style="margin:0; font-size:24px; font-weight:500; color: #FFFFFF; text-shadow: 2px 2px 4px rgba(0,0,0,0.8), 0 0 8px rgba(0,0,0,0.5), -1px -1px 2px rgba(0,0,0,0.8);">Select the Client Portal to login or create your LRB account.</h2>
                </div>
                <div style="display: flex; gap: 24px; justify-content: center; flex-wrap: wrap; margin-top: 24px;">
                    <button id="external-role-btn" class="landing-btn" style="background: var(--primary-blue); color: white;">Client Portal</button>
                </div>
            </div>

<!-- Human check modal -->
<div id="puzzle-modal" class="modal hidden">
    <div class="modal-content" style="max-width: 420px;">
        <div class="modal-header" style="display:flex; align-items:center; gap:12px; justify-content:space-between;">
            <div style="display:flex; align-items:center; gap:10px;">
                <img src="Pictures/lrb-circle-outlined.png" alt="LRB" style="width:40px; height:40px; border-radius:50%; object-fit:contain; background:#fff; padding:4px;">
                <h3 class="modal-title" style="margin:0;">Quick check before we submit</h3>
            </div>
            <button class="modal-close" id="puzzle-cancel" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body" style="padding: 24px;">
            <p style="margin:0 0 12px 0; color: var(--text-secondary);">Give the logo its missing piece to finish.</p>
            <div class="puzzle-wrapper" style="margin-top: 0;">
                <div class="puzzle-stage">
                    <div class="puzzle-bg"></div>
                    <div class="puzzle-piece" id="puzzle-piece" style="left:0;"></div>
                    <div class="puzzle-flash" id="puzzle-flash"></div>
                    <div class="puzzle-toast" id="puzzle-toast">Account Submitted</div>
                </div>
                <input type="range" id="puzzle-slider" min="0" max="100" value="0" style="width:100%;">
                <div id="puzzle-status" class="puzzle-status">Slide until the logo looks whole.</div>
            </div>
            <div id="puzzle-hint" class="puzzle-status" style="margin-top:8px;">When it lines up, we'll lock in your submission.</div>
        </div>
    </div>
</div>

<!-- Signup Success Modal -->
<div id="signup-success-modal" class="modal hidden">
    <div class="modal-content" style="max-width: 500px; text-align: center;">
        <div class="modal-body" style="padding: 40px 32px;">
            <div id="signup-success-message" style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px; line-height: 1.5;"></div>
            <div id="signup-success-countdown" style="font-size: 14px; color: var(--text-secondary); margin-top: 24px;"></div>
        </div>
    </div>
</div>

            <!-- Client Login Page -->
            <div id="client-login-container" class="hidden">
                <div class="card" style="max-width: 450px; margin: 60px auto;">
                    <div class="card-header">
                        <h2 class="card-title">Client Portal Login</h2>
                    </div>
                    <div class="card-body">
                        <form id="client-login-form">
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label for="client-username" style="display: block; margin-bottom: 8px; font-weight: 500;">Username or Email:</label>
                                <input type="text" id="client-username" class="form-control" placeholder="Enter your username or email" required>
                            </div>
                            <div class="form-group" style="margin-bottom: 24px;">
                                <label for="client-password" style="display: block; margin-bottom: 8px; font-weight: 500;">Password:</label>
                                <input type="password" id="client-password" class="form-control" placeholder="Enter your password" required>
                            </div>
                            <div id="client-login-error" class="hidden" style="color: var(--error-red); margin-bottom: 16px; padding: 12px; background: rgba(220, 53, 69, 0.1); border-radius: 4px;"></div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                            <div style="margin-top: 16px; text-align: center; display:flex; flex-direction:column; gap:8px; color: var(--text-secondary);">
                                <small>Don't have an account?</small>
                                <button type="button" id="show-signup-btn" class="btn btn-secondary" style="width: 100%;">Create Account</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="client-signup-card" class="card hidden" style="max-width: 450px; margin: 20px auto;">
                    <div class="card-header">
                        <h2 class="card-title">Create Client Account</h2>
                    </div>
                    <div class="card-body">
                        <form id="client-signup-form">
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label for="client-signup-email" style="display: block; margin-bottom: 8px; font-weight: 500;">Email:</label>
                                <input type="email" id="client-signup-email" class="form-control" placeholder="name@example.com" required>
                            </div>
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label for="client-signup-password" style="display: block; margin-bottom: 8px; font-weight: 500;">Password (8+ chars, 1 letter, 1 number):</label>
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <input type="password" id="client-signup-password" class="form-control" placeholder="Enter password" required style="flex:1;">
                                    <button type="button" class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px;" onclick="toggleInputVisibility('client-signup-password', this)">Show</button>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label for="client-signup-confirm" style="display: block; margin-bottom: 8px; font-weight: 500;">Confirm Password:</label>
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <input type="password" id="client-signup-confirm" class="form-control" placeholder="Confirm password" required style="flex:1;">
                                    <button type="button" class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px;" onclick="toggleInputVisibility('client-signup-confirm', this)">Show</button>
                                </div>
                            </div>
                            <div id="client-signup-error" class="hidden" style="color: var(--error-red); margin-bottom: 16px; padding: 12px; background: rgba(220, 53, 69, 0.1); border-radius: 4px;"></div>
                            <div id="client-signup-success" class="hidden" style="color: var(--success-green); margin-bottom: 16px; padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 4px;"></div>
                            <div style="display: flex; gap: 12px; margin-top: 8px;">
                                <button type="button" id="cancel-signup-btn" class="btn btn-secondary" style="flex:1;">Cancel</button>
                                <button type="submit" class="btn btn-primary" style="flex:1;">Create</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Client Dashboard -->
            <div id="client-dashboard-container" class="hidden">
                <div class="card-header">
                    <h2 class="card-title">Client Portal Dashboard</h2>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: 24px;">
                        <p style="margin-bottom: 16px; color: var(--text-secondary);">Welcome, <span id="client-welcome-name"></span></p>
                        <button id="new-submission-btn" class="btn btn-primary" style="margin-bottom: 24px;">+ New Submission</button>
                    </div>
                    <div id="saved-drafts-section">
                        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">Saved Drafts</h3>
                        <div id="saved-drafts-list" style="display: grid; gap: 16px;">
                            <!-- Saved drafts will be populated here -->
                        </div>
                        <div id="no-drafts-message" class="hidden" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <p>No saved drafts yet. Start a new submission to begin.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Navigation -->

            <!-- External Data Request -->
            <div id="main-container" class="hidden">
                <div class="card-header">
                    <h2 class="card-title" style="text-transform: uppercase; border-radius: var(--border-radius-lg); padding: 12px 16px; background: var(--bg-secondary);">
                        JUNE 30<tspan style="font-size: 0.55em; vertical-align: super;">TH</tspan> DATA REQUEST FORM
                    </h2>
                </div>
                <div class="card-body">
                        <form id="project-form">
                            <div class="form-row" style="flex-direction: row; align-items: center; gap: 10px;">
                                <label for="external-year-select" style="margin-bottom:0;">Year:</label>
                                <select id="external-year-select" name="year" required style="width:130px;min-width:130px;max-width:130px;">
                                    <option value="">Select Year</option>
                                    <option value="2020">2020</option>
                                    <option value="2021">2021</option>
                                    <option value="2022">2022</option>
                                    <option value="2023">2023</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027">2027</option>
                                    <option value="2028">2028</option>
                                    <option value="2029">2029</option>
                                    <option value="2030">2030</option>
                                    <option value="2031">2031</option>
                                    <option value="2032">2032</option>
                                    <option value="2033">2033</option>
                                    <option value="2034">2034</option>
                                    <option value="2035">2035</option>
                                    <option value="2036">2036</option>
                                    <option value="2037">2037</option>
                                    <option value="2038">2038</option>
                                    <option value="2039">2039</option>
                                    <option value="2040">2040</option>
                                    <option value="2041">2041</option>
                                    <option value="2042">2042</option>
                                    <option value="2043">2043</option>
                                    <option value="2044">2044</option>
                                    <option value="2045">2045</option>
                                    <option value="2046">2046</option>
                                    <option value="2047">2047</option>
                                    <option value="2048">2048</option>
                                    <option value="2049">2049</option>
                                    <option value="2050">2050</option>
                                    <option value="2051">2051</option>
                                    <option value="2052">2052</option>
                                    <option value="2053">2053</option>
                                    <option value="2054">2054</option>
                                    <option value="2055">2055</option>
                                    <option value="2056">2056</option>
                                    <option value="2057">2057</option>
                                    <option value="2058">2058</option>
                                    <option value="2059">2059</option>
                                    <option value="2060">2060</option>
                                </select>
                            </div>
                            <div class="project-area">
                                <div class="section-title" style="display: flex; align-items: center; justify-content: space-between;">
                                    <span>Project Area Information</span>
                                    <button type="button" id="load-last-year-btn" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; display: none;">Load Last Year's Data</button>
                                </div>
                                <div class="project-grid-two">
                                    <div class="form-row">
                                        <label>County:</label>
                                        <select id="external-county-dropdown" name="county" required>
                                            <option value="">Select County</option>
                                        </select>
                                        <div id="external-new-county-container" style="display: none; margin-top: 8px; flex-direction: row; gap: 8px; align-items: center;">
                                            <input type="text" id="external-new-county-input" placeholder="Enter new county name" style="flex: 1;">
                                            <button type="button" id="external-save-county-btn" class="btn btn-primary" style="padding: 8px 16px; white-space: nowrap;">Save</button>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <label>Agency/Submitter Name:</label>
                                        <select id="external-agency-dropdown" name="submitterName" required>
                                            <option value="">Select Agency/Submitter</option>
                                        </select>
                                        <div id="external-new-agency-container" style="display: none; margin-top: 8px; flex-direction: row; gap: 8px; align-items: center;">
                                            <input type="text" id="external-new-agency-input" name="newAgencyName" placeholder="Enter new agency name" style="flex: 1;">
                                            <button type="button" id="external-save-agency-btn" class="btn btn-primary" style="padding: 8px 16px; white-space: nowrap;">Save</button>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <label>Project Area Name:</label>
                                        <select id="external-project-dropdown" name="projectAreaName" required>
                                            <option value="">Select Project Area</option>
                                        </select>
                                        <div id="external-new-project-container" style="display: none; margin-top: 8px; flex-direction: row; gap: 8px; align-items: center;">
                                            <input type="text" id="external-new-project-input" name="newProjectAreaName" placeholder="Enter new project area name" style="flex: 1;">
                                            <button type="button" id="external-save-project-btn" class="btn btn-primary" style="padding: 8px 16px; white-space: nowrap;">Save</button>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-grid compact-grid project-grid">
                                    <!-- Row 2: five items -->
                                    <div class="form-row">
                                        <label>TOTAL ACREAGE: <span style="background: #4caf50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold; margin-left: 4px;">TIF</span></label>
                                        <input type="number" name="acreage" step="0.01" required>
                                    </div>
                                    <div class="form-row">
                                        <label>CREATION YEAR:</label>
                                        <input type="number" name="creationYear" min="1900" max="2100" required>
                                    </div>
                                    <div class="form-row">
                                        <label>BASE YEAR:</label>
                                        <input type="number" name="baseYear" min="1900" max="2100" required>
                                    </div>
                                    <div class="form-row">
                                        <label>TERM LENGTH:</label>
                                        <input type="number" name="termLength" min="1" max="100" required>
                                    </div>
                                    <div class="form-row">
                                        <label>START YEAR:</label>
                                        <input type="number" name="startYear" min="1900" max="2100" required>
                                    </div>

                                    <!-- Row 3: four items -->
                                    <div class="form-row">
                                        <label>EXPIRATION YEAR:</label>
                                        <input type="number" name="expirationYear" min="1900" max="2100" required>
                                    </div>
                                    <div class="form-row">
                                        <label>BASE VALUE: <span style="background: #4caf50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold; margin-left: 4px;">TIF</span></label>
                                        <input type="number" name="baseValue" step="0.01" required>
                                    </div>
                                    <div class="form-row">
                                        <label>FY INCREMENT:</label>
                                        <input type="number" name="fyIncrement" step="0.01" required>
                                    </div>
                                    <div class="form-row">
                                        <label>REMAINING LIFE:</label>
                                        <input type="number" name="remainingLife" step="0.01" readonly>
                                        <small style="color: #666; font-size: 0.8em;">Auto-calculated: Expiration Year - 2025</small>
                                    </div>
                                </div>
                                
                                <!-- TIF Report Fields (New - Light Green) -->
                                <div class="section-title" style="margin-top: 24px; padding: 8px 12px; background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 4px;">
                                    <span style="color: #2e7d32; font-weight: 600;">TIF Report Fields (New)</span>
                                </div>
                                <div class="form-grid compact-grid project-grid" style="background: #f1f8f4; padding: 16px; border-radius: 8px; border: 1px solid #c8e6c9;">
                                    <div class="form-row">
                                        <label>REAL PROPERTY VALUE:</label>
                                        <input type="number" name="realPropertyValue" step="0.01" style="background: #e8f5e9; border: 1px solid #a5d6a7;">
                                        <small style="color: #666; font-size: 0.8em;">Real Property Assessed Value</small>
                                    </div>
                                    <div class="form-row">
                                        <label>PERSONAL PROPERTY VALUE:</label>
                                        <input type="number" name="personalPropertyValue" step="0.01" value="0" style="background: #e8f5e9; border: 1px solid #a5d6a7;">
                                        <small style="color: #666; font-size: 0.8em;">Personal Property Assessed Value (default: 0)</small>
                                    </div>
                                    <div class="form-row">
                                        <label>CENTRALLY ASSESSED VALUE:</label>
                                        <input type="number" name="centrallyAssessedValue" step="0.01" style="background: #e8f5e9; border: 1px solid #a5d6a7;">
                                        <small style="color: #666; font-size: 0.8em;">Centrally Assessed Value</small>
                                    </div>
                                    <div class="form-row" style="grid-column: 1 / -1;">
                                        <label>GROWTH RATES (JSON Array):</label>
                                        <textarea name="growthRates" placeholder='[{"year": 2025, "rate": 0.585}, {"year": 2026, "rate": 0.385}]' style="min-height: 80px; background: #e8f5e9; border: 1px solid #a5d6a7; font-family: monospace; font-size: 12px;"></textarea>
                                        <small style="color: #666; font-size: 0.8em;">Annual growth rates for projected years (JSON format)</small>
                                    </div>
                                </div>
                                
                                <div class="section-title">Assessed Value & Financial Information</div>
                                <div class="form-grid" style="grid-template-columns: 2fr 1fr; gap: 16px 16px;">
                                    <div class="form-row" style="grid-column: 1 / 2;">
                                        <label>DESCRIPTION OF GROWTH IN ASSESSED VALUE:</label>
                                        <div style="margin-bottom: 8px; padding: 12px; background-color: #f8f9fa; border-left: 4px solid #00B0F0; border-radius: 4px;">
                                            <small style="color: #666; font-size: 0.9em; font-weight: 500;">Please include the following information:</small>
                                            <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #666; font-size: 0.85em;">
                                                <li>Number of residential units</li>
                                                <li>Amount of square footage (commercial, industrial, and institutional)</li>
                                                <li>Recent developments made</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="form-row" style="display:flex; flex-direction:column; gap:12px; max-width: 420px; grid-column: 2 / 3;">
                                        <label>FUND BALANCE: <span style="background: #4caf50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold; margin-left: 4px;">TIF</span></label>
                                        <input type="number" name="fundBalance" step="0.01" required>
                                    </div>
                                    <div class="form-row" style="grid-column: 1 / -1;">
                                        <textarea name="descriptionGrowthAssessedValue" required style="min-height: 220px;"></textarea>
                                    </div>
                                    <div class="form-row" style="grid-column: 1 / -1;">
                                        <label>PLANNED USES FOR FUND BALANCE:</label>
                                        <textarea name="plannedUsesFundBalance" required style="min-height: 220px;"></textarea>
                                    </div>
                                </div>
                                
                                <div class="section-title">Expense Categories</div>
                                <div id="expense-container">
                                    <!-- Default expense row -->
                                    <div class="expense-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 12px; align-items: end; margin-bottom: 12px; padding: 16px; background: var(--bg-secondary); border-radius: var(--border-radius); border: 1px solid var(--border-gray);">
                                        <div class="form-row">
                                            <label>Expense Title:</label>
                                            <input type="text" name="expenseTitle_0" required>
                                        </div>
                                        <div class="form-row">
                                            <label id="fy-label-0">FY (Selected Year) Expense:</label>
                                            <input type="number" name="tyExpense_0" step="0.01" required onchange="calculateExpenseTotal(0)">
                                        </div>
                                        <div class="form-row">
                                            <label id="cy-label-0">2025 Expense:</label>
                                            <input type="number" name="cyExpense_0" step="0.01" required onchange="calculateExpenseTotal(0)">
                                        </div>
                                        <div class="form-row">
                                            <label id="ny-label-0">2026 Expense:</label>
                                            <input type="number" name="nyExpense_0" step="0.01" required onchange="calculateExpenseTotal(0)">
                                        </div>
                                        <button type="button" class="btn btn-secondary" onclick="removeExpenseRow(this)" style="padding: 6px 12px; font-size: 12px;">Remove</button>
                                    </div>
                                </div>
                                <div style="margin-top: 16px;">
                                    <button type="button" class="add-btn" id="add-expense-btn" style="width: auto; margin: 0;">+ Add Expense</button>
                                </div>
                                <div class="form-grid">
                                    <div class="form-row">
                                        <label id="fy-actual-spent-label">FY (Selected Year) ACTUAL SPENT TOTAL:</label>
                                        <input type="number" name="tyActualSpentTotal" step="0.01" readonly>
                                        <small style="color: #666; font-size: 0.8em;">Auto-calculated: Sum of all expense totals</small>
                                    </div>
                                    <div class="form-row">
                                        <label>ADMINISTRATIVE PERCENTAGE:</label>
                                        <input type="number" name="administrativePercentage" step="0.01" readonly>
                                        <small style="color: #666; font-size: 0.8em;">Auto-calculated: (Admin Expense / Total Expenses) Ã— 100</small>
                                    </div>
                                </div>
                                
                                <div class="section-title">Development Information</div>
                                <div class="development-grid">
                                    <div class="form-row">
                                        <label>DEVELOPED ACREAGE: <span style="background: #4caf50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold; margin-left: 4px;">TIF</span></label>
                                        <input type="number" name="developedAcreage" step="0.01" required>
                                    </div>
                                    <div class="form-row">
                                        <label>UNDEVELOPED ACREAGE: <span style="background: #4caf50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold; margin-left: 4px;">TIF</span></label>
                                        <input type="number" name="undevelopedAcreage" step="0.01" required>
                                    </div>
                                    <div class="form-row">
                                        <label>RESIDENTIAL ACREAGE:</label>
                                        <input type="number" name="residentialAcreage" step="0.01" required>
                                    </div>
                                    <div class="form-row">
                                        <label>% RESIDENTIAL:</label>
                                        <input type="number" name="percentResidential" min="0" max="100" step="0.01" required readonly>
                                        <small style="color: #666; font-size: 0.8em;">Auto-calculated: (Residential Acreage / Total Acreage) Ã— 100</small>
                                    </div>
                                    <div class="form-row">
                                        <label>TOTAL AUTHORIZED HOUSING UNITS:</label>
                                        <input type="number" name="totalAuthorizedHousingUnits" min="0" required>
                                    </div>
                                </div>
                                
                                <div class="section-title">Descriptions</div>
                                <div class="form-row" style="grid-column: 1 / -1;">
                                    <label>DESCRIPTION OF SIGNIFICANT DEVELOPMENT:</label>
                                    <textarea name="descriptionSignificantDevelopment" required></textarea>
                                </div>
                                <div class="form-row" style="grid-column: 1 / -1;">
                                    <label>DESCRIPTION OF HOW THE PLAN HAS BEEN FURTHERED:</label>
                                    <textarea name="descriptionPlanFurthered" required></textarea>
                                </div>
                                <div class="form-row" style="grid-column: 1 / -1;">
                                    <label>DESCRIPTION OF OTHER ISSUES WORTH NOTING:</label>
                                    <textarea name="descriptionOtherIssues"></textarea>
                                </div>
                            </div>
                            
                            <!-- Project Area Map Section -->
                            <div class="section-title">Project Area Map</div>
                            <div class="form-row" style="grid-column: 1 / -1;">
                                <label>Upload Project Area Map (PDF):</label>
                                
                                <!-- Modern Drag & Drop Upload Area -->
                                <div id="pdf-upload-zone" style="
                                    border: 2px dashed #00B0F0;
                                    border-radius: 12px;
                                    padding: 32px 24px;
                                    text-align: center;
                                    background: #00B0F0;
                                    margin: 12px 0;
                                    transition: all 0.3s ease;
                                    cursor: pointer;
                                    position: relative;
                                    overflow: hidden;
                                ">
                                    <div id="upload-content">
                                        <div style="font-size: 48px; color: #00B0F0; margin-bottom: 16px;">ðŸ“„</div>
                                        <h4 style="margin: 0 0 8px 0; color: #333; font-weight: 600;">Drop PDF files here</h4>
                                        <p style="margin: 0 0 16px 0; color: #666; font-size: 14px;">or click to browse files</p>
                                        <div style="
                                            display: inline-flex;
                                            align-items: center;
                                            gap: 8px;
                                            background: #00B0F0;
                                            color: white;
                                            padding: 10px 20px;
                                            border-radius: 8px;
                                            font-size: 14px;
                                            font-weight: 500;
                                            transition: all 0.2s ease;
                                        " onmouseover="this.style.background='#00B0F0'" onmouseout="this.style.background='#00B0F0'">
                                            <span>ðŸ“</span>
                                            <span>Choose Files</span>
                                        </div>
                                        <p style="margin: 12px 0 0 0; color: #999; font-size: 12px;">Supports multiple PDF files â€¢ Max 5MB per file</p>
                                    </div>
                                    <input type="file" id="project-area-map-upload" accept=".pdf" multiple style="
                                        position: absolute;
                                        top: 0;
                                        left: 0;
                                        width: 100%;
                                        height: 100%;
                                        opacity: 0;
                                        cursor: pointer;
                                    ">
                                </div>
                                
                                <!-- Uploaded Files List -->
                                <div id="uploaded-maps-list" style="margin-top: 16px;"></div>
                            </div>
                            
                            <div style="display: flex; gap: 12px; margin-top: 24px;">
                                <button type="button" id="save-progress-btn" class="btn btn-secondary" style="flex: 1;">Save Progress</button>
                                <button type="button" id="fill-test-data-external-btn" class="btn" style="flex: 0 0 auto; background: #6c757d; color: white; padding: 8px 12px; font-size: 12px;" title="Fill form with test data">ðŸ§ª Fill Test Data</button>
                                <button type="submit" class="add-btn" style="flex: 1;">Add Project Area</button>
                            </div>
                            <div id="auto-save-indicator-external" style="display: none; margin-top: 8px; padding: 8px; background: #e7f3ff; border-left: 4px solid #00B0F0; border-radius: 4px; font-size: 12px; color: #0066cc;">
                                <span id="auto-save-status-external">Auto-save active. Last saved: <span id="last-saved-time-external">Never</span></span>
                            </div>
                            <div id="save-status" style="margin-top: 12px; text-align: center; color: var(--text-secondary); font-size: 14px;"></div>
                        </form>
                        <div class="table-container external-table-container">
                            <table id="project-table" style="margin-top:0; display:none;">
                                <thead>
                                    <tr>
                                        <th>Agency/Submitter Name</th>
                                        <th>Project Area Name</th>
                                        <th>ACREAGE</th>
                                        <th>CREATION YEAR</th>
                                        <th>BASE YEAR</th>
                                        <th>TERM LENGTH</th>
                                        <th>START YEAR</th>
                                        <th>EXPIRATION YEAR</th>
                                        <th>BASE VALUE</th>
                                        <th>FY INCREMENT</th>
                                        <th>REMAINING LIFE</th>
                                        <th>FUND BALANCE</th>
                                        <th id="fy-actual-spent-header">FY (Selected Year) ACTUAL SPENT TOTAL</th>
                                        <th>DEVELOPED ACREAGE</th>
                                        <th>UNDEVELOPED ACREAGE</th>
                                        <th>RESIDENTIAL ACREAGE</th>
                                        <th>% RESIDENTIAL</th>
                                        <th>TOTAL AUTHORIZED HOUSING UNITS</th>
                                        <th>Edit</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                            <button id="external-submit-all-btn" type="button" class="add-btn" style="display:none; margin-top:18px; width:100%;">Submit All</button>
                        </div>
                    </div>
            </div>

            <!-- Thank You Page -->
            <div id="external-thankyou" class="hidden">
                <div class="card">
                    <div class="card-body" style="text-align: center; padding: 64px 32px;">
                        <h2 style="font-size: 28px; font-weight: 600; margin-bottom: 16px; color: var(--text-primary);">Thanks for your help!</h2>
                        <p style="margin-bottom: 32px; color: var(--text-secondary);">Your submission has been received successfully.</p>
                        <button id="external-new-submission-btn" class="btn btn-primary">Make Another Submission</button>
                    </div>
                </div>
            </div>

            <!-- Internal Database -->
            <div id="internal-container" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">June 30th Database <span style="font-size: 12px; color: var(--success-green); font-weight: normal;">(Enterprise Build)</span></h2>
                    </div>
                    <div class="card-body">
                        <div class="controls">
                            <div class="search-box">
                                <input type="text" id="internal-db-search" class="form-control" placeholder="Search by city, project area, status...">
                            </div>
                            <div class="filter-group">
                                <select id="internal-db-filter-year" class="form-control" style="width: 160px;">
                                    <option value="">Select Year</option>
                                    <option value="2020">2020</option>
                                    <option value="2021">2021</option>
                                    <option value="2022">2022</option>
                                    <option value="2023">2023</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027">2027</option>
                                    <option value="2028">2028</option>
                                    <option value="2029">2029</option>
                                    <option value="2030">2030</option>
                                    <option value="2031">2031</option>
                                    <option value="2032">2032</option>
                                    <option value="2033">2033</option>
                                    <option value="2034">2034</option>
                                    <option value="2035">2035</option>
                                    <option value="2036">2036</option>
                                    <option value="2037">2037</option>
                                    <option value="2038">2038</option>
                                    <option value="2039">2039</option>
                                    <option value="2040">2040</option>
                                    <option value="2041">2041</option>
                                    <option value="2042">2042</option>
                                    <option value="2043">2043</option>
                                    <option value="2044">2044</option>
                                    <option value="2045">2045</option>
                                    <option value="2046">2046</option>
                                    <option value="2047">2047</option>
                                    <option value="2048">2048</option>
                                    <option value="2049">2049</option>
                                    <option value="2050">2050</option>
                                    <option value="2051">2051</option>
                                    <option value="2052">2052</option>
                                    <option value="2053">2053</option>
                                    <option value="2054">2054</option>
                                    <option value="2055">2055</option>
                                    <option value="2056">2056</option>
                                    <option value="2057">2057</option>
                                    <option value="2058">2058</option>
                                    <option value="2059">2059</option>
                                    <option value="2060">2060</option>
                                </select>
                                <select id="internal-db-filter-status" class="form-control" style="width: 180px;">
                                    <option value="">All Status</option>
                                    <option value="Ready">Ready</option>
                                    <option value="Internal Data Needed">Internal Data Needed</option>
                                </select>
                            </div>
                        </div>
                        <div id="internal-db-table-container"></div>
                        <div id="internal-db-detail-modal" class="internal-db-modal" style="display:none;"></div>
                        
                        <!-- Tax Rate Management Section -->
                        <div style="margin-top: 32px; padding-top: 32px; border-top: 2px solid var(--border-gray);">
                            <div class="section-title" style="margin-bottom: 16px;">
                                <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Tax Rate Management</h3>
                                <p style="margin: 8px 0 0 0; color: var(--text-secondary); font-size: 14px;">
                                    Import tax rates from the Utah Certified Tax Rates website or review project tax rates used in TIF reporting.
                                </p>
                            </div>

                            <!-- Project Tax Rates Display -->
                            <div class="card" style="background: var(--bg-secondary); border: 1px solid var(--border-gray); border-radius: var(--border-radius-lg); padding: 24px;">
                                <div style="margin-bottom: 12px;">
                                    <h4 style="margin: 0; font-size: 16px; font-weight: 600;">Project Tax Rates</h4>
                                    <p style="margin: 6px 0 0 0; color: var(--text-secondary); font-size: 13px;">
                                        These rates feed the statewide TIF report. Refresh only when verifying new scrape or import activity.
                                    </p>
                                </div>

                                <div id="tax-rate-master-rates-container">
                                    <p style="color: var(--text-secondary); text-align: center; padding: 24px;">Loading project tax rates...</p>
                                </div>

                                <div style="margin-top: 16px; display: flex; justify-content: flex-end;">
                                    <button type="button" id="tax-rate-refresh-btn" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;">
                                        Refresh
                                    </button>
                                </div>
                            </div>

                            <!-- Import Tax Rates -->
                            <div class="card" style="margin-top: 24px; background: var(--bg-secondary); border: 1px solid var(--border-gray); border-radius: var(--border-radius-lg); padding: 24px;">
                                <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Import Tax Rates</h4>
                                
                                <!-- Import Method Tabs -->
                                <div style="display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 2px solid var(--border-gray);">
                                    <button type="button" id="tax-rate-method-file" class="tax-rate-method-btn active" style="padding: 8px 16px; background: #00B0F0; color: white; border: none; border-radius: 4px 4px 0 0; cursor: pointer; font-weight: 500;">Upload File</button>
                                    <button type="button" id="tax-rate-method-scrape" class="tax-rate-method-btn" style="padding: 8px 16px; background: var(--bg-secondary); color: var(--text-secondary); border: none; border-radius: 4px 4px 0 0; cursor: pointer; font-weight: 500;">Scrape from Website</button>
                                </div>
                                
                                <!-- File Upload Method -->
                                <div id="tax-rate-file-method" style="display: block;">
                                    <div style="margin-bottom: 16px; padding: 12px; background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 4px;">
                                        <p style="margin: 0; font-size: 13px; color: #2e7d32;">
                                            <strong>Instructions:</strong> Download tax rates from 
                                            <a href="https://taxrates.utah.gov/CDRAIncrementPaid700.aspx" target="_blank" style="color: #2e7d32; text-decoration: underline;">
                                                Utah Certified Tax Rates website
                                            </a>
                                            <br>Format: CSV/Excel with columns: Entity, Year, Rate
                                        </p>
                                    </div>
                                    
                                    <div style="display: flex; gap: 16px; align-items: flex-start; margin-bottom: 16px;">
                                        <div style="flex: 1;">
                                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Import Type:</label>
                                            <select id="tax-rate-import-type" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;">
                                                <option value="master">Master Rates (Org-wide, reusable)</option>
                                                <option value="project">Project-Specific Rates</option>
                                            </select>
                                        </div>
                                        <div id="tax-rate-project-select-container" style="flex: 1; display: none;">
                                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Select Project:</label>
                                            <select id="tax-rate-project-select" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;">
                                                <option value="">Loading projects...</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Scrape Method -->
                                <div id="tax-rate-scrape-method" style="display: none;">
                                    <div style="margin-bottom: 16px; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                                        <p style="margin: 0; font-size: 13px; color: #856404;">
                                            <strong>Note:</strong> This will automatically scrape tax rates from the Utah website. 
                                            You'll need to provide the Tax Year, County, Agency, and Project Area.
                                        </p>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Tax Year:</label>
                                            <select id="tax-rate-scrape-year" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;">
                                                <option value="">Select Year</option>
                                                <option value="2025">2025</option>
                                                <option value="2024">2024</option>
                                                <option value="2023">2023</option>
                                                <option value="2022">2022</option>
                                                <option value="2021">2021</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">County:</label>
                                            <input type="text" id="tax-rate-scrape-county" placeholder="e.g., 23_TOOELE" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Agency:</label>
                                            <input type="text" id="tax-rate-scrape-agency" placeholder="e.g., Tooele County CDRA" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Project Area:</label>
                                            <input type="text" id="tax-rate-scrape-project" placeholder="e.g., 1000 North Retail CRA" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;">
                                        </div>
                                    </div>
                                    
                                    <div style="margin-bottom: 16px;">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Import Type:</label>
                                        <select id="tax-rate-scrape-import-type" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;">
                                            <option value="master">Master Rates (Org-wide, reusable)</option>
                                            <option value="project">Project-Specific Rates</option>
                                        </select>
                                    </div>
                                    
                                    <div id="tax-rate-scrape-project-container" style="display: none; margin-bottom: 16px;">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Select Project:</label>
                                        <select id="tax-rate-scrape-project-select" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;">
                                            <option value="">Loading projects...</option>
                                        </select>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                        <button type="button" id="tax-rate-scrape-btn" class="btn btn-primary" style="width: 100%; padding: 12px; font-size: 14px; font-weight: 600;" disabled>
                                            Scrape Selected Project
                                        </button>
                                        <button type="button" id="tax-rate-scrape-all-btn" class="btn" style="width: 100%; padding: 12px; font-size: 14px; font-weight: 600; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                            Scrape All (2025)
                                        </button>
                                    </div>
                                    
                                    <div style="margin-bottom: 16px; padding: 12px; background: #d1ecf1; border-left: 4px solid #0c5460; border-radius: 4px;">
                                        <p style="margin: 0; font-size: 12px; color: #0c5460;">
                                            <strong>Bulk Scrape:</strong> This will scrape tax rates for ALL counties, agencies, and projects for 2025. 
                                            This process may take 1-2 hours. The system will process in the background.
                                        </p>
                                    </div>
                                    
                                    <div id="tax-rate-scrape-status" style="display: none; margin-top: 16px;">                                    </div>
                                    <div id="tax-rate-scrape-all-status" style="display: none; margin-top: 16px;">                                    </div>
                                    
                                    <!-- File Upload Area -->
                                    <div id="tax-rate-upload-zone" style="
                                    border: 2px dashed #00B0F0;
                                    border-radius: 12px;
                                    padding: 32px 24px;
                                    text-align: center;
                                    background: #f8f9fa;
                                    margin: 16px 0;
                                    transition: all 0.3s ease;
                                    cursor: pointer;
                                    position: relative;
                                ">
                                    <div id="tax-rate-upload-content">
                                        <div style="font-size: 48px; color: #00B0F0; margin-bottom: 16px;">ðŸ“„</div>
                                        <h4 style="margin: 0 0 8px 0; color: #333; font-weight: 600;">Drop CSV/Excel file here</h4>
                                        <p style="margin: 0 0 16px 0; color: #666; font-size: 14px;">or click to browse files</p>
                                        <div style="
                                            display: inline-flex;
                                            align-items: center;
                                            gap: 8px;
                                            background: #00B0F0;
                                            color: white;
                                            padding: 10px 20px;
                                            border-radius: 8px;
                                            font-size: 14px;
                                            font-weight: 500;
                                        ">
                                            <span>ðŸ“</span>
                                            <span>Choose File</span>
                                        </div>
                                        <p style="margin: 12px 0 0 0; color: #999; font-size: 12px;">Supports CSV and Excel files (.csv, .xlsx, .xls)</p>
                                    </div>
                                    <input type="file" id="tax-rate-file-input" accept=".csv,.xlsx,.xls" style="
                                        position: absolute;
                                        top: 0;
                                        left: 0;
                                        width: 100%;
                                        height: 100%;
                                        opacity: 0;
                                        cursor: pointer;
                                    ">
                                </div>
                                
                                <!-- Selected File Display -->
                                <div id="tax-rate-selected-file" style="display: none; margin-top: 16px; padding: 12px; background: #e7f3ff; border-left: 4px solid #00B0F0; border-radius: 4px;">
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <div>
                                            <strong id="tax-rate-file-name"></strong>
                                            <span id="tax-rate-file-size" style="color: #666; margin-left: 8px; font-size: 12px;"></span>
                                        </div>
                                        <button type="button" id="tax-rate-remove-file" class="btn btn-secondary" style="padding: 4px 12px; font-size: 12px;">Remove</button>
                                    </div>
                                </div>
                                
                                <!-- Import Button -->
                                <button type="button" id="tax-rate-import-btn" class="btn btn-primary" style="margin-top: 16px; width: 100%; padding: 12px; font-size: 14px; font-weight: 600;" disabled>
                                    Import Tax Rates
                                </button>
                                
                                <!-- Import Status -->
                                <div id="tax-rate-import-status" style="display: none; margin-top: 16px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Internal Data Request -->
            <div id="internal-data-request-container" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Internal Data Request Form</h2>
                    </div>
                    <div class="card-body">
                        <form id="internal-data-request-form" novalidate>
                            <div class="form-row" style="flex-direction: row; align-items: center; gap: 10px;">
                                <label for="internal-year-select" style="margin-bottom:0;">Year:</label>
                                <select id="internal-year-select" name="year" style="width:130px;min-width:130px;max-width:130px;">
                                    <option value="">Select Year</option>
                                    <option value="2020">2020</option>
                                    <option value="2021">2021</option>
                                    <option value="2022">2022</option>
                                    <option value="2023">2023</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027">2027</option>
                                    <option value="2028">2028</option>
                                    <option value="2029">2029</option>
                                    <option value="2030">2030</option>
                                    <option value="2031">2031</option>
                                    <option value="2032">2032</option>
                                    <option value="2033">2033</option>
                                    <option value="2034">2034</option>
                                    <option value="2035">2035</option>
                                    <option value="2036">2036</option>
                                    <option value="2037">2037</option>
                                    <option value="2038">2038</option>
                                    <option value="2039">2039</option>
                                    <option value="2040">2040</option>
                                    <option value="2041">2041</option>
                                    <option value="2042">2042</option>
                                    <option value="2043">2043</option>
                                    <option value="2044">2044</option>
                                    <option value="2045">2045</option>
                                    <option value="2046">2046</option>
                                    <option value="2047">2047</option>
                                    <option value="2048">2048</option>
                                    <option value="2049">2049</option>
                                    <option value="2050">2050</option>
                                    <option value="2051">2051</option>
                                    <option value="2052">2052</option>
                                    <option value="2053">2053</option>
                                    <option value="2054">2054</option>
                                    <option value="2055">2055</option>
                                    <option value="2056">2056</option>
                                    <option value="2057">2057</option>
                                    <option value="2058">2058</option>
                                    <option value="2059">2059</option>
                                    <option value="2060">2060</option>
                                </select>
                            </div>
                            <div class="project-area">
                                <div class="section-title" style="display: flex; align-items: center; justify-content: space-between;">
                                    <span>Basic Information</span>
                                    <button type="button" id="load-last-year-internal-btn" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; display: none;">Load Last Year's Data</button>
                                </div>
                                <div class="project-grid-two">
                                    <div class="form-row">
                                        <label>Client (Agency/Submitter):</label>
                                        <select id="internal-city-dropdown" name="cityCounty">
                                            <option value="">Select Client</option>
                                        </select>
                                    </div>
                                    <div class="form-row">
                                        <label>Project Area:</label>
                                        <select id="internal-project-dropdown" name="projectArea">
                                            <option value="">Select Project Area</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-grid compact-grid project-grid">
                                    <div class="form-row">
                                        <label id="fy-label">Fiscal Year:</label>
                                        <select name="fy" id="internal-fy-select">
                                            <option value="">Select Fiscal Year</option>
                                            <option value="2020">2020</option>
                                            <option value="2021">2021</option>
                                            <option value="2022">2022</option>
                                            <option value="2023">2023</option>
                                            <option value="2024">2024</option>
                                            <option value="2025">2025</option>
                                            <option value="2026">2026</option>
                                            <option value="2027">2027</option>
                                            <option value="2028">2028</option>
                                            <option value="2029">2029</option>
                                            <option value="2030">2030</option>
                                            <option value="2031">2031</option>
                                            <option value="2032">2032</option>
                                            <option value="2033">2033</option>
                                            <option value="2034">2034</option>
                                            <option value="2035">2035</option>
                                            <option value="2036">2036</option>
                                            <option value="2037">2037</option>
                                            <option value="2038">2038</option>
                                            <option value="2039">2039</option>
                                            <option value="2040">2040</option>
                                            <option value="2041">2041</option>
                                            <option value="2042">2042</option>
                                            <option value="2043">2043</option>
                                            <option value="2044">2044</option>
                                            <option value="2045">2045</option>
                                            <option value="2046">2046</option>
                                            <option value="2047">2047</option>
                                            <option value="2048">2048</option>
                                            <option value="2049">2049</option>
                                            <option value="2050">2050</option>
                                            <option value="2051">2051</option>
                                            <option value="2052">2052</option>
                                            <option value="2053">2053</option>
                                            <option value="2054">2054</option>
                                            <option value="2055">2055</option>
                                            <option value="2056">2056</option>
                                            <option value="2057">2057</option>
                                            <option value="2058">2058</option>
                                            <option value="2059">2059</option>
                                            <option value="2060">2060</option>
                                        </select>
                                    </div>
                                    <div class="form-row">
                                        <label id="ty-label">Tax Year:</label>
                                        <select name="ty" id="internal-ty-select">
                                            <option value="">Select Tax Year</option>
                                            <option value="2019">2019</option>
                                            <option value="2020">2020</option>
                                            <option value="2021">2021</option>
                                            <option value="2022">2022</option>
                                            <option value="2023">2023</option>
                                            <option value="2024">2024</option>
                                            <option value="2025">2025</option>
                                            <option value="2026">2026</option>
                                            <option value="2027">2027</option>
                                            <option value="2028">2028</option>
                                            <option value="2029">2029</option>
                                            <option value="2030">2030</option>
                                            <option value="2031">2031</option>
                                            <option value="2032">2032</option>
                                            <option value="2033">2033</option>
                                            <option value="2034">2034</option>
                                            <option value="2035">2035</option>
                                            <option value="2036">2036</option>
                                            <option value="2037">2037</option>
                                            <option value="2038">2038</option>
                                            <option value="2039">2039</option>
                                            <option value="2040">2040</option>
                                            <option value="2041">2041</option>
                                            <option value="2042">2042</option>
                                            <option value="2043">2043</option>
                                            <option value="2044">2044</option>
                                            <option value="2045">2045</option>
                                            <option value="2046">2046</option>
                                            <option value="2047">2047</option>
                                            <option value="2048">2048</option>
                                            <option value="2049">2049</option>
                                            <option value="2050">2050</option>
                                            <option value="2051">2051</option>
                                            <option value="2052">2052</option>
                                            <option value="2053">2053</option>
                                            <option value="2054">2054</option>
                                            <option value="2055">2055</option>
                                            <option value="2056">2056</option>
                                            <option value="2057">2057</option>
                                            <option value="2058">2058</option>
                                            <option value="2059">2059</option>
                                        </select>
                                    </div>
                                    <div class="form-row">
                                        <label>TYPE:</label>
                                        <select name="type">
                                            <option value="">Select Type</option>
                                            <option value="EDA">EDA</option>
                                            <option value="URA">URA</option>
                                            <option value="RDA">RDA</option>
                                            <option value="CDA">CDA</option>
                                            <option value="CRA">CRA</option>
                                        </select>
                                    </div>
                                    <div class="form-row">
                                        <label>PURPOSE:</label>
                                        <select name="purpose">
                                            <option value="">Select Purpose</option>
                                            <option value="Commercial Development">Commercial Development</option>
                                            <option value="Industrial Development">Industrial Development</option>
                                            <option value="Mixed-Used Development">Mixed-Used Development</option>
                                            <option value="Residential Development">Residential Development</option>
                                        </select>
                                    </div>
                                    <div class="form-row">
                                        <label>TAXING DISTRICT:</label>
                                        <input type="text" name="taxingDistrict">
                                    </div>
                                    <div class="form-row">
                                        <label>TAX RATE:</label>
                                        <input type="number" name="taxRate">
                                    </div>
                                </div>

                                <div class="section-title">Value Information</div>
                                <div class="form-grid compact-grid project-grid">
                                    <div class="form-row">
                                        <label id="fy-value-label">Total Assessed Value: <span style="background: #4caf50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold; margin-left: 4px;">TIF</span></label>
                                        <input type="number" name="tyValue" step="0.01">
                                    </div>
                                    <div class="form-row">
                                        <label>VALUE INCREASE:</label>
                                        <input type="number" name="valueIncrease" step="0.01" readonly>
                                        <small style="color: #666; font-size: 0.8em;">Auto-calculated: FY (Selected Year) VALUE - Prior Year Value</small>
                                    </div>
                                    <div class="form-row full-span">
                                        <label>DESCRIPTION OF PROJECT AREA:</label>
                                        <textarea name="growthInAssessedValue"></textarea>
                                    </div>
                                </div>
                                
                                <!-- TIF Report Fields (New - Light Green) -->
                                <div class="section-title" style="margin-top: 24px; padding: 8px 12px; background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 4px;">
                                    <span style="color: #2e7d32; font-weight: 600;">TIF Report Fields (New)</span>
                                </div>
                                <div class="form-grid compact-grid project-grid" style="background: #f1f8f4; padding: 16px; border-radius: 8px; border: 1px solid #c8e6c9;">
                                    <div class="form-row">
                                        <label>REAL PROPERTY VALUE:</label>
                                        <input type="number" name="realPropertyValue" step="0.01" style="background: #e8f5e9; border: 1px solid #a5d6a7;">
                                        <small style="color: #666; font-size: 0.8em;">Real Property Assessed Value</small>
                                    </div>
                                    <div class="form-row">
                                        <label>PERSONAL PROPERTY VALUE:</label>
                                        <input type="number" name="personalPropertyValue" step="0.01" value="0" style="background: #e8f5e9; border: 1px solid #a5d6a7;">
                                        <small style="color: #666; font-size: 0.8em;">Personal Property Assessed Value (default: 0)</small>
                                    </div>
                                    <div class="form-row">
                                        <label>CENTRALLY ASSESSED VALUE:</label>
                                        <input type="number" name="centrallyAssessedValue" step="0.01" style="background: #e8f5e9; border: 1px solid #a5d6a7;">
                                        <small style="color: #666; font-size: 0.8em;">Centrally Assessed Value</small>
                                    </div>
                                    <div class="form-row" style="grid-column: 1 / -1;">
                                        <label>GROWTH RATES (JSON Array):</label>
                                        <textarea name="growthRates" placeholder='[{"year": 2025, "rate": 0.585}, {"year": 2026, "rate": 0.385}]' style="min-height: 80px; background: #e8f5e9; border: 1px solid #a5d6a7; font-family: monospace; font-size: 12px;"></textarea>
                                        <small style="color: #666; font-size: 0.8em;">Annual growth rates for projected years (JSON format)</small>
                                    </div>
                                </div>

                                <div class="section-title">Tax Entities</div>
                                <div class="form-grid">
                                    <div class="table-container" style="grid-column: 1 / -1;">
                                        <table class="table" id="tax-entities-table">
                                            <thead>
                                                <tr>
                                                    <th style="width: 18%;">Tax Entity <span style="background: #4caf50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: bold; margin-left: 4px;">TIF</span></th>
                                                    <th style="width: 14%;">Tax Rate <span style="background: #4caf50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: bold; margin-left: 4px;">TIF</span></th>
                                                    <th style="width: 11%;">Participation Rate (%) <span style="background: #4caf50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: bold; margin-left: 4px;">TIF</span></th>
                                                    <th style="width: 11%;">Remittance</th>
                                                    <th style="width: 11%;">Cap Amount</th>
                                                    <th style="width: 13%;" id="actual-revenue-header">(Selected Year) Increment Paid</th>
                                                    <th style="width: 11%;">Remaining Authorized</th>
                                                    <th style="width: 5%;">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tax-entities-tbody">
                                                <tr class="tax-entity-row">
                                                    <td>
                                                        <input type="text" name="taxEntityName_0" placeholder="Enter tax entity name" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;">
                                                    </td>
                                                    <td>
                                                        <div style="display: flex; flex-direction: column; gap: 4px;">
                                                            <select name="taxEntityRateSource_0" class="tax-rate-source-select" style="width: 100%; padding: 6px; border: 1px solid var(--border-gray); border-radius: 4px; font-size: 11px;" onchange="handleTaxRateSourceChange(this, 0)">
                                                                <option value="master">Select from Master Rates</option>
                                                                <option value="custom">Enter Custom Rate</option>
                                                            </select>
                                                            <select name="taxEntityRateMaster_0" class="tax-rate-master-select" style="width: 100%; padding: 6px; border: 1px solid var(--border-gray); border-radius: 4px; font-size: 11px; display: block;" onchange="handleMasterRateSelect(this, 0)">
                                                                <option value="">Loading master rates...</option>
                                                            </select>
                                                            <input type="number" name="taxEntityRateCustom_0" step="0.000001" placeholder="0.000000" style="width: 100%; padding: 6px; border: 1px solid var(--border-gray); border-radius: 4px; font-size: 11px; display: none;" onchange="handleCustomRateChange(this, 0)">
                                                            <input type="hidden" name="taxEntityRate_0" value="">
                                                            <input type="hidden" name="taxEntityRateYear_0" value="">
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <input type="number" name="taxEntityParticipationRate_0" step="0.01" min="0" max="100" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTaxEntitiesTotal()">
                                                    </td>
                                                    <td>
                                                        <input type="number" name="taxEntityRemittance_0" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTaxEntitiesTotal()">
                                                    </td>
                                                    <td>
                                                        <input type="number" name="taxEntityCapAmount_0" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTaxEntitiesTotal()">
                                                    </td>
                                                    <td>
                                                        <input type="number" name="taxEntityIncrementPaid_0" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTaxEntitiesTotal()">
                                                    </td>
                                                    <td>
                                                        <input type="number" name="taxEntityRemainingAuthorized_0" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTaxEntitiesTotal()">
                                                    </td>
                                                    <td style="width: 60px;">
                                                        <button type="button" class="btn btn-secondary" onclick="removeTaxEntityRow(this)" style="padding: 4px 8px; font-size: 11px;">Remove</button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="form-row" style="grid-column: 1 / -1; margin-top: 4px;">
                                        <button type="button" id="add-tax-entity-btn" class="btn btn-primary">+ Add Tax Entity</button>
                                    </div>
                                </div>

                                <!-- 2025 SOURCES OF FUNDS Section -->
                                <div class="section-title">2025 SOURCES OF FUNDS (Internal data request)</div>
                                <div class="table-container" style="grid-column: 1 / -1;">
                                    <table class="table" id="sources-of-funds-table">
                                        <thead>
                                            <tr>
                                                <th>Description of Revenue source</th>
                                                <th>2025 actual</th>
                                                <th>2026 forecast</th>
                                                <th>2027 forecast</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="sources-of-funds-tbody">
                                            <!-- Default row -->
                                            <tr class="sources-of-funds-row">
                                                <td><input type="text" name="revenueSourceDescription_0" placeholder="Enter revenue source description" style="width: 100%; border: none; background: transparent; padding: 8px;"></td>
                                                <td><input type="number" name="revenueSource2025Actual_0" placeholder="0" step="0.01" style="width: 100%; border: none; background: transparent; padding: 8px; text-align: right;"></td>
                                                <td><input type="number" name="revenueSource2026Forecast_0" placeholder="0" step="0.01" style="width: 100%; border: none; background: transparent; padding: 8px; text-align: right;"></td>
                                                <td><input type="number" name="revenueSource2027Forecast_0" placeholder="0" step="0.01" style="width: 100%; border: none; background: transparent; padding: 8px; text-align: right;"></td>
                                                <td><button type="button" class="btn btn-danger btn-sm" onclick="removeSourcesOfFundsRow(this)" style="padding: 4px 8px; font-size: 12px;">Remove</button></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <button type="button" id="add-sources-of-funds-btn" class="btn btn-secondary" style="margin-top: 12px;">Add Revenue Source</button>
                                </div>

                                <!-- Tax Increment Summary Section -->
                                <div class="section-title">Tax Increment Summary</div>
                                <div class="table-container" style="grid-column: 1 / -1;">
                                    <table class="table" id="tax-increment-summary-table">
                                        <thead>
                                            <tr>
                                                <th>Entity</th>
                                                <th id="tax-increment-year-label">2025 Actual</th>
                                                <th>Remaining Authorized</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tax-increment-summary-tbody">
                                            <!-- Default row -->
                                            <tr class="tax-increment-summary-row">
                                                <td><input type="text" name="taxIncrementEntity_0" placeholder="Enter entity name" style="width: 100%; border: 1px solid var(--border-gray); background: var(--bg-primary); padding: 8px; border-radius: 4px;"></td>
                                                <td><input type="number" name="taxIncrementYearActual_0" placeholder="0" step="0.01" style="width: 100%; border: 1px solid var(--border-gray); background: var(--bg-primary); padding: 8px; text-align: right; border-radius: 4px;"></td>
                                                <td><input type="number" name="taxIncrementRemainingAuthorized_0" placeholder="0" step="0.01" style="width: 100%; border: 1px solid var(--border-gray); background: var(--bg-primary); padding: 8px; text-align: right; border-radius: 4px;"></td>
                                                <td><button type="button" class="btn btn-danger btn-sm" onclick="removeTaxIncrementSummaryRow(this)" style="padding: 4px 8px; font-size: 12px;">Remove</button></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <button type="button" id="add-tax-increment-summary-btn" class="btn btn-secondary" style="margin-top: 12px;">Add Row</button>
                                </div>

                                <div class="section-title">Totals</div>
                                <div class="form-grid compact-grid project-grid">
                                    <div class="form-row">
                                        <label>TOTAL REMITTANCE:</label>
                                        <input type="number" name="totalRemittance" step="0.01" readonly>
                                    </div>
                                    <div class="form-row">
                                        <label>TOTAL CAP:</label>
                                        <input type="number" name="totalCap" step="0.01" readonly>
                                    </div>
                                    <div class="form-row">
                                        <label>TOTAL ACTUAL RECEIVED:</label>
                                        <input type="number" name="totalActualReceived" step="0.01" readonly>
                                    </div>
                                    <div class="form-row">
                                        <label>TOTAL REMAINING AUTHORIZED:</label>
                                        <input type="number" name="totalRemainingAuthorized" step="0.01" readonly>
                                    </div>
                                </div>

                                <div class="section-title">Revenue Information</div>
                                <div class="table-container" style="grid-column: 1 / -1;">
                                    <table class="table" id="revenue-information-table">
                                        <thead>
                                            <tr>
                                                <th></th>
                                                <th>ORIGINAL BUDGET REVENUES <span style="background: #4caf50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: bold; margin-left: 4px;">TIF</span></th>
                                                <th>ACTUAL REVENUE <span style="background: #4caf50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: bold; margin-left: 4px;">TIF</span></th>
                                                <th>BASE YEAR VALUE REVENUES</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="font-weight: 600; padding: 12px;"><span id="tax-year-revenue-label">Tax Year 2025</span></td>
                                                <td><input type="number" name="tyOriginalBudgetRevenues" step="0.01" placeholder="0" style="width: 100%; border: 1px solid var(--border-gray); background: var(--bg-primary); padding: 8px; border-radius: 4px; text-align: right;"></td>
                                                <td><input type="number" name="tyActualRevenue" step="0.01" placeholder="0" style="width: 100%; border: 1px solid var(--border-gray); background: var(--bg-primary); padding: 8px; border-radius: 4px; text-align: right;"></td>
                                                <td><input type="number" name="tyBaseYearRevenue" step="0.01" placeholder="0" style="width: 100%; border: 1px solid var(--border-gray); background: var(--bg-primary); padding: 8px; border-radius: 4px; text-align: right;"></td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 600; padding: 12px;">Lifetime Revenue</td>
                                                <td><input type="number" name="lifetimeRevenues" step="0.01" placeholder="0" style="width: 100%; border: 1px solid var(--border-gray); background: var(--bg-primary); padding: 8px; border-radius: 4px; text-align: right;"></td>
                                                <td><input type="number" name="lifetimeActualRevenues" step="0.01" placeholder="0" style="width: 100%; border: 1px solid var(--border-gray); background: var(--bg-primary); padding: 8px; border-radius: 4px; text-align: right;"></td>
                                                <td><input type="number" name="lifetimeBaseYearRevenues" step="0.01" placeholder="0" style="width: 100%; border: 1px solid var(--border-gray); background: var(--bg-primary); padding: 8px; border-radius: 4px; text-align: right;"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="section-title">Project Area Budget</div>
                                <div class="table-container" style="grid-column: 1 / -1;">
                                    <table class="table" id="project-area-budget-table">
                                        <thead>
                                            <tr>
                                                <th></th>
                                                <th>Totals</th>
                                                <th id="npv-revenue-header">NPV @ <span id="discount-rate-display">0</span>%</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr style="background-color: var(--bg-secondary); font-weight: 600;">
                                                <td>Revenues</td>
                                                <td>Totals</td>
                                                <td id="npv-revenue-header-cell">NPV @ <span id="discount-rate-display-revenue">0</span>%</td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 600; padding: 12px;">Property Tax Increment</td>
                                                <td><input type="number" name="propertyTaxIncrementTotal" step="0.01" placeholder="0" style="width: 100%; border: 1px solid var(--border-gray); background: var(--bg-primary); padding: 8px; border-radius: 4px; text-align: right;" onchange="calculateTotalRevenue()"></td>
                                                <td><input type="number" name="propertyTaxIncrementNpv" step="0.01" placeholder="0" style="width: 100%; border: 1px solid var(--border-gray); background: var(--bg-primary); padding: 8px; border-radius: 4px; text-align: right;" onchange="calculateTotalRevenue()"></td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 600; padding: 12px;">Total Revenue</td>
                                                <td><input type="number" name="totalRevenueTotal" step="0.01" placeholder="0" readonly style="width: 100%; border: 1px solid var(--border-gray); background: var(--bg-secondary); padding: 8px; border-radius: 4px; text-align: right;"></td>
                                                <td><input type="number" name="totalRevenueNpv" step="0.01" placeholder="0" readonly style="width: 100%; border: 1px solid var(--border-gray); background: var(--bg-secondary); padding: 8px; border-radius: 4px; text-align: right;"></td>
                                            </tr>
                                            <tr style="background-color: var(--bg-secondary); font-weight: 600;">
                                                <td>Expenses</td>
                                                <td>Totals</td>
                                                <td id="npv-expense-header-cell">NPV @ <span id="discount-rate-display-expense">0</span>%</td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 600; padding: 12px;">Administrative Fee</td>
                                                <td><input type="number" name="administrativeFeeTotal" step="0.01" placeholder="0" style="width: 100%; border: 1px solid var(--border-gray); background: var(--bg-primary); padding: 8px; border-radius: 4px; text-align: right;" onchange="calculateTotalUsesOfFunds()"></td>
                                                <td><input type="number" name="administrativeFeeNpv" step="0.01" placeholder="0" style="width: 100%; border: 1px solid var(--border-gray); background: var(--bg-primary); padding: 8px; border-radius: 4px; text-align: right;" onchange="calculateTotalUsesOfFunds()"></td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 600; padding: 12px;">Expense</td>
                                                <td><input type="number" name="expenseTotal" step="0.01" placeholder="0" style="width: 100%; border: 1px solid var(--border-gray); background: var(--bg-primary); padding: 8px; border-radius: 4px; text-align: right;" onchange="calculateTotalUsesOfFunds()"></td>
                                                <td><input type="number" name="expenseNpv" step="0.01" placeholder="0" style="width: 100%; border: 1px solid var(--border-gray); background: var(--bg-primary); padding: 8px; border-radius: 4px; text-align: right;" onchange="calculateTotalUsesOfFunds()"></td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 600; padding: 12px;">Total Uses of Funds</td>
                                                <td><input type="number" name="totalUsesOfFundsTotal" step="0.01" placeholder="0" readonly style="width: 100%; border: 1px solid var(--border-gray); background: var(--bg-secondary); padding: 8px; border-radius: 4px; text-align: right;"></td>
                                                <td><input type="number" name="totalUsesOfFundsNpv" step="0.01" placeholder="0" readonly style="width: 100%; border: 1px solid var(--border-gray); background: var(--bg-secondary); padding: 8px; border-radius: 4px; text-align: right;"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="section-title">Financial Analysis</div>
                                <div class="form-grid">
                                    <div class="form-row">
                                        <label>ADMINISTRATIVE PERCENTAGE:</label>
                                        <input type="number" name="administrativePercentage" step="0.01">
                                    </div>
                                    <div class="form-row">
                                        <label>DISCOUNT RATE (%):</label>
                                        <input type="number" name="discountRate" step="0.01" min="0" max="100">
                                    </div>
                                    <div class="form-row">
                                        <label>AGGREGATE REMAINING REVENUE:</label>
                                        <input type="number" name="aggregateRemainingRevenue" step="0.01">
                                    </div>
                                    <div class="form-row">
                                        <label>DISCOUNTED AGGREGATE REMAINING REVENUE:</label>
                                        <input type="number" name="discountedAggregateRemainingRevenue" step="0.01">
                                    </div>
                                    <div class="form-row">
                                        <label>TOTAL AGGREGATE EXPENSE:</label>
                                        <input type="number" name="totalAggregateExpense" step="0.01">
                                    </div>
                                    <div class="form-row">
                                        <label>TOTAL AGGREGATE EXPENSE AT NPV:</label>
                                        <input type="number" name="totalAggregateExpenseAtNpv" step="0.01">
                                    </div>
                                </div>

                                <div class="section-title">Total Expenses</div>
                                <div class="form-grid">
                                    <div class="table-container" style="grid-column: 1 / -1;">
                                        <table class="table" id="total-expenses-table">
                                            <thead>
                                                <tr>
                                                    <th style="width: 50%;">Expense Description</th>
                                                    <th style="width: 20%;">Amount</th>
                                                    <th style="width: 20%;">NPV</th>
                                                    <th style="width: 10%;">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="total-expenses-tbody">
                                                <tr class="total-expense-row">
                                                    <td>
                                                        <input type="text" name="totalExpenseDescription_0" placeholder="Enter expense description" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;">
                                                    </td>
                                                    <td>
                                                        <input type="number" name="totalExpenseAmount_0" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTotalUsesOfFunds()">
                                                    </td>
                                                    <td>
                                                        <input type="number" name="totalExpenseNpv_0" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTotalUsesOfFunds()">
                                                    </td>
                                                    <td style="width: 60px;">
                                                        <button type="button" class="btn btn-secondary" onclick="removeTotalExpenseRow(this)" style="padding: 4px 8px; font-size: 11px;">Remove</button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="form-row" style="grid-column: 1 / -1; margin-top: 4px;">
                                        <button type="button" id="add-total-expense-btn" class="btn btn-primary">+ Add Expense</button>
                                    </div>
                                    <div class="form-row">
                                        <label>TOTAL USES OF FUNDS:</label>
                                        <input type="number" name="totalUsesOfFunds" step="0.01" readonly>
                                    </div>
                                </div>



                                <div class="section-title">Additional Information</div>
                                <div class="form-row" style="grid-column: 1 / -1;">
                                    <label>DESCRIPTION OF BENEFITS TO TAXING ENTITIES:</label>
                                    <textarea name="descriptionOfBenefitsToTaxingEntities"></textarea>
                                </div>

                                <!-- Governing Board of Trustees Section -->
                                <div class="section-title">Governing Board of Trustees</div>
                                <div id="governing-board-container">
                                    <div class="governing-board-row" style="display: flex; gap: 16px; margin-bottom: 16px; align-items: end;">
                                        <div class="form-row" style="flex: 1;">
                                            <label>Name:</label>
                                            <input type="text" name="governingBoardName_0" placeholder="Board Member Name">
                                        </div>
                                        <div class="form-row" style="flex: 1;">
                                            <label>Title:</label>
                                            <input type="text" name="governingBoardTitle_0" placeholder="Board Member Title">
                                        </div>
                                        <button type="button" class="btn btn-secondary" onclick="removeGoverningBoardRow(this)" style="padding: 6px 12px; font-size: 12px; margin-bottom: 0;">Remove</button>
                                    </div>
                                </div>
                                <button type="button" id="add-governing-board-btn" class="btn btn-secondary" style="margin-bottom: 24px;">Add Board Member</button>

                                <!-- Agency Staff Section -->
                                <div class="section-title">Agency Staff</div>
                                <div id="agency-staff-container">
                                    <div class="agency-staff-row" style="display: flex; gap: 16px; margin-bottom: 16px; align-items: end;">
                                        <div class="form-row" style="flex: 1;">
                                            <label>Name:</label>
                                            <input type="text" name="agencyStaffName_0" placeholder="Staff Member Name">
                                        </div>
                                        <div class="form-row" style="flex: 1;">
                                            <label>Title:</label>
                                            <input type="text" name="agencyStaffTitle_0" placeholder="Staff Member Title">
                                        </div>
                                        <button type="button" class="btn btn-secondary" onclick="removeAgencyStaffRow(this)" style="padding: 6px 12px; font-size: 12px; margin-bottom: 0;">Remove</button>
                                    </div>
                                </div>
                                <button type="button" id="add-agency-staff-btn" class="btn btn-secondary" style="margin-bottom: 24px;">Add Staff Member</button>

                                <!-- Increment Distribution Section -->
                                <div class="section-title">Increment Distribution</div>
                                <div id="increment-distribution-container">
                                    <div class="increment-distribution-row" style="display: flex; gap: 16px; margin-bottom: 16px; align-items: end;">
                                        <div class="form-row" style="flex: 1;">
                                            <label>Entity Description:</label>
                                            <input type="text" name="incrementEntity_0" placeholder="Taxing Entity Name">
                                        </div>
                                        <div class="form-row" style="flex: 1;">
                                            <label>Actual Received:</label>
                                            <input type="number" name="incrementActual_0" step="0.01" placeholder="0.00">
                                        </div>
                                        <div class="form-row" style="flex: 1;">
                                            <label>Amount Remaining Authorized:</label>
                                            <input type="number" name="incrementRemaining_0" step="0.01" placeholder="0.00">
                                        </div>
                                        <button type="button" class="btn btn-secondary" onclick="removeIncrementDistributionRow(this)" style="padding: 6px 12px; font-size: 12px; margin-bottom: 0;">Remove</button>
                                    </div>
                                </div>
                                <button type="button" id="add-increment-distribution-btn" class="btn btn-secondary" style="margin-bottom: 24px;">Add Entity</button>

                                <div style="display: flex; gap: 12px; margin-top: 24px;">
                                    <button type="button" id="save-progress-internal-btn" class="btn btn-secondary" style="flex: 1;">Save Progress</button>
                                    <button type="button" id="fill-test-data-internal-btn" class="btn" style="flex: 0 0 auto; background: #6c757d; color: white; padding: 8px 12px; font-size: 12px;" title="Fill form with test data">ðŸ§ª Fill Test Data</button>
                                    <button type="submit" class="add-btn" style="flex: 1;">Submit Data Request</button>
                                </div>
                                <div id="auto-save-indicator" style="display: none; margin-top: 8px; padding: 8px; background: #e7f3ff; border-left: 4px solid #00B0F0; border-radius: 4px; font-size: 12px; color: #0066cc;">
                                    <span id="auto-save-status">Auto-save active. Last saved: <span id="last-saved-time">Never</span></span>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Account Management -->
            <div id="account-management-container" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Account Management</h2>
                    </div>
                    <div class="card-body">
                    <div style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                        <div style="flex: 1; min-width: 300px;">
                            <input type="text" id="account-search-input" class="form-control" placeholder="Search accounts by username..." style="width: 100%;">
                        </div>
                        <button id="add-account-btn" class="btn btn-primary">+ Add New Account</button>
                    </div>
                    
                    <div id="accounts-table-container" style="overflow-x: auto;">
                        <!-- Accounts table will be populated here -->
                    </div>

                    <div id="login-audit-section" style="margin-top: 32px;">
                        <div style="display:flex; align-items:center; justify-content: space-between; gap:12px; flex-wrap:wrap;">
                            <h3 style="margin:0; font-size:18px; font-weight:600;">Login Activity (local)</h3>
                            <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
                                <small id="login-audit-count" style="color: var(--text-secondary);">Showing 5 of 0 entries</small>
                                <button type="button" id="expand-login-audit-btn" class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px; white-space: nowrap;">Show All</button>
                                <button type="button" id="export-login-audit-btn" class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px; white-space: nowrap;">Export</button>
                            </div>
                        </div>
                        <div id="login-audit-table" style="margin-top: 12px; overflow-x: auto;"></div>
                    </div>

                    <div id="bulk-upload-section" style="margin-top: 32px;">
                        <h3 style="margin:0 0 12px 0; font-size:18px; font-weight:600;">Bulk Client Upload</h3>
                        <p style="color: var(--text-secondary); margin: 0 0 12px 0;">Upload CSV or Excel with an <strong>email</strong> column. Users with the same email domain are grouped automatically.</p>
                        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px;">
                            <input type="file" id="bulk-client-file" accept=".csv,.xlsx,.xls" />
                            <button type="button" id="process-bulk-upload" class="btn btn-primary" style="margin:0;">Process Upload</button>
                        </div>
                        <div id="bulk-upload-result" style="margin-top:12px;"></div>
                        <div id="client-groups-table" style="margin-top:16px; overflow-x:auto;"></div>
                    </div>

                    <div id="email-config-section" style="margin-top: 32px;">
                        <h3 style="margin:0 0 12px 0; font-size:18px; font-weight:600;">Email Setup (for automated invites/resets)</h3>
                        <p style="color: var(--text-secondary); margin: 0 0 12px 0;">Fill these in to enable automated signup/reset emails. Stored locally for now; ready to wire to backend later.</p>
                        <form id="email-config-form" style="display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));">
                            <div class="form-group" style="margin:0;">
                                <label>Mode:</label>
                                <select id="email-mode" class="form-control">
                                    <option value="manual">Manual (pending accounts)</option>
                                    <option value="smtp">SMTP (automated)</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin:0;">
                                <label>SMTP Host:</label>
                                <input type="text" id="email-host" class="form-control" placeholder="smtp.example.com">
                            </div>
                            <div class="form-group" style="margin:0;">
                                <label>SMTP Port:</label>
                                <input type="number" id="email-port" class="form-control" placeholder="587">
                            </div>
                            <div class="form-group" style="margin:0;">
                                <label>Username:</label>
                                <input type="text" id="email-user" class="form-control" placeholder="user@example.com">
                            </div>
                            <div class="form-group" style="margin:0;">
                                <label>Password / App Password:</label>
                                <input type="password" id="email-pass" class="form-control" placeholder="App password or SMTP password">
                            </div>
                            <div class="form-group" style="margin:0;">
                                <label>From Email:</label>
                                <input type="email" id="email-from" class="form-control" placeholder="noreply@example.com">
                            </div>
                            <div class="form-group" style="margin:0;">
                                <label>Use TLS/STARTTLS:</label>
                                <select id="email-tls" class="form-control">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin:0; grid-column: 1 / -1; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                                <button type="button" id="save-email-config" class="btn btn-primary">Save Email Settings</button>
                                <button type="button" id="clear-email-config" class="btn btn-secondary">Clear</button>
                                <span id="email-config-status" style="color: var(--text-secondary); font-size: 14px;">Status: Manual (pending)</span>
                            </div>
                        </form>
                        <small style="color: var(--text-secondary); display:block; margin-top:8px;">For Gmail/Outlook, use an App Password. For providers like SendGrid/Postmark/SES, use SMTP creds and your verified from-address.</small>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="internal-password-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <img src="Pictures/lrb_public_finance_advisors_logo.jpg" alt="LRB" style="width:36px; height:36px; border-radius:50%; object-fit:cover;">
                    <h3 class="modal-title" style="margin:0;">Internal Access</h3>
                </div>
                <button class="modal-close" id="internal-password-cancel">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <input type="email" id="internal-email-input" class="form-control" placeholder="Internal email">
                </div>
                <div class="form-group">
                    <input type="password" id="internal-password-input" class="form-control password-input" placeholder="Enter password">
                </div>
                <div id="internal-password-error" class="hidden" style="color: var(--error-red); margin-bottom: 16px;"></div>
                <div style="display: flex; justify-content: center;">
                    <button id="internal-password-submit" class="btn btn-primary modal-login-btn">Login</button>
                </div>
            </div>
        </div>
    </div>

    <div id="external-password-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <img src="Pictures/lrb_public_finance_advisors_logo.jpg" alt="LRB" style="width:36px; height:36px; border-radius:50%; object-fit:cover;">
                    <h3 class="modal-title" style="margin:0;">Client Portal Access</h3>
                </div>
                <button class="modal-close" id="external-password-cancel">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Toggle between Login and Signup -->
                <div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid var(--border-gray);">
                    <button type="button" id="external-login-tab" class="btn btn-secondary" style="flex: 1; border-radius: 0; border-bottom: 2px solid var(--primary-blue); background: transparent; color: var(--primary-blue);">Login</button>
                    <button type="button" id="external-signup-tab" class="btn btn-secondary" style="flex: 1; border-radius: 0; border-bottom: none; background: transparent; color: var(--text-secondary);">Sign Up</button>
                </div>
                
                <!-- Login Form -->
                <div id="external-login-form">
                    <div class="form-group">
                        <label for="external-email-input">Email:</label>
                        <input type="email" id="external-email-input" class="form-control" placeholder="your.email@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="external-password-input">Password:</label>
                        <input type="password" id="external-password-input" class="form-control password-input" placeholder="Enter password" required>
                    </div>
                    <div id="external-password-error" class="hidden" style="color: var(--error-red); margin-bottom: 16px; font-size: 14px;"></div>
                    <div style="display: flex; justify-content: center; gap: 12px;">
                        <button id="external-password-submit" class="btn btn-primary modal-login-btn">Login</button>
                    </div>
                    <div style="text-align: center; margin-top: 12px;">
                        <button type="button" id="external-forgot-password" class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px; background: transparent; border: none; color: var(--primary-blue); text-decoration: underline;">Forgot Password?</button>
                    </div>
                </div>
                
                <!-- Signup Form -->
                <div id="external-signup-form" style="display: none;">
                    <div class="form-group">
                        <label for="external-signup-email">Email:</label>
                        <input type="email" id="external-signup-email" class="form-control" placeholder="your.email@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="external-signup-password">Password:</label>
                        <input type="password" id="external-signup-password" class="form-control" placeholder="Create a password" required minlength="8">
                        <small style="color: var(--text-muted); font-size: 12px;">Must be at least 8 characters</small>
                    </div>
                    <div class="form-group">
                        <label for="external-signup-org-code">Organization Code:</label>
                        <input type="text" id="external-signup-org-code" class="form-control" placeholder="Ask your administrator for this code" required>
                        <small style="color: var(--text-muted); font-size: 12px;">Required to create an account</small>
                    </div>
                    <div id="external-signup-error" class="hidden" style="color: var(--error-red); margin-bottom: 16px; font-size: 14px;"></div>
                    <div style="display: flex; justify-content: center;">
                        <button id="external-signup-submit" class="btn btn-primary modal-login-btn">Create Account</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Management Modals -->
    <!-- Add Account Modal -->
    <div id="add-account-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                <h3 class="modal-title" style="margin:0;">Add New Account</h3>
                <button class="modal-close" id="add-account-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="add-account-form">
                    <div class="form-group">
                        <label>Email (required):</label>
                        <input type="email" id="new-account-username" class="form-control" required placeholder="name@example.com">
                        <small style="color: var(--text-secondary);">Must be a valid email; groups derive from domain.</small>
                    </div>
                    <div class="form-group">
                        <label>Role:</label>
                        <select id="new-account-role" class="form-control" required>
                            <option value="client" selected>Client</option>
                            <option value="internal">Internal</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Password (min 8 chars, 1 letter, 1 number):</label>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input type="password" id="new-account-password" class="form-control" required placeholder="Enter strong password" style="flex:1;">
                            <button type="button" class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px;" onclick="toggleInputVisibility('new-account-password', this)">Show</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Confirm Password:</label>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input type="password" id="new-account-password-confirm" class="form-control" required placeholder="Confirm password" style="flex:1;">
                            <button type="button" class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px;" onclick="toggleInputVisibility('new-account-password-confirm', this)">Show</button>
                        </div>
                    </div>
                    <div id="add-account-error" class="hidden" style="color: var(--error-red); margin-bottom: 16px;"></div>
                    <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
                        <button type="button" id="add-account-cancel-btn" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Account</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Account Details Modal -->
    <div id="account-details-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                <h3 class="modal-title" style="margin:0;" id="account-details-title">Account Details</h3>
                <button class="modal-close" id="account-details-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="account-details-content">
                    <!-- Account details will be populated here -->
                </div>
                <!-- Password Management Section -->
                <div style="margin-top: 32px; padding-top: 32px; border-top: 2px solid var(--border-gray);">
                    <h4 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">Password Management</h4>
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">New Password:</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="text" id="account-new-password" class="form-control" placeholder="Generate or enter new password" style="flex: 1;" readonly>
                            <button type="button" id="generate-password-btn" class="btn btn-secondary" style="white-space: nowrap;">Generate</button>
                            <button type="button" id="copy-password-btn" class="btn btn-secondary" style="white-space: nowrap; display: none;">Copy</button>
                        </div>
                        <small style="color: var(--text-secondary); display: block; margin-top: 4px;">Password will be auto-saved when generated</small>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button type="button" id="reset-password-email-btn" class="btn btn-primary" style="flex: 1;">Send Password Reset Email</button>
                        <button type="button" id="save-password-btn" class="btn btn-primary" style="flex: 1; display: none;">Save New Password</button>
                    </div>
                    <div id="password-management-message" style="margin-top: 12px; padding: 12px; border-radius: 4px; display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Account Modal -->
    <div id="delete-account-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                <h3 class="modal-title" style="margin:0;">Delete Account</h3>
                <button class="modal-close" id="delete-account-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="delete-account-warning" style="margin-bottom: 24px;"></p>
                <div class="form-group">
                    <label style="font-weight: bold;">Select deletion option:</label>
                    <div style="margin-top: 12px;">
                        <label style="display: flex; align-items: start; gap: 8px; margin-bottom: 12px; cursor: pointer;">
                            <input type="radio" name="delete-option" value="account-only" checked style="margin-top: 4px;">
                            <div>
                                <strong>Delete account only</strong>
                                <div style="color: var(--text-secondary); font-size: 14px; margin-top: 4px;">Remove the account but keep all submissions and drafts</div>
                            </div>
                        </label>
                        <label style="display: flex; align-items: start; gap: 8px; margin-bottom: 12px; cursor: pointer;">
                            <input type="radio" name="delete-option" value="account-drafts" style="margin-top: 4px;">
                            <div>
                                <strong>Delete account and all drafts</strong>
                                <div style="color: var(--text-secondary); font-size: 14px; margin-top: 4px;">Remove the account and all saved drafts, but keep submissions</div>
                            </div>
                        </label>
                        <label style="display: flex; align-items: start; gap: 8px; margin-bottom: 12px; cursor: pointer;">
                            <input type="radio" name="delete-option" value="account-drafts-submissions" style="margin-top: 4px;">
                            <div>
                                <strong>Delete account, drafts, and all submissions</strong>
                                <div style="color: var(--text-secondary); font-size: 14px; margin-top: 4px;">Permanently remove everything associated with this account</div>
                            </div>
                        </label>
                    </div>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
                    <button type="button" id="delete-account-cancel-btn" class="btn btn-secondary">Cancel</button>
                    <button type="button" id="delete-account-confirm-btn" class="btn btn-danger">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="change-password-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                <h3 class="modal-title" style="margin:0;">Change Password</h3>
                <button class="modal-close" id="change-password-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="change-password-form">
                    <div class="form-group">
                        <label>New Password:</label>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input type="password" id="change-password-new" class="form-control" required placeholder="Enter new password" style="flex:1;">
                            <button type="button" class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px;" onclick="toggleInputVisibility('change-password-new', this)">Show</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Confirm New Password:</label>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input type="password" id="change-password-confirm" class="form-control" required placeholder="Confirm new password" style="flex:1;">
                            <button type="button" class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px;" onclick="toggleInputVisibility('change-password-confirm', this)">Show</button>
                        </div>
                    </div>
                    <div id="change-password-error" class="hidden" style="color: var(--error-red); margin-bottom: 16px;"></div>
                    <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
                        <button type="button" id="change-password-cancel-btn" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary">Change Password</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Email Modal -->
    <div id="profile-email-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 420px;">
            <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                <h3 class="modal-title" style="margin:0;">Update Email</h3>
                <button class="modal-close" id="profile-email-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="profile-email-form">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display:block; margin-bottom: 8px;">New Email:</label>
                        <input type="email" id="profile-email-input" class="form-control" required placeholder="name@example.com">
                    </div>
                    <div id="profile-email-error" class="hidden" style="color: var(--error-red); margin-bottom: 16px;"></div>
                    <div style="display:flex; gap:12px; justify-content:flex-end;">
                        <button type="button" id="profile-email-cancel" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">New submission received!</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.min.js"></script>
    <!-- Keep jsPDF for now as fallback, will remove after conversion -->
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    
    <!-- Enterprise Build: API Client -->
    <script>
        // Set API base URL - defaults to localhost, can be overridden for production
        window.API_BASE_URL = window.API_BASE_URL || 'http://localhost:4000/api';
    </script>
    <script src="../client/apiClient.js"></script>
    
    <script>
        // Global jsPDF reference - handle different loading scenarios
        window.jsPDF = window.jsPDF || window.jspdf?.jsPDF;
        
        // Ensure jsPDF is loaded when page is ready
        window.addEventListener('load', function() {
            console.log('Page loaded, checking jsPDF availability...');
            console.log('window.jsPDF:', typeof window.jsPDF);
            console.log('window.jspdf:', typeof window.jspdf);
            
            if (typeof window.jsPDF !== 'undefined') {
                console.log('jsPDF is available');
            } else if (typeof window.jspdf !== 'undefined' && window.jspdf.jsPDF) {
                console.log('jsPDF available via window.jspdf');
                window.jsPDF = window.jspdf.jsPDF;
            } else {
                console.log('jsPDF not available, loading fallback...');
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js';
                script.onload = function() {
                    console.log('jsPDF fallback loaded successfully');
                    // Try to set global reference again
                    window.jsPDF = window.jsPDF || window.jspdf?.jsPDF;
                    // Test if it works
                    setTimeout(() => testJsPDF(), 100);
                };
                script.onerror = function() {
                    console.error('Failed to load jsPDF fallback');
                };
                document.head.appendChild(script);
            }
            
            // Test jsPDF after a short delay
            setTimeout(() => testJsPDF(), 1000);
            
            // Auto-convert r@teambarker.com to internal if needed (after DOM is ready)
            setTimeout(() => {
                const email = 'r@teambarker.com';
                const emailLower = email.toLowerCase();
                try {
                    // Use window versions to ensure functions are accessible
                    const getMeta = window.getAccountMeta || getAccountMeta;
                    const getClient = window.getClientCredentials || getClientCredentials;
                    const getInternal = window.getInternalCredentials || getInternalCredentials;
                    const convert = window.convertClientToInternal || convertClientToInternal;
                    
                    if (typeof getMeta !== 'function' || typeof getClient !== 'function' || typeof getInternal !== 'function') {
                        console.warn('Account management functions not available yet');
                        return;
                    }
                    
                    const meta = getMeta();
                    const clientCreds = getClient();
                    const internalCreds = getInternal();
                    
                    // Convert if: exists in client creds OR exists in internal creds but meta says client
                    const needsConversion = (clientCreds[emailLower] || internalCreds[emailLower]) && 
                                           (!meta[emailLower] || meta[emailLower].role !== 'internal');
                    
                    if (needsConversion && typeof convert === 'function') {
                        convert(email);
                        console.log('Auto-converted r@teambarker.com to internal user');
                    }
                } catch (err) {
                    console.warn('Auto-conversion check failed:', err);
                }
            }, 1500);
            
            // If bypass to internal was requested, show it AFTER all initialization is complete
            const urlParams = new URLSearchParams(window.location.search);
            const bypassToInternal = urlParams.get('internal') === 'true' || urlParams.get('mode') === 'internal';
            if (bypassToInternal) {
                setTimeout(() => {
                    if (typeof showInternalAccess === 'function') {
                        showInternalAccess('r@teambarker.com');
                    } else {
                        // Fallback: manually show internal interface
                        document.getElementById('landing-container')?.classList.add('hidden');
                        document.getElementById('client-login-container')?.classList.add('hidden');
                        document.getElementById('internal-container')?.classList.remove('hidden');
                        document.getElementById('tab-bar')?.classList.remove('hidden');
                        document.getElementById('internal-tab-btn')?.classList.add('active');
                        document.getElementById('internal-tab-btn').style.display = 'inline-block';
                        document.getElementById('internal-data-tab-btn').style.display = 'inline-block';
                        document.getElementById('account-management-tab-btn').style.display = 'inline-block';
                        if (typeof renderInternalDBCityList === 'function') renderInternalDBCityList();
                        if (typeof changeLogo === 'function') changeLogo('Pictures/horz_names (1).png');
                    }
                }, 2000); // Wait for all initialization to complete
            }
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script>
        // Global variables
        let allSubmissions = JSON.parse(localStorage.getItem('allSubmissions') || '[]');
        let currentSubmission = {};
        const profileControlEl = document.getElementById('profile-control');
        const profileButtonEl = document.getElementById('profile-button');
        const profileMenuEl = document.getElementById('profile-menu');
        const profileTooltipEmail = document.getElementById('profile-tooltip-email');
        const profileMenuEmail = document.getElementById('profile-menu-email');
        const profileInitialEl = document.getElementById('profile-initial');
        let profileMenuInitialized = false;

        function toggleHeaderVisibility(show = true) {
            const wrapper = document.querySelector('.header-wrapper');
            if (!wrapper) return;
            if (show) wrapper.classList.remove('hidden');
            else wrapper.classList.add('hidden');
        }

        function updateProfileControl(user) {
            if (!profileControlEl || !profileButtonEl || !user) return;
            const email = user.email || user.username || 'user@example.com';
            const initial = email.charAt(0).toUpperCase();
            profileButtonEl.textContent = initial;
            if (profileInitialEl) profileInitialEl.textContent = initial;
            if (profileTooltipEmail) profileTooltipEmail.textContent = email;
            if (profileMenuEmail) profileMenuEmail.textContent = email;
            profileControlEl.classList.remove('hidden');
            document.querySelector('.header-wrapper')?.classList.remove('hidden');
        }

        function hideProfileControl() {
            if (profileControlEl) {
                profileControlEl.classList.add('hidden');
            }
            if (profileMenuEl) {
                profileMenuEl.classList.add('hidden');
            }
            document.querySelector('.header-wrapper')?.classList.add('hidden');
        }

        function setupProfileMenu() {
            if (profileMenuInitialized || !profileControlEl) return;
            profileMenuInitialized = true;

            document.addEventListener('click', (event) => {
                if (!profileControlEl.contains(event.target)) {
                    profileMenuEl?.classList.add('hidden');
                }
            });

            if (profileButtonEl) {
                profileButtonEl.addEventListener('click', (event) => {
                    event.stopPropagation();
                    profileMenuEl?.classList.toggle('hidden');
                });
            }

            const editEmailBtn = document.getElementById('profile-edit-email-btn');
            const changePasswordBtn = document.getElementById('profile-change-password-btn');
            const logoutBtn = document.getElementById('profile-logout-btn');

            if (editEmailBtn) {
                editEmailBtn.addEventListener('click', () => {
                    profileMenuEl?.classList.add('hidden');
                    openProfileEmailModal();
                });
            }

            if (changePasswordBtn) {
                changePasswordBtn.addEventListener('click', () => {
                    profileMenuEl?.classList.add('hidden');
                    openProfileChangePassword();
                });
            }

            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    profileMenuEl?.classList.add('hidden');
                    handleLogout();
                });
            }
        }

        function openProfileChangePassword() {
            if (!window.currentUser) return;
            currentAccountDetails = window.currentUser.email;
            currentAccountRole = window.currentUser.role || 'internal';
            const modal = document.getElementById('change-password-modal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function openProfileEmailModal() {
            if (!window.currentUser) return;
            const modal = document.getElementById('profile-email-modal');
            const input = document.getElementById('profile-email-input');
            const error = document.getElementById('profile-email-error');
            if (!modal || !input) return;
            input.value = window.currentUser.email || '';
            if (error) error.classList.add('hidden');
            modal.classList.remove('hidden');
        }

        function closeProfileEmailModal() {
            const modal = document.getElementById('profile-email-modal');
            if (modal) modal.classList.add('hidden');
        }

        function emailExistsInStoredAccounts(email) {
            const lower = email.toLowerCase();
            let clientCreds = {};
            let internalCreds = {};
            try { clientCreds = getClientCredentials(); } catch (e) { clientCreds = JSON.parse(localStorage.getItem('clientCredentials') || '{}'); }
            try { internalCreds = getInternalCredentials(); } catch (e) { internalCreds = JSON.parse(localStorage.getItem('internalCredentials') || '{}'); }
            return !!(clientCreds[lower] || internalCreds[lower]);
        }

        function renameDraftStorage(oldEmail, newEmail) {
            const oldKey = `clientDrafts_${oldEmail.toLowerCase()}`;
            const newKey = `clientDrafts_${newEmail.toLowerCase()}`;
            if (oldKey === newKey) return;
            const drafts = localStorage.getItem(oldKey);
            if (drafts) {
                localStorage.setItem(newKey, drafts);
                localStorage.removeItem(oldKey);
            }
        }

        function updateSubmissionEmails(oldEmail, newEmail) {
            let changed = false;
            allSubmissions = allSubmissions.map(submission => {
                const submitterName = (submission.submitterName || submission.cityCounty || '').toLowerCase();
                if (submitterName === oldEmail.toLowerCase()) {
                    changed = true;
                    return { ...submission, submitterName: newEmail };
                }
                return submission;
            });
            if (changed) {
                try { localStorage.setItem('allSubmissions', JSON.stringify(allSubmissions)); } catch (e) {}
            }
        }

        function updateStoredAccountEmail(oldEmail, newEmail, role = 'client') {
            if (!oldEmail || !newEmail) return { success: false, message: 'Invalid email' };
            const lowerOld = oldEmail.toLowerCase();
            const lowerNew = newEmail.toLowerCase();
            if (lowerOld === lowerNew) return { success: true };

            let clientCreds = {};
            let internalCreds = {};
            try { clientCreds = getClientCredentials(); } catch (e) { clientCreds = JSON.parse(localStorage.getItem('clientCredentials') || '{}'); }
            try { internalCreds = getInternalCredentials(); } catch (e) { internalCreds = JSON.parse(localStorage.getItem('internalCredentials') || '{}'); }

            if (emailExistsInStoredAccounts(newEmail)) {
                return { success: false, message: 'That email is already in use.' };
            }

            if (role === 'internal') {
                if (internalCreds[lowerOld]) {
                    internalCreds[lowerNew] = internalCreds[lowerOld];
                    delete internalCreds[lowerOld];
                    saveInternalCredentials(internalCreds);
                }
            } else {
                if (clientCreds[lowerOld]) {
                    clientCreds[lowerNew] = clientCreds[lowerOld];
                    delete clientCreds[lowerOld];
                    localStorage.setItem('clientCredentials', JSON.stringify(clientCreds));
                }
            }

            const storedClient = JSON.parse(localStorage.getItem('currentClient') || 'null');
            if (storedClient && (storedClient.email || storedClient.username)?.toLowerCase() === lowerOld) {
                storedClient.email = newEmail;
                storedClient.username = newEmail;
                localStorage.setItem('currentClient', JSON.stringify(storedClient));
            }

            renameDraftStorage(oldEmail, newEmail);
            updateSubmissionEmails(oldEmail, newEmail);

            return { success: true };
        }
        
        // Enterprise Build: Load submissions from API
        async function loadSubmissionsFromAPI() {
            if (!window.apiClient || !window.currentUser) {
                console.log('API client or user not available, using localStorage only');
                return;
            }
            
            try {
                console.log('Loading submissions from API...');
                const result = await apiClient.listSubmissions();
                
                if (result && result.submissions && Array.isArray(result.submissions)) {
                    // Convert API submissions to the format expected by the UI
                    allSubmissions = result.submissions.map(sub => {
                        try {
                            const payload = typeof sub.payload_json === 'string' 
                                ? JSON.parse(sub.payload_json) 
                                : sub.payload_json || {};
                            
                            // Merge payload with submission metadata
                            return {
                                ...payload,
                                id: sub.id,
                                year: sub.year || payload.year,
                                fy: sub.year || payload.fy || payload.year,
                                status: sub.status || 'submitted',
                                createdAt: sub.created_at,
                                updatedAt: sub.updated_at
                            };
                        } catch (e) {
                            console.error('Error parsing submission payload:', e, sub);
                            return null;
                        }
                    }).filter(sub => sub !== null);
                    
                    console.log(`Loaded ${allSubmissions.length} submissions from API`);
                    
                    // Also update localStorage as backup
                    localStorage.setItem('allSubmissions', JSON.stringify(allSubmissions));
                } else {
                    console.warn('No submissions found in API response');
                    allSubmissions = [];
                }
            } catch (err) {
                console.error('Failed to load submissions from API:', err);
                // Fall back to localStorage
                allSubmissions = JSON.parse(localStorage.getItem('allSubmissions') || '[]');
            }
        }
        
        // Test function to verify jsPDF is working
        function testJsPDF() {
            console.log('Testing jsPDF availability...');
            console.log('window.jsPDF:', typeof window.jsPDF);
            console.log('window.jspdf:', typeof window.jspdf);
            console.log('jsPDF global:', typeof jsPDF);
            
            if (typeof window.jsPDF !== 'undefined') {
                try {
                    const doc = new window.jsPDF();
                    console.log('jsPDF test successful!');
                    return true;
                } catch (e) {
                    console.error('jsPDF test failed:', e);
                    return false;
                }
            }
            return false;
        }
        let logoDataUrl = null; // cached base64 for PDF logo
        let logoWidth = 0; // store logo dimensions
        let logoHeight = 0;
        
        let circleLogoDataUrl = null; // cached base64 for circle logo
        let circleLogoWidth = 0;
        let circleLogoHeight = 0;

        // Preload horizontal logo for PDF cover page
        async function loadLogo() {
            try {
                // Check if we're in file:// protocol (images won't load due to CORS)
                if (window.location.protocol === 'file:') {
                    console.log('Note: Running in file:// protocol - images may not load due to browser security restrictions. Consider serving via HTTP server.');
                    logoDataUrl = null;
                    logoWidth = 0;
                    logoHeight = 0;
                    return;
                }
                
                const img = new Image();
                img.crossOrigin = 'anonymous';
                const src = 'Pictures/horz_names (1).png';
                
                await new Promise((resolve, reject) => {
                    img.onload = () => {
                        console.log('Logo image loaded successfully. Size:', img.width, 'x', img.height);
                        resolve();
                    };
                    img.onerror = (e) => {
                        // Silently handle error - images may not load in file:// protocol
                        reject(e);
                    };
                    img.src = src;
                });
                
                // Store original dimensions
                logoWidth = img.naturalWidth;
                logoHeight = img.naturalHeight;
                
                // Create a canvas with the image's actual dimensions (no cropping for horizontal logo)
                const canvas = document.createElement('canvas');
                canvas.width = logoWidth;
                canvas.height = logoHeight;
                const ctx = canvas.getContext('2d');
                
                // Draw the full horizontal logo
                ctx.drawImage(img, 0, 0);
                
                // Export as PNG to preserve transparency
                logoDataUrl = canvas.toDataURL('image/png');
                console.log('âœ“ Horizontal logo loaded and cached for PDF. Size:', logoWidth, 'x', logoHeight, 'Data URL length:', logoDataUrl.length);
            } catch (e) {
                // Silently handle error - images may not load in file:// protocol
                logoDataUrl = null;
                logoWidth = 0;
                logoHeight = 0;
            }
        }

        // Preload circle logo for PDF cover page
        async function loadCircleLogo() {
            try {
                // Check if we're in file:// protocol (images won't load due to CORS)
                if (window.location.protocol === 'file:') {
                    console.log('Note: Running in file:// protocol - images may not load due to browser security restrictions. Consider serving via HTTP server.');
                    circleLogoDataUrl = null;
                    circleLogoWidth = 0;
                    circleLogoHeight = 0;
                    return;
                }
                
                const img = new Image();
                img.crossOrigin = 'anonymous';
                const src = 'Pictures/lrb-circle-outlined.png';
                
                await new Promise((resolve, reject) => {
                    img.onload = () => {
                        console.log('Circle logo image loaded successfully. Size:', img.width, 'x', img.height);
                        resolve();
                    };
                    img.onerror = (e) => {
                        // Silently handle error - images may not load in file:// protocol
                        reject(e);
                    };
                    img.src = src;
                });
                
                // Store original dimensions
                circleLogoWidth = img.naturalWidth;
                circleLogoHeight = img.naturalHeight;
                
                // Create a canvas with the image's actual dimensions
                const canvas = document.createElement('canvas');
                canvas.width = circleLogoWidth;
                canvas.height = circleLogoHeight;
                const ctx = canvas.getContext('2d');
                
                // Draw the circle logo
                ctx.drawImage(img, 0, 0);
                
                // Export as PNG to preserve transparency
                circleLogoDataUrl = canvas.toDataURL('image/png');
                console.log('âœ“ Circle logo loaded and cached for PDF. Size:', circleLogoWidth, 'x', circleLogoHeight, 'Data URL length:', circleLogoDataUrl.length);
            } catch (e) {
                // Silently handle error - images may not load in file:// protocol
                circleLogoDataUrl = null;
                circleLogoWidth = 0;
                circleLogoHeight = 0;
            }
        }

        // Replace the page favicon with a circular, transparent PNG
        function setCircularFavicon(dataUrl) {
            try {
                // Respect a pre-defined static favicon if present
                if (document.querySelector('link[rel="icon"][data-static="true"]')) return;
                // Resize to a crisp 32x32 for favicon
                const baseImg = new Image();
                baseImg.onload = () => {
                    const c = document.createElement('canvas');
                    c.width = 32; c.height = 32;
                    const ctx = c.getContext('2d');
                    ctx.clearRect(0,0,32,32);
                    ctx.drawImage(baseImg, 0, 0, 32, 32);
                    const faviconDataUrl = c.toDataURL('image/png');

                    let link = document.querySelector('link[rel="icon"]');
                    if (!link) {
                        link = document.createElement('link');
                        link.rel = 'icon';
                        document.head.appendChild(link);
                    }
                    link.type = 'image/png';
                    link.href = faviconDataUrl;
                };
                baseImg.src = dataUrl;
            } catch (err) {
                console.warn('Unable to set circular favicon:', err);
            }
        }

        // Ensure each primary section lives at the top level even if the HTML parser
        // reshuffled tags (this can happen when large forms are edited frequently).
        function normalizeSectionHierarchy() {
            const internalContainer = document.getElementById('internal-container');
            const internalDataContainer = document.getElementById('internal-data-request-container');
            const accountManagementContainer = document.getElementById('account-management-container');
            
            if (internalContainer) {
                if (internalDataContainer && internalDataContainer.parentElement === internalContainer) {
                    internalContainer.insertAdjacentElement('afterend', internalDataContainer);
                    console.log('[normalize] Moved internal-data-request-container outside internal-container');
                }
                if (accountManagementContainer && accountManagementContainer.parentElement === internalContainer) {
                    internalContainer.insertAdjacentElement('afterend', accountManagementContainer);
                    console.log('[normalize] Moved account-management-container outside internal-container');
                }
            }
        }

        // DOM Content Loaded
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOM Content Loaded - Enterprise Build (API Connected)');
            console.log('API Base URL:', window.API_BASE_URL);
            console.log('API Client Available:', typeof window.apiClient !== 'undefined');
            
            // Make sure tabs start as siblings (safety net if markup became nested)
            normalizeSectionHierarchy();
            
            // Enterprise Build: Auto-restore session if user is already logged in
            let hasActiveSession = false;
            try {
                if (window.apiClient) {
                    const result = await apiClient.me();
                    if (result && result.user) {
                        console.log('Session restored for user:', result.user.email);
                        // User is already logged in, route them directly
                        handleLoggedInUser(result.user);
                        hasActiveSession = true;
                    }
                }
            } catch (err) {
                // No valid session, show landing page as normal
                console.log('No active session, showing landing page');
            }
            
            // If user has active session, skip showing landing page
            if (hasActiveSession) {
                // Still initialize everything else, just don't show landing
                const landingContainer = document.getElementById('landing-container');
                if (landingContainer) landingContainer.classList.add('hidden');
            }
            
            // Check for URL parameters to bypass login (but still run all initialization)
            const urlParams = new URLSearchParams(window.location.search);
            const bypassToInternal = urlParams.get('internal') === 'true' || urlParams.get('mode') === 'internal';
            
            // Add landing background class on initial load and start video
            const landingContainer = document.getElementById('landing-container');
            const mainContent = document.querySelector('.main-content');
            const landingVideo = document.getElementById('landing-video');
            const externalBtn = document.getElementById('external-role-btn');
            if (externalBtn) {
                externalBtn.style.margin = '0 auto';
                externalBtn.style.display = 'inline-block';
            }
            
            // Limit landing video to two plays, then freeze first frame
            let videoPlayCount = 0;
            if (landingVideo) {
                landingVideo.loop = false;
                landingVideo.addEventListener('ended', () => {
                    videoPlayCount += 1;
                    if (videoPlayCount < 2) {
                        landingVideo.currentTime = 0;
                        landingVideo.play().catch(err => console.warn('Video replay failed:', err));
                    } else {
                        landingVideo.pause();
                        landingVideo.currentTime = 0;
                        landingVideo.classList.add('visible');
                        landingVideo.style.opacity = '1';
                    }
                });
            }
            
            if (landingContainer && !landingContainer.classList.contains('hidden') && mainContent) {
                mainContent.classList.add('landing-background');
                if (landingVideo) {
                    landingVideo.play().then(() => {
                        landingVideo.classList.add('visible');
                    }).catch(err => {
                        console.warn('Video autoplay failed:', err);
                        // Fallback to white background if video fails
                    });
                }
            } else {
                // Hide video if landing page is not visible
                if (landingVideo) {
                    landingVideo.pause();
                    landingVideo.classList.remove('visible');
                }
            }
            // Preload the logo for PDF report headers
            loadLogo();
            loadCircleLogo();
            // If a static favicon is present, prefer it over dynamic one
            const staticFavicon = document.querySelector('link[rel="icon"][data-static="true"]');
            if (staticFavicon) {
                // Ensure PNG is used; do nothing else
            } else {
                // Fallback: keep dynamic circular favicon setup
            }
            
            try {
                // Clear any saved current submission so we always start blank
                try { localStorage.removeItem('currentSubmission'); } catch (e) {}
                
                // Initialize year dropdowns
                populateYearDropdown('external-year-select');
                populateYearDropdown('internal-year-select');
                populateYearDropdown('internal-db-filter-year');
                console.log('Year dropdowns initialized');
                
                // Initialize external form dropdowns
                initializeExternalLocationDropdowns();
                
                // Update expense labels with initial year selection
                updateExpenseLabels();

            // ========== CLIENT AUTHENTICATION & SAVE/RESUME SYSTEM ==========
            
            // Logo switching function (made globally accessible)
            function changeLogo(logoPath) {
                const logoImg = document.querySelector('.logo img');
                if (logoImg) {
                    logoImg.src = logoPath;
                }
            }
            // Also expose globally for use outside this scope
            window.changeLogo = changeLogo;

            // Get current logged-in client
            function getCurrentClient() {
                return JSON.parse(localStorage.getItem('currentClient') || 'null');
            }

            // Set current logged-in client
            function setCurrentClient(client) {
                if (client) {
                    localStorage.setItem('currentClient', JSON.stringify(client));
                } else {
                    localStorage.removeItem('currentClient');
                }
            }

            // Get client credentials from localStorage
        function getClientCredentials() {
            return JSON.parse(localStorage.getItem('clientCredentials') || '{}');
        }

        function getInternalCredentials() {
            return JSON.parse(localStorage.getItem('internalCredentials') || '{}');
        }

        function saveInternalCredentials(creds) {
            localStorage.setItem('internalCredentials', JSON.stringify(creds));
        }

        function authenticateInternal(email, password) {
            if (!email || !password) return false;
            const creds = getInternalCredentials();
            return creds[email.toLowerCase()] === password;
        }

        // Account meta key constant (defined early for use in functions)
        const ACCOUNT_META_KEY = 'clientAccountsMeta';
        
        function getAccountMeta() {
            try {
                return JSON.parse(localStorage.getItem(ACCOUNT_META_KEY) || '{}');
            } catch (e) {
                return {};
            }
        }

        function saveAccountMeta(meta) {
            localStorage.setItem(ACCOUNT_META_KEY, JSON.stringify(meta || {}));
        }
        
        // Make functions globally accessible
        if (typeof window !== 'undefined') {
            window.getAccountMeta = getAccountMeta;
            window.saveAccountMeta = saveAccountMeta;
            window.getClientCredentials = getClientCredentials;
            window.getInternalCredentials = getInternalCredentials;
            window.saveInternalCredentials = saveInternalCredentials;
        }

        // Email config helpers
        function getEmailConfig() {
            try {
                return JSON.parse(localStorage.getItem('emailConfig') || '{}');
            } catch (e) {
                return {};
            }
        }

        function saveEmailConfig(cfg) {
            localStorage.setItem('emailConfig', JSON.stringify(cfg || {}));
        }

        function renderEmailConfig() {
            const cfg = getEmailConfig();
            const mode = cfg.mode || 'manual';
            const host = cfg.host || '';
            const port = cfg.port || '';
            const user = cfg.user || '';
            const pass = cfg.pass || '';
            const from = cfg.from || '';
            const tls = cfg.tls === false ? 'false' : 'true';

            const modeEl = document.getElementById('email-mode');
            const hostEl = document.getElementById('email-host');
            const portEl = document.getElementById('email-port');
            const userEl = document.getElementById('email-user');
            const passEl = document.getElementById('email-pass');
            const fromEl = document.getElementById('email-from');
            const tlsEl = document.getElementById('email-tls');
            const statusEl = document.getElementById('email-config-status');

            if (modeEl) modeEl.value = mode;
            if (hostEl) hostEl.value = host;
            if (portEl) portEl.value = port;
            if (userEl) userEl.value = user;
            if (passEl) passEl.value = pass;
            if (fromEl) fromEl.value = from;
            if (tlsEl) tlsEl.value = tls;
            if (statusEl) statusEl.textContent = `Status: ${mode === 'smtp' ? 'SMTP configured' : 'Manual (pending)'}`;
        }

        function setupEmailConfig() {
            const saveBtn = document.getElementById('save-email-config');
            const clearBtn = document.getElementById('clear-email-config');
            if (saveBtn) {
                saveBtn.onclick = function() {
                    const cfg = {
                        mode: document.getElementById('email-mode')?.value || 'manual',
                        host: document.getElementById('email-host')?.value || '',
                        port: document.getElementById('email-port')?.value || '',
                        user: document.getElementById('email-user')?.value || '',
                        pass: document.getElementById('email-pass')?.value || '',
                        from: document.getElementById('email-from')?.value || '',
                        tls: (document.getElementById('email-tls')?.value || 'true') === 'true'
                    };
                    saveEmailConfig(cfg);
                    renderEmailConfig();
                    showNotification('Email settings saved locally. Ready for backend wiring.');
                };
            }
            if (clearBtn) {
                clearBtn.onclick = function() {
                    saveEmailConfig({});
                    renderEmailConfig();
                };
            }
            renderEmailConfig();
        }

            // Save client credentials
            function saveClientCredentials(username, password) {
                const credentials = getClientCredentials();
                credentials[username.toLowerCase()] = password;
                localStorage.setItem('clientCredentials', JSON.stringify(credentials));
            }

            // Authenticate client or internal user - check BOTH stores to handle conversion edge cases
            function authenticateClient(username, password) {
                const usernameLower = username.toLowerCase();
                
                // Check BOTH credential stores (handles cases where conversion didn't fully complete)
                const clientCreds = getClientCredentials();
                const internalCreds = getInternalCredentials();
                
                // Try internal first, then client
                if (internalCreds[usernameLower] === password) {
                    return true;
                }
                if (clientCreds[usernameLower] === password) {
                    return true;
                }
                
                return false;
            }

            // Save form progress
            async function saveFormProgress(draftId = null) {
                // Enterprise Build: Check if user is logged in via API
                if (!window.currentUser && !getCurrentClient()) {
                    alert('Please log in to save your progress.');
                    return false;
                }

                const projectForm = document.getElementById('project-form');
                if (!projectForm) return false;

                const formData = new FormData(projectForm);
                const draft = {
                    id: draftId || 'draft_' + Date.now(),
                    savedAt: new Date().toISOString(),
                    year: formData.get('year') || '',
                    data: {}
                };

                // Capture all form data
                for (let [key, value] of formData.entries()) {
                    draft.data[key] = value;
                }

                // Capture expense data
                const expenseRows = document.querySelectorAll('.expense-row');
                const expenses = [];
                expenseRows.forEach((row, index) => {
                    const expenseTitle = row.querySelector(`input[name="expenseTitle_${index}"]`)?.value;
                    const tyExpense = row.querySelector(`input[name="tyExpense_${index}"]`)?.value;
                    const cyExpense = row.querySelector(`input[name="cyExpense_${index}"]`)?.value;
                    const nyExpense = row.querySelector(`input[name="nyExpense_${index}"]`)?.value;
                    if (expenseTitle || tyExpense || cyExpense || nyExpense) {
                        expenses.push({
                            title: expenseTitle,
                            tyExpense: tyExpense,
                            cyExpense: cyExpense,
                            nyExpense: nyExpense
                        });
                    }
                });
                draft.data.expenses = expenses;

                // Enterprise Build: Try to save to server as draft (status: 'draft')
                if (window.apiClient && window.currentUser) {
                    try {
                        const year = parseInt(draft.year || new Date().getFullYear());
                        await apiClient.createSubmission({ 
                            year, 
                            payload: { ...draft.data, _draft: true, _draftId: draft.id }
                        });
                        console.log('Draft saved to server:', draft.id);
                    } catch (err) {
                        console.warn('Failed to save draft to server, saving locally only:', err);
                    }
                }

                // Always save to localStorage as backup
                const currentClient = getCurrentClient() || window.currentUser;
                const clientId = currentClient?.username || currentClient?.email || 'guest';
                const clientDrafts = JSON.parse(localStorage.getItem(`clientDrafts_${clientId}`) || '[]');
                const existingIndex = clientDrafts.findIndex(d => d.id === draftId);
                
                if (existingIndex >= 0) {
                    clientDrafts[existingIndex] = draft;
                } else {
                    clientDrafts.push(draft);
                }
                
                localStorage.setItem(`clientDrafts_${clientId}`, JSON.stringify(clientDrafts));
                
                // Update save status
                const saveStatus = document.getElementById('save-status');
                if (saveStatus) {
                    const savedTime = new Date(draft.savedAt).toLocaleString();
                    const savedToServer = window.apiClient && window.currentUser;
                    saveStatus.textContent = `Last saved: ${savedTime}${savedToServer ? ' (server + local)' : ' (local only)'}`;
                    saveStatus.style.color = savedToServer ? 'var(--success-green, #28a745)' : 'var(--warning-yellow, #f59e0b)';
                    setTimeout(() => {
                        saveStatus.textContent = '';
                    }, 5000);
                }
                
                return draft.id;
            }

            // Load form from draft
            function loadFormFromDraft(draftId) {
                const currentClient = getCurrentClient();
                if (!currentClient) return false;

                const clientDrafts = JSON.parse(localStorage.getItem(`clientDrafts_${currentClient.username}`) || '[]');
                const draft = clientDrafts.find(d => d.id === draftId);
                
                if (!draft) {
                    alert('Draft not found.');
                    return false;
                }

                const projectForm = document.getElementById('project-form');
                if (!projectForm) return false;

                // Load year first
                if (draft.data.year) {
                    const yearSelect = document.getElementById('external-year-select');
                    if (yearSelect) {
                        yearSelect.value = draft.data.year;
                        if (yearSelect.onchange) yearSelect.onchange();
                    }
                }

                // Load all form fields
                Object.keys(draft.data).forEach(key => {
                    if (key === 'expenses' || key === 'year') return;
                    
                    const field = projectForm.querySelector(`[name="${key}"]`);
                    if (field) {
                        field.value = draft.data[key];
                    }
                });

                // Load expenses
                if (draft.data.expenses && draft.data.expenses.length > 0) {
                    const expenseContainer = document.getElementById('expense-container');
                    if (expenseContainer) {
                        expenseContainer.innerHTML = '';
                        draft.data.expenses.forEach((expense, index) => {
                            addExpenseRow();
                            const row = expenseContainer.children[index];
                            if (row) {
                                const titleInput = row.querySelector(`input[name="expenseTitle_${index}"]`);
                                const tyInput = row.querySelector(`input[name="tyExpense_${index}"]`);
                                const cyInput = row.querySelector(`input[name="cyExpense_${index}"]`);
                                const nyInput = row.querySelector(`input[name="nyExpense_${index}"]`);
                                if (titleInput) titleInput.value = expense.title || '';
                                if (tyInput) tyInput.value = expense.tyExpense || '';
                                if (cyInput) cyInput.value = expense.cyExpense || '';
                                if (nyInput) nyInput.value = expense.nyExpense || '';
                            }
                        });
                    }
                }

                // Store current draft ID for updates
                projectForm.dataset.draftId = draftId;
                
                return true;
            }

            // Render client dashboard
            function renderClientDashboard() {
                const currentClient = getCurrentClient();
                if (!currentClient) return;

                const welcomeName = document.getElementById('client-welcome-name');
                if (welcomeName) {
                    welcomeName.textContent = currentClient.username;
                }

                const draftsList = document.getElementById('saved-drafts-list');
                const noDraftsMessage = document.getElementById('no-drafts-message');
                
                const clientDrafts = JSON.parse(localStorage.getItem(`clientDrafts_${currentClient.username}`) || '[]');
                
                if (clientDrafts.length === 0) {
                    if (draftsList) draftsList.innerHTML = '';
                    if (noDraftsMessage) noDraftsMessage.classList.remove('hidden');
                } else {
                    if (noDraftsMessage) noDraftsMessage.classList.add('hidden');
                    if (draftsList) {
                        draftsList.innerHTML = clientDrafts.map(draft => {
                            const savedDate = new Date(draft.savedAt).toLocaleString();
                            const year = draft.data.year || 'No year selected';
                            return `
                                <div style="padding: 16px; border: 1px solid var(--border-gray); border-radius: 8px; background: var(--bg-primary);">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <h4 style="margin: 0 0 4px 0; font-size: 16px; font-weight: 600;">Year: ${year}</h4>
                                            <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">Saved: ${savedDate}</p>
                                        </div>
                                        <div style="display: flex; gap: 8px;">
                                            <button class="btn btn-primary btn-sm resume-draft-btn" data-draft-id="${draft.id}" style="padding: 8px 16px; font-size: 14px;">Resume</button>
                                            <button class="btn btn-secondary btn-sm delete-draft-btn" data-draft-id="${draft.id}" style="padding: 8px 16px; font-size: 14px;">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }
            }

            function showInternalAccess(username) {
                // Hide client/landing views
                document.getElementById('landing-container')?.classList.add('hidden');
                document.getElementById('client-login-container')?.classList.add('hidden');
                document.getElementById('client-dashboard-container')?.classList.add('hidden');
                document.getElementById('external-thankyou')?.classList.add('hidden');
            toggleHeaderVisibility(true);
            const pseudoUser = username ? { email: username, role: 'internal' } : (window.currentUser || { email: 'internal@lrb.com', role: 'internal' });
            setupProfileMenu();
            updateProfileControl(pseudoUser);
                
                // Ensure tab bar is visible
                const tabBar = document.getElementById('tab-bar');
                if (tabBar) tabBar.classList.remove('hidden');
                
                // Make all tabs available to internal users
                const externalTabBtn = document.getElementById('external-tab-btn');
                const internalTabBtn = document.getElementById('internal-tab-btn');
                const internalDataTabBtn = document.getElementById('internal-data-tab-btn');
                const accountManagementTabBtn = document.getElementById('account-management-tab-btn');
                
                if (externalTabBtn) {
                    externalTabBtn.style.display = 'inline-block';
                    externalTabBtn.onclick = () => showTab('external');
                }
                if (internalTabBtn) {
                    internalTabBtn.style.display = 'inline-block';
                    internalTabBtn.onclick = () => showTab('internal');
                }
                if (internalDataTabBtn) {
                    internalDataTabBtn.style.display = 'inline-block';
                    internalDataTabBtn.onclick = () => showTab('internal-data');
                }
                if (accountManagementTabBtn) {
                    accountManagementTabBtn.style.display = 'inline-block';
                    accountManagementTabBtn.onclick = () => showTab('account-management');
                }
                
                // Re-bind tab listeners (safeguard in case initialization ran before elements were visible)
                if (typeof setupTabSwitching === 'function') {
                    setupTabSwitching();
                }
                
                // Default internal landing view -> Account Management
                showTab('account-management');
                
                // Update branding
                if (typeof changeLogo === 'function') {
                    changeLogo('Pictures/horz_names (1).png');
                }
                
                // Clean up landing visuals
                const mainContent = document.querySelector('.main-content');
                const landingVideo = document.getElementById('landing-video');
                if (mainContent) mainContent.classList.remove('landing-background');
                if (landingVideo) {
                    landingVideo.pause();
                    landingVideo.currentTime = 0;
                    landingVideo.classList.remove('visible');
                }
                
                // Record login event
                if (typeof recordLoginEvent === 'function') {
                    recordLoginEvent({ user: username || 'internal', role: 'internal', outcome: 'success' });
                }
            }

            // Setup client login form - Enterprise Build: Uses API and routes based on role
            function setupClientLogin() {
                const loginForm = document.getElementById('client-login-form');
                if (!loginForm) return;

                loginForm.onsubmit = async function(e) {
                    e.preventDefault();
                    const email = document.getElementById('client-username').value.trim().toLowerCase();
                    const password = document.getElementById('client-password').value;
                    const errorDiv = document.getElementById('client-login-error');
                    const submitBtn = loginForm.querySelector('button[type="submit"]');

                    if (!email || !password) {
                        if (errorDiv) {
                            errorDiv.textContent = 'Please enter both email and password.';
                            errorDiv.classList.remove('hidden');
                        }
                        return;
                    }

                    // Disable form during request
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'Logging in...';
                    }

                    try {
                        // Check if apiClient is available
                        if (!window.apiClient) {
                            throw new Error('API client not loaded. Make sure the server is running.');
                        }

                        console.log('[LOGIN] Client Portal login attempt for:', email);
                        const result = await apiClient.login({ email, password });
                        console.log('[LOGIN] Login successful, role:', result.user?.role);

                        if (result.user && result.token) {
                            // Success - route based on role
                            if (errorDiv) errorDiv.classList.add('hidden');
                            
                            // Record login event
                            if (typeof recordLoginEvent === 'function') {
                                recordLoginEvent({ user: email, role: result.user.role, outcome: 'success' });
                            }

                            // Route based on role: admin/internal â†’ internal access, user â†’ client dashboard
                            handleLoggedInUser(result.user);
                        } else {
                            throw new Error('Invalid response from server');
                        }
                    } catch (err) {
                        console.error('[LOGIN] Login error:', err);
                        let errorMsg = err.message || 'Invalid email or password';
                        
                        if (err.message && (err.message.includes('Failed to fetch') || err.message.includes('NetworkError'))) {
                            errorMsg = 'Cannot connect to server. Make sure the server is running (npm run dev in server folder).';
                        }

                        if (errorDiv) {
                            errorDiv.textContent = errorMsg;
                            errorDiv.classList.remove('hidden');
                        }

                        // Record failed login
                        if (typeof recordLoginEvent === 'function') {
                            recordLoginEvent({ user: email, role: 'unknown', outcome: 'failure' });
                        }
                    } finally {
                        // Re-enable form
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Login';
                        }
                    }
                };
            }

            function setupClientSignup() {
                const showBtn = document.getElementById('show-signup-btn');
                const cancelBtn = document.getElementById('cancel-signup-btn');
                const signupCard = document.getElementById('client-signup-card');
                const loginCard = document.querySelector('#client-login-container .card');
                const signupForm = document.getElementById('client-signup-form');
                const errorDiv = document.getElementById('client-signup-error');
                const successDiv = document.getElementById('client-signup-success');
                const emailRegex = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
                const strongPassword = /^(?=.*[A-Za-z])(?=.*\d).{8,}$/;
                const puzzleModal = document.getElementById('puzzle-modal');
                const puzzleSlider = document.getElementById('puzzle-slider');
                const puzzlePiece = document.getElementById('puzzle-piece');
                const puzzleFlash = document.getElementById('puzzle-flash');
                const puzzleToast = document.getElementById('puzzle-toast');
                const puzzleStatus = document.getElementById('puzzle-status');
                const puzzleCancel = document.getElementById('puzzle-cancel');
                let puzzleTarget = Math.floor(20 + Math.random() * 60); // percent
                let puzzleSolved = false;
                let pendingSignup = null;

                function resetPuzzle() {
                    puzzleSolved = false;
                    puzzleTarget = Math.floor(20 + Math.random() * 60);
                    if (puzzleSlider) {
                        puzzleSlider.disabled = false;
                        puzzleSlider.value = 0;
                    }
                    if (puzzlePiece) puzzlePiece.style.left = '0px';
                    if (puzzleStatus) {
                        puzzleStatus.textContent = 'Slide until the logo looks whole.';
                        puzzleStatus.style.color = 'var(--text-secondary)';
                    }
                }

                function openPuzzleModal(signupData) {
                    pendingSignup = signupData;
                    resetPuzzle();
                    if (puzzleModal) puzzleModal.classList.remove('hidden');
                }

                function closePuzzleModal() {
                    pendingSignup = null;
                    if (puzzleModal) puzzleModal.classList.add('hidden');
                }

                function updatePuzzleDisplay(val) {
                    if (!puzzlePiece || !puzzleSlider) return;
                    const px = (parseInt(val, 10) / 100) * 220; // slide width inside stage
                    puzzlePiece.style.left = `${px}px`;
                }

                function markPuzzleSolved() {
                    puzzleSolved = true;
                    if (puzzleSlider) puzzleSlider.disabled = true;
                    if (puzzleStatus) {
                        puzzleStatus.textContent = 'Logo aligned. Submitting...';
                        puzzleStatus.style.color = '#0a8f2a';
                    }
                    if (puzzleFlash) {
                        puzzleFlash.classList.add('visible');
                        setTimeout(() => puzzleFlash.classList.add('fade'), 900);
                        setTimeout(() => {
                            puzzleFlash.classList.remove('visible');
                            puzzleFlash.classList.remove('fade');
                        }, 1300);
                    }
                    if (puzzleToast) {
                        puzzleToast.classList.add('visible');
                        setTimeout(() => puzzleToast.classList.remove('visible'), 1400);
                    }
                    // Finalize signup (with error handling)
                    let signupResult = null;
                    if (pendingSignup) {
                        try {
                            signupResult = finalizeSignup(pendingSignup);
                        } catch (err) {
                            console.error('Signup finalization error:', err);
                            signupResult = { success: false, error: err.message };
                        }
                    }
                    
                    // Show success modal after flash
                    setTimeout(() => {
                        if (puzzleModal) puzzleModal.classList.add('hidden');
                        
                        if (signupResult && signupResult.success) {
                            showSignupSuccessModal(signupResult.smtpConfigured);
                        } else if (signupResult && signupResult.error === 'Email already exists') {
                            // Show error and return to login
                            setTimeout(() => {
                                returnToLanding();
                            }, 2000);
                        } else {
                            // Default: return to landing
                            returnToLanding();
                        }
                    }, 1500);
                }
                
                function showSignupSuccessModal(smtpConfigured) {
                    const successModal = document.getElementById('signup-success-modal');
                    const successMessage = document.getElementById('signup-success-message');
                    const countdownDiv = document.getElementById('signup-success-countdown');
                    
                    if (!successModal || !successMessage) return;
                    
                    // Set message based on SMTP status
                    if (smtpConfigured) {
                        successMessage.textContent = 'Account created successfully! An email will be sent to you shortly with your login credentials.';
                    } else {
                        successMessage.textContent = 'LRB will review your submission shortly and respond by email shortly.';
                    }
                    
                    // Show modal
                    successModal.classList.remove('hidden');
                    
                    // Countdown timer
                    let seconds = 4;
                    const updateCountdown = () => {
                        if (countdownDiv) {
                            if (seconds > 0) {
                                countdownDiv.textContent = `We will now return you to the home page in ${seconds} second${seconds !== 1 ? 's' : ''}...`;
                                seconds--;
                                setTimeout(updateCountdown, 1000);
                            } else {
                                countdownDiv.textContent = 'Returning to home page...';
                                setTimeout(() => {
                                    successModal.classList.add('hidden');
                                    returnToLanding();
                                }, 500);
                            }
                        }
                    };
                    updateCountdown();
                }
                
                function returnToLanding() {
                    try {
                        // Hide all containers
                        const landingContainer = document.getElementById('landing-container');
                        const clientLoginContainer = document.getElementById('client-login-container');
                        const clientDashboardContainer = document.getElementById('client-dashboard-container');
                        const mainContainer = document.getElementById('main-container');
                        const tabBar = document.getElementById('tab-bar');
                        
                        if (clientLoginContainer) clientLoginContainer.classList.add('hidden');
                        if (clientDashboardContainer) clientDashboardContainer.classList.add('hidden');
                        if (mainContainer) mainContainer.classList.add('hidden');
                        if (tabBar) tabBar.classList.add('hidden');
                        
                        // Show landing page
                        if (landingContainer) {
                            landingContainer.classList.remove('hidden');
                        }
                        
                        // Restart video
                        const landingVideo = document.getElementById('landing-video');
                        const mainContent = document.querySelector('.main-content');
                        if (mainContent) mainContent.classList.add('landing-background');
                        if (landingVideo) {
                            landingVideo.currentTime = 0;
                            landingVideo.play().catch(e => console.warn('Video play failed:', e));
                            landingVideo.classList.add('visible');
                        }
                    } catch (err) {
                        console.error('Error returning to landing:', err);
                    }
                }

                if (puzzleSlider) {
                    updatePuzzleDisplay(puzzleSlider.value);
                    puzzleSlider.addEventListener('input', (e) => {
                        updatePuzzleDisplay(e.target.value);
                        if (puzzleSolved) return;
                        const val = parseInt(e.target.value, 10);
                        if (Math.abs(val - puzzleTarget) <= 3) {
                            markPuzzleSolved();
                        } else if (puzzleStatus) {
                            puzzleStatus.textContent = 'Slide until the logo looks whole.';
                            puzzleStatus.style.color = 'var(--text-secondary)';
                        }
                    });
                }

                if (puzzleCancel) {
                    puzzleCancel.onclick = () => {
                        closePuzzleModal();
                    };
                }

                function showSignup() {
                    if (loginCard) loginCard.classList.add('hidden');
                    if (signupCard) signupCard.classList.remove('hidden');
                    if (errorDiv) { errorDiv.classList.add('hidden'); errorDiv.textContent = ''; }
                    if (successDiv) { successDiv.classList.add('hidden'); successDiv.textContent = ''; }
                    const emailInput = document.getElementById('client-signup-email');
                    if (emailInput) emailInput.focus();
                }

                function hideSignup() {
                    if (signupCard) signupCard.classList.add('hidden');
                    if (loginCard) loginCard.classList.remove('hidden');
                }

                if (showBtn) showBtn.onclick = showSignup;
                if (cancelBtn) cancelBtn.onclick = hideSignup;

                function finalizeSignup({ email, pwd, signupForm }) {
                    try {
                        let credentials = {};
                        try { credentials = getClientCredentials(); } catch (e) { credentials = JSON.parse(localStorage.getItem('clientCredentials') || '{}'); }

                        if (credentials[email]) {
                            // Email already exists - show error in puzzle modal
                            if (puzzleStatus) {
                                puzzleStatus.textContent = 'An account with this email already exists.';
                                puzzleStatus.style.color = 'var(--error-red)';
                            }
                            return { success: false, error: 'Email already exists' };
                        }

                        // Check if SMTP is configured
                        const emailConfig = getEmailConfig();
                        const smtpConfigured = emailConfig.host && emailConfig.port && emailConfig.user && emailConfig.pass;

                        // Create account
                        credentials[email] = pwd;
                        localStorage.setItem('clientCredentials', JSON.stringify(credentials));
                        const meta = getAccountMeta();
                        meta[email] = { role: 'client', status: smtpConfigured ? 'active' : 'pending', createdAt: new Date().toISOString() };
                        saveAccountMeta(meta);

                        if (signupForm) signupForm.reset();

                        try {
                            renderAccountsTable();
                        } catch (e) {
                            // Ignore if accounts table doesn't exist
                        }

                        return { success: true, smtpConfigured };
                    } catch (err) {
                        console.error('Error in finalizeSignup:', err);
                        return { success: false, error: err.message };
                    }
                }

                if (signupForm) {
                    signupForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        const email = (document.getElementById('client-signup-email')?.value || '').trim().toLowerCase();
                        const pwd = document.getElementById('client-signup-password')?.value || '';
                        const confirm = document.getElementById('client-signup-confirm')?.value || '';

                        if (!emailRegex.test(email)) {
                            errorDiv.textContent = 'Enter a valid email address.';
                            errorDiv.classList.remove('hidden');
                            successDiv.classList.add('hidden');
                            return;
                        }
                        if (!strongPassword.test(pwd)) {
                            errorDiv.textContent = 'Password must be 8+ characters with a letter and a number.';
                            errorDiv.classList.remove('hidden');
                            successDiv.classList.add('hidden');
                            return;
                        }
                        if (pwd !== confirm) {
                            errorDiv.textContent = 'Passwords do not match.';
                            errorDiv.classList.remove('hidden');
                            successDiv.classList.add('hidden');
                            return;
                        }

                        openPuzzleModal({ email, pwd, signupForm });
                    });
                }
            }

            // Show client dashboard
            function showClientDashboard() {
                document.getElementById('landing-container').classList.add('hidden');
                document.getElementById('client-login-container').classList.add('hidden');
                document.getElementById('client-dashboard-container').classList.remove('hidden');
                document.getElementById('tab-bar').classList.remove('hidden');
                // Hide all tabs except logout for external users
                document.getElementById('external-tab-btn').style.display = 'none';
                document.getElementById('internal-tab-btn').style.display = 'none';
                document.getElementById('internal-data-tab-btn').style.display = 'none';
                document.getElementById('account-management-tab-btn').style.display = 'none';
                
                // Change logo to standard version
                changeLogo('Pictures/horz_names (1).png');
                
                // Remove landing background and stop video
                const mainContent = document.querySelector('.main-content');
                const landingVideo = document.getElementById('landing-video');
                mainContent.classList.remove('landing-background');
                if (landingVideo) {
                    landingVideo.pause();
                    landingVideo.currentTime = 0;
                    landingVideo.classList.remove('visible');
                }
                
                renderClientDashboard();
            }

            // Show client login
            function showClientLogin() {
                document.getElementById('landing-container').classList.add('hidden');
                document.getElementById('client-dashboard-container').classList.add('hidden');
                document.getElementById('main-container').classList.add('hidden');
                document.getElementById('client-login-container').classList.remove('hidden');
                document.getElementById('tab-bar').classList.add('hidden');
                
                // Change logo to standard version
                changeLogo('Pictures/horz_names (1).png');
                
                // Remove landing background and stop video
                const mainContent = document.querySelector('.main-content');
                const landingVideo = document.getElementById('landing-video');
                mainContent.classList.remove('landing-background');
                if (landingVideo) {
                    landingVideo.pause();
                    landingVideo.currentTime = 0;
                    landingVideo.classList.remove('visible');
                }
            }

            // Show new submission form
            function showNewSubmission() {
                document.getElementById('client-dashboard-container').classList.add('hidden');
                document.getElementById('main-container').classList.remove('hidden');
                
                // Clear form
                const projectForm = document.getElementById('project-form');
                if (projectForm) {
                    projectForm.reset();
                    projectForm.dataset.draftId = '';
                    const expenseContainer = document.getElementById('expense-container');
                    if (expenseContainer) {
                        expenseContainer.innerHTML = '';
                        addExpenseRow();
                    }
                }
            }

            // Setup dashboard event listeners
            function setupDashboardListeners() {
                // New submission button
                const newSubmissionBtn = document.getElementById('new-submission-btn');
                if (newSubmissionBtn) {
                    newSubmissionBtn.onclick = showNewSubmission;
                }

                // Resume draft buttons (delegated)
                document.addEventListener('click', function(e) {
                    if (e.target.classList.contains('resume-draft-btn')) {
                        const draftId = e.target.dataset.draftId;
                        if (draftId) {
                            if (loadFormFromDraft(draftId)) {
                                showNewSubmission();
                            }
                        }
                    }
                    
                    if (e.target.classList.contains('delete-draft-btn')) {
                        const draftId = e.target.dataset.draftId;
                        if (draftId && confirm('Are you sure you want to delete this draft?')) {
                            const currentClient = getCurrentClient();
                            if (currentClient) {
                                const clientDrafts = JSON.parse(localStorage.getItem(`clientDrafts_${currentClient.username}`) || '[]');
                                const filtered = clientDrafts.filter(d => d.id !== draftId);
                                localStorage.setItem(`clientDrafts_${currentClient.username}`, JSON.stringify(filtered));
                                renderClientDashboard();
                            }
                        }
                    }
                });
            }

            // Setup save progress button
            function setupSaveProgressButton() {
                const saveBtn = document.getElementById('save-progress-btn');
                if (saveBtn) {
                    saveBtn.onclick = async function() {
                        if (currentEditingSubmissionId) {
                            // In edit mode, save the current form
                            await saveCurrentForm(currentEditingSubmissionId, false);
                            showNotification('Changes saved successfully!');
                        } else {
                            // Normal draft save
                            const projectForm = document.getElementById('project-form');
                            const draftId = projectForm ? projectForm.dataset.draftId : null;
                            const newDraftId = saveFormProgress(draftId);
                            if (newDraftId && projectForm) {
                                projectForm.dataset.draftId = newDraftId;
                            }
                        }
                    };
                }
                
                // Internal form save button
                const saveInternalBtn = document.getElementById('save-progress-internal-btn');
                if (saveInternalBtn) {
                    saveInternalBtn.onclick = async function() {
                        if (currentEditingSubmissionId) {
                            // In edit mode, save the current form
                            await saveCurrentForm(currentEditingSubmissionId, false);
                            showNotification('Changes saved successfully!');
                        } else {
                            // Normal draft save for internal form
                            const internalForm = document.getElementById('internal-data-request-form');
                            if (internalForm) {
                                const formData = new FormData(internalForm);
                                const draft = {};
                                for (const [key, value] of formData.entries()) {
                                    draft[key] = value;
                                }
                                localStorage.setItem('internalFormDraft', JSON.stringify(draft));
                                showNotification('Draft saved locally.');
                            }
                        }
                    };
                }
            }

            // ========== END CLIENT AUTHENTICATION SYSTEM ==========

            // Landing page button handler (client portal only)
            const externalRoleBtn = document.getElementById('external-role-btn');
            if (externalRoleBtn) {
                externalRoleBtn.onclick = function() {
                    showClientLogin();
                };
            }
            

            // Password modal handlers
            setupPasswordModals();

            // Client authentication system setup
            setupClientLogin();
            setupClientSignup();
            setupDashboardListeners();
            setupSaveProgressButton();

            // Tab switching
            setupTabSwitching();

                // Form submissions
                setupFormSubmissions();
                console.log('Form submissions setup');
                
                // Test data fillers
                setupTestDataFillers();

            // Admin utilities
            setupBulkUpload();
            setupLoginAuditControls();
            renderLoginAudit();
            renderClientGroups();
            setupEmailConfig();

                // Internal database functionality
                setupInternalDatabase();
                console.log('Internal database setup');

                // Setup number formatting with commas
                setupNumberFormatting();
                console.log('Number formatting setup');

                // Setup percentage formatting
                setupPercentageFormatting();
                console.log('Percentage formatting setup');
                
                console.log('Application initialization complete');
                
                // Test form submission setup
                setTimeout(() => {
                    testFormSubmission();
                    
                    // Additional debugging - check if forms are visible
                    const externalForm = document.getElementById('project-form');
                    const internalForm = document.getElementById('internal-data-request-form');
                    
                    if (externalForm) {
                        console.log('External form display style:', window.getComputedStyle(externalForm).display);
                        console.log('External form visibility:', window.getComputedStyle(externalForm).visibility);
                        console.log('External form parent display:', window.getComputedStyle(externalForm.parentElement).display);
                    }
                    
                    if (internalForm) {
                        console.log('Internal form display style:', window.getComputedStyle(internalForm).display);
                        console.log('Internal form visibility:', window.getComputedStyle(internalForm).visibility);
                        console.log('Internal form parent display:', window.getComputedStyle(internalForm.parentElement).display);
                    }
                }, 1000);
            } catch (error) {
                console.error('Error during initialization:', error);
            }

            // Disable auto-restore and ensure blank start
            window.onbeforeunload = function() {
                try { localStorage.removeItem('currentSubmission'); } catch (e) {}
            };
            
            // Force blank table on load
            currentSubmission = {};
            const projectTable = document.getElementById('project-table');
            const submitAllBtnOnLoad = document.getElementById('external-submit-all-btn');
            if (projectTable) projectTable.style.display = 'none';
            if (submitAllBtnOnLoad) submitAllBtnOnLoad.style.display = 'none';
        });

        // ========== ADMIN UTILITIES ==========
        function getLoginLogs() {
            try {
                return JSON.parse(localStorage.getItem('loginAuditLogs') || '[]');
            } catch (e) {
                return [];
            }
        }

        function recordLoginEvent({ user, role, outcome }) {
            const logs = getLoginLogs();
            logs.unshift({
                id: 'log_' + Date.now() + '_' + Math.random().toString(16).slice(2),
                user,
                role,
                outcome,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('loginAuditLogs', JSON.stringify(logs.slice(0, 200)));
        }

        let loginAuditExpanded = false;

        function renderLoginAudit() {
            const container = document.getElementById('login-audit-table');
            const countDisplay = document.getElementById('login-audit-count');
            const expandBtn = document.getElementById('expand-login-audit-btn');
            
            if (!container) return;
            const logs = getLoginLogs();
            const totalLogs = logs.length;
            
            if (!totalLogs) {
                container.innerHTML = '<p style="color: var(--text-secondary); margin:0;">No login activity yet.</p>';
                if (countDisplay) countDisplay.textContent = 'No entries';
                if (expandBtn) expandBtn.style.display = 'none';
                return;
            }
            
            // Determine how many logs to show
            const displayLimit = loginAuditExpanded ? totalLogs : 5;
            const logsToShow = logs.slice(0, displayLimit);
            
            // Update count display
            if (countDisplay) {
                if (loginAuditExpanded) {
                    countDisplay.textContent = `Showing all ${totalLogs} entries`;
                } else {
                    countDisplay.textContent = `Showing ${Math.min(5, totalLogs)} of ${totalLogs} entries`;
                }
            }
            
            // Update expand button
            if (expandBtn) {
                expandBtn.textContent = loginAuditExpanded ? 'Show Less' : 'Show All';
                expandBtn.style.display = totalLogs <= 5 ? 'none' : 'inline-block';
            }
            
            const rows = logsToShow.map(log => {
                const when = new Date(log.timestamp).toLocaleString();
                return `<tr>
                    <td style="padding:8px 12px;">${when}</td>
                    <td style="padding:8px 12px;">${log.user || 'unknown'}</td>
                    <td style="padding:8px 12px; text-transform:capitalize;">${log.role || ''}</td>
                    <td style="padding:8px 12px; color:${log.outcome === 'success' ? '#16a34a' : '#dc2626'};">${log.outcome}</td>
                </tr>`;
            }).join('');
            
            container.innerHTML = `
                <table style="width:100%; border-collapse:collapse;">
                    <thead style="background: var(--bg-secondary);">
                        <tr>
                            <th style="text-align:left; padding:8px 12px;">Time</th>
                            <th style="text-align:left; padding:8px 12px;">User</th>
                            <th style="text-align:left; padding:8px 12px;">Role</th>
                            <th style="text-align:left; padding:8px 12px;">Outcome</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        function exportLoginAudit() {
            const logs = getLoginLogs();
            if (!logs.length) {
                showNotification('No login activity to export.', 'warning');
                return;
            }
            
            // Create CSV content
            const headers = ['Time', 'User', 'Role', 'Outcome'];
            const rows = logs.map(log => {
                const when = new Date(log.timestamp).toLocaleString();
                return [
                    `"${when}"`,
                    `"${log.user || 'unknown'}"`,
                    `"${log.role || ''}"`,
                    `"${log.outcome || ''}"`
                ].join(',');
            });
            
            const csvContent = [
                headers.join(','),
                ...rows
            ].join('\n');
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `login-activity-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showNotification('Login activity exported successfully.', 'success');
        }

        function setupLoginAuditControls() {
            const expandBtn = document.getElementById('expand-login-audit-btn');
            const exportBtn = document.getElementById('export-login-audit-btn');
            
            if (expandBtn) {
                expandBtn.addEventListener('click', function() {
                    loginAuditExpanded = !loginAuditExpanded;
                    renderLoginAudit();
                });
            }
            
            if (exportBtn) {
                exportBtn.addEventListener('click', exportLoginAudit);
            }
        }

        function getClientGroups() {
            try {
                return JSON.parse(localStorage.getItem('clientGroups') || '{}');
            } catch (e) {
                return {};
            }
        }

        function saveClientGroups(groups) {
            localStorage.setItem('clientGroups', JSON.stringify(groups));
        }

        function upsertClientGroupsFromEmails(emails) {
            const groups = getClientGroups();
            emails.forEach(email => {
                const trimmed = (email || '').trim().toLowerCase();
                if (!trimmed || !trimmed.includes('@')) return;
                const domain = trimmed.split('@')[1];
                if (!domain) return;
                if (!groups[domain]) {
                    groups[domain] = { id: domain, members: [], createdAt: new Date().toISOString() };
                }
                if (!groups[domain].members.includes(trimmed)) {
                    groups[domain].members.push(trimmed);
                }
                // Ensure credentials exist for this email with a generated password
                const credentials = getClientCredentials();
                if (!credentials[trimmed]) {
                    const generated = 'Temp' + Math.random().toString(36).slice(2, 8);
                    saveClientCredentials(trimmed, generated);
                }
            });
            saveClientGroups(groups);
            return groups;
        }

        function renderClientGroups() {
            const container = document.getElementById('client-groups-table');
            if (!container) return;
            const groups = getClientGroups();
            const entries = Object.values(groups);
            if (!entries.length) {
                container.innerHTML = '<p style="color: var(--text-secondary); margin:0;">No groups yet.</p>';
                return;
            }
            const rows = entries.map(g => {
                return `<tr>
                    <td style="padding:8px 12px;">${g.id}</td>
                    <td style="padding:8px 12px;">${g.members.length}</td>
                    <td style="padding:8px 12px; color: var(--text-secondary); font-size: 12px;">${(g.members || []).join(', ')}</td>
                </tr>`;
            }).join('');
            container.innerHTML = `
                <table style="width:100%; border-collapse:collapse;">
                    <thead style="background: var(--bg-secondary);">
                        <tr>
                            <th style="text-align:left; padding:8px 12px;">Domain / Group</th>
                            <th style="text-align:left; padding:8px 12px;">Members</th>
                            <th style="text-align:left; padding:8px 12px;">Emails</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        function setupBulkUpload() {
            const input = document.getElementById('bulk-client-file');
            const btn = document.getElementById('process-bulk-upload');
            const result = document.getElementById('bulk-upload-result');
            if (!input || !btn) return;

            function showResult(html) {
                if (result) result.innerHTML = html;
            }

            btn.onclick = function() {
                const file = input.files && input.files[0];
                if (!file) {
                    showResult('<p style="color: var(--error-red); margin:0;">Please choose a CSV or Excel file.</p>');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        let emails = [];
                        if (file.name.toLowerCase().endsWith('.csv')) {
                            const text = e.target.result;
                            const lines = text.split(/\r?\n/);
                            lines.forEach(line => {
                                const parts = line.split(',');
                                parts.forEach(p => {
                                    const val = p.trim();
                                    if (val.includes('@')) emails.push(val);
                                });
                            });
                        } else {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                            rows.forEach(r => {
                                r.forEach(cell => {
                                    if (typeof cell === 'string' && cell.includes('@')) emails.push(cell.trim());
                                });
                            });
                        }
                        const uniqueEmails = Array.from(new Set(emails.filter(Boolean)));
                        const groups = upsertClientGroupsFromEmails(uniqueEmails);
                        showResult(`<p style="color: var(--success-green); margin:0;">Processed ${uniqueEmails.length} emails. Groups: ${Object.keys(groups).length}</p>`);
                        renderClientGroups();
                    } catch (err) {
                        console.error(err);
                        showResult('<p style="color: var(--error-red); margin:0;">Upload failed. Please check the file format.</p>');
                    }
                };
                if (file.name.toLowerCase().endsWith('.csv')) {
                    reader.readAsText(file);
                } else {
                    reader.readAsArrayBuffer(file);
                }
            };
        }

        // Enterprise Build: Handle logged in user based on role
        function handleLoggedInUser(user) {
            if (!user) return;
            
            // Store user info globally
            window.currentUser = user;
            toggleHeaderVisibility(true);
            setupProfileMenu();
            updateProfileControl(user);
            
            // Hide landing page, login forms, and show tab bar
            document.getElementById('landing-container')?.classList.add('hidden');
            document.getElementById('client-login-container')?.classList.add('hidden');
            document.getElementById('client-dashboard-container')?.classList.add('hidden');
            document.getElementById('external-thankyou')?.classList.add('hidden');
            document.getElementById('tab-bar')?.classList.remove('hidden');
            
            // Hide all tabs first
            document.getElementById('external-tab-btn').style.display = 'none';
            document.getElementById('internal-tab-btn').style.display = 'none';
            document.getElementById('internal-data-tab-btn').style.display = 'none';
            document.getElementById('account-management-tab-btn').style.display = 'none';
            
            // Show tabs based on role
            if (user.role === 'admin' || user.role === 'internal') {
                // Admin/Internal users see ALL tabs including external
                document.getElementById('external-tab-btn').style.display = 'inline-block';
                document.getElementById('internal-tab-btn').style.display = 'inline-block';
                document.getElementById('internal-data-tab-btn').style.display = 'inline-block';
                document.getElementById('account-management-tab-btn').style.display = 'inline-block';
                
                // Show internal database by default
                showTab('internal');
                // renderInternalDBCityList() is called by showTab('internal')
            } else {
                // Regular users only see external data request
                document.getElementById('external-tab-btn').style.display = 'inline-block';
                showTab('external');
            }
        }

        function setupPasswordModals() {
            // Internal password modal
            const internalPasswordModal = document.getElementById('internal-password-modal');
            const internalPasswordInput = document.getElementById('internal-password-input');
            const internalEmailInput = document.getElementById('internal-email-input');
            const internalPasswordSubmit = document.getElementById('internal-password-submit');
            const internalPasswordCancel = document.getElementById('internal-password-cancel');
            const internalPasswordError = document.getElementById('internal-password-error');
            
            console.log('[LOGIN SETUP] Internal password submit button found:', !!internalPasswordSubmit);
            console.log('[LOGIN SETUP] Internal password cancel button found:', !!internalPasswordCancel);
            console.log('[LOGIN SETUP] Internal password error div found:', !!internalPasswordError);

            // Enterprise Build: Internal login with API
            internalPasswordSubmit.onclick = async function() {
                console.log('[LOGIN] Internal login button clicked');
                const email = (internalEmailInput?.value || '').trim().toLowerCase();
                const password = internalPasswordInput.value;
                
                console.log('[LOGIN] Email:', email, 'Password length:', password.length);
                
                if (!email || !password) {
                    console.log('[LOGIN] Missing email or password');
                    internalPasswordError.textContent = 'Please enter both email and password';
                    internalPasswordError.classList.remove('hidden');
                    return;
                }
                
                // Disable button during request
                internalPasswordSubmit.disabled = true;
                internalPasswordSubmit.textContent = 'Logging in...';
                
                try {
                    // Check if apiClient is available
                    if (!window.apiClient) {
                        console.error('[LOGIN] API client not available');
                        throw new Error('API client not loaded. Make sure the server is running and you opened the file through a web server (not file://).');
                    }
                    
                    console.log('[LOGIN] Calling apiClient.login...');
                    console.log('[LOGIN] API Base URL:', window.API_BASE_URL || 'http://localhost:4000/api');
                    const result = await apiClient.login({ email, password });
                    console.log('[LOGIN] Login result:', result);
                    
                    if (result.user && result.token) {
                        // Success - close modal and route user
                        internalPasswordModal.classList.add('hidden');
                        internalPasswordInput.value = '';
                        if (internalEmailInput) internalEmailInput.value = '';
                        internalPasswordError.classList.add('hidden');
                        
                        // Record login event if function exists
                        if (typeof recordLoginEvent === 'function') {
                            recordLoginEvent({ user: email, role: result.user.role, outcome: 'success' });
                        }
                        
                        // Route based on role
                        handleLoggedInUser(result.user);
                    } else {
                        throw new Error('Invalid response from server');
                    }
                } catch (err) {
                    console.error('Login error:', err);
                    let errorMsg = err.message || 'Incorrect email or password';
                    
                    // Provide helpful error messages
                    if (err.message && err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
                        errorMsg = 'Cannot connect to server. Make sure the server is running (npm run dev in server folder) and you opened this file through http://localhost (not file://).';
                    } else if (err.message && err.message.includes('API client not loaded')) {
                        errorMsg = err.message;
                    }
                    
                    internalPasswordError.textContent = errorMsg;
                    internalPasswordError.classList.remove('hidden');
                    
                    // Record failed login if function exists
                    if (typeof recordLoginEvent === 'function') {
                        recordLoginEvent({ user: email, role: 'internal', outcome: 'failure' });
                    }
                } finally {
                    internalPasswordSubmit.disabled = false;
                    internalPasswordSubmit.textContent = 'Login';
                }
            };

            // Add Enter key support for internal password
            internalPasswordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    internalPasswordSubmit.click();
                }
            });

            internalPasswordCancel.onclick = function() {
                internalPasswordModal.classList.add('hidden');
                internalPasswordInput.value = '';
                internalPasswordError.classList.add('hidden');
            };

            // External password modal
            const externalPasswordModal = document.getElementById('external-password-modal');
            const externalPasswordInput = document.getElementById('external-password-input');
            const externalEmailInput = document.getElementById('external-email-input');
            const externalPasswordSubmit = document.getElementById('external-password-submit');
            const externalPasswordCancel = document.getElementById('external-password-cancel');
            const externalPasswordError = document.getElementById('external-password-error');
            
            // Signup form elements
            const externalSignupEmail = document.getElementById('external-signup-email');
            const externalSignupPassword = document.getElementById('external-signup-password');
            const externalSignupOrgCode = document.getElementById('external-signup-org-code');
            const externalSignupSubmit = document.getElementById('external-signup-submit');
            const externalSignupError = document.getElementById('external-signup-error');
            
            // Tab switching
            const externalLoginTab = document.getElementById('external-login-tab');
            const externalSignupTab = document.getElementById('external-signup-tab');
            const externalLoginForm = document.getElementById('external-login-form');
            const externalSignupForm = document.getElementById('external-signup-form');
            
            // Switch to login tab
            if (externalLoginTab) {
                externalLoginTab.onclick = function() {
                    externalLoginForm.style.display = 'block';
                    externalSignupForm.style.display = 'none';
                    externalLoginTab.style.borderBottom = '2px solid var(--primary-blue)';
                    externalLoginTab.style.color = 'var(--primary-blue)';
                    externalSignupTab.style.borderBottom = 'none';
                    externalSignupTab.style.color = 'var(--text-secondary)';
                    // Clear errors
                    externalPasswordError.classList.add('hidden');
                    externalSignupError.classList.add('hidden');
                };
            }
            
            // Switch to signup tab
            if (externalSignupTab) {
                externalSignupTab.onclick = function() {
                    externalLoginForm.style.display = 'none';
                    externalSignupForm.style.display = 'block';
                    externalSignupTab.style.borderBottom = '2px solid var(--primary-blue)';
                    externalSignupTab.style.color = 'var(--primary-blue)';
                    externalLoginTab.style.borderBottom = 'none';
                    externalLoginTab.style.color = 'var(--text-secondary)';
                    // Clear errors
                    externalPasswordError.classList.add('hidden');
                    externalSignupError.classList.add('hidden');
                };
            }

            // Enterprise Build: External login with API
            externalPasswordSubmit.onclick = async function() {
                console.log('[LOGIN] External login button clicked');
                const email = (externalEmailInput?.value || '').trim().toLowerCase();
                const password = externalPasswordInput.value;
                
                console.log('[LOGIN] Email:', email, 'Password length:', password.length);
                
                if (!email || !password) {
                    console.log('[LOGIN] Missing email or password');
                    externalPasswordError.textContent = 'Please enter both email and password';
                    externalPasswordError.classList.remove('hidden');
                    return;
                }
                
                // Disable button during request
                externalPasswordSubmit.disabled = true;
                externalPasswordSubmit.textContent = 'Logging in...';
                
                try {
                    console.log('[LOGIN] Calling apiClient.login...');
                    console.log('[LOGIN] API Base URL:', window.API_BASE_URL || 'http://localhost:4000/api');
                    const result = await apiClient.login({ email, password });
                    console.log('[LOGIN] Login result:', result);
                    
                    if (result.user && result.token) {
                        // Success - close modal and route user
                        externalPasswordModal.classList.add('hidden');
                        externalPasswordInput.value = '';
                        if (externalEmailInput) externalEmailInput.value = '';
                        externalPasswordError.classList.add('hidden');
                        
                        // Route based on role
                        handleLoggedInUser(result.user);
                    } else {
                        throw new Error('Invalid response from server');
                    }
                } catch (err) {
                    externalPasswordError.textContent = err.message || 'Incorrect email or password';
                    externalPasswordError.classList.remove('hidden');
                } finally {
                    externalPasswordSubmit.disabled = false;
                    externalPasswordSubmit.textContent = 'Login';
                }
            };

            // Enterprise Build: External signup with API
            if (externalSignupSubmit) {
                externalSignupSubmit.onclick = async function() {
                    const email = (externalSignupEmail?.value || '').trim().toLowerCase();
                    const password = externalSignupPassword?.value || '';
                    const orgCode = (externalSignupOrgCode?.value || '').trim();
                    
                    if (!email || !password || !orgCode) {
                        externalSignupError.textContent = 'Please fill in all fields';
                        externalSignupError.classList.remove('hidden');
                        return;
                    }
                    
                    if (password.length < 8) {
                        externalSignupError.textContent = 'Password must be at least 8 characters';
                        externalSignupError.classList.remove('hidden');
                        return;
                    }
                    
                    // Disable button during request
                    externalSignupSubmit.disabled = true;
                    externalSignupSubmit.textContent = 'Creating account...';
                    
                    try {
                        const result = await apiClient.signup({ email, password, orgCode });
                        
                        if (result.user && result.token) {
                            // Success - close modal and route user
                            externalPasswordModal.classList.add('hidden');
                            externalSignupEmail.value = '';
                            externalSignupPassword.value = '';
                            externalSignupOrgCode.value = '';
                            externalSignupError.classList.add('hidden');
                            
                            // Show success message
                            if (typeof showNotification === 'function') {
                                showNotification('Account created successfully!');
                            }
                            
                            // Route based on role (should be 'user' for new signups)
                            handleLoggedInUser(result.user);
                        } else {
                            throw new Error('Invalid response from server');
                        }
                    } catch (err) {
                        externalSignupError.textContent = err.message || 'Failed to create account. Please check your organization code.';
                        externalSignupError.classList.remove('hidden');
                    } finally {
                        externalSignupSubmit.disabled = false;
                        externalSignupSubmit.textContent = 'Create Account';
                    }
                };
            }

            // Add Enter key support for external login
            if (externalPasswordInput) {
                externalPasswordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        externalPasswordSubmit.click();
                    }
                });
            }
            
            if (externalEmailInput) {
                externalEmailInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        externalPasswordSubmit.click();
                    }
                });
            }
            
            // Add Enter key support for external signup
            if (externalSignupPassword) {
                externalSignupPassword.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        externalSignupSubmit?.click();
                    }
                });
            }
            
            if (externalSignupOrgCode) {
                externalSignupOrgCode.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        externalSignupSubmit?.click();
                    }
                });
            }

            externalPasswordCancel.onclick = function() {
                externalPasswordModal.classList.add('hidden');
                externalPasswordInput.value = '';
                if (externalEmailInput) externalEmailInput.value = '';
                externalPasswordError.classList.add('hidden');
                externalSignupError.classList.add('hidden');
                // Reset to login tab
                if (externalLoginTab) externalLoginTab.click();
            };
        }

        function setupTabSwitching() {
            const externalTabBtn = document.getElementById('external-tab-btn');
            const internalTabBtn = document.getElementById('internal-tab-btn');
            const internalDataTabBtn = document.getElementById('internal-data-tab-btn');
            const accountManagementTabBtn = document.getElementById('account-management-tab-btn');

            // Tab button event listeners
            if (externalTabBtn) {
                externalTabBtn.addEventListener('click', () => showTab('external'));
            }
            if (internalTabBtn) {
                internalTabBtn.addEventListener('click', () => showTab('internal'));
            }
            if (internalDataTabBtn) {
                internalDataTabBtn.addEventListener('click', () => showTab('internal-data'));
            }
            if (accountManagementTabBtn) {
                accountManagementTabBtn.addEventListener('click', () => showTab('account-management'));
            }

            // Tab buttons and profile menu handle logout now
        }

        function showTab(tabName) {
            // Hide all containers
            document.getElementById('main-container').classList.add('hidden');
            document.getElementById('internal-container').classList.add('hidden');
            document.getElementById('internal-data-request-container').classList.add('hidden');
            document.getElementById('account-management-container').classList.add('hidden');
            document.getElementById('external-thankyou').classList.add('hidden');

            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));

            // Show selected container and activate tab
            if (tabName === 'external') {
                document.getElementById('main-container').classList.remove('hidden');
                document.getElementById('external-tab-btn').classList.add('active');
            } else if (tabName === 'internal') {
                document.getElementById('internal-container').classList.remove('hidden');
                document.getElementById('internal-tab-btn').classList.add('active');
                // Load from API and render (async, but don't await to avoid blocking UI)
                renderInternalDBCityList().catch(err => console.error('Error loading internal database:', err));
            } else if (tabName === 'internal-data') {
                const container = document.getElementById('internal-data-request-container');
                if (container) {
                    container.classList.remove('hidden');
                    container.style.display = 'block';
                    container.style.visibility = 'visible';
                    container.style.opacity = '1';
                }
                document.getElementById('internal-data-tab-btn').classList.add('active');
            } else if (tabName === 'account-management') {
                const container = document.getElementById('account-management-container');
                if (container) {
                    container.classList.remove('hidden');
                    container.style.display = 'block';
                    container.style.visibility = 'visible';
                    container.style.opacity = '1';
                }
                document.getElementById('account-management-tab-btn').classList.add('active');
                renderAccountsTable();
                renderLoginAudit();
                renderClientGroups();
            }
        }

        function setupFormSubmissions() {
            // External form submission
            const projectForm = document.getElementById('project-form');
            if (projectForm) {
                console.log('Setting up external form submission handler');
                projectForm.onsubmit = async function(e) {
                    console.log('External form submit triggered');
                    e.preventDefault();
                    
                    // Check form validity
                    if (!projectForm.checkValidity()) {
                        console.log('Form validation failed');
                        projectForm.reportValidity();
                        return false;
                    }
                    
                    console.log('Form validation passed, processing submission');
                    
                    // Check if we're in edit mode
                    if (currentEditingSubmissionId) {
                        // Update existing submission
                        await saveCurrentForm(currentEditingSubmissionId, false);
                        showNotification('Project updated successfully!');
                        
                        // Clear edit mode
                        currentEditingSubmissionId = null;
                        if (autoSaveInterval) {
                            clearInterval(autoSaveInterval);
                            autoSaveInterval = null;
                        }
                        const indicator = document.getElementById('auto-save-indicator-external');
                        if (indicator) indicator.style.display = 'none';
                        
                        // Re-enable Client/Project dropdowns
                        const agencyDropdown = document.getElementById('external-agency-dropdown');
                        const projectDropdown = document.getElementById('external-project-dropdown');
                        if (agencyDropdown) {
                            agencyDropdown.disabled = false;
                            agencyDropdown.style.backgroundColor = '';
                            agencyDropdown.style.cursor = '';
                        }
                        if (projectDropdown) {
                            projectDropdown.disabled = false;
                            projectDropdown.style.backgroundColor = '';
                            projectDropdown.style.cursor = '';
                        }
                        
                        // Reset button text
                        const submitBtn = projectForm.querySelector('button[type="submit"]');
                        if (submitBtn) {
                            submitBtn.textContent = 'Add Project Area';
                            delete submitBtn.dataset.editMode;
                        }
                        
                        // Go back to Internal Database
                        showTab('internal');
                        return false;
                    }
                    
                    const formData = new FormData(projectForm);
                    const submission = {};
                    
                    // Declare variables at function scope so they're available later
                    const countyDropdown = document.getElementById('external-county-dropdown');
                    const newCountyInput = document.getElementById('external-new-county-input');
                    const newAgencyInput = document.getElementById('external-new-agency-input');
                    const newProjectInput = document.getElementById('external-new-project-input');
                    
                    if (countyDropdown && countyDropdown.value && countyDropdown.value !== '__ADD_NEW_COUNTY__') {
                        submission.county = countyDropdown.value;
                    } else if (newCountyInput && newCountyInput.value.trim()) {
                        submission.county = newCountyInput.value.trim();
                    }
                    
                    // Get agency/submitter name from dropdown (should be set after saving)
                    const agencyDropdown = document.getElementById('external-agency-dropdown');
                    if (agencyDropdown && agencyDropdown.value && agencyDropdown.value !== '__ADD_NEW_AGENCY__') {
                        submission.submitterName = agencyDropdown.value;
                    } else {
                        // Fallback: check if there's a value in the new input (shouldn't happen if saved properly)
                        if (newAgencyInput && newAgencyInput.value) {
                            submission.submitterName = newAgencyInput.value.trim();
                        }
                    }
                    
                    // Get project area name from dropdown (should be set after saving)
                    const projectDropdown = document.getElementById('external-project-dropdown');
                    if (projectDropdown && projectDropdown.value && projectDropdown.value !== '__ADD_NEW_PROJECT__') {
                        submission.projectAreaName = projectDropdown.value;
                    } else {
                        // Fallback: check if there's a value in the new input (shouldn't happen if saved properly)
                        if (newProjectInput && newProjectInput.value) {
                            submission.projectAreaName = newProjectInput.value.trim();
                        }
                    }
                    
                    // Capture all other form data
                    for (let [key, value] of formData.entries()) {
                        // Skip the special dropdown values and new input fields (we already handled them)
                        if (key !== 'county' && key !== 'submitterName' && key !== 'projectAreaName' && 
                            key !== 'newAgencyName' && key !== 'newProjectAreaName' &&
                            value !== '__ADD_NEW_AGENCY__' && value !== '__ADD_NEW_PROJECT__') {
                            submission[key] = value;
                        }
                    }
                    
                    // Capture all dynamic expense data
                    const expenseRows = document.querySelectorAll('.expense-row');
                    expenseRows.forEach((row, index) => {
                        const expenseTitle = row.querySelector(`input[name="expenseTitle_${index}"]`)?.value;
                        const tyExpense = row.querySelector(`input[name="tyExpense_${index}"]`)?.value;
                        const cyExpense = row.querySelector(`input[name="cyExpense_${index}"]`)?.value;
                        const nyExpense = row.querySelector(`input[name="nyExpense_${index}"]`)?.value;
                        
                        if (expenseTitle || tyExpense || cyExpense || nyExpense) {
                            submission[`expenseTitle_${index}`] = expenseTitle;
                            submission[`tyExpense_${index}`] = tyExpense;
                            submission[`cyExpense_${index}`] = cyExpense;
                            submission[`nyExpense_${index}`] = nyExpense;
                        }
                    });
                    
                    // Also keep the expenses array for compatibility
                    const expenses = [];
                    expenseRows.forEach((row, index) => {
                        const expenseTitle = row.querySelector(`input[name="expenseTitle_${index}"]`)?.value;
                        const tyExpense = row.querySelector(`input[name="tyExpense_${index}"]`)?.value;
                        const cyExpense = row.querySelector(`input[name="cyExpense_${index}"]`)?.value;
                        const nyExpense = row.querySelector(`input[name="nyExpense_${index}"]`)?.value;
                        
                        if (expenseTitle || tyExpense || cyExpense || nyExpense) {
                            expenses.push({
                                title: expenseTitle,
                                tyExpense: tyExpense,
                                cyExpense: cyExpense,
                                nyExpense: nyExpense
                            });
                        }
                    });
                    
                    submission.expenses = expenses;
                    
                    // Capture PDF data
                    submission.projectAreaMaps = uploadedPDFs;
                    
                    submission.timestamp = new Date().toISOString();
                    
                    // Add to current submission
                    if (!currentSubmission.projectAreas) {
                        currentSubmission.projectAreas = [];
                    }
                    currentSubmission.projectAreas.push(submission);
                    console.log('Project area added to currentSubmission:', submission);
                    console.log('Total project areas now:', currentSubmission.projectAreas.length);
                    
                    // Clear form
                    projectForm.reset();
                    
                    // Reset dropdowns and hide new input containers (reuse variables already declared above)
                    const newCountyContainer = document.getElementById('external-new-county-container');
                    const newAgencyContainer = document.getElementById('external-new-agency-container');
                    const newProjectContainer = document.getElementById('external-new-project-container');
                    
                    if (newCountyContainer) {
                        newCountyContainer.style.display = 'none';
                    }
                    if (newCountyInput) {
                        newCountyInput.value = '';
                        newCountyInput.required = false;
                    }
                    if (newAgencyContainer) {
                        newAgencyContainer.style.display = 'none';
                    }
                    if (newAgencyInput) {
                        newAgencyInput.value = '';
                        newAgencyInput.required = false;
                    }
                    if (newProjectContainer) {
                        newProjectContainer.style.display = 'none';
                    }
                    if (newProjectInput) {
                        newProjectInput.value = '';
                        newProjectInput.required = false;
                    }
                    
                    // Repopulate dropdowns
                    await populateExternalCountyDropdown(false);
                    await handleExternalCountyChange();
                    
                    // Clear uploaded PDFs
                    uploadedPDFs = [];
                    updateUploadedMapsList();
                    
                    // Clear expense rows and add default
                    const expenseContainer = document.getElementById('expense-container');
                    if (expenseContainer) {
                        expenseContainer.innerHTML = '';
                        // Add back the default expense row
                        addExpenseRow();
                    }
                    
                    // Show table
                    try {
                        renderTable();
                        console.log('Table rendered successfully');
                    } catch (error) {
                        console.error('Error rendering table:', error);
                    }
                    
                    // Show notification
                    try {
                        showNotification('Project area added successfully!');
                        showNotification('Project area submitted.');
                    } catch (error) {
                        console.error('Error showing notification:', error);
                        alert('Project area added successfully!');
                    }
                    
                    console.log('Project area added:', submission);

                    // Enterprise Build: Save to backend API
                    if (window.apiClient && window.currentUser) {
                        try {
                            const year = parseInt(submission.year || formData.get('year') || new Date().getFullYear());
                            const result = await apiClient.createSubmission({ 
                                year, 
                                payload: submission 
                            });
                            
                            console.log('Submission saved to server:', result);
                            
                            // Upload PDFs if any were added
                            if (uploadedPDFs.length > 0 && result.submission && result.submission.id) {
                                console.log(`Uploading ${uploadedPDFs.length} PDF file(s)...`);
                                for (const pdf of uploadedPDFs) {
                                    if (pdf.file) {
                                        try {
                                            await apiClient.uploadFile({
                                                submissionId: result.submission.id,
                                                file: pdf.file
                                            });
                                            console.log(`âœ“ Uploaded: ${pdf.name}`);
                                        } catch (uploadErr) {
                                            console.error(`Failed to upload ${pdf.name}:`, uploadErr);
                                        }
                                    }
                                }
                            }
                            
                            // Show success message
                            showNotification('Submission saved to server successfully!');
                            
                            // Reset form after successful submission
                            projectForm.reset();
                            
                        } catch (err) {
                            console.error('Failed to save submission to server:', err);
                            // Still show success for local storage, but warn about server
                            showNotification('Saved locally, but server save failed. Check your connection.');
                        }
                    } else {
                        console.warn('API client or user not available - submission only saved locally');
                    }
                };
            } else {
                console.error('External form not found!');
            }

            // Setup remaining life calculation
            const expirationYearInput = document.querySelector('input[name="expirationYear"]');
            if (expirationYearInput) {
                expirationYearInput.addEventListener('input', calculateRemainingLife);
                expirationYearInput.addEventListener('change', calculateRemainingLife);
            }

            // Internal form submission
            const internalForm = document.getElementById('internal-data-request-form');
            if (internalForm) {
                console.log('Setting up internal form submission handler');
                internalForm.onsubmit = async function(e) {
                    console.log('Internal form submit triggered');
                    e.preventDefault();
                    
                    // Check if we're in edit mode
                    if (currentEditingSubmissionId) {
                        // Update existing submission
                        await saveCurrentForm(currentEditingSubmissionId, false);
                        showNotification('Project updated successfully!');
                        
                        // Clear edit mode
                        currentEditingSubmissionId = null;
                        if (autoSaveInterval) {
                            clearInterval(autoSaveInterval);
                            autoSaveInterval = null;
                        }
                        const indicator = document.getElementById('auto-save-indicator');
                        if (indicator) indicator.style.display = 'none';
                        
                        // Re-enable Client/Project dropdowns
                        const clientDropdown = document.getElementById('internal-city-dropdown');
                        const projectDropdown = document.getElementById('internal-project-dropdown');
                        if (clientDropdown) {
                            clientDropdown.disabled = false;
                            clientDropdown.style.backgroundColor = '';
                            clientDropdown.style.cursor = '';
                        }
                        if (projectDropdown) {
                            projectDropdown.disabled = false;
                            projectDropdown.style.backgroundColor = '';
                            projectDropdown.style.cursor = '';
                        }
                        
                        // Reset button text
                        const submitBtn = internalForm.querySelector('button[type="submit"]');
                        if (submitBtn) {
                            submitBtn.textContent = 'Submit Data Request';
                            delete submitBtn.dataset.editMode;
                        }
                        
                        // Go back to Internal Database
                        showTab('internal');
                        return false;
                    }
                    
                    // Skip all validation - allow submission with any data
                    console.log('Processing internal form submission (no validation)');
                    const formData = new FormData(internalForm);
                    const submission = {};
                    
                    // Capture all form data
                    for (let [key, value] of formData.entries()) {
                        submission[key] = value;
                    }
                    
                    // Capture expense data
                    const expenseRows = document.querySelectorAll('.expense-row');
                    const expenses = [];
                    expenseRows.forEach((row, index) => {
                        const expenseTitle = row.querySelector(`input[name="expenseTitle_${index}"]`)?.value;
                        const tyExpense = row.querySelector(`input[name="tyExpense_${index}"]`)?.value;
                        const cyExpense = row.querySelector(`input[name="cyExpense_${index}"]`)?.value;
                        const nyExpense = row.querySelector(`input[name="nyExpense_${index}"]`)?.value;
                        
                        if (expenseTitle || tyExpense || cyExpense || nyExpense) {
                            expenses.push({
                                title: expenseTitle,
                                tyExpense: tyExpense,
                                cyExpense: cyExpense,
                                nyExpense: nyExpense
                            });
                        }
                    });
                    
                    submission.expenses = expenses;
                    
                    // Capture all dynamic tax entity data
                    const taxEntityRows = document.querySelectorAll('.tax-entity-row');
                    taxEntityRows.forEach((row, index) => {
                        const taxEntityName = row.querySelector(`input[name="taxEntityName_${index}"]`)?.value;
                        const participationRate = row.querySelector(`input[name="taxEntityParticipationRate_${index}"]`)?.value;
                        const remittance = row.querySelector(`input[name="taxEntityRemittance_${index}"]`)?.value;
                        const capAmount = row.querySelector(`input[name="taxEntityCapAmount_${index}"]`)?.value;
                        const incrementPaid = row.querySelector(`input[name="taxEntityIncrementPaid_${index}"]`)?.value;
                        const remainingAuthorized = row.querySelector(`input[name="taxEntityRemainingAuthorized_${index}"]`)?.value;
                        const percentOfTotal = row.querySelector(`input[name="taxEntityPercentOfTotal_${index}"]`)?.value;
                        
                        // Capture tax rate data
                        const rateSource = row.querySelector(`select[name="taxEntityRateSource_${index}"]`)?.value;
                        const rateMaster = row.querySelector(`select[name="taxEntityRateMaster_${index}"]`)?.value;
                        const rateCustom = row.querySelector(`input[name="taxEntityRateCustom_${index}"]`)?.value;
                        const rateValue = row.querySelector(`input[name="taxEntityRate_${index}"]`)?.value;
                        const rateYear = row.querySelector(`input[name="taxEntityRateYear_${index}"]`)?.value;
                        
                        if (taxEntityName || participationRate || remittance || capAmount || incrementPaid || remainingAuthorized || percentOfTotal || rateValue) {
                            submission[`taxEntityName_${index}`] = taxEntityName;
                            submission[`taxEntityParticipationRate_${index}`] = participationRate;
                            submission[`taxEntityRemittance_${index}`] = remittance;
                            submission[`taxEntityCapAmount_${index}`] = capAmount;
                            submission[`taxEntityIncrementPaid_${index}`] = incrementPaid;
                            submission[`taxEntityRemainingAuthorized_${index}`] = remainingAuthorized;
                            submission[`taxEntityPercentOfTotal_${index}`] = percentOfTotal;
                            
                            // Store tax rate data
                            submission[`taxEntityRateSource_${index}`] = rateSource;
                            submission[`taxEntityRateMaster_${index}`] = rateMaster;
                            submission[`taxEntityRateCustom_${index}`] = rateCustom;
                            submission[`taxEntityRate_${index}`] = rateValue;
                            submission[`taxEntityRateYear_${index}`] = rateYear;
                        }
                    });
                    
                    // Capture all dynamic total expense data
                    const totalExpenseRows = document.querySelectorAll('.total-expense-row');
                    totalExpenseRows.forEach((row, index) => {
                        const description = row.querySelector(`input[name="totalExpenseDescription_${index}"]`)?.value;
                        const amount = row.querySelector(`input[name="totalExpenseAmount_${index}"]`)?.value;
                        const npv = row.querySelector(`input[name="totalExpenseNpv_${index}"]`)?.value;
                        
                        if (description || amount || npv) {
                            submission[`totalExpenseDescription_${index}`] = description;
                            submission[`totalExpenseAmount_${index}`] = amount;
                            submission[`totalExpenseNpv_${index}`] = npv;
                        }
                    });
                    
                    // Capture Governing Board data
                    const governingBoardRows = document.querySelectorAll('.governing-board-row');
                    governingBoardRows.forEach((row, index) => {
                        const name = row.querySelector(`input[name="governingBoardName_${index}"]`)?.value;
                        const title = row.querySelector(`input[name="governingBoardTitle_${index}"]`)?.value;
                        
                        if (name || title) {
                            submission[`governingBoardName_${index}`] = name;
                            submission[`governingBoardTitle_${index}`] = title;
                        }
                    });
                    
                    // Capture Agency Staff data
                    const agencyStaffRows = document.querySelectorAll('.agency-staff-row');
                    agencyStaffRows.forEach((row, index) => {
                        const name = row.querySelector(`input[name="agencyStaffName_${index}"]`)?.value;
                        const title = row.querySelector(`input[name="agencyStaffTitle_${index}"]`)?.value;
                        
                        if (name || title) {
                            submission[`agencyStaffName_${index}`] = name;
                            submission[`agencyStaffTitle_${index}`] = title;
                        }
                    });
                    
                    // Capture Increment Distribution data
                    const incrementDistributionRows = document.querySelectorAll('.increment-distribution-row');
                    incrementDistributionRows.forEach((row, index) => {
                        const entity = row.querySelector(`input[name="incrementEntity_${index}"]`)?.value;
                        const actual = row.querySelector(`input[name="incrementActual_${index}"]`)?.value;
                        const remaining = row.querySelector(`input[name="incrementRemaining_${index}"]`)?.value;
                        
                        if (entity || actual || remaining) {
                            submission[`incrementEntity_${index}`] = entity;
                            submission[`incrementActual_${index}`] = actual;
                            submission[`incrementRemaining_${index}`] = remaining;
                        }
                    });
                    
                    // Capture Sources of Funds data
                    const sourcesOfFundsRows = document.querySelectorAll('.sources-of-funds-row');
                    sourcesOfFundsRows.forEach((row, index) => {
                        const description = row.querySelector(`input[name="revenueSourceDescription_${index}"]`)?.value;
                        const actual2025 = row.querySelector(`input[name="revenueSource2025Actual_${index}"]`)?.value;
                        const forecast2026 = row.querySelector(`input[name="revenueSource2026Forecast_${index}"]`)?.value;
                        const forecast2027 = row.querySelector(`input[name="revenueSource2027Forecast_${index}"]`)?.value;
                        
                        if (description || actual2025 || forecast2026 || forecast2027) {
                            submission[`revenueSourceDescription_${index}`] = description;
                            submission[`revenueSource2025Actual_${index}`] = actual2025;
                            submission[`revenueSource2026Forecast_${index}`] = forecast2026;
                            submission[`revenueSource2027Forecast_${index}`] = forecast2027;
                        }
                    });
                    
                    // Capture Tax Increment Summary data
                    const taxIncrementSummaryRows = document.querySelectorAll('.tax-increment-summary-row');
                    const taxIncrementEntities = [];
                    taxIncrementSummaryRows.forEach((row, index) => {
                        const entity = row.querySelector(`input[name="taxIncrementEntity_${index}"]`)?.value;
                        const yearActual = row.querySelector(`input[name="taxIncrementYearActual_${index}"]`)?.value;
                        const remainingAuthorized = row.querySelector(`input[name="taxIncrementRemainingAuthorized_${index}"]`)?.value;
                        
                        if (entity || yearActual || remainingAuthorized) {
                            taxIncrementEntities.push({
                                entity: entity || '',
                                yearActual: yearActual ? parseFloat(yearActual) : 0,
                                remainingAuthorized: remainingAuthorized ? parseFloat(remainingAuthorized) : 0
                            });
                        }
                    });
                    if (taxIncrementEntities.length > 0) {
                        submission.taxIncrementEntities = taxIncrementEntities;
                    }
                    
                    // Add timestamp
                    submission.timestamp = new Date().toISOString();
                    
                    // Find the matching submission by client, project area, AND year
                    const matchingSubmission = allSubmissions.find(sub => {
                        const externalClient = sub.submitterName || sub.cityCounty;
                        const externalProject = sub.projectAreaName || sub.projectArea;
                        const externalYear = sub.fy || sub.year;
                        const internalClient = submission.cityCounty;
                        const internalProject = submission.projectArea;
                        const internalYear = submission.fy;
                        return externalClient === internalClient && externalProject === internalProject && externalYear === internalYear;
                    });
                    
                    if (matchingSubmission) {
                        // Merge internal data with external data
                        Object.assign(matchingSubmission, submission);
                        console.log('Internal data merged with external submission:', matchingSubmission);
                    } else {
                        // If no matching external submission, add as new submission
                        allSubmissions.push(submission);
                        console.log('New internal submission added:', submission);
                    }
                    
                    // Enterprise Build: Save to backend API
                    if (window.apiClient && window.currentUser) {
                        try {
                            const year = parseInt(submission.fy || submission.year || new Date().getFullYear());
                            const result = await apiClient.createSubmission({ 
                                year, 
                                payload: submission 
                            });
                            
                            console.log('Internal submission saved to server:', result);
                            
                            // Show success message
                            showNotification('Internal submission saved to server successfully!');
                        } catch (err) {
                            console.error('Failed to save internal submission to server:', err);
                            // Still save locally as fallback
                            localStorage.setItem('allSubmissions', JSON.stringify(allSubmissions));
                            showNotification('Saved locally, but server save failed. Check your connection.');
                        }
                    } else {
                        // Fallback to localStorage if API not available
                        localStorage.setItem('allSubmissions', JSON.stringify(allSubmissions));
                        console.warn('API client or user not available - submission only saved locally');
                    }
                    
                    // Clear form
                    internalForm.reset();
                    
                    // Clear expense rows
                    try {
                        const expenseContainer = document.getElementById('expense-container');
                        if (expenseContainer) {
                            expenseContainer.innerHTML = '';
                            // Add back the default expense row
                            addExpenseRow();
                        }
                        console.log('Expense rows cleared and reset');
                    } catch (error) {
                        console.error('Error clearing expense rows:', error);
                    }
                    
                    // Clear Governing Board and Agency Staff sections
                    try {
                        const governingBoardContainer = document.getElementById('governing-board-container');
                        const agencyStaffContainer = document.getElementById('agency-staff-container');
                        
                        if (governingBoardContainer) {
                            governingBoardContainer.innerHTML = `
                                <div class="governing-board-row" style="display: flex; gap: 16px; margin-bottom: 16px; align-items: end;">
                                    <div class="form-row" style="flex: 1;">
                                        <label>Name:</label>
                                        <input type="text" name="governingBoardName_0" placeholder="Board Member Name">
                                    </div>
                                    <div class="form-row" style="flex: 1;">
                                        <label>Title:</label>
                                        <input type="text" name="governingBoardTitle_0" placeholder="Board Member Title">
                                    </div>
                                    <button type="button" class="btn btn-secondary" onclick="removeGoverningBoardRow(this)" style="padding: 6px 12px; font-size: 12px; margin-bottom: 0;">Remove</button>
                                </div>
                            `;
                        }
                        
                        if (agencyStaffContainer) {
                            agencyStaffContainer.innerHTML = `
                                <div class="agency-staff-row" style="display: flex; gap: 16px; margin-bottom: 16px; align-items: end;">
                                    <div class="form-row" style="flex: 1;">
                                        <label>Name:</label>
                                        <input type="text" name="agencyStaffName_0" placeholder="Staff Member Name">
                                    </div>
                                    <div class="form-row" style="flex: 1;">
                                        <label>Title:</label>
                                        <input type="text" name="agencyStaffTitle_0" placeholder="Staff Member Title">
                                    </div>
                                    <button type="button" class="btn btn-secondary" onclick="removeAgencyStaffRow(this)" style="padding: 6px 12px; font-size: 12px; margin-bottom: 0;">Remove</button>
                                </div>
                            `;
                        }
                        
                        console.log('Governing Board and Agency Staff sections cleared and reset');
                    } catch (error) {
                        console.error('Error clearing Governing Board and Agency Staff sections:', error);
                    }
                    
                    // Clear Increment Distribution section
                    try {
                        const incrementDistributionContainer = document.getElementById('increment-distribution-container');
                        if (incrementDistributionContainer) {
                            incrementDistributionContainer.innerHTML = `
                                <div class="increment-distribution-row" style="display: flex; gap: 16px; margin-bottom: 16px; align-items: end;">
                                    <div class="form-row" style="flex: 1;">
                                        <label>Entity Description:</label>
                                        <input type="text" name="incrementEntity_0" placeholder="Taxing Entity Name">
                                    </div>
                                    <div class="form-row" style="flex: 1;">
                                        <label>Actual Received:</label>
                                        <input type="number" name="incrementActual_0" step="0.01" placeholder="0.00">
                                    </div>
                                    <div class="form-row" style="flex: 1;">
                                        <label>Amount Remaining Authorized:</label>
                                        <input type="number" name="incrementRemaining_0" step="0.01" placeholder="0.00">
                                    </div>
                                    <button type="button" class="btn btn-secondary" onclick="removeIncrementDistributionRow(this)" style="padding: 6px 12px; font-size: 12px; margin-bottom: 0;">Remove</button>
                                </div>
                            `;
                        }
                        console.log('Increment Distribution section cleared and reset');
                    } catch (error) {
                        console.error('Error clearing Increment Distribution section:', error);
                    }
                    
                    // Show notification
                    try {
                        showNotification('Internal data submitted successfully!');
                    } catch (error) {
                        console.error('Error showing notification:', error);
                        alert('Internal data submitted successfully!');
                    }
                    
                    // Switch to internal database view to show the new submission
                    try {
                        showTab('internal');
                    } catch (error) {
                        console.error('Error switching to internal tab:', error);
                    }
                    
                    console.log('Submission saved:', submission);
                };
            } else {
                console.error('Internal form not found!');
            }

            // Submit all button
            const submitAllBtn = document.getElementById('external-submit-all-btn');
            if (submitAllBtn) {
                submitAllBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    console.log('Submit All clicked');
                    try {
                        // Ensure allSubmissions is an array
                        if (!Array.isArray(allSubmissions)) {
                            console.warn('allSubmissions was not an array. Resetting to empty array.');
                            allSubmissions = [];
                        }

                        if (currentSubmission && Array.isArray(currentSubmission.projectAreas) && currentSubmission.projectAreas.length > 0) {
                            const submittedCount = currentSubmission.projectAreas.length;
                            console.log('Project areas to submit:', submittedCount);
                            currentSubmission.projectAreas.forEach((projectArea, idx) => {
                                console.log('Adding project area', idx, projectArea);
                                allSubmissions.push(projectArea);
                            });

                            try {
                                const serialized = JSON.stringify(allSubmissions);
                                console.log('Serialized allSubmissions length:', serialized.length);
                                localStorage.setItem('allSubmissions', serialized);
                                console.log('Saved to allSubmissions:', allSubmissions.length, 'items');
                            } catch (storageError) {
                                console.error('localStorage setItem failed:', storageError);
                                throw storageError;
                            }
                            
                            // Success toast
                            try { showNotification(`Submitted ${submittedCount} project area${submittedCount > 1 ? 's' : ''} successfully!`); } catch (_) {}
                            
                            // Reset working state and UI
                            currentSubmission = {};
                            const table = document.getElementById('project-table');
                            const submitAllBtnEl = document.getElementById('external-submit-all-btn');
                            if (table) table.style.display = 'none';
                            if (submitAllBtnEl) submitAllBtnEl.style.display = 'none';
                            
                            // Show thank you page (only if elements exist)
                            const mainContainer = document.getElementById('main-container');
                            const thankYou = document.getElementById('external-thankyou');
                            if (mainContainer && thankYou) {
                                mainContainer.classList.add('hidden');
                                thankYou.classList.remove('hidden');
                            } else {
                                // Fallback: notify success
                                try { showNotification('Submission saved successfully.'); } catch (_) { alert('Submission saved successfully.'); }
                            }
                        } else {
                            console.log('No project areas to submit');
                            try { showNotification('Add at least one project area before submitting.'); } catch (_) {}
                        }
                    } catch (error) {
                        console.error('Error during Submit All:', error && (error.stack || error.message || error));
                        alert('There was an error submitting: ' + (error && (error.message || String(error))));
                    }
                });
            }

            // New submission button
            const newSubmissionBtn = document.getElementById('external-new-submission-btn');
            if (newSubmissionBtn) {
                newSubmissionBtn.onclick = function() {
                    document.getElementById('external-thankyou').classList.add('hidden');
                    document.getElementById('main-container').classList.remove('hidden');
                    document.getElementById('project-form').reset();
                    document.getElementById('project-table').style.display = 'none';
                    document.getElementById('external-submit-all-btn').style.display = 'none';
                    currentSubmission = {};
                };
            }

            // Add Expense button functionality
            const addExpenseBtn = document.getElementById('add-expense-btn');
            if (addExpenseBtn) {
                addExpenseBtn.onclick = function() {
                    addExpenseRow();
                };
            }

            // Add Governing Board button functionality
            const addGoverningBoardBtn = document.getElementById('add-governing-board-btn');
            if (addGoverningBoardBtn) {
                addGoverningBoardBtn.onclick = function() {
                    addGoverningBoardRow();
                };
            }

            // Add Agency Staff button functionality
            const addAgencyStaffBtn = document.getElementById('add-agency-staff-btn');
            if (addAgencyStaffBtn) {
                addAgencyStaffBtn.onclick = function() {
                    addAgencyStaffRow();
                };
            }

            // Add Increment Distribution button functionality
            const addIncrementDistributionBtn = document.getElementById('add-increment-distribution-btn');
            if (addIncrementDistributionBtn) {
                addIncrementDistributionBtn.onclick = function() {
                    addIncrementDistributionRow();
                };
            }

            // Add Sources of Funds button functionality
            const addSourcesOfFundsBtn = document.getElementById('add-sources-of-funds-btn');
            if (addSourcesOfFundsBtn) {
                addSourcesOfFundsBtn.onclick = function() {
                    addSourcesOfFundsRow();
                };
            }

            // Add Tax Increment Summary button functionality
            const addTaxIncrementSummaryBtn = document.getElementById('add-tax-increment-summary-btn');
            if (addTaxIncrementSummaryBtn) {
                addTaxIncrementSummaryBtn.onclick = function() {
                    addTaxIncrementSummaryRow();
                };
            }

            // PDF Upload functionality
            const pdfUploadInput = document.getElementById('project-area-map-upload');
            const pdfUploadZone = document.getElementById('pdf-upload-zone');
            
            if (pdfUploadInput) {
                pdfUploadInput.addEventListener('change', handlePDFUpload);
            }
            
            if (pdfUploadZone) {
                // Drag and drop functionality
                pdfUploadZone.addEventListener('dragover', handleDragOver);
                pdfUploadZone.addEventListener('dragleave', handleDragLeave);
                pdfUploadZone.addEventListener('drop', handleDrop);
                pdfUploadZone.addEventListener('click', () => pdfUploadInput.click());
            }
            
            // Debug: Check if submit buttons are found
            const externalSubmitBtn = projectForm?.querySelector('button[type="submit"]');
            const internalSubmitBtn = internalForm?.querySelector('button[type="submit"]');
            
            console.log('External submit button found:', !!externalSubmitBtn);
            console.log('Internal submit button found:', !!internalSubmitBtn);
            
            if (externalSubmitBtn) {
                console.log('External submit button text:', externalSubmitBtn.textContent);
            }
            if (internalSubmitBtn) {
                console.log('Internal submit button text:', internalSubmitBtn.textContent);
            }
        }

        function setupInternalDatabase() {
            // Search functionality
            const searchInput = document.getElementById('internal-db-search');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    renderInternalDBCityList();
                });
            }

            // Year filter
            const yearFilter = document.getElementById('internal-db-filter-year');
            if (yearFilter) {
                yearFilter.addEventListener('change', function() {
                    renderInternalDBCityList();
                });
            }

            // External year select - update expense labels and check for load button
            const externalYearSelect = document.getElementById('external-year-select');
            if (externalYearSelect) {
                externalYearSelect.addEventListener('change', function() {
                    updateExpenseLabels();
                    checkShowLoadLastYearButton();
                });
            }
            
            // External county dropdown - cascades into agency/project
            const externalCountyDropdown = document.getElementById('external-county-dropdown');
            if (externalCountyDropdown) {
                externalCountyDropdown.addEventListener('change', () => {
                    handleExternalCountyChange();
                });
            }
            
            // External agency dropdown - handle "Add New" selection
            const externalAgencyDropdown = document.getElementById('external-agency-dropdown');
            if (externalAgencyDropdown) {
                externalAgencyDropdown.addEventListener('change', function() {
                    const newAgencyContainer = document.getElementById('external-new-agency-container');
                    const newAgencyInput = document.getElementById('external-new-agency-input');
                    if (this.value === '__ADD_NEW_AGENCY__') {
                        if (newAgencyContainer) newAgencyContainer.style.display = 'flex';
                        if (newAgencyInput) {
                            newAgencyInput.required = true;
                            newAgencyInput.value = '';
                            newAgencyInput.focus();
                        }
                        this.required = false;
                    } else {
                        if (newAgencyContainer) newAgencyContainer.style.display = 'none';
                        if (newAgencyInput) {
                            newAgencyInput.required = false;
                            newAgencyInput.value = '';
                        }
                        this.required = true;
                    }
                    populateExternalProjectDropdown();
                    checkShowLoadLastYearButton();
                });
            }
            
            // Load last year's data button
            const loadLastYearBtn = document.getElementById('load-last-year-btn');
            if (loadLastYearBtn) {
                loadLastYearBtn.addEventListener('click', loadLastYearData);
            }
            
            // Save buttons for new county, agency, and project area
            const saveCountyBtn = document.getElementById('external-save-county-btn');
            if (saveCountyBtn) {
                saveCountyBtn.addEventListener('click', () => {
                    saveNewCounty();
                });
            }
            
            const saveAgencyBtn = document.getElementById('external-save-agency-btn');
            if (saveAgencyBtn) {
                saveAgencyBtn.addEventListener('click', () => {
                    saveNewAgency();
                });
            }
            
            const saveProjectBtn = document.getElementById('external-save-project-btn');
            if (saveProjectBtn) {
                saveProjectBtn.addEventListener('click', () => {
                    saveNewProjectArea();
                });
            }
            
            // Allow Enter key to trigger save
            const newCountyInput = document.getElementById('external-new-county-input');
            if (newCountyInput) {
                newCountyInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveNewCounty();
                    }
                });
            }
            
            const newAgencyInput = document.getElementById('external-new-agency-input');
            if (newAgencyInput) {
                newAgencyInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveNewAgency();
                    }
                });
            }
            
            const newProjectInput = document.getElementById('external-new-project-input');
            if (newProjectInput) {
                newProjectInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveNewProjectArea();
                    }
                });
            }
            
            // Internal form - Load Last Year's Data event listeners
            const internalClientDropdown = document.getElementById('internal-city-dropdown');
            if (internalClientDropdown) {
                // Remove the inline onchange and add event listener
                internalClientDropdown.removeAttribute('onchange');
                internalClientDropdown.addEventListener('change', function() {
                    populateProjectDropdown();
                    checkShowLoadLastYearButtonInternal();
                });
            }
            
            const internalProjectDropdown = document.getElementById('internal-project-dropdown');
            if (internalProjectDropdown) {
                internalProjectDropdown.addEventListener('change', function() {
                    checkShowLoadLastYearButtonInternal();
                });
            }
            
            const internalFyInput = document.querySelector('#internal-data-request-container select[name="fy"]');
            if (internalFyInput) {
                internalFyInput.addEventListener('change', function() {
                    checkShowLoadLastYearButtonInternal();
                });
            }
            
            const loadLastYearInternalBtn = document.getElementById('load-last-year-internal-btn');
            if (loadLastYearInternalBtn) {
                loadLastYearInternalBtn.addEventListener('click', loadLastYearDataInternal);
            }

            // Internal year select - update FY/TY labels
            const internalYearSelect = document.getElementById('internal-year-select');
            if (internalYearSelect) {
                internalYearSelect.addEventListener('change', function() {
                    updateInternalYearLabels();
                    updateExpenseLabels();
                });
            }

            // Discount rate input - update NPV headers in real-time
            const discountRateInput = document.querySelector('input[name="discountRate"]');
            if (discountRateInput) {
                discountRateInput.addEventListener('input', function() {
                    updateDiscountRateDisplay();
                });
                discountRateInput.addEventListener('change', function() {
                    updateDiscountRateDisplay();
                });
                // Initialize on load
                updateDiscountRateDisplay();
            }

            // Populate internal form dropdowns when internal data tab is shown
            // Set up event listeners for tab buttons
            const externalTabBtn = document.getElementById('external-tab-btn');
            if (externalTabBtn) {
                externalTabBtn.addEventListener('click', function() {
                    showTab('external');
                    // Repopulate dropdowns in case new submissions were added
                    initializeExternalLocationDropdowns();
                });
            }

            const internalTabBtn = document.getElementById('internal-tab-btn');
            if (internalTabBtn) {
                internalTabBtn.addEventListener('click', function() {
                    showTab('internal');
                });
            }

            const internalDataTabBtn = document.getElementById('internal-data-tab-btn');
            if (internalDataTabBtn) {
                internalDataTabBtn.addEventListener('click', function() {
                    showTab('internal-data');
                    populateClientDropdown();
                    // Buttons are already set up in initialization, no need for separate function
                });
            }

            // Unified logout function
            function handleLogout() {
                try {
                    // Clear client session if function exists
                    if (typeof setCurrentClient === 'function') {
                        setCurrentClient(null);
                    } else {
                        // Fallback: clear from localStorage directly
                        localStorage.removeItem('currentClient');
                    }
                    
                    // Reset to landing page
                    document.getElementById('landing-container').classList.remove('hidden');
                    document.getElementById('tab-bar').classList.add('hidden');
                    document.getElementById('main-container').classList.add('hidden');
                    document.getElementById('internal-container').classList.add('hidden');
                    document.getElementById('internal-data-request-container').classList.add('hidden');
                    document.getElementById('external-thankyou').classList.add('hidden');
                    document.getElementById('client-login-container').classList.add('hidden');
                    document.getElementById('client-dashboard-container').classList.add('hidden');
                hideProfileControl();
                toggleHeaderVisibility(false);
                    
                    // Change logo back to white version for landing page
                    if (typeof changeLogo === 'function') {
                        changeLogo('Pictures/LRB White Out.png');
                    } else if (typeof window.changeLogo === 'function') {
                        window.changeLogo('Pictures/LRB White Out.png');
                    } else {
                        const logoImg = document.querySelector('.logo img');
                        if (logoImg) logoImg.src = 'Pictures/LRB White Out.png';
                    }
                    
                    // Restore landing background and start video
                    const mainContent = document.querySelector('.main-content');
                    const landingVideo = document.getElementById('landing-video');
                    if (mainContent) {
                        mainContent.classList.add('landing-background');
                    }
                    if (landingVideo) {
                        landingVideo.currentTime = 0;
                        landingVideo.play().then(() => {
                            landingVideo.classList.add('visible');
                        }).catch(err => {
                            console.warn('Video autoplay failed:', err);
                        });
                    }
                    
                    // Reset tab states
                    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                } catch (error) {
                    console.error('Logout error:', error);
                    // Fallback: just show landing page
                    document.getElementById('landing-container').classList.remove('hidden');
                    document.getElementById('tab-bar').classList.add('hidden');
                    document.getElementById('main-container').classList.add('hidden');
                    document.getElementById('internal-container').classList.add('hidden');
                    document.getElementById('internal-data-request-container').classList.add('hidden');
                    document.getElementById('account-management-container').classList.add('hidden');
                    document.getElementById('client-login-container').classList.add('hidden');
                    document.getElementById('client-dashboard-container').classList.add('hidden');
                }
            }

            // Setup logout button with event delegation to handle dynamically created buttons

            // Status filter
            const statusFilter = document.getElementById('internal-db-filter-status');
            if (statusFilter) {
                statusFilter.addEventListener('change', function() {
                    renderInternalDBCityList();
                });
            }

            // Total Expenses functionality
            const addTotalExpenseBtn = document.getElementById('add-total-expense-btn');
            if (addTotalExpenseBtn) {
                addTotalExpenseBtn.addEventListener('click', addTotalExpenseRow);
            }

            // Total Expenses NPV functionality
            const addTotalExpenseNpvBtn = document.getElementById('add-total-expense-npv-btn');
            if (addTotalExpenseNpvBtn) {
                addTotalExpenseNpvBtn.addEventListener('click', addTotalExpenseNpvRow);
            }

            // Tax Entities functionality
            const addTaxEntityBtn = document.getElementById('add-tax-entity-btn');
            if (addTaxEntityBtn) {
                addTaxEntityBtn.addEventListener('click', addTaxEntityRow);
            }

            // Auto-calculations
            const residentialAcreageInput = document.querySelector('input[name="residentialAcreage"]');
            const totalAcreageInput = document.querySelector('input[name="acreage"]');
            if (residentialAcreageInput) {
                residentialAcreageInput.addEventListener('input', calculatePercentResidential);
            }
            if (totalAcreageInput) {
                totalAcreageInput.addEventListener('input', calculatePercentResidential);
            }

            // Update year headers when year changes
            if (internalYearSelect) {
                internalYearSelect.addEventListener('change', updateYearHeaders);
            }
        }

        function populateYearDropdown(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;

            // Clear existing options except the first one
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }

            // Add years 2020-2060
            for (let year = 2020; year <= 2060; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                select.appendChild(option);
            }
        }

        function renderTable() {
            console.log('renderTable() called');
            const table = document.getElementById('project-table');
            const tbody = table.querySelector('tbody');
            const submitAllBtn = document.getElementById('external-submit-all-btn');
            
            console.log('Current submission project areas:', currentSubmission.projectAreas);
            console.log('Project areas length:', currentSubmission.projectAreas ? currentSubmission.projectAreas.length : 0);
            
            if (!currentSubmission.projectAreas || currentSubmission.projectAreas.length === 0) {
                console.log('No project areas, hiding table and submit button');
                table.style.display = 'none';
                submitAllBtn.style.display = 'none';
                return;
            }

            console.log('Showing table and submit button');
            table.style.display = 'table';
            submitAllBtn.style.display = 'block';
            
            tbody.innerHTML = '';
            
            currentSubmission.projectAreas.forEach((area, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${area.submitterName || ''}</td>
                    <td>${area.projectAreaName || ''}</td>
                    <td>${area.acreage || ''}</td>
                    <td>${area.creationYear || ''}</td>
                    <td>${area.baseYear || ''}</td>
                    <td>${area.termLength || ''}</td>
                    <td>${area.startYear || ''}</td>
                    <td>${area.expirationYear || ''}</td>
                    <td>${area.baseValue || ''}</td>
                    <td>${area.fyIncrement || ''}</td>
                    <td>${area.remainingLife || ''}</td>
                    <td>${area.fundBalance || ''}</td>
                    <td>${area.tyActualSpentTotal || ''}</td>
                    <td>${area.developedAcreage || ''}</td>
                    <td>${area.undevelopedAcreage || ''}</td>
                    <td>${area.residentialAcreage || ''}</td>
                    <td>${area.percentResidential || ''}</td>
                    <td>${area.totalAuthorizedHousingUnits || ''}</td>
                    <td>
                        <button onclick="editRow(${index})" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; margin-right: 5px;">Edit</button>
                        <button onclick="deleteRowFromTable(${index})" class="btn btn-delete" style="padding: 6px 12px; font-size: 12px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function editRow(index) {
            // Implementation for editing rows
            console.log('Edit row:', index);
        }

        function deleteRowFromTable(index) {
            if (confirm('Are you sure you want to delete this project area from the internal database?')) {
                // Remove from current session's project areas
                if (currentSubmission.projectAreas && currentSubmission.projectAreas[index]) {
                    const deletedArea = currentSubmission.projectAreas[index];
                    currentSubmission.projectAreas.splice(index, 1);
                    
                    // Remove from allSubmissions (the database)
                    const submitterName = deletedArea.submitterName;
                    const projectAreaName = deletedArea.projectAreaName;
                    const fy = deletedArea.fy;
                    
                    allSubmissions = allSubmissions.filter(sub => {
                        const matchesClient = (sub.submitterName || sub.cityCounty) === submitterName;
                        const matchesProject = (sub.projectAreaName || sub.projectArea) === projectAreaName;
                        const matchesYear = (sub.fy || sub.year) === fy;
                        return !(matchesClient && matchesProject && matchesYear);
                    });
                    
                    localStorage.setItem('allSubmissions', JSON.stringify(allSubmissions));
                    renderTable();
                    showNotification('Project area deleted from internal database.');
                }
            }
        }

        function getProjectAreaStatus(projectArea) {
            const externalData = allSubmissions.filter(sub => 
                sub.projectAreas && sub.projectAreas.some(pa => pa.projectAreaName === projectArea)
            );
            
            const internalData = allSubmissions.filter(sub => 
                sub.projectArea === projectArea
            );

            if (externalData.length > 1 || internalData.length > 1) {
                return 'Multiple Submissions';
            } else if (externalData.length === 1 && internalData.length === 1) {
                return 'Ready';
            } else if (externalData.length === 1 && internalData.length === 0) {
                return 'Internal Data Needed';
            } else {
                return 'None';
            }
        }

        async function renderInternalDBCityList() {
            const container = document.getElementById('internal-db-table-container');
            if (!container) return;
            
            // Enterprise Build: Load from API first
            await loadSubmissionsFromAPI();
            
            const searchTerm = (document.getElementById('internal-db-search')?.value || '').toLowerCase();
            const selectedYear = document.getElementById('internal-db-filter-year')?.value || '';
            const selectedStatus = document.getElementById('internal-db-filter-status')?.value || '';

            // Group submissions by year first, then by city/county
            const yearGroups = {};
            allSubmissions.forEach(submission => {
                const year = String(submission.year || submission.fy || submission.ty || 'Unknown');
                const cityName = submission.cityCounty || 
                                submission.submitterName || 
                                submission.client ||
                                submission.agency ||
                                submission.projectArea || 
                                submission.projectAreaName ||
                                'Unknown';
                
                if (!yearGroups[year]) {
                    yearGroups[year] = {};
                }
                if (!yearGroups[year][cityName]) {
                    yearGroups[year][cityName] = [];
                }
                yearGroups[year][cityName].push(submission);
            });

            let html = '<div class="table-container">';
            html += '<div style="max-height: 600px; overflow-y: auto;">';
            html += '<table class="table">';
            html += '<thead><tr><th>Year</th><th>Clients</th><th>Project Areas</th><th>Actions</th></tr></thead><tbody>';

            // Sort years in descending order (newest first)
            const sortedYears = Object.keys(yearGroups).sort((a, b) => parseInt(b) - parseInt(a));

            let clientRowIndex = 0;
            
            sortedYears.forEach(year => {
                // Apply year filter
                if (selectedYear && year !== selectedYear) return;
                
                const yearCities = yearGroups[year];
                
                Object.keys(yearCities).forEach(city => {
                    const citySubmissions = yearCities[city];
                    const projectCount = citySubmissions.length;
                    
                    // Apply search filter
                    if (searchTerm && !city.toLowerCase().includes(searchTerm)) return;

                    html += `<tr style="transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor=''">
                        <td><strong>${year}</strong></td>
                        <td><strong>${city}</strong></td>
                        <td>${projectCount} project area${projectCount !== 1 ? 's' : ''}</td>
                        <td>
                            <button onclick="viewProjectsList('${city}', '${year}')" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;">Projects</button>
                            <div style="position: relative; display: inline-block; margin-left: 8px;">
                                <button onclick="toggleDropdown('client-dropdown-${clientRowIndex}')" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 2px 6px;">â‹¯</button>
                                <div id="client-dropdown-${clientRowIndex}" class="dropdown-content" style="display: none; position: absolute; right: 0; top: 100%; background-color: white; min-width: 150px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 10000; border-radius: 4px; border: 1px solid #ddd;">
                                    <a href="#" onclick="event.preventDefault(); editClientName('${city}', '${year}'); toggleDropdown('client-dropdown-${clientRowIndex}');" style="display: block; padding: 10px 16px; text-decoration: none; color: #28a745; font-size: 12px;">Edit Client Name</a>
                                    <a href="#" onclick="event.preventDefault(); deleteClientByYear('${city}', '${year}'); toggleDropdown('client-dropdown-${clientRowIndex}');" style="display: block; padding: 10px 16px; text-decoration: none; color: #dc3545; font-size: 12px;">Delete All Projects</a>
                                </div>
                            </div>
                        </td>
                    </tr>`;
                    clientRowIndex++;
                });
            });

            html += '</tbody></table></div></div>';
            container.innerHTML = html;
        }

        // New function: Show list of individual projects for a client/year
        function viewProjectsList(city, year) {
            const container = document.getElementById('internal-db-table-container');
            
            console.log(`[viewProjectsList] Looking for city: "${city}", year: "${year}"`);
            
            // Find all submissions for this client/year
            const cityYearSubmissions = allSubmissions.filter(submission => {
                const submissionCity = submission.cityCounty || 
                                     submission.submitterName || 
                                     submission.client ||
                                     submission.agency ||
                                     submission.projectArea || 
                                     submission.projectAreaName ||
                                     'Unknown';
                const submissionYear = String(submission.year || submission.fy || submission.ty || 'Unknown');
                const targetYear = String(year);
                const cityMatch = submissionCity.toString().trim().toLowerCase() === city.toString().trim().toLowerCase();
                const yearMatch = submissionYear === targetYear;
                return cityMatch && yearMatch;
            });
            
            console.log(`[viewProjectsList] Found ${cityYearSubmissions.length} submissions`);
            
            let html = '<div class="table-container">';
            html += `<div style="margin-bottom: 20px; display: flex; align-items: center; gap: 16px;">`;
            html += `<button onclick="renderInternalDBCityList()" class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px;">â† Back to Clients</button>`;
            html += `<h3 style="margin: 0; color: var(--primary-blue);">${city} - ${year} Projects</h3>`;
            html += `<button onclick="showProjectSelectionModal('${city}', '${year}')" class="btn btn-success" style="margin-left: auto; margin-right: 8px;">Generate Report</button>`;
            html += `<button onclick="downloadExcelForClient('${city}')" class="btn btn-primary">Download Excel</button>`;
            html += `</div>`;
            html += '<div style="max-height: 600px; overflow-y: auto;">';
            html += '<table class="table">';
            html += '<thead><tr><th>Project Area</th><th>Year</th><th>Type</th><th>Purpose</th><th>Status</th><th>Governing Board</th><th>Agency Staff</th><th>Actions</th></tr></thead><tbody>';
            
            if (cityYearSubmissions.length === 0) {
                html += '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #666;">';
                html += '<div style="margin-bottom: 12px;">No projects found for this client and year.</div>';
                html += '<div style="font-size: 14px;">Submit data using the External or Internal Data Request forms.</div>';
                html += '</td></tr>';
            } else {
                // Show each submission as a separate project (don't group)
                cityYearSubmissions.forEach((submission, idx) => {
                    const projectArea = submission.projectArea || submission.projectAreaName || 'N/A';
                    const type = submission.type || 'N/A';
                    const purpose = submission.purpose || 'N/A';
                    const submissionYear = submission.year || submission.fy || submission.ty || year;
                    
                    // Determine status
                    const hasExternalData = submission.submitterName || submission.projectAreaName;
                    const hasInternalData = submission.cityCounty || submission.fy || submission.ty;
                    let status, statusClass;
                    
                    if (hasExternalData && hasInternalData) {
                        status = 'Ready';
                        statusClass = 'status-ready';
                    } else if (hasExternalData) {
                        status = 'Internal Data Needed';
                        statusClass = 'status-internal-needed';
                    } else {
                        status = 'External Data Needed';
                        statusClass = 'status-external-needed';
                    }
                    
                    // Get Governing Board and Agency Staff
                    const governingBoardMembers = [];
                    const agencyStaffMembers = [];
                    
                    for (let i = 0; i < 10; i++) {
                        const boardName = submission[`governingBoardName_${i}`];
                        const boardTitle = submission[`governingBoardTitle_${i}`];
                        if (boardName || boardTitle) {
                            governingBoardMembers.push(`${boardName || ''}${boardTitle ? ` (${boardTitle})` : ''}`);
                        }
                        
                        const staffName = submission[`agencyStaffName_${i}`];
                        const staffTitle = submission[`agencyStaffTitle_${i}`];
                        if (staffName || staffTitle) {
                            agencyStaffMembers.push(`${staffName || ''}${staffTitle ? ` (${staffTitle})` : ''}`);
                        }
                    }
                    
                    const governingBoardText = governingBoardMembers.length > 0 ? governingBoardMembers.join(', ') : 'N/A';
                    const agencyStaffText = agencyStaffMembers.length > 0 ? agencyStaffMembers.join(', ') : 'N/A';
                    
                    // Store submission ID for reference
                    const submissionId = submission.id || `submission-${idx}`;
                    
                    html += `<tr style="transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor=''">
                        <td><strong>${projectArea}</strong></td>
                        <td>${submissionYear}</td>
                        <td>${type}</td>
                        <td>${purpose}</td>
                        <td><span class="status-badge ${statusClass}">${status}</span></td>
                        <td style="font-size: 12px; max-width: 200px;">${governingBoardText}</td>
                        <td style="font-size: 12px; max-width: 200px;">${agencyStaffText}</td>
                        <td>
                            <button onclick="editProjectSubmission('${submissionId}', '${city}', '${projectArea}', '${year}')" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px; margin-right: 4px;">Edit</button>
                            <button onclick="deleteProjectSubmission('${submissionId}', '${city}', '${projectArea}', '${year}')" class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;">Delete</button>
                        </td>
                    </tr>`;
                });
            }
            
            html += '</tbody></table></div></div>';
            container.innerHTML = html;
        }

        function viewClientDetailsByYear(city, year) {
            const container = document.getElementById('internal-db-table-container');
            
            console.log(`[viewClientDetailsByYear] Looking for city: "${city}", year: "${year}"`);
            console.log(`[viewClientDetailsByYear] Total submissions: ${allSubmissions.length}`);
            
            // Debug: Show first few submissions to understand data structure
            if (allSubmissions.length > 0) {
                console.log('[viewClientDetailsByYear] Sample submission structure:', {
                    firstSubmission: allSubmissions[0],
                    allCityNames: allSubmissions.map(s => ({
                        cityCounty: s.cityCounty,
                        submitterName: s.submitterName,
                        projectArea: s.projectArea,
                        projectAreaName: s.projectAreaName,
                        year: s.year,
                        fy: s.fy
                    }))
                });
            }
            
            const cityYearSubmissions = allSubmissions.filter(submission => {
                // Try multiple field name variations for city/client
                const submissionCity = submission.cityCounty || 
                                     submission.submitterName || 
                                     submission.client ||
                                     submission.agency ||
                                     submission.projectArea || 
                                     submission.projectAreaName ||
                                     'Unknown';
                
                // Try multiple field name variations for year (handle string vs number)
                const submissionYear = String(submission.year || submission.fy || submission.ty || 'Unknown');
                const targetYear = String(year);
                
                // Normalize city names (trim, lowercase for comparison)
                const cityMatch = submissionCity.toString().trim().toLowerCase() === city.toString().trim().toLowerCase();
                const yearMatch = submissionYear === targetYear;
                
                const matches = cityMatch && yearMatch;
                if (matches) {
                    console.log(`[viewClientDetailsByYear] Found matching submission:`, {
                        city: submissionCity,
                        year: submissionYear,
                        projectArea: submission.projectArea || submission.projectAreaName,
                        hasExternal: !!(submission.submitterName || submission.projectAreaName),
                        hasInternal: !!(submission.cityCounty || submission.fy),
                        fullSubmission: submission
                    });
                }
                return matches;
            });
            
            console.log(`[viewClientDetailsByYear] Found ${cityYearSubmissions.length} matching submissions`);

            let html = '<div class="table-container">';
            html += `<div style="margin-bottom: 20px; display: flex; align-items: center; gap: 16px;">`;
            html += `<button onclick="renderInternalDBCityList()" class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px;">â† Back to Clients</button>`;
            html += `<h3 style="margin: 0; color: var(--primary-blue);">${city} - ${year} Project Areas</h3>`;
            html += `<button onclick="showProjectSelectionModal('${city}', '${year}')" class="btn btn-success" style="margin-left: auto; margin-right: 8px;">Generate Report</button>`;
            html += `<button onclick="downloadExcelForClient('${city}')" class="btn btn-primary">Download Excel</button>`;
            html += `</div>`;
            html += '<div style="max-height: 600px; overflow-y: auto;">';
            html += '<table class="table">';
            html += '<thead><tr><th>Project Area</th><th>Type</th><th>Purpose</th><th>Status</th><th>Total Project Areas</th><th>Governing Board</th><th>Agency Staff</th><th>Actions</th></tr></thead><tbody>';

            // Calculate total project areas for this city/year
            const totalProjectAreas = cityYearSubmissions.length;
            
            // Show message if no submissions found
            if (cityYearSubmissions.length === 0) {
                html += '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #666;">';
                html += '<div style="margin-bottom: 12px;">No project areas found for this client and year.</div>';
                html += '<div style="font-size: 14px;">Submit data using the External or Internal Data Request forms.</div>';
                html += '</td></tr>';
                html += '</tbody></table></div></div>';
                container.innerHTML = html;
                return;
            }
            
            // Group submissions by project area to show separate entries
            const projectGroups = {};
            cityYearSubmissions.forEach(submission => {
                const projectArea = submission.projectArea || submission.projectAreaName || 'N/A';
                
                if (!projectGroups[projectArea]) {
                    projectGroups[projectArea] = submission;
                } else {
                    // Merge data if we have both external and internal data for same project
                    Object.assign(projectGroups[projectArea], submission);
                }
            });

            const projectGroupsArray = Object.values(projectGroups);
            console.log(`[viewClientDetailsByYear] Grouped into ${projectGroupsArray.length} project areas`);
            
            projectGroupsArray.forEach((submission, idx) => {
                const projectArea = submission.projectArea || submission.projectAreaName || 'N/A';
                const type = submission.type || 'N/A';
                const purpose = submission.purpose || 'N/A';
                
                // Determine status based on data completeness
                const hasExternalData = submission.submitterName || submission.projectAreaName;
                const hasInternalData = submission.cityCounty || submission.fy || submission.ty;
                let status, statusClass;
                
                if (hasExternalData && hasInternalData) {
                    status = 'Ready';
                    statusClass = 'status-ready';
                } else if (hasExternalData) {
                    status = 'Internal Data Needed';
                    statusClass = 'status-internal-needed';
                } else {
                    status = 'External Data Needed';
                    statusClass = 'status-external-needed';
                }

                // Get Governing Board and Agency Staff data
                const governingBoardMembers = [];
                const agencyStaffMembers = [];
                
                for (let i = 0; i < 10; i++) {
                    const boardName = submission[`governingBoardName_${i}`];
                    const boardTitle = submission[`governingBoardTitle_${i}`];
                    if (boardName || boardTitle) {
                        governingBoardMembers.push(`${boardName || ''}${boardTitle ? ` (${boardTitle})` : ''}`);
                    }
                    
                    const staffName = submission[`agencyStaffName_${i}`];
                    const staffTitle = submission[`agencyStaffTitle_${i}`];
                    if (staffName || staffTitle) {
                        agencyStaffMembers.push(`${staffName || ''}${staffTitle ? ` (${staffTitle})` : ''}`);
                    }
                }
                
                const governingBoardText = governingBoardMembers.length > 0 ? governingBoardMembers.join(', ') : 'N/A';
                const agencyStaffText = agencyStaffMembers.length > 0 ? agencyStaffMembers.join(', ') : 'N/A';
                
                html += `<tr onclick="viewProjectDetails('${city}', '${projectArea}', '${year}')" style="cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor=''">
                    <td><strong>${projectArea}</strong></td>
                    <td>${type}</td>
                    <td>${purpose}</td>
                    <td><span class="status-badge ${statusClass}">${status}</span></td>
                    <td><strong>${totalProjectAreas}</strong></td>
                    <td style="font-size: 12px; max-width: 200px;">${governingBoardText}</td>
                    <td style="font-size: 12px; max-width: 200px;">${agencyStaffText}</td>
                    <td>
                        <div style="position: relative; display: inline-block;" onclick="event.stopPropagation();">
                            <button onclick="toggleDropdown('dropdown-${idx}')" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 2px 6px;">â‹¯</button>
                            <div id="dropdown-${idx}" class="dropdown-content" style="display: none; position: absolute; right: 0; top: 100%; background-color: white; min-width: 150px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 10000; border-radius: 4px; border: 1px solid #ddd;">
                                <a href="#" onclick="event.preventDefault(); viewProjectDetails('${city}', '${projectArea}', '${year}'); toggleDropdown('dropdown-${idx}');" style="display: block; padding: 10px 16px; text-decoration: none; color: #00B0F0; font-size: 12px;">View Details</a>
                                <a href="#" onclick="event.preventDefault(); editProjectAreaName('${city}', '${projectArea}', '${year}', ${idx}); toggleDropdown('dropdown-${idx}');" style="display: block; padding: 10px 16px; text-decoration: none; color: #28a745; font-size: 12px;">Edit</a>
                                <a href="#" onclick="event.preventDefault(); deleteFromInternalDB('${city}', '${projectArea}', '${year}'); toggleDropdown('dropdown-${idx}');" style="display: block; padding: 10px 16px; text-decoration: none; color: #dc3545; font-size: 12px;">Delete</a>
                            </div>
                        </div>
                    </td>
                </tr>`;
            });

            html += '</tbody></table></div></div>';
            container.innerHTML = html;
        }

        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (dropdown) {
                // Close all other dropdowns
                document.querySelectorAll('.dropdown-content').forEach(menu => {
                    if (menu.id !== dropdownId) {
                        menu.style.display = 'none';
                    }
                });
                
                // Toggle current dropdown
                if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                    dropdown.style.display = 'block';
                    
                    // Get button position to calculate dropdown position
                    const button = dropdown.previousElementSibling;
                    if (button) {
                        const rect = button.getBoundingClientRect();
                        const dropdownHeight = dropdown.offsetHeight || 80; // approximate height
                        const spaceBelow = window.innerHeight - rect.bottom;
                        const spaceAbove = rect.top;
                        
                        // Use fixed positioning to escape the scroll container
                        dropdown.style.position = 'fixed';
                        dropdown.style.zIndex = '10000';
                        
                        // Calculate position
                        let topPos, bottomPos;
                        if (spaceBelow < dropdownHeight && spaceAbove > spaceBelow) {
                            // Show above
                            bottomPos = window.innerHeight - rect.top;
                            dropdown.style.bottom = bottomPos + 'px';
                            dropdown.style.top = 'auto';
                        } else {
                            // Show below
                            topPos = rect.bottom;
                            dropdown.style.top = topPos + 'px';
                            dropdown.style.bottom = 'auto';
                        }
                        
                        // Position right edge
                        dropdown.style.right = (window.innerWidth - rect.right) + 'px';
                    }
                } else {
                    dropdown.style.display = 'none';
                }
            }
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('[onclick*="toggleDropdown"]')) {
                document.querySelectorAll('.dropdown-content').forEach(menu => {
                    menu.style.display = 'none';
                });
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            setupProfileMenu();
            const profileEmailModalClose = document.getElementById('profile-email-modal-close');
            const profileEmailCancel = document.getElementById('profile-email-cancel');
            const profileEmailForm = document.getElementById('profile-email-form');
            const profileEmailInput = document.getElementById('profile-email-input');
            const profileEmailError = document.getElementById('profile-email-error');

            if (profileEmailModalClose) {
                profileEmailModalClose.addEventListener('click', closeProfileEmailModal);
            }
            if (profileEmailCancel) {
                profileEmailCancel.addEventListener('click', closeProfileEmailModal);
            }
            if (profileEmailForm) {
                profileEmailForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    if (!window.currentUser || !profileEmailInput) return;
                    const newEmail = profileEmailInput.value.trim();
                    const oldEmail = window.currentUser.email || '';
                    if (!newEmail) return;
                    if (newEmail.toLowerCase() === oldEmail.toLowerCase()) {
                        showNotification('Email is unchanged.', 'info');
                        closeProfileEmailModal();
                        return;
                    }
                    const result = updateStoredAccountEmail(oldEmail, newEmail, window.currentUser.role || 'client');
                    if (!result.success) {
                        if (profileEmailError) {
                            profileEmailError.textContent = result.message || 'Unable to update email.';
                            profileEmailError.classList.remove('hidden');
                        }
                        return;
                    }
                    window.currentUser.email = newEmail;
                    updateProfileControl(window.currentUser);
                    closeProfileEmailModal();
                    showNotification('Email updated successfully!');
                });
            }
        });

        // Edit project submission - loads form with data
        let currentEditingSubmissionId = null;
        let autoSaveInterval = null;
        
        async function editProjectSubmission(submissionId, city, projectArea, year) {
            // Find the submission
            const submission = allSubmissions.find(sub => (sub.id || `submission-${allSubmissions.indexOf(sub)}`) === submissionId);
            
            if (!submission) {
                alert('Submission not found.');
                return;
            }
            
            // Determine which form to use (external or internal)
            const hasExternalData = submission.submitterName || submission.projectAreaName;
            const hasInternalData = submission.cityCounty || submission.fy || submission.ty;
            
            // For now, prefer internal form if it has internal data, otherwise external
            const useInternalForm = hasInternalData;
            
            // Store the submission ID for saving
            currentEditingSubmissionId = submissionId;
            
            // Switch to appropriate tab
            if (useInternalForm) {
                showTab('internal-data');
            } else {
                showTab('external');
            }
            
            // Wait for form to be visible, then populate
            setTimeout(async () => {
                await populateFormWithSubmission(submission, useInternalForm);
                setupAutoSave(submissionId);
                
                // Update button text to show we're in edit mode
                const submitBtn = useInternalForm 
                    ? document.querySelector('#internal-data-request-form button[type="submit"]')
                    : document.querySelector('#project-form button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = useInternalForm ? 'Update Data Request' : 'Update Project Area';
                    submitBtn.dataset.editMode = 'true';
                }
                
                showNotification('Form loaded in edit mode. Auto-save is enabled. Changes will be saved automatically every 30 seconds.');
            }, 100);
        }
        
        async function populateFormWithSubmission(submission, isInternal) {
            if (isInternal) {
                const form = document.getElementById('internal-data-request-form');
                if (!form) return;
                
                // First, populate Client and Project Area dropdowns (these come from original submission)
                const clientDropdown = document.getElementById('internal-city-dropdown');
                const projectDropdown = document.getElementById('internal-project-dropdown');
                
                const clientName = submission.cityCounty || submission.submitterName || submission.client || '';
                const projectAreaName = submission.projectArea || submission.projectAreaName || '';
                
                // Set client dropdown - ensure the option exists or add it
                if (clientDropdown && clientName) {
                    // Check if option exists
                    let optionExists = Array.from(clientDropdown.options).some(opt => opt.value === clientName || opt.text === clientName);
                    if (!optionExists && clientName) {
                        const option = document.createElement('option');
                        option.value = clientName;
                        option.text = clientName;
                        clientDropdown.appendChild(option);
                    }
                    clientDropdown.value = clientName;
                    // Make it read-only in edit mode
                    clientDropdown.disabled = true;
                    clientDropdown.style.backgroundColor = '#f5f5f5';
                    clientDropdown.style.cursor = 'not-allowed';
                }
                
                // Set project dropdown - ensure the option exists or add it
                if (projectDropdown && projectAreaName) {
                    // Check if option exists
                    let optionExists = Array.from(projectDropdown.options).some(opt => opt.value === projectAreaName || opt.text === projectAreaName);
                    if (!optionExists && projectAreaName) {
                        const option = document.createElement('option');
                        option.value = projectAreaName;
                        option.text = projectAreaName;
                        projectDropdown.appendChild(option);
                    }
                    projectDropdown.value = projectAreaName;
                    // Make it read-only in edit mode
                    projectDropdown.disabled = true;
                    projectDropdown.style.backgroundColor = '#f5f5f5';
                    projectDropdown.style.cursor = 'not-allowed';
                }
                
                // Populate all other fields from submission (skip client/project fields as they're already set)
                Object.keys(submission).forEach(key => {
                    if (key === 'id' || key === 'createdAt' || key === 'updatedAt' || key === 'status' || 
                        key === 'cityCounty' || key === 'submitterName' || key === 'client' ||
                        key === 'projectArea' || key === 'projectAreaName') return;
                    
                    const field = form.querySelector(`[name="${key}"]`);
                    if (field) {
                        if (field.type === 'checkbox') {
                            field.checked = submission[key];
                        } else if (field.tagName === 'SELECT') {
                            field.value = submission[key] || '';
                        } else {
                            field.value = submission[key] || '';
                        }
                    }
                });
                
                // Handle dynamic rows (tax entities, expenses, etc.)
                populateDynamicRows(form, submission, 'taxEntity', ['Name', 'ParticipationRate', 'Remittance', 'CapAmount', 'IncrementPaid', 'RemainingAuthorized']);
                populateDynamicRows(form, submission, 'totalExpense', ['Description', 'Amount', 'Npv']);
                populateDynamicRows(form, submission, 'governingBoard', ['Name', 'Title']);
                populateDynamicRows(form, submission, 'agencyStaff', ['Name', 'Title']);
                populateDynamicRows(form, submission, 'increment', ['Entity', 'Actual', 'Remaining']);
                populateDynamicRows(form, submission, 'revenueSource', ['Description', '2025Actual', '2026Forecast', '2027Forecast']);
                populateDynamicRows(form, submission, 'taxIncrement', ['Entity', 'YearActual', 'RemainingAuthorized']);
                
                // Trigger calculations
                if (typeof updateTaxEntitiesTotal === 'function') updateTaxEntitiesTotal();
                if (typeof updateTotalUsesOfFunds === 'function') updateTotalUsesOfFunds();
                
            } else {
                const form = document.getElementById('project-form');
                if (!form) return;
                
                // First, populate Agency and Project Area dropdowns (these come from original submission)
                const countyDropdown = document.getElementById('external-county-dropdown');
                const agencyDropdown = document.getElementById('external-agency-dropdown');
                const projectDropdown = document.getElementById('external-project-dropdown');
                
                const countyName = submission.county || submission.countyName || '';
                const agencyName = submission.submitterName || submission.cityCounty || submission.agency || '';
                const projectAreaName = submission.projectAreaName || submission.projectArea || '';

                if (countyDropdown) {
                    await populateExternalCountyDropdown();
                    if (countyName) {
                        ensureOptionExists(countyDropdown, countyName);
                        countyDropdown.value = countyName;
                        countyDropdown.disabled = true;
                        countyDropdown.style.backgroundColor = '#f5f5f5';
                        countyDropdown.style.cursor = 'not-allowed';
                    } else {
                        countyDropdown.disabled = false;
                        countyDropdown.value = '';
                    }
                    await handleExternalCountyChange();
                } else {
                    await initializeExternalLocationDropdowns();
                }
                
                // Set agency dropdown - ensure the option exists or add it
                if (agencyDropdown && agencyName) {
                    // Check if option exists
                    ensureOptionExists(agencyDropdown, agencyName);
                    agencyDropdown.value = agencyName;
                    // Make it read-only in edit mode
                    agencyDropdown.disabled = true;
                    agencyDropdown.style.backgroundColor = '#f5f5f5';
                    agencyDropdown.style.cursor = 'not-allowed';
                    await populateExternalProjectDropdown();
                } else if (agencyDropdown) {
                    agencyDropdown.disabled = false;
                    agencyDropdown.value = '';
                    await populateExternalProjectDropdown();
                }
                
                // Set project dropdown - ensure the option exists or add it
                if (projectDropdown && projectAreaName) {
                    ensureOptionExists(projectDropdown, projectAreaName);
                    projectDropdown.value = projectAreaName;
                    // Make it read-only in edit mode
                    projectDropdown.disabled = true;
                    projectDropdown.style.backgroundColor = '#f5f5f5';
                    projectDropdown.style.cursor = 'not-allowed';
                }
                
                // Populate all other fields from submission (skip agency/project fields as they're already set)
                Object.keys(submission).forEach(key => {
                    if (key === 'id' || key === 'createdAt' || key === 'updatedAt' || key === 'status' ||
                        key === 'submitterName' || key === 'cityCounty' || key === 'agency' ||
                        key === 'projectAreaName' || key === 'projectArea') return;
                    
                    const field = form.querySelector(`[name="${key}"]`);
                    if (field) {
                        if (field.type === 'checkbox') {
                            field.checked = submission[key];
                        } else if (field.tagName === 'SELECT') {
                            field.value = submission[key] || '';
                        } else {
                            field.value = submission[key] || '';
                        }
                    }
                });
                
                // Handle dynamic rows for external form
                populateDynamicRows(form, submission, 'expense', ['Title', 'tyExpense', 'cyExpense', 'nyExpense']);
                
                // Trigger calculations
                if (typeof calculateRemainingLife === 'function') calculateRemainingLife();
                if (typeof calculateExpenseTotal === 'function') {
                    // Calculate for all expense rows
                    const expenseRows = form.querySelectorAll('.expense-row');
                    expenseRows.forEach((row, idx) => {
                        calculateExpenseTotal(idx);
                    });
                }
                if (typeof calculatePercentResidential === 'function') calculatePercentResidential();
            }
        }
        
        function populateDynamicRows(form, submission, prefix, fields) {
            // Find how many rows exist
            let rowCount = 0;
            for (let i = 0; i < 20; i++) {
                const firstField = form.querySelector(`[name="${prefix}${fields[0]}_${i}"]`);
                if (firstField) rowCount = i + 1;
            }
            
            // Populate existing rows and add new ones if needed
            for (let i = 0; i < 20; i++) {
                const hasData = fields.some(field => submission[`${prefix}${field}_${i}`]);
                if (!hasData) continue;
                
                // Add row if it doesn't exist
                if (i >= rowCount) {
                    // Trigger add button based on prefix
                    const addBtn = form.querySelector(`#add-${prefix}-btn, #add-${prefix.toLowerCase()}-btn, #add-total-expense-btn`);
                    if (addBtn) {
                        for (let j = rowCount; j <= i; j++) {
                            addBtn.click();
                        }
                    }
                }
                
                // Populate fields
                fields.forEach(field => {
                    const fieldName = `${prefix}${field}_${i}`;
                    const fieldElement = form.querySelector(`[name="${fieldName}"]`);
                    if (fieldElement && submission[fieldName] !== undefined) {
                        fieldElement.value = submission[fieldName];
                    }
                });
            }
        }
        
        // Auto-save functionality
        function setupAutoSave(submissionId) {
            // Clear existing interval
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }
            
            // Show auto-save indicator
            const externalIndicator = document.getElementById('auto-save-indicator-external');
            const internalIndicator = document.getElementById('auto-save-indicator');
            const activeIndicator = externalIndicator && !document.getElementById('main-container').classList.contains('hidden') 
                ? externalIndicator 
                : internalIndicator;
            
            if (activeIndicator) {
                activeIndicator.style.display = 'block';
                updateLastSavedTime(activeIndicator);
            }
            
            // Auto-save every 30 seconds
            autoSaveInterval = setInterval(async () => {
                if (!currentEditingSubmissionId || currentEditingSubmissionId !== submissionId) {
                    clearInterval(autoSaveInterval);
                    if (activeIndicator) activeIndicator.style.display = 'none';
                    return;
                }
                
                await saveCurrentForm(submissionId, true); // true = isAutoSave
                if (activeIndicator) updateLastSavedTime(activeIndicator);
            }, 30000); // 30 seconds
        }
        
        function updateLastSavedTime(indicator) {
            const timeElement = indicator.querySelector('#last-saved-time, #last-saved-time-external');
            if (timeElement) {
                const now = new Date();
                timeElement.textContent = now.toLocaleTimeString();
            }
        }
        
        async function saveCurrentForm(submissionId, isAutoSave = false) {
            const submission = allSubmissions.find(sub => (sub.id || `submission-${allSubmissions.indexOf(sub)}`) === submissionId);
            if (!submission) return;
            
            // Determine which form is active
            const internalForm = document.getElementById('internal-data-request-form');
            const externalForm = document.getElementById('project-form');
            const isInternal = internalForm && !internalForm.classList.contains('hidden');
            const isExternal = externalForm && !externalForm.classList.contains('hidden');
            
            const activeForm = isInternal ? internalForm : (isExternal ? externalForm : null);
            if (!activeForm) return;
            
            // Collect form data
            const formData = new FormData(activeForm);
            const updatedData = {};
            
            for (const [key, value] of formData.entries()) {
                updatedData[key] = value;
            }
            
            // Also get all input/select/textarea values
            activeForm.querySelectorAll('input, select, textarea').forEach(field => {
                if (field.name && !formData.has(field.name)) {
                    if (field.type === 'checkbox') {
                        updatedData[field.name] = field.checked;
                    } else {
                        updatedData[field.name] = field.value;
                    }
                }
            });
            
            // Merge with existing submission
            Object.assign(submission, updatedData);
            
            // Save to API if available
            if (window.apiClient && window.currentUser && submission.id) {
                try {
                    const year = parseInt(submission.year || submission.fy || new Date().getFullYear());
                    // Check if this is a real database ID (UUID format) vs a local ID
                    // UUIDs are 36 characters with dashes: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
                    const isDatabaseId = submission.id && 
                                        typeof submission.id === 'string' && 
                                        submission.id.length === 36 && 
                                        submission.id.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i);
                    
                    if (isDatabaseId) {
                        // Real database ID - use update to avoid creating duplicates
                        console.log(`[saveCurrentForm] Updating existing submission ${submission.id}`);
                        await apiClient.updateSubmission({
                            submissionId: submission.id,
                            year,
                            payload: submission
                        });
                    } else {
                        // Local ID or new submission - create new (but only if not in edit mode)
                        if (!currentEditingSubmissionId) {
                            console.log(`[saveCurrentForm] Creating new submission (local ID: ${submission.id})`);
                            const result = await apiClient.createSubmission({
                                year,
                                payload: submission
                            });
                            // Update local submission with server ID
                            if (result.submission && result.submission.id) {
                                submission.id = result.submission.id;
                                // Update in allSubmissions array too
                                const index = allSubmissions.findIndex(s => s.id === submission.id || 
                                    (s.cityCounty === submission.cityCounty && 
                                     s.projectArea === submission.projectArea && 
                                     s.year === submission.year));
                                if (index >= 0) {
                                    allSubmissions[index].id = result.submission.id;
                                }
                            }
                        } else {
                            console.warn(`[saveCurrentForm] Skipping create - in edit mode but no database ID found`);
                        }
                    }
                    
                    if (!isAutoSave) {
                        showNotification('Changes saved successfully!');
                    }
                } catch (err) {
                    console.error('Failed to save to API:', err);
                    if (!isAutoSave) {
                        showNotification('Failed to save to server. Data saved locally.');
                    }
                }
            }
            
            // Update local storage
            localStorage.setItem('allSubmissions', JSON.stringify(allSubmissions));
            
            if (isAutoSave) {
                console.log('Auto-saved submission:', submissionId);
            }
        }
        
        // Delete project with double confirmation
        async function deleteProjectSubmission(submissionId, city, projectArea, year) {
            // First confirmation
            if (!confirm(`Are you sure you want to delete the project "${projectArea}"?`)) {
                return;
            }
            
            // Second confirmation
            if (!confirm(`This action cannot be undone. Are you absolutely sure you want to delete "${projectArea}"?`)) {
                return;
            }
            
            // Find and remove the submission
            const submissionIndex = allSubmissions.findIndex(sub => (sub.id || `submission-${allSubmissions.indexOf(sub)}`) === submissionId);
            
            if (submissionIndex === -1) {
                alert('Submission not found.');
                return;
            }
            
            const submission = allSubmissions[submissionIndex];
            
            // Delete from API if available
            if (window.apiClient && window.currentUser && submission.id) {
                try {
                    // Note: You may need to add a delete endpoint to the API
                    // For now, we'll just remove it locally
                    console.log('Would delete from API:', submission.id);
                } catch (err) {
                    console.error('Failed to delete from API:', err);
                }
            }
            
            // Remove from local array
            allSubmissions.splice(submissionIndex, 1);
            
            // Update local storage
            localStorage.setItem('allSubmissions', JSON.stringify(allSubmissions));
            
            // Refresh the projects list
            viewProjectsList(city, year);
            
            showNotification('Project deleted successfully.');
        }
        
        function deleteFromInternalDB(city, projectArea, year) {
            if (confirm('Are you sure you want to delete this project area from the internal database?')) {
                // Find all submissions that match this city, project area, and year
                const submissionsToDelete = allSubmissions.filter(sub => {
                    const submissionCity = sub.cityCounty || sub.submitterName || sub.projectArea || 'Unknown';
                    const submissionProjectArea = sub.projectArea || sub.projectAreaName || 'N/A';
                    const submissionYear = sub.year || sub.fy || 'Unknown';
                    
                    return submissionCity === city && submissionProjectArea === projectArea && submissionYear === year;
                });
                
                // Remove them from allSubmissions
                allSubmissions = allSubmissions.filter(sub => {
                    const submissionCity = sub.cityCounty || sub.submitterName || sub.projectArea || 'Unknown';
                    const submissionProjectArea = sub.projectArea || sub.projectAreaName || 'N/A';
                    const submissionYear = sub.year || sub.fy || 'Unknown';
                    
                    return !(submissionCity === city && submissionProjectArea === projectArea && submissionYear === year);
                });
                
                // Save to localStorage
                localStorage.setItem('allSubmissions', JSON.stringify(allSubmissions));
                
                // Refresh the view
                viewClientDetailsByYear(city, year);
                
                // Show notification
                showNotification('Project area deleted from internal database.');
            }
        }

        function editProjectAreaName(city, projectArea, year, rowIndex) {
            const submission = allSubmissions.find(sub => {
                const submissionCity = sub.cityCounty || sub.submitterName || sub.projectArea || 'Unknown';
                const submissionProjectArea = sub.projectArea || sub.projectAreaName || 'N/A';
                const submissionYear = sub.year || sub.fy || 'Unknown';
                return submissionCity === city && submissionProjectArea === projectArea && submissionYear === year;
            });

            if (!submission) return;

            const currentClientName = submission.cityCounty || submission.submitterName || 'Unknown';
            const currentProjectAreaName = submission.projectArea || submission.projectAreaName || 'N/A';

            const newClientName = prompt('Edit Client/Submitter Name:', currentClientName);
            if (newClientName === null) return;

            const newProjectAreaName = prompt('Edit Project Area Name:', currentProjectAreaName);
            if (newProjectAreaName === null) return;

            // Update the submission
            submission.cityCounty = newClientName;
            submission.submitterName = newClientName;
            submission.projectArea = newProjectAreaName;
            submission.projectAreaName = newProjectAreaName;

            // Save to localStorage
            localStorage.setItem('allSubmissions', JSON.stringify(allSubmissions));

            // Refresh the view
            viewClientDetailsByYear(city, year);

            // Show notification
            showNotification('Client and project area names updated successfully.');
        }

        function editClientName(city, year) {
            const cityYearSubmissions = allSubmissions.filter(submission => {
                const submissionCity = submission.cityCounty || 
                                     submission.submitterName || 
                                     submission.projectArea || 
                                     'Unknown';
                const submissionYear = submission.year || submission.fy || 'Unknown';
                return submissionCity === city && submissionYear === year;
            });

            if (cityYearSubmissions.length === 0) return;

            const newClientName = prompt('Edit Client Name:', city);
            if (newClientName === null || newClientName === '') return;

            // Update all submissions for this client and year
            cityYearSubmissions.forEach(submission => {
                submission.cityCounty = newClientName;
                submission.submitterName = newClientName;
            });

            // Save to localStorage
            localStorage.setItem('allSubmissions', JSON.stringify(allSubmissions));

            // Refresh the view
            renderInternalDBCityList();

            // Show notification
            showNotification('Client name updated successfully.');
        }

        function deleteClientByYear(city, year) {
            if (confirm('Are you sure you want to delete all project areas for this client and year from the internal database?')) {
                // Remove all submissions that match this city and year
                allSubmissions = allSubmissions.filter(sub => {
                    const submissionCity = sub.cityCounty || sub.submitterName || sub.projectArea || 'Unknown';
                    const submissionYear = sub.year || sub.fy || 'Unknown';
                    
                    return !(submissionCity === city && submissionYear === year);
                });
                
                // Save to localStorage
                localStorage.setItem('allSubmissions', JSON.stringify(allSubmissions));
                
                // Refresh the view
                renderInternalDBCityList();
                
                // Show notification
                showNotification('Client data deleted from internal database.');
            }
        }

        function viewClientDetails(city) {
            const container = document.getElementById('internal-db-table-container');
            const citySubmissions = allSubmissions.filter(submission => {
                const submissionCity = submission.cityCounty || 
                                     submission.submitterName || 
                                     submission.projectArea || 
                                     'Unknown';
                return submissionCity === city;
            });

            let html = '<div class="table-container">';
            html += `<div style="margin-bottom: 20px; display: flex; align-items: center; gap: 16px;">`;
            html += `<button onclick="renderInternalDBCityList()" class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px;">â† Back to Clients</button>`;
            html += `<h3 style="margin: 0; color: var(--primary-blue);">${city} - Project Areas</h3>`;
            html += `<button onclick="generatePDFReport('${city}', null)" class="btn btn-success" style="margin-left: auto; margin-right: 8px;">Generate Report</button>`;
            html += `<button onclick="downloadExcelForClient('${city}')" class="btn btn-primary">Download Excel</button>`;
            html += `</div>`;
            html += '<table class="table">';
            html += '<thead><tr><th>Project Area</th><th>Year</th><th>Type</th><th>Purpose</th><th>Status</th><th>Total Project Areas</th><th>Governing Board</th><th>Agency Staff</th><th>Actions</th></tr></thead><tbody>';

            // Calculate total project areas for this city (across all years)
            const totalProjectAreas = citySubmissions.length;
            
            // Group submissions by project area and year to show separate entries
            const projectYearGroups = {};
            citySubmissions.forEach(submission => {
                const projectArea = submission.projectArea || submission.projectAreaName || 'N/A';
                const year = submission.year || submission.fy || 'N/A';
                const key = `${projectArea}-${year}`;
                
                if (!projectYearGroups[key]) {
                    projectYearGroups[key] = {
                        projectArea: projectArea,
                        year: year,
                        submission: submission
                    };
                } else {
                    // Merge data if we have both external and internal data for same project/year
                    Object.assign(projectYearGroups[key].submission, submission);
                }
            });

            Object.values(projectYearGroups).forEach(group => {
                const submission = group.submission;
                const projectArea = group.projectArea;
                const year = group.year;
                const type = submission.type || 'N/A';
                const purpose = submission.purpose || 'N/A';
                
                // Determine status based on data completeness
                const hasExternalData = submission.submitterName || submission.projectAreaName;
                const hasInternalData = submission.cityCounty || submission.fy || submission.ty;
                let status, statusClass;
                
                if (hasExternalData && hasInternalData) {
                    status = 'Ready';
                    statusClass = 'status-ready';
                } else if (hasExternalData) {
                    status = 'Internal Data Needed';
                    statusClass = 'status-internal-needed';
                } else {
                    status = 'External Data Needed';
                    statusClass = 'status-external-needed';
                }

                // Get Governing Board and Agency Staff data
                const governingBoardMembers = [];
                const agencyStaffMembers = [];
                
                for (let i = 0; i < 10; i++) {
                    const boardName = submission[`governingBoardName_${i}`];
                    const boardTitle = submission[`governingBoardTitle_${i}`];
                    if (boardName || boardTitle) {
                        governingBoardMembers.push(`${boardName || ''}${boardTitle ? ` (${boardTitle})` : ''}`);
                    }
                    
                    const staffName = submission[`agencyStaffName_${i}`];
                    const staffTitle = submission[`agencyStaffTitle_${i}`];
                    if (staffName || staffTitle) {
                        agencyStaffMembers.push(`${staffName || ''}${staffTitle ? ` (${staffTitle})` : ''}`);
                    }
                }
                
                const governingBoardText = governingBoardMembers.length > 0 ? governingBoardMembers.join(', ') : 'N/A';
                const agencyStaffText = agencyStaffMembers.length > 0 ? agencyStaffMembers.join(', ') : 'N/A';
                
                html += `<tr>
                    <td><strong>${projectArea}</strong></td>
                    <td>${year}</td>
                    <td>${type}</td>
                    <td>${purpose}</td>
                    <td><span class="status-badge ${statusClass}">${status}</span></td>
                    <td><strong>${totalProjectAreas}</strong></td>
                    <td style="font-size: 12px; max-width: 200px;">${governingBoardText}</td>
                    <td style="font-size: 12px; max-width: 200px;">${agencyStaffText}</td>
                    <td><button onclick="viewProjectDetails('${city}', '${projectArea}', '${year}')" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;">View Details</button></td>
                </tr>`;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function viewProjectDetails(city, projectArea, year) {
            const container = document.getElementById('internal-db-table-container');
            
            console.log(`[viewProjectDetails] Looking for city: "${city}", projectArea: "${projectArea}", year: "${year}"`);
            console.log(`[viewProjectDetails] Total submissions: ${allSubmissions.length}`);
            
            // Try to find the submission with flexible matching (same as viewClientDetailsByYear)
            const submission = allSubmissions.find(sub => {
                // Try multiple field name variations for city/client
                const submissionCity = sub.cityCounty || 
                                     sub.submitterName || 
                                     sub.client ||
                                     sub.agency ||
                                     sub.projectArea || 
                                     sub.projectAreaName ||
                                     'Unknown';
                
                // Try multiple field name variations for project area
                const submissionProject = sub.projectArea || 
                                        sub.projectAreaName || 
                                        'N/A';
                
                // Try multiple field name variations for year (handle string vs number)
                const submissionYear = String(sub.year || sub.fy || sub.ty || 'Unknown');
                const targetYear = String(year);
                
                // Normalize for comparison
                const cityMatch = submissionCity.toString().trim().toLowerCase() === city.toString().trim().toLowerCase();
                const projectMatch = submissionProject.toString().trim().toLowerCase() === projectArea.toString().trim().toLowerCase();
                const yearMatch = submissionYear === targetYear;
                
                const matches = cityMatch && projectMatch && yearMatch;
                
                if (matches) {
                    console.log(`[viewProjectDetails] Found matching submission:`, {
                        city: submissionCity,
                        projectArea: submissionProject,
                        year: submissionYear,
                        submission: sub
                    });
                }
                
                return matches;
            });

            if (!submission) {
                console.error(`[viewProjectDetails] No submission found matching:`, {
                    city,
                    projectArea,
                    year,
                    availableSubmissions: allSubmissions.map(s => ({
                        city: s.cityCounty || s.submitterName || s.client || s.agency,
                        projectArea: s.projectArea || s.projectAreaName,
                        year: s.year || s.fy || s.ty
                    }))
                });
                container.innerHTML = '<div class="card"><div class="card-body"><p style="padding: 40px; text-align: center; color: #666;">Project details not found.</p><p style="text-align: center; color: #999; font-size: 12px;">Check the browser console for debugging information.</p></div></div>';
                return;
            }
            
            console.log(`[viewProjectDetails] Displaying details for submission:`, submission);

            let html = '<div class="card">';
            html += `<div class=\"card-header\" style=\"display: flex; align-items: center; gap: 16px;\">`;
            html += `<button onclick=\"viewClientDetails('${city}')\" class=\"btn btn-secondary\" style=\"padding: 8px 16px; font-size: 12px;\">â† Back to ${city}</button>`;
            html += `<h3 style=\"margin: 0;\">${projectArea} - ${year}</h3>`;
            html += `<div style=\"margin-left: auto; display:flex; gap:8px;\">`;
            html += `<button id=\"edit-detail-btn\" class=\"btn btn-primary\">Edit</button>`;
            html += `<button id=\"save-detail-btn\" class=\"btn btn-success\" style=\"display:none;\">Save</button>`;
            html += `<button id=\"cancel-detail-btn\" class=\"btn btn-secondary\" style=\"display:none;\">Cancel</button>`;
            html += `</div>`;
            html += `</div>`;
            html += '<div class="card-body">';
            
            // Basic Information
            html += '<div class="section-title" style="display:flex; align-items:center; gap:8px;">Basic Information<div style="margin-left:auto; display:flex; gap:8px;">'
                + '<button class="btn btn-primary section-edit" data-section="basic" style="padding:4px 10px; font-size:12px;">Edit</button>'
                + '<button class="btn btn-success section-save" data-section="basic" style="padding:4px 10px; font-size:12px; display:none;">Save</button>'
                + '<button class="btn btn-secondary section-cancel" data-section="basic" style="padding:4px 10px; font-size:12px; display:none;">Cancel</button>'
                + '</div></div>';
            html += '<div class="form-grid editable-section" data-section="basic">';
            html += `<div class=\"form-row\"><label>Agency/Submitter:</label><span data-key=\"submitterName|cityCounty\">${submission.submitterName || submission.cityCounty || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\"><label>Project Area:</label><span data-key=\"projectArea|projectAreaName\">${submission.projectArea || submission.projectAreaName || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\"><label>Year:</label><span data-key=\"year|fy\">${submission.year || submission.fy || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\"><label>FY:</label><span data-key=\"fy\">${submission.fy || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\"><label>TY:</label><span data-key=\"ty\">${submission.ty || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\"><label>Type:</label><span data-key=\"type\">${submission.type || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\"><label>Purpose:</label><span data-key=\"purpose\">${submission.purpose || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\"><label>Taxing District:</label><span data-key=\"taxingDistrict\">${submission.taxingDistrict || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\"><label>Tax Rate:</label><span data-key=\"taxRate\">${submission.taxRate || 'N/A'}</span></div>`;
            html += '</div>';

            // Project Area Information (External Form) - Always show
            html += '<div class="section-title" style="display:flex; align-items:center; gap:8px;">Project Area Information<div style="margin-left:auto; display:flex; gap:8px;">'
                + '<button class="btn btn-primary section-edit" data-section="project" style="padding:4px 10px; font-size:12px;">Edit</button>'
                + '<button class="btn btn-success section-save" data-section="project" style="padding:4px 10px; font-size:12px; display:none;">Save</button>'
                + '<button class="btn btn-secondary section-cancel" data-section="project" style="padding:4px 10px; font-size:12px; display:none;">Cancel</button>'
                + '</div></div>';
            html += '<div class="form-grid editable-section" data-section="project">';
            html += `<div class=\"form-row\"><label>ACREAGE:</label><span data-key=\"acreage\">${submission.acreage || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\"><label>CREATION YEAR:</label><span data-key=\"creationYear\">${submission.creationYear || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\"><label>BASE YEAR:</label><span data-key=\"baseYear\">${submission.baseYear || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\"><label>TERM LENGTH:</label><span data-key=\"termLength\">${submission.termLength || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\"><label>START YEAR:</label><span data-key=\"startYear\">${submission.startYear || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\"><label>EXPIRATION YEAR:</label><span data-key=\"expirationYear\">${submission.expirationYear || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\"><label>BASE VALUE:</label><span data-key=\"baseValue\">${submission.baseValue || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\"><label>FY INCREMENT:</label><span data-key=\"fyIncrement\">${submission.fyIncrement || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\"><label>REMAINING LIFE:</label><span data-key=\"remainingLife\">${submission.remainingLife || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\"><label>FUND BALANCE:</label><span data-key=\"fundBalance\">${submission.fundBalance || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\" style=\"grid-column: 1 / -1;\"><label>PLANNED USES FOR FUND BALANCE:</label><span data-key=\"plannedUsesFundBalance\">${submission.plannedUsesFundBalance || 'N/A'}</span></div>`;
            html += '</div>';

            // Value Information - Always show
            html += '<div class="section-title" style="display:flex; align-items:center; gap:8px;">Value Information<div style="margin-left:auto; display:flex; gap:8px;">'
                + '<button class="btn btn-primary section-edit" data-section="value" style="padding:4px 10px; font-size:12px;">Edit</button>'
                + '<button class="btn btn-success section-save" data-section="value" style="padding:4px 10px; font-size:12px; display:none;">Save</button>'
                + '<button class="btn btn-secondary section-cancel" data-section="value" style="padding:4px 10px; font-size:12px; display:none;">Cancel</button>'
                + '</div></div>';
            html += '<div class="form-grid editable-section" data-section="value">';
            html += `<div class=\"form-row\"><label>TY Value:</label><span data-key=\"tyValue\">${submission.tyValue || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\"><label>Value Increase:</label><span data-key=\"valueIncrease\">${submission.valueIncrease || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\" style=\"grid-column: 1 / -1;\"><label>Growth in Assessed Value:</label><span data-key=\"growthInAssessedValue\">${submission.growthInAssessedValue || 'N/A'}</span></div>`;
            html += '</div>';

            // Development Information (External Form) - Always show
            html += '<div class="section-title" style="display:flex; align-items:center; gap:8px;">Development Information<div style="margin-left:auto; display:flex; gap:8px;">'
                + '<button class="btn btn-primary section-edit" data-section="development" style="padding:4px 10px; font-size:12px;">Edit</button>'
                + '<button class="btn btn-success section-save" data-section="development" style="padding:4px 10px; font-size:12px; display:none;">Save</button>'
                + '<button class="btn btn-secondary section-cancel" data-section="development" style="padding:4px 10px; font-size:12px; display:none;">Cancel</button>'
                + '</div></div>';
            html += '<div class="form-grid editable-section" data-section="development">';
            html += `<div class="form-row"><label>DEVELOPED ACREAGE:</label><span data-key="developedAcreage">${submission.developedAcreage || 'N/A'}</span></div>`;
            html += `<div class="form-row"><label>UNDEVELOPED ACREAGE:</label><span data-key="undevelopedAcreage">${submission.undevelopedAcreage || 'N/A'}</span></div>`;
            html += `<div class="form-row"><label>RESIDENTIAL ACREAGE:</label><span data-key="residentialAcreage">${submission.residentialAcreage || 'N/A'}</span></div>`;
            html += `<div class="form-row"><label>% RESIDENTIAL:</label><span data-key="percentResidential">${submission.percentResidential || 'N/A'}</span></div>`;
            html += `<div class="form-row"><label>TOTAL AUTHORIZED HOUSING UNITS:</label><span data-key="totalAuthorizedHousingUnits">${submission.totalAuthorizedHousingUnits || 'N/A'}</span></div>`;
            html += '</div>';

            // Descriptions (External Form) - Always show
            html += '<div class="section-title" style="display:flex; align-items:center; gap:8px;">Descriptions<div style="margin-left:auto; display:flex; gap:8px;">'
                + '<button class="btn btn-primary section-edit" data-section="descriptions" style="padding:4px 10px; font-size:12px;">Edit</button>'
                + '<button class="btn btn-success section-save" data-section="descriptions" style="padding:4px 10px; font-size:12px; display:none;">Save</button>'
                + '<button class="btn btn-secondary section-cancel" data-section="descriptions" style="padding:4px 10px; font-size:12px; display:none;">Cancel</button>'
                + '</div></div>';
            html += '<div class="form-grid editable-section" data-section="descriptions">';
            html += `<div class="form-row" style="grid-column: 1 / -1;"><label>DESCRIPTION OF SIGNIFICANT DEVELOPMENT:</label><span data-key="descriptionSignificantDevelopment">${submission.descriptionSignificantDevelopment || 'N/A'}</span></div>`;
            html += `<div class="form-row" style="grid-column: 1 / -1;"><label>DESCRIPTION OF HOW THE PLAN HAS BEEN FURTHERED:</label><span data-key="descriptionPlanFurthered">${submission.descriptionPlanFurthered || 'N/A'}</span></div>`;
            html += `<div class="form-row" style="grid-column: 1 / -1;"><label>DESCRIPTION OF OTHER ISSUES WORTH NOTING:</label><span data-key="descriptionOtherIssues">${submission.descriptionOtherIssues || 'N/A'}</span></div>`;
            html += '</div>';

            // Uses of Funds Table (from external form expenses)
            // Build expenses array from individual fields (expenseTitle_0, tyExpense_0, etc.)
            let expensesArray = [];
            if (submission.expenses && submission.expenses.length > 0) {
                expensesArray = submission.expenses;
            } else {
                // Build from individual fields used in external form
                for (let i = 0; i < 20; i++) {
                    const title = submission[`expenseTitle_${i}`];
                    const tyExpense = submission[`tyExpense_${i}`];
                    const cyExpense = submission[`cyExpense_${i}`];
                    const nyExpense = submission[`nyExpense_${i}`];
                    
                    if (title || tyExpense || cyExpense || nyExpense) {
                        expensesArray.push({
                            title: title || '',
                            tyExpense: tyExpense || '',
                            cyExpense: cyExpense || '',
                            nyExpense: nyExpense || ''
                        });
                    }
                }
            }
            
            // Uses of Funds - Always show (show at least one empty row if no data)
            html += '<div class="section-title" style="display:flex; align-items:center; gap:8px;">Uses of Funds<div style="margin-left:auto; display:flex; gap:8px;">'
                + '<button class="btn btn-primary section-edit" data-section="expenses" style="padding:4px 10px; font-size:12px;">Edit</button>'
                + '<button class="btn btn-success section-save" data-section="expenses" style="padding:4px 10px; font-size:12px; display:none;">Save</button>'
                + '<button class="btn btn-secondary section-cancel" data-section="expenses" style="padding:4px 10px; font-size:12px; display:none;">Cancel</button>'
                + '</div></div>';
            html += '<div class="table-container editable-section" data-section="expenses">';
            html += '<table class="table">';
            html += '<thead><tr><th>Expense Title</th><th>TY Expense</th><th>CY Expense</th><th>NY Expense</th></tr></thead><tbody>';
            
            if (expensesArray.length > 0) {
                expensesArray.forEach((expense, i) => {
                    html += `<tr>
                        <td data-key="expenses.${i}.title">${expense.title || ''}</td>
                        <td data-key="expenses.${i}.tyExpense">${expense.tyExpense || ''}</td>
                        <td data-key="expenses.${i}.cyExpense">${expense.cyExpense || ''}</td>
                        <td data-key="expenses.${i}.nyExpense">${expense.nyExpense || ''}</td>
                    </tr>`;
                });
            } else {
                // Show at least one empty row if no data
                html += `<tr>
                    <td data-key="expenses.0.title"></td>
                    <td data-key="expenses.0.tyExpense"></td>
                    <td data-key="expenses.0.cyExpense"></td>
                    <td data-key="expenses.0.nyExpense"></td>
                </tr>`;
            }
            
            html += '</tbody></table></div>';

            // Sources of Funds (editable) - Always show this section
            const currentYear = submission.year || submission.fy || new Date().getFullYear();
            const nextYear = parseInt(currentYear) + 1;
            const followingYear = parseInt(currentYear) + 2;
            const propTax2025 = parseFloat(submission.propertyTax2025 || submission.currentYearRevenue || 0);
            const propTax2026 = parseFloat(submission.propertyTax2026 || submission.nextYearRevenue || 0);
            const propTax2027 = parseFloat(submission.propertyTax2027 || submission.followingYearRevenue || 0);
            
            html += '<div class="section-title" style="display:flex; align-items:center; gap:8px;">Sources of Funds<div style="margin-left:auto; display:flex; gap:8px;">'
                + '<button class="btn btn-primary section-edit" data-section="sources" style="padding:4px 10px; font-size:12px;">Edit</button>'
                + '<button class="btn btn-success section-save" data-section="sources" style="padding:4px 10px; font-size:12px; display:none;">Save</button>'
                + '<button class="btn btn-secondary section-cancel" data-section="sources" style="padding:4px 10px; font-size:12px; display:none;">Cancel</button>'
                + '</div></div>';
            html += '<div class="table-container editable-section" data-section="sources">';
            html += '<table class="table">';
            html += `<thead><tr><th>Source</th><th>${currentYear} ACTUAL</th><th>${nextYear} FORECASTED</th><th>${followingYear} FORECASTED</th></tr></thead><tbody>`;
            
            // Property Tax Increment row - editable cells
            const display2025 = propTax2025 ? '$' + propTax2025.toLocaleString() : '';
            const display2026 = propTax2026 ? '$' + propTax2026.toLocaleString() : '';
            const display2027 = propTax2027 ? '$' + propTax2027.toLocaleString() : '';
            
            html += `<tr>
                <td>Property Tax Increment</td>
                <td data-key="propertyTax2025|currentYearRevenue">${display2025}</td>
                <td data-key="propertyTax2026|nextYearRevenue">${display2026}</td>
                <td data-key="propertyTax2027|followingYearRevenue">${display2027}</td>
            </tr>`;
            
            // Total row - calculated, not editable
            html += `<tr style="font-weight:bold; background-color:#E9ECEF;">
                <td>Total Sources of Funds</td>
                <td>${display2025}</td>
                <td>${display2026}</td>
                <td>${display2027}</td>
            </tr>`;
            
            html += '</tbody></table></div>';

            // Tax Entities (editable) - Always show (show at least one empty row if no data)
            html += '<div class="section-title" style="display:flex; align-items:center; gap:8px;">Tax Entities<div style="margin-left:auto; display:flex; gap:8px;">'
                + '<button class="btn btn-primary section-edit" data-section="taxentities" style="padding:4px 10px; font-size:12px;">Edit</button>'
                + '<button class="btn btn-success section-save" data-section="taxentities" style="padding:4px 10px; font-size:12px; display:none;">Save</button>'
                + '<button class="btn btn-secondary section-cancel" data-section="taxentities" style="padding:4px 10px; font-size:12px; display:none;">Cancel</button>'
                + '</div></div>';
            html += '<div class="table-container editable-section" data-section="taxentities">';
            html += '<table class="table">';
            html += '<thead><tr><th>Tax Entity</th><th>Tax Rate</th><th>Tax Revenue</th></tr></thead><tbody>';
            
            if (submission.taxEntities && submission.taxEntities.length > 0) {
                submission.taxEntities.forEach((entity, i) => {
                    html += `<tr>
                        <td data-key="taxEntities.${i}.name">${entity.name || ''}</td>
                        <td data-key="taxEntities.${i}.rate">${entity.rate || ''}</td>
                        <td data-key="taxEntities.${i}.revenue">${entity.revenue || ''}</td>
                    </tr>`;
                });
            } else {
                // Show at least one empty row if no data
                html += `<tr>
                    <td data-key="taxEntities.0.name"></td>
                    <td data-key="taxEntities.0.rate"></td>
                    <td data-key="taxEntities.0.revenue"></td>
                </tr>`;
            }
            
            html += '</tbody></table></div>';

            // Additional Internal Form Fields (editable) - Always show
            html += '<div class="section-title" style="display:flex; align-items:center; gap:8px;">Additional Internal Information<div style="margin-left:auto; display:flex; gap:8px;">'
                + '<button class="btn btn-primary section-edit" data-section="additional" style="padding:4px 10px; font-size:12px;">Edit</button>'
                + '<button class="btn btn-success section-save" data-section="additional" style="padding:4px 10px; font-size:12px; display:none;">Save</button>'
                + '<button class="btn btn-secondary section-cancel" data-section="additional" style="padding:4px 10px; font-size:12px; display:none;">Cancel</button>'
                + '</div></div>';
            html += '<div class="form-grid editable-section" data-section="additional">';
            html += `<div class="form-row"><label>TOTAL AGGREGATE EXPENSE:</label><span data-key="totalAggregateExpense">${submission.totalAggregateExpense || 'N/A'}</span></div>`;
            html += `<div class="form-row"><label>TOTAL AGGREGATE EXPENSE AT NPV:</label><span data-key="totalAggregateExpenseAtNpv">${submission.totalAggregateExpenseAtNpv || 'N/A'}</span></div>`;
            html += `<div class="form-row"><label>TOTAL USES OF FUNDS NPV:</label><span data-key="totalUsesOfFundsNpv">${submission.totalUsesOfFundsNpv || 'N/A'}</span></div>`;
            html += `<div class="form-row" style="grid-column: 1 / -1;"><label>DESCRIPTION OF BENEFITS TO TAXING ENTITIES:</label><span data-key="descriptionOfBenefitsToTaxingEntities">${submission.descriptionOfBenefitsToTaxingEntities || 'N/A'}</span></div>`;
            html += '</div>';

            // Governing Board (from indexed fields) - Always show table, allow adding members
            html += '<div class="section-title" style="display:flex; align-items:center; gap:8px;">Governing Board of Trustees<div style="margin-left:auto; display:flex; gap:8px;">'
                + '<button class="btn btn-primary section-edit" data-section="board" style="padding:4px 10px; font-size:12px;">Edit</button>'
                + '<button class="btn btn-success section-save" data-section="board" style="padding:4px 10px; font-size:12px; display:none;">Save</button>'
                + '<button class="btn btn-secondary section-cancel" data-section="board" style="padding:4px 10px; font-size:12px; display:none;">Cancel</button>'
                + '</div></div>';
            html += '<div class="table-container editable-section" data-section="board">';
            html += '<table class="table" id="governing-board-table">';
            html += '<thead><tr><th>Name</th><th>Title</th><th style="width:80px;">Actions</th></tr></thead><tbody id="governing-board-tbody">';
            
            // Find all existing board members
            const boardMembers = [];
            for (let i = 0; i < 50; i++) {
                const name = submission[`governingBoardName_${i}`];
                const title = submission[`governingBoardTitle_${i}`];
                if (name || title) {
                    boardMembers.push({ index: i, name: name || '', title: title || '' });
                }
            }
            
            // Display existing members or show empty row if none
            if (boardMembers.length > 0) {
                boardMembers.forEach(member => {
                    html += `<tr data-index="${member.index}">
                        <td data-key="governingBoardName_${member.index}">${member.name}</td>
                        <td data-key="governingBoardTitle_${member.index}">${member.title}</td>
                        <td><button class="btn btn-danger btn-sm remove-board-row" style="padding:2px 8px; font-size:11px; display:none;">Remove</button></td>
                    </tr>`;
                });
            } else {
                // Show empty row if no members
                html += '<tr data-index="0"><td data-key="governingBoardName_0"></td><td data-key="governingBoardTitle_0"></td><td><button class="btn btn-danger btn-sm remove-board-row" style="padding:2px 8px; font-size:11px; display:none;">Remove</button></td></tr>';
            }
            
            html += '</tbody></table>';
            html += '<button class="btn btn-primary btn-sm add-board-row" style="margin-top:10px; padding:6px 12px; font-size:12px; display:none;">+ Add Board Member</button>';
            html += '</div>';

            // Agency Staff (from indexed fields) - Always show table, allow adding members
            html += '<div class="section-title" style="display:flex; align-items:center; gap:8px;">Agency Staff<div style="margin-left:auto; display:flex; gap:8px;">'
                + '<button class="btn btn-primary section-edit" data-section="staff" style="padding:4px 10px; font-size:12px;">Edit</button>'
                + '<button class="btn btn-success section-save" data-section="staff" style="padding:4px 10px; font-size:12px; display:none;">Save</button>'
                + '<button class="btn btn-secondary section-cancel" data-section="staff" style="padding:4px 10px; font-size:12px; display:none;">Cancel</button>'
                + '</div></div>';
            html += '<div class="table-container editable-section" data-section="staff">';
            html += '<table class="table" id="agency-staff-table">';
            html += '<thead><tr><th>Name</th><th>Title</th><th style="width:80px;">Actions</th></tr></thead><tbody id="agency-staff-tbody">';
            
            // Find all existing staff members
            const staffMembers = [];
            for (let i = 0; i < 50; i++) {
                const name = submission[`agencyStaffName_${i}`];
                const title = submission[`agencyStaffTitle_${i}`];
                if (name || title) {
                    staffMembers.push({ index: i, name: name || '', title: title || '' });
                }
            }
            
            // Display existing members or show empty row if none
            if (staffMembers.length > 0) {
                staffMembers.forEach(member => {
                    html += `<tr data-index="${member.index}">
                        <td data-key="agencyStaffName_${member.index}">${member.name}</td>
                        <td data-key="agencyStaffTitle_${member.index}">${member.title}</td>
                        <td><button class="btn btn-danger btn-sm remove-staff-row" style="padding:2px 8px; font-size:11px; display:none;">Remove</button></td>
                    </tr>`;
                });
            } else {
                // Show empty row if no members
                html += '<tr data-index="0"><td data-key="agencyStaffName_0"></td><td data-key="agencyStaffTitle_0"></td><td><button class="btn btn-danger btn-sm remove-staff-row" style="padding:2px 8px; font-size:11px; display:none;">Remove</button></td></tr>';
            }
            
            html += '</tbody></table>';
            html += '<button class="btn btn-primary btn-sm add-staff-row" style="margin-top:10px; padding:6px 12px; font-size:12px; display:none;">+ Add Staff Member</button>';
            html += '</div>';

            // Project Area Budget (always visible, editable)
            const discountRate = submission.discountRate || 0;
            html += '<div class="section-title" style="display:flex; align-items:center; gap:8px;">Project Area Budget<div style="margin-left:auto; display:flex; gap:8px;">'
                + '<button class="btn btn-primary section-edit" data-section="budget" style="padding:4px 10px; font-size:12px;">Edit</button>'
                + '<button class="btn btn-success section-save" data-section="budget" style="padding:4px 10px; font-size:12px; display:none;">Save</button>'
                + '<button class="btn btn-secondary section-cancel" data-section="budget" style="padding:4px 10px; font-size:12px; display:none;">Cancel</button>'
                + '</div></div>';
            html += '<div class="table-container editable-section" data-section="budget">';
            html += '<table class="table">';
            html += '<thead><tr><th></th><th>Totals</th><th>NPV @ <span id="view-discount-rate-display">' + parseFloat(discountRate).toFixed(2) + '</span>%</th></tr></thead><tbody>';
            
            html += '<tr style="background-color: var(--bg-secondary); font-weight: 600;"><td>Revenues</td><td>Totals</td><td>NPV @ <span id="view-discount-rate-display-revenue">' + parseFloat(discountRate).toFixed(2) + '</span>%</td></tr>';
            
            const propertyTaxIncrementTotal = parseFloat(submission.propertyTaxIncrementTotal || 0);
            const propertyTaxIncrementNpv = parseFloat(submission.propertyTaxIncrementNpv || 0);
            const totalRevenueTotal = parseFloat(submission.totalRevenueTotal || propertyTaxIncrementTotal || 0);
            const totalRevenueNpv = parseFloat(submission.totalRevenueNpv || propertyTaxIncrementNpv || 0);
            
            html += `<tr>
                <td style="font-weight: 600; padding: 12px;">Property Tax Increment</td>
                <td><span data-key="propertyTaxIncrementTotal" class="budget-input-display">${propertyTaxIncrementTotal}</span></td>
                <td><span data-key="propertyTaxIncrementNpv" class="budget-input-display">${propertyTaxIncrementNpv}</span></td>
            </tr>`;
            
            html += `<tr>
                <td style="font-weight: 600; padding: 12px;">Total Revenue</td>
                <td><span data-key="totalRevenueTotal" class="budget-input-display budget-calculated">${totalRevenueTotal}</span></td>
                <td><span data-key="totalRevenueNpv" class="budget-input-display budget-calculated">${totalRevenueNpv}</span></td>
            </tr>`;
            
            html += '<tr style="background-color: var(--bg-secondary); font-weight: 600;"><td>Expenses</td><td>Totals</td><td>NPV @ <span id="view-discount-rate-display-expense">' + parseFloat(discountRate).toFixed(2) + '</span>%</td></tr>';
            
            const administrativeFeeTotal = parseFloat(submission.administrativeFeeTotal || 0);
            const administrativeFeeNpv = parseFloat(submission.administrativeFeeNpv || 0);
            const expenseTotal = parseFloat(submission.expenseTotal || 0);
            const expenseNpv = parseFloat(submission.expenseNpv || 0);
            const totalUsesOfFundsTotal = parseFloat(submission.totalUsesOfFundsTotal || (administrativeFeeTotal + expenseTotal) || 0);
            const totalUsesOfFundsNpv = parseFloat(submission.totalUsesOfFundsNpv || (administrativeFeeNpv + expenseNpv) || 0);
            
            html += `<tr>
                <td style="font-weight: 600; padding: 12px;">Administrative Fee</td>
                <td><span data-key="administrativeFeeTotal" class="budget-input-display">${administrativeFeeTotal}</span></td>
                <td><span data-key="administrativeFeeNpv" class="budget-input-display">${administrativeFeeNpv}</span></td>
            </tr>`;
            
            html += `<tr>
                <td style="font-weight: 600; padding: 12px;">Expense</td>
                <td><span data-key="expenseTotal" class="budget-input-display">${expenseTotal}</span></td>
                <td><span data-key="expenseNpv" class="budget-input-display">${expenseNpv}</span></td>
            </tr>`;
            
            html += `<tr>
                <td style="font-weight: 600; padding: 12px;">Total Uses of Funds</td>
                <td><span data-key="totalUsesOfFundsTotal" class="budget-input-display budget-calculated">${totalUsesOfFundsTotal}</span></td>
                <td><span data-key="totalUsesOfFundsNpv" class="budget-input-display budget-calculated">${totalUsesOfFundsNpv}</span></td>
            </tr>`;
            
            html += '</tbody></table>';
            html += '<div style="margin-top: 16px;"><label style="font-weight: 600;">Discount Rate (%):</label> <span data-key="discountRate" class="budget-input-display">' + parseFloat(discountRate).toFixed(2) + '</span></div>';
            html += '</div>';

            // Combined Tax Increment Budget
            html += '<div class="section-title">Combined Tax Increment Budget</div>';
            html += generateCombinedTaxIncrementBudget(city, year);
            
            // Combined Acreage Overview
            html += '<div class="section-title">Combined Acreage Overview</div>';
            html += generateCombinedAcreageOverview(city, year);
            
            // Increment Distribution
            if (submission.incrementEntity_0 || submission.incrementActual_0 || submission.incrementRemaining_0) {
                html += '<div class="section-title">Increment Distribution</div>';
                html += '<div class="table-container">';
                html += '<table class="table">';
                html += '<thead><tr><th>Entity Description</th><th>Actual Received</th><th>Amount Remaining Authorized</th></tr></thead><tbody>';
                
                // Show up to 10 increment distribution entries
                for (let i = 0; i < 10; i++) {
                    const entity = submission[`incrementEntity_${i}`];
                    const actual = submission[`incrementActual_${i}`];
                    const remaining = submission[`incrementRemaining_${i}`];
                    
                    if (entity || actual || remaining) {
                        html += `<tr>
                            <td>${entity || 'N/A'}</td>
                            <td>$${parseFloat(actual || 0).toLocaleString()}</td>
                            <td>$${parseFloat(remaining || 0).toLocaleString()}</td>
                        </tr>`;
                    }
                }
                
                html += '</tbody></table></div>';
            }

            // Tax Increment Summary
            if (submission.taxIncrementEntities && submission.taxIncrementEntities.length > 0) {
                const displayYear = submission.fy || submission.year || '2025';
                html += '<div class="section-title">Tax Increment Summary</div>';
                html += '<div class="table-container">';
                html += '<table class="table">';
                html += `<thead><tr><th>Entity</th><th>${displayYear} Actual</th><th>Remaining Authorized</th></tr></thead><tbody>`;
                
                submission.taxIncrementEntities.forEach((item) => {
                    html += `<tr>
                        <td>${item.entity || 'N/A'}</td>
                        <td>$${parseFloat(item.yearActual || 0).toLocaleString()}</td>
                        <td>$${parseFloat(item.remainingAuthorized || 0).toLocaleString()}</td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
            }

            // Revenue Information
            if (submission.tyOriginalBudgetRevenues || submission.lifetimeRevenues || submission.tyActualRevenue || submission.lifetimeActualRevenues || submission.tyBaseYearRevenue || submission.lifetimeBaseYearRevenues) {
                const displayYear = submission.fy || submission.year || '2025';
                html += '<div class="section-title">Revenue Information</div>';
                html += '<div class="table-container">';
                html += '<table class="table">';
                html += '<thead><tr style="background-color: #f8f9fa; font-weight: bold;"><th colspan="4" style="text-align: center; background-color: #e9ecef; color: #000000;">Growth in Tax Increment</th></tr>';
                html += '<tr><th></th><th>ORIGINAL BUDGET REVENUES</th><th>ACTUAL REVENUE</th><th>BASE YEAR VALUE REVENUES</th></tr></thead><tbody>';
                
                html += `<tr>
                    <td style="font-weight: 600; padding: 12px;">Tax Year ${displayYear}</td>
                    <td>$${parseFloat(submission.tyOriginalBudgetRevenues || 0).toLocaleString()}</td>
                    <td>$${parseFloat(submission.tyActualRevenue || 0).toLocaleString()}</td>
                    <td>$${parseFloat(submission.tyBaseYearRevenue || 0).toLocaleString()}</td>
                </tr>`;
                
                html += `<tr>
                    <td style="font-weight: 600; padding: 12px;">Lifetime Revenue</td>
                    <td>$${parseFloat(submission.lifetimeRevenues || 0).toLocaleString()}</td>
                    <td>$${parseFloat(submission.lifetimeActualRevenues || 0).toLocaleString()}</td>
                    <td>$${parseFloat(submission.lifetimeBaseYearRevenues || 0).toLocaleString()}</td>
                </tr>`;
                
                html += '</tbody></table></div>';
            }


            // Project Area Maps
            if (submission.projectAreaMaps && submission.projectAreaMaps.length > 0) {
                html += '<div class="section-title">Project Area Maps</div>';
                html += '<div style="display: grid; gap: 12px; margin-top: 16px;">';
                
                submission.projectAreaMaps.forEach((map, index) => {
                    html += `<div style="
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        background: #00B0F0;
                        border: 1px solid #00B0F0;
                        border-radius: 12px;
                        padding: 16px 20px;
                        transition: all 0.3s ease;
                        box-shadow: 0 2px 8px rgba(0,176,240,0.1);
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 16px rgba(0,176,240,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,176,240,0.1)'">
                        <div style="display: flex; align-items: center; gap: 16px; flex: 1;">
                            <div style="
                                width: 48px;
                                height: 48px;
                                background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                                border-radius: 12px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-size: 20px;
                                font-weight: bold;
                                box-shadow: 0 2px 8px rgba(220,53,69,0.3);
                            ">PDF</div>
                            <div>
                                <div style="font-weight: 600; color: #333; margin-bottom: 4px; font-size: 16px;">${map.name}</div>
                                <div style="font-size: 13px; color: #666; display: flex; align-items: center; gap: 8px;">
                                    <span>ðŸ“Š</span>
                                    <span>${(map.size / 1024).toFixed(1)} KB</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="downloadPDF('${map.name}', '${map.data}')" style="
                            background: #00B0F0;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            padding: 10px 16px;
                            font-size: 14px;
                            font-weight: 500;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            box-shadow: 0 2px 8px rgba(0,176,240,0.3);
                        " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 16px rgba(0,176,240,0.4)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(0,176,240,0.3)'">
                            <span>â¬‡ï¸</span>
                            <span>Download</span>
                        </button>
                    </div>`;
                });
                
                html += '</div>';
            }
            
            html += '</div></div>';
            container.innerHTML = html;

            // Wire up inline edit controls
            const editBtn = document.getElementById('edit-detail-btn');
            const saveBtn = document.getElementById('save-detail-btn');
            const cancelBtn = document.getElementById('cancel-detail-btn');

            let snapshot = null;

            function setEditable(isEditable) {
                const spans = container.querySelectorAll('[data-key]');
                spans.forEach(el => {
                    el.contentEditable = isEditable ? 'true' : 'false';
                    el.style.outline = isEditable ? '1px dashed var(--border-gray)' : '';
                    el.style.background = isEditable ? 'var(--bg-secondary)' : '';
                });
                if (editBtn) editBtn.style.display = isEditable ? 'none' : '';
                if (saveBtn) saveBtn.style.display = isEditable ? '' : 'none';
                if (cancelBtn) cancelBtn.style.display = isEditable ? '' : 'none';
            }

            if (editBtn) {
                editBtn.onclick = function() {
                    snapshot = {};
                    container.querySelectorAll('[data-key]').forEach(el => {
                        snapshot[el.getAttribute('data-key')] = el.textContent;
                    });
                    setEditable(true);
                };
            }
            if (cancelBtn) {
                cancelBtn.onclick = function() {
                    if (snapshot) {
                        container.querySelectorAll('[data-key]').forEach(el => {
                            const key = el.getAttribute('data-key');
                            if (snapshot[key] !== undefined) el.textContent = snapshot[key];
                        });
                    }
                    setEditable(false);
                };
            }
            if (saveBtn) {
                saveBtn.onclick = function() {
                    const target = allSubmissions.find(sub => {
                        const subCity = sub.cityCounty || sub.submitterName || sub.projectArea || 'Unknown';
                        const subYear = sub.year || sub.fy || 'Unknown';
                        const subProject = sub.projectArea || sub.projectAreaName || 'Unknown';
                        return subCity === city && subYear === year && subProject === (projectArea || 'Unknown');
                    });
                    if (target) {
                        container.querySelectorAll('[data-key]').forEach(el => {
                            const spec = el.getAttribute('data-key');
                            const keys = spec.split('|');
                            const value = el.textContent.trim();
                            for (const k of keys) {
                                if (k) { target[k] = value; break; }
                            }
                        });
                        localStorage.setItem('allSubmissions', JSON.stringify(allSubmissions));
                        showNotification('Changes saved.');
                        setEditable(false);
                    }
                };
            }

            // Per-section edit handlers
            const sectionSnapshots = {};

            function setSectionEditable(section, isEditable) {
                const wrapper = container.querySelector(`.editable-section[data-section="${section}"]`);
                if (!wrapper) return;
                
                // Special handling for budget section - use input fields
                if (section === 'budget') {
                    const budgetDisplays = wrapper.querySelectorAll('.budget-input-display');
                    budgetDisplays.forEach(el => {
                        const key = el.getAttribute('data-key');
                        const isCalculated = el.classList.contains('budget-calculated');
                        // Get current value - could be from span textContent or input value
                        const currentValue = el.tagName === 'INPUT' ? (parseFloat(el.value) || 0) : (parseFloat(el.textContent) || 0);
                        
                        if (isEditable) {
                            // Convert to input field
                            const input = document.createElement('input');
                            input.type = 'number';
                            input.step = '0.01';
                            input.value = currentValue;
                            input.className = 'budget-input';
                            input.setAttribute('data-key', key);
                            input.style.width = '100%';
                            input.style.padding = '4px 8px';
                            input.style.border = '1px solid var(--border-gray)';
                            input.style.borderRadius = '4px';
                            input.style.textAlign = 'right';
                            if (isCalculated) {
                                input.readOnly = true;
                                input.style.background = 'var(--bg-secondary)';
                            }
                            
                            // Add change handlers for calculations
                            if (!isCalculated) {
                                input.addEventListener('input', calculateBudgetTotals);
                            }
                            
                            el.parentNode.replaceChild(input, el);
                        } else {
                            // Convert back to span - get value from input if it exists
                            const inputValue = el.tagName === 'INPUT' ? parseFloat(el.value) || 0 : currentValue;
                            const span = document.createElement('span');
                            span.className = 'budget-input-display';
                            if (isCalculated) span.classList.add('budget-calculated');
                            span.setAttribute('data-key', key);
                            span.textContent = inputValue;
                            el.parentNode.replaceChild(span, el);
                        }
                    });
                    
                    // Handle discount rate separately
                    const discountRateDisplay = wrapper.querySelector('[data-key="discountRate"]');
                    if (discountRateDisplay) {
                        // Get current value - could be from span textContent or input value
                        const currentRate = discountRateDisplay.tagName === 'INPUT' ? (parseFloat(discountRateDisplay.value) || 0) : (parseFloat(discountRateDisplay.textContent) || 0);
                        if (isEditable) {
                            const input = document.createElement('input');
                            input.type = 'number';
                            input.step = '0.01';
                            input.min = '0';
                            input.max = '100';
                            input.value = currentRate;
                            input.className = 'budget-input';
                            input.setAttribute('data-key', 'discountRate');
                            input.style.width = '100px';
                            input.style.padding = '4px 8px';
                            input.style.border = '1px solid var(--border-gray)';
                            input.style.borderRadius = '4px';
                            input.addEventListener('input', updateBudgetDiscountRate);
                            discountRateDisplay.parentNode.replaceChild(input, discountRateDisplay);
                        } else {
                            // Convert back to span - get value from input if it exists
                            const inputValue = discountRateDisplay.tagName === 'INPUT' ? parseFloat(discountRateDisplay.value) || 0 : currentRate;
                            const span = document.createElement('span');
                            span.className = 'budget-input-display';
                            span.setAttribute('data-key', 'discountRate');
                            span.textContent = parseFloat(inputValue).toFixed(2);
                            discountRateDisplay.parentNode.replaceChild(span, discountRateDisplay);
                        }
                    }
                } else {
                    // Standard handling for other sections
                    const spans = wrapper.querySelectorAll('[data-key]');
                    spans.forEach(el => {
                        el.contentEditable = isEditable ? 'true' : 'false';
                        el.style.outline = isEditable ? '1px dashed var(--border-gray)' : '';
                        el.style.background = isEditable ? 'var(--bg-secondary)' : '';
                    });
                }
                
                const edit = container.querySelector(`.section-edit[data-section="${section}"]`);
                const save = container.querySelector(`.section-save[data-section="${section}"]`);
                const cancel = container.querySelector(`.section-cancel[data-section="${section}"]`);
                if (edit) edit.style.display = isEditable ? 'none' : '';
                if (save) save.style.display = isEditable ? '' : 'none';
                if (cancel) cancel.style.display = isEditable ? '' : 'none';
                
                // Special handling for board and staff sections - show/hide add/remove buttons
                if (section === 'board') {
                    const addBtn = container.querySelector('.add-board-row');
                    const removeBtns = container.querySelectorAll('.remove-board-row');
                    if (addBtn) addBtn.style.display = isEditable ? 'inline-block' : 'none';
                    removeBtns.forEach(btn => btn.style.display = isEditable ? 'inline-block' : 'none');
                } else if (section === 'staff') {
                    const addBtn = container.querySelector('.add-staff-row');
                    const removeBtns = container.querySelectorAll('.remove-staff-row');
                    if (addBtn) addBtn.style.display = isEditable ? 'inline-block' : 'none';
                    removeBtns.forEach(btn => btn.style.display = isEditable ? 'inline-block' : 'none');
                }
            }
            
            function calculateBudgetTotals() {
                const wrapper = container.querySelector('.editable-section[data-section="budget"]');
                if (!wrapper) return;
                
                // Get input values
                const propertyTaxIncrementTotal = parseFloat(wrapper.querySelector('[data-key="propertyTaxIncrementTotal"]')?.value || 0);
                const propertyTaxIncrementNpv = parseFloat(wrapper.querySelector('[data-key="propertyTaxIncrementNpv"]')?.value || 0);
                const administrativeFeeTotal = parseFloat(wrapper.querySelector('[data-key="administrativeFeeTotal"]')?.value || 0);
                const administrativeFeeNpv = parseFloat(wrapper.querySelector('[data-key="administrativeFeeNpv"]')?.value || 0);
                const expenseTotal = parseFloat(wrapper.querySelector('[data-key="expenseTotal"]')?.value || 0);
                const expenseNpv = parseFloat(wrapper.querySelector('[data-key="expenseNpv"]')?.value || 0);
                
                // Calculate totals
                const totalRevenueTotal = propertyTaxIncrementTotal;
                const totalRevenueNpv = propertyTaxIncrementNpv;
                const totalUsesOfFundsTotal = administrativeFeeTotal + expenseTotal;
                const totalUsesOfFundsNpv = administrativeFeeNpv + expenseNpv;
                
                // Update calculated fields
                const totalRevenueTotalInput = wrapper.querySelector('[data-key="totalRevenueTotal"]');
                const totalRevenueNpvInput = wrapper.querySelector('[data-key="totalRevenueNpv"]');
                const totalUsesOfFundsTotalInput = wrapper.querySelector('[data-key="totalUsesOfFundsTotal"]');
                const totalUsesOfFundsNpvInput = wrapper.querySelector('[data-key="totalUsesOfFundsNpv"]');
                
                if (totalRevenueTotalInput) totalRevenueTotalInput.value = totalRevenueTotal.toFixed(2);
                if (totalRevenueNpvInput) totalRevenueNpvInput.value = totalRevenueNpv.toFixed(2);
                if (totalUsesOfFundsTotalInput) totalUsesOfFundsTotalInput.value = totalUsesOfFundsTotal.toFixed(2);
                if (totalUsesOfFundsNpvInput) totalUsesOfFundsNpvInput.value = totalUsesOfFundsNpv.toFixed(2);
            }
            
            function updateBudgetDiscountRate() {
                const wrapper = container.querySelector('.editable-section[data-section="budget"]');
                if (!wrapper) return;
                
                const discountRateInput = wrapper.querySelector('[data-key="discountRate"]');
                const discountRate = discountRateInput ? (parseFloat(discountRateInput.value) || 0) : 0;
                
                // Update all discount rate displays
                const displays = [
                    document.getElementById('view-discount-rate-display'),
                    document.getElementById('view-discount-rate-display-revenue'),
                    document.getElementById('view-discount-rate-display-expense')
                ];
                
                displays.forEach(display => {
                    if (display) {
                        display.textContent = discountRate.toFixed(2);
                    }
                });
            }

            container.querySelectorAll('.section-edit').forEach(btn => {
                btn.addEventListener('click', () => {
                    const section = btn.getAttribute('data-section');
                    const wrapper = container.querySelector(`.editable-section[data-section="${section}"]`);
                    const snap = {};
                    wrapper.querySelectorAll('[data-key]').forEach(el => {
                        // For budget section, store numeric values
                        if (section === 'budget') {
                            snap[el.getAttribute('data-key')] = parseFloat(el.textContent) || 0;
                        } else {
                            snap[el.getAttribute('data-key')] = el.textContent;
                        }
                    });
                    sectionSnapshots[section] = snap;
                    setSectionEditable(section, true);
                });
            });

            container.querySelectorAll('.section-cancel').forEach(btn => {
                btn.addEventListener('click', () => {
                    const section = btn.getAttribute('data-section');
                    const wrapper = container.querySelector(`.editable-section[data-section="${section}"]`);
                    const snap = sectionSnapshots[section] || {};
                    wrapper.querySelectorAll('[data-key]').forEach(el => {
                        const key = el.getAttribute('data-key');
                        if (snap[key] !== undefined) {
                            // For budget section inputs, restore value; for other sections, restore textContent
                            if (section === 'budget' && el.tagName === 'INPUT') {
                                el.value = snap[key];
                            } else {
                                el.textContent = snap[key];
                            }
                        }
                    });
                    setSectionEditable(section, false);
                });
            });

            container.querySelectorAll('.section-save').forEach(btn => {
                btn.addEventListener('click', () => {
                    const section = btn.getAttribute('data-section');
                    const wrapper = container.querySelector(`.editable-section[data-section="${section}"]`);
                    const target = allSubmissions.find(sub => {
                        const subCity = sub.cityCounty || sub.submitterName || sub.projectArea || 'Unknown';
                        const subYear = sub.year || sub.fy || 'Unknown';
                        const subProject = sub.projectArea || sub.projectAreaName || 'Unknown';
                        return subCity === city && subYear === year && subProject === (projectArea || 'Unknown');
                    });
                    if (target) {
                        // Special handling for board and staff sections - clear removed entries first
                        if (section === 'board') {
                            // Clear all board fields first
                            for (let i = 0; i < 50; i++) {
                                target[`governingBoardName_${i}`] = '';
                                target[`governingBoardTitle_${i}`] = '';
                            }
                        } else if (section === 'staff') {
                            // Clear all staff fields first
                            for (let i = 0; i < 50; i++) {
                                target[`agencyStaffName_${i}`] = '';
                                target[`agencyStaffTitle_${i}`] = '';
                            }
                        }
                        
                        wrapper.querySelectorAll('[data-key]').forEach(el => {
                            const spec = el.getAttribute('data-key');
                            // For budget section, use value instead of textContent
                            const value = section === 'budget' && el.tagName === 'INPUT' 
                                ? parseFloat(el.value) || 0 
                                : el.textContent.trim();
                            if (spec.includes('.')) {
                                // nested path like expenses.0.title or taxEntities.2.name
                                const parts = spec.split('.');
                                let ref = target;
                                for (let i = 0; i < parts.length - 1; i++) {
                                    const p = parts[i];
                                    if (ref[p] === undefined) ref[p] = isNaN(Number(parts[i+1])) ? {} : [];
                                    ref = ref[p];
                                }
                                ref[parts[parts.length - 1]] = value;
                            } else {
                                const keys = spec.split('|');
                                for (const k of keys) { if (k) { target[k] = value; break; } }
                            }
                        });
                        localStorage.setItem('allSubmissions', JSON.stringify(allSubmissions));
                        showNotification('Section saved.');
                    }
                    setSectionEditable(section, false);
                });
            });
            
            // Add event handlers for governing board add/remove buttons
            container.querySelectorAll('.add-board-row').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tbody = container.querySelector('#governing-board-tbody');
                    if (!tbody) return;
                    
                    // Find the highest index
                    let maxIndex = -1;
                    tbody.querySelectorAll('tr[data-index]').forEach(row => {
                        const index = parseInt(row.getAttribute('data-index')) || 0;
                        if (index > maxIndex) maxIndex = index;
                    });
                    const newIndex = maxIndex + 1;
                    
                    // Create new row
                    const newRow = document.createElement('tr');
                    newRow.setAttribute('data-index', newIndex);
                    newRow.innerHTML = `
                        <td data-key="governingBoardName_${newIndex}" contenteditable="true" style="outline: 1px dashed var(--border-gray); background: var(--bg-secondary);"></td>
                        <td data-key="governingBoardTitle_${newIndex}" contenteditable="true" style="outline: 1px dashed var(--border-gray); background: var(--bg-secondary);"></td>
                        <td><button class="btn btn-danger btn-sm remove-board-row" style="padding:2px 8px; font-size:11px;">Remove</button></td>
                    `;
                    tbody.appendChild(newRow);
                });
            });
            
            container.querySelectorAll('.remove-board-row').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const row = e.target.closest('tr');
                    if (row && confirm('Are you sure you want to remove this board member?')) {
                        row.remove();
                    }
                });
            });
            
            // Add event handlers for agency staff add/remove buttons
            container.querySelectorAll('.add-staff-row').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tbody = container.querySelector('#agency-staff-tbody');
                    if (!tbody) return;
                    
                    // Find the highest index
                    let maxIndex = -1;
                    tbody.querySelectorAll('tr[data-index]').forEach(row => {
                        const index = parseInt(row.getAttribute('data-index')) || 0;
                        if (index > maxIndex) maxIndex = index;
                    });
                    const newIndex = maxIndex + 1;
                    
                    // Create new row
                    const newRow = document.createElement('tr');
                    newRow.setAttribute('data-index', newIndex);
                    newRow.innerHTML = `
                        <td data-key="agencyStaffName_${newIndex}" contenteditable="true" style="outline: 1px dashed var(--border-gray); background: var(--bg-secondary);"></td>
                        <td data-key="agencyStaffTitle_${newIndex}" contenteditable="true" style="outline: 1px dashed var(--border-gray); background: var(--bg-secondary);"></td>
                        <td><button class="btn btn-danger btn-sm remove-staff-row" style="padding:2px 8px; font-size:11px;">Remove</button></td>
                    `;
                    tbody.appendChild(newRow);
                });
            });
            
            container.querySelectorAll('.remove-staff-row').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const row = e.target.closest('tr');
                    if (row && confirm('Are you sure you want to remove this staff member?')) {
                        row.remove();
                    }
                });
            });
        }

        function generateCombinedTaxIncrementBudget(city, year) {
            // Get all submissions for this city and year
            const cityYearSubmissions = allSubmissions.filter(submission => {
                const submissionCity = submission.cityCounty || submission.submitterName;
                const submissionYear = submission.year || submission.fy;
                return submissionCity === city && parseInt(submissionYear) === parseInt(year);
            });

            if (cityYearSubmissions.length === 0) {
                return '<div class="table-container"><p>No data available for this city and year.</p></div>';
            }

            let html = '<div class="table-container">';
            html += '<table class="table" style="margin-bottom: 32px;">';
            
            // Revenue Section Header
            html += '<thead><tr style="background-color: #f8f9fa; font-weight: bold;">';
            html += '<th colspan="5" style="text-align: center; background-color: #e9ecef; color: #000000;">COMBINED TAX REVENUE</th>';
            html += '</tr>';
            html += '<tr><th>Description</th><th>Current Year</th><th>Next Year Projected</th><th>Next Year+1 Projected</th><th>Authorized Amount Remaining</th></tr></thead>';
            html += '<tbody>';

            // Revenue rows - one for each project area
            let totalCurrentYear = 0;
            let totalNextYear = 0;
            let totalNextYearPlus1 = 0;
            let totalAuthorizedRemaining = 0;

            cityYearSubmissions.forEach(submission => {
                const projectArea = submission.projectArea || submission.projectAreaName || 'N/A';
                const fyIncrement = parseFloat(submission.fyIncrement) || 0;
                const authorizedRemaining = parseFloat(submission.remainingAuthorized) || 0;

                totalCurrentYear += fyIncrement;
                totalNextYear += fyIncrement;
                totalNextYearPlus1 += fyIncrement;
                totalAuthorizedRemaining += authorizedRemaining;

                html += `<tr>
                    <td><strong>${projectArea} - Revenue</strong></td>
                    <td>$${fyIncrement.toLocaleString()}</td>
                    <td>$${fyIncrement.toLocaleString()}</td>
                    <td>$${fyIncrement.toLocaleString()}</td>
                    <td>$${authorizedRemaining.toLocaleString()}</td>
                </tr>`;
            });

            // Revenue totals row
            html += `<tr style="background-color: #e9ecef; font-weight: bold;">
                <td><strong>TOTAL REVENUE</strong></td>
                <td><strong>$${totalCurrentYear.toLocaleString()}</strong></td>
                <td><strong>$${totalNextYear.toLocaleString()}</strong></td>
                <td><strong>$${totalNextYearPlus1.toLocaleString()}</strong></td>
                <td><strong>$${totalAuthorizedRemaining.toLocaleString()}</strong></td>
            </tr>`;

            html += '</tbody></table>';

            // Expenses Section
            html += '<table class="table">';
            html += '<thead><tr style="background-color: #f8f9fa; font-weight: bold;">';
            html += '<th colspan="5" style="text-align: center; background-color: #e9ecef; color: #000000;">COMBINED EXPENSES</th>';
            html += '</tr>';
            html += '<tr><th>Description</th><th>Current Year</th><th>Next Year Projected</th><th>Next Year+1 Projected</th><th>Authorized Amount Remaining</th></tr></thead>';
            html += '<tbody>';

            // Collect all unique expense types across all project areas
            const expenseTypes = new Map();
            
            cityYearSubmissions.forEach(submission => {
                if (submission.expenses && submission.expenses.length > 0) {
                    submission.expenses.forEach(expense => {
                        const expenseTitle = expense.title || 'Unnamed Expense';
                        if (!expenseTypes.has(expenseTitle)) {
                            expenseTypes.set(expenseTitle, {
                                tyExpense: 0,
                                cyExpense: 0,
                                nyExpense: 0,
                                authorizedRemaining: 0
                            });
                        }
                        
                        const expenseData = expenseTypes.get(expenseTitle);
                        expenseData.tyExpense += parseFloat(expense.tyExpense) || 0;
                        expenseData.cyExpense += parseFloat(expense.cyExpense) || 0;
                        expenseData.nyExpense += parseFloat(expense.nyExpense) || 0;
                    });
                }
            });

            // Expense rows - one for each expense type
            let totalExpenseCurrentYear = 0;
            let totalExpenseNextYear = 0;
            let totalExpenseNextYearPlus1 = 0;
            let totalExpenseAuthorizedRemaining = 0;

            expenseTypes.forEach((expenseData, expenseTitle) => {
                totalExpenseCurrentYear += expenseData.tyExpense;
                totalExpenseNextYear += expenseData.cyExpense;
                totalExpenseNextYearPlus1 += expenseData.nyExpense;
                totalExpenseAuthorizedRemaining += expenseData.authorizedRemaining;

                html += `<tr>
                    <td><strong>${expenseTitle}</strong></td>
                    <td>$${expenseData.tyExpense.toLocaleString()}</td>
                    <td>$${expenseData.cyExpense.toLocaleString()}</td>
                    <td>$${expenseData.nyExpense.toLocaleString()}</td>
                    <td>$${expenseData.authorizedRemaining.toLocaleString()}</td>
                </tr>`;
            });

            // Expense totals row
            html += `<tr style="background-color: #e9ecef; font-weight: bold;">
                <td><strong>TOTAL EXPENSES</strong></td>
                <td><strong>$${totalExpenseCurrentYear.toLocaleString()}</strong></td>
                <td><strong>$${totalExpenseNextYear.toLocaleString()}</strong></td>
                <td><strong>$${totalExpenseNextYearPlus1.toLocaleString()}</strong></td>
                <td><strong>$${totalExpenseAuthorizedRemaining.toLocaleString()}</strong></td>
            </tr>`;

            html += '</tbody></table></div>';
            return html;
        }

        function generateCombinedAcreageOverview(city, year) {
            // Get all submissions for this city and year
            const cityYearSubmissions = allSubmissions.filter(submission => {
                const submissionCity = submission.cityCounty || submission.submitterName;
                const submissionYear = submission.year || submission.fy;
                return submissionCity === city && parseInt(submissionYear) === parseInt(year);
            });

            if (cityYearSubmissions.length === 0) {
                return '<div class="table-container"><p>No data available for this city and year.</p></div>';
            }

            let html = '<div class="table-container">';
            html += '<table class="table">';
            
            // Table Header
            html += '<thead><tr>';
            html += '<th>Project Area</th>';
            html += '<th>Developed</th>';
            html += '<th>Undeveloped</th>';
            html += '<th>Residential</th>';
            html += '<th>% Residential</th>';
            html += '<th># of Authorized Housing Units</th>';
            html += '</tr></thead>';
            html += '<tbody>';

            // Data rows - one for each project area
            let totalDeveloped = 0;
            let totalUndeveloped = 0;
            let totalResidential = 0;
            let totalHousingUnits = 0;

            cityYearSubmissions.forEach(submission => {
                const projectArea = submission.projectArea || submission.projectAreaName || 'N/A';
                const developed = parseFloat(submission.developedAcreage) || 0;
                const undeveloped = parseFloat(submission.undevelopedAcreage) || 0;
                const residential = parseFloat(submission.residentialAcreage) || 0;
                const percentResidential = parseFloat(submission.percentResidential) || 0;
                const housingUnits = parseFloat(submission.totalAuthorizedHousingUnits) || 0;

                totalDeveloped += developed;
                totalUndeveloped += undeveloped;
                totalResidential += residential;
                totalHousingUnits += housingUnits;

                html += `<tr>
                    <td><strong>${projectArea}</strong></td>
                    <td>${developed.toLocaleString()} acres</td>
                    <td>${undeveloped.toLocaleString()} acres</td>
                    <td>${residential.toLocaleString()} acres</td>
                    <td>${percentResidential.toFixed(1)}%</td>
                    <td>${housingUnits.toLocaleString()}</td>
                </tr>`;
            });

            // Totals row
            html += `<tr style="background-color: #e9ecef; font-weight: bold;">
                <td><strong>TOTAL</strong></td>
                <td><strong>${totalDeveloped.toLocaleString()} acres</strong></td>
                <td><strong>${totalUndeveloped.toLocaleString()} acres</strong></td>
                <td><strong>${totalResidential.toLocaleString()} acres</strong></td>
                <td><strong>${totalResidential > 0 ? ((totalResidential / (totalDeveloped + totalUndeveloped)) * 100).toFixed(1) : 0}%</strong></td>
                <td><strong>${totalHousingUnits.toLocaleString()}</strong></td>
            </tr>`;

            html += '</tbody></table></div>';
            return html;
        }

        function addExpenseRow() {
            const expenseContainer = document.getElementById('expense-container');
            const expenseIndex = expenseContainer.children.length;
            
            const expenseRow = document.createElement('div');
            expenseRow.className = 'expense-row';
            expenseRow.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 12px; align-items: end; margin-bottom: 12px; padding: 16px; background: var(--bg-secondary); border-radius: var(--border-radius); border: 1px solid var(--border-gray);';
            
            const selectedYear = document.getElementById('external-year-select').value || new Date().getFullYear();
            
            expenseRow.innerHTML = `
                <div class="form-row">
                    <label>Expense Title:</label>
                    <input type="text" name="expenseTitle_${expenseIndex}" required>
                </div>
                <div class="form-row">
                    <label id="fy-label-${expenseIndex}">FY (${selectedYear}) Expense:</label>
                    <input type="number" name="tyExpense_${expenseIndex}" step="0.01" required onchange="calculateExpenseTotal(${expenseIndex})">
                </div>
                <div class="form-row">
                    <label id="cy-label-${expenseIndex}">${parseInt(selectedYear) + 1} Expense:</label>
                    <input type="number" name="cyExpense_${expenseIndex}" step="0.01" required onchange="calculateExpenseTotal(${expenseIndex})">
                </div>
                <div class="form-row">
                    <label id="ny-label-${expenseIndex}">${parseInt(selectedYear) + 2} Expense:</label>
                    <input type="number" name="nyExpense_${expenseIndex}" step="0.01" required onchange="calculateExpenseTotal(${expenseIndex})">
                </div>
                <button type="button" class="btn btn-secondary" onclick="removeExpenseRow(this)" style="padding: 6px 12px; font-size: 12px;">Remove</button>
            `;
            
            expenseContainer.appendChild(expenseRow);
            updateTotalExpenses();
        }

        function removeExpenseRow(button) {
            button.closest('.expense-row').remove();
            updateTotalExpenses();
        }

        function addGoverningBoardRow() {
            const container = document.getElementById('governing-board-container');
            const index = container.children.length;
            
            const row = document.createElement('div');
            row.className = 'governing-board-row';
            row.style.cssText = 'display: flex; gap: 16px; margin-bottom: 16px; align-items: end;';
            
            row.innerHTML = `
                <div class="form-row" style="flex: 1;">
                    <label>Name:</label>
                    <input type="text" name="governingBoardName_${index}" placeholder="Board Member Name">
                </div>
                <div class="form-row" style="flex: 1;">
                    <label>Title:</label>
                    <input type="text" name="governingBoardTitle_${index}" placeholder="Board Member Title">
                </div>
                <button type="button" class="btn btn-secondary" onclick="removeGoverningBoardRow(this)" style="padding: 6px 12px; font-size: 12px; margin-bottom: 0;">Remove</button>
            `;
            
            container.appendChild(row);
        }

        function removeGoverningBoardRow(button) {
            const container = document.getElementById('governing-board-container');
            if (container.children.length > 1) {
                button.parentElement.remove();
            }
        }

        function addAgencyStaffRow() {
            const container = document.getElementById('agency-staff-container');
            const index = container.children.length;
            
            const row = document.createElement('div');
            row.className = 'agency-staff-row';
            row.style.cssText = 'display: flex; gap: 16px; margin-bottom: 16px; align-items: end;';
            
            row.innerHTML = `
                <div class="form-row" style="flex: 1;">
                    <label>Name:</label>
                    <input type="text" name="agencyStaffName_${index}" placeholder="Staff Member Name">
                </div>
                <div class="form-row" style="flex: 1;">
                    <label>Title:</label>
                    <input type="text" name="agencyStaffTitle_${index}" placeholder="Staff Member Title">
                </div>
                <button type="button" class="btn btn-secondary" onclick="removeAgencyStaffRow(this)" style="padding: 6px 12px; font-size: 12px; margin-bottom: 0;">Remove</button>
            `;
            
            container.appendChild(row);
        }

        function removeAgencyStaffRow(button) {
            const container = document.getElementById('agency-staff-container');
            if (container.children.length > 1) {
                button.parentElement.remove();
            }
        }

        function addIncrementDistributionRow() {
            const container = document.getElementById('increment-distribution-container');
            const index = container.children.length;
            
            const row = document.createElement('div');
            row.className = 'increment-distribution-row';
            row.style.cssText = 'display: flex; gap: 16px; margin-bottom: 16px; align-items: end;';
            
            row.innerHTML = `
                <div class="form-row" style="flex: 1;">
                    <label>Entity Description:</label>
                    <input type="text" name="incrementEntity_${index}" placeholder="Taxing Entity Name">
                </div>
                <div class="form-row" style="flex: 1;">
                    <label>Actual Received:</label>
                    <input type="number" name="incrementActual_${index}" step="0.01" placeholder="0.00">
                </div>
                <div class="form-row" style="flex: 1;">
                    <label>Amount Remaining Authorized:</label>
                    <input type="number" name="incrementRemaining_${index}" step="0.01" placeholder="0.00">
                </div>
                <button type="button" class="btn btn-secondary" onclick="removeIncrementDistributionRow(this)" style="padding: 6px 12px; font-size: 12px; margin-bottom: 0;">Remove</button>
            `;
            
            container.appendChild(row);
        }

        function removeIncrementDistributionRow(button) {
            const container = document.getElementById('increment-distribution-container');
            if (container.children.length > 1) {
                button.parentElement.remove();
            }
        }

        function addSourcesOfFundsRow() {
            const tbody = document.getElementById('sources-of-funds-tbody');
            const index = tbody.children.length;
            
            const row = document.createElement('tr');
            row.className = 'sources-of-funds-row';
            
            row.innerHTML = `
                <td><input type="text" name="revenueSourceDescription_${index}" placeholder="Enter revenue source description" style="width: 100%; border: none; background: transparent; padding: 8px;"></td>
                <td><input type="number" name="revenueSource2025Actual_${index}" placeholder="0" step="0.01" style="width: 100%; border: none; background: transparent; padding: 8px; text-align: right;"></td>
                <td><input type="number" name="revenueSource2026Forecast_${index}" placeholder="0" step="0.01" style="width: 100%; border: none; background: transparent; padding: 8px; text-align: right;"></td>
                <td><input type="number" name="revenueSource2027Forecast_${index}" placeholder="0" step="0.01" style="width: 100%; border: none; background: transparent; padding: 8px; text-align: right;"></td>
                <td><button type="button" class="btn btn-danger btn-sm" onclick="removeSourcesOfFundsRow(this)" style="padding: 4px 8px; font-size: 12px;">Remove</button></td>
            `;
            
            tbody.appendChild(row);
        }

        function removeSourcesOfFundsRow(button) {
            const tbody = document.getElementById('sources-of-funds-tbody');
            if (tbody.children.length > 1) {
                button.closest('tr').remove();
            }
        }

        function addTaxIncrementSummaryRow() {
            const tbody = document.getElementById('tax-increment-summary-tbody');
            const index = tbody.children.length;
            
            const row = document.createElement('tr');
            row.className = 'tax-increment-summary-row';
            
            const selectedYear = document.getElementById('internal-year-select').value || '2025';
            
            row.innerHTML = `
                <td><input type="text" name="taxIncrementEntity_${index}" placeholder="Enter entity name" style="width: 100%; border: 1px solid var(--border-gray); background: var(--bg-primary); padding: 8px; border-radius: 4px;"></td>
                <td><input type="number" name="taxIncrementYearActual_${index}" placeholder="0" step="0.01" style="width: 100%; border: 1px solid var(--border-gray); background: var(--bg-primary); padding: 8px; text-align: right; border-radius: 4px;"></td>
                <td><input type="number" name="taxIncrementRemainingAuthorized_${index}" placeholder="0" step="0.01" style="width: 100%; border: 1px solid var(--border-gray); background: var(--bg-primary); padding: 8px; text-align: right; border-radius: 4px;"></td>
                <td><button type="button" class="btn btn-danger btn-sm" onclick="removeTaxIncrementSummaryRow(this)" style="padding: 4px 8px; font-size: 12px;">Remove</button></td>
            `;
            
            tbody.appendChild(row);
        }

        function removeTaxIncrementSummaryRow(button) {
            const tbody = document.getElementById('tax-increment-summary-tbody');
            if (tbody.children.length > 1) {
                button.closest('tr').remove();
            }
        }

        function calculateTotalRevenue() {
            const propertyTaxIncrementTotal = parseFloat(document.querySelector('input[name="propertyTaxIncrementTotal"]')?.value || 0);
            const propertyTaxIncrementNpv = parseFloat(document.querySelector('input[name="propertyTaxIncrementNpv"]')?.value || 0);
            
            const totalRevenueTotalInput = document.querySelector('input[name="totalRevenueTotal"]');
            const totalRevenueNpvInput = document.querySelector('input[name="totalRevenueNpv"]');
            
            if (totalRevenueTotalInput) {
                totalRevenueTotalInput.value = propertyTaxIncrementTotal.toFixed(2);
            }
            if (totalRevenueNpvInput) {
                totalRevenueNpvInput.value = propertyTaxIncrementNpv.toFixed(2);
            }
        }

        function calculateTotalUsesOfFunds() {
            const administrativeFeeTotal = parseFloat(document.querySelector('input[name="administrativeFeeTotal"]')?.value || 0);
            const administrativeFeeNpv = parseFloat(document.querySelector('input[name="administrativeFeeNpv"]')?.value || 0);
            const expenseTotal = parseFloat(document.querySelector('input[name="expenseTotal"]')?.value || 0);
            const expenseNpv = parseFloat(document.querySelector('input[name="expenseNpv"]')?.value || 0);
            
            const totalUsesOfFundsTotalInput = document.querySelector('input[name="totalUsesOfFundsTotal"]');
            const totalUsesOfFundsNpvInput = document.querySelector('input[name="totalUsesOfFundsNpv"]');
            
            if (totalUsesOfFundsTotalInput) {
                totalUsesOfFundsTotalInput.value = (administrativeFeeTotal + expenseTotal).toFixed(2);
            }
            if (totalUsesOfFundsNpvInput) {
                totalUsesOfFundsNpvInput.value = (administrativeFeeNpv + expenseNpv).toFixed(2);
            }
        }

        function updateDiscountRateDisplay() {
            const discountRateInput = document.querySelector('input[name="discountRate"]');
            const discountRate = discountRateInput ? (parseFloat(discountRateInput.value) || 0) : 0;
            
            // Update all discount rate displays
            const displays = [
                document.getElementById('discount-rate-display'),
                document.getElementById('discount-rate-display-revenue'),
                document.getElementById('discount-rate-display-expense')
            ];
            
            displays.forEach(display => {
                if (display) {
                    display.textContent = discountRate.toFixed(2);
                }
            });
        }

        function autoFillGoverningBoardAndStaff() {
            const currentYear = document.getElementById('internal-year-select').value;
            const currentClient = document.getElementById('internal-city-dropdown').value;
            
            if (!currentYear || !currentClient) return;
            
            const previousYear = parseInt(currentYear) - 1;
            
            // Find previous year data for this client
            const previousYearData = allSubmissions.filter(submission => {
                const submissionClient = submission.cityCounty || submission.submitterName;
                const submissionYear = submission.year || submission.fy;
                return submissionClient === currentClient && parseInt(submissionYear) === previousYear;
            });
            
            if (previousYearData.length === 0) return;
            
            // Get the most recent submission from previous year
            const latestSubmission = previousYearData[previousYearData.length - 1];
            
            // Auto-fill Governing Board data
            const governingBoardData = [];
            for (let i = 0; i < 10; i++) { // Check up to 10 board members
                const name = latestSubmission[`governingBoardName_${i}`];
                const title = latestSubmission[`governingBoardTitle_${i}`];
                if (name || title) {
                    governingBoardData.push({ name, title });
                }
            }
            
            // Auto-fill Agency Staff data
            const agencyStaffData = [];
            for (let i = 0; i < 10; i++) { // Check up to 10 staff members
                const name = latestSubmission[`agencyStaffName_${i}`];
                const title = latestSubmission[`agencyStaffTitle_${i}`];
                if (name || title) {
                    agencyStaffData.push({ name, title });
                }
            }
            
            // Show prompts if data exists
            if (governingBoardData.length > 0) {
                const confirmed = confirm(`Found ${governingBoardData.length} Governing Board member(s) from ${previousYear}. Has this data changed in the past year? Click OK to keep the data, Cancel to clear.`);
                if (confirmed) {
                    populateGoverningBoardData(governingBoardData);
                }
            }
            
            if (agencyStaffData.length > 0) {
                const confirmed = confirm(`Found ${agencyStaffData.length} Agency Staff member(s) from ${previousYear}. Has this data changed in the past year? Click OK to keep the data, Cancel to clear.`);
                if (confirmed) {
                    populateAgencyStaffData(agencyStaffData);
                }
            }
        }

        function populateGoverningBoardData(data) {
            const container = document.getElementById('governing-board-container');
            container.innerHTML = '';
            
            data.forEach((member, index) => {
                const row = document.createElement('div');
                row.className = 'governing-board-row';
                row.style.cssText = 'display: flex; gap: 16px; margin-bottom: 16px; align-items: end;';
                
                row.innerHTML = `
                    <div class="form-row" style="flex: 1;">
                        <label>Name:</label>
                        <input type="text" name="governingBoardName_${index}" value="${member.name || ''}" placeholder="Board Member Name">
                    </div>
                    <div class="form-row" style="flex: 1;">
                        <label>Title:</label>
                        <input type="text" name="governingBoardTitle_${index}" value="${member.title || ''}" placeholder="Board Member Title">
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="removeGoverningBoardRow(this)" style="padding: 6px 12px; font-size: 12px; margin-bottom: 0;">Remove</button>
                `;
                
                container.appendChild(row);
            });
        }

        function populateAgencyStaffData(data) {
            const container = document.getElementById('agency-staff-container');
            container.innerHTML = '';
            
            data.forEach((member, index) => {
                const row = document.createElement('div');
                row.className = 'agency-staff-row';
                row.style.cssText = 'display: flex; gap: 16px; margin-bottom: 16px; align-items: end;';
                
                row.innerHTML = `
                    <div class="form-row" style="flex: 1;">
                        <label>Name:</label>
                        <input type="text" name="agencyStaffName_${index}" value="${member.name || ''}" placeholder="Staff Member Name">
                    </div>
                    <div class="form-row" style="flex: 1;">
                        <label>Title:</label>
                        <input type="text" name="agencyStaffTitle_${index}" value="${member.title || ''}" placeholder="Staff Member Title">
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="removeAgencyStaffRow(this)" style="padding: 6px 12px; font-size: 12px; margin-bottom: 0;">Remove</button>
                `;
                
                container.appendChild(row);
            });
        }

        function calculateExpenseTotal(index) {
            const tyExpense = parseFloat(document.querySelector(`input[name="tyExpense_${index}"]`)?.value) || 0;
            const cyExpense = parseFloat(document.querySelector(`input[name="cyExpense_${index}"]`)?.value) || 0;
            const nyExpense = parseFloat(document.querySelector(`input[name="nyExpense_${index}"]`)?.value) || 0;
            
            // Update the main total field
            updateTotalExpenses();
        }

        function updateExpenseLabels() {
            const selectedYear = document.getElementById('external-year-select')?.value || document.getElementById('internal-year-select')?.value;
            if (!selectedYear) return;
            
            const nextYear = parseInt(selectedYear) + 1;
            const yearAfter = parseInt(selectedYear) + 2;
            
            const expenseRows = document.querySelectorAll('.expense-row');
            expenseRows.forEach((row, index) => {
                const fyLabel = row.querySelector(`#fy-label-${index}`);
                const cyLabel = row.querySelector(`#cy-label-${index}`);
                const nyLabel = row.querySelector(`#ny-label-${index}`);
                
                if (fyLabel) {
                    fyLabel.textContent = `FY (${selectedYear}) Expense:`;
                }
                if (cyLabel) {
                    cyLabel.textContent = `${nextYear} Expense:`;
                }
                if (nyLabel) {
                    nyLabel.textContent = `${yearAfter} Expense:`;
                }
            });
            
            // Update other FY labels
            const fyActualSpentLabel = document.getElementById('fy-actual-spent-label');
            const fyActualSpentHeader = document.getElementById('fy-actual-spent-header');
            const fyOriginalBudgetLabel = document.getElementById('fy-original-budget-label');
            const fyLifetimeRevenuesLabel = document.getElementById('fy-lifetime-revenues-label');
            const fyActualRevenueLabel = document.getElementById('fy-actual-revenue-label');
            const fyBaseYearRevenueLabel = document.getElementById('fy-base-year-revenue-label');
            const fyValueLabel = document.getElementById('fy-value-label');
            
            if (fyActualSpentLabel) {
                fyActualSpentLabel.textContent = `FY (${selectedYear}) ACTUAL SPENT TOTAL:`;
            }
            if (fyActualSpentHeader) {
                fyActualSpentHeader.textContent = `FY (${selectedYear}) ACTUAL SPENT TOTAL`;
            }
            if (fyOriginalBudgetLabel) {
                fyOriginalBudgetLabel.textContent = `FY (${selectedYear}) ORIGINAL BUDGET REVENUES:`;
            }

            if (fyActualRevenueLabel) {
                fyActualRevenueLabel.textContent = `FY (${selectedYear}) ACTUAL REVENUE:`;
            }
            if (fyBaseYearRevenueLabel) {
                fyBaseYearRevenueLabel.textContent = `FY (${selectedYear}) BASE YEAR REVENUE:`;
            }
            if (fyValueLabel) {
                fyValueLabel.textContent = `FY (${selectedYear}) VALUE:`;
            }
        }

        function populateClientDropdown() {
            const clientDropdown = document.getElementById('internal-city-dropdown');
            if (!clientDropdown) return;
            
            // Get unique clients from external submissions
            const clients = new Set();
            allSubmissions.forEach(submission => {
                const clientName = submission.submitterName || submission.cityCounty;
                if (clientName) {
                    clients.add(clientName);
                }
            });
            
            // Clear existing options except the first one
            clientDropdown.innerHTML = '<option value="">Select Client</option>';
            
            // Add client options
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client;
                option.textContent = client;
                clientDropdown.appendChild(option);
            });
        }

        function populateProjectDropdown() {
            const clientDropdown = document.getElementById('internal-city-dropdown');
            const projectDropdown = document.getElementById('internal-project-dropdown');
            if (!clientDropdown || !projectDropdown) return;
            
            const selectedClient = clientDropdown.value;
            if (!selectedClient) {
                projectDropdown.innerHTML = '<option value="">Select Project Area</option>';
                return;
            }
            
            // Get project areas for the selected client
            const projectAreas = new Set();
            allSubmissions.forEach(submission => {
                const clientName = submission.submitterName || submission.cityCounty;
                const projectArea = submission.projectAreaName || submission.projectArea;
                if (clientName === selectedClient && projectArea) {
                    projectAreas.add(projectArea);
                }
            });
            
            // Clear existing options except the first one
            projectDropdown.innerHTML = '<option value="">Select Project Area</option>';
            
            // Add project area options
            projectAreas.forEach(projectArea => {
                const option = document.createElement('option');
                option.value = projectArea;
                option.textContent = projectArea;
                projectDropdown.appendChild(option);
            });
            
            // Auto-fill Governing Board and Agency Staff data
            setTimeout(() => {
                autoFillGoverningBoardAndStaff();
            }, 100);
            
            // Check if load last year button should be shown
            checkShowLoadLastYearButtonInternal();
        }

        // External form dropdown functions
        async function populateExternalCountyDropdown(preserveSelection = true) {
            const countyDropdown = document.getElementById('external-county-dropdown');
            if (!countyDropdown) return;
            
            const previousValue = preserveSelection ? countyDropdown.value : '';
            const cache = await ensureProjectLocationCache();
            const counties = getCountyOptionsFromCache(cache);
            
            countyDropdown.innerHTML = '<option value="">Select County</option>';
            counties.forEach(county => {
                const option = document.createElement('option');
                option.value = county;
                option.textContent = county;
                countyDropdown.appendChild(option);
            });
            
            const addNewOption = document.createElement('option');
            addNewOption.value = '__ADD_NEW_COUNTY__';
            addNewOption.textContent = '+ Add New County...';
            countyDropdown.appendChild(addNewOption);
            
            if (previousValue && (previousValue === '__ADD_NEW_COUNTY__' || counties.includes(previousValue))) {
                countyDropdown.value = previousValue;
            } else {
                countyDropdown.value = '';
            }
        }
        
        async function handleExternalCountyChange() {
            const countyDropdown = document.getElementById('external-county-dropdown');
            const newCountyContainer = document.getElementById('external-new-county-container');
            const newCountyInput = document.getElementById('external-new-county-input');
            const agencyDropdown = document.getElementById('external-agency-dropdown');
            const projectDropdown = document.getElementById('external-project-dropdown');
            
            if (!countyDropdown) return;
            const selectedCounty = countyDropdown.value;
            
            if (selectedCounty === '__ADD_NEW_COUNTY__') {
                if (newCountyContainer) newCountyContainer.style.display = 'flex';
                if (newCountyInput) {
                    newCountyInput.required = true;
                    newCountyInput.value = '';
                    newCountyInput.focus();
                }
                if (agencyDropdown) {
                    agencyDropdown.innerHTML = '<option value="">Select Agency/Submitter</option>';
                    agencyDropdown.disabled = true;
                }
                if (projectDropdown) {
                    projectDropdown.innerHTML = '<option value="">Select Project Area</option>';
                    projectDropdown.disabled = true;
                }
                checkShowLoadLastYearButton();
                return;
            } else {
                if (newCountyContainer) newCountyContainer.style.display = 'none';
                if (newCountyInput) {
                    newCountyInput.required = false;
                    newCountyInput.value = '';
                }
            }
            
            if (agencyDropdown) agencyDropdown.disabled = false;
            await populateExternalAgencyDropdown();
            checkShowLoadLastYearButton();
        }
        
        async function populateExternalAgencyDropdown(preserveSelection = true) {
            const countyDropdown = document.getElementById('external-county-dropdown');
            const agencyDropdown = document.getElementById('external-agency-dropdown');
            const newAgencyContainer = document.getElementById('external-new-agency-container');
            const newAgencyInput = document.getElementById('external-new-agency-input');
            
            if (!agencyDropdown) return;
            const selectedCounty = countyDropdown?.value || '';
            const previousValue = preserveSelection ? agencyDropdown.value : '';
            
            if (!selectedCounty || selectedCounty === '__ADD_NEW_COUNTY__') {
                agencyDropdown.innerHTML = '<option value="">Select Agency/Submitter</option>';
                agencyDropdown.disabled = true;
                if (newAgencyContainer) newAgencyContainer.style.display = 'none';
                if (newAgencyInput) newAgencyInput.required = false;
                await populateExternalProjectDropdown(false);
                return;
            }
            
            const cache = await ensureProjectLocationCache();
            const agencies = getAgencyOptionsForCounty(selectedCounty, cache);
            
            agencyDropdown.innerHTML = '<option value="">Select Agency/Submitter</option>';
            agencies.forEach(agency => {
                const option = document.createElement('option');
                option.value = agency;
                option.textContent = agency;
                agencyDropdown.appendChild(option);
            });
            
            const addNewOption = document.createElement('option');
            addNewOption.value = '__ADD_NEW_AGENCY__';
            addNewOption.textContent = '+ Add New Agency...';
            agencyDropdown.appendChild(addNewOption);
            agencyDropdown.disabled = false;
            
            if (newAgencyContainer) newAgencyContainer.style.display = 'none';
            if (newAgencyInput) {
                newAgencyInput.required = false;
                newAgencyInput.value = '';
            }
            
            if (previousValue && agencies.includes(previousValue)) {
                agencyDropdown.value = previousValue;
            } else {
                agencyDropdown.value = '';
            }
            
            await populateExternalProjectDropdown();
        }
        
        async function populateExternalProjectDropdown(preserveSelection = true) {
            const countyDropdown = document.getElementById('external-county-dropdown');
            const agencyDropdown = document.getElementById('external-agency-dropdown');
            const projectDropdown = document.getElementById('external-project-dropdown');
            const newProjectContainer = document.getElementById('external-new-project-container');
            const newProjectInput = document.getElementById('external-new-project-input');
            
            if (!projectDropdown) return;
            const selectedCounty = countyDropdown?.value || '';
            const selectedAgency = agencyDropdown?.value || '';
            const previousValue = preserveSelection ? projectDropdown.value : '';
            
            if (!selectedCounty || selectedCounty === '__ADD_NEW_COUNTY__' || !selectedAgency) {
                projectDropdown.innerHTML = '<option value="">Select Project Area</option>';
                projectDropdown.disabled = true;
                if (newProjectContainer) newProjectContainer.style.display = 'none';
                if (newProjectInput) newProjectInput.required = false;
                checkShowLoadLastYearButton();
                return;
            }
            
            if (selectedAgency === '__ADD_NEW_AGENCY__') {
                projectDropdown.innerHTML = '<option value="">Select Project Area</option>';
                const addNewProjectOption = document.createElement('option');
                addNewProjectOption.value = '__ADD_NEW_PROJECT__';
                addNewProjectOption.textContent = '+ Add New Project Area...';
                projectDropdown.appendChild(addNewProjectOption);
                projectDropdown.disabled = false;
                projectDropdown.value = '__ADD_NEW_PROJECT__';
                if (newProjectContainer) newProjectContainer.style.display = 'flex';
                if (newProjectInput) {
                    newProjectInput.required = true;
                    newProjectInput.value = '';
                    newProjectInput.focus();
                }
                projectDropdown.required = false;
                projectDropdown.onchange = function() {
                    if (projectDropdown.value === '__ADD_NEW_PROJECT__') {
                        if (newProjectContainer) newProjectContainer.style.display = 'flex';
                        if (newProjectInput) {
                            newProjectInput.required = true;
                            newProjectInput.value = '';
                            newProjectInput.focus();
                        }
                        projectDropdown.required = false;
                    } else {
                        if (newProjectContainer) newProjectContainer.style.display = 'none';
                        if (newProjectInput) {
                            newProjectInput.required = false;
                            newProjectInput.value = '';
                        }
                        projectDropdown.required = true;
                    }
                    checkShowLoadLastYearButton();
                };
                checkShowLoadLastYearButton();
                return;
            }
            
            const cache = await ensureProjectLocationCache();
            const projects = getProjectOptionsForCountyAgency(selectedCounty, selectedAgency, cache);
            
            projectDropdown.innerHTML = '<option value="">Select Project Area</option>';
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project;
                option.textContent = project;
                projectDropdown.appendChild(option);
            });
            
            const addNewOption = document.createElement('option');
            addNewOption.value = '__ADD_NEW_PROJECT__';
            addNewOption.textContent = '+ Add New Project Area...';
            projectDropdown.appendChild(addNewOption);
            projectDropdown.disabled = false;
            
            if (previousValue && projects.includes(previousValue)) {
                projectDropdown.value = previousValue;
            } else {
                projectDropdown.value = '';
            }
            
            if (newProjectContainer) newProjectContainer.style.display = 'none';
            if (newProjectInput) {
                newProjectInput.required = false;
                newProjectInput.value = '';
            }
            projectDropdown.required = true;
            
            projectDropdown.onchange = function() {
                if (projectDropdown.value === '__ADD_NEW_PROJECT__') {
                    if (newProjectContainer) newProjectContainer.style.display = 'flex';
                    if (newProjectInput) {
                        newProjectInput.required = true;
                        newProjectInput.value = '';
                        newProjectInput.focus();
                    }
                    projectDropdown.required = false;
                } else {
                    if (newProjectContainer) newProjectContainer.style.display = 'none';
                    if (newProjectInput) {
                        newProjectInput.required = false;
                        newProjectInput.value = '';
                    }
                    projectDropdown.required = true;
                }
                checkShowLoadLastYearButton();
            };
            
            checkShowLoadLastYearButton();
        }

        async function initializeExternalLocationDropdowns() {
            await populateExternalCountyDropdown();
            await handleExternalCountyChange();
        }

        function checkShowLoadLastYearButton() {
            const loadBtn = document.getElementById('load-last-year-btn');
            const countyDropdown = document.getElementById('external-county-dropdown');
            const agencyDropdown = document.getElementById('external-agency-dropdown');
            const projectDropdown = document.getElementById('external-project-dropdown');
            const yearSelect = document.getElementById('external-year-select');
            
            if (!loadBtn || !countyDropdown || !agencyDropdown || !projectDropdown || !yearSelect) return;
            
            const selectedCounty = countyDropdown.value;
            const selectedAgency = agencyDropdown.value;
            const selectedProject = projectDropdown.value;
            const selectedYear = yearSelect.value;
            
            if (selectedCounty && selectedCounty !== '__ADD_NEW_COUNTY__' &&
                selectedAgency && selectedAgency !== '__ADD_NEW_AGENCY__' &&
                selectedProject && selectedProject !== '__ADD_NEW_PROJECT__' &&
                selectedYear) {
                loadBtn.style.display = 'block';
            } else {
                loadBtn.style.display = 'none';
            }
        }

        function loadLastYearData() {
            const agencyDropdown = document.getElementById('external-agency-dropdown');
            const projectDropdown = document.getElementById('external-project-dropdown');
            const yearSelect = document.getElementById('external-year-select');
            const countyDropdown = document.getElementById('external-county-dropdown');
            const projectForm = document.getElementById('project-form');
            
            if (!agencyDropdown || !projectDropdown || !yearSelect || !projectForm || !countyDropdown) return;
            
            const selectedCounty = countyDropdown.value;
            const selectedAgency = agencyDropdown.value;
            const selectedProject = projectDropdown.value;
            const selectedYear = parseInt(yearSelect.value);
            
            if (!selectedCounty || selectedCounty === '__ADD_NEW_COUNTY__' ||
                !selectedAgency || selectedAgency === '__ADD_NEW_AGENCY__' ||
                !selectedProject || selectedProject === '__ADD_NEW_PROJECT__' ||
                !selectedYear) {
                showNotification('Please select county, agency, project area, and year first.');
                return;
            }
            
            // Find the most recent submission for this agency and project area
            // Get all submissions for this agency/project, sorted by year (descending)
            const relevantSubmissions = allSubmissions.filter(submission => {
                const agencyName = submission.submitterName || submission.cityCounty;
                const projectArea = submission.projectAreaName || submission.projectArea;
                const submissionCounty = submission.county || submission.countyName || '';
                const submissionYear = parseInt(submission.year || submission.fy || 0);
                
                const countyMatch = submissionCounty ? (submissionCounty === selectedCounty) : true;
                
                return countyMatch &&
                       agencyName === selectedAgency && 
                       projectArea === selectedProject &&
                       submissionYear < selectedYear; // Only previous years
            });
            
            if (relevantSubmissions.length === 0) {
                showNotification('No previous year data found for this project area.');
                return;
            }
            
            // Get the most recent submission (highest year)
            const lastYearSubmission = relevantSubmissions.sort((a, b) => {
                const yearA = parseInt(a.year || a.fy || 0);
                const yearB = parseInt(b.year || b.fy || 0);
                return yearB - yearA;
            })[0];
            
            const lastYear = lastYearSubmission.year || lastYearSubmission.fy;
            
            // Confirm with user
            if (!confirm(`Load data from ${lastYear}? This will fill in the form with last year's data. You can then update what needs to be changed.`)) {
                return;
            }
            
            // Fields to autofill (project area info, development info, etc.)
            const fieldsToAutofill = [
                'acreage', 'creationYear', 'baseYear', 'termLength', 'startYear', 
                'expirationYear', 'baseValue', 'fyIncrement', 'remainingLife',
                'developedAcreage', 'undevelopedAcreage', 'residentialAcreage',
                'percentResidential', 'totalAuthorizedHousingUnits',
                'descriptionGrowthAssessedValue', 'descriptionPlanFurthered',
                'descriptionOtherIssues', 'fundBalance', 'plannedUsesFundBalance'
            ];
            
            // Autofill project area information fields
            fieldsToAutofill.forEach(fieldName => {
                const field = projectForm.querySelector(`[name="${fieldName}"]`);
                if (field && lastYearSubmission[fieldName]) {
                    field.value = lastYearSubmission[fieldName];
                }
            });
            
            // Autofill expense categories (titles only, not amounts)
            // Check both expenses array and individual fields
            const expenseContainer = document.getElementById('expense-container');
            if (expenseContainer) {
                // Clear existing expense rows
                expenseContainer.innerHTML = '';
                
                let expensesToLoad = [];
                
                // First check if expenses are stored as an array
                if (lastYearSubmission.expenses && lastYearSubmission.expenses.length > 0) {
                    expensesToLoad = lastYearSubmission.expenses;
                } else {
                    // Build from individual fields (expenseTitle_0, etc.)
                    for (let i = 0; i < 20; i++) {
                        const expenseTitle = lastYearSubmission[`expenseTitle_${i}`];
                        if (expenseTitle) {
                            expensesToLoad.push({ title: expenseTitle });
                        }
                    }
                }
                
                // Add expense rows from last year
                expensesToLoad.forEach((expense) => {
                    if (expense.title) {
                        addExpenseRow();
                        const expenseRow = expenseContainer.querySelector(`.expense-row:last-child`);
                        if (expenseRow) {
                            // The new row will have index based on expenseContainer.children.length - 1
                            const newIndex = expenseContainer.children.length - 1;
                            const titleInput = expenseRow.querySelector(`input[name="expenseTitle_${newIndex}"]`);
                            if (titleInput) {
                                titleInput.value = expense.title;
                            }
                            // Don't autofill amounts - user should enter new year's amounts
                        }
                    }
                });
                
                // If no expenses, add one default row
                if (expenseContainer.querySelectorAll('.expense-row').length === 0) {
                    addExpenseRow();
                }
            }
            
            // Autofill tax entities (from individual fields taxEntityName_0, etc.)
            const taxEntitiesTbody = document.getElementById('tax-entities-tbody');
            if (taxEntitiesTbody) {
                // Clear existing tax entity rows
                taxEntitiesTbody.innerHTML = '';
                
                // Check for tax entities stored as individual fields
                let hasTaxEntities = false;
                for (let i = 0; i < 20; i++) {
                    const taxEntityName = lastYearSubmission[`taxEntityName_${i}`];
                    if (taxEntityName) {
                        hasTaxEntities = true;
                        addTaxEntityRow();
                        // Get the row that was just added (last child)
                        const taxEntityRow = taxEntitiesTbody.querySelector(`.tax-entity-row:last-child`);
                        if (taxEntityRow) {
                            // The new row will have index based on tbody.children.length - 1
                            const newIndex = taxEntitiesTbody.children.length - 1;
                            const nameInput = taxEntityRow.querySelector(`input[name="taxEntityName_${newIndex}"]`);
                            const participationInput = taxEntityRow.querySelector(`input[name="taxEntityParticipationRate_${newIndex}"]`);
                            const remittanceInput = taxEntityRow.querySelector(`input[name="taxEntityRemittance_${newIndex}"]`);
                            const capInput = taxEntityRow.querySelector(`input[name="taxEntityCapAmount_${newIndex}"]`);
                            const remainingInput = taxEntityRow.querySelector(`input[name="taxEntityRemainingAuthorized_${newIndex}"]`);
                            
                            if (nameInput) nameInput.value = taxEntityName;
                            if (participationInput && lastYearSubmission[`taxEntityParticipationRate_${i}`]) {
                                participationInput.value = lastYearSubmission[`taxEntityParticipationRate_${i}`];
                            }
                            if (remittanceInput && lastYearSubmission[`taxEntityRemittance_${i}`]) {
                                remittanceInput.value = lastYearSubmission[`taxEntityRemittance_${i}`];
                            }
                            if (capInput && lastYearSubmission[`taxEntityCapAmount_${i}`]) {
                                capInput.value = lastYearSubmission[`taxEntityCapAmount_${i}`];
                            }
                            // Don't autofill increment paid (year-specific)
                            if (remainingInput && lastYearSubmission[`taxEntityRemainingAuthorized_${i}`]) {
                                remainingInput.value = lastYearSubmission[`taxEntityRemainingAuthorized_${i}`];
                            }
                        }
                    }
                }
                
                // If no tax entities found, add one default row
                if (!hasTaxEntities) {
                    addTaxEntityRow();
                }
            }
            
            // Autofill revenue sources (titles only, not amounts)
            for (let i = 0; i < 10; i++) {
                const revenueTitle = lastYearSubmission[`revenueSourceTitle_${i}`];
                if (revenueTitle) {
                    const titleField = projectForm.querySelector(`input[name="revenueSourceTitle_${i}"]`);
                    if (titleField) {
                        titleField.value = revenueTitle;
                    }
                    // Don't autofill amounts - user should enter new year's amounts
                }
            }
            
            // Update expense labels to match the selected year
            updateExpenseLabels();
            
            showNotification(`Data loaded from ${lastYear}. Please review and update year-specific information.`);
            
            // Highlight autofilled fields (optional visual feedback)
            fieldsToAutofill.forEach(fieldName => {
                const field = projectForm.querySelector(`[name="${fieldName}"]`);
                if (field && field.value) {
                    field.style.backgroundColor = '#fff3cd'; // Light yellow
                    setTimeout(() => {
                        field.style.backgroundColor = '';
                    }, 3000);
                }
            });
        }

        // Internal form - Load Last Year's Data functions
        function checkShowLoadLastYearButtonInternal() {
            const loadBtn = document.getElementById('load-last-year-internal-btn');
            const clientDropdown = document.getElementById('internal-city-dropdown');
            const projectDropdown = document.getElementById('internal-project-dropdown');
            const fyInput = document.querySelector('#internal-data-request-container select[name="fy"]');
            
            if (!loadBtn || !clientDropdown || !projectDropdown || !fyInput) return;
            
            const selectedClient = clientDropdown.value;
            const selectedProject = projectDropdown.value;
            const selectedFy = fyInput.value;
            
            // Show button if client, project area, and fiscal year are all selected
            if (selectedClient && selectedProject && selectedFy) {
                loadBtn.style.display = 'block';
            } else {
                loadBtn.style.display = 'none';
            }
        }

        function loadLastYearDataInternal() {
            const clientDropdown = document.getElementById('internal-city-dropdown');
            const projectDropdown = document.getElementById('internal-project-dropdown');
            const fyInput = document.querySelector('#internal-data-request-container select[name="fy"]');
            const internalForm = document.querySelector('#internal-data-request-container form');
            
            if (!clientDropdown || !projectDropdown || !fyInput || !internalForm) return;
            
            const selectedClient = clientDropdown.value;
            const selectedProject = projectDropdown.value;
            const selectedFy = parseInt(fyInput.value);
            
            if (!selectedClient || !selectedProject || !selectedFy) {
                showNotification('Please select client, project area, and fiscal year first.');
                return;
            }
            
            // Find the most recent submission for this client and project area
            const relevantSubmissions = allSubmissions.filter(submission => {
                const clientName = submission.submitterName || submission.cityCounty;
                const projectArea = submission.projectAreaName || submission.projectArea;
                const submissionFy = parseInt(submission.fy || submission.year || 0);
                
                return clientName === selectedClient && 
                       projectArea === selectedProject &&
                       submissionFy < selectedFy; // Only previous years
            });
            
            if (relevantSubmissions.length === 0) {
                showNotification('No previous year data found for this project area.');
                return;
            }
            
            // Get the most recent submission (highest year)
            const lastYearSubmission = relevantSubmissions.sort((a, b) => {
                const yearA = parseInt(a.fy || a.year || 0);
                const yearB = parseInt(b.fy || b.year || 0);
                return yearB - yearA;
            })[0];
            
            const lastYear = lastYearSubmission.fy || lastYearSubmission.year;
            
            // Confirm with user
            if (!confirm(`Load data from ${lastYear}? This will fill in the form with last year's data. You can then update what needs to be changed.`)) {
                return;
            }
            
            // Fields to autofill (basic info, not year-specific)
            const fieldsToAutofill = [
                'type', 'purpose', 'taxingDistrict', 'taxRate', 'growthInAssessedValue'
            ];
            
            // Autofill basic information fields
            fieldsToAutofill.forEach(fieldName => {
                const field = internalForm.querySelector(`[name="${fieldName}"]`);
                if (field && lastYearSubmission[fieldName]) {
                    field.value = lastYearSubmission[fieldName];
                }
            });
            
            // Autofill tax entities (names, participation rates, remittance, cap amounts, remaining authorized - but NOT increment paid)
            const taxEntitiesTbody = document.getElementById('tax-entities-tbody');
            if (taxEntitiesTbody) {
                // Clear existing tax entity rows
                taxEntitiesTbody.innerHTML = '';
                
                // Check for tax entities stored as individual fields
                let hasTaxEntities = false;
                for (let i = 0; i < 20; i++) {
                    const taxEntityName = lastYearSubmission[`taxEntityName_${i}`];
                    if (taxEntityName) {
                        hasTaxEntities = true;
                        addTaxEntityRow();
                        // Get the row that was just added (last child)
                        const taxEntityRow = taxEntitiesTbody.querySelector(`.tax-entity-row:last-child`);
                        if (taxEntityRow) {
                            // The new row will have index based on tbody.children.length - 1
                            const newIndex = taxEntitiesTbody.children.length - 1;
                            const nameInput = taxEntityRow.querySelector(`input[name="taxEntityName_${newIndex}"]`);
                            const participationInput = taxEntityRow.querySelector(`input[name="taxEntityParticipationRate_${newIndex}"]`);
                            const remittanceInput = taxEntityRow.querySelector(`input[name="taxEntityRemittance_${newIndex}"]`);
                            const capInput = taxEntityRow.querySelector(`input[name="taxEntityCapAmount_${newIndex}"]`);
                            const remainingInput = taxEntityRow.querySelector(`input[name="taxEntityRemainingAuthorized_${newIndex}"]`);
                            
                            if (nameInput) nameInput.value = taxEntityName;
                            if (participationInput && lastYearSubmission[`taxEntityParticipationRate_${i}`]) {
                                participationInput.value = lastYearSubmission[`taxEntityParticipationRate_${i}`];
                            }
                            if (remittanceInput && lastYearSubmission[`taxEntityRemittance_${i}`]) {
                                remittanceInput.value = lastYearSubmission[`taxEntityRemittance_${i}`];
                            }
                            if (capInput && lastYearSubmission[`taxEntityCapAmount_${i}`]) {
                                capInput.value = lastYearSubmission[`taxEntityCapAmount_${i}`];
                            }
                            // Don't autofill increment paid (year-specific)
                            if (remainingInput && lastYearSubmission[`taxEntityRemainingAuthorized_${i}`]) {
                                remainingInput.value = lastYearSubmission[`taxEntityRemainingAuthorized_${i}`];
                            }
                        }
                    }
                }
                
                // If no tax entities found, add one default row
                if (!hasTaxEntities) {
                    addTaxEntityRow();
                } else {
                    // Update totals after loading tax entities
                    updateTaxEntitiesTotal();
                }
            }
            
            // Autofill sources of funds (descriptions only, not amounts)
            const sourcesOfFundsTbody = document.getElementById('sources-of-funds-tbody');
            if (sourcesOfFundsTbody) {
                // Clear existing rows
                sourcesOfFundsTbody.innerHTML = '';
                
                // Check for revenue sources stored as individual fields
                let hasRevenueSources = false;
                for (let i = 0; i < 20; i++) {
                    const revenueDescription = lastYearSubmission[`revenueSourceDescription_${i}`];
                    if (revenueDescription) {
                        hasRevenueSources = true;
                        addSourcesOfFundsRow();
                        // Get the row that was just added
                        const sourcesRow = sourcesOfFundsTbody.querySelector(`.sources-of-funds-row:last-child`);
                        if (sourcesRow) {
                            const newIndex = sourcesOfFundsTbody.children.length - 1;
                            const descInput = sourcesRow.querySelector(`input[name="revenueSourceDescription_${newIndex}"]`);
                            if (descInput) {
                                descInput.value = revenueDescription;
                            }
                            // Don't autofill amounts - user should enter new year's amounts
                        }
                    }
                }
                
                // If no revenue sources found, keep the default row
                if (!hasRevenueSources && sourcesOfFundsTbody.children.length === 0) {
                    addSourcesOfFundsRow();
                }
            }
            
            // Autofill tax increment summary (entity names and remaining authorized, but NOT year actual)
            const taxIncrementTbody = document.getElementById('tax-increment-summary-tbody');
            if (taxIncrementTbody) {
                // Clear existing rows
                taxIncrementTbody.innerHTML = '';
                
                // Check for tax increment entities stored as individual fields
                let hasTaxIncrement = false;
                for (let i = 0; i < 20; i++) {
                    const taxIncrementEntity = lastYearSubmission[`taxIncrementEntity_${i}`];
                    if (taxIncrementEntity) {
                        hasTaxIncrement = true;
                        addTaxIncrementSummaryRow();
                        // Get the row that was just added
                        const incrementRow = taxIncrementTbody.querySelector(`.tax-increment-summary-row:last-child`);
                        if (incrementRow) {
                            const newIndex = taxIncrementTbody.children.length - 1;
                            const entityInput = incrementRow.querySelector(`input[name="taxIncrementEntity_${newIndex}"]`);
                            const remainingInput = incrementRow.querySelector(`input[name="taxIncrementRemainingAuthorized_${newIndex}"]`);
                            
                            if (entityInput) entityInput.value = taxIncrementEntity;
                            // Don't autofill year actual (year-specific)
                            if (remainingInput && lastYearSubmission[`taxIncrementRemainingAuthorized_${i}`]) {
                                remainingInput.value = lastYearSubmission[`taxIncrementRemainingAuthorized_${i}`];
                            }
                        }
                    }
                }
                
                // If no tax increment entities found, keep the default row
                if (!hasTaxIncrement && taxIncrementTbody.children.length === 0) {
                    addTaxIncrementSummaryRow();
                }
            }
            
            showNotification(`Data loaded from ${lastYear}. Please review and update year-specific information.`);
            
            // Highlight autofilled fields (optional visual feedback)
            fieldsToAutofill.forEach(fieldName => {
                const field = internalForm.querySelector(`[name="${fieldName}"]`);
                if (field && field.value) {
                    field.style.backgroundColor = '#fff3cd'; // Light yellow
                    setTimeout(() => {
                        field.style.backgroundColor = '';
                    }, 3000);
                }
            });
        }

        async function saveNewCounty() {
            const newCountyInput = document.getElementById('external-new-county-input');
            const countyDropdown = document.getElementById('external-county-dropdown');
            const newCountyContainer = document.getElementById('external-new-county-container');
            
            if (!newCountyInput || !countyDropdown) return;
            
            const newCountyName = newCountyInput.value.trim();
            if (!newCountyName) {
                showNotification('Please enter a county name.');
                return;
            }
            
            addCustomCounty(newCountyName);
            await populateExternalCountyDropdown(false);
            countyDropdown.value = newCountyName;
            
            if (newCountyContainer) newCountyContainer.style.display = 'none';
            newCountyInput.value = '';
            newCountyInput.required = false;
            
            await handleExternalCountyChange();
            showNotification('County saved successfully!');
        }
        
        async function saveNewAgency() {
            const newAgencyInput = document.getElementById('external-new-agency-input');
            const agencyDropdown = document.getElementById('external-agency-dropdown');
            const countyDropdown = document.getElementById('external-county-dropdown');
            const newAgencyContainer = document.getElementById('external-new-agency-container');
            
            if (!newAgencyInput || !agencyDropdown || !countyDropdown) return;
            
            const selectedCounty = countyDropdown.value;
            if (!selectedCounty || selectedCounty === '__ADD_NEW_COUNTY__') {
                showNotification('Please select or add a county first.');
                return;
            }
            
            const newAgencyName = newAgencyInput.value.trim();
            if (!newAgencyName) {
                showNotification('Please enter an agency name.');
                return;
            }
            
            const existingOption = Array.from(agencyDropdown.options).find(opt =>
                opt.value === newAgencyName && opt.value !== '__ADD_NEW_AGENCY__'
            );
            if (existingOption) {
                showNotification('This agency already exists.');
                agencyDropdown.value = newAgencyName;
                if (newAgencyContainer) newAgencyContainer.style.display = 'none';
                newAgencyInput.value = '';
                newAgencyInput.required = false;
                populateExternalProjectDropdown();
                return;
            }
            
            addCustomAgency(selectedCounty, newAgencyName);
            await populateExternalAgencyDropdown(false);
            agencyDropdown.value = newAgencyName;
            agencyDropdown.required = true;
            
            if (newAgencyContainer) newAgencyContainer.style.display = 'none';
            newAgencyInput.value = '';
            newAgencyInput.required = false;
            
            await populateExternalProjectDropdown(false);
            showNotification('Agency saved successfully!');
        }
        
        async function saveNewProjectArea() {
            const newProjectInput = document.getElementById('external-new-project-input');
            const projectDropdown = document.getElementById('external-project-dropdown');
            const agencyDropdown = document.getElementById('external-agency-dropdown');
            const countyDropdown = document.getElementById('external-county-dropdown');
            const newProjectContainer = document.getElementById('external-new-project-container');
            
            if (!newProjectInput || !projectDropdown || !agencyDropdown || !countyDropdown) return;
            
            const selectedCounty = countyDropdown.value;
            const selectedAgency = agencyDropdown.value;
            if (!selectedCounty || selectedCounty === '__ADD_NEW_COUNTY__' ||
                !selectedAgency || selectedAgency === '__ADD_NEW_AGENCY__') {
                showNotification('Please select a county and agency first.');
                return;
            }
            
            const newProjectName = newProjectInput.value.trim();
            if (!newProjectName) {
                showNotification('Please enter a project area name.');
                return;
            }
            
            const existingOption = Array.from(projectDropdown.options).find(opt =>
                opt.value === newProjectName && opt.value !== '__ADD_NEW_PROJECT__'
            );
            if (existingOption) {
                showNotification('This project area already exists.');
                projectDropdown.value = newProjectName;
                if (newProjectContainer) newProjectContainer.style.display = 'none';
                newProjectInput.value = '';
                newProjectInput.required = false;
                return;
            }
            
            addCustomProject(selectedCounty, selectedAgency, newProjectName);
            await populateExternalProjectDropdown(false);
            projectDropdown.value = newProjectName;
            projectDropdown.required = true;
            
            if (newProjectContainer) newProjectContainer.style.display = 'none';
            newProjectInput.value = '';
            newProjectInput.required = false;
            
            showNotification('Project area saved successfully!');
        }

        function updateInternalYearLabels() {
            const selectedYear = document.getElementById('internal-year-select').value;
            if (!selectedYear) return;
            
            const fiscalYear = selectedYear;
            const taxYear = parseInt(selectedYear) - 1;
            
            // Update the labels
            const fyLabel = document.getElementById('fy-label');
            const tyLabel = document.getElementById('ty-label');
            
            if (fyLabel) {
                fyLabel.textContent = `Fiscal Year (${fiscalYear}):`;
            }
            if (tyLabel) {
                tyLabel.textContent = `Tax Year (${taxYear}):`;
            }
            
            // Update Tax Increment Summary year label
            const taxIncrementYearLabel = document.getElementById('tax-increment-year-label');
            if (taxIncrementYearLabel) {
                taxIncrementYearLabel.textContent = `${selectedYear} Actual`;
            }
            
            // Update Revenue Information Tax Year label
            const taxYearRevenueLabel = document.getElementById('tax-year-revenue-label');
            if (taxYearRevenueLabel) {
                taxYearRevenueLabel.textContent = `Tax Year ${selectedYear}`;
            }
            
            // Auto-fill the select fields
            const fyInput = document.querySelector('#internal-data-request-container select[name="fy"]');
            const tyInput = document.querySelector('#internal-data-request-container select[name="ty"]');
            
            if (fyInput) {
                fyInput.value = fiscalYear;
            }
            if (tyInput) {
                tyInput.value = taxYear;
            }
        }

        function addTotalExpenseRow() {
            const tbody = document.getElementById('total-expenses-tbody');
            const rowIndex = tbody.children.length;
            
            const row = document.createElement('tr');
            row.className = 'total-expense-row';
            row.innerHTML = `
                <td>
                    <input type="text" name="totalExpenseDescription_${rowIndex}" placeholder="Enter expense description" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;">
                </td>
                <td>
                    <input type="number" name="totalExpenseAmount_${rowIndex}" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTotalUsesOfFunds()">
                </td>
                <td>
                    <input type="number" name="totalExpenseNpv_${rowIndex}" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTotalUsesOfFunds()">
                </td>
                <td style="width: 60px;">
                    <button type="button" class="btn btn-secondary" onclick="removeTotalExpenseRow(this)" style="padding: 4px 8px; font-size: 11px;">Remove</button>
                </td>
            `;
            
            tbody.appendChild(row);
            updateTotalUsesOfFunds();
        }

        function removeTotalExpenseRow(button) {
            button.closest('tr').remove();
            updateTotalUsesOfFunds();
        }

        function updateTotalUsesOfFunds() {
            const totalInput = document.querySelector('input[name="totalUsesOfFunds"]');
            const expenseRows = document.querySelectorAll('.total-expense-row');
            let total = 0;
            
            expenseRows.forEach(row => {
                const amount = parseFloat(row.querySelector('input[name*="totalExpenseAmount_"]')?.value) || 0;
                total += amount;
            });
            
            if (totalInput) {
                totalInput.value = total.toFixed(2);
            }
        }

        function addTotalExpenseNpvRow() {
            const tbody = document.getElementById('total-expenses-npv-tbody');
            const rowIndex = tbody.children.length;
            
            const row = document.createElement('tr');
            row.className = 'total-expense-npv-row';
            row.innerHTML = `
                <td>
                    <input type="text" name="totalExpenseNpvDescription_${rowIndex}" placeholder="Enter expense description" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;">
                </td>
                <td>
                    <input type="number" name="totalExpenseNpvAmount_${rowIndex}" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTotalUsesOfFundsNpv()">
                </td>
                <td style="width: 60px;">
                    <button type="button" class="btn btn-secondary" onclick="removeTotalExpenseNpvRow(this)" style="padding: 4px 8px; font-size: 11px;">Remove</button>
                </td>
            `;
            
            tbody.appendChild(row);
            updateTotalUsesOfFundsNpv();
        }

        function removeTotalExpenseNpvRow(button) {
            button.closest('tr').remove();
            updateTotalUsesOfFundsNpv();
        }

        function updateTotalUsesOfFundsNpv() {
            const totalInput = document.querySelector('input[name="totalUsesOfFundsNpv"]');
            const expenseRows = document.querySelectorAll('.total-expense-npv-row');
            let total = 0;
            
            expenseRows.forEach(row => {
                const amount = parseFloat(row.querySelector('input[name*="totalExpenseNpvAmount_"]')?.value) || 0;
                total += amount;
            });
            
            if (totalInput) {
                totalInput.value = total.toFixed(2);
            }
        }

        function addTaxEntityRow() {
            const tbody = document.getElementById('tax-entities-tbody');
            const rowIndex = tbody.children.length;
            
            const row = document.createElement('tr');
            row.className = 'tax-entity-row';
            row.innerHTML = `
                <td>
                    <input type="text" name="taxEntityName_${rowIndex}" placeholder="Enter tax entity name" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;">
                </td>
                <td>
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                        <select name="taxEntityRateSource_${rowIndex}" class="tax-rate-source-select" style="width: 100%; padding: 6px; border: 1px solid var(--border-gray); border-radius: 4px; font-size: 11px;" onchange="handleTaxRateSourceChange(this, ${rowIndex})">
                            <option value="master">Select from Master Rates</option>
                            <option value="custom">Enter Custom Rate</option>
                        </select>
                        <select name="taxEntityRateMaster_${rowIndex}" class="tax-rate-master-select" style="width: 100%; padding: 6px; border: 1px solid var(--border-gray); border-radius: 4px; font-size: 11px; display: block;" onchange="handleMasterRateSelect(this, ${rowIndex})">
                            <option value="">Loading master rates...</option>
                        </select>
                        <input type="number" name="taxEntityRateCustom_${rowIndex}" step="0.000001" placeholder="0.000000" style="width: 100%; padding: 6px; border: 1px solid var(--border-gray); border-radius: 4px; font-size: 11px; display: none;" onchange="handleCustomRateChange(this, ${rowIndex})">
                        <input type="hidden" name="taxEntityRate_${rowIndex}" value="">
                        <input type="hidden" name="taxEntityRateYear_${rowIndex}" value="">
                    </div>
                </td>
                <td>
                    <input type="number" name="taxEntityParticipationRate_${rowIndex}" step="0.01" min="0" max="100" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTaxEntitiesTotal()">
                </td>
                <td>
                    <input type="number" name="taxEntityRemittance_${rowIndex}" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTaxEntitiesTotal()">
                </td>
                <td>
                    <input type="number" name="taxEntityCapAmount_${rowIndex}" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTaxEntitiesTotal()">
                </td>
                <td>
                    <input type="number" name="taxEntityIncrementPaid_${rowIndex}" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTaxEntitiesTotal()">
                </td>
                <td>
                    <input type="number" name="taxEntityRemainingAuthorized_${rowIndex}" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTaxEntitiesTotal()">
                </td>
                <td style="width: 60px;">
                    <button type="button" class="btn btn-secondary" onclick="removeTaxEntityRow(this)" style="padding: 4px 8px; font-size: 11px;">Remove</button>
                </td>
            `;
            
            tbody.appendChild(row);
            
            // Load master rates for this new row
            loadMasterRatesForRow(rowIndex);
            updateTaxEntitiesTotal();
        }

        function removeTaxEntityRow(button) {
            button.closest('tr').remove();
            updateTaxEntitiesTotal();
        }
        
        // Tax Rate Management Functions
        let masterTaxRates = [];
        let masterRatesLoaded = false;
        const formatMasterRateValue = (value) => (typeof value === 'number' && Number.isFinite(value) ? value.toFixed(6) : 'â€”');
        const formatMasterLabel = (value) => {
            if (value === null || value === undefined) return 'N/A';
            const label = `${value}`.trim();
            return label.length ? label : 'N/A';
        };

        const CUSTOM_LOCATIONS_STORAGE_KEY = 'projectLocationOverrides';
        const createDefaultLocationOverrides = () => ({
            counties: [],
            agenciesByCounty: {},
            projectsByCountyAgency: {}
        });
        let customLocationOverrides;
        try {
            customLocationOverrides = JSON.parse(localStorage.getItem(CUSTOM_LOCATIONS_STORAGE_KEY) || 'null') || createDefaultLocationOverrides();
        } catch (error) {
            customLocationOverrides = createDefaultLocationOverrides();
        }
        let projectLocationCache = null;

        function persistCustomLocationOverrides() {
            try {
                localStorage.setItem(CUSTOM_LOCATIONS_STORAGE_KEY, JSON.stringify(customLocationOverrides));
            } catch (error) {
                console.warn('Unable to persist location overrides:', error);
            }
        }

        function invalidateProjectLocationCache() {
            projectLocationCache = null;
        }

        const normalizeLocationValue = (value) => {
            if (value === null || value === undefined) return '';
            const label = `${value}`.trim();
            if (!label || label.toUpperCase() === 'N/A') return '';
            return label;
        };

        function addLocationToHierarchy(hierarchy, county, agency = null, project = null) {
            const normalizedCounty = normalizeLocationValue(county);
            if (!normalizedCounty) return;
            if (!hierarchy[normalizedCounty]) {
                hierarchy[normalizedCounty] = {};
            }
            if (agency) {
                const normalizedAgency = normalizeLocationValue(agency);
                if (!normalizedAgency) return;
                if (!hierarchy[normalizedCounty][normalizedAgency]) {
                    hierarchy[normalizedCounty][normalizedAgency] = new Set();
                }
                if (project) {
                    const normalizedProject = normalizeLocationValue(project);
                    if (normalizedProject) {
                        hierarchy[normalizedCounty][normalizedAgency].add(normalizedProject);
                    }
                }
            }
        }

        function buildProjectLocationCache() {
            const hierarchy = {};
            masterTaxRates.forEach(rate => {
                addLocationToHierarchy(hierarchy, rate.county, rate.agency, rate.project);
            });
            (customLocationOverrides.counties || []).forEach(county => addLocationToHierarchy(hierarchy, county));
            Object.entries(customLocationOverrides.agenciesByCounty || {}).forEach(([county, agencies]) => {
                (agencies || []).forEach(agency => addLocationToHierarchy(hierarchy, county, agency));
            });
            Object.entries(customLocationOverrides.projectsByCountyAgency || {}).forEach(([key, projects]) => {
                const [county, agency] = key.split('||');
                (projects || []).forEach(project => addLocationToHierarchy(hierarchy, county, agency, project));
            });
            const cache = {};
            Object.entries(hierarchy).forEach(([county, agencies]) => {
                cache[county] = {};
                Object.entries(agencies).forEach(([agency, projectSet]) => {
                    cache[county][agency] = Array.from(projectSet || []).sort((a, b) => a.localeCompare(b));
                });
            });
            return cache;
        }

        async function ensureProjectLocationCache() {
            if (!projectLocationCache) {
                await loadMasterTaxRates();
                projectLocationCache = buildProjectLocationCache();
            }
            return projectLocationCache;
        }

        function getCountyOptionsFromCache(cache) {
            return Object.keys(cache || {}).sort((a, b) => a.localeCompare(b));
        }

        function getAgencyOptionsForCounty(county, cache) {
            if (!county || !cache[county]) return [];
            return Object.keys(cache[county]).sort((a, b) => a.localeCompare(b));
        }

        function getProjectOptionsForCountyAgency(county, agency, cache) {
            if (!county || !agency) return [];
            const agencyMap = cache[county];
            if (!agencyMap || !agencyMap[agency]) return [];
            return (agencyMap[agency] || []).slice();
        }

        function addCustomCounty(county) {
            const normalizedCounty = normalizeLocationValue(county);
            if (!normalizedCounty) return false;
            if (!customLocationOverrides.counties.includes(normalizedCounty)) {
                customLocationOverrides.counties.push(normalizedCounty);
                persistCustomLocationOverrides();
                invalidateProjectLocationCache();
            }
            return true;
        }

        function addCustomAgency(county, agency) {
            const normalizedCounty = normalizeLocationValue(county);
            const normalizedAgency = normalizeLocationValue(agency);
            if (!normalizedCounty || !normalizedAgency) return false;
            if (!customLocationOverrides.agenciesByCounty[normalizedCounty]) {
                customLocationOverrides.agenciesByCounty[normalizedCounty] = [];
            }
            if (!customLocationOverrides.agenciesByCounty[normalizedCounty].includes(normalizedAgency)) {
                customLocationOverrides.agenciesByCounty[normalizedCounty].push(normalizedAgency);
                persistCustomLocationOverrides();
                invalidateProjectLocationCache();
            }
            return true;
        }

        function addCustomProject(county, agency, project) {
            const normalizedCounty = normalizeLocationValue(county);
            const normalizedAgency = normalizeLocationValue(agency);
            const normalizedProject = normalizeLocationValue(project);
            if (!normalizedCounty || !normalizedAgency || !normalizedProject) return false;
            const key = `${normalizedCounty}||${normalizedAgency}`;
            if (!customLocationOverrides.projectsByCountyAgency[key]) {
                customLocationOverrides.projectsByCountyAgency[key] = [];
            }
            if (!customLocationOverrides.projectsByCountyAgency[key].includes(normalizedProject)) {
                customLocationOverrides.projectsByCountyAgency[key].push(normalizedProject);
                persistCustomLocationOverrides();
                invalidateProjectLocationCache();
            }
            return true;
        }

        function ensureOptionExists(dropdown, value, label = null) {
            if (!dropdown || !value) return;
            const exists = Array.from(dropdown.options).some(opt => opt.value === value);
            if (exists) return;
            const option = document.createElement('option');
            option.value = value;
            option.textContent = label || value;
            const addNewOption = Array.from(dropdown.options).find(opt => opt.value && opt.value.startsWith('__ADD_NEW_'));
            if (addNewOption && addNewOption.parentNode === dropdown) {
                dropdown.insertBefore(option, addNewOption);
            } else {
                dropdown.appendChild(option);
            }
        }
        
        async function loadMasterTaxRates() {
            if (masterRatesLoaded) return masterTaxRates;
            
            try {
                const response = await apiClient.getMasterTaxRates();
                if (response && response.rates) {
                    masterTaxRates = response.rates;
                    masterRatesLoaded = true;
                    return masterTaxRates;
                }
            } catch (error) {
                console.error('Error loading master tax rates:', error);
            }
            return [];
        }
        
        async function loadMasterRatesForRow(rowIndex) {
            const masterSelect = document.querySelector(`select[name="taxEntityRateMaster_${rowIndex}"]`);
            if (!masterSelect) return;
            
            // Load master rates if not already loaded
            await loadMasterTaxRates();
            
            // Clear existing options
            masterSelect.innerHTML = '<option value="">Select a rate...</option>';
            
            // Group rates by entity/year/county/agency/project
            const groupedRates = {};
            masterTaxRates.forEach(rate => {
                // Include project in key to handle same entity/year across different projects
                const project = rate.project || 'N/A';
                const county = rate.county || '';
                const agency = rate.agency || '';
                const key = `${rate.entity_name}_${project}_${rate.year}_${county}_${agency}`;
                if (!groupedRates[key]) {
                    groupedRates[key] = rate;
                }
            });
            
            // Add options - show Entity, Project, Year, Rate
            Object.values(groupedRates).forEach(rate => {
                const option = document.createElement('option');
                const project = formatMasterLabel(rate.project);
                const countyLabel = formatMasterLabel(rate.county);
                const agencyLabel = formatMasterLabel(rate.agency);
                const fallbackRate = [rate.real_property_rate, rate.personal_property_rate, rate.centrally_assessed_rate]
                    .find(value => typeof value === 'number' && Number.isFinite(value));
                const primaryRate = Number.isFinite(rate.rate) ? rate.rate : (fallbackRate ?? 0);
                const primaryRateString = Number.isFinite(primaryRate) ? primaryRate.toFixed(6) : '';
                option.value = `${rate.entity_name}|${rate.year}|${primaryRateString}`;
                // Display contextual metadata + individual rates for audit accuracy
                option.textContent = `${rate.entity_name} â€¢ ${project} â€¢ ${rate.year} â€¢ County: ${countyLabel} â€¢ Agency: ${agencyLabel} â€¢ RP ${formatMasterRateValue(rate.real_property_rate)} | PP ${formatMasterRateValue(rate.personal_property_rate)} | CA ${formatMasterRateValue(rate.centrally_assessed_rate)}`;
                option.title = `County: ${countyLabel}
Agency: ${agencyLabel}
Project: ${project}
Year: ${rate.year}
Real Property: ${formatMasterRateValue(rate.real_property_rate)}
Personal Property: ${formatMasterRateValue(rate.personal_property_rate)}
Centrally Assessed: ${formatMasterRateValue(rate.centrally_assessed_rate)}
Primary Rate: ${formatMasterRateValue(primaryRate)}`;
                masterSelect.appendChild(option);
            });
            
            if (masterTaxRates.length === 0) {
                masterSelect.innerHTML = '<option value="">No master rates available. Import rates first.</option>';
            }
        }
        
        function handleTaxRateSourceChange(select, rowIndex) {
            const source = select.value;
            const masterSelect = document.querySelector(`select[name="taxEntityRateMaster_${rowIndex}"]`);
            const customInput = document.querySelector(`input[name="taxEntityRateCustom_${rowIndex}"]`);
            const hiddenRate = document.querySelector(`input[name="taxEntityRate_${rowIndex}"]`);
            const hiddenYear = document.querySelector(`input[name="taxEntityRateYear_${rowIndex}"]`);
            
            if (source === 'master') {
                masterSelect.style.display = 'block';
                customInput.style.display = 'none';
                customInput.value = '';
                // Load rates if not already loaded
                loadMasterRatesForRow(rowIndex);
            } else {
                masterSelect.style.display = 'none';
                customInput.style.display = 'block';
                masterSelect.value = '';
                hiddenRate.value = '';
                hiddenYear.value = '';
            }
        }
        
        function handleMasterRateSelect(select, rowIndex) {
            const value = select.value;
            if (!value) return;
            
            const [entityName, year, rate] = value.split('|');
            const hiddenRate = document.querySelector(`input[name="taxEntityRate_${rowIndex}"]`);
            const hiddenYear = document.querySelector(`input[name="taxEntityRateYear_${rowIndex}"]`);
            
            if (hiddenRate) hiddenRate.value = rate;
            if (hiddenYear) hiddenYear.value = year;
            
            // Auto-fill entity name if empty
            const entityNameInput = document.querySelector(`input[name="taxEntityName_${rowIndex}"]`);
            if (entityNameInput && !entityNameInput.value) {
                entityNameInput.value = entityName;
            }
        }
        
        function handleCustomRateChange(input, rowIndex) {
            const rate = input.value;
            const hiddenRate = document.querySelector(`input[name="taxEntityRate_${rowIndex}"]`);
            const hiddenYear = document.querySelector(`input[name="taxEntityRateYear_${rowIndex}"]`);
            
            if (hiddenRate) hiddenRate.value = rate;
            if (hiddenYear) {
                // Use current year or selected year from form
                const yearSelect = document.getElementById('internal-year-select');
                hiddenYear.value = yearSelect ? yearSelect.value : new Date().getFullYear();
            }
        }
        
        // Load master rates when Internal Form is shown
        document.addEventListener('DOMContentLoaded', async () => {
            // Load master rates on page load
            await loadMasterTaxRates();
            
            // Load rates for existing rows
            const existingRows = document.querySelectorAll('.tax-entity-row');
            existingRows.forEach((row, index) => {
                const nameAttr = row.querySelector('input[name^="taxEntityName_"]')?.name;
                if (nameAttr) {
                    const rowIndex = nameAttr.match(/\d+/)[0];
                    loadMasterRatesForRow(rowIndex);
                }
            });
            
            // Setup Tax Rate Import UI
            setupTaxRateImportUI();
        });
        
        // Tax Rate Import UI Functions
        let selectedTaxRateFile = null;
        
        function setupTaxRateImportUI() {
            const importTypeSelect = document.getElementById('tax-rate-import-type');
            const projectSelectContainer = document.getElementById('tax-rate-project-select-container');
            const projectSelect = document.getElementById('tax-rate-project-select');
            const uploadZone = document.getElementById('tax-rate-upload-zone');
            const fileInput = document.getElementById('tax-rate-file-input');
            const selectedFileDiv = document.getElementById('tax-rate-selected-file');
            const fileNameSpan = document.getElementById('tax-rate-file-name');
            const fileSizeSpan = document.getElementById('tax-rate-file-size');
            const removeFileBtn = document.getElementById('tax-rate-remove-file');
            const importBtn = document.getElementById('tax-rate-import-btn');
            const importStatus = document.getElementById('tax-rate-import-status');
            const refreshBtn = document.getElementById('tax-rate-refresh-btn');
            
            // Method toggle (File Upload vs Scrape)
            const fileMethodBtn = document.getElementById('tax-rate-method-file');
            const scrapeMethodBtn = document.getElementById('tax-rate-method-scrape');
            const fileMethodDiv = document.getElementById('tax-rate-file-method');
            const scrapeMethodDiv = document.getElementById('tax-rate-scrape-method');
            
            if (fileMethodBtn && scrapeMethodBtn) {
                fileMethodBtn.addEventListener('click', () => {
                    fileMethodBtn.classList.add('active');
                    fileMethodBtn.style.background = '#00B0F0';
                    fileMethodBtn.style.color = 'white';
                    scrapeMethodBtn.classList.remove('active');
                    scrapeMethodBtn.style.background = 'var(--bg-secondary)';
                    scrapeMethodBtn.style.color = 'var(--text-secondary)';
                    if (fileMethodDiv) fileMethodDiv.style.display = 'block';
                    if (scrapeMethodDiv) scrapeMethodDiv.style.display = 'none';
                });
                
                scrapeMethodBtn.addEventListener('click', () => {
                    scrapeMethodBtn.classList.add('active');
                    scrapeMethodBtn.style.background = '#00B0F0';
                    scrapeMethodBtn.style.color = 'white';
                    fileMethodBtn.classList.remove('active');
                    fileMethodBtn.style.background = 'var(--bg-secondary)';
                    fileMethodBtn.style.color = 'var(--text-secondary)';
                    if (fileMethodDiv) fileMethodDiv.style.display = 'none';
                    if (scrapeMethodDiv) scrapeMethodDiv.style.display = 'block';
                });
            }
            
            // Scrape method handlers
            const scrapeYear = document.getElementById('tax-rate-scrape-year');
            const scrapeCounty = document.getElementById('tax-rate-scrape-county');
            const scrapeAgency = document.getElementById('tax-rate-scrape-agency');
            const scrapeProject = document.getElementById('tax-rate-scrape-project');
            const scrapeImportType = document.getElementById('tax-rate-scrape-import-type');
            const scrapeProjectContainer = document.getElementById('tax-rate-scrape-project-container');
            const scrapeProjectSelect = document.getElementById('tax-rate-scrape-project-select');
            const scrapeBtn = document.getElementById('tax-rate-scrape-btn');
            const scrapeStatus = document.getElementById('tax-rate-scrape-status');
            const scrapeAllBtn = document.getElementById('tax-rate-scrape-all-btn');
            const scrapeAllStatus = document.getElementById('tax-rate-scrape-all-status');
            
            // Validate scrape form
            function validateScrapeForm() {
                const isValid = scrapeYear?.value && scrapeCounty?.value && scrapeAgency?.value && scrapeProject?.value;
                if (scrapeBtn) {
                    scrapeBtn.disabled = !isValid;
                }
            }
            
            if (scrapeYear) scrapeYear.addEventListener('change', validateScrapeForm);
            if (scrapeCounty) scrapeCounty.addEventListener('input', validateScrapeForm);
            if (scrapeAgency) scrapeAgency.addEventListener('input', validateScrapeForm);
            if (scrapeProject) scrapeProject.addEventListener('input', validateScrapeForm);
            
            // Toggle project select for scrape method
            if (scrapeImportType) {
                scrapeImportType.addEventListener('change', (e) => {
                    const isProject = e.target.value === 'project';
                    if (scrapeProjectContainer) {
                        scrapeProjectContainer.style.display = isProject ? 'block' : 'none';
                    }
                    if (isProject) {
                        loadProjectsForTaxRateImport(scrapeProjectSelect);
                    }
                });
            }
            
            // Scrape button handler
            if (scrapeBtn) {
                scrapeBtn.addEventListener('click', async () => {
                    if (!scrapeYear?.value || !scrapeCounty?.value || !scrapeAgency?.value || !scrapeProject?.value) {
                        showNotification('Please fill in all scrape fields', 'error');
                        return;
                    }
                    
                    const isMaster = scrapeImportType?.value === 'master';
                    const submissionId = isMaster ? null : (scrapeProjectSelect?.value || null);
                    
                    if (!isMaster && !submissionId) {
                        showNotification('Please select a project for project-specific import', 'error');
                        return;
                    }
                    
                    if (scrapeBtn) {
                        scrapeBtn.disabled = true;
                        scrapeBtn.textContent = 'Scraping...';
                    }
                    
                    if (scrapeStatus) {
                        scrapeStatus.style.display = 'block';
                        scrapeStatus.innerHTML = '<p style="color: #666; margin: 0;">Scraping tax rates from Utah website... This may take a minute.</p>';
                    }
                    
                    try {
                        const result = await apiClient.scrapeTaxRates({
                            taxYear: scrapeYear.value,
                            county: scrapeCounty.value,
                            agency: scrapeAgency.value,
                            project: scrapeProject.value,
                            isMaster: isMaster,
                            submissionId: submissionId
                        });
                        
                        if (scrapeStatus) {
                            scrapeStatus.innerHTML = `
                                <div style="padding: 12px; background: #d4edda; border-left: 4px solid #28a745; border-radius: 4px;">
                                    <p style="margin: 0; color: #155724; font-weight: 600;">
                                        âœ“ Successfully scraped and imported ${result.stored} tax rate(s)
                                    </p>
                                </div>
                            `;
                        }
                        
                        showNotification(`Successfully scraped and imported ${result.stored} tax rate(s)`, 'success');
                        
                        // Clear form
                        if (scrapeYear) scrapeYear.value = '';
                        if (scrapeCounty) scrapeCounty.value = '';
                        if (scrapeAgency) scrapeAgency.value = '';
                        if (scrapeProject) scrapeProject.value = '';
                        validateScrapeForm();
                        
                        // Reload master rates display
                        if (isMaster) {
                            loadMasterRatesDisplay();
                            masterRatesLoaded = false;
                            await loadMasterTaxRates();
                        }
                        
                    } catch (error) {
                        console.error('Tax rate scrape error:', error);
                        if (scrapeStatus) {
                            scrapeStatus.innerHTML = `
                                <div style="padding: 12px; background: #f8d7da; border-left: 4px solid #dc3545; border-radius: 4px;">
                                    <p style="margin: 0; color: #721c24;">
                                        âœ— Scraping failed: ${error.message || 'Unknown error'}
                                    </p>
                                </div>
                            `;
                        }
                        showNotification(`Scraping failed: ${error.message || 'Unknown error'}`, 'error');
                    } finally {
                        if (scrapeBtn) {
                            scrapeBtn.disabled = false;
                            scrapeBtn.textContent = 'Scrape Tax Rates';
                        }
                    }
                });
            }
            
            // Bulk scrape all button handler
            if (scrapeAllBtn) {
                scrapeAllBtn.addEventListener('click', async () => {
                    if (!confirm('This will scrape tax rates for ALL counties, agencies, and projects for 2025. This process may take 1-2 hours and will run in the background. Continue?')) {
                        return;
                    }
                    
                    if (scrapeAllBtn) {
                        scrapeAllBtn.disabled = true;
                        scrapeAllBtn.textContent = 'Starting...';
                    }
                    
                    if (scrapeAllStatus) {
                        scrapeAllStatus.style.display = 'block';
                        scrapeAllStatus.innerHTML = '<p style="color: #666; margin: 0;">Starting bulk scrape... This will run in the background.</p>';
                    }
                    
                    try {
                        const result = await apiClient.scrapeAllTaxRates({ taxYear: 2025 });
                        
                        if (scrapeAllStatus) {
                            scrapeAllStatus.innerHTML = `
                                <div style="padding: 12px; background: #d1ecf1; border-left: 4px solid #0c5460; border-radius: 4px;">
                                    <p style="margin: 0; color: #0c5460; font-weight: 600;">
                                        âœ“ Bulk scraping started successfully
                                    </p>
                                    <p style="margin: 8px 0 0 0; color: #0c5460; font-size: 13px;">
                                        The process is running in the background. Check back later to see the imported rates.
                                        This may take 1-2 hours to complete all counties, agencies, and projects.
                                    </p>
                                </div>
                            `;
                        }
                        
                        showNotification('Bulk scraping started. This will run in the background.', 'success');
                        
                    } catch (error) {
                        console.error('Bulk scrape error:', error);
                        if (scrapeAllStatus) {
                            scrapeAllStatus.innerHTML = `
                                <div style="padding: 12px; background: #f8d7da; border-left: 4px solid #dc3545; border-radius: 4px;">
                                    <p style="margin: 0; color: #721c24;">
                                        âœ— Failed to start bulk scraping: ${error.message || 'Unknown error'}
                                    </p>
                                </div>
                            `;
                        }
                        showNotification(`Failed to start bulk scraping: ${error.message || 'Unknown error'}`, 'error');
                    } finally {
                        if (scrapeAllBtn) {
                            scrapeAllBtn.disabled = false;
                            scrapeAllBtn.textContent = 'Scrape All (2025)';
                        }
                    }
                });
            }
            
            // Toggle project select based on import type
            if (importTypeSelect) {
                importTypeSelect.addEventListener('change', (e) => {
                    const isProject = e.target.value === 'project';
                    if (projectSelectContainer) {
                        projectSelectContainer.style.display = isProject ? 'block' : 'none';
                    }
                    if (isProject) {
                        loadProjectsForTaxRateImport();
                    }
                    selectedTaxRateFile = null;
                    updateFileDisplay();
                });
            }
            
            // File upload handling
            if (uploadZone && fileInput) {
                uploadZone.addEventListener('click', () => fileInput.click());
                uploadZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadZone.style.borderColor = '#00B0F0';
                    uploadZone.style.background = '#e7f3ff';
                });
                uploadZone.addEventListener('dragleave', () => {
                    uploadZone.style.borderColor = '#00B0F0';
                    uploadZone.style.background = '#f8f9fa';
                });
                uploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadZone.style.borderColor = '#00B0F0';
                    uploadZone.style.background = '#f8f9fa';
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        handleTaxRateFileSelect(files[0]);
                    }
                });
                
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        handleTaxRateFileSelect(e.target.files[0]);
                    }
                });
            }
            
            // Remove file
            if (removeFileBtn) {
                removeFileBtn.addEventListener('click', () => {
                    selectedTaxRateFile = null;
                    if (fileInput) fileInput.value = '';
                    updateFileDisplay();
                });
            }
            
            // Import button
            if (importBtn) {
                importBtn.addEventListener('click', handleTaxRateImport);
            }
            
            // Refresh master rates
            if (refreshBtn) {
                refreshBtn.addEventListener('click', loadMasterRatesDisplay);
            }
            
            // Load master rates display on page load
            loadMasterRatesDisplay();
            
            function handleTaxRateFileSelect(file) {
                const validTypes = ['.csv', '.xlsx', '.xls'];
                const fileName = file.name.toLowerCase();
                const isValid = validTypes.some(type => fileName.endsWith(type));
                
                if (!isValid) {
                    showNotification('Please select a CSV or Excel file (.csv, .xlsx, .xls)', 'error');
                    return;
                }
                
                selectedTaxRateFile = file;
                updateFileDisplay();
            }
            
            function updateFileDisplay() {
                if (selectedTaxRateFile) {
                    if (selectedFileDiv) selectedFileDiv.style.display = 'block';
                    if (fileNameSpan) fileNameSpan.textContent = selectedTaxRateFile.name;
                    if (fileSizeSpan) {
                        const sizeKB = (selectedTaxRateFile.size / 1024).toFixed(2);
                        fileSizeSpan.textContent = `(${sizeKB} KB)`;
                    }
                    if (importBtn) importBtn.disabled = false;
                } else {
                    if (selectedFileDiv) selectedFileDiv.style.display = 'none';
                    if (importBtn) importBtn.disabled = true;
                }
            }
            
            async function handleTaxRateImport() {
                if (!selectedTaxRateFile) {
                    showNotification('Please select a file to import', 'error');
                    return;
                }
                
                const importType = importTypeSelect?.value || 'master';
                const isMaster = importType === 'master';
                const submissionId = isMaster ? null : (projectSelect?.value || null);
                
                if (!isMaster && !submissionId) {
                    showNotification('Please select a project for project-specific import', 'error');
                    return;
                }
                
                if (importBtn) {
                    importBtn.disabled = true;
                    importBtn.textContent = 'Importing...';
                }
                
                if (importStatus) {
                    importStatus.style.display = 'block';
                    importStatus.innerHTML = '<p style="color: #666; margin: 0;">Importing tax rates...</p>';
                }
                
                try {
                    const result = await apiClient.importTaxRates({
                        file: selectedTaxRateFile,
                        submissionId: submissionId,
                        isMaster: isMaster
                    });
                    
                    if (importStatus) {
                        importStatus.innerHTML = `
                            <div style="padding: 12px; background: #d4edda; border-left: 4px solid #28a745; border-radius: 4px;">
                                <p style="margin: 0; color: #155724; font-weight: 600;">
                                    âœ“ Successfully imported ${result.imported} tax rate(s)
                                </p>
                            </div>
                        `;
                    }
                    
                    showNotification(`Successfully imported ${result.imported} tax rate(s)`, 'success');
                    
                    // Reset form
                    selectedTaxRateFile = null;
                    if (fileInput) fileInput.value = '';
                    updateFileDisplay();
                    
                    // Reload master rates display
                    if (isMaster) {
                        loadMasterRatesDisplay();
                        // Reload master rates for form dropdowns
                        masterRatesLoaded = false;
                        await loadMasterTaxRates();
                    }
                    
                } catch (error) {
                    console.error('Tax rate import error:', error);
                    if (importStatus) {
                        importStatus.innerHTML = `
                            <div style="padding: 12px; background: #f8d7da; border-left: 4px solid #dc3545; border-radius: 4px;">
                                <p style="margin: 0; color: #721c24;">
                                    âœ— Import failed: ${error.message || 'Unknown error'}
                                </p>
                            </div>
                        `;
                    }
                    showNotification(`Import failed: ${error.message || 'Unknown error'}`, 'error');
                } finally {
                    if (importBtn) {
                        importBtn.disabled = false;
                        importBtn.textContent = 'Import Tax Rates';
                    }
                }
            }
            
            async function loadProjectsForTaxRateImport(targetSelect = null) {
                const select = targetSelect || projectSelect;
                if (!select) return;
                
                select.innerHTML = '<option value="">Loading projects...</option>';
                
                try {
                    const response = await apiClient.listSubmissions();
                    const submissions = response.submissions || [];
                    
                    select.innerHTML = '<option value="">Select a project...</option>';
                    
                    submissions.forEach(sub => {
                        const payload = typeof sub.payload_json === 'string' ? JSON.parse(sub.payload_json) : sub.payload_json;
                        const projectName = payload.projectAreaName || payload.projectArea || payload.submitterName || `Project ${sub.id.substring(0, 8)}`;
                        const year = sub.year || 'N/A';
                        const option = document.createElement('option');
                        option.value = sub.id;
                        option.textContent = `${projectName} (${year})`;
                        select.appendChild(option);
                    });
                    
                    if (submissions.length === 0) {
                        select.innerHTML = '<option value="">No projects found</option>';
                    }
                } catch (error) {
                    console.error('Error loading projects:', error);
                    select.innerHTML = '<option value="">Error loading projects</option>';
                }
            }
            
            async function loadMasterRatesDisplay() {
                const container = document.getElementById('tax-rate-master-rates-container');
                if (!container) return;
                
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 24px;">Loading project tax rates...</p>';
                
                try {
                    const response = await apiClient.getMasterTaxRates();
                    const rates = response.rates || [];
                    
                    if (rates.length === 0) {
                        container.innerHTML = `
                            <p style="color: var(--text-secondary); text-align: center; padding: 24px;">
                                No project tax rates available yet. Import or scrape them from the Utah Certified Tax Rates website.
                            </p>
                        `;
                        return;
                    }
                    
                    // Group by project for easier auditing
                    const projectGroupsMap = {};
                    rates.forEach(rate => {
                        const countyLabel = formatMasterLabel(rate.county);
                        const agencyLabel = formatMasterLabel(rate.agency);
                        const projectName = formatMasterLabel(rate.project);
                        const key = `${countyLabel}|${agencyLabel}|${projectName}`;
                        if (!projectGroupsMap[key]) {
                            projectGroupsMap[key] = {
                                county: countyLabel,
                                agency: agencyLabel,
                                project: projectName,
                                rates: []
                            };
                        }
                        projectGroupsMap[key].rates.push(rate);
                    });
                    
                    const projectGroups = Object.values(projectGroupsMap).sort((a, b) => {
                        const countyCompare = a.county.localeCompare(b.county);
                        if (countyCompare !== 0) return countyCompare;
                        const agencyCompare = a.agency.localeCompare(b.agency);
                        if (agencyCompare !== 0) return agencyCompare;
                        return a.project.localeCompare(b.project);
                    });
                    
                    const escapeAttr = value => String(value || '').replace(/"/g, '&quot;');
                    const filterState = {
                        county: '__all__',
                        agency: '__all__',
                        project: '__all__'
                    };
                    
                    const buildFilterOptions = (values, placeholder, selectedValue) => {
                        const options = [`<option value="__all__"${selectedValue === '__all__' ? ' selected' : ''}>${placeholder}</option>`];
                        values.forEach(value => {
                            const selected = value === selectedValue ? ' selected' : '';
                            options.push(`<option value="${value}"${selected}>${value}</option>`);
                        });
                        return options.join('');
                    };
                    
                    const filterControls = `
                        <div class="master-filter-bar">
                            <label class="master-filter">
                                <span>County</span>
                                <select id="master-filter-county"></select>
                                <span class="caret"></span>
                            </label>
                            <label class="master-filter">
                                <span>Agency</span>
                                <select id="master-filter-agency"></select>
                                <span class="caret"></span>
                            </label>
                            <label class="master-filter">
                                <span>Project</span>
                                <select id="master-filter-project"></select>
                                <span class="caret"></span>
                            </label>
                        </div>
                    `;
                    
                    let html = `
                        ${filterControls}
                        <div class="table-container">
                            <table class="table master-rates-table">
                                <thead>
                                    <tr>
                                        <th>Entity Name</th>
                                        <th>Tax Year</th>
                                        <th>Real Property Rate</th>
                                        <th>Personal Property Rate</th>
                                        <th>Centrally Assessed Rate</th>
                                        <th>Primary Rate</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    projectGroups.forEach(group => {
                        html += `
                            <tr class="project-group-header">
                                <td colspan="6">
                                    <div class="project-meta" data-county="${escapeAttr(group.county)}" data-agency="${escapeAttr(group.agency)}" data-project="${escapeAttr(group.project)}">
                                        <span><strong>County:</strong> ${group.county}</span>
                                        <span><strong>Agency:</strong> ${group.agency}</span>
                                        <span><strong>Project:</strong> ${group.project}</span>
                                        <span><strong>Entities:</strong> ${group.rates.length}</span>
                                    </div>
                                </td>
                            </tr>
                        `;
                        
                        group.rates
                            .slice()
                            .sort((a, b) => {
                                if (a.entity_name !== b.entity_name) {
                                    return a.entity_name.localeCompare(b.entity_name);
                                }
                                return b.year - a.year;
                            })
                            .forEach(rate => {
                                html += `
                                    <tr>
                                        <td>${rate.entity_name}</td>
                                        <td class="numeric">${rate.year}</td>
                                        <td class="numeric">${formatMasterRateValue(rate.real_property_rate)}</td>
                                        <td class="numeric">${formatMasterRateValue(rate.personal_property_rate)}</td>
                                        <td class="numeric">${formatMasterRateValue(rate.centrally_assessed_rate)}</td>
                                        <td class="numeric">${formatMasterRateValue(rate.rate)}</td>
                                    </tr>
                                `;
                            });
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                        <p style="margin-top: 16px; color: var(--text-secondary); font-size: 13px; text-align: center;">
                            Total: ${rates.length} rate(s) across ${projectGroups.length} project(s)
                        </p>
                    `;
                    
                    container.innerHTML = html;
                    
                    const countyFilter = document.getElementById('master-filter-county');
                    const agencyFilter = document.getElementById('master-filter-agency');
                    const projectFilter = document.getElementById('master-filter-project');
                    const groupRows = container.querySelectorAll('.project-group-header');

                    const getUniqueValues = items => Array.from(new Set(items)).sort();
                    
                    const getAgencyOptions = (countyValue) => {
                        return getUniqueValues(
                            projectGroups
                                .filter(group => countyValue === '__all__' || group.county === countyValue)
                                .map(group => group.agency)
                        );
                    };
                    
                    const getProjectOptions = (countyValue, agencyValue) => {
                        return getUniqueValues(
                            projectGroups
                                .filter(group => {
                                    const countyMatch = countyValue === '__all__' || group.county === countyValue;
                                    const agencyMatch = agencyValue === '__all__' || group.agency === agencyValue;
                                    return countyMatch && agencyMatch;
                                })
                                .map(group => group.project)
                        );
                    };
                    
                    const renderFilterOptions = () => {
                        const countyOptions = getUniqueValues(projectGroups.map(group => group.county));
                        const agencyOptions = getAgencyOptions(filterState.county);
                        
                        if (filterState.agency !== '__all__' && !agencyOptions.includes(filterState.agency)) {
                            filterState.agency = '__all__';
                        }
                        
                        const projectOptions = getProjectOptions(filterState.county, filterState.agency);
                        if (filterState.project !== '__all__' && !projectOptions.includes(filterState.project)) {
                            filterState.project = '__all__';
                        }
                        
                        countyFilter.innerHTML = buildFilterOptions(countyOptions, 'All Counties', filterState.county);
                        agencyFilter.innerHTML = buildFilterOptions(agencyOptions, 'All Agencies', filterState.agency);
                        projectFilter.innerHTML = buildFilterOptions(projectOptions, 'All Projects', filterState.project);
                    };

                    const filterTable = () => {
                        groupRows.forEach(headerRow => {
                            const meta = headerRow.querySelector('.project-meta');
                            const matches =
                                (filterState.county === '__all__' || meta?.dataset.county === filterState.county) &&
                                (filterState.agency === '__all__' || meta?.dataset.agency === filterState.agency) &&
                                (filterState.project === '__all__' || meta?.dataset.project === filterState.project);

                            let currentRow = headerRow;
                            headerRow.style.display = matches ? '' : 'none';

                            while (currentRow.nextElementSibling && !currentRow.nextElementSibling.classList.contains('project-group-header')) {
                                currentRow = currentRow.nextElementSibling;
                                currentRow.style.display = matches ? '' : 'none';
                            }
                        });
                    };

                    const handleFilterChange = (type, value) => {
                        const normalized = value || '__all__';
                        if (type === 'county') {
                            filterState.county = normalized;
                            filterState.agency = '__all__';
                            filterState.project = '__all__';
                        } else if (type === 'agency') {
                            filterState.agency = normalized;
                            filterState.project = '__all__';
                        } else if (type === 'project') {
                            filterState.project = normalized;
                        }
                        renderFilterOptions();
                        filterTable();
                    };

                    countyFilter?.addEventListener('change', (e) => handleFilterChange('county', e.target.value));
                    agencyFilter?.addEventListener('change', (e) => handleFilterChange('agency', e.target.value));
                    projectFilter?.addEventListener('change', (e) => handleFilterChange('project', e.target.value));

                    renderFilterOptions();
                    filterTable();
                } catch (error) {
                    console.error('Error loading project tax rates:', error);
                    container.innerHTML = `
                        <p style="color: #dc3545; text-align: center; padding: 24px;">
                            Error loading project tax rates: ${error.message || 'Unknown error'}
                        </p>
                    `;
                }
            }
        }

        function updateTaxEntitiesTotal() {
            const taxEntityRows = document.querySelectorAll('.tax-entity-row');
            let totalParticipationRate = 0;
            let totalRemittance = 0;
            let totalCapAmount = 0;
            let totalIncrementPaid = 0;
            let totalRemainingAuthorized = 0;
            
            taxEntityRows.forEach(row => {
                const participationRate = parseFloat(row.querySelector('input[name*="taxEntityParticipationRate_"]')?.value) || 0;
                const remittance = parseFloat(row.querySelector('input[name*="taxEntityRemittance_"]')?.value) || 0;
                const capAmount = parseFloat(row.querySelector('input[name*="taxEntityCapAmount_"]')?.value) || 0;
                const incrementPaid = parseFloat(row.querySelector('input[name*="taxEntityIncrementPaid_"]')?.value) || 0;
                const remainingAuthorized = parseFloat(row.querySelector('input[name*="taxEntityRemainingAuthorized_"]')?.value) || 0;
                
                totalParticipationRate += participationRate;
                totalRemittance += remittance;
                totalCapAmount += capAmount;
                totalIncrementPaid += incrementPaid;
                totalRemainingAuthorized += remainingAuthorized;
            });
            
            // Update the totals fields in real-time
            const totalRemittanceInput = document.querySelector('input[name="totalRemittance"]');
            const totalCapInput = document.querySelector('input[name="totalCap"]');
            const totalActualReceivedInput = document.querySelector('input[name="totalActualReceived"]');
            const totalRemainingAuthorizedInput = document.querySelector('input[name="totalRemainingAuthorized"]');
            
            if (totalRemittanceInput) {
                totalRemittanceInput.value = totalRemittance.toFixed(2);
            }
            if (totalCapInput) {
                totalCapInput.value = totalCapAmount.toFixed(2);
            }
            if (totalActualReceivedInput) {
                totalActualReceivedInput.value = totalIncrementPaid.toFixed(2);
            }
            if (totalRemainingAuthorizedInput) {
                totalRemainingAuthorizedInput.value = totalRemainingAuthorized.toFixed(2);
            }
            
            // Console logging for debugging
            console.log('Total Participation Rate:', totalParticipationRate);
            console.log('Total Remittance:', totalRemittance);
            console.log('Total Cap Amount:', totalCapAmount);
            console.log('Total Increment Paid:', totalIncrementPaid);
            console.log('Total Remaining Authorized:', totalRemainingAuthorized);
        }

        function updateTotalExpenses() {
            const totalInput = document.querySelector('input[name="tyActualSpentTotal"]');
            const expenseRows = document.querySelectorAll('.expense-row');
            let total = 0;
            
            expenseRows.forEach(row => {
                const tyExpense = parseFloat(row.querySelector('input[name*="tyExpense_"]')?.value) || 0;
                
                            // Only sum the FY (Fiscal Year) expenses
            total += tyExpense;
            });
            
            if (totalInput) {
                totalInput.value = total.toFixed(2);
            }
        }

        function calculatePercentResidential() {
            const residentialAcreage = parseFloat(document.querySelector('input[name="residentialAcreage"]')?.value) || 0;
            const totalAcreage = parseFloat(document.querySelector('input[name="acreage"]')?.value) || 0;
            const percentResidentialInput = document.querySelector('input[name="percentResidential"]');
            
            if (percentResidentialInput && totalAcreage > 0) {
                const percentResidential = (residentialAcreage / totalAcreage) * 100;
                percentResidentialInput.value = percentResidential.toFixed(2);
            } else if (percentResidentialInput) {
                percentResidentialInput.value = '0.00';
            }
        }

        function calculateRemainingLife() {
            const expirationYearInput = document.querySelector('input[name="expirationYear"]');
            const remainingLifeInput = document.querySelector('input[name="remainingLife"]');
            
            if (expirationYearInput && remainingLifeInput) {
                const expirationYear = parseInt(expirationYearInput.value) || 0;
                const currentYear = 2025; // Current year
                
                if (expirationYear > 0) {
                    const remainingLife = expirationYear - currentYear;
                    remainingLifeInput.value = remainingLife;
                } else {
                    remainingLifeInput.value = '';
                }
            }
        }

        function calculateAdminPercentage() {
            const adminExpenseInput = document.querySelector('input[name="administrativeExpense"]');
            const totalExpensesInput = document.querySelector('input[name="tyActualSpentTotal"]');
            const adminPercentageInput = document.querySelector('input[name="administrativePercentage"]');
            
            if (adminExpenseInput && totalExpensesInput && adminPercentageInput) {
                const adminExpense = parseFloat(adminExpenseInput.value) || 0;
                const totalExpenses = parseFloat(totalExpensesInput.value) || 0;
                
                if (totalExpenses > 0) {
                    const adminPercentage = (adminExpense / totalExpenses) * 100;
                    adminPercentageInput.value = adminPercentage.toFixed(2);
                } else {
                    adminPercentageInput.value = '0.00';
                }
            }
        }

        function updateYearHeaders() {
            const selectedYear = document.getElementById('internal-year-select')?.value;
            const actualRevenueHeader = document.getElementById('actual-revenue-header');
            
            if (selectedYear && actualRevenueHeader) {
                actualRevenueHeader.textContent = `(${selectedYear}) Increment Paid`;
            }
            
            // Also update external request labels
            updateExpenseLabels();
        }

        function getCombinedRevenueTotal(submissions, period) {
            let total = 0;
            submissions.forEach(submission => {
                const fyIncrement = parseFloat(submission.fyIncrement) || 0;
                const authorizedRemaining = parseFloat(submission.remainingAuthorized) || 0;
                
                switch(period) {
                    case 'current':
                    case 'next':
                    case 'nextPlus1':
                        total += fyIncrement;
                        break;
                    case 'authorized':
                        total += authorizedRemaining;
                        break;
                }
            });
            return total;
        }

        function getCombinedExpensesTotal(submissions, period) {
            let total = 0;
            const expenseTypes = new Map();
            
            // Collect all expenses by type
            submissions.forEach(submission => {
                if (submission.expenses && submission.expenses.length > 0) {
                    submission.expenses.forEach(expense => {
                        const expenseTitle = expense.title || 'Unnamed Expense';
                        if (!expenseTypes.has(expenseTitle)) {
                            expenseTypes.set(expenseTitle, {
                                tyExpense: 0,
                                cyExpense: 0,
                                nyExpense: 0,
                                authorizedRemaining: 0
                            });
                        }
                        
                        const expenseData = expenseTypes.get(expenseTitle);
                        expenseData.tyExpense += parseFloat(expense.tyExpense) || 0;
                        expenseData.cyExpense += parseFloat(expense.cyExpense) || 0;
                        expenseData.nyExpense += parseFloat(expense.nyExpense) || 0;
                    });
                }
            });
            
            // Sum up totals based on period
            expenseTypes.forEach(expenseData => {
                switch(period) {
                    case 'current':
                        total += expenseData.tyExpense;
                        break;
                    case 'next':
                        total += expenseData.cyExpense;
                        break;
                    case 'nextPlus1':
                        total += expenseData.nyExpense;
                        break;
                    case 'authorized':
                        total += expenseData.authorizedRemaining;
                        break;
                }
            });
            
            return total;
        }

        function getCombinedAcreageTotal(submissions, type) {
            let total = 0;
            let totalDeveloped = 0;
            let totalUndeveloped = 0;
            let totalResidential = 0;

            submissions.forEach(submission => {
                const developed = parseFloat(submission.developedAcreage) || 0;
                const undeveloped = parseFloat(submission.undevelopedAcreage) || 0;
                const residential = parseFloat(submission.residentialAcreage) || 0;
                const housingUnits = parseFloat(submission.totalAuthorizedHousingUnits) || 0;

                totalDeveloped += developed;
                totalUndeveloped += undeveloped;
                totalResidential += residential;

                switch(type) {
                    case 'developed':
                        total += developed;
                        break;
                    case 'undeveloped':
                        total += undeveloped;
                        break;
                    case 'residential':
                        total += residential;
                        break;
                    case 'housingUnits':
                        total += housingUnits;
                        break;
                    case 'percentResidential':
                        // This will be calculated after the loop
                        break;
                }
            });

            if (type === 'percentResidential') {
                const totalAcreage = totalDeveloped + totalUndeveloped;
                return totalAcreage > 0 ? ((totalResidential / totalAcreage) * 100).toFixed(1) + '%' : '0%';
            }

            return total;
        }

        // PDF Upload Functions
        let uploadedPDFs = [];

        function handlePDFUpload(event) {
            const files = Array.from(event.target.files);
            handlePDFFiles(files);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            const zone = document.getElementById('pdf-upload-zone');
            zone.style.borderColor = '#00B0F0';
            zone.style.background = '#00B0F0';
            zone.style.transform = 'scale(1.02)';
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            const zone = document.getElementById('pdf-upload-zone');
            zone.style.borderColor = '#00B0F0';
            zone.style.background = '#00B0F0';
            zone.style.transform = 'scale(1)';
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            const zone = document.getElementById('pdf-upload-zone');
            zone.style.borderColor = '#00B0F0';
            zone.style.background = '#00B0F0';
            zone.style.transform = 'scale(1)';
            
            const files = Array.from(e.dataTransfer.files);
            handlePDFFiles(files);
        }

        async function handlePDFFiles(files) {
            const pdfFiles = files.filter(file => file.type === 'application/pdf');
            
            if (pdfFiles.length !== files.length) {
                alert('Only PDF files are allowed. Please select only PDF files.');
                return;
            }
            
            for (const file of pdfFiles) {
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    alert(`File "${file.name}" is too large. Please keep files under 5MB.`);
                    continue;
                }
                
                // Enterprise Build: Upload to server immediately if user is logged in
                if (window.apiClient && window.currentUser) {
                    try {
                        // For now, store in memory - will upload when form is submitted
                        // (We need a submission ID first, which we get after form submission)
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const base64 = e.target.result;
                            uploadedPDFs.push({
                                name: file.name,
                                data: base64,
                                size: file.size,
                                file: file // Keep original file for later upload
                            });
                            updateUploadedMapsList();
                        };
                        reader.readAsDataURL(file);
                    } catch (err) {
                        console.error('Error preparing PDF for upload:', err);
                        alert(`Error preparing "${file.name}" for upload.`);
                    }
                } else {
                    // Fallback: Store in memory only (localStorage mode)
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const base64 = e.target.result;
                        uploadedPDFs.push({
                            name: file.name,
                            data: base64,
                            size: file.size
                        });
                        updateUploadedMapsList();
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        function updateUploadedMapsList() {
            const listContainer = document.getElementById('uploaded-maps-list');
            if (!listContainer) return;
            
            if (uploadedPDFs.length === 0) {
                listContainer.innerHTML = '';
                return;
            }
            
            let html = '<div style="margin-top: 16px;">';
            html += '<h5 style="margin: 0 0 12px 0; color: #333; font-weight: 600; display: flex; align-items: center; gap: 8px;">';
            html += '<span>ðŸ“„</span><span>Uploaded Maps (' + uploadedPDFs.length + ')</span></h5>';
            html += '<div style="display: grid; gap: 8px;">';
            
            uploadedPDFs.forEach((pdf, index) => {
                html += `<div style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    background: #f8f9fa;
                    border: 1px solid #e9ecef;
                    border-radius: 8px;
                    padding: 12px 16px;
                    transition: all 0.2s ease;
                " onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                    <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                        <div style="
                            width: 40px;
                            height: 40px;
                            background: #dc3545;
                            border-radius: 8px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 18px;
                            font-weight: bold;
                        ">PDF</div>
                        <div>
                            <div style="font-weight: 500; color: #333; margin-bottom: 2px;">${pdf.name}</div>
                            <div style="font-size: 12px; color: #666;">${(pdf.size / 1024).toFixed(1)} KB</div>
                        </div>
                    </div>
                    <button type="button" onclick="removePDF(${index})" style="
                        background: #dc3545;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        padding: 6px 12px;
                        font-size: 12px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        display: flex;
                        align-items: center;
                        gap: 4px;
                    " onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                        <span>ðŸ—‘ï¸</span>
                        <span>Remove</span>
                    </button>
                </div>`;
            });
            
            html += '</div></div>';
            listContainer.innerHTML = html;
        }

        function removePDF(index) {
            uploadedPDFs.splice(index, 1);
            updateUploadedMapsList();
        }

        function downloadPDF(filename, base64Data) {
            try {
                // Convert base64 to blob
                const byteCharacters = atob(base64Data.split(',')[1]);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'application/pdf' });
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error downloading PDF:', error);
                alert('Error downloading PDF file.');
            }
        }

        function downloadExcelForClient(clientName) {
            // Get ALL submissions for the client (not just complete ones)
            const clientSubmissions = allSubmissions.filter(submission => {
                const submissionClient = submission.submitterName || submission.cityCounty;
                return submissionClient === clientName;
            });
            
            // Group by project area and year to ensure we get all years
            const groupedSubmissions = {};
            clientSubmissions.forEach(submission => {
                const projectArea = submission.projectArea || submission.projectAreaName || 'N/A';
                const year = submission.year || submission.fy || 'N/A';
                const key = `${projectArea}-${year}`;
                
                if (!groupedSubmissions[key]) {
                    groupedSubmissions[key] = submission;
                } else {
                    // Merge data if we have both external and internal data for same project/year
                    Object.assign(groupedSubmissions[key], submission);
                }
            });
            
            const finalSubmissions = Object.values(groupedSubmissions);
            
            if (finalSubmissions.length === 0) {
                showNotification(`No submissions found for ${clientName}.`);
                return;
            }
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Prepare data for Excel - Include ALL possible fields with blank values
            const excelData = finalSubmissions.map(submission => {
                return {
                    // External Request - Project Area Information
                    'Agency/Submitter Name': submission.submitterName || '',
                    'Project Area Name': submission.projectAreaName || '',
                    'Total Acreage': submission.acreage || '',
                    'Creation Year': submission.creationYear || '',
                    'Base Year': submission.baseYear || '',
                    'Term Length': submission.termLength || '',
                    'Start Year': submission.startYear || '',
                    'Expiration Year': submission.expirationYear || '',
                    'Base Value': submission.baseValue || '',
                    'FY Increment': submission.fyIncrement || '',
                    'Remaining Life': submission.remainingLife || '',
                    
                    // External Request - Assessed Value & Financial Information
                    'Description of Growth in Assessed Value': submission.descriptionGrowthAssessedValue || '',
                    'Fund Balance': submission.fundBalance || '',
                    'Planned Uses for Fund Balance': submission.plannedUsesForFundBalance || '',
                    
                    // External Request - Development Information
                    'Developed Acreage': submission.developedAcreage || '',
                    'Undeveloped Acreage': submission.undevelopedAcreage || '',
                    'Residential Acreage': submission.residentialAcreage || '',
                    '% Residential': submission.percentResidential || '',
                    'Total Authorized Housing Units': submission.totalAuthorizedHousingUnits || '',
                    'Description of Significant Development': submission.descriptionSignificantDevelopment || '',
                    'Description of How Plan Has Been Furthered': submission.descriptionPlanFurthered || '',
                    'Description of Other Issues': submission.descriptionOtherIssues || '',
                    
                    // Internal Request - Basic Information
                    'Client (Agency/Submitter)': submission.cityCounty || '',
                    'Project Area': submission.projectArea || '',
                    'Fiscal Year': submission.fy || '',
                    'Tax Year': submission.ty || '',
                    'Type': submission.type || '',
                    'Purpose': submission.purpose || '',
                    'Total Project Areas': clientSubmissions.length || '',
                    
                    // Governing Board of Trustees
                    'Governing Board Member 1': submission.governingBoardName_0 || '',
                    'Governing Board Title 1': submission.governingBoardTitle_0 || '',
                    'Governing Board Member 2': submission.governingBoardName_1 || '',
                    'Governing Board Title 2': submission.governingBoardTitle_1 || '',
                    'Governing Board Member 3': submission.governingBoardName_2 || '',
                    'Governing Board Title 3': submission.governingBoardTitle_2 || '',
                    'Governing Board Member 4': submission.governingBoardName_3 || '',
                    'Governing Board Title 4': submission.governingBoardTitle_3 || '',
                    'Governing Board Member 5': submission.governingBoardName_4 || '',
                    'Governing Board Title 5': submission.governingBoardTitle_4 || '',
                    
                    // Agency Staff
                    'Agency Staff Member 1': submission.agencyStaffName_0 || '',
                    'Agency Staff Title 1': submission.agencyStaffTitle_0 || '',
                    'Agency Staff Member 2': submission.agencyStaffName_1 || '',
                    'Agency Staff Title 2': submission.agencyStaffTitle_1 || '',
                    'Agency Staff Member 3': submission.agencyStaffName_2 || '',
                    'Agency Staff Title 3': submission.agencyStaffTitle_2 || '',
                    'Agency Staff Member 4': submission.agencyStaffName_3 || '',
                    'Agency Staff Title 4': submission.agencyStaffTitle_3 || '',
                    'Agency Staff Member 5': submission.agencyStaffName_4 || '',
                    'Agency Staff Title 5': submission.agencyStaffTitle_4 || '',
                    
                    // Combined Tax Increment Budget - Revenue
                    'Combined Revenue Current Year': getCombinedRevenueTotal(clientSubmissions, 'current'),
                    'Combined Revenue Next Year': getCombinedRevenueTotal(clientSubmissions, 'next'),
                    'Combined Revenue Next Year+1': getCombinedRevenueTotal(clientSubmissions, 'nextPlus1'),
                    'Combined Revenue Authorized Remaining': getCombinedRevenueTotal(clientSubmissions, 'authorized'),
                    
                    // Combined Tax Increment Budget - Expenses
                    'Combined Expenses Current Year': getCombinedExpensesTotal(clientSubmissions, 'current'),
                    'Combined Expenses Next Year': getCombinedExpensesTotal(clientSubmissions, 'next'),
                    'Combined Expenses Next Year+1': getCombinedExpensesTotal(clientSubmissions, 'nextPlus1'),
                    'Combined Expenses Authorized Remaining': getCombinedExpensesTotal(clientSubmissions, 'authorized'),
                    
                    // Combined Acreage Overview
                    'Combined Total Developed Acres': getCombinedAcreageTotal(clientSubmissions, 'developed'),
                    'Combined Total Undeveloped Acres': getCombinedAcreageTotal(clientSubmissions, 'undeveloped'),
                    'Combined Total Residential Acres': getCombinedAcreageTotal(clientSubmissions, 'residential'),
                    'Combined Total Housing Units': getCombinedAcreageTotal(clientSubmissions, 'housingUnits'),
                    'Combined % Residential': getCombinedAcreageTotal(clientSubmissions, 'percentResidential'),
                    
                    // Increment Distribution
                    'Increment Entity 1': submission.incrementEntity_0 || '',
                    'Increment Actual 1': submission.incrementActual_0 || '',
                    'Increment Remaining 1': submission.incrementRemaining_0 || '',
                    'Increment Entity 2': submission.incrementEntity_1 || '',
                    'Increment Actual 2': submission.incrementActual_1 || '',
                    'Increment Remaining 2': submission.incrementRemaining_1 || '',
                    'Increment Entity 3': submission.incrementEntity_2 || '',
                    'Increment Actual 3': submission.incrementActual_2 || '',
                    'Increment Remaining 3': submission.incrementRemaining_2 || '',
                    'Increment Entity 4': submission.incrementEntity_3 || '',
                    'Increment Actual 4': submission.incrementActual_3 || '',
                    'Increment Remaining 4': submission.incrementRemaining_3 || '',
                    'Increment Entity 5': submission.incrementEntity_4 || '',
                    'Increment Actual 5': submission.incrementActual_4 || '',
                    'Increment Remaining 5': submission.incrementRemaining_4 || '',
                    
                    // 2025 Sources of Funds (Internal data request)
                    'Revenue Source Description 1': submission.revenueSourceDescription_0 || '',
                    'Revenue Source 2025 Actual 1': submission.revenueSource2025Actual_0 || '',
                    'Revenue Source 2026 Forecast 1': submission.revenueSource2026Forecast_0 || '',
                    'Revenue Source 2027 Forecast 1': submission.revenueSource2027Forecast_0 || '',
                    'Revenue Source Description 2': submission.revenueSourceDescription_1 || '',
                    'Revenue Source 2025 Actual 2': submission.revenueSource2025Actual_1 || '',
                    'Revenue Source 2026 Forecast 2': submission.revenueSource2026Forecast_1 || '',
                    'Revenue Source 2027 Forecast 2': submission.revenueSource2027Forecast_1 || '',
                    'Revenue Source Description 3': submission.revenueSourceDescription_2 || '',
                    'Revenue Source 2025 Actual 3': submission.revenueSource2025Actual_2 || '',
                    'Revenue Source 2026 Forecast 3': submission.revenueSource2026Forecast_2 || '',
                    'Revenue Source 2027 Forecast 3': submission.revenueSource2027Forecast_2 || '',
                    'Revenue Source Description 4': submission.revenueSourceDescription_3 || '',
                    'Revenue Source 2025 Actual 4': submission.revenueSource2025Actual_3 || '',
                    'Revenue Source 2026 Forecast 4': submission.revenueSource2026Forecast_3 || '',
                    'Revenue Source 2027 Forecast 4': submission.revenueSource2027Forecast_3 || '',
                    'Revenue Source Description 5': submission.revenueSourceDescription_4 || '',
                    'Revenue Source 2025 Actual 5': submission.revenueSource2025Actual_4 || '',
                    'Revenue Source 2026 Forecast 5': submission.revenueSource2026Forecast_4 || '',
                    'Revenue Source 2027 Forecast 5': submission.revenueSource2027Forecast_4 || '',
                    
                    // Project Area Maps
                    'Project Area Maps': submission.projectAreaMaps ? submission.projectAreaMaps.map(map => map.name).join('; ') : '',
                    'Number of Maps': submission.projectAreaMaps ? submission.projectAreaMaps.length : 0,
                    
                    'Taxing District': submission.taxingDistrict || '',
                    'Tax Rate': submission.taxRate || '',
                    'Total Assessed Value': submission.tyValue || '',
                    'Value Increase': submission.valueIncrease || '',
                    'Description of Project Area': submission.growthInAssessedValue || '',
                    
                    // Internal Request - Tax Entities (All 10 possible entities)
                    'Tax Entity 1': submission.taxEntityName_0 || '',
                    'Participation Rate 1': submission.taxEntityParticipationRate_0 || '',
                    'Remittance 1': submission.taxEntityRemittance_0 || '',
                    'Cap Amount 1': submission.taxEntityCapAmount_0 || '',
                    'Increment Paid 1': submission.taxEntityIncrementPaid_0 || '',
                    'Remaining Authorized 1': submission.taxEntityRemainingAuthorized_0 || '',
                    'Tax Entity 2': submission.taxEntityName_1 || '',
                    'Participation Rate 2': submission.taxEntityParticipationRate_1 || '',
                    'Remittance 2': submission.taxEntityRemittance_1 || '',
                    'Cap Amount 2': submission.taxEntityCapAmount_1 || '',
                    'Increment Paid 2': submission.taxEntityIncrementPaid_1 || '',
                    'Remaining Authorized 2': submission.taxEntityRemainingAuthorized_1 || '',
                    'Tax Entity 3': submission.taxEntityName_2 || '',
                    'Participation Rate 3': submission.taxEntityParticipationRate_2 || '',
                    'Remittance 3': submission.taxEntityRemittance_2 || '',
                    'Cap Amount 3': submission.taxEntityCapAmount_2 || '',
                    'Increment Paid 3': submission.taxEntityIncrementPaid_2 || '',
                    'Remaining Authorized 3': submission.taxEntityRemainingAuthorized_2 || '',
                    'Tax Entity 4': submission.taxEntityName_3 || '',
                    'Participation Rate 4': submission.taxEntityParticipationRate_3 || '',
                    'Remittance 4': submission.taxEntityRemittance_3 || '',
                    'Cap Amount 4': submission.taxEntityCapAmount_3 || '',
                    'Increment Paid 4': submission.taxEntityIncrementPaid_3 || '',
                    'Remaining Authorized 4': submission.taxEntityRemainingAuthorized_3 || '',
                    'Tax Entity 5': submission.taxEntityName_4 || '',
                    'Participation Rate 5': submission.taxEntityParticipationRate_4 || '',
                    'Remittance 5': submission.taxEntityRemittance_4 || '',
                    'Cap Amount 5': submission.taxEntityCapAmount_4 || '',
                    'Increment Paid 5': submission.taxEntityIncrementPaid_4 || '',
                    'Remaining Authorized 5': submission.taxEntityRemainingAuthorized_4 || '',
                    'Tax Entity 6': submission.taxEntityName_5 || '',
                    'Participation Rate 6': submission.taxEntityParticipationRate_5 || '',
                    'Remittance 6': submission.taxEntityRemittance_5 || '',
                    'Cap Amount 6': submission.taxEntityCapAmount_5 || '',
                    'Increment Paid 6': submission.taxEntityIncrementPaid_5 || '',
                    'Remaining Authorized 6': submission.taxEntityRemainingAuthorized_5 || '',
                    'Tax Entity 7': submission.taxEntityName_6 || '',
                    'Participation Rate 7': submission.taxEntityParticipationRate_6 || '',
                    'Remittance 7': submission.taxEntityRemittance_6 || '',
                    'Cap Amount 7': submission.taxEntityCapAmount_6 || '',
                    'Increment Paid 7': submission.taxEntityIncrementPaid_6 || '',
                    'Remaining Authorized 7': submission.taxEntityRemainingAuthorized_6 || '',
                    'Tax Entity 8': submission.taxEntityName_7 || '',
                    'Participation Rate 8': submission.taxEntityParticipationRate_7 || '',
                    'Remittance 8': submission.taxEntityRemittance_7 || '',
                    'Cap Amount 8': submission.taxEntityCapAmount_7 || '',
                    'Increment Paid 8': submission.taxEntityIncrementPaid_7 || '',
                    'Remaining Authorized 8': submission.taxEntityRemainingAuthorized_7 || '',
                    'Tax Entity 9': submission.taxEntityName_8 || '',
                    'Participation Rate 9': submission.taxEntityParticipationRate_8 || '',
                    'Remittance 9': submission.taxEntityRemittance_8 || '',
                    'Cap Amount 9': submission.taxEntityCapAmount_8 || '',
                    'Increment Paid 9': submission.taxEntityIncrementPaid_8 || '',
                    'Remaining Authorized 9': submission.taxEntityRemainingAuthorized_8 || '',
                    'Tax Entity 10': submission.taxEntityName_9 || '',
                    'Participation Rate 10': submission.taxEntityParticipationRate_9 || '',
                    'Remittance 10': submission.taxEntityRemittance_9 || '',
                    'Cap Amount 10': submission.taxEntityCapAmount_9 || '',
                    'Increment Paid 10': submission.taxEntityIncrementPaid_9 || '',
                    'Remaining Authorized 10': submission.taxEntityRemainingAuthorized_9 || '',
                    
                    // Internal Request - Totals
                    'Total Remittance': submission.totalRemittance || '',
                    'Total Cap': submission.totalCap || '',
                    'Total Actual Received': submission.totalActualReceived || '',
                    'Total Remaining Authorized': submission.totalRemainingAuthorized || '',
                    
                    // Internal Request - Revenue Information
                    'FY Original Budget Revenues': submission.tyOriginalBudgetRevenues || '',
                    'Original Budget Lifetime Revenues': submission.lifetimeRevenues || '',
                    'FY Actual Revenue': submission.tyActualRevenue || '',
                    'Lifetime Actual Revenues': submission.lifetimeActualRevenues || '',
                    'FY Base Year Revenue': submission.tyBaseYearRevenue || '',
                    'Lifetime Base Year Revenues': submission.lifetimeBaseYearRevenues || '',
                    
                    // Internal Request - Financial Analysis
                    'Administrative Percentage': submission.administrativePercentage || '',
                    'Discount Rate': submission.discountRate || '',
                    'Aggregate Remaining Revenue': submission.aggregateRemainingRevenue || '',
                    'Discounted Aggregate Remaining Revenue': submission.discountedAggregateRemainingRevenue || '',
                    'Total Aggregate Expense': submission.totalAggregateExpense || '',
                    'Total Aggregate Expense at NPV': submission.totalAggregateExpenseAtNpv || '',
                    
                    // Internal Request - Total Expenses (All 10 possible expenses)
                    'Total Expense Description 1': submission.totalExpenseDescription_0 || '',
                    'Total Expense Amount 1': submission.totalExpenseAmount_0 || '',
                    'Total Expense NPV 1': submission.totalExpenseNpv_0 || '',
                    'Total Expense Description 2': submission.totalExpenseDescription_1 || '',
                    'Total Expense Amount 2': submission.totalExpenseAmount_1 || '',
                    'Total Expense NPV 2': submission.totalExpenseNpv_1 || '',
                    'Total Expense Description 3': submission.totalExpenseDescription_2 || '',
                    'Total Expense Amount 3': submission.totalExpenseAmount_2 || '',
                    'Total Expense NPV 3': submission.totalExpenseNpv_2 || '',
                    'Total Expense Description 4': submission.totalExpenseDescription_3 || '',
                    'Total Expense Amount 4': submission.totalExpenseAmount_3 || '',
                    'Total Expense NPV 4': submission.totalExpenseNpv_3 || '',
                    'Total Expense Description 5': submission.totalExpenseDescription_4 || '',
                    'Total Expense Amount 5': submission.totalExpenseAmount_4 || '',
                    'Total Expense NPV 5': submission.totalExpenseNpv_4 || '',
                    'Total Expense Description 6': submission.totalExpenseDescription_5 || '',
                    'Total Expense Amount 6': submission.totalExpenseAmount_5 || '',
                    'Total Expense NPV 6': submission.totalExpenseNpv_5 || '',
                    'Total Expense Description 7': submission.totalExpenseDescription_6 || '',
                    'Total Expense Amount 7': submission.totalExpenseAmount_6 || '',
                    'Total Expense NPV 7': submission.totalExpenseNpv_6 || '',
                    'Total Expense Description 8': submission.totalExpenseDescription_7 || '',
                    'Total Expense Amount 8': submission.totalExpenseAmount_7 || '',
                    'Total Expense NPV 8': submission.totalExpenseNpv_7 || '',
                    'Total Expense Description 9': submission.totalExpenseDescription_8 || '',
                    'Total Expense Amount 9': submission.totalExpenseAmount_8 || '',
                    'Total Expense NPV 9': submission.totalExpenseNpv_8 || '',
                    'Total Expense Description 10': submission.totalExpenseDescription_9 || '',
                    'Total Expense Amount 10': submission.totalExpenseAmount_9 || '',
                    'Total Expense NPV 10': submission.totalExpenseNpv_9 || '',
                    
                    // External Request - Expenses (All 10 possible expenses)
                    'Expense Title 1': submission.expenseTitle_0 || '',
                    'FY Expense 1': submission.tyExpense_0 || '',
                    '2025 Expense 1': submission.cyExpense_0 || '',
                    '2026 Expense 1': submission.nyExpense_0 || '',
                    'Expense Title 2': submission.expenseTitle_1 || '',
                    'FY Expense 2': submission.tyExpense_1 || '',
                    '2025 Expense 2': submission.cyExpense_1 || '',
                    '2026 Expense 2': submission.nyExpense_1 || '',
                    'Expense Title 3': submission.expenseTitle_2 || '',
                    'FY Expense 3': submission.tyExpense_2 || '',
                    '2025 Expense 3': submission.cyExpense_2 || '',
                    '2026 Expense 3': submission.nyExpense_2 || '',
                    'Expense Title 4': submission.expenseTitle_3 || '',
                    'FY Expense 4': submission.tyExpense_3 || '',
                    '2025 Expense 4': submission.cyExpense_3 || '',
                    '2026 Expense 4': submission.nyExpense_3 || '',
                    'Expense Title 5': submission.expenseTitle_4 || '',
                    'FY Expense 5': submission.tyExpense_4 || '',
                    '2025 Expense 5': submission.cyExpense_4 || '',
                    '2026 Expense 5': submission.nyExpense_4 || '',
                    'Expense Title 6': submission.expenseTitle_5 || '',
                    'FY Expense 6': submission.tyExpense_5 || '',
                    '2025 Expense 6': submission.cyExpense_5 || '',
                    '2026 Expense 6': submission.nyExpense_5 || '',
                    'Expense Title 7': submission.expenseTitle_6 || '',
                    'FY Expense 7': submission.tyExpense_6 || '',
                    '2025 Expense 7': submission.cyExpense_6 || '',
                    '2026 Expense 7': submission.nyExpense_6 || '',
                    'Expense Title 8': submission.expenseTitle_7 || '',
                    'FY Expense 8': submission.tyExpense_7 || '',
                    '2025 Expense 8': submission.cyExpense_7 || '',
                    '2026 Expense 8': submission.nyExpense_7 || '',
                    'Expense Title 9': submission.expenseTitle_8 || '',
                    'FY Expense 9': submission.tyExpense_8 || '',
                    '2025 Expense 9': submission.cyExpense_8 || '',
                    '2026 Expense 9': submission.nyExpense_8 || '',
                    'Expense Title 10': submission.expenseTitle_9 || '',
                    'FY Expense 10': submission.tyExpense_9 || '',
                    '2025 Expense 10': submission.cyExpense_9 || '',
                    '2026 Expense 10': submission.nyExpense_9 || '',
                    
                    // Metadata
                    'Timestamp': submission.timestamp || '',
                    'Submission Type': submission.submitterName ? 'External' : 'Internal'
                };
            });
            
            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, `${clientName} Data`);
            
            // Generate Excel file
            XLSX.writeFile(wb, `${clientName}_LRB_Compliance_Data_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            showNotification(`Excel file downloaded successfully for ${clientName}!`);
        }

        function generatePDFReport(city, year) {
            try {
                // Get selected project IDs if they were set via the modal
                const selectedProjectIds = window._selectedProjectIdsForReport || null;
                if (selectedProjectIds) {
                    delete window._selectedProjectIdsForReport; // Clear after use
                }
                
                console.log('Starting PDFMake generation for:', city, year, selectedProjectIds ? `with ${selectedProjectIds.length} selected projects` : '');
                
                // Wait for PDFMake and fonts to load if they're not available yet
                const waitForPDFMake = (attempts = 0) => {
                    if (typeof pdfMake !== 'undefined' && typeof pdfMake.vfs !== 'undefined') {
                        console.log('PDFMake and fonts are available, proceeding with generation');
                        generatePDFReportInternal(city, year, selectedProjectIds);
                    } else if (attempts < 20) {
                        console.log(`Waiting for PDFMake and fonts... attempt ${attempts + 1}`);
                        setTimeout(() => waitForPDFMake(attempts + 1), 500);
                    } else {
                        console.error('PDFMake library or fonts not loaded after waiting');
                        console.log('pdfMake available:', typeof pdfMake !== 'undefined');
                        console.log('pdfMake.vfs available:', typeof pdfMake !== 'undefined' && typeof pdfMake.vfs !== 'undefined');
                        showNotification('PDF library or fonts not loaded. Please refresh the page and try again.');
                    }
                };
                
                waitForPDFMake();
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showNotification(`Error generating PDF report: ${error.message}. Please try again.`);
            }
        }
        
        function generatePDFReportInternal(city, year, selectedProjectIds = null) {
            try {
                // Get submissions for this city/year
                let cityYearSubmissions = allSubmissions.filter(submission => {
                    const submissionCity = submission.cityCounty || submission.submitterName || submission.projectArea || 'Unknown';
                    const submissionYear = submission.year || submission.fy || 'N/A';
                    return submissionCity === city && (year === null || submissionYear === year);
                });

                // Filter by selected project IDs if provided
                if (selectedProjectIds && selectedProjectIds.length > 0) {
                    cityYearSubmissions = cityYearSubmissions.filter(submission => {
                        const submissionId = submission.id || `submission-${allSubmissions.indexOf(submission)}`;
                        return selectedProjectIds.includes(submissionId);
                    });
                }

                console.log('Found submissions:', cityYearSubmissions.length, selectedProjectIds ? `(filtered from ${selectedProjectIds.length} selected)` : '');

                if (cityYearSubmissions.length === 0) {
                    showNotification(`No data found for ${city}${year ? ` - ${year}` : ''}.`);
                    return;
                }

                // Build PDFMake document definition
                // Note: PDFMake uses Roboto fonts from vfs_fonts by default
                const docDefinition = {
                    pageSize: 'LETTER',
                    pageMargins: [40, 60, 40, 60],
                    defaultStyle: {
                        fontSize: 10,
                        lineHeight: 1.2
                        // Don't specify font - PDFMake will use default (Roboto from vfs_fonts)
                    },
                    footer: function(currentPage, pageCount) {
                        return {
                            margin: [40, 0, 40, 0],
                            text: [
                                { text: `Page ${currentPage}`, fontSize: 8, color: '#999999' },
                                { text: '  |  ', fontSize: 8, color: '#999999' },
                                { text: 'LRB PUBLIC FINANCE ADVISORS | 41 NORTH RIO GRANDE, SUITE 101 | SALT LAKE CITY, UT 84101', fontSize: 8, color: '#999999' }
                            ],
                            alignment: 'center',
                            margin: [40, 20, 40, 0] // Top margin pushes text to bottom of footer area
                        };
                    },
                    content: []
                };
                
                // Ensure fonts are available
                if (typeof pdfMake === 'undefined' || typeof pdfMake.vfs === 'undefined') {
                    showNotification('PDF fonts not loaded. Please refresh the page and try again.');
                    return;
                }
                
                // Get submitter name from first submission
                const submitterName = cityYearSubmissions.length > 0 
                    ? (cityYearSubmissions[0].submitterName || cityYearSubmissions[0].cityCounty || city)
                    : city;
                
                // Add cover page
                addCoverPagePDFMake(docDefinition, city, year, submitterName);
                
                // Add table of contents
                addTableOfContentsPDFMake(docDefinition, cityYearSubmissions);
                
                // Add executive summary intro page (black page with "EXECUTIVE SUMMARY")
                addExecutiveSummaryIntroPDFMake(docDefinition);
                
                // Add executive summary
                addExecutiveSummaryPDFMake(docDefinition, city, cityYearSubmissions);
                
                // Add governing board section
                addGoverningBoardSectionPDFMake(docDefinition, cityYearSubmissions);
                
                // Add combined budget section
                addCombinedBudgetSectionPDFMake(docDefinition, cityYearSubmissions, year);
                
                // Add acreage overview section
                addAcreageOverviewSectionPDFMake(docDefinition, cityYearSubmissions);
                
                // Add individual project sections
                addIndividualProjectSectionsPDFMake(docDefinition, cityYearSubmissions);
                
                // Generate and download the PDF
                const filename = `LRB_Annual_Report_${city}_${year || 'all'}_${new Date().toISOString().split('T')[0]}.pdf`;
                
                try {
                    console.log('Creating PDF with PDFMake...');
                    console.log('docDefinition content length:', docDefinition.content.length);
                    
                    // Use download method directly - it should handle fonts automatically
                    pdfMake.createPdf(docDefinition).download(filename, () => {
                        console.log('PDF download initiated');
                        showNotification(`PDF report generated successfully for ${city}${year ? ` - ${year}` : ''}!`);
                    }, (error) => {
                        console.error('PDF generation error in callback:', error);
                        showNotification(`Error generating PDF: ${error.message || 'Unknown error'}. Please check console.`);
                    });
                } catch (error) {
                    console.error('PDF generation error (catch):', error);
                    console.error('Error details:', error.stack);
                    showNotification(`Error generating PDF: ${error.message}. Please check console for details.`);
                }
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showNotification(`Error generating PDF report: ${error.message}. Please try again.`);
            }
        }

        function generateHTMLReport(city, year, submissions) {
            let html = '';
            
            // Cover Page
            html += generateHTMLCoverPage(city, year);
            
            // Table of Contents
            html += generateHTMLTableOfContents(submissions);
            
            // Executive Summary Intro Page
            html += generateHTMLExecutiveSummaryIntro();
            
            // Executive Summary
            html += generateHTMLExecutiveSummary(city, submissions);
            
            // Governing Board Section
            html += generateHTMLGoverningBoardSection(submissions);
            
            // Combined Budget Section
            html += generateHTMLCombinedBudgetSection(submissions);
            
            // Individual Project Sections
            html += generateHTMLIndividualProjectSections(submissions);
            
            return html;
        }

        function generateHTMLExecutiveSummaryIntro() {
            return `
                <div style="page-break-after: always; background: #000000; color: white; min-height: 11in; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <h1 style="font-size: 48px; font-weight: bold; text-align: center; margin: 0; color: #00B0F0; font-family: sans-serif;">EXECUTIVE SUMMARY</h1>
                    <div style="width: 80%; height: 2px; background-color: #d3d3d3; margin-top: 20px;"></div>
                </div>
            `;
        }

        function generateHTMLCoverPage(city, year) {
            return `
                <div style="page-break-after: always; padding: 20px; text-align: center; min-height: 11in; display: flex; flex-direction: column; justify-content: center;">
                    <img src="Pictures/horz_names (1).png" alt="LRB Logo" style="max-width: 400px; height: auto; margin: 0 auto 20px;">
                    <div style="font-size: 12px; margin-bottom: 10px;">MULTI-YEAR BUDGET</div>
                    <div style="font-size: 12px; margin-bottom: auto;">[${city.toUpperCase()} AGENCY]</div>
                </div>
            `;
        }

        function generateHTMLTableOfContents(submissions) {
            return `
                <div style="page-break-after: always; padding: 20px;">
                    <div style="background: #00B0F0; color: white; padding: 10px; margin: -20px -20px 20px -20px; text-align: center; font-weight: bold;">TABLE OF CONTENTS</div>
                    <div style="margin-bottom: 10px;"><strong>EXECUTIVE SUMMARY</strong> ........................................................ 3</div>
                    <div style="margin-bottom: 10px;"><strong>INTRODUCTION</strong> .......................................................... 3</div>
                    <div style="margin-bottom: 10px;"><strong>SUMMARY OF 17C-1-603. REPORTING REQUIREMENTS</strong> ........ 4</div>
                    <div style="margin-bottom: 10px;"><strong>GOVERNING BOARD OF TRUSTEES AND STAFF</strong> ............... 5</div>
                    <div style="margin-bottom: 10px;"><strong>SUMMARY OF TAX INCREMENT REVENUES AND EXPENDITURES</strong> . 6</div>
                    <div style="margin-bottom: 10px;"><strong>TABLE E.3 â€“ COMBINED AGENCY BUDGET</strong> .................... 6</div>
                    ${submissions.map((submission, index) => {
                        const projectNumber = index + 1;
                        const projectArea = submission.projectAreaName || submission.projectArea || submission.submitterName || `Project Area ${projectNumber}`;
                        return `<div style="margin-bottom: 10px;"><strong>PROJECT AREA ${projectNumber}: ${projectArea}</strong> ............... ${7 + index}</div>`;
                    }).join('')}
                </div>
            `;
        }

        function generateHTMLExecutiveSummary(city, submissions) {
            const projectAreas = submissions.map(submission => {
                const projectArea = submission.projectAreaName || submission.projectArea || submission.submitterName || 'Unknown Project';
                return `â€¢ ${projectArea}`;
            }).join('<br>');

            return `
                <div style="page-break-after: always; padding: 20px;">
                    <div style="background: #00B0F0; color: white; padding: 10px; margin: -20px -20px 20px -20px; text-align: center; font-weight: bold;"></div>
                    
                    <h2 style="margin: 10px 0 15px 0; transform: translateY(-3mm);">EXECUTIVE SUMMARY</h2>
                    <div style="width: 100%; height: 0.5mm; background-color: #000000; margin: -5mm 0 20px 0;"></div>
                    
                    <h3 style="color: #00B0F0; margin: 15px 0 10px 0;">INTRODUCTION</h3>
                    <p>LRB Public Finance Advisors, Inc ("LRB") has been retained by the ${city} Agency of ${city}, Utah (the "Agency") to assist with the management and reporting requirements of the Agency's ${submissions.length} project areas:</p>
                    <div style="margin: 10px 0 20px 20px;">
                        ${projectAreas}
                    </div>
                    
                    <h3 style="color: #00B0F0; margin: 15px 0 10px 0;">OVERVIEW OF AGENCY</h3>
                    <p>The ${city} Community Reinvestment Agency is a public entity established under Utah Code Title 17C, Chapter 1, Community Reinvestment Agency Act. Community Reinvestment Agencies (CRAs) are authorized to create and manage project areas to promote economic development, job creation, and community improvement through the use of tax increment financing.</p>
                    
                    <p>CRAs have the authority to acquire, develop, and dispose of real property; enter into agreements with developers and other entities; and utilize tax increment revenues to fund public improvements and development activities within designated project areas. The agency operates under the oversight of local government and in accordance with state statutory requirements.</p>
                    
                    <h3 style="color: #00B0F0; margin: 15px 0 10px 0;">SUMMARY OF AGENCY POWERS</h3>
                    <p>Under Utah Code 17C-1-301, Community Reinvestment Agencies possess the following powers and authorities:</p>
                    <ul style="margin: 10px 0 20px 20px;">
                        <li>To acquire, hold, and dispose of real and personal property within project areas</li>
                        <li>To enter into contracts and agreements with public and private entities</li>
                        <li>To plan, design, and implement public improvements and infrastructure</li>
                        <li>To provide financial assistance to private development through loans, grants, and other mechanisms</li>
                        <li>To utilize tax increment revenues for project area development and administration</li>
                        <li>To issue bonds and other debt instruments for project financing</li>
                        <li>To exercise eminent domain powers within project areas when necessary</li>
                        <li>To coordinate with local governments and taxing entities on development activities</li>
                    </ul>
                    
                    <p>The purpose of this report, in part, is to fulfill the requirements of Utah Code section 17C-1-603 â€“ Reporting requirements â€“ Governor's Office of Economic Opportunity to maintain a database and related reports. As new reporting requirements were adopted in legislation and became effective in 2011 and again revised and updated in 2016, 2019, 2022, and 2025, this report facilitates the Agency's compliance with the current state code, providing the data necessary to fulfill the Agency report requirements. The Agency has submitted all required information into the GOEO database and is providing this Annual Report for further transparency to the public and taxing entities, and to update the Agency Board on the status and activities within each project area. This annual report is for informational purposes only and does not alter the amount of project area funds that the Agency is authorized to receive from each Project Area. This report is intended to provide an overview of each Project Area that lies within the boundaries of the Agency, including descriptions of each Project Area, significant activities, project timelines, actual and estimated tax increment collections, and any other information pertinent to the taxing entities.</p>
                    
                    <h3 style="color: #00B0F0; margin: 20px 0 10px 0;">SUMMARY OF 17C-1-603. REPORTING REQUIREMENTS â€“ GOVERNOR'S OFFICE OF ECONOMIC OPPORTUNITY TO MAINTAIN A DATABASE.</h3>
                    <p>Utah State Code 17C-1-603 sets out the annual reporting requirements for community reinvestment agencies. Under this section:</p>
                    <ul style="margin: 10px 0 20px 20px;">
                        <li>Agencies must submit annual reports by June 30 for each active project area, providing detailed financial and project information, such as:</li>
                        <li>Amounts and estimates of project area funds received and to be received.</li>
                        <li>Project budgets and analyses of receipts and expenditures.</li>
                        <li>Maps of the project area and descriptions of progress toward project goals.</li>
                        <li>Agencies with no active project areas must still submit a report confirming their status until the agency is dissolved.</li>
                        <li>The Governor's Office of Economic Opportunity must maintain a public database of the submitted data and prepare an annual report for legislative review.</li>
                        <li>Noncompliance can lead to financial penalties, including withholding a portion of the agency's tax increment funds.</li>
                        <li>The report is informational and does not alter the total funds the agency is entitled to collect.</li>
                    </ul>
                </div>
            `;
        }

        function generateHTMLGoverningBoardSection(submissions) {
            // Get governing board data from submissions
            const boardMembers = [];
            for (let i = 1; i <= 10; i++) {
                const name = submissions[0]?.[`governingBoardName_${i}`];
                const title = submissions[0]?.[`governingBoardTitle_${i}`];
                if (name && name.trim()) {
                    boardMembers.push({ name: name.trim(), title: title?.trim() || '' });
                }
            }

            // Get agency staff data from submissions
            const staffMembers = [];
            for (let i = 1; i <= 10; i++) {
                const name = submissions[0]?.[`agencyStaffName_${i}`];
                const title = submissions[0]?.[`agencyStaffTitle_${i}`];
                if (name && name.trim()) {
                    staffMembers.push({ name: name.trim(), title: title?.trim() || '' });
                }
            }

            const boardRows = boardMembers.map(member => 
                `<tr><td style="padding: 8px; border: 1px solid #ddd;">${member.name}</td><td style="padding: 8px; border: 1px solid #ddd;">${member.title}</td></tr>`
            ).join('');

            const staffRows = staffMembers.map(member => 
                `<tr><td style="padding: 8px; border: 1px solid #ddd;">${member.name}</td><td style="padding: 8px; border: 1px solid #ddd;">${member.title}</td></tr>`
            ).join('');

            return `
                <div style="page-break-after: always; padding: 20px;">
                    <h2 style="margin: 20px 0 15px 0; color: #00B0F0;">GOVERNING BOARD OF TRUSTEES AND STAFF</h2>
                    
                    <h3 style="color: #00B0F0; margin: 15px 0 10px 0;">GOVERNING BOARD OF TRUSTEES</h3>
                    <p>The governing board of the Agency consists of the following members:</p>
                    
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: bold;">Name</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: bold;">Title/Position</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${boardRows || '<tr><td colspan="2" style="padding: 8px; border: 1px solid #ddd; text-align: center; font-style: italic;">No governing board members data available</td></tr>'}
                        </tbody>
                    </table>

                    <h3 style="color: #00B0F0; margin: 25px 0 10px 0;">AGENCY STAFF</h3>
                    <p>The agency staff consists of the following members:</p>
                    
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: bold;">Name</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: bold;">Title/Position</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${staffRows || '<tr><td colspan="2" style="padding: 8px; border: 1px solid #ddd; text-align: center; font-style: italic;">No agency staff data available</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function generateHTMLCombinedBudgetSection(submissions) {
            // Calculate combined financial data (using same logic as original jsPDF function)
            const combinedData = {
                totalRevenues: 0,
                totalExpenditures: 0,
                projectAreas: []
            };

            // Revenue categories
            const revenueCategories = [
                'taxIncrementRevenue',
                'bondProceeds',
                'grants',
                'developerContributions',
                'otherRevenue'
            ];

            // Expenditure categories  
            const expenditureCategories = [
                'administrativeCosts',
                'publicImprovements',
                'infrastructure',
                'landAcquisition',
                'bondPayments',
                'otherExpenditures'
            ];

            // Aggregate data from all submissions
            submissions.forEach(submission => {
                const projectArea = submission.projectAreaName || submission.projectArea || submission.submitterName || 'Unknown';
                
                let projectRevenues = 0;
                let projectExpenditures = 0;

                // Calculate revenues
                revenueCategories.forEach(category => {
                    const amount = parseFloat(submission[category]) || 0;
                    projectRevenues += amount;
                });

                // Calculate expenditures
                expenditureCategories.forEach(category => {
                    const amount = parseFloat(submission[category]) || 0;
                    projectExpenditures += amount;
                });

                combinedData.projectAreas.push({
                    name: projectArea,
                    revenues: projectRevenues,
                    expenditures: projectExpenditures
                });

                combinedData.totalRevenues += projectRevenues;
                combinedData.totalExpenditures += projectExpenditures;
            });

            // Generate revenue table rows
            const revenueRows = revenueCategories.map(category => {
                const totalAmount = submissions.reduce((sum, submission) => {
                    return sum + (parseFloat(submission[category]) || 0);
                }, 0);
                return `<tr><td style="padding: 8px; border: 1px solid #ddd;">${category.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${totalAmount.toLocaleString()}</td></tr>`;
            }).join('');

            // Generate expenditure table rows
            const expenditureRows = expenditureCategories.map(category => {
                const totalAmount = submissions.reduce((sum, submission) => {
                    return sum + (parseFloat(submission[category]) || 0);
                }, 0);
                return `<tr><td style="padding: 8px; border: 1px solid #ddd;">${category.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${totalAmount.toLocaleString()}</td></tr>`;
            }).join('');

            // Generate acreage overview table
            const acreageRows = combinedData.projectAreas.map(project => {
                const submission = submissions.find(s => 
                    (s.projectAreaName || s.projectArea || s.submitterName) === project.name
                );
                const totalAcreage = parseFloat(submission?.totalAcreage) || 0;
                const developedAcreage = parseFloat(submission?.developedAcreage) || 0;
                const remainingAcreage = totalAcreage - developedAcreage;
                
                return `<tr>
                    <td style="padding: 8px; border: 1px solid #ddd;">${project.name}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${totalAcreage.toLocaleString()}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${developedAcreage.toLocaleString()}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${remainingAcreage.toLocaleString()}</td>
                </tr>`;
            }).join('');

            const totalAcreage = combinedData.projectAreas.reduce((sum, project) => {
                const submission = submissions.find(s => 
                    (s.projectAreaName || s.projectArea || s.submitterName) === project.name
                );
                return sum + (parseFloat(submission?.totalAcreage) || 0);
            }, 0);

            const totalDevelopedAcreage = combinedData.projectAreas.reduce((sum, project) => {
                const submission = submissions.find(s => 
                    (s.projectAreaName || s.projectArea || s.submitterName) === project.name
                );
                return sum + (parseFloat(submission?.developedAcreage) || 0);
            }, 0);

            const totalRemainingAcreage = totalAcreage - totalDevelopedAcreage;

            return `
                <div style="page-break-after: always; padding: 20px;">
                    <h2 style="margin: 20px 0 15px 0; color: #00B0F0;">SUMMARY OF TAX INCREMENT REVENUES AND EXPENDITURES</h2>
                    
                    <h3 style="color: #00B0F0; margin: 15px 0 10px 0;">TABLE E.3 â€“ COMBINED AGENCY BUDGET</h3>
                    <p><strong>COMBINED TAX INCREMENT BUDGET â€“ AGENCY</strong></p>
                    
                    <h4 style="margin: 20px 0 10px 0;">REVENUES</h4>
                    <table style="width: 100%; border-collapse: collapse; margin: 10px 0 30px 0;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: bold;">Revenue Source</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: bold;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${revenueRows}
                            <tr style="background: #f0f8ff; font-weight: bold;">
                                <td style="padding: 12px; border: 1px solid #ddd;">TOTAL REVENUES</td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">$${combinedData.totalRevenues.toLocaleString()}</td>
                            </tr>
                        </tbody>
                    </table>

                    <h4 style="margin: 20px 0 10px 0;">EXPENDITURES</h4>
                    <table style="width: 100%; border-collapse: collapse; margin: 10px 0 30px 0;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: bold;">Expenditure Category</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: bold;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${expenditureRows}
                            <tr style="background: #f0f8ff; font-weight: bold;">
                                <td style="padding: 12px; border: 1px solid #ddd;">TOTAL EXPENDITURES</td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">$${combinedData.totalExpenditures.toLocaleString()}</td>
                            </tr>
                        </tbody>
                    </table>

                    <h4 style="margin: 20px 0 10px 0;">COMBINED ACREAGE OVERVIEW</h4>
                    <table style="width: 100%; border-collapse: collapse; margin: 10px 0 30px 0;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: bold;">Project Area</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: bold;">Total Acreage</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: bold;">Developed Acreage</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: bold;">Remaining Acreage</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${acreageRows}
                            <tr style="background: #f0f8ff; font-weight: bold;">
                                <td style="padding: 12px; border: 1px solid #ddd;">TOTAL</td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${totalAcreage.toLocaleString()}</td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${totalDevelopedAcreage.toLocaleString()}</td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${totalRemainingAcreage.toLocaleString()}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        function generateHTMLIndividualProjectSections(submissions) {
            let html = '';
            
            submissions.forEach((submission, index) => {
                const projectNumber = index + 1;
                const projectArea = submission.projectAreaName || submission.projectArea || submission.submitterName || `Project Area ${projectNumber}`;
                
                // Financial data
                const revenues = {
                    taxIncrement: parseFloat(submission.taxIncrementRevenue) || 0,
                    bondProceeds: parseFloat(submission.bondProceeds) || 0,
                    grants: parseFloat(submission.grants) || 0,
                    developerContributions: parseFloat(submission.developerContributions) || 0,
                    otherRevenue: parseFloat(submission.otherRevenue) || 0
                };
                const totalRevenues = Object.values(revenues).reduce((sum, val) => sum + val, 0);

                const expenditures = {
                    administrativeCosts: parseFloat(submission.administrativeCosts) || 0,
                    publicImprovements: parseFloat(submission.publicImprovements) || 0,
                    infrastructure: parseFloat(submission.infrastructure) || 0,
                    landAcquisition: parseFloat(submission.landAcquisition) || 0,
                    bondPayments: parseFloat(submission.bondPayments) || 0,
                    otherExpenditures: parseFloat(submission.otherExpenditures) || 0
                };
                const totalExpenditures = Object.values(expenditures).reduce((sum, val) => sum + val, 0);

                // Acreage data
                const totalAcreage = parseFloat(submission.totalAcreage) || 0;
                const developedAcreage = parseFloat(submission.developedAcreage) || 0;
                const remainingAcreage = totalAcreage - developedAcreage;

                html += `
                    <div style="page-break-after: always; background: #000000; color: white; min-height: 11in; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <h1 style="font-size: 48px; font-weight: bold; text-align: center; margin: 0; color: #00B0F0; font-family: sans-serif;">${projectArea.toUpperCase()}</h1>
                        <div style="width: 80%; height: 2px; background-color: #d3d3d3; margin-top: 20px;"></div>
                    </div>
                    
                    <div style="page-break-after: always; padding: 20px;">
                        <div style="background: #00B0F0; color: white; padding: 10px; margin: -20px -20px 20px -20px; text-align: center; font-weight: bold;"></div>
                        
                        <h2 style="margin: 10px 0 15px 0; transform: translateY(-3mm);">${projectArea.toUpperCase()}</h2>
                        <div style="width: 100%; height: 0.5mm; background-color: #000000; margin: -5mm 0 20px 0;"></div>
                        
                        <div style="margin: 15px 0;">
                            <h3 style="color: #00B0F0; margin: 15px 0 10px 0;">PROJECT INFORMATION</h3>
                            <p><strong>Project Area:</strong> ${projectArea}</p>
                            <p><strong>Type:</strong> ${submission.type || 'N/A'}</p>
                            <p><strong>Purpose:</strong> ${submission.purpose || 'N/A'}</p>
                            <p><strong>Year:</strong> ${submission.year || submission.fy || 'N/A'}</p>
                            ${submission.submitterName ? `<p><strong>Submitter:</strong> ${submission.submitterName}</p>` : ''}
                            ${submission.submitterEmail ? `<p><strong>Email:</strong> ${submission.submitterEmail}</p>` : ''}
                            ${submission.submitterPhone ? `<p><strong>Phone:</strong> ${submission.submitterPhone}</p>` : ''}
                            ${submission.timestamp ? `<p><strong>Submitted:</strong> ${new Date(submission.timestamp).toLocaleDateString()}</p>` : ''}
                        </div>

                        <h3 style="color: #00B0F0; margin: 20px 0 10px 0;">FINANCIAL SUMMARY</h3>
                        
                        <h4 style="margin: 10px 0 5px 0; color: #888888; font-size: 12px; font-weight: bold;">TABLE 1 â€“ OVERVIEW OF PROJECT AREA</h4>
                        <h4 style="margin: 15px 0 8px 0;">REVENUES</h4>
                        <table style="width: 100%; border-collapse: collapse; margin: 10px 0 20px 0;">
                            <tbody>
                                <tr><td style="padding: 6px; border: 1px solid #ddd;">Tax Increment Revenue</td><td style="padding: 6px; border: 1px solid #ddd; text-align: right;">$${revenues.taxIncrement.toLocaleString()}</td></tr>
                                <tr><td style="padding: 6px; border: 1px solid #ddd;">Bond Proceeds</td><td style="padding: 6px; border: 1px solid #ddd; text-align: right;">$${revenues.bondProceeds.toLocaleString()}</td></tr>
                                <tr><td style="padding: 6px; border: 1px solid #ddd;">Grants</td><td style="padding: 6px; border: 1px solid #ddd; text-align: right;">$${revenues.grants.toLocaleString()}</td></tr>
                                <tr><td style="padding: 6px; border: 1px solid #ddd;">Developer Contributions</td><td style="padding: 6px; border: 1px solid #ddd; text-align: right;">$${revenues.developerContributions.toLocaleString()}</td></tr>
                                <tr><td style="padding: 6px; border: 1px solid #ddd;">Other Revenue</td><td style="padding: 6px; border: 1px solid #ddd; text-align: right;">$${revenues.otherRevenue.toLocaleString()}</td></tr>
                                <tr style="background: #f0f8ff; font-weight: bold;"><td style="padding: 8px; border: 1px solid #ddd;">TOTAL REVENUES</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${totalRevenues.toLocaleString()}</td></tr>
                            </tbody>
                        </table>

                        <h4 style="margin: 15px 0 8px 0;">EXPENDITURES</h4>
                        <table style="width: 100%; border-collapse: collapse; margin: 10px 0 20px 0;">
                            <tbody>
                                <tr><td style="padding: 6px; border: 1px solid #ddd;">Administrative Costs</td><td style="padding: 6px; border: 1px solid #ddd; text-align: right;">$${expenditures.administrativeCosts.toLocaleString()}</td></tr>
                                <tr><td style="padding: 6px; border: 1px solid #ddd;">Public Improvements</td><td style="padding: 6px; border: 1px solid #ddd; text-align: right;">$${expenditures.publicImprovements.toLocaleString()}</td></tr>
                                <tr><td style="padding: 6px; border: 1px solid #ddd;">Infrastructure</td><td style="padding: 6px; border: 1px solid #ddd; text-align: right;">$${expenditures.infrastructure.toLocaleString()}</td></tr>
                                <tr><td style="padding: 6px; border: 1px solid #ddd;">Land Acquisition</td><td style="padding: 6px; border: 1px solid #ddd; text-align: right;">$${expenditures.landAcquisition.toLocaleString()}</td></tr>
                                <tr><td style="padding: 6px; border: 1px solid #ddd;">Bond Payments</td><td style="padding: 6px; border: 1px solid #ddd; text-align: right;">$${expenditures.bondPayments.toLocaleString()}</td></tr>
                                <tr><td style="padding: 6px; border: 1px solid #ddd;">Other Expenditures</td><td style="padding: 6px; border: 1px solid #ddd; text-align: right;">$${expenditures.otherExpenditures.toLocaleString()}</td></tr>
                                <tr style="background: #f0f8ff; font-weight: bold;"><td style="padding: 8px; border: 1px solid #ddd;">TOTAL EXPENDITURES</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${totalExpenditures.toLocaleString()}</td></tr>
                            </tbody>
                        </table>

                        <h3 style="color: #00B0F0; margin: 20px 0 10px 0;">ACREAGE OVERVIEW</h3>
                        <h4 style="margin: 10px 0 5px 0; color: #888888; font-size: 12px; font-weight: bold;">TABLE 8 â€“ ACREAGE</h4>
                        <table style="width: 100%; border-collapse: collapse; margin: 10px 0 20px 0;">
                            <tbody>
                                <tr><td style="padding: 8px; border: 1px solid #ddd;">Total Acreage</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${totalAcreage.toLocaleString()} acres</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #ddd;">Developed Acreage</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${developedAcreage.toLocaleString()} acres</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #ddd;">Remaining Acreage</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${remainingAcreage.toLocaleString()} acres</td></tr>
                            </tbody>
                        </table>

                        <h3 style="color: #00B0F0; margin: 20px 0 10px 0;">ADDITIONAL DETAILS</h3>
                        ${submission.description ? `<p><strong>Description:</strong> ${submission.description}</p>` : ''}
                        ${submission.status ? `<p><strong>Status:</strong> ${submission.status}</p>` : ''}
                        ${submission.timeline ? `<p><strong>Timeline:</strong> ${submission.timeline}</p>` : ''}
                        ${submission.notes ? `<p><strong>Notes:</strong> ${submission.notes}</p>` : ''}
                    </div>
                `;
            });
            
            return html;
        }

        function addCoverPage(doc, city, year) {
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            
            console.log('Adding cover page. logoDataUrl exists:', !!logoDataUrl, 'Logo dimensions:', logoWidth, 'x', logoHeight);
            
            // Add horizontal logo at top middle (1/5 of page width, 25mm from top)
            if (logoDataUrl && logoWidth > 0 && logoHeight > 0) {
                try {
                    // Calculate aspect ratio from stored dimensions
                    const aspectRatio = logoWidth / logoHeight;
                    
                    console.log('Logo aspect ratio:', aspectRatio);
                    
                    // Logo width: 4/5 of page width (210mm * 0.8 = 168mm) - 4x bigger
                    const pdfLogoWidth = pageWidth * 0.8;
                    const pdfLogoHeight = pdfLogoWidth / aspectRatio;
                    
                    // Position: center horizontally, 25mm from top
                    const logoX = (pageWidth - pdfLogoWidth) / 2;
                    const logoY = 25;
                    
                    // Add black background rectangle (full page width, from top to 10mm below logo)
                    doc.setFillColor(0, 0, 0); // Black
                    const bgX = 0; // Full page width, starts at left edge
                    const bgY = 0; // Starts at top of page
                    const bgWidth = pageWidth; // Full page width
                    const bgHeight = logoY + pdfLogoHeight + 10; // From top to logo bottom + 10mm
                    doc.rect(bgX, bgY, bgWidth, bgHeight, 'F'); // 'F' = filled rectangle
                    
                    console.log('âœ“ Black background added:', bgX, bgY, bgWidth, 'x', bgHeight);
                    
                    // Add logo on top of black background
                    console.log('Adding logo to cover page at:', logoX, logoY, 'size:', pdfLogoWidth, 'x', pdfLogoHeight);
                    doc.addImage(logoDataUrl, 'PNG', logoX, logoY, pdfLogoWidth, pdfLogoHeight);
                    console.log('âœ“ Logo added to cover page');
                    
                    // Add "REDEVELOPMENT AGENCY OF [CITY]" text on left side
                    // Right-aligned at middle of page (50%), vertically centered with last line at center
                    const middleOfPage = pageWidth / 2; // Middle of page
                    
                    // Calculate vertical center between black section and bottom of page
                    const remainingSpace = pageHeight - bgHeight;
                    const verticalCenter = bgHeight + (remainingSpace / 2);
                    
                    // Set text properties
                    doc.setTextColor(0, 176, 240); // Blue color (#00B0F0)
                    doc.setFontSize(28);
                    // Use jsPDF default font (no setFont call)
                    
                    // Line spacing (28pt font = ~9.9mm, normal spacing adds ~20% = ~12mm between lines)
                    const lineHeight = 12;
                    
                    // Last line (city name) should be at vertical center
                    // So work backwards from that position
                    const line3Y = verticalCenter; // City name at center
                    const line2Y = line3Y - lineHeight; // "AGENCY OF"
                    const line1Y = line2Y - lineHeight; // "REDEVELOPMENT"
                    
                    // Add vertical divider line at 50% mark + 2mm - 10mm + 1mm (shifted left then right 1mm)
                    const lineX = middleOfPage + 2 - 10 + 1; // 2mm to the right of center, then 10mm left, then 1mm right
                    const lineStartY = bgHeight + 65; // 65mm below black section
                    const lineEndY = pageHeight - 30; // 30mm from bottom
                    doc.setDrawColor(153, 153, 153); // Medium-light gray (#999999)
                    doc.setLineWidth(0.5); // 0.5mm thick
                    doc.line(lineX, lineStartY, lineX, lineEndY);
                    
                    // Draw three lines of text, right-aligned 5mm LEFT of divider line
                    const leftTextX = lineX - 5; // 5mm left of divider line
                    doc.text('REDEVELOPMENT', leftTextX, line1Y, { align: 'right' });
                    doc.text('AGENCY OF', leftTextX, line2Y, { align: 'right' });
                    doc.text(city.toUpperCase(), leftTextX, line3Y, { align: 'right' });
                    
                    // Add date below city name - 20mm gap
                    const dateY = line3Y + 20;
                    doc.setFontSize(24);
                    doc.setTextColor(153, 153, 153); // Medium-light gray (#999999)
                    doc.text(`June 30, ${year}`, leftTextX, dateY, { align: 'right' });
                    
                    // Add "ANNUAL RDA REPORT" and "2025" on right side
                    // Left-aligned 5mm RIGHT of divider line, same Y as REDEVELOPMENT
                    const rightTextX = lineX + 5; // 5mm right of divider line
                    doc.setFontSize(24); // 24pt font
                    doc.setTextColor(170, 170, 170); // Medium-light gray (#AAAAAA)
                    doc.text('ANNUAL RDA REPORT', rightTextX, line1Y, { align: 'left' });
                    doc.text('2025', rightTextX, line1Y + 12, { align: 'left' }); // 12mm below first line
                    
                    // Add "PREPARED BY:" section
                    const preparedByY = line1Y + 12 + 15 + 15; // 15mm below "2025" + 15mm down
                    doc.setFontSize(16); // Increased to 16pt
                    doc.setFont(undefined, 'bold'); // Make it bold
                    doc.setTextColor(100, 100, 100); // Dark gray
                    doc.text('PREPARED BY:', rightTextX, preparedByY, { align: 'left' });
                    
                    // Add second line with company name as hyperlink
                    const companyY = preparedByY + 15; // 15mm below "PREPARED BY:"
                    doc.setFontSize(16); // Increased to 16pt
                    doc.setFont(undefined, 'bold'); // Make it bold
                    doc.setTextColor(0, 176, 240); // Blue color (#00B0F0)
                    doc.textWithLink('LRB PUBLIC FINANCE ADVISORS', rightTextX, companyY, { 
                        align: 'left',
                        url: 'https://lrbfinance.com/'
                    });
                    
                    console.log('âœ“ Agency text, date, divider line, and right side text added');
                } catch (e) {
                    console.error('ERROR adding logo to cover page:', e);
                }
            } else {
                console.warn('âš  logoDataUrl is null or dimensions invalid - logo not loaded properly');
            }
        }

        // PDFMake version of cover page - direct conversion from jsPDF
        function addCoverPagePDFMake(docDefinition, city, year, submitterName) {
            console.log('Adding PDFMake cover page. logoDataUrl exists:', !!logoDataUrl);
            
            // Ensure year is not null/undefined
            const displayYear = year || new Date().getFullYear();
            
            // Constants: jsPDF uses mm, PDFMake uses points. 1mm = 2.83465 points
            const mmToPt = 2.83465;
            // Letter size: 215.9mm x 279.4mm = 612pt x 792pt
            const pageWidth = 215.9 * mmToPt; // Convert mm to pt (matches jsPDF)
            const pageHeight = 279.4 * mmToPt; // Convert mm to pt (matches jsPDF)
            
            // Use submitterName if provided, otherwise fall back to city
            // Remove "RDA" if it appears after the name
            let displayName = submitterName || city;
            displayName = displayName.replace(/\s*RDA\s*$/i, ''); // Remove "RDA" at the end (case insensitive)
            
            if (logoDataUrl && logoWidth > 0 && logoHeight > 0) {
                try {
                    // Exact same calculations as jsPDF
                    const aspectRatio = logoWidth / logoHeight;
                    const pdfLogoWidth = pageWidth * 0.8; // 80% of page width
                    const pdfLogoHeight = pdfLogoWidth / aspectRatio;
                    
                    // Logo position: center horizontally, 25mm from top (jsPDF uses mm)
                    const logoX = (pageWidth - pdfLogoWidth) / 2;
                    const logoY = 25 * mmToPt; // 25mm converted to points
                    
                    // Black background: full page width, from top to 10mm below logo bottom
                    const bgX = 0;
                    const bgY = 0;
                    const bgWidth = pageWidth;
                    const bgHeight = logoY + pdfLogoHeight + (10 * mmToPt); // 10mm below logo
                    
                    // Build cover page content array
                    const coverPageContent = [];
                    
                    // 1. Black background rectangle (edge-to-edge, accounting for PDFMake margins)
                    coverPageContent.push({
                        canvas: [{
                            type: 'rect',
                            x: -40, // Extend to left edge (negative left margin)
                            y: -60, // Extend to top edge (negative top margin)
                            w: bgWidth + 80, // Full width including margins
                            h: bgHeight + 60, // Height including top margin
                            color: '#000000'
                        }]
                    });
                    
                    // 2. Logo image (with manual offset adjustments)
                    const logoOffsetX = 35; // Manual adjustment to center on black box
                    const logoOffsetY = 45; // Manual adjustment to center on black box
                    coverPageContent.push({
                        image: logoDataUrl,
                        width: pdfLogoWidth,
                        height: pdfLogoHeight,
                        absolutePosition: { 
                            x: logoX - 40 + logoOffsetX, // Account for left margin + offset
                            y: logoY - 60 + logoOffsetY // Account for top margin + offset
                        }
                    });
                    
                    // 3. Text in middle-left section (left portion of middle third)
                    // Position: middle-left means left portion of middle third
                    // Split page into thirds: left (0-33%), middle (33-66%), right (66-100%)
                    // Middle-left would be around 30-35% of page width
                    // Move 40mm to the left from original position (30mm + 10mm)
                    const textX = (pageWidth * 0.32) - (40 * mmToPt); // 32% from left, then 40mm left
                    
                    // Vertical center of the page (accounting for black section at top)
                    const remainingSpace = pageHeight - bgHeight;
                    const verticalCenter = bgHeight + (remainingSpace / 2);
                    
                    // Move down 35mm from center (20mm + 15mm)
                    const verticalOffset = 35 * mmToPt; // 35mm down
                    
                    // Line spacing: 28pt font with spacing between lines
                    // Add extra spacing for blank lines between text
                    const lineHeight = 18 * mmToPt; // 18mm between lines (includes blank line space)
                    
                    // Calculate Y positions for each line (centered vertically, then moved down 20mm)
                    // Line 4 (date) at center + 20mm down, work backwards with spacing
                    const line4Y = verticalCenter + verticalOffset; // Date at center + 20mm down
                    const line3Y = line4Y - lineHeight; // Submittername (with blank line above)
                    const line2Y = line3Y - lineHeight; // "AGENCY OF" (with blank line above)
                    const line1Y = line2Y - lineHeight; // "REDEVELOPMENT"
                    
                    // Add text lines (right-aligned at textX position)
                    // Line 1: REDEVELOPMENT
                    coverPageContent.push({
                        text: 'REDEVELOPMENT',
                        fontSize: 28,
                        color: '#00B0F0', // Blue color
                        absolutePosition: { x: textX - 40, y: line1Y - 60 }, // Account for margins
                        alignment: 'left',
                        width: pageWidth * 0.3 // Width for left alignment
                    });
                    
                    // Line 2: AGENCY OF
                    coverPageContent.push({
                        text: 'AGENCY OF',
                        fontSize: 28,
                        color: '#00B0F0', // Blue color
                        absolutePosition: { x: textX - 40, y: line2Y - 60 },
                        alignment: 'left',
                        width: pageWidth * 0.3
                    });
                    
                    // Line 3: {Submitter name}
                    coverPageContent.push({
                        text: displayName.toUpperCase(),
                        fontSize: 28,
                        color: '#00B0F0', // Blue color
                        absolutePosition: { x: textX - 40, y: line3Y - 60 },
                        alignment: 'left',
                        width: pageWidth * 0.3
                    });
                    
                    // Line 4: June 30, {Year} (in gray)
                    coverPageContent.push({
                        text: `June 30, ${displayYear}`,
                        fontSize: 24,
                        color: '#999999', // Medium-light gray
                        absolutePosition: { x: textX - 40, y: line4Y - 60 },
                        alignment: 'left',
                        width: pageWidth * 0.3
                    });
                    
                    // Right side text - vertically aligned with left side text
                    // Position on right side of page (around 65% from left, then 10mm to the left)
                    const rightTextX = (pageWidth * 0.65) - (10 * mmToPt);
                    
                    // Calculate Y positions for right side text
                    // Line 1 and 2 align with left side, then 20mm space before line 3
                    const rightLine1Y = line1Y; // Align with "REDEVELOPMENT"
                    const rightLine2Y = line2Y; // Align with "AGENCY OF"
                    const rightLine3Y = rightLine2Y + (20 * mmToPt); // 20mm space after line 2
                    const rightLine4Y = rightLine3Y + (15 * mmToPt); // Normal spacing for line 4
                    
                    // Increased width to allow text to fit on one line
                    const rightTextWidth = pageWidth * 0.35; // Increased from 0.3 to give more room
                    
                    // Line 1: ANNUAL RDA REPORT (in gray)
                    coverPageContent.push({
                        text: 'ANNUAL RDA REPORT',
                        fontSize: 24,
                        color: '#999999', // Medium-light gray
                        absolutePosition: { x: rightTextX - 40, y: rightLine1Y - 60 },
                        alignment: 'left',
                        width: rightTextWidth
                    });
                    
                    // Line 2: {Year} (in gray)
                    coverPageContent.push({
                        text: displayYear.toString(),
                        fontSize: 24,
                        color: '#999999', // Medium-light gray
                        absolutePosition: { x: rightTextX - 40, y: rightLine2Y - 60 },
                        alignment: 'left',
                        width: rightTextWidth
                    });
                    
                    // Line 3: PREPARED BY: (gray, bold)
                    coverPageContent.push({
                        text: 'PREPARED BY:',
                        fontSize: 16,
                        color: '#999999', // Medium-light gray
                        bold: true,
                        absolutePosition: { x: rightTextX - 40, y: rightLine3Y - 60 },
                        alignment: 'left',
                        width: rightTextWidth
                    });
                    
                    // LRB Horizontal Logo below "PREPARED BY:"
                    if (logoDataUrl && logoWidth > 0 && logoHeight > 0) {
                        const horizontalLogoSpacing = 10 * mmToPt; // 10mm spacing below text
                        const horizontalLogoY = rightLine3Y + horizontalLogoSpacing + (3 * mmToPt); // 10mm spacing + 3mm down
                        const horizontalLogoWidth = 80 * mmToPt; // 80mm width for the logo
                        
                        // Calculate aspect ratio to maintain proportions
                        const horizontalAspectRatio = logoWidth / logoHeight;
                        const horizontalLogoDisplayWidth = horizontalLogoWidth;
                        const horizontalLogoDisplayHeight = horizontalLogoWidth / horizontalAspectRatio;
                        
                        coverPageContent.push({
                            image: logoDataUrl,
                            width: horizontalLogoDisplayWidth,
                            height: horizontalLogoDisplayHeight,
                            link: 'https://lrbfinance.com/', // Make logo a hyperlink
                            absolutePosition: { 
                                x: rightTextX - 40, // Align with text above
                                y: horizontalLogoY - 60 // Account for top margin
                            }
                        });
                    }
                    
                    // 4. Gray vertical line in the middle of the page
                    // Starts 20mm below black box, ends 20mm above footer (then 15mm shorter)
                    const footerHeight = 30; // Footer is 30pt high
                    // Black box bottom is at bgHeight (in page coordinates, accounting for -60 margin offset)
                    const lineStartY = bgHeight + (20 * mmToPt) + (30 * mmToPt) + (5 * mmToPt); // Black box bottom + 20mm + 30mm down + 5mm down
                    const lineEndY = pageHeight - (20 * mmToPt) - footerHeight + (30 * mmToPt) - (15 * mmToPt) + (5 * mmToPt); // 20mm above footer + 30mm down - 15mm shorter + 5mm down
                    const lineX = (pageWidth / 2) + (10 * mmToPt); // Middle of page + 10mm to the right
                    
                    coverPageContent.push({
                        canvas: [{
                            type: 'line',
                            x1: 0, // Relative to absolutePosition (middle of page + 10mm right)
                            y1: 0, // Relative to absolutePosition (lineStartY + 30mm down)
                            x2: 0, // Same X (vertical line)
                            y2: lineEndY - lineStartY, // Height of line (15mm shorter)
                            lineWidth: 1 * mmToPt, // 1mm thick total
                            lineColor: '#999999' // Medium-light gray
                        }],
                        absolutePosition: { 
                            x: lineX - 40, // Middle of page + 10mm right, accounting for left margin
                            y: lineStartY - 60 // Start position + 30mm down, accounting for top margin
                        }
                    });
                    
                    // Add cover page to document (first page, no pageBreak needed)
                    // Add all elements directly to content (not in a stack) so absolutePosition works correctly
                    // All elements go on the same page (page 1)
                    coverPageContent.forEach((item) => {
                        docDefinition.content.push(item);
                    });
                    
                    console.log('âœ“ PDFMake cover page content added');
                } catch (e) {
                    console.error('ERROR adding PDFMake cover page:', e);
                    // Fallback
                    docDefinition.content.push({
                        text: `ANNUAL JUNE 30TH COMPLIANCE REPORT\n${city}\n${displayYear}`,
                        fontSize: 24,
                        bold: true,
                        alignment: 'center',
                        margin: [0, 200, 0, 0]
                    });
                }
            } else {
                // Fallback if no logo
                docDefinition.content.push({
                    text: `ANNUAL JUNE 30TH COMPLIANCE REPORT\n${city}\n${displayYear}`,
                    fontSize: 24,
                    bold: true,
                    alignment: 'center',
                    margin: [0, 200, 0, 0]
                });
            }
        }

        function addTableOfContents(doc, submissions) {
            doc.addPage();
            
            const margin = 20;
            const pageWidth = doc.internal.pageSize.getWidth();
            let yPosition = 30;
            
            // Add header background
            doc.setFillColor(0, 176, 240);
            doc.rect(0, 0, pageWidth, 40, 'F');
            
            // Title with enhanced styling
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            // Use jsPDF default font
            doc.text('TABLE OF CONTENTS', pageWidth / 2, 25, { align: 'center' });
            
            // Reset text color
            doc.setTextColor(0, 0, 0);
            yPosition = 60;
            
            // Table of Contents Items with enhanced styling
            const tocItems = [
                { title: 'EXECUTIVE SUMMARY', page: '3' },
                { title: 'INTRODUCTION', page: '3' },
                { title: 'SUMMARY OF 17C-1-603 REPORTING REQUIREMENTS', page: '4' },
                { title: 'OVERVIEW OF AGENCY (CRA/CDRA/RDA)', page: '4' },
                { title: 'SUMMARY OF 17C-1-202 AGENCY POWERS', page: '5' },
                { title: 'GOVERNING BOARD OF TRUSTEES AND STAFF', page: '6' },
                { title: 'SUMMARY OF TAX INCREMENT REVENUES AND EXPENDITURES', page: '7' },
                { title: 'GENERAL OVERVIEW OF PROJECT AREAS AND ACREAGE', page: '8' }
            ];
            
            // Add individual project area sections with actual names
            submissions.forEach((submission, index) => {
                // Use the most descriptive name available - prioritize actual project area names
                let projectArea = submission.projectAreaName || submission.projectArea;
                
                // If no project area name, use submitter name (like "Redhawks CDA")
                if (!projectArea) {
                    projectArea = submission.submitterName || submission.cityCounty;
                }
                
                // Only use generic name as absolute last resort
                if (!projectArea) {
                    projectArea = `Project Area #${index + 1}`;
                }
                
                tocItems.push({ title: projectArea.toUpperCase(), page: `${8 + index + 1}` });
            });
            
            doc.setFontSize(12);
            // Use jsPDF default font
            
            tocItems.forEach((item, index) => {
                // Add alternating row colors
                if (index % 2 === 0) {
                    doc.setFillColor(248, 249, 250);
                    doc.rect(margin - 5, yPosition - 5, pageWidth - (margin * 2) + 10, 12, 'F');
                }
                
                doc.setTextColor(0, 176, 240);
                doc.setFont(undefined, 'bold');
                doc.text(item.title, margin, yPosition);
                
                doc.setTextColor(100, 100, 100);
                doc.setFont(undefined, 'normal');
                doc.text(`Page ${item.page}`, pageWidth - margin - 20, yPosition, { align: 'right' });
                
                yPosition += 18;
            });
            
            // Add footer line
            doc.setDrawColor(0, 176, 240);
            doc.setLineWidth(1);
            doc.line(margin, yPosition + 10, pageWidth - margin, yPosition + 10);
        }

        // Reusable improved table layout for consistent styling across all tables
        function getImprovedTableLayout() {
            return {
                // Horizontal lines: thicker for header separation, lighter for body
                hLineWidth: (i, node) => {
                    if (i === 0 || i === node.table.body.length) return 1; // Top and bottom borders
                    if (i === 1) return 0.8; // Header bottom border
                    return 0.3; // Body row borders (lighter)
                },
                // Vertical lines: lighter for cleaner look
                vLineWidth: () => 0.3,
                // Line colors: lighter gray for body, darker for headers
                hLineColor: (i, node) => {
                    if (i === 0 || i === node.table.body.length) return '#CCCCCC'; // Top/bottom borders
                    if (i === 1) return '#00B0F0'; // Header bottom border (blue accent)
                    return '#E0E0E0'; // Body row borders (light gray)
                },
                vLineColor: () => '#E0E0E0', // Light gray vertical lines
                // Enhanced padding for better readability
                paddingLeft: () => 10,
                paddingRight: () => 10,
                paddingTop: (i, node) => {
                    if (i === 0) return 12; // Header top padding
                    return 8; // Body row padding
                },
                paddingBottom: (i, node) => {
                    if (i === 0) return 12; // Header bottom padding
                    return 8; // Body row padding
                }
            };
        }

        // PDFMake version of table of contents
        function addTableOfContentsPDFMake(docDefinition, submissions) {
            const tocItems = [
                { title: 'EXECUTIVE SUMMARY', page: '3' },
                { title: 'INTRODUCTION', page: '3' },
                { title: 'SUMMARY OF 17C-1-603 REPORTING REQUIREMENTS', page: '4' },
                { title: 'OVERVIEW OF AGENCY (CRA/CDRA/RDA)', page: '4' },
                { title: 'SUMMARY OF 17C-1-202 AGENCY POWERS', page: '5' },
                { title: 'GOVERNING BOARD OF TRUSTEES AND STAFF', page: '6' },
                { title: 'SUMMARY OF TAX INCREMENT REVENUES AND EXPENDITURES', page: '7' },
                { title: 'GENERAL OVERVIEW OF PROJECT AREAS AND ACREAGE', page: '8' }
            ];
            
            // Add individual project area sections
            submissions.forEach((submission, index) => {
                let projectArea = submission.projectAreaName || submission.projectArea;
                if (!projectArea) {
                    projectArea = submission.submitterName || submission.cityCounty;
                }
                if (!projectArea) {
                    projectArea = `Project Area #${index + 1}`;
                }
                tocItems.push({ title: projectArea.toUpperCase(), page: `${8 + index + 1}` });
            });
            
            // Build table body - compact layout to ensure it fits on one page
            const tableBody = tocItems.map((item, index) => {
                return [
                    { 
                        text: item.title, 
                        color: '#00B0F0', 
                        bold: true,
                        fontSize: 10, // Slightly larger for better readability
                        fillColor: index % 2 === 0 ? '#FAFAFA' : undefined, // More subtle alternating colors
                        margin: [0, 3, 0, 3] // Slightly more vertical margin
                    },
                    { 
                        text: `Page ${item.page}`, 
                        color: '#646464',
                        fontSize: 10, // Slightly larger
                        alignment: 'right',
                        fillColor: index % 2 === 0 ? '#FAFAFA' : undefined,
                        margin: [0, 3, 0, 3] // Slightly more vertical margin
                    }
                ];
            });
            
            // Header section with blue background and title
            const headerRow = [
                {
                    text: 'TABLE OF CONTENTS',
                    colSpan: 2,
                    fillColor: '#00B0F0',
                    color: '#FFFFFF',
                    fontSize: 16,
                    bold: true,
                    alignment: 'center',
                    margin: [0, 8, 0, 8] // Improved padding
                },
                {} // Empty cell for colspan
            ];
            
            // Add header as first row of table, then TOC items
            const fullTableBody = [headerRow, ...tableBody];
            
            // Header (blue bar at top) - same as other sections
            docDefinition.content.push({
                pageBreak: 'before',
                canvas: [{
                    type: 'rect',
                    x: -40, // Extend to left edge (negative left margin)
                    y: -60, // Extend to top edge (negative top margin)
                    w: 612 + 80, // Full page width (612pt + 40pt margins on each side)
                    h: 30 + 60, // Header height (30pt + 60pt for top margin)
                    color: '#00B0F0'
                }]
            });
            
            // Section title "TABLE OF CONTENTS" below the blue header
            docDefinition.content.push({
                text: 'TABLE OF CONTENTS',
                fontSize: 16,
                bold: true,
                color: '#00B0F0',
                margin: [40, 20, 40, 10]
            });
            
            // Table of contents - full page layout
            docDefinition.content.push({
                unbreakable: true, // Prevent page breaks - must fit on one page
                table: {
                    widths: ['*', 60], // Narrower page number column
                    body: tableBody // Use tableBody without headerRow since we added header separately
                },
                layout: {
                    hLineWidth: () => 0,
                    vLineWidth: () => 0,
                    paddingLeft: () => 40, // Match document margins
                    paddingRight: () => 40, // Match document margins
                    paddingTop: () => 8,
                    paddingBottom: () => 8
                },
                margin: [0, 0, 0, 0] // No margins - table fills page
            });
        }

        function addExecutiveSummaryIntro(doc) {
            doc.addPage();
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            
            // Black background
            doc.setFillColor(0, 0, 0);
            doc.rect(0, 0, pageWidth, pageHeight, 'F');
            
            // Blue text centered
            doc.setTextColor(0, 176, 240);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('EXECUTIVE SUMMARY', pageWidth / 2, pageHeight / 2 - 10, { align: 'center' });
            
            // Gray underline
            doc.setDrawColor(211, 211, 211);
            doc.setLineWidth(2);
            const lineWidth = pageWidth * 0.8;
            const lineX = (pageWidth - lineWidth) / 2;
            const lineY = pageHeight / 2 + 15;
            doc.line(lineX, lineY, lineX + lineWidth, lineY);
        }

        function addExecutiveSummary(doc, city, submissions) {
            doc.addPage();
            
            const margin = 20;
            const pageWidth = doc.internal.pageSize.getWidth();
            let yPosition = 30;
            
            // Add header
            addReportHeader(doc, 'ANNUAL JUNE 30TH COMPLIANCE REPORT');
            
            // EXECUTIVE SUMMARY Title, moved up by 3mm (approximately 8 points)
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('EXECUTIVE SUMMARY', margin, yPosition - 8);
            yPosition -= 6; // Move line up by 5mm (approximately 14 points)
            
            // Add black horizontal line under the title (0.5mm thick)
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.5);
            doc.line(margin, yPosition, pageWidth - margin, yPosition);
            yPosition += 14; // Space after line
            
            // Helper function to add text with automatic page breaks using global utility
            const addTextWithPageBreaks = (text, fontSize, color, isBold = false) => {
                doc.setFontSize(fontSize);
                doc.setFont(undefined, isBold ? 'bold' : 'normal');
                // Keep blue for section headings, force black for regular paragraphs
                if (isBold && fontSize === 14) {
                    doc.setTextColor(color[0], color[1], color[2]); // Blue for section headings
                } else {
                    doc.setTextColor(0, 0, 0); // Black for regular paragraphs
                }
                
                const splitText = doc.splitTextToSize(text, pageWidth - (margin * 2));
                const requiredSpace = splitText.length * (fontSize * 0.4) + 10;
                
                // Use global autoPageBreak utility
                const { yPosition: newY } = autoPageBreak(doc, yPosition, requiredSpace);
                yPosition = newY;
                
                doc.text(splitText, margin, yPosition);
                yPosition += splitText.length * (fontSize * 0.4) + 10;
            };
            
            // Helper function to add bullet points with automatic page breaks - FORCE BLACK TEXT
            const addBulletPoints = (items, fontSize, color, indent = 10) => {
                doc.setFontSize(fontSize);
                // FORCE BLACK TEXT for all bullet points
                doc.setTextColor(0, 0, 0);
                
                items.forEach(item => {
                    // Use global autoPageBreak utility
                    const { yPosition: newY } = autoPageBreak(doc, yPosition, 10);
                    yPosition = newY;
                    
                    doc.text(`â€¢ ${item}`, margin + indent, yPosition);
                    yPosition += 8;
                });
            };
            
            // INTRODUCTION Section
            addTextWithPageBreaks('INTRODUCTION', 14, [0, 176, 240], true);
            
            // Get project area names dynamically
            const projectAreaNames = submissions.map((submission, index) => {
                let projectArea = submission.projectAreaName || submission.projectArea;
                if (!projectArea) {
                    projectArea = submission.submitterName || submission.cityCounty;
                }
                if (!projectArea) {
                    projectArea = `Project Area #${index + 1}`;
                }
                return projectArea;
            });
            
            // Introduction paragraph
            const introText = `LRB Public Finance Advisors, Inc ("LRB") has been retained by the ${city} Agency of ${city}, Utah (the "Agency") to assist with the management and reporting requirements of the Agency's ${submissions.length} project areas:`;
            addTextWithPageBreaks(introText, 11, [0, 0, 0]);
            
            // List project areas
            addBulletPoints(projectAreaNames, 10, [0, 176, 240], 10);
            
            // Purpose paragraph
            const purposeText = `The purpose of this report, in part, is to fulfill the requirements of Utah Code section 17C-1-603 â€“ Reporting requirements â€“ Governor's Office of Economic Opportunity to maintain a database and related reports. As new reporting requirements were adopted in legislation and became effective in 2011 and again revised and updated in 2016, 2019, 2022, and 2025, this report facilitates the Agency's compliance with the current state code, providing the data necessary to fulfill the Agency report requirements. The Agency has submitted all required information into the GOEO database and is providing this Annual Report for further transparency to the public and taxing entities, and to update the Agency Board on the status and activities within each project area.`;
            addTextWithPageBreaks(purposeText, 11, [0, 0, 0]);
            
            const purposeText2 = `This annual report is for informational purposes only and does not alter the amount of project area funds that the Agency is authorized to receive from each Project Area. This report is intended to provide an overview of each Project Area that lies within the boundaries of the Agency, including descriptions of each Project Area, significant activities, project timelines, actual and estimated tax increment collections, and any other information pertinent to the taxing entities.`;
            addTextWithPageBreaks(purposeText2, 11, [0, 0, 0]);
            
            // SUMMARY OF 17C-1-603 REPORTING REQUIREMENTS Section - with proper page breaks
            const pageHeight = doc.internal.pageSize.getHeight();
            const availableWidth = pageWidth - (margin * 2);
            
            // Helper function to add text with guaranteed page breaks and proper wrapping
            const addTextWithGuaranteedBreaks = (text, fontSize, color, isBold = false, indent = 0, isBullet = false) => {
                doc.setFontSize(fontSize);
                doc.setFont(undefined, isBold ? 'bold' : 'normal');
                doc.setTextColor(color[0], color[1], color[2]);
                
                // Calculate available width for text (accounting for bullet symbol if needed)
                const bulletWidth = isBullet ? doc.getTextWidth('â€¢ ') : 0;
                const textWidth = availableWidth - indent - bulletWidth;
                
                const splitText = doc.splitTextToSize(text, textWidth);
                const lineHeight = fontSize * 0.4;
                const requiredHeight = splitText.length * lineHeight + 5;
                
                // Use global autoPageBreak utility
                const { yPosition: newY } = autoPageBreak(doc, yPosition, requiredHeight);
                yPosition = newY;
                
                // Add text line by line with proper bullet handling
                if (isBullet && splitText.length > 0) {
                    // First line with bullet
                    doc.text('â€¢ ' + splitText[0], margin + indent, yPosition);
                    yPosition += lineHeight;
                    
                    // Remaining lines without bullet (indented)
                    for (let i = 1; i < splitText.length; i++) {
                        doc.text(splitText[i], margin + indent + bulletWidth, yPosition);
                        yPosition += lineHeight;
                    }
                } else {
                    // Regular text without bullet
                    doc.text(splitText, margin + indent, yPosition);
                    yPosition += requiredHeight;
                }
            };
            
            // Section heading
            addTextWithGuaranteedBreaks('SUMMARY OF 17C-1-603. REPORTING REQUIREMENTS â€“ GOVERNOR\'S OFFICE OF ECONOMIC OPPORTUNITY TO MAINTAIN A DATABASE.', 14, [0, 176, 240], true);
            
            // Introduction paragraph
            addTextWithGuaranteedBreaks(`Utah State Code 17C-1-603 sets out the annual reporting requirements for community reinvestment agencies. Under this section:`, 11, [0, 0, 0]);
            
            // Bullet points for reporting requirements
            const requirements = [
                'Agencies must submit annual reports by June 30 for each active project area, providing detailed financial and project information, such as:',
                'Amounts and estimates of project area funds received and to be received.',
                'Project budgets and analyses of receipts and expenditures.',
                'Maps of the project area and descriptions of progress toward project goals.',
                'Agencies with no active project areas must still submit a report confirming their status until the agency is dissolved.',
                'The Governor\'s Office of Economic Opportunity must maintain a public database of the submitted data and prepare an annual report for legislative review.',
                'Noncompliance can lead to financial penalties, including withholding a portion of the agency\'s tax increment funds.',
                'The report is informational and does not alter the total funds the agency is entitled to collect.'
            ];
            
            requirements.forEach(requirement => {
                addTextWithGuaranteedBreaks(requirement, 10, [0, 0, 0], false, 10, true);
            });
            
            // OVERVIEW OF AGENCY Section
            addTextWithPageBreaks('OVERVIEW OF AGENCY (CRA/CDRA/RDA)', 14, [0, 176, 240], true);
            
            const agencyText = `A Community Reinvestment Agency (CRA), Community Development and Renewal Agency (CDRA), or Redevelopment Agency (RDA) is a special local government entity established under state law (Title 17C of the Utah Code) to help communities revitalize underused, blighted, or deteriorating areas. The main goals of these agencies are to:`;
            addTextWithPageBreaks(agencyText, 11, [0, 0, 0]);
            
            // Agency goals bullet points
            const goals = [
                'Encourage private and public investment in areas that have declined or are not thriving.',
                'Eliminate blight and improve infrastructure, housing, and economic opportunities within specific project areas.',
                'Promote economic development by supporting businesses, creating jobs, and expanding the local tax base.',
                'Increase the amount and variety of affordable housing in the community.'
            ];
            
            addBulletPoints(goals, 10, [0, 176, 240], 10);
            
            const overviewText = `CRAs, CDRAs, or RDAs can use tools such as tax increment financing to fund and incentivize improvements and development. They are typically governed by the local city council or county commission, serving as the agency's board. These agencies play a key role in assembling land, improving public works (like roads and utilities), and stimulating private investment to bring new life to designated neighborhoods or business districts.`;
            addTextWithPageBreaks(overviewText, 11, [0, 0, 0]);
            
            // SUMMARY OF 17C-1-202 AGENCY POWERS Section - with proper wrapping
            addTextWithGuaranteedBreaks('SUMMARY OF 17C-1-202. AGENCY POWERS.', 14, [0, 176, 240], true);
            
            const powersIntroText = `Utah State Code 17C-1-202 outlines the powers and authorities of CRAs, CDRAs, or RDAs. This section gives agencies the following key powers:`;
            addTextWithGuaranteedBreaks(powersIntroText, 11, [0, 0, 0]);
            
            // Agency powers bullet points - with proper wrapping
            const powers = [
                'Sue and be sued, enter into contracts, and acquire or dispose of real and personal property.',
                'Undertake actions for urban renewal, economic development, or community development, such as receiving tax increment funds and financing projects within designated areas.',
                'Issue bonds for project financing and other agency purposes, including repaying advances or refunding previously issued bonds.',
                'Pay impact fees and other costs associated with land development.',
                'Enter into development agreements with individuals or entities specifying project details, funding amounts, and performance expectations; these agreements must be approved by the agency\'s board and must align with the goals of the project area plan.'
            ];
            
            powers.forEach(power => {
                addTextWithGuaranteedBreaks(power, 10, [0, 0, 0], false, 10, true);
            });
            
            // Concluding paragraph - direct approach with page breaks
            yPosition += 15; // Add space after bullet points
            
            const concludingText = `The section also allows agencies to accept financial assistance from various sources, retain controls over developed land consistent with project plans, and transact any business necessary to fulfill their mission. If acquiring property outside a project area, the agency's board must find that it benefits an existing project area. All major agreements and decisions require adoption by resolution with clear findings.`;
            
            // Check if we need a new page before adding the text
            const splitConcludingText = doc.splitTextToSize(concludingText, pageWidth - (margin * 2));
            const requiredSpace = splitConcludingText.length * 4.5 + 10;
            
            if (yPosition + requiredSpace > doc.internal.pageSize.getHeight() - 30) {
                doc.addPage();
                addReportHeader(doc, 'ANNUAL JUNE 30TH COMPLIANCE REPORT');
                addReportFooter(doc);
                yPosition = 40; // Start below header
            }
            
            // Direct text rendering - bypass all helper functions
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0, 0, 0);
            
            doc.text(splitConcludingText, margin, yPosition);
            yPosition += splitConcludingText.length * 4.5 + 10;
            
            // Add footer
            addReportFooter(doc);
        }

        function addDataSummary(doc, city, submissions, margin, startY) {
            let yPosition = startY;
            
            // Data Summary Section
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(0, 176, 240);
            doc.text('COMPREHENSIVE DATA SUMMARY', margin, yPosition);
            yPosition += 15;
            
            // Add decorative line
            doc.setDrawColor(0, 176, 240);
            doc.setLineWidth(1);
            doc.line(margin, yPosition - 5, margin + 150, yPosition - 5);
            yPosition += 10;
            
            // Calculate comprehensive statistics
            const totalAcreage = submissions.reduce((sum, s) => sum + parseFloat(s.developedAcreage || 0) + parseFloat(s.undevelopedAcreage || 0), 0);
            const totalDeveloped = submissions.reduce((sum, s) => sum + parseFloat(s.developedAcreage || 0), 0);
            const totalUndeveloped = submissions.reduce((sum, s) => sum + parseFloat(s.undevelopedAcreage || 0), 0);
            const totalResidential = submissions.reduce((sum, s) => sum + parseFloat(s.residentialAcreage || 0), 0);
            const totalHousingUnits = submissions.reduce((sum, s) => sum + parseFloat(s.authorizedHousingUnits || 0), 0);
            const totalRevenue = submissions.reduce((sum, s) => sum + parseFloat(s.currentYearRevenue || 0), 0);
            const totalExpenses = submissions.reduce((sum, s) => sum + parseFloat(s.currentYearExpense || 0), 0);
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            
            // Create summary table
            const summaryData = [
                ['Metric', 'Value'],
                ['Total Project Areas', submissions.length.toString()],
                ['Total Acreage', `${totalAcreage.toFixed(2)} acres`],
                ['Developed Acreage', `${totalDeveloped.toFixed(2)} acres`],
                ['Undeveloped Acreage', `${totalUndeveloped.toFixed(2)} acres`],
                ['Residential Acreage', `${totalResidential.toFixed(2)} acres`],
                ['Authorized Housing Units', totalHousingUnits.toString()],
                ['Current Year Revenue', `$${totalRevenue.toLocaleString()}`],
                ['Current Year Expenses', `$${totalExpenses.toLocaleString()}`],
                ['Net Revenue', `$${(totalRevenue - totalExpenses).toLocaleString()}`]
            ];
            
            try {
                doc.autoTable({
                    startY: yPosition,
                    head: [summaryData[0]],
                    body: summaryData.slice(1),
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [0, 176, 240],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    bodyStyles: { textColor: [0, 0, 0] },
                    alternateRowStyles: { fillColor: [243, 244, 246] },
                    margin: { left: margin, right: margin }
                });
            } catch (error) {
                // Fallback to text if table fails
                summaryData.slice(1).forEach(row => {
                    doc.text(`${row[0]}: ${row[1]}`, margin, yPosition);
                    yPosition += 8;
                });
            }
        }

        function addGoverningBoardSection(doc, submissions) {
            doc.addPage();
            
            const margin = 20;
            let yPosition = 30;
            
            // Add header
            addReportHeader(doc, 'ANNUAL JUNE 30TH COMPLIANCE REPORT');
            
            // GOVERNING BOARD OF TRUSTEES AND STAFF Title
            doc.setTextColor(0, 176, 240);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('GOVERNING BOARD OF TRUSTEES AND STAFF', margin, yPosition);
            yPosition += 20;
            
            // TABLE E.1 â€“ AGENCY GOVERNING BOARD
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(0, 176, 240);
            doc.text('TABLE E.1 â€“ AGENCY GOVERNING BOARD', margin, yPosition);
            yPosition += 15;
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('GOVERNING BOARD OF TRUSTEES', margin, yPosition);
            yPosition += 10;
            
            // Create comprehensive governing board table
            const boardData = [];
            boardData.push(['Name', 'Title']);
            
            // Collect governing board entries from indexed fields across submissions
            const firstSubmission = submissions[0];
            const maxRows = 50;
            for (let i = 0; i < maxRows; i++) {
                let name = '';
                let title = '';
                // Prefer the first non-empty across submissions
                for (const s of submissions) {
                    if (!name && s[`governingBoardName_${i}`]) name = s[`governingBoardName_${i}`];
                    if (!title && s[`governingBoardTitle_${i}`]) title = s[`governingBoardTitle_${i}`];
                    if (name && title) break;
                }
                if (name || title) {
                    boardData.push([name || 'â€”', title || 'â€”']);
                }
            }
            
            if (boardData.length > 1) {
                try {
                    doc.autoTable({
                        startY: yPosition,
                        head: [boardData[0]],
                        body: boardData.slice(1),
                        theme: 'grid',
                        headStyles: { 
                            fillColor: [0, 176, 240],
                            textColor: [255, 255, 255],
                            fontStyle: 'bold'
                        },
                        bodyStyles: { textColor: [0, 0, 0] },
                        alternateRowStyles: { fillColor: [243, 244, 246] },
                        margin: { left: margin, right: margin }
                    });
                    yPosition = doc.lastAutoTable.finalY + 20;
                } catch (error) {
                    doc.text('Governing board data not available', margin, yPosition);
                    yPosition += 20;
                }
            } else {
                doc.text('Governing board data not available', margin, yPosition);
                yPosition += 20;
            }
            
            // TABLE E.2 â€“ AGENCY STAFF
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(0, 176, 240);
            doc.text('TABLE E.2 â€“ AGENCY STAFF', margin, yPosition);
            yPosition += 15;
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('STAFF MEMBERS', margin, yPosition);
            yPosition += 10;
            
            // Create comprehensive staff table
            const staffData = [];
            staffData.push(['Name', 'Title']);
            
            // Collect staff entries from indexed fields across submissions
            for (let i = 0; i < 50; i++) {
                let name = '';
                let title = '';
                for (const s of submissions) {
                    if (!name && s[`agencyStaffName_${i}`]) name = s[`agencyStaffName_${i}`];
                    if (!title && s[`agencyStaffTitle_${i}`]) title = s[`agencyStaffTitle_${i}`];
                    if (name && title) break;
                }
                if (name || title) {
                    staffData.push([name || 'â€”', title || 'â€”']);
                }
            }
            
            if (staffData.length > 1) {
                try {
                doc.autoTable({
                        startY: yPosition,
                        head: [staffData[0]],
                        body: staffData.slice(1),
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [0, 176, 240],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    bodyStyles: { textColor: [0, 0, 0] },
                    alternateRowStyles: { fillColor: [243, 244, 246] },
                        margin: { left: margin, right: margin }
                    });
                    yPosition = doc.lastAutoTable.finalY + 20;
                } catch (error) {
                    doc.text('Staff data not available', margin, yPosition);
                    yPosition += 20;
                }
            } else {
                doc.text('Staff data not available', margin, yPosition);
                yPosition += 20;
            }
            
            // Add footer
            addReportFooter(doc);
        }

        function addCombinedBudgetSection(doc, submissions) {
            doc.addPage();
            
            const margin = 20;
            let yPosition = 30;
            
            // Add header
            addReportHeader(doc, 'ANNUAL JUNE 30TH COMPLIANCE REPORT');
            
            // SUMMARY OF TAX INCREMENT REVENUES AND EXPENDITURES Title
            doc.setTextColor(0, 176, 240);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('SUMMARY OF TAX INCREMENT REVENUES AND EXPENDITURES', margin, yPosition);
            yPosition += 20;
            
            // TABLE E.3 â€“ COMBINED AGENCY BUDGET
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(0, 176, 240);
            doc.text('TABLE E.3 â€“ COMBINED AGENCY BUDGET', margin, yPosition);
            yPosition += 15;
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('COMBINED TAX INCREMENT BUDGET â€“ AGENCY', margin, yPosition);
            yPosition += 15;
            
            // Create COMBINED TAX REVENUE table
            const revenueData = [];
            revenueData.push(['DESCRIPTION', 'CURRENT YEAR', 'NEXT YEAR PROJECTED', 'NEXT YEAR+1 PROJECTED', 'AUTHORIZED AMOUNT REMAINING']);
            
            // Add individual project area revenues
            let totalCurrent = 0, totalNext = 0, totalFollowing = 0, totalRemaining = 0;
            
            submissions.forEach((submission, index) => {
                // Use the most descriptive name available - prioritize actual project area names
                let projectArea = submission.projectAreaName || submission.projectArea;
                
                // If no project area name, use submitter name (like "Redhawks CDA")
                if (!projectArea) {
                    projectArea = submission.submitterName || submission.cityCounty;
                }
                
                // Only use generic name as absolute last resort
                if (!projectArea) {
                    projectArea = `Project Area #${index + 1}`;
                }
                
                // Get revenue data from the actual form fields
                let current = 0, next = 0, following = 0, remaining = 0;
                
                // Sum up all revenue sources for this project area
                for (let i = 0; i < 20; i++) {
                    const actual2025 = parseFloat(submission[`revenueSource2025Actual_${i}`] || 0);
                    const forecast2026 = parseFloat(submission[`revenueSource2026Forecast_${i}`] || 0);
                    const forecast2027 = parseFloat(submission[`revenueSource2027Forecast_${i}`] || 0);
                    
                    current += actual2025;
                    next += forecast2026;
                    following += forecast2027;
                }
                
                // Get remaining revenue
                remaining = parseFloat(submission.aggregateRemainingRevenue || 0);
                
                totalCurrent += current;
                totalNext += next;
                totalFollowing += following;
                totalRemaining += remaining;
                
                revenueData.push([
                    `${projectArea} - Revenue`,
                    `$${current.toLocaleString()}`,
                    `$${next.toLocaleString()}`,
                    `$${following.toLocaleString()}`,
                    `$${remaining.toLocaleString()}`
                ]);
            });
            
            // Add total revenue row
            revenueData.push([
                'TOTAL REVENUE',
                `$${totalCurrent.toLocaleString()}`,
                `$${totalNext.toLocaleString()}`,
                `$${totalFollowing.toLocaleString()}`,
                `$${totalRemaining.toLocaleString()}`
            ]);
            
            try {
                doc.autoTable({
                    startY: yPosition,
                    head: [revenueData[0]],
                    body: revenueData.slice(1),
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [0, 176, 240],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    bodyStyles: { textColor: [0, 0, 0] },
                    alternateRowStyles: { fillColor: [243, 244, 246] },
                    margin: { left: margin, right: margin }
                });
                yPosition = doc.lastAutoTable.finalY + 20;
            } catch (error) {
                doc.text('Revenue data not available', margin, yPosition);
                yPosition += 20;
            }
            
            // Add COMBINED EXPENSES table
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('COMBINED EXPENSES', margin, yPosition);
            yPosition += 15;
            
            const expenseData = [];
            expenseData.push(['DESCRIPTION', 'CURRENT YEAR', 'NEXT YEAR PROJECTED', 'NEXT YEAR+1 PROJECTED', 'AUTHORIZED AMOUNT REMAINING']);
            
            // Collect all expense types across all project areas
            const expenseTypes = new Map();
            console.log('Generating expense table for submissions:', submissions.length);
            
            submissions.forEach(submission => {
                // Get all expense fields using the actual field names
                for (let i = 0; i < 20; i++) {
                    const expenseDesc = submission[`expenseTitle_${i}`];
                    const expenseCurrent = parseFloat(submission[`tyExpense_${i}`] || 0);
                    const expenseNext = parseFloat(submission[`cyExpense_${i}`] || 0);
                    const expenseFollowing = parseFloat(submission[`nyExpense_${i}`] || 0);
                    
                    if (expenseDesc && (expenseCurrent > 0 || expenseNext > 0 || expenseFollowing > 0)) {
                        if (!expenseTypes.has(expenseDesc)) {
                            expenseTypes.set(expenseDesc, { current: 0, next: 0, following: 0, remaining: 0 });
                        }
                        const current = expenseTypes.get(expenseDesc);
                        current.current += expenseCurrent;
                        current.next += expenseNext;
                        current.following += expenseFollowing;
                    }
                }
                
                // Also get total expenses
                const totalExpense = parseFloat(submission.totalAggregateExpense || 0);
                if (totalExpense > 0) {
                    if (!expenseTypes.has('Total Expenses')) {
                        expenseTypes.set('Total Expenses', { current: 0, next: 0, following: 0, remaining: 0 });
                    }
                    const current = expenseTypes.get('Total Expenses');
                    current.current += totalExpense;
                }
            });
            
            // Add expense types to table
            expenseTypes.forEach((values, expense) => {
                expenseData.push([
                    expense,
                    `$${values.current.toLocaleString()}`,
                    `$${values.next.toLocaleString()}`,
                    `$${values.following.toLocaleString()}`,
                    `$${values.remaining.toLocaleString()}`
                ]);
            });
            
            // Add expense totals
            const totalExpenseCurrent = Array.from(expenseTypes.values()).reduce((sum, v) => sum + v.current, 0);
            const totalExpenseNext = Array.from(expenseTypes.values()).reduce((sum, v) => sum + v.next, 0);
            const totalExpenseFollowing = Array.from(expenseTypes.values()).reduce((sum, v) => sum + v.following, 0);
            const totalExpenseRemaining = Array.from(expenseTypes.values()).reduce((sum, v) => sum + v.remaining, 0);
            
            expenseData.push([
                'TOTAL EXPENSES',
                `$${totalExpenseCurrent.toLocaleString()}`,
                `$${totalExpenseNext.toLocaleString()}`,
                `$${totalExpenseFollowing.toLocaleString()}`,
                `$${totalExpenseRemaining.toLocaleString()}`
            ]);
            
            try {
                doc.autoTable({
                    startY: yPosition,
                    head: [expenseData[0]],
                    body: expenseData.slice(1),
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [0, 176, 240],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    bodyStyles: { textColor: [0, 0, 0] },
                    alternateRowStyles: { fillColor: [243, 244, 246] },
                    margin: { left: margin, right: margin }
                });
                yPosition = doc.lastAutoTable.finalY + 20;
            } catch (error) {
                doc.text('Expense data not available', margin, yPosition);
                yPosition += 20;
            }
            
            // Acreage overview section is handled separately in addAcreageOverviewSection
            
            
            // Add footer
            addReportFooter(doc);
        }

        function addAcreageOverviewSection(doc, submissions) {
            doc.addPage();
            
            const margin = 20;
            let yPosition = 30;
            
            // Title
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('GENERAL OVERVIEW OF PROJECT AREAS AND ACREAGE', margin, yPosition);
            yPosition += 20;
            
            // Acreage Table
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('TABLE E.4 â€“ ACREAGE (DEVELOPED, UNDEVELOPED, AND RESIDENTIAL)', margin, yPosition);
            yPosition += 10;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('ACREAGE (DEVELOPED, UNDEVELOPED, AND RESIDENTIAL)', margin, yPosition);
            yPosition += 10;
            
            // Create acreage table
            const acreageData = [];
            acreageData.push(['PROJECT AREA', 'DEVELOPED', 'UNDEVELOPED', 'RESIDENTIAL', '% RESIDENTIAL', 'AUTHORIZED HOUSING UNITS #']);
            
            let totalDeveloped = 0, totalUndeveloped = 0, totalResidential = 0, totalHousingUnits = 0;
            
            submissions.forEach((submission, index) => {
                // Use the most descriptive name available - prioritize actual project area names
                let projectArea = submission.projectAreaName || submission.projectArea;
                
                // If no project area name, use submitter name (like "Redhawks CDA")
                if (!projectArea) {
                    projectArea = submission.submitterName || submission.cityCounty;
                }
                
                // Only use generic name as absolute last resort
                if (!projectArea) {
                    projectArea = `Project Area #${index + 1}`;
                }
                const developed = parseFloat(submission.developedAcreage || 0);
                const undeveloped = parseFloat(submission.undevelopedAcreage || 0);
                const residential = parseFloat(submission.residentialAcreage || 0);
                const housingUnits = parseFloat(submission.authorizedHousingUnits || 0);
                
                const totalAcreage = developed + undeveloped;
                const residentialPercentage = totalAcreage > 0 ? ((residential / totalAcreage) * 100).toFixed(1) : '0.0';
                
                acreageData.push([
                    projectArea,
                    developed.toFixed(2),
                    undeveloped.toFixed(2),
                    residential.toFixed(2),
                    `${residentialPercentage}%`,
                    housingUnits.toString()
                ]);
                
                totalDeveloped += developed;
                totalUndeveloped += undeveloped;
                totalResidential += residential;
                totalHousingUnits += housingUnits;
            });
            
            // Add totals
            const totalAcreage = totalDeveloped + totalUndeveloped;
            const totalResidentialPercentage = totalAcreage > 0 ? ((totalResidential / totalAcreage) * 100).toFixed(1) : '0.0';
            
            acreageData.push([
                'Total',
                totalDeveloped.toFixed(2),
                totalUndeveloped.toFixed(2),
                totalResidential.toFixed(2),
                `${totalResidentialPercentage}%`,
                totalHousingUnits.toString()
            ]);
            
            try {
                doc.autoTable({
                    startY: yPosition,
                    head: [acreageData[0]],
                    body: acreageData.slice(1),
                    theme: 'grid',
                    headStyles: { fillColor: [0, 176, 240], textColor: [255,255,255] },
                    bodyStyles: { textColor: [0, 0, 0] },
                    margin: { left: margin, right: margin }
                });
            } catch (error) {
                doc.text('Acreage data not available', margin, yPosition);
            }
        }

        function addIndividualProjectSections(doc, submissions) {
            submissions.forEach((submission, index) => {
                const projectNumber = index + 1;
                
                // PROJECT AREA HEADER PAGE
                addProjectAreaHeader(doc, projectNumber, submission);
                
                // PROJECT AREA OVERVIEW PAGE
                addProjectAreaOverview(doc, submission, projectNumber);
                
                // FUND ACCOUNTABILITY PAGE
                addFundAccountability(doc, submission, projectNumber);
                
                // PROJECT AREA DEVELOPMENT PAGE
                addProjectAreaDevelopment(doc, submission, projectNumber);
                
                // PROJECT AREA MAP PAGE
                addProjectAreaMap(doc, projectNumber);
            });
        }

        function addProjectAreaHeader(doc, projectNumber, submission) {
            doc.addPage();
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            
            // Black background
            doc.setFillColor(0, 0, 0);
            doc.rect(0, 0, pageWidth, pageHeight, 'F');
            
            // Get the actual project area name
            let projectArea = submission.projectAreaName || submission.projectArea;
            
            // If no project area name, use submitter name (like "Redhawks CDA")
            if (!projectArea) {
                projectArea = submission.submitterName || submission.cityCounty;
            }
            
            // Only use generic name as absolute last resort
            if (!projectArea) {
                projectArea = `Project Area #${projectNumber}`;
            }
            
            // Blue text centered
            doc.setTextColor(0, 176, 240);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text(projectArea.toUpperCase(), pageWidth / 2, pageHeight / 2 - 10, { align: 'center' });
            
            // Gray underline
            doc.setDrawColor(211, 211, 211);
            doc.setLineWidth(2);
            const lineWidth = pageWidth * 0.8;
            const lineX = (pageWidth - lineWidth) / 2;
            const lineY = pageHeight / 2 + 15;
            doc.line(lineX, lineY, lineX + lineWidth, lineY);
        }

        function addProjectAreaOverview(doc, submission, projectNumber) {
            doc.addPage();
            
            const margin = 20;
            const pageWidth = doc.internal.pageSize.getWidth();
            let yPosition = 30;
            
            // Add header
            addReportHeader(doc, 'ANNUAL JUNE 30TH COMPLIANCE REPORT');
            
            // Main title - use actual project area name
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            
            // Get the actual project area name
            let projectArea = submission.projectAreaName || submission.projectArea;
            
            // If no project area name, use submitter name (like "Redhawks CDA")
            if (!projectArea) {
                projectArea = submission.submitterName || submission.cityCounty;
            }
            
            // Only use generic name as absolute last resort
            if (!projectArea) {
                projectArea = `Project Area #${projectNumber}`;
            }
            
            doc.text(projectArea.toUpperCase(), margin, yPosition - 8);
            yPosition -= 6; // Move line up by 5mm
            
            // Add black horizontal line under the title (0.5mm thick)
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.5);
            doc.line(margin, yPosition, pageWidth - margin, yPosition);
            yPosition += 14; // Space after line
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('OVERVIEW OF PROJECT AREA', margin, yPosition + 5); // Move down 5mm
            yPosition += 25; // Increased spacing to account for the move
            
            // TABLE 1 - OVERVIEW OF PROJECT AREA
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(136, 136, 136); // Medium light gray
            doc.text('TABLE 1 â€“ OVERVIEW OF PROJECT AREA', margin, yPosition + 5); // Move 5mm down
            yPosition += 10; // Reduced spacing
            
            // Reset text color to black for table content
            doc.setTextColor(0, 0, 0);
            
            // Create comprehensive overview table
            const overviewData = [];
            
            // Section 1: General Info
            overviewData.push(['TYPE', 'ACREAGE', 'OVERVIEW PURPOSE', 'TAXING DISTRICT', 'TAX RATE 2024']);
            const type = submission.projectType || 'RDA';
            const acreage = parseFloat(submission.developedAcreage || 0) + parseFloat(submission.undevelopedAcreage || 0);
            const purpose = submission.projectPurpose || 'Commercial Development';
            const taxingDistrict = submission.taxingDistrict || '55A';
            const taxRate = submission.taxRate2024 || '0.008925';
            
            overviewData.push([type, acreage.toFixed(2), purpose, taxingDistrict, taxRate]);
            
            // Section 2: Project Area Funds Collection Period
            overviewData.push(['PROJECT AREA FUNDS COLLECTION PERIOD', '', '', '', '']);
            overviewData.push(['CREATION YEAR', 'BASE YEAR', 'TERM', 'START YEAR', 'EXPIRATION YEAR']);
            const creationYear = submission.creationYear || '1989';
            const baseYear = submission.baseYear || '1989';
            const term = submission.term || '32 Years';
            const startYear = submission.startYear || 'FY 1994';
            const expirationYear = submission.expirationYear || 'FY 2025';
            
            overviewData.push([creationYear, baseYear, term, startYear, expirationYear]);
            
            // Section 3: Financial Metrics
            overviewData.push(['BASE TAXABLE VALUE', 'CURRENT TAXABLE VALUE', 'ASSESSED VALUE INCREASE (%)', 'CURRENT YEAR TAX INCREMENT', 'REMAINING LIFE']);
            const baseValue = parseFloat(submission.baseTaxableValue || 609648);
            const currentValue = parseFloat(submission.currentTaxableValue || 138913478);
            const increasePercent = ((currentValue - baseValue) / baseValue * 100).toFixed(0);
            const currentIncrement = parseFloat(submission.currentYearRevenue || 623751);
            const remainingLife = submission.remainingLife || '0 Years';
            
            overviewData.push([
                `$${baseValue.toLocaleString()}`,
                `$${currentValue.toLocaleString()}`,
                `${increasePercent}%`,
                `$${currentIncrement.toLocaleString()}`,
                remainingLife
            ]);
            
            try {
                doc.autoTable({
                    startY: yPosition,
                    head: [overviewData[0]],
                    body: overviewData.slice(1),
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [0, 176, 240],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    bodyStyles: { textColor: [0, 0, 0] },
                    alternateRowStyles: { fillColor: [243, 244, 246] },
                    margin: { left: margin, right: margin }
                });
                yPosition = doc.lastAutoTable.finalY + 20;
            } catch (error) {
                doc.text('Overview data not available', margin, yPosition);
                yPosition += 20;
            }
            
            // Add narrative text
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const narrativeText = `The "CRA" was created in ${creationYear} with a base year of "${baseYear}", with a value of "$${baseValue.toLocaleString()}". Since that time, the assessed value of the project area has increased to "$${currentValue.toLocaleString()}". This has been a growth of over "${increasePercent}%" in assessed value. The growth is thanks to developments in a new tech headquarters...`;
            
            const splitText = doc.splitTextToSize(narrativeText, 170);
            doc.text(splitText, margin, yPosition);
            yPosition += splitText.length * 5 + 15;
            
            // Add bullet points
            const bulletPoints = [
                'Including: Number of residential units, amount of sqft of commercial, industrial, and institutional development, number of jobs, and any other economic strength indicators within the project area.',
                'Named recent developments (developments that have made progress)',
                'THIS SECTION SHOULD BE A BRIEF OVERVIEW OF THE REPORT.'
            ];
            
            bulletPoints.forEach(point => {
                doc.text(`â€¢ ${point}`, margin + 10, yPosition);
                yPosition += 8;
            });
            
            yPosition += 15;
            
            // Add interlocal agreements text
            const interlocalText = 'Interlocal Cooperation Agreements or Interlocal Agreements are agreements made between the Agency and taxing entities, which permit the Agency to collect all or a portion of the property tax increment generated by the project area. Table 2 below summarizes the terms and conditions of each interlocal agreement.';
            
            const splitInterlocalText = doc.splitTextToSize(interlocalText, 170);
            doc.text(splitInterlocalText, margin, yPosition);
            yPosition += splitInterlocalText.length * 5 + 15;
            
            // TABLE 2 - SUMMARY OF INTERLOCAL AGREEMENTS
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(136, 136, 136); // Medium light gray
            doc.text('TABLE 2 â€“ SUMMARY OF INTERLOCAL AGREEMENTS', margin, yPosition + 5); // Move 5mm down
            yPosition += 10; // Reduced spacing
            
            // Reset text color to black for table content
            doc.setTextColor(0, 0, 0);
            
            const interlocalData = [];
            interlocalData.push(['INTERLOCAL AGREEMENT SUMMARY', '', '', '', '']);
            interlocalData.push(['ENTITY', '% OF TAX INCREMENT', 'REMITTANCE', 'CAP AMOUNTS', 'LENGTH']);
            
            // Add interlocal agreement data
            const entities = [
                { name: 'Salt Lake County', percent: '70%', remittance: '-%', cap: '$-', length: '12 Years' },
                { name: 'Canyons School District', percent: '75%', remittance: '-', cap: '-', length: '12 Years' },
                { name: 'Draper City', percent: '75%', remittance: '-', cap: '-', length: '' },
                { name: 'South Salt Lake Mosquito Abatement District', percent: '75%', remittance: '-', cap: '-', length: '' },
                { name: 'Jordan Valley Water Conservancy District', percent: '75%', remittance: '-', cap: '-', length: '' },
                { name: 'South Valley Sewer District', percent: '75%', remittance: '-', cap: '-', length: '' },
                { name: 'Central Utah Water Conservancy District', percent: '70%', remittance: '-', cap: '-', length: '' },
                { name: 'Salt Lake County Library', percent: '70%', remittance: '-', cap: '-', length: '' }
            ];
            
            entities.forEach(entity => {
                interlocalData.push([entity.name, entity.percent, entity.remittance, entity.cap, entity.length]);
            });
            
            interlocalData.push(['Total', '-%', '$-', '', '']);
            
            try {
                doc.autoTable({
                    startY: yPosition,
                    head: [interlocalData[0]],
                    body: interlocalData.slice(1),
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [0, 176, 240],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    bodyStyles: { textColor: [0, 0, 0] },
                    alternateRowStyles: { fillColor: [243, 244, 246] },
                    margin: { left: margin, right: margin }
                });
            } catch (error) {
                doc.text('Interlocal agreement data not available', margin, yPosition);
            }
            
            // Add footer
            addReportFooter(doc);
        }

        function addFundAccountability(doc, submission, projectNumber) {
            doc.addPage();
            
            const margin = 20;
            let yPosition = 45; // Moved down 15mm from 30
            
            // Add header
            addReportHeader(doc, 'ANNUAL JUNE 30TH COMPLIANCE REPORT');
            
            // TABLE 3 - SOURCES OF FUNDS
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(136, 136, 136); // Medium light gray
            doc.text('TABLE 3 â€“ SOURCES OF FUNDS', margin, yPosition + 5); // Move 5mm down
            
            // FUND ACCOUNTABILITY - positioned 5mm above TABLE 3
            doc.text('FUND ACCOUNTABILITY', margin, yPosition - 5); // 5mm above TABLE 3
            yPosition += 10; // Reduced spacing
            
            // Reset text color to black for table content
            doc.setTextColor(0, 0, 0);
            
            const sourcesData = [];
            sourcesData.push(['2025 SOURCES OF FUNDS', '2026 FORECASTED', '2027 FORECASTED']);
            sourcesData.push(['2025 ACTUAL', '2026 FORECASTED', '2027 FORECASTED']);
            
            const propTax2025 = parseFloat(submission.propertyTax2025 || submission.currentYearRevenue || 4116081);
            const propTax2026 = parseFloat(submission.propertyTax2026 || submission.nextYearRevenue || 4200000);
            const propTax2027 = parseFloat(submission.propertyTax2027 || submission.followingYearRevenue || 4400000);
            
            sourcesData.push([
                `$${propTax2025.toLocaleString()}`,
                `$${propTax2026.toLocaleString()}`,
                `$${propTax2027.toLocaleString()}`
            ]);
            sourcesData.push(['Property Tax Increment', '', '']);
            sourcesData.push([
                `$${propTax2025.toLocaleString()}`,
                '',
                ''
            ]);
            sourcesData.push(['Total Sources of Funds', '', '']);
            
            try {
                doc.autoTable({
                    startY: yPosition,
                    head: [sourcesData[0]],
                    body: sourcesData.slice(1),
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [0, 176, 240],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    bodyStyles: { textColor: [0, 0, 0] },
                    alternateRowStyles: { fillColor: [243, 244, 246] },
                    margin: { left: margin, right: margin }
                });
                yPosition = doc.lastAutoTable.finalY + 20;
            } catch (error) {
                doc.text('Sources of funds data not available', margin, yPosition);
                yPosition += 20;
            }
            
            // TABLE 4 - USES OF FUNDS
            // Build expenses array from individual fields (expenseTitle_0, tyExpense_0, etc.)
            let expensesArray = [];
            if (submission.expenses && submission.expenses.length > 0) {
                expensesArray = submission.expenses;
            } else {
                // Build from individual fields used in external form
                for (let i = 0; i < 20; i++) {
                    const title = submission[`expenseTitle_${i}`];
                    const tyExpense = submission[`tyExpense_${i}`];
                    const cyExpense = submission[`cyExpense_${i}`];
                    const nyExpense = submission[`nyExpense_${i}`];
                    
                    if (title || tyExpense || cyExpense || nyExpense) {
                        expensesArray.push({
                            title: title || '',
                            tyExpense: tyExpense || '',
                            cyExpense: cyExpense || '',
                            nyExpense: nyExpense || ''
                        });
                    }
                }
            }
            
            if (expensesArray.length > 0) {
                // Check if we need a new page
                if (yPosition > 250) {
                    doc.addPage();
                    addReportHeader(doc, 'ANNUAL JUNE 30TH COMPLIANCE REPORT');
                    yPosition = 45;
                }
                
                // Table title
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(136, 136, 136); // Medium light gray
                doc.text('TABLE 4 â€“ USES OF FUNDS', margin, yPosition);
                yPosition += 10;
                
                // Reset text color to black for table content
                doc.setTextColor(0, 0, 0);
                
                // Build table data
                const usesData = [];
                usesData.push(['Expense Title', 'TY Expense', 'CY Expense', 'NY Expense']);
                
                let totalTY = 0;
                let totalCY = 0;
                let totalNY = 0;
                
                expensesArray.forEach(expense => {
                    const tyExpense = parseFloat(expense.tyExpense || 0);
                    const cyExpense = parseFloat(expense.cyExpense || 0);
                    const nyExpense = parseFloat(expense.nyExpense || 0);
                    
                    totalTY += tyExpense;
                    totalCY += cyExpense;
                    totalNY += nyExpense;
                    
                    usesData.push([
                        expense.title || '',
                        `$${tyExpense.toLocaleString()}`,
                        `$${cyExpense.toLocaleString()}`,
                        `$${nyExpense.toLocaleString()}`
                    ]);
                });
                
                // Add totals row
                usesData.push([
                    'TOTAL USES OF FUNDS',
                    `$${totalTY.toLocaleString()}`,
                    `$${totalCY.toLocaleString()}`,
                    `$${totalNY.toLocaleString()}`
                ]);
                
                try {
                    const bodyData = usesData.slice(1);
                    const totalsRowIndex = bodyData.length - 1;
                    
                    doc.autoTable({
                        startY: yPosition,
                        head: [usesData[0]],
                        body: bodyData,
                        theme: 'grid',
                        headStyles: { 
                            fillColor: [0, 176, 240],
                            textColor: [255, 255, 255],
                            fontStyle: 'bold'
                        },
                        bodyStyles: { textColor: [0, 0, 0] },
                        alternateRowStyles: { fillColor: [243, 244, 246] },
                        margin: { left: margin, right: margin },
                        didParseCell: function(data) {
                            // Make the totals row bold and with background color
                            if (data.row.index === totalsRowIndex) {
                                data.cell.styles.fontStyle = 'bold';
                                data.cell.styles.fillColor = [233, 236, 239]; // Light gray background like Sources table
                            }
                        }
                    });
                    yPosition = doc.lastAutoTable.finalY + 20;
                } catch (error) {
                    doc.text('Uses of funds data not available', margin, yPosition);
                    yPosition += 20;
                }
            }
            
            // PLANNED USES FOR FUND BALANCE section
            if (submission.plannedUsesFundBalance) {
                // Check if we need a new page
                if (yPosition > 250) {
                    doc.addPage();
                    addReportHeader(doc, 'ANNUAL JUNE 30TH COMPLIANCE REPORT');
                    yPosition = 45;
                }
                
                // Section title
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(136, 136, 136); // Medium light gray
                doc.text('PLANNED USES FOR FUND BALANCE', margin, yPosition);
                yPosition += 10;
                
                // Reset text color and font for content
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                
                // Split the text into lines that fit the page width
                const maxWidth = doc.internal.pageSize.getWidth() - (margin * 2);
                const plannedUsesText = submission.plannedUsesFundBalance || 'N/A';
                const splitText = doc.splitTextToSize(plannedUsesText, maxWidth);
                
                // Add the text
                splitText.forEach((line, index) => {
                    // Check if we need a new page
                    if (yPosition > 270) {
                        doc.addPage();
                        addReportHeader(doc, 'ANNUAL JUNE 30TH COMPLIANCE REPORT');
                        yPosition = 45;
                    }
                    doc.text(line, margin, yPosition);
                    yPosition += 6; // Line spacing
                });
                
                yPosition += 10; // Extra spacing after the section
            }
            
            // Add footer
            addReportFooter(doc);
        }

        function addProjectAreaDevelopment(doc, submission, projectNumber) {
            doc.addPage();
            
            const margin = 20;
            let yPosition = 40; // Moved down 10mm from 30
            
            // Add header
            addReportHeader(doc, 'ANNUAL JUNE 30TH COMPLIANCE REPORT');
            
            // Main title
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('PROJECT AREA DEVELOPMENT', margin, yPosition);
            yPosition += 15;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('Mentioning of development of the project area. Acreage both developed and undeveloped, etc.', margin, yPosition);
            yPosition += 20;
            
            // TABLE 8 - ACREAGE
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(136, 136, 136); // Medium light gray
            doc.text('TABLE 8 â€“ ACREAGE', margin, yPosition + 5); // Move 5mm down
            yPosition += 10; // Reduced spacing
            
            // Reset text color to black for table content
            doc.setTextColor(0, 0, 0);
            
            const acreageData = [];
            acreageData.push(['ACREAGE (DEVELOPED, UNDEVELOPED, AND RESIDENTIAL)', '', '', '', '']);
            acreageData.push(['DEVELOPED', 'UNDEVELOPED', 'RESIDENTIAL', '% RESIDENTIAL', 'AUTHORIZED HOUSING UNITS #']);
            
            const developed = parseFloat(submission.developedAcreage || 232.08);
            const undeveloped = parseFloat(submission.undevelopedAcreage || 67.05);
            const residential = parseFloat(submission.residentialAcreage || 39.67);
            const housingUnits = parseFloat(submission.authorizedHousingUnits || 400);
            const totalAcreage = developed + undeveloped;
            const residentialPercent = totalAcreage > 0 ? ((residential / totalAcreage) * 100).toFixed(1) : '0.0';
            
            acreageData.push([
                developed.toFixed(2),
                undeveloped.toFixed(2),
                residential.toFixed(2),
                `${residentialPercent}%`,
                housingUnits.toString()
            ]);
            
            try {
                doc.autoTable({
                    startY: yPosition,
                    head: [acreageData[0]],
                    body: acreageData.slice(1),
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [0, 176, 240],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    bodyStyles: { textColor: [0, 0, 0] },
                    alternateRowStyles: { fillColor: [243, 244, 246] },
                    margin: { left: margin, right: margin }
                });
                yPosition = doc.lastAutoTable.finalY + 20;
            } catch (error) {
                doc.text('Acreage data not available', margin, yPosition);
                yPosition += 20;
            }
            
            // Add development narrative
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('This project area has had 20,000 square feet of commercial development. In addition to this, the following businesses have opened:', margin, yPosition);
            yPosition += 15;
            
            const businesses = ['Jimmy John\'s', 'Johnny Jim\'s', 'Jersey Mikes', 'Mikey Jerse\'s'];
            businesses.forEach(business => {
                doc.text(`â€¢ ${business}`, margin + 10, yPosition);
                yPosition += 8;
            });
            
            yPosition += 20;
            
            // PROGRESS PURSUANT TO PLAN
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('PROGRESS PURSUANT TO PLAN', margin, yPosition);
            yPosition += 15;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('The plan outlined the.... The plan has been furthered through the...', margin, yPosition);
            yPosition += 20;
            
            // OTHER ISSUES
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('OTHER ISSUES', margin, yPosition);
            yPosition += 15;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('Any other issues worth mentioning...', margin, yPosition);
            
            // Add footer
            addReportFooter(doc);
        }

        function addProjectAreaMap(doc, projectNumber) {
            doc.addPage();
            
            const margin = 20;
            let yPosition = 30;
            
            // Add header
            addReportHeader(doc, 'ANNUAL JUNE 30TH COMPLIANCE REPORT');
            
            // Main title
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('PROJECT AREA MAP', margin, yPosition);
            yPosition += 20;
            
            // Add placeholder text
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('[Project Area Map Placeholder]', margin, yPosition);
            
            // Add footer
            addReportFooter(doc);
        }

        // PDFMake versions of remaining functions - simplified working versions
        function addExecutiveSummaryIntroPDFMake(docDefinition) {
            // Direct conversion from jsPDF - black background with centered blue text
            // All elements must be on the same page using absolute positioning
            const pageWidth = 612; // Letter width in points
            const pageHeight = 792; // Letter height in points
            
            // Calculate center positions
            const centerY = pageHeight / 2;
            const textY = centerY - 10;
            // 5mm = 14.17 points (1mm = 2.83465 points)
            const lineY = centerY + 15 + 14.17;
            const lineWidth = pageWidth * 0.8;
            const lineX1 = (pageWidth - lineWidth) / 2;
            const lineX2 = lineX1 + lineWidth;
            
            // Push all elements as a single stack with pageBreak to ensure they stay together
            // Use absolutePosition for all elements so they render on the same page
            docDefinition.content.push({
                pageBreak: 'before',
                footer: null, // No footer on intro pages
                stack: [
                    // Black background covering entire page
                    {
                        canvas: [{
                            type: 'rect',
                            x: 0,
                            y: 0,
                            w: pageWidth,
                            h: pageHeight,
                            color: '#000000'
                        }],
                        absolutePosition: { x: 0, y: 0 },
                        // Set no margins for this element
                        margin: [0, 0, 0, 0]
                    },
                    // Blue text centered
                    {
                        text: 'EXECUTIVE SUMMARY',
                        fontSize: 24,
                        color: '#00B0F0',
                        bold: true,
                        alignment: 'center',
                        absolutePosition: { x: 0, y: textY },
                        width: pageWidth,
                        margin: [0, 0, 0, 0]
                    },
                    // Gray underline - canvas coordinates are relative to absolutePosition
                    {
                        canvas: [{
                            type: 'line',
                            x1: lineX1,
                            y1: 0,  // Relative to absolutePosition y
                            x2: lineX2,
                            y2: 0,  // Relative to absolutePosition y
                            lineWidth: 2,
                            lineColor: '#D3D3D3'
                        }],
                        absolutePosition: { x: 0, y: lineY },
                        margin: [0, 0, 0, 0]
                    }
                ]
            });
        }

        function addExecutiveSummaryPDFMake(docDefinition, city, submissions) {
            // Direct conversion from jsPDF with all content - optimized to fit on one page
            const headerContent = [];
            const bodyContent = [];
            
            // Header (blue bar at top) - full width
            headerContent.push({
                canvas: [{
                    type: 'rect',
                    x: -40,
                    y: -60,
                    w: 612 + 80,
                    h: 30 + 60,
                    color: '#00B0F0'
                }]
            });
            
            // Title section - full width
            headerContent.push({
                stack: [
                    { text: 'EXECUTIVE SUMMARY', fontSize: 16, bold: true, color: '#000000', margin: [40, 3, 40, 0] },
                    {
                        canvas: [{
                            type: 'line',
                            x1: 40,
                            y1: 0,
                            x2: 572,
                            y2: 0,
                            lineWidth: 0.5,
                            lineColor: '#000000'
                        }],
                        margin: [0, 1, 0, 2]
                    }
                ]
            });
            
            // Get project area names
            const projectAreaNames = submissions.map((submission, index) => {
                let projectArea = submission.projectAreaName || submission.projectArea;
                if (!projectArea) {
                    projectArea = submission.submitterName || submission.cityCounty;
                }
                if (!projectArea) {
                    projectArea = `Project Area #${index + 1}`;
                }
                return projectArea;
            });
            
            // All body content - very compact
            // INTRODUCTION Section
            bodyContent.push({
                text: 'INTRODUCTION',
                fontSize: 12,
                bold: true,
                color: '#00B0F0',
                margin: [40, 2, 40, 1]
            });
            
            const introText = `LRB Public Finance Advisors, Inc ("LRB") has been retained by the ${city} Agency of ${city}, Utah (the "Agency") to assist with the management and reporting requirements of the Agency's ${submissions.length} project areas:`;
            bodyContent.push({
                text: introText,
                fontSize: 9,
                color: '#000000',
                margin: [40, 0, 40, 2],
                lineHeight: 1.2
            });
            
            // Project area list
            const projectAreaList = projectAreaNames.map(name => ({ text: `â€¢ ${name}`, fontSize: 9, color: '#000000', margin: [50, 0, 40, 0], lineHeight: 1.1 }));
            bodyContent.push({ stack: projectAreaList });
            
            // Purpose paragraphs
            const purposeText = `The purpose of this report, in part, is to fulfill the requirements of Utah Code section 17C-1-603 â€“ Reporting requirements â€“ Governor's Office of Economic Opportunity to maintain a database and related reports. As new reporting requirements were adopted in legislation and became effective in 2011 and again revised and updated in 2016, 2019, 2022, and 2025, this report facilitates the Agency's compliance with the current state code, providing the data necessary to fulfill the Agency report requirements. The Agency has submitted all required information into the GOEO database and is providing this Annual Report for further transparency to the public and taxing entities, and to update the Agency Board on the status and activities within each project area.`;
            bodyContent.push({
                text: purposeText,
                fontSize: 9,
                color: '#000000',
                margin: [40, 2, 40, 2],
                lineHeight: 1.2
            });
            
            const purposeText2 = `This annual report is for informational purposes only and does not alter the amount of project area funds that the Agency is authorized to receive from each Project Area. This report is intended to provide an overview of each Project Area that lies within the boundaries of the Agency, including descriptions of each Project Area, significant activities, project timelines, actual and estimated tax increment collections, and any other information pertinent to the taxing entities.`;
            bodyContent.push({
                text: purposeText2,
                fontSize: 9,
                color: '#000000',
                margin: [40, 0, 40, 3],
                lineHeight: 1.2
            });
            
            // SUMMARY OF 17C-1-603 Section
            bodyContent.push({
                text: 'SUMMARY OF 17C-1-603. REPORTING REQUIREMENTS â€“ GOVERNOR\'S OFFICE OF ECONOMIC OPPORTUNITY TO MAINTAIN A DATABASE.',
                fontSize: 12,
                bold: true,
                color: '#00B0F0',
                margin: [40, 2, 40, 1]
            });
            
            bodyContent.push({
                text: `Utah State Code 17C-1-603 sets out the annual reporting requirements for community reinvestment agencies. Under this section:`,
                fontSize: 9,
                color: '#000000',
                margin: [40, 0, 40, 1],
                lineHeight: 1.2
            });
            
            // Requirements bullet points
            const requirements = [
                'Agencies must submit annual reports by June 30 for each active project area, providing detailed financial and project information, such as:',
                'Amounts and estimates of project area funds received and to be received.',
                'Project budgets and analyses of receipts and expenditures.',
                'Maps of the project area and descriptions of progress toward project goals.',
                'Agencies with no active project areas must still submit a report confirming their status until the agency is dissolved.',
                'The Governor\'s Office of Economic Opportunity must maintain a public database of the submitted data and prepare an annual report for legislative review.',
                'Noncompliance can lead to financial penalties, including withholding a portion of the agency\'s tax increment funds.',
                'The report is informational and does not alter the total funds the agency is entitled to collect.'
            ];
            
            requirements.forEach(req => {
                bodyContent.push({
                    text: `â€¢ ${req}`,
                    fontSize: 8,
                    color: '#000000',
                    margin: [50, 0, 40, 0],
                    lineHeight: 1.1
                });
            });
            
            // OVERVIEW OF AGENCY Section
            bodyContent.push({
                text: 'OVERVIEW OF AGENCY (CRA/CDRA/RDA)',
                fontSize: 12,
                bold: true,
                color: '#00B0F0',
                margin: [40, 3, 40, 1]
            });
            
            const agencyText = `A Community Reinvestment Agency (CRA), Community Development and Renewal Agency (CDRA), or Redevelopment Agency (RDA) is a special local government entity established under state law (Title 17C of the Utah Code) to help communities revitalize underused, blighted, or deteriorating areas. The main goals of these agencies are to:`;
            bodyContent.push({
                text: agencyText,
                fontSize: 9,
                color: '#000000',
                margin: [40, 0, 40, 1],
                lineHeight: 1.2
            });
            
            const goals = [
                'Encourage private and public investment in areas that have declined or are not thriving.',
                'Eliminate blight and improve infrastructure, housing, and economic opportunities within specific project areas.',
                'Promote economic development by supporting businesses, creating jobs, and expanding the local tax base.',
                'Increase the amount and variety of affordable housing in the community.'
            ];
            
            goals.forEach(goal => {
                bodyContent.push({
                    text: `â€¢ ${goal}`,
                    fontSize: 8,
                    color: '#000000',
                    margin: [50, 0, 40, 0],
                    lineHeight: 1.1
                });
            });
            
            const overviewText = `CRAs, CDRAs, or RDAs can use tools such as tax increment financing to fund and incentivize improvements and development. They are typically governed by the local city council or county commission, serving as the agency's board. These agencies play a key role in assembling land, improving public works (like roads and utilities), and stimulating private investment to bring new life to designated neighborhoods or business districts.`;
            bodyContent.push({
                text: overviewText,
                fontSize: 9,
                color: '#000000',
                margin: [40, 2, 40, 3],
                lineHeight: 1.2
            });
            
            // SUMMARY OF 17C-1-202 Section
            bodyContent.push({
                text: 'SUMMARY OF 17C-1-202. AGENCY POWERS.',
                fontSize: 12,
                bold: true,
                color: '#00B0F0',
                margin: [40, 2, 40, 1]
            });
            
            const powersIntroText = `Utah State Code 17C-1-202 outlines the powers and authorities of CRAs, CDRAs, or RDAs. This section gives agencies the following key powers:`;
            bodyContent.push({
                text: powersIntroText,
                fontSize: 9,
                color: '#000000',
                margin: [40, 0, 40, 1],
                lineHeight: 1.2
            });
            
            const powers = [
                'Sue and be sued, enter into contracts, and acquire or dispose of real and personal property.',
                'Undertake actions for urban renewal, economic development, or community development, such as receiving tax increment funds and financing projects within designated areas.',
                'Issue bonds for project financing and other agency purposes, including repaying advances or refunding previously issued bonds.',
                'Pay impact fees and other costs associated with land development.',
                'Enter into development agreements with individuals or entities specifying project details, funding amounts, and performance expectations; these agreements must be approved by the agency\'s board and must align with the goals of the project area plan.'
            ];
            
            powers.forEach(power => {
                bodyContent.push({
                    text: `â€¢ ${power}`,
                    fontSize: 8,
                    color: '#000000',
                    margin: [50, 0, 40, 0],
                    lineHeight: 1.1
                });
            });
            
            const concludingText = `The section also allows agencies to accept financial assistance from various sources, retain controls over developed land consistent with project plans, and transact any business necessary to fulfill their mission. If acquiring property outside a project area, the agency's board must find that it benefits an existing project area. All major agreements and decisions require adoption by resolution with clear findings.`;
            bodyContent.push({
                text: concludingText,
                fontSize: 9,
                color: '#000000',
                margin: [40, 3, 40, 3],
                lineHeight: 1.2
            });
            
            // Combine header and body - all in one stack to keep on one page
            const allContent = [...headerContent, ...bodyContent];
            
            docDefinition.content.push({
                pageBreak: 'before',
                stack: allContent
            });
        }

        function addGoverningBoardSectionPDFMake(docDefinition, submissions) {
            const content = [];
            
            // Header (blue bar at top)
            content.push({
                canvas: [{
                    type: 'rect',
                    x: -40,
                    y: -60,
                    w: 612 + 80,
                    h: 30 + 60,
                    color: '#00B0F0'
                }]
            });
            
            // GOVERNING BOARD OF TRUSTEES AND STAFF Title
            content.push({
                text: 'GOVERNING BOARD OF TRUSTEES AND STAFF',
                fontSize: 16,
                bold: true,
                color: '#00B0F0',
                margin: [40, 20, 40, 10]
            });
            
            // TABLE E.1 â€“ AGENCY GOVERNING BOARD
            content.push({
                text: 'TABLE E.1 â€“ AGENCY GOVERNING BOARD',
                fontSize: 14,
                bold: true,
                color: '#00B0F0',
                margin: [40, 0, 40, 5]
            });
            
            content.push({
                text: 'GOVERNING BOARD OF TRUSTEES',
                fontSize: 11,
                bold: true,
                color: '#000000',
                margin: [40, 0, 40, 10]
            });
            
            // Create comprehensive governing board table
            const boardData = [];
            boardData.push(['Name', 'Title']);
            
            // Collect governing board entries from indexed fields across submissions
            const maxRows = 50;
            for (let i = 0; i < maxRows; i++) {
                let name = '';
                let title = '';
                // Prefer the first non-empty across submissions
                for (const s of submissions) {
                    if (!name && s[`governingBoardName_${i}`]) name = s[`governingBoardName_${i}`];
                    if (!title && s[`governingBoardTitle_${i}`]) title = s[`governingBoardTitle_${i}`];
                    if (name && title) break;
                }
                if (name || title) {
                    boardData.push([name || 'â€”', title || 'â€”']);
                }
            }
            
            if (boardData.length > 1) {
                content.push({
                    table: {
                        headerRows: 1,
                        widths: ['*', '*'],
                        body: boardData,
                        fillColor: (rowIndex) => {
                            if (rowIndex === 0) return '#00B0F0';
                            return rowIndex % 2 === 0 ? '#FAFAFA' : null; // More subtle alternating colors
                        },
                        color: (rowIndex) => rowIndex === 0 ? '#FFFFFF' : '#000000'
                    },
                    layout: getImprovedTableLayout(),
                    margin: [40, 0, 40, 20]
                });
            } else {
                content.push({
                    text: 'Governing board data not available',
                    fontSize: 11,
                    color: '#000000',
                    margin: [40, 0, 40, 20]
                });
            }
            
            // TABLE E.2 â€“ AGENCY STAFF
            content.push({
                text: 'TABLE E.2 â€“ AGENCY STAFF',
                fontSize: 14,
                bold: true,
                color: '#00B0F0',
                margin: [40, 0, 40, 5]
            });
            
            content.push({
                text: 'STAFF MEMBERS',
                fontSize: 11,
                bold: true,
                color: '#000000',
                margin: [40, 0, 40, 10]
            });
            
            // Create comprehensive staff table
            const staffData = [];
            staffData.push(['Name', 'Title']);
            
            // Collect staff entries from indexed fields across submissions
            for (let i = 0; i < 50; i++) {
                let name = '';
                let title = '';
                for (const s of submissions) {
                    if (!name && s[`agencyStaffName_${i}`]) name = s[`agencyStaffName_${i}`];
                    if (!title && s[`agencyStaffTitle_${i}`]) title = s[`agencyStaffTitle_${i}`];
                    if (name && title) break;
                }
                if (name || title) {
                    staffData.push([name || 'â€”', title || 'â€”']);
                }
            }
            
            if (staffData.length > 1) {
                content.push({
                    table: {
                        headerRows: 1,
                        widths: ['*', '*'],
                        body: staffData,
                        fillColor: (rowIndex) => {
                            if (rowIndex === 0) return '#00B0F0';
                            return rowIndex % 2 === 0 ? '#FAFAFA' : null; // More subtle alternating colors
                        },
                        color: (rowIndex) => rowIndex === 0 ? '#FFFFFF' : '#000000'
                    },
                    layout: getImprovedTableLayout(),
                    margin: [40, 0, 40, 20]
                });
            } else {
                content.push({
                    text: 'Staff data not available',
                    fontSize: 11,
                    color: '#000000',
                    margin: [40, 0, 40, 20]
                });
            }
            
            // Add footer - removed to prevent blank pages
            // Footers will be handled by PDFMake's built-in footer functionality
            
            // Only add page if there's actual content
            if (content.length > 0) {
                docDefinition.content.push({
                    pageBreak: 'before',
                    stack: content
                });
            }
        }

        function addCombinedBudgetSectionPDFMake(docDefinition, submissions, year) {
            const content = [];
            
            // Calculate dynamic years
            // Get year from parameter, or from first submission, or use current year
            let currentYear = year;
            if (!currentYear && submissions.length > 0) {
                currentYear = submissions[0].year || submissions[0].fy || new Date().getFullYear();
            }
            if (!currentYear) {
                currentYear = new Date().getFullYear();
            }
            // Convert to number if it's a string
            currentYear = parseInt(currentYear) || new Date().getFullYear();
            const nextYear = currentYear + 1;
            const yearAfterNext = currentYear + 2;
            
            // Header (blue bar at top)
            content.push({
                canvas: [{
                    type: 'rect',
                    x: -40,
                    y: -60,
                    w: 612 + 80,
                    h: 30 + 60,
                    color: '#00B0F0'
                }]
            });
            
            // SUMMARY OF TAX INCREMENT REVENUES AND EXPENDITURES Title
            content.push({
                text: 'SUMMARY OF TAX INCREMENT REVENUES AND EXPENDITURES',
                fontSize: 16,
                bold: true,
                color: '#00B0F0',
                margin: [40, 20, 40, 10]
            });
            
            // TABLE E.3 â€“ COMBINED AGENCY BUDGET
            content.push({
                text: 'TABLE E.3 â€“ COMBINED AGENCY BUDGET',
                fontSize: 14,
                bold: true,
                color: '#00B0F0',
                margin: [40, 0, 40, 5]
            });
            
            content.push({
                text: 'COMBINED TAX INCREMENT BUDGET â€“ AGENCY',
                fontSize: 11,
                bold: true,
                color: '#000000',
                margin: [40, 0, 40, 10]
            });
            
            // Create COMBINED TAX REVENUE table
            const revenueData = [];
            revenueData.push(['DESCRIPTION', currentYear.toString(), nextYear.toString(), yearAfterNext.toString(), 'AUTHORIZED AMOUNT REMAINING']);
            
            // Add individual project area revenues
            let totalCurrent = 0, totalNext = 0, totalFollowing = 0, totalRemaining = 0;
            
            submissions.forEach((submission, index) => {
                // Use the most descriptive name available
                let projectArea = submission.projectAreaName || submission.projectArea;
                if (!projectArea) {
                    projectArea = submission.submitterName || submission.cityCounty;
                }
                if (!projectArea) {
                    projectArea = `Project Area #${index + 1}`;
                }
                
                // Get revenue data from the actual form fields
                let current = 0, next = 0, following = 0, remaining = 0;
                
                // Sum up all revenue sources for this project area
                for (let i = 0; i < 20; i++) {
                    const actual2025 = parseFloat(submission[`revenueSource2025Actual_${i}`] || 0);
                    const forecast2026 = parseFloat(submission[`revenueSource2026Forecast_${i}`] || 0);
                    const forecast2027 = parseFloat(submission[`revenueSource2027Forecast_${i}`] || 0);
                    
                    current += actual2025;
                    next += forecast2026;
                    following += forecast2027;
                }
                
                // Get remaining revenue
                remaining = parseFloat(submission.aggregateRemainingRevenue || 0);
                
                totalCurrent += current;
                totalNext += next;
                totalFollowing += following;
                totalRemaining += remaining;
                
                revenueData.push([
                    `${projectArea} - Revenue`,
                    `$${current.toLocaleString()}`,
                    `$${next.toLocaleString()}`,
                    `$${following.toLocaleString()}`,
                    `$${remaining.toLocaleString()}`
                ]);
            });
            
            // Add total revenue row
            revenueData.push([
                'TOTAL REVENUE',
                `$${totalCurrent.toLocaleString()}`,
                `$${totalNext.toLocaleString()}`,
                `$${totalFollowing.toLocaleString()}`,
                `$${totalRemaining.toLocaleString()}`
            ]);
            
            content.push({
                table: {
                    headerRows: 1,
                    widths: ['*', '*', '*', '*', '*'],
                    body: revenueData,
                    fillColor: (rowIndex) => {
                        if (rowIndex === 0) return '#00B0F0';
                        if (rowIndex === revenueData.length - 1) return '#E5E7EB'; // Total row
                        return rowIndex % 2 === 0 ? '#FAFAFA' : null; // More subtle alternating colors
                    },
                    color: (rowIndex) => rowIndex === 0 ? '#FFFFFF' : '#000000',
                    bold: (rowIndex) => rowIndex === 0 || rowIndex === revenueData.length - 1
                },
                layout: getImprovedTableLayout(),
                margin: [40, 0, 40, 20]
            });
            
            // Add COMBINED EXPENSES table
            content.push({
                text: 'COMBINED EXPENSES',
                fontSize: 11,
                bold: true,
                color: '#000000',
                margin: [40, 0, 40, 10]
            });
            
            const expenseData = [];
            expenseData.push(['DESCRIPTION', currentYear.toString(), nextYear.toString(), yearAfterNext.toString(), 'AUTHORIZED AMOUNT REMAINING']);
            
            // Collect all expense types across all project areas
            const expenseTypes = new Map();
            
            submissions.forEach(submission => {
                // Get all expense fields using the actual field names
                for (let i = 0; i < 20; i++) {
                    const expenseDesc = submission[`expenseTitle_${i}`];
                    const expenseCurrent = parseFloat(submission[`tyExpense_${i}`] || 0);
                    const expenseNext = parseFloat(submission[`cyExpense_${i}`] || 0);
                    const expenseFollowing = parseFloat(submission[`nyExpense_${i}`] || 0);
                    
                    if (expenseDesc && (expenseCurrent > 0 || expenseNext > 0 || expenseFollowing > 0)) {
                        if (!expenseTypes.has(expenseDesc)) {
                            expenseTypes.set(expenseDesc, { current: 0, next: 0, following: 0, remaining: 0 });
                        }
                        const current = expenseTypes.get(expenseDesc);
                        current.current += expenseCurrent;
                        current.next += expenseNext;
                        current.following += expenseFollowing;
                    }
                }
                
                // Also get total expenses
                const totalExpense = parseFloat(submission.totalAggregateExpense || 0);
                if (totalExpense > 0) {
                    if (!expenseTypes.has('Total Expenses')) {
                        expenseTypes.set('Total Expenses', { current: 0, next: 0, following: 0, remaining: 0 });
                    }
                    const current = expenseTypes.get('Total Expenses');
                    current.current += totalExpense;
                }
            });
            
            // Add expense types to table
            expenseTypes.forEach((values, expense) => {
                expenseData.push([
                    expense,
                    `$${values.current.toLocaleString()}`,
                    `$${values.next.toLocaleString()}`,
                    `$${values.following.toLocaleString()}`,
                    `$${values.remaining.toLocaleString()}`
                ]);
            });
            
            // Add expense totals
            const totalExpenseCurrent = Array.from(expenseTypes.values()).reduce((sum, v) => sum + v.current, 0);
            const totalExpenseNext = Array.from(expenseTypes.values()).reduce((sum, v) => sum + v.next, 0);
            const totalExpenseFollowing = Array.from(expenseTypes.values()).reduce((sum, v) => sum + v.following, 0);
            const totalExpenseRemaining = Array.from(expenseTypes.values()).reduce((sum, v) => sum + v.remaining, 0);
            
            expenseData.push([
                'TOTAL EXPENSES',
                `$${totalExpenseCurrent.toLocaleString()}`,
                `$${totalExpenseNext.toLocaleString()}`,
                `$${totalExpenseFollowing.toLocaleString()}`,
                `$${totalExpenseRemaining.toLocaleString()}`
            ]);
            
            content.push({
                table: {
                    headerRows: 1,
                    widths: ['*', '*', '*', '*', '*'],
                    body: expenseData,
                    fillColor: (rowIndex) => {
                        if (rowIndex === 0) return '#00B0F0';
                        if (rowIndex === expenseData.length - 1) return '#E5E7EB'; // Total row
                        return rowIndex % 2 === 0 ? '#FAFAFA' : null; // More subtle alternating colors
                    },
                    color: (rowIndex) => rowIndex === 0 ? '#FFFFFF' : '#000000',
                    bold: (rowIndex) => rowIndex === 0 || rowIndex === expenseData.length - 1
                },
                layout: getImprovedTableLayout(),
                margin: [40, 0, 40, 20]
            });
            
            // Add footer - removed to prevent blank pages
            // Footers will be handled by PDFMake's built-in footer functionality if needed
            // For now, skip footer to avoid blank page issues
            
            // Only add page if there's actual content
            if (content.length > 0) {
                docDefinition.content.push({
                    pageBreak: 'before',
                    stack: content
                });
            }
        }

        function addAcreageOverviewSectionPDFMake(docDefinition, submissions) {
            const content = [];
            
            // Title
            content.push({
                text: 'GENERAL OVERVIEW OF PROJECT AREAS AND ACREAGE',
                fontSize: 16,
                bold: true,
                color: '#000000',
                margin: [40, 20, 40, 10]
            });
            
            // Acreage Table
            content.push({
                text: 'TABLE E.4 â€“ ACREAGE (DEVELOPED, UNDEVELOPED, AND RESIDENTIAL)',
                fontSize: 12,
                bold: true,
                color: '#000000',
                margin: [40, 0, 40, 5]
            });
            
            content.push({
                text: 'ACREAGE (DEVELOPED, UNDEVELOPED, AND RESIDENTIAL)',
                fontSize: 10,
                color: '#000000',
                margin: [40, 0, 40, 10]
            });
            
            // Create acreage table
            const acreageData = [];
            acreageData.push(['PROJECT AREA', 'DEVELOPED', 'UNDEVELOPED', 'RESIDENTIAL', '% RESIDENTIAL', 'AUTHORIZED HOUSING UNITS #']);
            
            let totalDeveloped = 0, totalUndeveloped = 0, totalResidential = 0, totalHousingUnits = 0;
            
            submissions.forEach((submission, index) => {
                // Use the most descriptive name available
                let projectArea = submission.projectAreaName || submission.projectArea;
                if (!projectArea) {
                    projectArea = submission.submitterName || submission.cityCounty;
                }
                if (!projectArea) {
                    projectArea = `Project Area #${index + 1}`;
                }
                
                const developed = parseFloat(submission.developedAcreage || 0);
                const undeveloped = parseFloat(submission.undevelopedAcreage || 0);
                const residential = parseFloat(submission.residentialAcreage || 0);
                const housingUnits = parseFloat(submission.authorizedHousingUnits || 0);
                
                const totalAcreage = developed + undeveloped;
                const residentialPercentage = totalAcreage > 0 ? ((residential / totalAcreage) * 100).toFixed(1) : '0.0';
                
                acreageData.push([
                    projectArea,
                    developed.toFixed(2),
                    undeveloped.toFixed(2),
                    residential.toFixed(2),
                    `${residentialPercentage}%`,
                    housingUnits.toString()
                ]);
                
                totalDeveloped += developed;
                totalUndeveloped += undeveloped;
                totalResidential += residential;
                totalHousingUnits += housingUnits;
            });
            
            // Add totals
            const totalAcreage = totalDeveloped + totalUndeveloped;
            const totalResidentialPercentage = totalAcreage > 0 ? ((totalResidential / totalAcreage) * 100).toFixed(1) : '0.0';
            
            acreageData.push([
                'Total',
                totalDeveloped.toFixed(2),
                totalUndeveloped.toFixed(2),
                totalResidential.toFixed(2),
                `${totalResidentialPercentage}%`,
                totalHousingUnits.toString()
            ]);
            
            content.push({
                table: {
                    headerRows: 1,
                    widths: ['*', '*', '*', '*', '*', '*'],
                    body: acreageData,
                    fillColor: (rowIndex) => {
                        if (rowIndex === 0) return '#00B0F0';
                        if (rowIndex === acreageData.length - 1) return '#E5E7EB'; // Total row
                        return rowIndex % 2 === 0 ? '#FAFAFA' : null; // More subtle alternating colors
                    },
                    color: (rowIndex) => rowIndex === 0 ? '#FFFFFF' : '#000000',
                    bold: (rowIndex) => rowIndex === 0 || rowIndex === acreageData.length - 1
                },
                layout: getImprovedTableLayout(),
                margin: [0, 0, 40, 20] // Left margin set to 0 to move table 10mm more to the left
            });
            
            // Only add page if there's actual content
            if (content.length > 0) {
                docDefinition.content.push({
                    pageBreak: 'before',
                    stack: content
                });
            }
        }

        function addIndividualProjectSectionsPDFMake(docDefinition, submissions) {
            submissions.forEach((submission, index) => {
                const projectNumber = index + 1;
                
                // PROJECT AREA HEADER PAGE (black page with blue text)
                addProjectAreaHeaderPDFMake(docDefinition, projectNumber, submission);
                
                // PROJECT AREA OVERVIEW PAGE
                addProjectAreaOverviewPDFMake(docDefinition, submission, projectNumber);
                
                // FUND ACCOUNTABILITY PAGE
                addFundAccountabilityPDFMake(docDefinition, submission, projectNumber);
                
                // PROJECT AREA DEVELOPMENT PAGE
                addProjectAreaDevelopmentPDFMake(docDefinition, submission, projectNumber);
                
                // PROJECT AREA MAP PAGE
                addProjectAreaMapPDFMake(docDefinition, projectNumber);
            });
        }
        
        function addProjectAreaHeaderPDFMake(docDefinition, projectNumber, submission) {
            let projectArea = submission.projectAreaName || submission.projectArea;
            if (!projectArea) {
                projectArea = submission.submitterName || submission.cityCounty;
            }
            if (!projectArea) {
                projectArea = `Project Area #${projectNumber}`;
            }
            
            // All elements must be on the same page using absolute positioning
            const pageWidth = 612; // Letter width in points
            const pageHeight = 792; // Letter height in points
            const centerY = pageHeight / 2;
            const textY = centerY - 10;
            // 5mm = 14.17 points (1mm = 2.83465 points)
            const lineY = centerY + 15 + 14.17;
            const lineWidth = pageWidth * 0.8;
            const lineX1 = (pageWidth - lineWidth) / 2;
            const lineX2 = lineX1 + lineWidth;
            
            docDefinition.content.push({
                pageBreak: 'before',
                footer: null, // No footer on intro pages
                stack: [
                    // Black background covering entire page
                    {
                        canvas: [{
                            type: 'rect',
                            x: 0,
                            y: 0,
                            w: pageWidth,
                            h: pageHeight,
                            color: '#000000'
                        }],
                        absolutePosition: { x: 0, y: 0 },
                        margin: [0, 0, 0, 0]
                    },
                    // Blue text centered
                    {
                        text: projectArea.toUpperCase(),
                        fontSize: 24,
                        bold: true,
                        color: '#00B0F0',
                        alignment: 'center',
                        absolutePosition: { x: 0, y: textY },
                        width: pageWidth,
                        margin: [0, 0, 0, 0]
                    },
                    // Gray underline - canvas coordinates are relative to absolutePosition
                    {
                        canvas: [{
                            type: 'line',
                            x1: lineX1,
                            y1: 0,  // Relative to absolutePosition y
                            x2: lineX2,
                            y2: 0,  // Relative to absolutePosition y
                            lineWidth: 2,
                            lineColor: '#D3D3D3'
                        }],
                        absolutePosition: { x: 0, y: lineY },
                        margin: [0, 0, 0, 0]
                    }
                ]
            });
        }

        function addProjectAreaOverviewPDFMake(docDefinition, submission, projectNumber) {
            const content = [];
            
            // Header (blue bar at top)
            content.push({
                canvas: [{
                    type: 'rect',
                    x: -40,
                    y: -60,
                    w: 612 + 80,
                    h: 30 + 60,
                    color: '#00B0F0'
                }]
            });
            
            // Get project area name
            let projectArea = submission.projectAreaName || submission.projectArea;
            if (!projectArea) {
                projectArea = submission.submitterName || submission.cityCounty;
            }
            if (!projectArea) {
                projectArea = `Project Area #${projectNumber}`;
            }
            
            // Main title
            content.push({
                text: projectArea.toUpperCase(),
                fontSize: 18,
                bold: true,
                color: '#000000',
                margin: [40, 20, 40, 0]
            });
            
            // Black horizontal line
            content.push({
                canvas: [{
                    type: 'line',
                    x1: 40,
                    y1: 0,
                    x2: 572,
                    y2: 0,
                    lineWidth: 0.5,
                    lineColor: '#000000'
                }],
                margin: [0, 5, 0, 10]
            });
            
            content.push({
                text: 'OVERVIEW OF PROJECT AREA',
                fontSize: 14,
                bold: true,
                color: '#000000',
                margin: [40, 0, 40, 10]
            });
            
            // TABLE 1 - OVERVIEW OF PROJECT AREA
            content.push({
                text: 'TABLE 1 â€“ OVERVIEW OF PROJECT AREA',
                fontSize: 12,
                bold: true,
                color: '#888888',
                margin: [40, 0, 40, 5]
            });
            
            // Build overview table
            const overviewData = [];
            const type = submission.type || submission.projectType || 'RDA';
            // Calculate acreage: prefer acreage field, otherwise sum developed + undeveloped (legacy behavior)
            const acreage = parseFloat(submission.acreage || 0) || 
                          (parseFloat(submission.developedAcreage || 0) + parseFloat(submission.undevelopedAcreage || 0));
            const purpose = submission.purpose || submission.projectPurpose || 'Commercial Development';
            const taxingDistrict = submission.taxingDistrict || '55A';
            const taxRate = submission.taxRate || submission.taxRate2024 || '0.008925';
            
            // Row 1: Header row (bolded)
            overviewData.push([
                { text: 'TYPE', bold: true },
                { text: 'ACREAGE', bold: true },
                { text: 'OVERVIEW PURPOSE', bold: true },
                { text: 'TAXING DISTRICT', bold: true },
                { text: 'TAX RATE 2024', bold: true }
            ]);
            overviewData.push([type, acreage.toFixed(2), purpose, taxingDistrict, taxRate]);
            
            // Creation Year and related information
            // Row 3: Header row (bolded)
            overviewData.push([
                { text: 'CREATION YEAR', bold: true },
                { text: 'BASE YEAR', bold: true },
                { text: 'TERM', bold: true },
                { text: 'START YEAR', bold: true },
                { text: 'EXPIRATION YEAR', bold: true }
            ]);
            const creationYear = submission.creationYear || '1989';
            const baseYear = submission.baseYear || '1989';
            const termLength = submission.termLength || 32;
            const term = termLength ? `${termLength} Years` : '32 Years';
            const startYear = submission.startYear || 'FY 1994';
            const expirationYear = submission.expirationYear || 'FY 2025';
            
            overviewData.push([creationYear, baseYear, term, startYear, expirationYear]);
            
            // Financial Metrics
            // Row 5: Header row (bolded)
            overviewData.push([
                { text: 'BASE TAXABLE VALUE', bold: true },
                { text: 'CURRENT TAXABLE VALUE', bold: true },
                { text: 'ASSESSED VALUE INCREASE (%)', bold: true },
                { text: 'CURRENT YEAR TAX INCREMENT', bold: true },
                { text: 'REMAINING LIFE', bold: true }
            ]);
            const baseValue = parseFloat(submission.baseValue || submission.baseTaxableValue || 609648);
            const currentValue = parseFloat(submission.tyValue || submission.currentTaxableValue || 138913478);
            const increasePercent = baseValue > 0 ? ((currentValue - baseValue) / baseValue * 100).toFixed(0) : '0';
            const currentIncrement = parseFloat(submission.fyIncrement || submission.currentYearRevenue || submission.tyActualRevenue || 623751);
            const remainingLife = submission.remainingLife || '0 Years';
            
            overviewData.push([
                `$${baseValue.toLocaleString()}`,
                `$${currentValue.toLocaleString()}`,
                `${increasePercent}%`,
                `$${currentIncrement.toLocaleString()}`,
                remainingLife
            ]);
            
            content.push({
                table: {
                    headerRows: 1,
                    widths: ['*', '*', '*', '*', '*'],
                    body: overviewData,
                    fillColor: (rowIndex) => {
                        if (rowIndex === 0) return '#00B0F0';
                        return rowIndex % 2 === 0 ? '#FAFAFA' : null; // More subtle alternating colors
                    },
                    color: (rowIndex) => rowIndex === 0 ? '#FFFFFF' : '#000000'
                },
                layout: getImprovedTableLayout(),
                margin: [40, 0, 40, 15]
            });
            
            // Narrative text
            const narrativeText = `The "CRA" was created in ${creationYear} with a base year of "${baseYear}", with a value of "$${baseValue.toLocaleString()}". Since that time, the assessed value of the project area has increased to "$${currentValue.toLocaleString()}". This has been a growth of over "${increasePercent}%" in assessed value. The growth is thanks to developments in a new tech headquarters...`;
            
            content.push({
                text: narrativeText,
                fontSize: 10,
                color: '#000000',
                margin: [40, 0, 40, 10]
            });
            
            // Bullet points
            const bulletPoints = [
                'Including: Number of residential units, amount of sqft of commercial, industrial, and institutional development, number of jobs, and any other economic strength indicators within the project area.',
                'Named recent developments (developments that have made progress)',
                'THIS SECTION SHOULD BE A BRIEF OVERVIEW OF THE REPORT.'
            ];
            
            bulletPoints.forEach(point => {
                content.push({
                    text: `â€¢ ${point}`,
                    fontSize: 10,
                    color: '#000000',
                    margin: [50, 0, 40, 10]
                });
            });
            
            // Interlocal agreements text
            const interlocalText = 'Interlocal Cooperation Agreements or Interlocal Agreements are agreements made between the Agency and taxing entities, which permit the Agency to collect all or a portion of the property tax increment generated by the project area. Table 2 below summarizes the terms and conditions of each interlocal agreement.';
            
            content.push({
                text: interlocalText,
                fontSize: 10,
                color: '#000000',
                margin: [40, 0, 40, 10]
            });
            
            // TABLE 2 - SUMMARY OF INTERLOCAL AGREEMENTS (keep title and table together)
            const interlocalData = [];
            // First row: merged header cell spanning all columns, centered
            interlocalData.push([
                { text: 'INTERLOCAL AGREEMENT SUMMARY', colSpan: 5, alignment: 'center', bold: true },
                {}, {}, {}, {}
            ]);
            interlocalData.push(['ENTITY', '% OF TAX INCREMENT', 'REMITTANCE', 'CAP AMOUNTS', 'LENGTH']);
            
            // Collect tax entity data from submission
            const taxEntities = [];
            for (let i = 0; i < 20; i++) {
                const entityName = submission[`taxEntityName_${i}`];
                const participationRate = submission[`taxEntityParticipationRate_${i}`];
                if (entityName) {
                    taxEntities.push({
                        name: entityName,
                        percent: participationRate ? `${participationRate}%` : '-',
                        remittance: '-',
                        cap: '-',
                        length: '-'
                    });
                }
            }
            
            // Add default entities if none found
            if (taxEntities.length === 0) {
                taxEntities.push(
                    { name: 'Salt Lake County', percent: '70%', remittance: '-%', cap: '$-', length: '12 Years' },
                    { name: 'Canyons School District', percent: '75%', remittance: '-', cap: '-', length: '12 Years' }
                );
            }
            
            taxEntities.forEach(entity => {
                interlocalData.push([entity.name, entity.percent, entity.remittance, entity.cap, entity.length]);
            });
            
            interlocalData.push(['Total', '-%', '$-', '', '']);
            
            // Keep TABLE 2 title and table together on same page
            content.push({
                unbreakable: true, // Keep title and table together
                stack: [
                    {
                        text: 'TABLE 2 â€“ SUMMARY OF INTERLOCAL AGREEMENTS',
                        fontSize: 12,
                        bold: true,
                        color: '#888888',
                        margin: [40, 0, 40, 5]
                    },
                    {
                        table: {
                            headerRows: 2,
                            widths: ['*', '*', '*', '*', '*'],
                            body: interlocalData,
                            fillColor: (rowIndex) => {
                                if (rowIndex === 0 || rowIndex === 1) return '#00B0F0';
                                return rowIndex % 2 === 0 ? '#FAFAFA' : null; // More subtle alternating colors
                            },
                            color: (rowIndex) => (rowIndex === 0 || rowIndex === 1) ? '#FFFFFF' : '#000000'
                        },
                        layout: getImprovedTableLayout(),
                        margin: [40, 0, 40, 20]
                    }
                ]
            });
            
            // Add footer - removed to prevent blank pages
            // Footers will be handled by PDFMake's built-in footer functionality if needed
            // For now, skip footer to avoid blank page issues
            
            // Only add page if there's actual content
            if (content.length > 0) {
                docDefinition.content.push({
                    pageBreak: 'before',
                    stack: content
                });
            }
        }
        
        function addFundAccountabilityPDFMake(docDefinition, submission, projectNumber) {
            const content = [];
            
            // Header (blue bar at top)
            content.push({
                canvas: [{
                    type: 'rect',
                    x: -40,
                    y: -60,
                    w: 612 + 80,
                    h: 30 + 60,
                    color: '#00B0F0'
                }]
            });
            
            // FUND ACCOUNTABILITY title
            content.push({
                text: 'FUND ACCOUNTABILITY',
                fontSize: 12,
                bold: true,
                color: '#000000',
                margin: [40, 20, 40, 5]
            });
            
            // TABLE 3 - SOURCES OF FUNDS
            content.push({
                text: 'TABLE 3 â€“ SOURCES OF FUNDS',
                fontSize: 12,
                bold: true,
                color: '#888888',
                margin: [40, 0, 40, 5]
            });
            
            const sourcesData = [];
            sourcesData.push(['2025 SOURCES OF FUNDS', '2026 FORECASTED', '2027 FORECASTED']);
            sourcesData.push(['2025 ACTUAL', '2026 FORECASTED', '2027 FORECASTED']);
            
            const propTax2025 = parseFloat(submission.propertyTax2025 || submission.currentYearRevenue || 4116081);
            const propTax2026 = parseFloat(submission.propertyTax2026 || submission.nextYearRevenue || 4200000);
            const propTax2027 = parseFloat(submission.propertyTax2027 || submission.followingYearRevenue || 4400000);
            
            sourcesData.push([
                `$${propTax2025.toLocaleString()}`,
                `$${propTax2026.toLocaleString()}`,
                `$${propTax2027.toLocaleString()}`
            ]);
            sourcesData.push(['Property Tax Increment', '', '']);
            sourcesData.push([
                `$${propTax2025.toLocaleString()}`,
                '',
                ''
            ]);
            sourcesData.push(['Total Sources of Funds', '', '']);
            
            content.push({
                table: {
                    headerRows: 1,
                    widths: ['*', '*', '*'],
                    body: sourcesData,
                    fillColor: (rowIndex) => {
                        if (rowIndex === 0) return '#00B0F0';
                        if (rowIndex === sourcesData.length - 1) return '#E9ECEF'; // Total row
                        return rowIndex % 2 === 0 ? '#FAFAFA' : null; // More subtle alternating colors
                    },
                    color: (rowIndex) => rowIndex === 0 ? '#FFFFFF' : '#000000',
                    bold: (rowIndex) => rowIndex === 0 || rowIndex === sourcesData.length - 1
                },
                layout: getImprovedTableLayout(),
                margin: [40, 0, 40, 20]
            });
            
            // TABLE 4 - USES OF FUNDS
            content.push({
                text: 'TABLE 4 â€“ USES OF FUNDS',
                fontSize: 12,
                bold: true,
                color: '#888888',
                margin: [40, 0, 40, 5]
            });
            
            // Build expenses array
            let expensesArray = [];
            if (submission.expenses && submission.expenses.length > 0) {
                expensesArray = submission.expenses;
            } else {
                for (let i = 0; i < 20; i++) {
                    const title = submission[`expenseTitle_${i}`];
                    const tyExpense = submission[`tyExpense_${i}`];
                    const cyExpense = submission[`cyExpense_${i}`];
                    const nyExpense = submission[`nyExpense_${i}`];
                    
                    if (title || tyExpense || cyExpense || nyExpense) {
                        expensesArray.push({
                            title: title || '',
                            tyExpense: tyExpense || '',
                            cyExpense: cyExpense || '',
                            nyExpense: nyExpense || ''
                        });
                    }
                }
            }
            
            if (expensesArray.length > 0) {
                // Calculate dynamic years
                // TY = past year (current year - 1), CY = current year, NY = next year (current year + 1)
                let currentYear = submission.year || submission.fy || new Date().getFullYear();
                currentYear = parseInt(currentYear) || new Date().getFullYear();
                const pastYear = currentYear - 1; // TY
                const nextYear = currentYear + 1; // NY
                
                const usesData = [];
                usesData.push(['Expense Title', pastYear.toString(), currentYear.toString(), nextYear.toString()]);
                
                let totalTY = 0;
                let totalCY = 0;
                let totalNY = 0;
                
                expensesArray.forEach(expense => {
                    const tyExpense = parseFloat(expense.tyExpense || 0);
                    const cyExpense = parseFloat(expense.cyExpense || 0);
                    const nyExpense = parseFloat(expense.nyExpense || 0);
                    
                    totalTY += tyExpense;
                    totalCY += cyExpense;
                    totalNY += nyExpense;
                    
                    usesData.push([
                        expense.title || '',
                        `$${tyExpense.toLocaleString()}`,
                        `$${cyExpense.toLocaleString()}`,
                        `$${nyExpense.toLocaleString()}`
                    ]);
                });
                
                // Add totals row
                usesData.push([
                    'TOTAL USES OF FUNDS',
                    `$${totalTY.toLocaleString()}`,
                    `$${totalCY.toLocaleString()}`,
                    `$${totalNY.toLocaleString()}`
                ]);
                
                content.push({
                    table: {
                        headerRows: 1,
                        widths: ['*', '*', '*', '*'],
                        body: usesData,
                        fillColor: (rowIndex) => {
                            if (rowIndex === 0) return '#00B0F0';
                            if (rowIndex === usesData.length - 1) return '#E9ECEF'; // Total row
                            return rowIndex % 2 === 0 ? '#FAFAFA' : null; // More subtle alternating colors
                        },
                        color: (rowIndex) => rowIndex === 0 ? '#FFFFFF' : '#000000',
                        bold: (rowIndex) => rowIndex === 0 || rowIndex === usesData.length - 1
                    },
                    layout: getImprovedTableLayout(),
                    margin: [40, 0, 40, 20]
                });
            }
            
            // PLANNED USES FOR FUND BALANCE section
            if (submission.plannedUsesFundBalance) {
                content.push({
                    text: 'PLANNED USES FOR FUND BALANCE',
                    fontSize: 12,
                    bold: true,
                    color: '#888888',
                    margin: [40, 0, 40, 5]
                });
                
                const plannedUsesText = submission.plannedUsesFundBalance || 'N/A';
                // Split text into lines (approximate 80 characters per line)
                const maxCharsPerLine = 80;
                const words = plannedUsesText.split(' ');
                const lines = [];
                let currentLine = '';
                
                words.forEach(word => {
                    if ((currentLine + word).length > maxCharsPerLine) {
                        if (currentLine) lines.push(currentLine);
                        currentLine = word;
                    } else {
                        currentLine = currentLine ? currentLine + ' ' + word : word;
                    }
                });
                if (currentLine) lines.push(currentLine);
                
                lines.forEach(line => {
                    content.push({
                        text: line,
                        fontSize: 10,
                        color: '#000000',
                        margin: [40, 0, 40, 5]
                    });
                });
            }
            
            // GROWTH IN TAX INCREMENT section (always show, even if values are 0)
            content.push({
                text: 'GROWTH IN TAX INCREMENT',
                fontSize: 12,
                bold: true,
                color: '#888888',
                margin: [40, 20, 40, 5]
            });
            
            const displayYear = submission.fy || submission.year || '2025';
            const tyOriginalBudgetRevenues = parseFloat(submission.tyOriginalBudgetRevenues || 0);
            const tyActualRevenue = parseFloat(submission.tyActualRevenue || 0);
            const tyBaseYearRevenue = parseFloat(submission.tyBaseYearRevenue || 0);
            const lifetimeRevenues = parseFloat(submission.lifetimeRevenues || 0);
            const lifetimeActualRevenues = parseFloat(submission.lifetimeActualRevenues || 0);
            const lifetimeBaseYearRevenues = parseFloat(submission.lifetimeBaseYearRevenues || 0);
            
            const growthData = [];
            // Header row with "Growth in Tax Increment" spanning all columns
            growthData.push([
                { text: 'GROWTH IN TAX INCREMENT', colSpan: 4, alignment: 'center', bold: true, fillColor: '#E9ECEF' },
                {}, {}, {}
            ]);
            // Column headers
            growthData.push([
                '',
                'ORIGINAL BUDGET REVENUES',
                'ACTUAL REVENUE',
                'BASE YEAR VALUE REVENUES'
            ]);
            // Tax Year row
            growthData.push([
                { text: `Tax Year ${displayYear}`, bold: true },
                `$${tyOriginalBudgetRevenues.toLocaleString()}`,
                `$${tyActualRevenue.toLocaleString()}`,
                `$${tyBaseYearRevenue.toLocaleString()}`
            ]);
            // Lifetime Revenue row
            growthData.push([
                { text: 'Lifetime Revenue', bold: true },
                `$${lifetimeRevenues.toLocaleString()}`,
                `$${lifetimeActualRevenues.toLocaleString()}`,
                `$${lifetimeBaseYearRevenues.toLocaleString()}`
            ]);
            
            content.push({
                table: {
                    headerRows: 2,
                    widths: ['*', '*', '*', '*'],
                    body: growthData,
                    fillColor: (rowIndex) => {
                        if (rowIndex === 0) return '#E9ECEF'; // "Growth in Tax Increment" header row
                        if (rowIndex === 1) return '#00B0F0'; // Column headers row
                        return rowIndex % 2 === 0 ? '#FAFAFA' : null; // Alternating rows
                    },
                    color: (rowIndex) => rowIndex === 1 ? '#FFFFFF' : '#000000',
                    bold: (rowIndex) => rowIndex === 0 || rowIndex === 1 || rowIndex === 2 || rowIndex === 3
                },
                layout: getImprovedTableLayout(),
                margin: [40, 0, 40, 20]
            });
            
            // Add footer - removed to prevent blank pages
            // Footers will be handled by PDFMake's built-in footer functionality if needed
            // For now, skip footer to avoid blank page issues
            
            // Only add page if there's actual content
            if (content.length > 0) {
                docDefinition.content.push({
                    pageBreak: 'before',
                    stack: content
                });
            }
            
            // PROJECT AREA BUDGET section (always show, even if values are 0)
            // Add this section on its own page
            const budgetContent = [];
            
            // Header (blue bar at top)
            budgetContent.push({
                canvas: [{
                    type: 'rect',
                    x: -40,
                    y: -60,
                    w: 612 + 80,
                    h: 30 + 60,
                    color: '#00B0F0'
                }]
            });
            
            budgetContent.push({
                text: 'PROJECT AREA BUDGET',
                fontSize: 12,
                bold: true,
                color: '#000000',
                margin: [40, 20, 40, 5]
            });
            
            const discountRate = parseFloat(submission.discountRate || 0);
            const propertyTaxIncrementTotal = parseFloat(submission.propertyTaxIncrementTotal || 0);
            const propertyTaxIncrementNpv = parseFloat(submission.propertyTaxIncrementNpv || 0);
            const totalRevenueTotal = parseFloat(submission.totalRevenueTotal || propertyTaxIncrementTotal || 0);
            const totalRevenueNpv = parseFloat(submission.totalRevenueNpv || propertyTaxIncrementNpv || 0);
            const administrativeFeeTotal = parseFloat(submission.administrativeFeeTotal || 0);
            const administrativeFeeNpv = parseFloat(submission.administrativeFeeNpv || 0);
            const expenseTotal = parseFloat(submission.expenseTotal || 0);
            const expenseNpv = parseFloat(submission.expenseNpv || 0);
            const totalUsesOfFundsTotal = parseFloat(submission.totalUsesOfFundsTotal || (administrativeFeeTotal + expenseTotal) || 0);
            const totalUsesOfFundsNpv = parseFloat(submission.totalUsesOfFundsNpv || (administrativeFeeNpv + expenseNpv) || 0);
            
            const budgetData = [];
            budgetData.push(['', 'Totals', `NPV @ ${discountRate.toFixed(2)}%`]);
            
            // Revenues section header row (row index 1)
            budgetData.push(['Revenues', 'Totals', `NPV @ ${discountRate.toFixed(2)}%`]);
            
            // Property Tax Increment row (row index 2)
            budgetData.push([
                'Property Tax Increment',
                `$${propertyTaxIncrementTotal.toLocaleString()}`,
                `$${propertyTaxIncrementNpv.toLocaleString()}`
            ]);
            
            // Total Revenue row (row index 3)
            budgetData.push([
                'Total Revenue',
                `$${totalRevenueTotal.toLocaleString()}`,
                `$${totalRevenueNpv.toLocaleString()}`
            ]);
            
            // Expenses section header row (row index 4)
            budgetData.push(['Expenses', 'Totals', `NPV @ ${discountRate.toFixed(2)}%`]);
            
            // Administrative Fee row (row index 5)
            budgetData.push([
                'Administrative Fee',
                `$${administrativeFeeTotal.toLocaleString()}`,
                `$${administrativeFeeNpv.toLocaleString()}`
            ]);
            
            // Expense row (row index 6)
            budgetData.push([
                'Expense',
                `$${expenseTotal.toLocaleString()}`,
                `$${expenseNpv.toLocaleString()}`
            ]);
            
            // Total Uses of Funds row (row index 7)
            budgetData.push([
                'Total Uses of Funds',
                `$${totalUsesOfFundsTotal.toLocaleString()}`,
                `$${totalUsesOfFundsNpv.toLocaleString()}`
            ]);
            
            budgetContent.push({
                table: {
                    headerRows: 1,
                    widths: ['*', '*', '*'],
                    body: budgetData,
                    fillColor: (rowIndex) => {
                        if (rowIndex === 0) return '#00B0F0'; // Header row
                        if (rowIndex === 1 || rowIndex === 4) return '#E9ECEF'; // Revenues/Expenses section headers
                        return rowIndex % 2 === 0 ? '#FAFAFA' : null; // Alternating rows
                    },
                    color: (rowIndex) => rowIndex === 0 ? '#FFFFFF' : '#000000',
                    bold: (rowIndex) => {
                        // Bold header row, section headers, and total rows
                        return rowIndex === 0 || rowIndex === 1 || rowIndex === 3 || rowIndex === 4 || rowIndex === 7;
                    }
                },
                layout: getImprovedTableLayout(),
                margin: [40, 0, 40, 20]
            });
            
            // Add Project Area Budget on its own page
            docDefinition.content.push({
                pageBreak: 'before',
                stack: budgetContent
            });
        }
        
        function addProjectAreaDevelopmentPDFMake(docDefinition, submission, projectNumber) {
            const content = [];
            
            // Header (blue bar at top)
            content.push({
                canvas: [{
                    type: 'rect',
                    x: -40,
                    y: -60,
                    w: 612 + 80,
                    h: 30 + 60,
                    color: '#00B0F0'
                }]
            });
            
            content.push({
                text: 'PROJECT AREA DEVELOPMENT',
                fontSize: 16,
                bold: true,
                color: '#000000',
                margin: [40, 20, 40, 10]
            });
            
            content.push({
                text: 'Mentioning of development of the project area. Acreage both developed and undeveloped, etc.',
                fontSize: 10,
                color: '#000000',
                margin: [40, 0, 40, 10]
            });
            
            // TABLE 8 - ACREAGE
            content.push({
                text: 'TABLE 8 â€“ ACREAGE',
                fontSize: 12,
                bold: true,
                color: '#888888',
                margin: [40, 0, 40, 5]
            });
            
            const acreageData = [];
            // First row: merged header cell spanning all columns, centered and bold
            acreageData.push([
                { text: 'ACREAGE (DEVELOPED, UNDEVELOPED, AND RESIDENTIAL)', colSpan: 5, alignment: 'center', bold: true },
                {}, {}, {}, {}
            ]);
            acreageData.push(['DEVELOPED', 'UNDEVELOPED', 'RESIDENTIAL', '% RESIDENTIAL', 'AUTHORIZED HOUSING UNITS #']);
            
            const developed = parseFloat(submission.developedAcreage || 232.08);
            const undeveloped = parseFloat(submission.undevelopedAcreage || 67.05);
            const residential = parseFloat(submission.residentialAcreage || 39.67);
            const housingUnits = parseFloat(submission.authorizedHousingUnits || 400);
            const totalAcreage = developed + undeveloped;
            const residentialPercent = totalAcreage > 0 ? ((residential / totalAcreage) * 100).toFixed(1) : '0.0';
            
            acreageData.push([
                developed.toFixed(2),
                undeveloped.toFixed(2),
                residential.toFixed(2),
                `${residentialPercent}%`,
                housingUnits.toString()
            ]);
            
            content.push({
                table: {
                    headerRows: 2,
                    widths: ['*', '*', '*', '*', '*'],
                    body: acreageData,
                    fillColor: (rowIndex) => {
                        if (rowIndex === 0 || rowIndex === 1) return '#00B0F0';
                        return rowIndex % 2 === 0 ? '#FAFAFA' : null; // More subtle alternating colors
                    },
                    color: (rowIndex) => (rowIndex === 0 || rowIndex === 1) ? '#FFFFFF' : '#000000'
                },
                layout: getImprovedTableLayout(),
                margin: [40, 0, 40, 15]
            });
            
            // Development narrative
            content.push({
                text: 'This project area has had 20,000 square feet of commercial development. In addition to this, the following businesses have opened:',
                fontSize: 10,
                color: '#000000',
                margin: [40, 0, 40, 10]
            });
            
            const businesses = ['Jimmy John\'s', 'Johnny Jim\'s', 'Jersey Mikes', 'Mikey Jerse\'s'];
            businesses.forEach(business => {
                content.push({
                    text: `â€¢ ${business}`,
                    fontSize: 10,
                    color: '#000000',
                    margin: [50, 0, 40, 10]
                });
            });
            
            content.push({
                text: 'PROGRESS PURSUANT TO PLAN',
                fontSize: 12,
                bold: true,
                color: '#000000',
                margin: [40, 10, 40, 5]
            });
            
            content.push({
                text: 'The plan outlined the.... The plan has been furthered through the...',
                fontSize: 10,
                color: '#000000',
                margin: [40, 0, 40, 10]
            });
            
            content.push({
                text: 'OTHER ISSUES',
                fontSize: 12,
                bold: true,
                color: '#000000',
                margin: [40, 0, 40, 5]
            });
            
            content.push({
                text: 'Any other issues worth mentioning...',
                fontSize: 10,
                color: '#000000',
                margin: [40, 0, 40, 20]
            });
            
            // Add footer - removed to prevent blank pages
            // Footers will be handled by PDFMake's built-in footer functionality if needed
            // For now, skip footer to avoid blank page issues
            
            // Only add page if there's actual content
            if (content.length > 0) {
                docDefinition.content.push({
                    pageBreak: 'before',
                    stack: content
                });
            }
        }
        
        function addProjectAreaMapPDFMake(docDefinition, projectNumber) {
            const content = [];
            
            // Header (blue bar at top)
            content.push({
                canvas: [{
                    type: 'rect',
                    x: -40,
                    y: -60,
                    w: 612 + 80,
                    h: 30 + 60,
                    color: '#00B0F0'
                }]
            });
            
            content.push({
                text: 'PROJECT AREA MAP',
                fontSize: 16,
                bold: true,
                color: '#000000',
                margin: [40, 20, 40, 10]
            });
            
            content.push({
                text: '[Project Area Map Placeholder]',
                fontSize: 12,
                color: '#000000',
                margin: [40, 0, 40, 20]
            });
            
            // Add footer - removed to prevent blank pages
            // Footers will be handled by PDFMake's built-in footer functionality if needed
            // For now, skip footer to avoid blank page issues
            
            // Only add page if there's actual content
            if (content.length > 0) {
                docDefinition.content.push({
                    pageBreak: 'before',
                    stack: content
                });
            }
        }
        
        function addReportHeader(doc, title) {
            const pageWidth = doc.internal.pageSize.getWidth();
            
            // Add header background (site blue)
            doc.setFillColor(0, 176, 240);
            doc.rect(0, 0, pageWidth, 30, 'F');
            
            // No text in header - just the blue bar
        }

        function addReportFooter(doc) {
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            
            // Add footer background
            doc.setFillColor(0, 176, 240);
            doc.rect(0, pageHeight - 30, pageWidth, 30, 'F');
            
            // Add footer content
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            
            // Page number
            doc.text(`Page ${doc.internal.getNumberOfPages()}`, 20, pageHeight - 10);
            
            // Company info
            doc.text('LRB PUBLIC FINANCE ADVISORS | 41 NORTH RIO GRANDE, SUITE 101 | SALT LAKE CITY, UT 84101', pageWidth / 2, pageHeight - 10, { align: 'center' });

            // Logo only appears on cover page (removed from footer)
        }

        /**
         * Automatic page break utility function
         * Checks if content will fit on current page, adds new page if needed
         * @param {jsPDF} doc - The jsPDF document instance
         * @param {number} yPosition - Current Y position
         * @param {number} requiredSpace - Space needed for the content in mm/points
         * @param {number} bottomMargin - Bottom margin to maintain (default: 30)
         * @param {boolean} addHeaderFooter - Whether to add header/footer on new page (default: true)
         * @param {string} headerText - Optional header text for continuation pages
         * @returns {object} - Returns object with {yPosition, pageAdded}
         */
        function autoPageBreak(doc, yPosition, requiredSpace, bottomMargin = 30, addHeaderFooter = true, headerText = 'ANNUAL JUNE 30TH COMPLIANCE REPORT') {
            const pageHeight = doc.internal.pageSize.getHeight();
            let pageAdded = false;
            
            // Check if we need a new page
            if (yPosition + requiredSpace > pageHeight - bottomMargin) {
                doc.addPage();
                pageAdded = true;
                
                if (addHeaderFooter) {
                    addReportHeader(doc, headerText);
                    addReportFooter(doc);
                }
                
                // Reset y position below header (header takes ~30-40 units)
                yPosition = 40;
            }
            
            return { yPosition, pageAdded };
        }

        /**
         * Add text with automatic page breaks
         * @param {jsPDF} doc - The jsPDF document instance
         * @param {string} text - Text to add
         * @param {number} fontSize - Font size
         * @param {number} x - X position
         * @param {number} yPosition - Current Y position
         * @param {object} options - Options object
         * @returns {number} - New Y position after text
         */
        function addTextAutoBreak(doc, text, fontSize, x, yPosition, options = {}) {
            const {
                maxWidth = doc.internal.pageSize.getWidth() - (x * 2),
                lineHeight = fontSize * 0.4,
                color = [0, 0, 0],
                isBold = false,
                bottomMargin = 30,
                headerText = 'ANNUAL JUNE 30TH COMPLIANCE REPORT'
            } = options;
            
            doc.setFontSize(fontSize);
            doc.setFont(undefined, isBold ? 'bold' : 'normal');
            doc.setTextColor(color[0], color[1], color[2]);
            
            // Split text to fit width
            const splitText = doc.splitTextToSize(text, maxWidth);
            const requiredHeight = splitText.length * lineHeight + 10;
            
            // Check for page break
            const { yPosition: currentY } = autoPageBreak(doc, yPosition, requiredHeight, bottomMargin, true, headerText);
            
            // Add text
            doc.text(splitText, x, currentY);
            
            // Update y position
            return currentY + splitText.length * lineHeight + 10;
        }

        function generateTaxIncrementTableData(submissions) {
            const data = [];
            let totalCurrent = 0, totalNext = 0, totalFollowing = 0, totalAuthorized = 0;

            submissions.forEach(submission => {
                const projectArea = submission.projectArea || submission.projectAreaName || 'N/A';
                
                // Revenue data
                const currentRevenue = parseFloat(submission.currentYearRevenue || 0);
                const nextRevenue = parseFloat(submission.nextYearRevenue || 0);
                const followingRevenue = parseFloat(submission.followingYearRevenue || 0);
                const authorizedRevenue = parseFloat(submission.authorizedRevenueRemaining || 0);
                
                if (currentRevenue > 0 || nextRevenue > 0 || followingRevenue > 0 || authorizedRevenue > 0) {
                    data.push([
                        `${projectArea} - Revenue`,
                        `$${currentRevenue.toLocaleString()}`,
                        `$${nextRevenue.toLocaleString()}`,
                        `$${followingRevenue.toLocaleString()}`,
                        `$${authorizedRevenue.toLocaleString()}`
                    ]);
                    totalCurrent += currentRevenue;
                    totalNext += nextRevenue;
                    totalFollowing += followingRevenue;
                    totalAuthorized += authorizedRevenue;
                }

                // Expense data
                const currentExpense = parseFloat(submission.currentYearExpense || 0);
                const nextExpense = parseFloat(submission.nextYearExpense || 0);
                const followingExpense = parseFloat(submission.followingYearExpense || 0);
                const authorizedExpense = parseFloat(submission.authorizedExpenseRemaining || 0);
                
                if (currentExpense > 0 || nextExpense > 0 || followingExpense > 0 || authorizedExpense > 0) {
                    data.push([
                        `${projectArea} - Expenses`,
                        `$${currentExpense.toLocaleString()}`,
                        `$${nextExpense.toLocaleString()}`,
                        `$${followingExpense.toLocaleString()}`,
                        `$${authorizedExpense.toLocaleString()}`
                    ]);
                    totalCurrent += currentExpense;
                    totalNext += nextExpense;
                    totalFollowing += followingExpense;
                    totalAuthorized += authorizedExpense;
                }
            });

            // Add totals row
            if (data.length > 0) {
                data.push([
                    'TOTAL',
                    `$${totalCurrent.toLocaleString()}`,
                    `$${totalNext.toLocaleString()}`,
                    `$${totalFollowing.toLocaleString()}`,
                    `$${totalAuthorized.toLocaleString()}`
                ]);
            }

            return data;
        }

        function generateAcreageTableData(submissions) {
            const data = [];
            let totalDeveloped = 0, totalUndeveloped = 0, totalResidential = 0, totalHousingUnits = 0;

            submissions.forEach(submission => {
                const projectArea = submission.projectArea || submission.projectAreaName || 'N/A';
                const developed = parseFloat(submission.developedAcreage || 0);
                const undeveloped = parseFloat(submission.undevelopedAcreage || 0);
                const residential = parseFloat(submission.residentialAcreage || 0);
                const housingUnits = parseFloat(submission.authorizedHousingUnits || 0);
                
                const totalAcreage = developed + undeveloped;
                const residentialPercentage = totalAcreage > 0 ? ((residential / totalAcreage) * 100).toFixed(1) : '0.0';

                data.push([
                    projectArea,
                    developed.toFixed(2),
                    undeveloped.toFixed(2),
                    residential.toFixed(2),
                    `${residentialPercentage}%`,
                    housingUnits.toString()
                ]);

                totalDeveloped += developed;
                totalUndeveloped += undeveloped;
                totalResidential += residential;
                totalHousingUnits += housingUnits;
            });

            // Add totals row
            if (data.length > 0) {
                const totalAcreage = totalDeveloped + totalUndeveloped;
                const totalResidentialPercentage = totalAcreage > 0 ? ((totalResidential / totalAcreage) * 100).toFixed(1) : '0.0';
                
                data.push([
                    'TOTAL',
                    totalDeveloped.toFixed(2),
                    totalUndeveloped.toFixed(2),
                    totalResidential.toFixed(2),
                    `${totalResidentialPercentage}%`,
                    totalHousingUnits.toString()
                ]);
            }

            return data;
        }

        function generateRevenueTableData(submissions) {
            const data = [];
            const revenueSources = new Map();

            submissions.forEach(submission => {
                // Collect revenue sources from various fields
                const sources = [
                    { name: 'Property Tax', actual: submission.propertyTax2025, forecast2026: submission.propertyTax2026, forecast2027: submission.propertyTax2027 },
                    { name: 'Sales Tax', actual: submission.salesTax2025, forecast2026: submission.salesTax2026, forecast2027: submission.salesTax2027 },
                    { name: 'Income Tax', actual: submission.incomeTax2025, forecast2026: submission.incomeTax2026, forecast2027: submission.incomeTax2027 },
                    { name: 'Other Revenue', actual: submission.otherRevenue2025, forecast2026: submission.otherRevenue2026, forecast2027: submission.otherRevenue2027 }
                ];

                sources.forEach(source => {
                    if (source.actual || source.forecast2026 || source.forecast2027) {
                        if (!revenueSources.has(source.name)) {
                            revenueSources.set(source.name, { actual: 0, forecast2026: 0, forecast2027: 0 });
                        }
                        const current = revenueSources.get(source.name);
                        current.actual += parseFloat(source.actual || 0);
                        current.forecast2026 += parseFloat(source.forecast2026 || 0);
                        current.forecast2027 += parseFloat(source.forecast2027 || 0);
                    }
                });
            });

            // Convert to array format
            revenueSources.forEach((values, name) => {
                if (values.actual > 0 || values.forecast2026 > 0 || values.forecast2027 > 0) {
                    data.push([
                        name,
                        `$${values.actual.toLocaleString()}`,
                        `$${values.forecast2026.toLocaleString()}`,
                        `$${values.forecast2027.toLocaleString()}`
                    ]);
                }
            });

            return data;
        }

        function showNotification(message) {
            try {
                const notification = document.getElementById('notification');
                if (notification) {
                    notification.textContent = message;
                    notification.style.display = 'block';
                    setTimeout(() => {
                        notification.style.display = 'none';
                    }, 3000);
                } else {
                    console.warn('Notification element not found, using alert instead');
                    alert(message);
                }
            } catch (error) {
                console.error('Error showing notification:', error);
                alert(message);
            }
        }
        
        // Test function to verify forms are working
        function testFormSubmission() {
            console.log('Testing form submission...');
            const externalForm = document.getElementById('project-form');
            const internalForm = document.getElementById('internal-data-request-form');
            
            console.log('External form found:', !!externalForm);
            console.log('Internal form found:', !!internalForm);
            
            if (externalForm) {
                console.log('External form submit handler:', typeof externalForm.onsubmit);
                const externalSubmitBtn = externalForm.querySelector('button[type="submit"]');
                console.log('External submit button found:', !!externalSubmitBtn);
                if (externalSubmitBtn) {
                    console.log('External submit button text:', externalSubmitBtn.textContent);
                    console.log('External submit button disabled:', externalSubmitBtn.disabled);
                }
            }
            if (internalForm) {
                console.log('Internal form submit handler:', typeof internalForm.onsubmit);
                const internalSubmitBtn = internalForm.querySelector('button[type="submit"]');
                console.log('Internal submit button found:', !!internalSubmitBtn);
                if (internalSubmitBtn) {
                    console.log('Internal submit button text:', internalSubmitBtn.textContent);
                    console.log('Internal submit button disabled:', internalSubmitBtn.disabled);
                }
            }
        }
        
        // Manual test function - call this from console to test
        function manualTestSubmit() {
            console.log('Manual test: triggering external form submit');
            const externalForm = document.getElementById('project-form');
            if (externalForm) {
                externalForm.dispatchEvent(new Event('submit'));
            }
        }

        function formatNumberWithCommas(input) {
            // Only format if there's actually a number
            if (!input.value || input.value.trim() === '') return;
            
            // Get the raw value without commas
            let rawValue = input.value.replace(/,/g, '');
            
            // Only proceed if it's a valid number
            if (isNaN(parseFloat(rawValue))) return;
            
            // Format with commas - simple approach
            const num = parseFloat(rawValue);
            const formatted = num.toLocaleString('en-US');
            
            // Only update if the formatting is different
            if (formatted !== input.value) {
                input.value = formatted;
            }
        }

        function removeCommas(input) {
            // Remove commas when user clicks in to edit
            if (input.value && input.value.includes(',')) {
                input.value = input.value.replace(/,/g, '');
            }
        }

        function setupNumberFormatting() {
            // Select all number inputs that should have comma formatting
            // Exclude year fields and percentage fields
            const numberInputs = document.querySelectorAll('input[type="number"]:not([name*="year"]):not([name*="Year"]):not([name*="percentage"]):not([name*="Percentage"]):not([name*="rate"]):not([name*="Rate"]):not([min="0"][max="100"])');
            
            numberInputs.forEach(input => {
                // Change input type to text to avoid browser interference
                input.type = 'text';
                input.pattern = '[0-9,]*';
                
                // Format on blur (when user clicks out)
                input.addEventListener('blur', function() {
                    formatNumberWithCommas(this);
                });
                
                // Remove commas on focus (when user clicks in)
                input.addEventListener('focus', function() {
                    removeCommas(this);
                });
            });
        }

        function setupPercentageFormatting() {
            // Select all percentage inputs
            const percentageInputs = document.querySelectorAll('input[type="number"][name*="percentage"], input[type="number"][name*="Percentage"], input[type="number"][name*="rate"], input[type="number"][name*="Rate"], input[type="number"][min="0"][max="100"]');
            
            percentageInputs.forEach(input => {
                // Change input type to text to avoid browser interference
                input.type = 'text';
                input.pattern = '[0-9.]*';
                // Format on blur (when user clicks out)
                input.addEventListener('blur', function() {
                    formatPercentage(this);
                });
                
                // Remove % on focus (when user clicks in)
                input.addEventListener('focus', function() {
                    removePercentage(this);
                });
            });
        }

        function formatPercentage(input) {
            if (!input.value || input.value.trim() === '') return;
            
            // Remove any existing % and get the raw number
            let rawValue = input.value.replace(/%/g, '');
            
            // Only proceed if it's a valid number
            if (isNaN(parseFloat(rawValue))) return;
            
            // Add % symbol
            const num = parseFloat(rawValue);
            const formatted = num + '%';
            
            // Only update if the formatting is different
            if (formatted !== input.value) {
                input.value = formatted;
            }
        }

        function removePercentage(input) {
            // Remove % symbol when user clicks in
            if (input.value && input.value.includes('%')) {
                input.value = input.value.replace(/%/g, '');
            }
        }

        // ========== ACCOUNT MANAGEMENT FUNCTIONS ==========
        
        let allAccounts = [];
        let currentAccountDetails = null;
        let currentAccountRole = 'client';
        // ACCOUNT_META_KEY is defined earlier in the file

        function renderAccountsTable() {
            const container = document.getElementById('accounts-table-container');
            if (!container) return;

            // Get all accounts from localStorage directly
            let credentials = {};
            let internalCreds = {};
            try { credentials = getClientCredentials(); } catch (e) { credentials = JSON.parse(localStorage.getItem('clientCredentials') || '{}'); }
            try { internalCreds = getInternalCredentials(); } catch (e) { internalCreds = JSON.parse(localStorage.getItem('internalCredentials') || '{}'); }
            
            const meta = getAccountMeta();
            
            // Combine all usernames from both stores and deduplicate
            const allUsernames = new Set([
                ...Object.keys(credentials),
                ...Object.keys(internalCreds)
            ]);
            
            // Build account list, prioritizing internalCreds if account exists in both
            allAccounts = Array.from(allUsernames).map(username => {
                // Check which store has the password (prioritize internal if both exist)
                const password = internalCreds[username] || credentials[username];
                const inInternal = !!internalCreds[username];
                const inClient = !!credentials[username];
                
                // Determine role: use meta if set, otherwise infer from store location
                let role = meta[username]?.role;
                if (!role) {
                    role = inInternal ? 'internal' : 'client';
                }
                
                return {
                    username,
                    password,
                    role: role.toLowerCase(),
                    status: meta[username]?.status || 'active',
                    createdAt: meta[username]?.createdAt || null
                };
            });

            // Get search filter
            const searchInput = document.getElementById('account-search-input');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            
            // Filter accounts based on search
            let filteredAccounts = allAccounts;
            if (searchTerm) {
                filteredAccounts = allAccounts.filter(account => 
                    account.username.toLowerCase().includes(searchTerm) || (account.status || '').toLowerCase().includes(searchTerm)
                );
            }

            // Get submissions and drafts for each account
            filteredAccounts = filteredAccounts.map(account => {
                const submissions = getAccountSubmissions(account.username);
                const drafts = getAccountDrafts(account.username);
                const lastActivity = getLastActivityDate(submissions, drafts);
                
                return {
                    ...account,
                    submissionCount: submissions.length,
                    draftCount: drafts.length,
                    lastActivity: lastActivity
                };
            });

            // Sort by username
            filteredAccounts.sort((a, b) => a.username.localeCompare(b.username));

            // Build table HTML
            let html = '<table class="accounts-table">';
            html += '<thead><tr>';
            html += '<th>Username</th>';
            html += '<th>Role</th>';
            html += '<th>Status</th>';
            html += '<th>Password</th>';
            html += '<th>Submissions</th>';
            html += '<th>Drafts</th>';
            html += '<th>Last Activity</th>';
            html += '<th>Actions</th>';
            html += '</tr></thead><tbody>';

            if (filteredAccounts.length === 0) {
                html += '<tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--text-secondary);">No accounts found</td></tr>';
            } else {
                filteredAccounts.forEach((account, index) => {
                    const safeId = `pwd-${index}`;
                    html += '<tr>';
                    html += `<td>${escapeHtml(account.username)}</td>`;
                    html += `<td style="text-transform: capitalize;">${escapeHtml(account.role || 'client')}</td>`;
                    const status = (account.status || 'active').toLowerCase();
                    const statusColor = status === 'pending' ? '#f59e0b' : '#16a34a';
                    html += `<td><span style="color:${statusColor}; font-weight:600; text-transform: capitalize;">${escapeHtml(status)}</span></td>`;
                    html += `<td><div class="password-display"><span class="password-masked" id="${safeId}" data-password="${escapeHtml(account.password)}">${'â€¢'.repeat(account.password.length)}</span><button type="button" class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" data-password-id="${safeId}" onclick="togglePasswordVisibility(this.getAttribute('data-password-id'))">Show</button></div></td>`;
                    html += `<td>${account.submissionCount}</td>`;
                    html += `<td>${account.draftCount}</td>`;
                    html += `<td>${account.lastActivity || 'Never'}</td>`;
                    html += '<td><div class="account-actions">';
                    html += `<button type="button" class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" data-username="${escapeHtml(account.username)}" data-role="${escapeHtml(account.role || 'client')}" onclick="viewAccountDetails(this.getAttribute('data-username'), this.getAttribute('data-role'))">View</button>`;
                    html += `<button type="button" class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" data-username="${escapeHtml(account.username)}" data-role="${escapeHtml(account.role || 'client')}" onclick="changeAccountPassword(this.getAttribute('data-username'), this.getAttribute('data-role'))">Change Password</button>`;
                    html += `<button type="button" class="btn btn-danger" style="padding: 4px 8px; font-size: 11px;" data-username="${escapeHtml(account.username)}" data-role="${escapeHtml(account.role || 'client')}" onclick="deleteAccount(this.getAttribute('data-username'), this.getAttribute('data-role'))">Delete</button>`;
                    html += '</div></td>';
                    html += '</tr>';
                });
            }

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function togglePasswordVisibility(passwordId) {
            const passwordSpan = document.getElementById(passwordId);
            if (!passwordSpan) return;
            
            const button = passwordSpan.nextElementSibling;
            const password = passwordSpan.getAttribute('data-password');
            
            if (!password || !button) return;

            if (button.textContent === 'Show') {
                passwordSpan.textContent = password;
                button.textContent = 'Hide';
            } else {
                passwordSpan.textContent = 'â€¢'.repeat(password.length);
                button.textContent = 'Show';
            }
        }

        function toggleInputVisibility(inputId, btn) {
            const input = document.getElementById(inputId);
            if (!input || !btn) return;
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'Hide';
            } else {
                input.type = 'password';
                btn.textContent = 'Show';
            }
        }

        function getAccountSubmissions(username) {
            return allSubmissions.filter(submission => {
                const submitterName = (submission.submitterName || submission.cityCounty || '').toLowerCase();
                return submitterName === username.toLowerCase();
            });
        }

        function getAccountDrafts(username) {
            const drafts = JSON.parse(localStorage.getItem(`clientDrafts_${username}`) || '[]');
            return drafts;
        }

        function getLastActivityDate(submissions, drafts) {
            let lastDate = null;
            
            // Check submissions
            submissions.forEach(sub => {
                const date = sub.timestamp ? new Date(sub.timestamp) : null;
                if (date && (!lastDate || date > lastDate)) {
                    lastDate = date;
                }
            });
            
            // Check drafts
            drafts.forEach(draft => {
                const date = draft.savedAt ? new Date(draft.savedAt) : null;
                if (date && (!lastDate || date > lastDate)) {
                    lastDate = date;
                }
            });
            
            return lastDate ? lastDate.toLocaleDateString() : null;
        }

        function viewAccountDetails(username, role = 'client') {
            currentAccountDetails = username;
            currentAccountRole = role;
            const modal = document.getElementById('account-details-modal');
            const title = document.getElementById('account-details-title');
            const content = document.getElementById('account-details-content');
            
            if (!modal || !title || !content) return;

            const submissions = getAccountSubmissions(username);
            const drafts = getAccountDrafts(username);

            title.textContent = `Account Details: ${escapeHtml(username)}`;
            
            let html = '';
            
            // Submissions section
            html += '<div class="account-details-section">';
            html += `<h4>Submissions (${submissions.length})</h4>`;
            if (submissions.length === 0) {
                html += '<p style="color: var(--text-secondary);">No submissions found.</p>';
            } else {
                submissions.forEach((sub, index) => {
                    const projectArea = sub.projectAreaName || sub.projectArea || 'N/A';
                    const year = sub.year || sub.fy || 'N/A';
                    const date = sub.timestamp ? new Date(sub.timestamp).toLocaleString() : 'N/A';
                    html += `<div class="submission-item">`;
                    html += `<strong>${index + 1}. ${escapeHtml(projectArea)}</strong> - Year: ${year} - Submitted: ${date}`;
                    html += `</div>`;
                });
            }
            html += '</div>';

            // Drafts section
            html += '<div class="account-details-section">';
            html += `<h4>Saved Drafts (${drafts.length})</h4>`;
            if (drafts.length === 0) {
                html += '<p style="color: var(--text-secondary);">No saved drafts found.</p>';
            } else {
                drafts.forEach((draft, index) => {
                    const year = draft.year || 'N/A';
                    const date = draft.savedAt ? new Date(draft.savedAt).toLocaleString() : 'N/A';
                    html += `<div class="draft-item">`;
                    html += `<strong>${index + 1}. Draft ${draft.id}</strong> - Year: ${year} - Saved: ${date}`;
                    html += `</div>`;
                });
            }
            html += '</div>';

            content.innerHTML = html;
            
            // Reset password management section
            const passwordInput = document.getElementById('account-new-password');
            const copyBtn = document.getElementById('copy-password-btn');
            const savePasswordBtn = document.getElementById('save-password-btn');
            const messageDiv = document.getElementById('password-management-message');
            
            if (passwordInput) {
                passwordInput.value = '';
                passwordInput.setAttribute('readonly', 'readonly');
            }
            if (copyBtn) copyBtn.style.display = 'none';
            if (savePasswordBtn) savePasswordBtn.style.display = 'none';
            if (messageDiv) {
                messageDiv.style.display = 'none';
                messageDiv.textContent = '';
            }
            
            modal.classList.remove('hidden');
        }

        function deleteAccount(username, role = 'client') {
            currentAccountDetails = username;
            currentAccountRole = role;
            const modal = document.getElementById('delete-account-modal');
            const warning = document.getElementById('delete-account-warning');
            
            if (!modal || !warning) return;

            const submissions = getAccountSubmissions(username);
            const drafts = getAccountDrafts(username);

            warning.textContent = `Are you sure you want to delete the account "${escapeHtml(username)}"? This account has ${submissions.length} submission(s) and ${drafts.length} draft(s).`;
            
            modal.classList.remove('hidden');
        }

        function changeAccountPassword(username, role = 'client') {
            currentAccountDetails = username;
            currentAccountRole = role;
            const modal = document.getElementById('change-password-modal');
            
            if (!modal) return;

            // Reset form
            document.getElementById('change-password-new').value = '';
            document.getElementById('change-password-confirm').value = '';
            const errorDiv = document.getElementById('change-password-error');
            if (errorDiv) {
                errorDiv.classList.add('hidden');
                errorDiv.textContent = '';
            }

            modal.classList.remove('hidden');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function setupAccountManagement() {
            // Search functionality
            const searchInput = document.getElementById('account-search-input');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    renderAccountsTable();
                });
            }

            // Add account button
            const addAccountBtn = document.getElementById('add-account-btn');
            if (addAccountBtn) {
                addAccountBtn.addEventListener('click', function() {
                    const modal = document.getElementById('add-account-modal');
                    if (modal) {
                        // Reset form
                        document.getElementById('new-account-username').value = '';
                        document.getElementById('new-account-password').value = '';
                        document.getElementById('new-account-password-confirm').value = '';
                        const roleSelect = document.getElementById('new-account-role');
                        if (roleSelect) roleSelect.value = 'client';
                        const errorDiv = document.getElementById('add-account-error');
                        if (errorDiv) {
                            errorDiv.classList.add('hidden');
                            errorDiv.textContent = '';
                        }
                        modal.classList.remove('hidden');
                    }
                });
            }

            // Add account form submission
            const addAccountForm = document.getElementById('add-account-form');
            if (addAccountForm) {
                addAccountForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const username = document.getElementById('new-account-username').value.trim();
                    const password = document.getElementById('new-account-password').value;
                    const passwordConfirm = document.getElementById('new-account-password-confirm').value;
                    const role = (document.getElementById('new-account-role')?.value || 'client').toLowerCase();
                    const errorDiv = document.getElementById('add-account-error');
                    const emailRegex = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
                    // Require 8+ chars, at least one letter and one digit; allow symbols
                    const strongPassword = /^(?=.*[A-Za-z])(?=.*\d).{8,}$/;
                    
                    // Validation
                    if (!username) {
                        errorDiv.textContent = 'Email is required.';
                        errorDiv.classList.remove('hidden');
                        return;
                    }
                    
                    if (!emailRegex.test(username)) {
                        errorDiv.textContent = 'Enter a valid email address.';
                        errorDiv.classList.remove('hidden');
                        return;
                    }
                    
                    if (!password) {
                        errorDiv.textContent = 'Password is required.';
                        errorDiv.classList.remove('hidden');
                        return;
                    }

                    if (!strongPassword.test(password)) {
                        errorDiv.textContent = 'Password must be 8+ characters and include at least one letter and one number.';
                        errorDiv.classList.remove('hidden');
                        return;
                    }
                    
                    if (password !== passwordConfirm) {
                        errorDiv.textContent = 'Passwords do not match.';
                        errorDiv.classList.remove('hidden');
                        return;
                    }
                    
                    // Check if account already exists in either role
                    let credentials = {};
                    let internalCreds = {};
                    try { credentials = getClientCredentials(); } catch (e) { credentials = JSON.parse(localStorage.getItem('clientCredentials') || '{}'); }
                    try { internalCreds = getInternalCredentials(); } catch (e) { internalCreds = JSON.parse(localStorage.getItem('internalCredentials') || '{}'); }
                    
                    if (credentials[username.toLowerCase()] || internalCreds[username.toLowerCase()]) {
                        errorDiv.textContent = 'An account with this email already exists.';
                        errorDiv.classList.remove('hidden');
                        return;
                    }
                    
                    // Create account in appropriate store
                    if (role === 'internal') {
                        internalCreds[username.toLowerCase()] = password;
                        saveInternalCredentials(internalCreds);
                    } else {
                        credentials[username.toLowerCase()] = password;
                        localStorage.setItem('clientCredentials', JSON.stringify(credentials));
                    }

                    // Save meta
                    const meta = getAccountMeta();
                    meta[username.toLowerCase()] = {
                        role,
                        status: 'active',
                        createdAt: new Date().toISOString()
                    };
                    saveAccountMeta(meta);
                    
                    // Close modal and refresh table
                    document.getElementById('add-account-modal').classList.add('hidden');
                    renderAccountsTable();
                    showNotification('Account created successfully!');
                });
            }

            // Add account modal close buttons
            const addAccountModalClose = document.getElementById('add-account-modal-close');
            const addAccountCancelBtn = document.getElementById('add-account-cancel-btn');
            if (addAccountModalClose) {
                addAccountModalClose.addEventListener('click', function() {
                    document.getElementById('add-account-modal').classList.add('hidden');
                });
            }
            if (addAccountCancelBtn) {
                addAccountCancelBtn.addEventListener('click', function() {
                    document.getElementById('add-account-modal').classList.add('hidden');
                });
            }

            // Account details modal close
            const accountDetailsModalClose = document.getElementById('account-details-modal-close');
            if (accountDetailsModalClose) {
                accountDetailsModalClose.addEventListener('click', function() {
                    document.getElementById('account-details-modal').classList.add('hidden');
                });
            }

            // Delete account modal
            const deleteAccountModalClose = document.getElementById('delete-account-modal-close');
            const deleteAccountCancelBtn = document.getElementById('delete-account-cancel-btn');
            const deleteAccountConfirmBtn = document.getElementById('delete-account-confirm-btn');
            
            if (deleteAccountModalClose) {
                deleteAccountModalClose.addEventListener('click', function() {
                    document.getElementById('delete-account-modal').classList.add('hidden');
                });
            }
            if (deleteAccountCancelBtn) {
                deleteAccountCancelBtn.addEventListener('click', function() {
                    document.getElementById('delete-account-modal').classList.add('hidden');
                });
            }
            if (deleteAccountConfirmBtn) {
                deleteAccountConfirmBtn.addEventListener('click', function() {
                    if (!currentAccountDetails) return;
                    
                    const deleteOption = document.querySelector('input[name="delete-option"]:checked').value;
                    const username = currentAccountDetails;
                    
                    let credentials = {};
                    let internalCreds = {};
                    try { credentials = getClientCredentials(); } catch (e) { credentials = JSON.parse(localStorage.getItem('clientCredentials') || '{}'); }
                    try { internalCreds = getInternalCredentials(); } catch (e) { internalCreds = JSON.parse(localStorage.getItem('internalCredentials') || '{}'); }
                    
                    if (currentAccountRole === 'internal') {
                        delete internalCreds[username.toLowerCase()];
                        saveInternalCredentials(internalCreds);
                    } else {
                        delete credentials[username.toLowerCase()];
                        localStorage.setItem('clientCredentials', JSON.stringify(credentials));
                    }
                    
                    // Delete drafts if selected
                    if (deleteOption === 'account-drafts' || deleteOption === 'account-drafts-submissions') {
                        localStorage.removeItem(`clientDrafts_${username}`);
                    }
                    
                    // Delete submissions if selected
                    if (deleteOption === 'account-drafts-submissions') {
                        allSubmissions = allSubmissions.filter(submission => {
                            const submitterName = (submission.submitterName || submission.cityCounty || '').toLowerCase();
                            return submitterName !== username.toLowerCase();
                        });
                        localStorage.setItem('allSubmissions', JSON.stringify(allSubmissions));
                    }
                    
                    // Close modal and refresh table
                    document.getElementById('delete-account-modal').classList.add('hidden');
                    renderAccountsTable();
                    showNotification('Account deleted successfully!');
                    currentAccountDetails = null;
                });
            }

            // Change password form
            const changePasswordForm = document.getElementById('change-password-form');
            if (changePasswordForm) {
                changePasswordForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    if (!currentAccountDetails) return;
                    
                    const newPassword = document.getElementById('change-password-new').value;
                    const passwordConfirm = document.getElementById('change-password-confirm').value;
                    const errorDiv = document.getElementById('change-password-error');
                    
                    if (!newPassword) {
                        errorDiv.textContent = 'Password is required.';
                        errorDiv.classList.remove('hidden');
                        return;
                    }
                    
                    if (newPassword !== passwordConfirm) {
                        errorDiv.textContent = 'Passwords do not match.';
                        errorDiv.classList.remove('hidden');
                        return;
                    }

                    // Update password in correct store
                    let credentials = {};
                    let internalCreds = {};
                    try { credentials = getClientCredentials(); } catch (e) { credentials = JSON.parse(localStorage.getItem('clientCredentials') || '{}'); }
                    try { internalCreds = getInternalCredentials(); } catch (e) { internalCreds = JSON.parse(localStorage.getItem('internalCredentials') || '{}'); }
                    
                    if (currentAccountRole === 'internal') {
                        internalCreds[currentAccountDetails.toLowerCase()] = newPassword;
                        saveInternalCredentials(internalCreds);
                    } else {
                        credentials[currentAccountDetails.toLowerCase()] = newPassword;
                        localStorage.setItem('clientCredentials', JSON.stringify(credentials));
                    }
                    
                    // Close modal and refresh table
                    document.getElementById('change-password-modal').classList.add('hidden');
                    renderAccountsTable();
                    showNotification('Password changed successfully!');
                    currentAccountDetails = null;
                });
            }

            // Change password modal close buttons
            const changePasswordModalClose = document.getElementById('change-password-modal-close');
            const changePasswordCancelBtn = document.getElementById('change-password-cancel-btn');
            if (changePasswordModalClose) {
                changePasswordModalClose.addEventListener('click', function() {
                    document.getElementById('change-password-modal').classList.add('hidden');
                });
            }
            if (changePasswordCancelBtn) {
                changePasswordCancelBtn.addEventListener('click', function() {
                    document.getElementById('change-password-modal').classList.add('hidden');
                });
            }
            
            // Password management in account details modal
            setupPasswordManagement();
        }
        
        function setupPasswordManagement() {
            const generateBtn = document.getElementById('generate-password-btn');
            const copyBtn = document.getElementById('copy-password-btn');
            const passwordInput = document.getElementById('account-new-password');
            const savePasswordBtn = document.getElementById('save-password-btn');
            const resetEmailBtn = document.getElementById('reset-password-email-btn');
            const messageDiv = document.getElementById('password-management-message');
            
            if (generateBtn) {
                generateBtn.addEventListener('click', function() {
                    const newPassword = generateSecurePassword();
                    if (passwordInput) {
                        passwordInput.value = newPassword;
                        passwordInput.removeAttribute('readonly');
                        passwordInput.type = 'text';
                    }
                    if (copyBtn) {
                        copyBtn.style.display = 'inline-block';
                    }
                    if (savePasswordBtn) {
                        savePasswordBtn.style.display = 'inline-block';
                    }
                    // Auto-save the password
                    if (currentAccountDetails) {
                        saveAccountPassword(currentAccountDetails, newPassword);
                        showPasswordMessage('Password generated and saved successfully!', 'success');
                    }
                });
            }
            
            if (copyBtn) {
                copyBtn.addEventListener('click', function() {
                    if (passwordInput && passwordInput.value) {
                        passwordInput.select();
                        passwordInput.setSelectionRange(0, 99999); // For mobile
                        try {
                            document.execCommand('copy');
                            showPasswordMessage('Password copied to clipboard!', 'success');
                            // Change button text temporarily
                            const originalText = copyBtn.textContent;
                            copyBtn.textContent = 'Copied!';
                            setTimeout(() => {
                                copyBtn.textContent = originalText;
                            }, 2000);
                        } catch (err) {
                            showPasswordMessage('Failed to copy. Please select and copy manually.', 'error');
                        }
                    }
                });
            }
            
            if (savePasswordBtn) {
                savePasswordBtn.addEventListener('click', function() {
                    if (!currentAccountDetails) return;
                    const newPassword = passwordInput ? passwordInput.value : '';
                    if (!newPassword) {
                        showPasswordMessage('Please generate or enter a password first.', 'error');
                        return;
                    }
                    saveAccountPassword(currentAccountDetails, newPassword);
                    showPasswordMessage('Password saved successfully!', 'success');
                    if (passwordInput) {
                        passwordInput.value = '';
                        passwordInput.setAttribute('readonly', 'readonly');
                    }
                    if (copyBtn) copyBtn.style.display = 'none';
                    if (savePasswordBtn) savePasswordBtn.style.display = 'none';
                    renderAccountsTable();
                });
            }
            
            if (resetEmailBtn) {
                resetEmailBtn.addEventListener('click', function() {
                    if (!currentAccountDetails) return;
                    sendPasswordResetEmail(currentAccountDetails);
                });
            }
        }
        
        function generateSecurePassword() {
            const length = 16;
            const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const lowercase = 'abcdefghijklmnopqrstuvwxyz';
            const numbers = '0123456789';
            const symbols = '!@#$%^&*()_+-=[]{}|;:,.<>?';
            const allChars = uppercase + lowercase + numbers + symbols;
            
            let password = '';
            // Ensure at least one of each type
            password += uppercase[Math.floor(Math.random() * uppercase.length)];
            password += lowercase[Math.floor(Math.random() * lowercase.length)];
            password += numbers[Math.floor(Math.random() * numbers.length)];
            password += symbols[Math.floor(Math.random() * symbols.length)];
            
            // Fill the rest randomly
            for (let i = password.length; i < length; i++) {
                password += allChars[Math.floor(Math.random() * allChars.length)];
            }
            
            // Shuffle the password
            return password.split('').sort(() => Math.random() - 0.5).join('');
        }
        
        function saveAccountPassword(username, newPassword) {
            let credentials = {};
            let internalCreds = {};
            try { credentials = getClientCredentials(); } catch (e) { credentials = JSON.parse(localStorage.getItem('clientCredentials') || '{}'); }
            try { internalCreds = getInternalCredentials(); } catch (e) { internalCreds = JSON.parse(localStorage.getItem('internalCredentials') || '{}'); }
            
            if (currentAccountRole === 'internal') {
                internalCreds[username.toLowerCase()] = newPassword;
                saveInternalCredentials(internalCreds);
            } else {
                credentials[username.toLowerCase()] = newPassword;
                localStorage.setItem('clientCredentials', JSON.stringify(credentials));
            }
        }
        
        function sendPasswordResetEmail(email) {
            const emailConfig = getEmailConfig();
            const smtpConfigured = emailConfig.host && emailConfig.port && emailConfig.user && emailConfig.pass;
            
            if (smtpConfigured) {
                // In a real implementation, this would call the API
                showPasswordMessage('Password reset email sent successfully!', 'success');
            } else {
                showPasswordMessage('SMTP not configured. Please use the password generator to create a new password.', 'error');
            }
        }
        
        function showPasswordMessage(message, type) {
            const messageDiv = document.getElementById('password-management-message');
            if (!messageDiv) return;
            
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            messageDiv.style.backgroundColor = type === 'success' ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';
            messageDiv.style.color = type === 'success' ? '#10b981' : '#ef4444';
            messageDiv.style.border = `1px solid ${type === 'success' ? '#10b981' : '#ef4444'}`;
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // Utility function to convert client to internal user
        function convertClientToInternal(email) {
            const emailLower = email.toLowerCase();
            
            // Get credentials
            let clientCreds = {};
            let internalCreds = {};
            try { 
                clientCreds = getClientCredentials(); 
            } catch (e) { 
                clientCreds = JSON.parse(localStorage.getItem('clientCredentials') || '{}'); 
            }
            try { 
                internalCreds = getInternalCredentials(); 
            } catch (e) { 
                internalCreds = JSON.parse(localStorage.getItem('internalCredentials') || '{}'); 
            }
            
            // Get password from either location
            let password = clientCreds[emailLower] || internalCreds[emailLower];
            
            if (!password) {
                console.error(`Account ${email} not found in credentials`);
                return false;
            }
            
            // Move to internal credentials if not already there
            if (clientCreds[emailLower]) {
                internalCreds[emailLower] = password;
                delete clientCreds[emailLower];
                localStorage.setItem('clientCredentials', JSON.stringify(clientCreds));
            } else if (!internalCreds[emailLower]) {
                internalCreds[emailLower] = password;
            }
            saveInternalCredentials(internalCreds);
            
            // Update account meta
            const meta = getAccountMeta();
            if (meta[emailLower]) {
                meta[emailLower].role = 'internal';
            } else {
                meta[emailLower] = { role: 'internal', status: 'active', createdAt: new Date().toISOString() };
            }
            saveAccountMeta(meta);
            
            console.log(`Successfully converted ${email} to internal user`);
            return true;
        }
        
        // Expose conversion function globally
        if (typeof window !== 'undefined') {
            window.convertToInternal = convertClientToInternal;
            window.convertClientToInternal = convertClientToInternal;
            
            // Debug function to check account status
            window.checkAccountStatus = function(email) {
                const emailLower = (email || 'r@teambarker.com').toLowerCase();
                const clientCreds = getClientCredentials();
                const internalCreds = getInternalCredentials();
                const meta = getAccountMeta();
                
                console.log('=== ACCOUNT STATUS FOR:', emailLower, '===');
                console.log('In clientCreds:', !!clientCreds[emailLower], clientCreds[emailLower] ? 'YES' : 'NO');
                console.log('In internalCreds:', !!internalCreds[emailLower], internalCreds[emailLower] ? 'YES' : 'NO');
                console.log('Meta role:', meta[emailLower]?.role || 'NOT SET');
                console.log('Meta data:', meta[emailLower]);
                console.log('==========================================');
                
                return {
                    inClient: !!clientCreds[emailLower],
                    inInternal: !!internalCreds[emailLower],
                    role: meta[emailLower]?.role || 'NOT SET',
                    meta: meta[emailLower]
                };
            };
            
            // Force convert function (more aggressive)
            window.forceConvertToInternal = function(email) {
                const emailLower = (email || 'r@teambarker.com').toLowerCase();
                console.log('FORCE CONVERTING:', emailLower);
                
                const clientCreds = getClientCredentials();
                const internalCreds = getInternalCredentials();
                const meta = getAccountMeta();
                
                // Get password from either location
                const password = clientCreds[emailLower] || internalCreds[emailLower];
                
                if (!password) {
                    console.error('NO PASSWORD FOUND for', emailLower);
                    return false;
                }
                
                // ALWAYS put in internal creds
                internalCreds[emailLower] = password;
                saveInternalCredentials(internalCreds);
                
                // Remove from client creds if it's there
                if (clientCreds[emailLower]) {
                    delete clientCreds[emailLower];
                    localStorage.setItem('clientCredentials', JSON.stringify(clientCreds));
                }
                
                // ALWAYS set role to internal
                if (!meta[emailLower]) {
                    meta[emailLower] = {};
                }
                meta[emailLower].role = 'internal';
                meta[emailLower].status = 'active';
                if (!meta[emailLower].createdAt) {
                    meta[emailLower].createdAt = new Date().toISOString();
                }
                saveAccountMeta(meta);
                
                console.log('FORCE CONVERSION COMPLETE');
                console.log('Password now in internalCreds:', !!internalCreds[emailLower]);
                console.log('Role set to:', meta[emailLower].role);
                
                return true;
            };
        }

        // Initialize account management when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupAccountManagement);
        } else {
            setupAccountManagement();
        }

        // ========== TEST DATA FILLERS ==========
        // Quick test data macros to fill forms for testing
        
        async function fillExternalFormTestData() {
            const form = document.getElementById('project-form');
            if (!form) {
                alert('External form not found. Make sure you are on the External Data Request tab.');
                return;
            }

            // Year
            const yearSelect = document.getElementById('external-year-select');
            if (yearSelect) yearSelect.value = '2025';

            // County, Agency/Submitter, and Project Area selections
            const countyDropdown = document.getElementById('external-county-dropdown');
            const agencyDropdown = document.getElementById('external-agency-dropdown');
            const projectDropdown = document.getElementById('external-project-dropdown');
            
            if (countyDropdown) {
                await populateExternalCountyDropdown();
                if (countyDropdown.options.length > 1) {
                    countyDropdown.value = countyDropdown.options[1].value;
                }
                await handleExternalCountyChange();
            }
            
            if (agencyDropdown && agencyDropdown.options.length > 1) {
                agencyDropdown.value = agencyDropdown.options[1].value;
                await populateExternalProjectDropdown();
            }
            
            if (projectDropdown && projectDropdown.options.length > 1) {
                projectDropdown.value = projectDropdown.options[1].value;
            }

            // Basic info
            form.querySelector('input[name="acreage"]').value = '125';
            form.querySelector('input[name="creationYear"]').value = '2015';
            form.querySelector('input[name="baseYear"]').value = '2015';
            form.querySelector('input[name="termLength"]').value = '30';
            form.querySelector('input[name="startYear"]').value = '2015';
            form.querySelector('input[name="expirationYear"]').value = '2045';
            form.querySelector('input[name="baseValue"]').value = '5000000';
            form.querySelector('input[name="fyIncrement"]').value = '250000';

            // Financial
            form.querySelector('input[name="fundBalance"]').value = '1250000';
            form.querySelector('textarea[name="descriptionGrowthAssessedValue"]').value = 
                'Test Development: 150 residential units, 50,000 sq ft commercial space, 25,000 sq ft industrial. Recent developments include new shopping center and residential complex.';
            form.querySelector('textarea[name="plannedUsesFundBalance"]').value = 
                'Infrastructure improvements, public facilities, economic development incentives, and administrative costs.';

            // Expenses
            const expenseTitle0 = form.querySelector('input[name="expenseTitle_0"]');
            const tyExpense0 = form.querySelector('input[name="tyExpense_0"]');
            const cyExpense0 = form.querySelector('input[name="cyExpense_0"]');
            const nyExpense0 = form.querySelector('input[name="nyExpense_0"]');
            if (expenseTitle0) expenseTitle0.value = 'Administrative';
            if (tyExpense0) tyExpense0.value = '50000';
            if (cyExpense0) cyExpense0.value = '50000';
            if (nyExpense0) nyExpense0.value = '55000';

            // Development
            form.querySelector('input[name="developedAcreage"]').value = '85';
            form.querySelector('input[name="undevelopedAcreage"]').value = '40';
            form.querySelector('input[name="residentialAcreage"]').value = '60';
            form.querySelector('input[name="totalAuthorizedHousingUnits"]').value = '150';

            // Descriptions
            form.querySelector('textarea[name="descriptionSignificantDevelopment"]').value = 
                'Major mixed-use development with residential, commercial, and retail components. Infrastructure improvements completed including roads, utilities, and public spaces.';
            form.querySelector('textarea[name="descriptionPlanFurthered"]').value = 
                'Development plan implementation on schedule. All phases completed as planned with strong community support and economic impact.';
            form.querySelector('textarea[name="descriptionOtherIssues"]').value = 
                'No significant issues to report. Project proceeding as expected.';

            // Trigger calculations
            if (typeof calculateRemainingLife === 'function') calculateRemainingLife();
            if (typeof calculateExpenseTotal === 'function') calculateExpenseTotal(0);
            if (typeof calculatePercentResidential === 'function') calculatePercentResidential();

            alert('âœ“ External form filled with test data!');
        }

        function fillInternalFormTestData() {
            const form = document.getElementById('internal-data-request-form');
            if (!form) {
                alert('Internal form not found. Make sure you are on the Internal Data Request tab.');
                return;
            }

            // Year
            const yearSelect = document.getElementById('internal-year-select');
            if (yearSelect) yearSelect.value = '2025';

            // Client and Project - try to select first option
            const clientDropdown = document.getElementById('internal-city-dropdown');
            if (clientDropdown && clientDropdown.options.length > 1) {
                clientDropdown.value = clientDropdown.options[1].value;
            }
            const projectDropdown = document.getElementById('internal-project-dropdown');
            if (projectDropdown && projectDropdown.options.length > 1) {
                projectDropdown.value = projectDropdown.options[1].value;
            }

            // Fiscal and Tax Year
            const fySelect = form.querySelector('select[name="fy"]');
            if (fySelect) fySelect.value = '2025';
            const tySelect = form.querySelector('select[name="ty"]');
            if (tySelect) tySelect.value = '2024';
            form.querySelector('select[name="type"]').value = 'EDA';
            form.querySelector('select[name="purpose"]').value = 'Mixed-Used Development';
            form.querySelector('input[name="taxingDistrict"]').value = 'Test Taxing District';
            form.querySelector('input[name="taxRate"]').value = '2';

            // Value Information
            form.querySelector('input[name="tyValue"]').value = '7500000';
            // valueIncrease is readonly/calculated, but trigger calculation if function exists
            if (typeof calculateValueIncrease === 'function') calculateValueIncrease();

            // Tax Entities - fill first row if it exists
            const taxEntityName0 = form.querySelector('input[name="taxEntityName_0"]');
            const taxEntityParticipationRate0 = form.querySelector('input[name="taxEntityParticipationRate_0"]');
            const taxEntityRemittance0 = form.querySelector('input[name="taxEntityRemittance_0"]');
            const taxEntityCapAmount0 = form.querySelector('input[name="taxEntityCapAmount_0"]');
            const taxEntityIncrementPaid0 = form.querySelector('input[name="taxEntityIncrementPaid_0"]');
            const taxEntityRemainingAuthorized0 = form.querySelector('input[name="taxEntityRemainingAuthorized_0"]');
            
            if (taxEntityName0) taxEntityName0.value = 'City of Test';
            if (taxEntityParticipationRate0) taxEntityParticipationRate0.value = '50';
            if (taxEntityRemittance0) taxEntityRemittance0.value = '25';
            if (taxEntityCapAmount0) taxEntityCapAmount0.value = '1000000';
            if (taxEntityIncrementPaid0) taxEntityIncrementPaid0.value = '125000';
            if (taxEntityRemainingAuthorized0) taxEntityRemainingAuthorized0.value = '875000';

            // Total Expenses - fill first row if it exists
            const totalExpenseDesc0 = form.querySelector('input[name="totalExpenseDescription_0"]');
            const totalExpenseAmount0 = form.querySelector('input[name="totalExpenseAmount_0"]');
            const totalExpenseNpv0 = form.querySelector('input[name="totalExpenseNpv_0"]');
            
            if (totalExpenseDesc0) totalExpenseDesc0.value = 'Infrastructure Development';
            if (totalExpenseAmount0) totalExpenseAmount0.value = '500000';
            if (totalExpenseNpv0) totalExpenseNpv0.value = '475000';

            // Revenue Information
            form.querySelector('input[name="tyOriginalBudgetRevenues"]').value = '300000';
            form.querySelector('input[name="tyActualRevenue"]').value = '325000';
            form.querySelector('input[name="tyBaseYearRevenue"]').value = '50000';
            form.querySelector('input[name="lifetimeRevenues"]').value = '5000000';
            form.querySelector('input[name="lifetimeActualRevenues"]').value = '5200000';
            form.querySelector('input[name="lifetimeBaseYearRevenues"]').value = '800000';

            // Sources of Funds (2025 SOURCES OF FUNDS)
            const revenueSourceDesc0 = form.querySelector('input[name="revenueSourceDescription_0"]');
            const revenueSource2025Actual0 = form.querySelector('input[name="revenueSource2025Actual_0"]');
            const revenueSource2026Forecast0 = form.querySelector('input[name="revenueSource2026Forecast_0"]');
            const revenueSource2027Forecast0 = form.querySelector('input[name="revenueSource2027Forecast_0"]');
            if (revenueSourceDesc0) revenueSourceDesc0.value = 'Property Tax Increment';
            if (revenueSource2025Actual0) revenueSource2025Actual0.value = '300000';
            if (revenueSource2026Forecast0) revenueSource2026Forecast0.value = '320000';
            if (revenueSource2027Forecast0) revenueSource2027Forecast0.value = '340000';

            // Tax Increment Summary
            const taxIncrementEntity0 = form.querySelector('input[name="taxIncrementEntity_0"]');
            const taxIncrementYearActual0 = form.querySelector('input[name="taxIncrementYearActual_0"]');
            const taxIncrementRemainingAuthorized0 = form.querySelector('input[name="taxIncrementRemainingAuthorized_0"]');
            if (taxIncrementEntity0) taxIncrementEntity0.value = 'City of Test';
            if (taxIncrementYearActual0) taxIncrementYearActual0.value = '125000';
            if (taxIncrementRemainingAuthorized0) taxIncrementRemainingAuthorized0.value = '875000';

            // Project Area Budget
            form.querySelector('input[name="propertyTaxIncrementTotal"]').value = '300000';
            form.querySelector('input[name="propertyTaxIncrementNpv"]').value = '285000';
            form.querySelector('input[name="administrativeFeeTotal"]').value = '50000';
            form.querySelector('input[name="administrativeFeeNpv"]').value = '47500';
            form.querySelector('input[name="expenseTotal"]').value = '250000';
            form.querySelector('input[name="expenseNpv"]').value = '237500';

            // Financial Analysis
            form.querySelector('input[name="administrativePercentage"]').value = '10';
            form.querySelector('input[name="discountRate"]').value = '3';
            form.querySelector('input[name="aggregateRemainingRevenue"]').value = '2000000';
            form.querySelector('input[name="discountedAggregateRemainingRevenue"]').value = '1900000';
            form.querySelector('input[name="totalAggregateExpense"]').value = '500000';
            form.querySelector('input[name="totalAggregateExpenseAtNpv"]').value = '475000';

            // Governing Board of Trustees
            const governingBoardName0 = form.querySelector('input[name="governingBoardName_0"]');
            const governingBoardTitle0 = form.querySelector('input[name="governingBoardTitle_0"]');
            if (governingBoardName0) governingBoardName0.value = 'John Smith';
            if (governingBoardTitle0) governingBoardTitle0.value = 'Chairman';

            // Agency Staff
            const agencyStaffName0 = form.querySelector('input[name="agencyStaffName_0"]');
            const agencyStaffTitle0 = form.querySelector('input[name="agencyStaffTitle_0"]');
            if (agencyStaffName0) agencyStaffName0.value = 'Jane Doe';
            if (agencyStaffTitle0) agencyStaffTitle0.value = 'Executive Director';

            // Increment Distribution
            const incrementEntity0 = form.querySelector('input[name="incrementEntity_0"]');
            const incrementActual0 = form.querySelector('input[name="incrementActual_0"]');
            const incrementRemaining0 = form.querySelector('input[name="incrementRemaining_0"]');
            if (incrementEntity0) incrementEntity0.value = 'City of Test';
            if (incrementActual0) incrementActual0.value = '125000';
            if (incrementRemaining0) incrementRemaining0.value = '875000';

            // Descriptions
            const growthTextarea = form.querySelector('textarea[name="growthInAssessedValue"]');
            if (growthTextarea) {
                growthTextarea.value = 'Significant growth in assessed value due to new development. 150 residential units added, 50,000 sq ft commercial space developed.';
            }

            const benefitsTextarea = form.querySelector('textarea[name="descriptionOfBenefitsToTaxingEntities"]');
            if (benefitsTextarea) {
                benefitsTextarea.value = 'Taxing entities benefit from increased property values and economic development. Revenue sharing provides funding for public services and infrastructure.';
            }

            // Trigger calculations
            if (typeof updateTaxEntitiesTotal === 'function') updateTaxEntitiesTotal();
            if (typeof updateTotalUsesOfFunds === 'function') updateTotalUsesOfFunds();
            if (typeof calculateTotalRevenue === 'function') calculateTotalRevenue();
            if (typeof calculateTotalUsesOfFunds === 'function') calculateTotalUsesOfFunds();

            alert('âœ“ Internal form filled with test data!');
        }

        function setupTestDataFillers() {
            // External form test data button
            const externalTestBtn = document.getElementById('fill-test-data-external-btn');
            if (externalTestBtn) {
                externalTestBtn.onclick = fillExternalFormTestData;
            }

            // Internal form test data button
            const internalTestBtn = document.getElementById('fill-test-data-internal-btn');
            if (internalTestBtn) {
                internalTestBtn.onclick = fillInternalFormTestData;
            }

            // Also expose to window for console access
            window.fillExternalTestData = fillExternalFormTestData;
            window.fillInternalTestData = fillInternalFormTestData;
            
            console.log('ðŸ§ª Test data fillers ready! Use fillExternalTestData() or fillInternalTestData() in console, or click the ðŸ§ª buttons on the forms.');
        }

        // Initialize test data fillers
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupTestDataFillers);
        } else {
            setupTestDataFillers();
        }

        // ========== PROJECT SELECTION MODAL FOR REPORT GENERATION ==========
        function showProjectSelectionModal(city, year) {
            // Get all projects for this client/year
            const cityYearSubmissions = allSubmissions.filter(submission => {
                const submissionCity = submission.cityCounty || 
                                     submission.submitterName || 
                                     submission.client ||
                                     submission.agency ||
                                     submission.projectArea || 
                                     submission.projectAreaName ||
                                     'Unknown';
                const submissionYear = String(submission.year || submission.fy || submission.ty || 'Unknown');
                const targetYear = String(year || 'all');
                const cityMatch = submissionCity.toString().trim().toLowerCase() === city.toString().trim().toLowerCase();
                const yearMatch = targetYear === 'all' || submissionYear === targetYear;
                return cityMatch && yearMatch;
            });

            if (cityYearSubmissions.length === 0) {
                showNotification(`No projects found for ${city}${year ? ` - ${year}` : ''}.`);
                return;
            }

            // Create modal
            const modal = document.createElement('div');
            modal.id = 'project-selection-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 8px;
                padding: 24px;
                max-width: 600px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            `;

            modalContent.innerHTML = `
                <h2 style="margin: 0 0 20px 0; color: var(--primary-blue);">Select Projects for Report</h2>
                <p style="margin: 0 0 16px 0; color: #666;">Select which projects to include in the report for <strong>${city}</strong>${year ? ` - ${year}` : ''}:</p>
                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" id="select-all-projects" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <strong>Select All</strong>
                    </label>
                </div>
                <div id="project-selection-list" style="margin-bottom: 20px; max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 12px;">
                    ${cityYearSubmissions.map((submission, idx) => {
                        const projectArea = submission.projectArea || submission.projectAreaName || 'N/A';
                        const submissionYear = submission.year || submission.fy || submission.ty || year || 'N/A';
                        const type = submission.type || 'N/A';
                        const purpose = submission.purpose || 'N/A';
                        const submissionId = submission.id || `submission-${idx}`;
                        return `
                            <label style="display: flex; align-items: center; gap: 12px; padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s;" 
                                   onmouseover="this.style.background='#f5f5f5'" 
                                   onmouseout="this.style.background=''">
                                <input type="checkbox" class="project-checkbox" value="${submissionId}" checked style="width: 18px; height: 18px; cursor: pointer;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #333;">${projectArea}</div>
                                    <div style="font-size: 12px; color: #666;">Year: ${submissionYear} | Type: ${type} | Purpose: ${purpose}</div>
                                </div>
                            </label>
                        `;
                    }).join('')}
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="closeProjectSelectionModal()" class="btn btn-secondary" style="padding: 10px 20px;">Cancel</button>
                    <button onclick="generateReportWithSelectedProjects('${city}', '${year}')" class="btn btn-success" style="padding: 10px 20px;">Generate Report</button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Select all checkbox handler
            const selectAll = document.getElementById('select-all-projects');
            const checkboxes = modalContent.querySelectorAll('.project-checkbox');
            
            selectAll.addEventListener('change', function() {
                checkboxes.forEach(cb => cb.checked = this.checked);
            });

            // Close on background click
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeProjectSelectionModal();
                }
            });
        }

        function closeProjectSelectionModal() {
            const modal = document.getElementById('project-selection-modal');
            if (modal) {
                modal.remove();
            }
        }


        // Wrapper function to call generatePDFReport with selected projects
        function generateReportWithSelectedProjects(city, year) {
            const checkboxes = document.querySelectorAll('.project-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(cb => cb.value);

            if (selectedIds.length === 0) {
                showNotification('Please select at least one project to include in the report.');
                return;
            }

            closeProjectSelectionModal();
            
            // Call the existing generatePDFReport function, but we need to modify it to accept selected IDs
            // For now, store selected IDs in a closure variable
            window._selectedProjectIdsForReport = selectedIds;
            
            // Call the original generatePDFReport
            generatePDFReport(city, year);
        }

        // ============================================
        // REPORT GENERATION TEST FUNCTION
        // Run testReportGeneration() in console to test
        // ============================================
        function testReportGeneration() {
            console.log('=== PDF Report Generation Test ===\n');
            
            const tests = {
                functionsExist: [],
                dataMapping: [],
                errors: []
            };
            
            // Test 1: Check if all required functions exist
            console.log('1. Testing function existence...');
            const requiredFunctions = [
                'generatePDFReport',
                'generatePDFReportInternal',
                'addCoverPagePDFMake',
                'addTableOfContentsPDFMake',
                'addExecutiveSummaryIntroPDFMake',
                'addExecutiveSummaryPDFMake',
                'addGoverningBoardSectionPDFMake',
                'addCombinedBudgetSectionPDFMake',
                'addAcreageOverviewSectionPDFMake',
                'addIndividualProjectSectionsPDFMake',
                'addProjectAreaHeaderPDFMake',
                'addProjectAreaOverviewPDFMake',
                'addFundAccountabilityPDFMake',
                'addProjectAreaDevelopmentPDFMake',
                'addProjectAreaMapPDFMake',
                'showProjectSelectionModal'
            ];
            
            requiredFunctions.forEach(funcName => {
                const exists = typeof window[funcName] === 'function';
                tests.functionsExist.push({ name: funcName, exists });
                if (exists) {
                    console.log(`  âœ“ ${funcName} exists`);
                } else {
                    console.error(`  âœ— ${funcName} is missing`);
                    tests.errors.push(`Missing function: ${funcName}`);
                }
            });
            
            // Test 2: Check if PDFMake library is loaded
            console.log('\n2. Testing PDFMake library...');
            if (typeof pdfMake !== 'undefined') {
                console.log('  âœ“ pdfMake is loaded');
                if (typeof pdfMake.vfs !== 'undefined') {
                    console.log('  âœ“ pdfMake.vfs (fonts) is loaded');
                } else {
                    console.error('  âœ— pdfMake.vfs (fonts) is not loaded');
                    tests.errors.push('PDFMake fonts not loaded');
                }
            } else {
                console.error('  âœ— pdfMake is not loaded');
                tests.errors.push('PDFMake library not loaded');
            }
            
            // Test 3: Check data field mapping compatibility
            console.log('\n3. Testing data field mapping compatibility...');
            const testSubmission = {
                // Test both legacy and new field names
                cityCounty: 'Test City',
                submitterName: 'Test Agency',
                projectArea: 'Test Project',
                projectAreaName: 'Test Project Area',
                year: 2025,
                fy: 2025,
                type: 'CDA',
                projectType: 'CDA', // Legacy field
                purpose: 'Commercial Development',
                projectPurpose: 'Commercial Development', // Legacy field
                taxingDistrict: 'Test District',
                taxRate: '2',
                taxRate2024: '2', // Legacy field
                acreage: 125,
                developedAcreage: 85,
                undevelopedAcreage: 40,
                baseValue: 5000000,
                baseTaxableValue: 5000000, // Legacy field
                tyValue: 7500000,
                currentTaxableValue: 7500000, // Legacy field
                currentYearRevenue: 300000,
                fyIncrement: 300000, // Alternative field
                governingBoardName_0: 'John Smith',
                taxEntityName_0: 'City of Test'
            };
            
            // Test field access patterns used in PDFMake functions
            const fieldTests = [
                { 
                    name: 'Project Area Name (priority order)', 
                    test: () => {
                        let projectArea = testSubmission.projectAreaName || testSubmission.projectArea;
                        if (!projectArea) projectArea = testSubmission.submitterName || testSubmission.cityCounty;
                        return projectArea === 'Test Project Area';
                    }
                },
                { 
                    name: 'Type field (with legacy fallback)', 
                    test: () => {
                        const type = testSubmission.type || testSubmission.projectType || 'RDA';
                        return type === 'CDA';
                    }
                },
                { 
                    name: 'Purpose field (with legacy fallback)', 
                    test: () => {
                        const purpose = testSubmission.purpose || testSubmission.projectPurpose || 'Commercial Development';
                        return purpose === 'Commercial Development';
                    }
                },
                { 
                    name: 'Base Value (with legacy fallback)', 
                    test: () => {
                        const baseValue = parseFloat(testSubmission.baseValue || testSubmission.baseTaxableValue || 609648);
                        return baseValue === 5000000;
                    }
                },
                { 
                    name: 'Current Value (with legacy fallback)', 
                    test: () => {
                        const currentValue = parseFloat(testSubmission.tyValue || testSubmission.currentTaxableValue || 138913478);
                        return currentValue === 7500000;
                    }
                },
                { 
                    name: 'Acreage calculation', 
                    test: () => {
                        const acreage = parseFloat(testSubmission.acreage || 0);
                        const calculatedAcreage = parseFloat(testSubmission.developedAcreage || 0) + parseFloat(testSubmission.undevelopedAcreage || 0);
                        return acreage === 125 || calculatedAcreage === 125;
                    }
                }
            ];
            
            fieldTests.forEach(test => {
                try {
                    const passed = test.test();
                    tests.dataMapping.push({ name: test.name, passed });
                    if (passed) {
                        console.log(`  âœ“ ${test.name}`);
                    } else {
                        console.error(`  âœ— ${test.name}`);
                        tests.errors.push(`Data mapping error: ${test.name}`);
                    }
                } catch (error) {
                    console.error(`  âœ— ${test.name}: ${error.message}`);
                    tests.errors.push(`Data mapping error: ${test.name} - ${error.message}`);
                }
            });
            
            // Test 4: Check if submissions can be loaded
            console.log('\n4. Testing data loading...');
            try {
                if (typeof allSubmissions !== 'undefined') {
                    console.log(`  âœ“ allSubmissions array exists (${allSubmissions.length} submissions)`);
                } else {
                    console.warn('  âš  allSubmissions not defined (may need to load data first)');
                }
                
                // Test filtering logic (same as in generatePDFReportInternal)
                const testCity = 'Test City';
                const testYear = '2025';
                const filtered = typeof allSubmissions !== 'undefined' ? allSubmissions.filter(submission => {
                    const submissionCity = submission.cityCounty || submission.submitterName || 'Unknown';
                    const submissionYear = String(submission.year || submission.fy || 'Unknown');
                    return submissionCity === testCity && submissionYear === testYear;
                }) : [];
                
                console.log(`  âœ“ Filtering logic works (found ${filtered.length} submissions for ${testCity} - ${testYear})`);
                
            } catch (error) {
                console.error('  âœ— Error testing data loading:', error);
                tests.errors.push(`Data loading test error: ${error.message}`);
            }
            
            // Summary
            console.log('\n=== Test Summary ===');
            const totalFunctions = tests.functionsExist.length;
            const existingFunctions = tests.functionsExist.filter(f => f.exists).length;
            const totalFields = tests.dataMapping.length;
            const passedFields = tests.dataMapping.filter(f => f.passed).length;
            
            console.log(`Functions: ${existingFunctions}/${totalFunctions} exist`);
            console.log(`Data Mapping: ${passedFields}/${totalFields} passed`);
            console.log(`Errors: ${tests.errors.length}`);
            
            if (tests.errors.length === 0) {
                console.log('\nâœ“ All tests passed! Report generation should work correctly.');
                return { success: true, tests };
            } else {
                console.log('\nâœ— Some tests failed:');
                tests.errors.forEach(error => console.error(`  - ${error}`));
                return { success: false, tests, errors: tests.errors };
            }
        }
        
        // Make test function available globally
        window.testReportGeneration = testReportGeneration;
        console.log('Report generation test loaded. Run testReportGeneration() in the console to test.');
    </script>
    <script>
        // Safety net: ensure each major section sits beside (not inside) the others.
        (function registerSectionNormalizer() {
            function ensureStandaloneSections() {
                const internalContainer = document.getElementById('internal-container');
                if (!internalContainer) return;
                
                ['internal-data-request-container', 'account-management-container'].forEach(id => {
                    const section = document.getElementById(id);
                    if (section && internalContainer.contains(section)) {
                        internalContainer.insertAdjacentElement('afterend', section);
                    }
                });
            }
            
            // Run immediately in case DOM is already parsed
            ensureStandaloneSections();
            // Also run after DOMContentLoaded to catch late DOM mutations
            document.addEventListener('DOMContentLoaded', ensureStandaloneSections);
        })();
    </script>
</body>
</html> 