<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LRB Compliance Database</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="Pictures/lrb-circle-outlined.png" data-static="true">
            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #0ea5e9;
            --primary-blue-dark: #0284c7;
            --primary-blue-light: #e0f2fe;
            --secondary-blue: #38bdf8;
            --accent-blue: #7dd3fc;
            --success-green: #10b981;
            --warning-yellow: #f59e0b;
            --error-red: #ef4444;
            --neutral-gray: #6b7280;
            --light-gray: #f3f4f6;
            --border-gray: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #374151;
            --text-muted: #6b7280;
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --border-radius: 8px;
            --border-radius-lg: 12px;
            --font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 14px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
        }

        .header .container {
            max-width: none;
            margin: 0;
            padding: 0 24px;
        }

        .header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-gray);
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo img {
            height: 40px;
            width: auto;
            border-radius: 0;
            object-fit: contain;
        }

        .logo-text {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .main-content {
            padding: 32px 0;
            min-height: calc(100vh - 80px);
        }

        .card {
            background: var(--bg-primary);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-gray);
            overflow: hidden;
        }

        .card-header {
            padding: 24px 32px;
            border-bottom: 1px solid var(--border-gray);
            background: var(--bg-secondary);
        }

        .card-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .card-body {
            padding: 32px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            font-weight: 500;
            font-size: 14px;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-blue-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-gray);
        }

        .btn-secondary:hover {
            background: var(--light-gray);
            border-color: var(--neutral-gray);
        }

        .btn-success {
            background: var(--success-green);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--error-red);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-gray);
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: all 0.2s ease;
            background: var(--bg-primary);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px var(--primary-blue-light);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        .table-container {
            background: var(--bg-primary);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-gray);
            max-height: 600px;
            position: relative;
        }
        
        .table-container table {
            width: 100%;
            display: table;
        }
        
        .table-container > div:has(table) {
            max-height: 600px;
            overflow-y: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: var(--primary-blue);
            color: white;
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid var(--border-gray);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table-sort-btn {
            background: transparent;
            border: none;
            color: inherit;
            font: inherit;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 0;
            text-transform: inherit;
            letter-spacing: inherit;
            user-select: none;
        }

        .table-sort-btn .sort-indicator {
            font-size: 11px;
            opacity: 0.85;
        }

        .table-sort-btn.active .sort-indicator {
            font-weight: 700;
            opacity: 1;
        }

        .table td {
            padding: 16px 12px;
            border-bottom: 1px solid var(--border-gray);
            color: var(--text-secondary);
            font-size: 14px;
        }

        .table tbody tr:hover {
            background: var(--light-gray);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-ready {
            background: #dcfce7;
            color: #166534;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-needed {
            background: #fee2e2;
            color: #991b1b;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            max-width: 400px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .password-input {
            width: 100%;
            max-width: 250px;
            margin: 0 auto 24px auto;
            display: block;
        }

        .modal-login-btn {
            padding: 12px 32px;
            font-size: 16px;
            font-weight: 600;
            min-width: 120px;
        }

        .modal-header {
            padding: 24px 32px;
            border-bottom: 1px solid var(--border-gray);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-body {
            padding: 32px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--primary-blue);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius);
        }

        .modal-close:hover {
            background: var(--primary-blue-light);
            color: var(--primary-blue-dark);
        }

        .tabs {
            display: flex;
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 4px;
            gap: 4px;
            box-shadow: var(--shadow-sm);
        }

        .tab {
            padding: 12px 24px;
            border-radius: var(--border-radius);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: none;
            color: var(--text-secondary);
        }

        .tab.active {
            background: var(--primary-blue);
            color: white;
        }

        .tab:hover:not(.active) {
            background: var(--light-gray);
            color: var(--text-primary);
        }

        .controls {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
        }

        .filter-group {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .hidden {
            display: none !important;
        }

        /* Legacy compatibility styles */
        .landing-container, .main-container, .internal-container, .login-container {
            max-width: 900px;
            margin: 60px auto;
            background: var(--bg-primary);
            padding: 40px 30px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-gray);
        }

        .landing-container {
            text-align: center;
            padding: 64px 32px;
        }

        .landing-container h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .landing-container p {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 48px;
        }

        .landing-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
            transition: all 0.2s ease;
            min-width: 200px;
            display: inline-block;
        }

        .landing-btn:hover {
            background: var(--primary-blue-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .tab-bar {
            display: flex;
            justify-content: flex-end;
            gap: 16px;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .site-logo {
            position: absolute;
            top: 18px;
            left: 24px;
            max-width: 48px;
            max-height: 48px;
            width: 48px;
            height: 48px;
            z-index: 100;
            background: var(--bg-primary);
            border-radius: 50%;
            box-shadow: var(--shadow-md);
            object-fit: contain;
        }

        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            background: var(--primary-blue);
            color: white;
            padding: 18px 32px;
            border-radius: var(--border-radius);
            font-size: 16px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: none;
        }

        /* Form styling */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px 32px;
        }

        .form-row {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        input[type="text"], input[type="number"], input[type="url"], textarea, select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-gray);
            border-radius: var(--border-radius);
            margin-bottom: 0;
            font-size: 14px;
            background: var(--bg-primary);
            transition: all 0.2s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px var(--primary-blue-light);
        }

        textarea {
            min-height: 60px;
            resize: vertical;
        }

        select {
            background-image: url('data:image/svg+xml;utf8,<svg fill="%236b7280" height="20" viewBox="0 0 20 20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M7.293 7.293a1 1 0 011.414 0L10 8.586l1.293-1.293a1 1 0 111.414 1.414l-2 2a1 1 0 01-1.414 0l-2-2a1 1 0 010-1.414z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 18px 18px;
            padding-right: 40px;
            appearance: none;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0 0 0;
        }

        /* Project area styling */
        .project-area {
            background: var(--bg-secondary);
            border: 1px solid var(--border-gray);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-sm);
            padding: 32px 24px;
            margin-bottom: 30px;
        }

        .section-title {
            font-family: 'Open Sans', sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-blue);
            margin: 30px 0 15px 0;
            border-bottom: 1px solid var(--primary-blue);
            padding-bottom: 8px;
        }

        /* Input styles */
        input, textarea, select {
            font-family: 'Open Sans', sans-serif;
        }

        /* Button styles */
        .btn, .add-btn, .save-btn, .logout-btn, .internal-btn, .back-btn, .landing-btn, .internal-db-action-btn, .internal-db-actions-btn, .view-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin: 30px 0 0 0;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn:hover, .add-btn:hover, .save-btn:hover, .logout-btn:hover, .internal-btn:hover, .back-btn:hover, .landing-btn:hover, .internal-db-action-btn:hover, .internal-db-actions-btn:hover, .view-btn:hover {
            background: var(--primary-blue-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .logout-btn, .internal-btn {
            float: right;
            margin: 0 0 20px 10px;
            padding: 10px 24px;
            font-size: 14px;
        }

        /* Status styles */
        .internal-db-status {
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 20px;
            display: inline-block;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .internal-db-status-pending { background: #fef3c7; color: #92400e; }
        .internal-db-status-approved, .internal-db-status-ready { background: #dcfce7; color: #166534; }
        .internal-db-status-rejected, .internal-db-status-internal-needed { background: #fee2e2; color: #991b1b; }
        .internal-db-status-multiple { background: #fef3c7; color: #92400e; }
        .internal-db-status-none { background: var(--neutral-gray); color: white; }
        .status-submitted { background: #dcfce7; color: #166534; }
        .status-ready { background: #dcfce7; color: #166534; }
        .status-internal-needed { background: #fee2e2; color: #991b1b; }
        .status-external-needed { background: #fef3c7; color: #92400e; }

        /* Table styles */
        .table-container {
            margin-top: 40px;
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--bg-primary);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        th, td {
            border-bottom: 1px solid var(--border-gray);
            padding: 16px 12px;
            text-align: left;
        }

        th {
            background: var(--primary-blue);
            color: white;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* Internal database controls */
        .internal-db-controls {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        #internal-db-filter-year {
            width: 160px;
            min-width: 160px;
            max-width: 160px;
        }

        #internal-db-search {
            width: 320px;
            min-width: 120px;
            max-width: 340px;
        }

        #internal-db-filter-status {
            width: 180px;
            min-width: 90px;
            max-width: 180px;
        }

        .internal-db-controls input[type="text"],
        .internal-db-controls select {
            height: 44px;
            padding: 12px 16px;
            font-size: 14px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-gray);
            background: var(--bg-primary);
            box-sizing: border-box;
            margin-bottom: 0;
            display: inline-block;
            vertical-align: middle;
        }

        .internal-db-controls select {
            background-position: right 12px center;
            padding-right: 40px;
        }

        /* External table container */
        .external-table-container {
            overflow-x: auto;
            max-width: 100%;
        }

        #project-table {
            min-width: 1200px;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: 0 16px;
            }
            
            .card-body {
                padding: 24px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                min-width: auto;
            }

            .site-logo { 
                left: 8px; 
                top: 8px; 
                max-width: 36px; 
                max-height: 36px; 
                width: 36px; 
                height: 36px; 
            }

            .landing-container, .main-container, .internal-container { 
                padding: 24px 16px; 
            }
            
            .form-grid { 
                grid-template-columns: 1fr; 
                gap: 18px; 
            }
        }

        /* üé® MODERN PDF REPORT STYLES */
        .pdf-report {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: #ffffff;
            max-width: 8.5in;
            margin: 0 auto;
            padding: 0;
        }

        /* Cover Page Styles */
        .pdf-cover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 60px 40px;
            text-align: center;
            min-height: 11in;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .pdf-cover::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .pdf-cover-content {
            position: relative;
            z-index: 2;
        }

        .pdf-logo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 40px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 4px solid rgba(255,255,255,0.2);
        }

        .pdf-title {
            font-size: 3rem;
            font-weight: 700;
            margin: 0 0 20px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .pdf-subtitle {
            font-size: 1.5rem;
            font-weight: 300;
            margin: 0 0 40px;
            opacity: 0.9;
        }

        .pdf-entity {
            font-size: 2rem;
            font-weight: 600;
            margin: 0 0 30px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .pdf-date {
            font-size: 1rem;
            opacity: 0.8;
            margin: 40px 0 0;
        }

        /* Page Styles */
        .pdf-page {
            background: white;
            padding: 40px;
            min-height: 11in;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* Section Headers */
        .pdf-section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            margin: -40px -40px 30px -40px;
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .pdf-section-icon {
            font-size: 1.8rem;
        }

        /* Data Cards */
        .pdf-data-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }

        .pdf-data-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .pdf-card-header {
            font-size: 1.2rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pdf-card-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        /* Tables */
        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .pdf-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .pdf-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.85rem;
        }

        .pdf-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .pdf-table tr:hover {
            background: #e3f2fd;
        }

        /* Typography */
        .pdf-h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 0 0 20px;
            line-height: 1.2;
        }

        .pdf-h2 {
            font-size: 2rem;
            font-weight: 600;
            color: #34495e;
            margin: 30px 0 15px;
            line-height: 1.3;
        }

        .pdf-h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #495057;
            margin: 25px 0 10px;
            line-height: 1.4;
        }

        .pdf-text {
            font-size: 0.95rem;
            line-height: 1.6;
            margin: 0 0 15px;
            color: #6c757d;
        }

        /* Status Badges */
        .pdf-status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pdf-status-ready {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .pdf-status-pending {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: white;
        }

        .pdf-status-error {
            background: linear-gradient(135deg, #dc3545, #e74c3c);
            color: white;
        }

        /* Footer */
        .pdf-footer {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 40px;
            margin: 40px -40px -40px -40px;
            text-align: center;
            font-size: 0.9rem;
        }

        /* Print Styles */
        @media print {
            .pdf-report {
                max-width: none;
                margin: 0;
                padding: 0;
            }
            
            .pdf-page {
                page-break-after: always;
                box-shadow: none;
                margin: 0;
                padding: 40px;
            }
            
            .pdf-page:last-child {
                page-break-after: avoid;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <img src="Pictures/horz_names (1).png" alt="LRB Logo">
                </div>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <!-- Landing Page -->
            <div id="landing-container" class="landing-container">
                <div style="display:flex; flex-direction:column; align-items:center; gap:24px; margin-bottom:32px;">
                    <img src="Pictures/lrb_public_finance_advisors_logo.jpg" alt="LRB" style="width:80px; height:80px; border-radius:50%; object-fit:cover; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <h2 style="margin:0; font-size:24px; font-weight:500; color: var(--text-secondary);">Choose your access point</h2>
                </div>
                <div style="display: flex; gap: 24px; justify-content: center; flex-wrap: wrap; margin-top: 24px;">
                    <button id="external-role-btn" class="landing-btn" style="background: var(--primary-blue); color: white;">Client Portal</button>
                    <button id="internal-role-btn" class="landing-btn" style="background: var(--primary-blue); color: white;">Internal Database</button>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div id="tab-bar" class="tabs hidden" style="margin-bottom: 24px;">
                <button id="external-tab-btn" class="tab">External Data Request</button>
                <button id="internal-tab-btn" class="tab">Internal Database</button>
                <button id="internal-data-tab-btn" class="tab">Internal Data Request</button>
                <button id="logout-btn" class="btn btn-secondary" style="margin-left: auto;">Logout</button>
            </div>

            <!-- External Data Request -->
            <div id="main-container" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">June 30th Data Request Form</h2>
                    </div>
                    <div class="card-body">
                        <form id="project-form">
                            <div class="form-row" style="flex-direction: row; align-items: center; gap: 10px;">
                                <label for="external-year-select" style="margin-bottom:0;">Year:</label>
                                <select id="external-year-select" name="year" required style="width:130px;min-width:130px;max-width:130px;">
                                    <option value="">Select Year</option>
                                    <option value="2020">2020</option>
                                    <option value="2021">2021</option>
                                    <option value="2022">2022</option>
                                    <option value="2023">2023</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027">2027</option>
                                    <option value="2028">2028</option>
                                    <option value="2029">2029</option>
                                    <option value="2030">2030</option>
                                    <option value="2031">2031</option>
                                    <option value="2032">2032</option>
                                    <option value="2033">2033</option>
                                    <option value="2034">2034</option>
                                    <option value="2035">2035</option>
                                    <option value="2036">2036</option>
                                    <option value="2037">2037</option>
                                    <option value="2038">2038</option>
                                    <option value="2039">2039</option>
                                    <option value="2040">2040</option>
                                    <option value="2041">2041</option>
                                    <option value="2042">2042</option>
                                    <option value="2043">2043</option>
                                    <option value="2044">2044</option>
                                    <option value="2045">2045</option>
                                    <option value="2046">2046</option>
                                    <option value="2047">2047</option>
                                    <option value="2048">2048</option>
                                    <option value="2049">2049</option>
                                    <option value="2050">2050</option>
                                    <option value="2051">2051</option>
                                    <option value="2052">2052</option>
                                    <option value="2053">2053</option>
                                    <option value="2054">2054</option>
                                    <option value="2055">2055</option>
                                    <option value="2056">2056</option>
                                    <option value="2057">2057</option>
                                    <option value="2058">2058</option>
                                    <option value="2059">2059</option>
                                    <option value="2060">2060</option>
                                </select>
                            </div>
                            <div class="project-area">
                                <div class="section-title">Project Area Information</div>
                                <div class="form-grid">
                                    <div class="form-row">
                                        <label>Agency/Submitter Name:</label>
                                        <input type="text" name="submitterName" required>
                                    </div>
                                    <div class="form-row">
                                        <label>Project Area Name:</label>
                                        <input type="text" name="projectAreaName" required>
                                    </div>
                                    <div class="form-row">
                                        <label>TOTAL ACREAGE:</label>
                                        <input type="number" name="acreage" step="0.01" required>
                                    </div>
                                    <div class="form-row">
                                        <label>CREATION YEAR:</label>
                                        <input type="number" name="creationYear" min="1900" max="2100" required>
                                    </div>
                                    <div class="form-row">
                                        <label>BASE YEAR:</label>
                                        <input type="number" name="baseYear" min="1900" max="2100" required>
                                    </div>
                                    <div class="form-row">
                                        <label>TERM LENGTH:</label>
                                        <input type="number" name="termLength" min="1" max="100" required>
                                    </div>
                                    <div class="form-row">
                                        <label>START YEAR:</label>
                                        <input type="number" name="startYear" min="1900" max="2100" required>
                                    </div>
                                    <div class="form-row">
                                        <label>EXPIRATION YEAR:</label>
                                        <input type="number" name="expirationYear" min="1900" max="2100" required>
                                    </div>
                                    <div class="form-row">
                                        <label>BASE VALUE:</label>
                                        <input type="number" name="baseValue" step="0.01" required>
                                    </div>
                                    <div class="form-row">
                                        <label>FY INCREMENT:</label>
                                        <input type="number" name="fyIncrement" step="0.01" required>
                                    </div>
                                    <div class="form-row">
                                        <label>REMAINING LIFE:</label>
                                        <input type="number" name="remainingLife" step="0.01" readonly>
                                        <small style="color: #666; font-size: 0.8em;">Auto-calculated: Expiration Year - 2025</small>
                                    </div>
                                </div>
                                
                                <div class="section-title">Assessed Value & Financial Information</div>
                                <div class="form-row" style="grid-column: 1 / -1;">
                                    <label>DESCRIPTION OF GROWTH IN ASSESSED VALUE:</label>
                                    <div style="margin-bottom: 8px; padding: 12px; background-color: #f8f9fa; border-left: 4px solid #007bff; border-radius: 4px;">
                                        <small style="color: #666; font-size: 0.9em; font-weight: 500;">Please include the following information:</small>
                                        <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #666; font-size: 0.85em;">
                                            <li>Number of residential units</li>
                                            <li>Amount of square footage (commercial, industrial, and institutional)</li>
                                            <li>Recent developments made</li>
                                        </ul>
                                    </div>
                                    <textarea name="descriptionGrowthAssessedValue" required></textarea>
                                </div>
                                <div class="form-grid">
                                    <div class="form-row">
                                        <label>FUND BALANCE:</label>
                                        <input type="number" name="fundBalance" step="0.01" required>
                                    </div>
                                    <div class="form-row" style="grid-column: 1 / -1;">
                                        <label>PLANNED USES FOR FUND BALANCE:</label>
                                        <textarea name="plannedUsesFundBalance" required></textarea>
                                    </div>
                                </div>
                                
                                <div class="section-title">Expense Categories</div>
                                <div id="expense-container">
                                    <!-- Default expense row -->
                                    <div class="expense-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 12px; align-items: end; margin-bottom: 12px; padding: 16px; background: var(--bg-secondary); border-radius: var(--border-radius); border: 1px solid var(--border-gray);">
                                        <div class="form-row">
                                            <label>Expense Title:</label>
                                            <input type="text" name="expenseTitle_0" required>
                                        </div>
                                        <div class="form-row">
                                            <label id="fy-label-0">FY (Selected Year) Expense:</label>
                                            <input type="number" name="tyExpense_0" step="0.01" required onchange="calculateExpenseTotal(0)">
                                        </div>
                                        <div class="form-row">
                                            <label id="cy-label-0">2025 Expense:</label>
                                            <input type="number" name="cyExpense_0" step="0.01" required onchange="calculateExpenseTotal(0)">
                                        </div>
                                        <div class="form-row">
                                            <label id="ny-label-0">2026 Expense:</label>
                                            <input type="number" name="nyExpense_0" step="0.01" required onchange="calculateExpenseTotal(0)">
                                        </div>
                                        <button type="button" class="btn btn-secondary" onclick="removeExpenseRow(this)" style="padding: 6px 12px; font-size: 12px;">Remove</button>
                                    </div>
                                </div>
                                <div style="margin-top: 16px;">
                                    <button type="button" class="add-btn" id="add-expense-btn" style="width: auto; margin: 0;">+ Add Expense</button>
                                </div>
                                <div class="form-grid">
                                    <div class="form-row">
                                        <label id="fy-actual-spent-label">FY (Selected Year) ACTUAL SPENT TOTAL:</label>
                                        <input type="number" name="tyActualSpentTotal" step="0.01" readonly>
                                        <small style="color: #666; font-size: 0.8em;">Auto-calculated: Sum of all expense totals</small>
                                    </div>
                                    <div class="form-row">
                                        <label>ADMINISTRATIVE PERCENTAGE:</label>
                                        <input type="number" name="administrativePercentage" step="0.01" readonly>
                                        <small style="color: #666; font-size: 0.8em;">Auto-calculated: (Admin Expense / Total Expenses) √ó 100</small>
                                    </div>
                                </div>
                                
                                <div class="section-title">Development Information</div>
                                <div class="form-grid">
                                    <div class="form-row">
                                        <label>DEVELOPED ACREAGE:</label>
                                        <input type="number" name="developedAcreage" step="0.01" required>
                                    </div>
                                    <div class="form-row">
                                        <label>UNDEVELOPED ACREAGE:</label>
                                        <input type="number" name="undevelopedAcreage" step="0.01" required>
                                    </div>
                                    <div class="form-row">
                                        <label>RESIDENTIAL ACREAGE:</label>
                                        <input type="number" name="residentialAcreage" step="0.01" required>
                                    </div>
                                    <div class="form-row">
                                        <label>% RESIDENTIAL:</label>
                                        <input type="number" name="percentResidential" min="0" max="100" step="0.01" required readonly>
                                        <small style="color: #666; font-size: 0.8em;">Auto-calculated: (Residential Acreage / Total Acreage) √ó 100</small>
                                    </div>
                                    <div class="form-row">
                                        <label>TOTAL AUTHORIZED HOUSING UNITS:</label>
                                        <input type="number" name="totalAuthorizedHousingUnits" min="0" required>
                                    </div>
                                </div>
                                
                                <div class="section-title">Descriptions</div>
                                <div class="form-row" style="grid-column: 1 / -1;">
                                    <label>DESCRIPTION OF SIGNIFICANT DEVELOPMENT:</label>
                                    <textarea name="descriptionSignificantDevelopment" required></textarea>
                                </div>
                                <div class="form-row" style="grid-column: 1 / -1;">
                                    <label>DESCRIPTION OF HOW THE PLAN HAS BEEN FURTHERED:</label>
                                    <textarea name="descriptionPlanFurthered" required></textarea>
                                </div>
                                <div class="form-row" style="grid-column: 1 / -1;">
                                    <label>DESCRIPTION OF OTHER ISSUES WORTH NOTING:</label>
                                    <textarea name="descriptionOtherIssues"></textarea>
                                </div>
                            </div>
                            
                            <!-- Project Area Map Section -->
                            <div class="section-title">Project Area Map</div>
                            <div class="form-row" style="grid-column: 1 / -1;">
                                <label>Upload Project Area Map (PDF):</label>
                                
                                <!-- Modern Drag & Drop Upload Area -->
                                <div id="pdf-upload-zone" style="
                                    border: 2px dashed #007bff;
                                    border-radius: 12px;
                                    padding: 32px 24px;
                                    text-align: center;
                                    background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%);
                                    margin: 12px 0;
                                    transition: all 0.3s ease;
                                    cursor: pointer;
                                    position: relative;
                                    overflow: hidden;
                                ">
                                    <div id="upload-content">
                                        <div style="font-size: 48px; color: #007bff; margin-bottom: 16px;">üìÑ</div>
                                        <h4 style="margin: 0 0 8px 0; color: #333; font-weight: 600;">Drop PDF files here</h4>
                                        <p style="margin: 0 0 16px 0; color: #666; font-size: 14px;">or click to browse files</p>
                                        <div style="
                                            display: inline-flex;
                                            align-items: center;
                                            gap: 8px;
                                            background: #007bff;
                                            color: white;
                                            padding: 10px 20px;
                                            border-radius: 8px;
                                            font-size: 14px;
                                            font-weight: 500;
                                            transition: all 0.2s ease;
                                        " onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'">
                                            <span>üìÅ</span>
                                            <span>Choose Files</span>
                                        </div>
                                        <p style="margin: 12px 0 0 0; color: #999; font-size: 12px;">Supports multiple PDF files ‚Ä¢ Max 5MB per file</p>
                                    </div>
                                    <input type="file" id="project-area-map-upload" accept=".pdf" multiple style="
                                        position: absolute;
                                        top: 0;
                                        left: 0;
                                        width: 100%;
                                        height: 100%;
                                        opacity: 0;
                                        cursor: pointer;
                                    ">
                                </div>
                                
                                <!-- Uploaded Files List -->
                                <div id="uploaded-maps-list" style="margin-top: 16px;"></div>
                            </div>
                            
                            <button type="submit" class="add-btn" style="width:100%;margin-top:24px;">Add Project Area</button>
                        </form>
                        <div class="table-container external-table-container">
                            <table id="project-table" style="margin-top:0; display:none;">
                                <thead>
                                    <tr>
                                        <th>Agency/Submitter Name</th>
                                        <th>Project Area Name</th>
                                        <th>ACREAGE</th>
                                        <th>CREATION YEAR</th>
                                        <th>BASE YEAR</th>
                                        <th>TERM LENGTH</th>
                                        <th>START YEAR</th>
                                        <th>EXPIRATION YEAR</th>
                                        <th>BASE VALUE</th>
                                        <th>FY INCREMENT</th>
                                        <th>REMAINING LIFE</th>
                                        <th>FUND BALANCE</th>
                                        <th id="fy-actual-spent-header">FY (Selected Year) ACTUAL SPENT TOTAL</th>
                                        <th>DEVELOPED ACREAGE</th>
                                        <th>UNDEVELOPED ACREAGE</th>
                                        <th>RESIDENTIAL ACREAGE</th>
                                        <th>% RESIDENTIAL</th>
                                        <th>TOTAL AUTHORIZED HOUSING UNITS</th>
                                        <th>Edit</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                            <button id="external-submit-all-btn" type="button" class="add-btn" style="display:none; margin-top:18px; width:100%;">Submit All</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Thank You Page -->
            <div id="external-thankyou" class="hidden">
                <div class="card">
                    <div class="card-body" style="text-align: center; padding: 64px 32px;">
                        <h2 style="font-size: 28px; font-weight: 600; margin-bottom: 16px; color: var(--text-primary);">Thanks for your help!</h2>
                        <p style="margin-bottom: 32px; color: var(--text-secondary);">Your submission has been received successfully.</p>
                        <button id="external-new-submission-btn" class="btn btn-primary">Make Another Submission</button>
                    </div>
                </div>
            </div>

            <!-- Internal Database -->
            <div id="internal-container" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">June 30th Database</h2>
                    </div>
                    <div class="card-body">
                        <div class="controls">
                            <div class="search-box">
                                <input type="text" id="internal-db-search" class="form-control" placeholder="Search by city, project area, status...">
                            </div>
                            <div class="filter-group">
                                <select id="internal-db-filter-year" class="form-control" style="width: 160px;">
                                    <option value="">Select Year</option>
                                    <option value="2020">2020</option>
                                    <option value="2021">2021</option>
                                    <option value="2022">2022</option>
                                    <option value="2023">2023</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027">2027</option>
                                    <option value="2028">2028</option>
                                    <option value="2029">2029</option>
                                    <option value="2030">2030</option>
                                    <option value="2031">2031</option>
                                    <option value="2032">2032</option>
                                    <option value="2033">2033</option>
                                    <option value="2034">2034</option>
                                    <option value="2035">2035</option>
                                    <option value="2036">2036</option>
                                    <option value="2037">2037</option>
                                    <option value="2038">2038</option>
                                    <option value="2039">2039</option>
                                    <option value="2040">2040</option>
                                    <option value="2041">2041</option>
                                    <option value="2042">2042</option>
                                    <option value="2043">2043</option>
                                    <option value="2044">2044</option>
                                    <option value="2045">2045</option>
                                    <option value="2046">2046</option>
                                    <option value="2047">2047</option>
                                    <option value="2048">2048</option>
                                    <option value="2049">2049</option>
                                    <option value="2050">2050</option>
                                    <option value="2051">2051</option>
                                    <option value="2052">2052</option>
                                    <option value="2053">2053</option>
                                    <option value="2054">2054</option>
                                    <option value="2055">2055</option>
                                    <option value="2056">2056</option>
                                    <option value="2057">2057</option>
                                    <option value="2058">2058</option>
                                    <option value="2059">2059</option>
                                    <option value="2060">2060</option>
                                </select>
                                <select id="internal-db-filter-status" class="form-control" style="width: 180px;">
                                    <option value="">All Status</option>
                                    <option value="Ready">Ready</option>
                                    <option value="Internal Data Needed">Internal Data Needed</option>
                                </select>
                            </div>
                        </div>
                        <div id="internal-db-table-container"></div>
                        <div id="internal-db-detail-modal" class="internal-db-modal" style="display:none;"></div>
                    </div>
                </div>
            </div>

            <!-- Internal Data Request -->
            <div id="internal-data-request-container" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Internal Data Request Form</h2>
                    </div>
                    <div class="card-body">
                        <form id="internal-data-request-form" novalidate>
                            <div class="form-row" style="flex-direction: row; align-items: center; gap: 10px;">
                                <label for="internal-year-select" style="margin-bottom:0;">Year:</label>
                                <select id="internal-year-select" name="year" style="width:130px;min-width:130px;max-width:130px;">
                                    <option value="">Select Year</option>
                                    <option value="2020">2020</option>
                                    <option value="2021">2021</option>
                                    <option value="2022">2022</option>
                                    <option value="2023">2023</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027">2027</option>
                                    <option value="2028">2028</option>
                                    <option value="2029">2029</option>
                                    <option value="2030">2030</option>
                                    <option value="2031">2031</option>
                                    <option value="2032">2032</option>
                                    <option value="2033">2033</option>
                                    <option value="2034">2034</option>
                                    <option value="2035">2035</option>
                                    <option value="2036">2036</option>
                                    <option value="2037">2037</option>
                                    <option value="2038">2038</option>
                                    <option value="2039">2039</option>
                                    <option value="2040">2040</option>
                                    <option value="2041">2041</option>
                                    <option value="2042">2042</option>
                                    <option value="2043">2043</option>
                                    <option value="2044">2044</option>
                                    <option value="2045">2045</option>
                                    <option value="2046">2046</option>
                                    <option value="2047">2047</option>
                                    <option value="2048">2048</option>
                                    <option value="2049">2049</option>
                                    <option value="2050">2050</option>
                                    <option value="2051">2051</option>
                                    <option value="2052">2052</option>
                                    <option value="2053">2053</option>
                                    <option value="2054">2054</option>
                                    <option value="2055">2055</option>
                                    <option value="2056">2056</option>
                                    <option value="2057">2057</option>
                                    <option value="2058">2058</option>
                                    <option value="2059">2059</option>
                                    <option value="2060">2060</option>
                                </select>
                            </div>
                            <div class="project-area">
                                <div class="section-title">Basic Information</div>
                                <div class="form-grid">
                                    <div class="form-row">
                                        <label>Client (Agency/Submitter):</label>
                                        <select id="internal-city-dropdown" name="cityCounty" onchange="populateProjectDropdown()">
                                            <option value="">Select Client</option>
                                        </select>
                                    </div>
                                    <div class="form-row">
                                        <label>Project Area:</label>
                                        <select id="internal-project-dropdown" name="projectArea">
                                            <option value="">Select Project Area</option>
                                        </select>
                                    </div>
                                    <div class="form-row">
                                        <label id="fy-label">Fiscal Year:</label>
                                        <input type="number" name="fy">
                                    </div>
                                    <div class="form-row">
                                        <label id="ty-label">Tax Year:</label>
                                        <input type="number" name="ty">
                                    </div>
                                    <div class="form-row">
                                        <label>TYPE:</label>
                                        <select name="type">
                                            <option value="">Select Type</option>
                                            <option value="EDA">EDA</option>
                                            <option value="URA">URA</option>
                                            <option value="RDA">RDA</option>
                                            <option value="CDA">CDA</option>
                                            <option value="CRA">CRA</option>
                                        </select>
                                    </div>
                                    <div class="form-row">
                                        <label>PURPOSE:</label>
                                        <select name="purpose">
                                            <option value="">Select Purpose</option>
                                            <option value="Commercial Development">Commercial Development</option>
                                            <option value="Industrial Development">Industrial Development</option>
                                            <option value="Mixed-Used Development">Mixed-Used Development</option>
                                            <option value="Residential Development">Residential Development</option>
                                        </select>
                                    </div>
                                    <div class="form-row">
                                        <label>TAXING DISTRICT:</label>
                                        <input type="text" name="taxingDistrict">
                                    </div>
                                    <div class="form-row">
                                        <label>TAX RATE:</label>
                                        <input type="number" name="taxRate">
                                    </div>
                                </div>

                                <div class="section-title">Value Information</div>
                                <div class="form-grid">
                                    <div class="form-row">
                                        <label id="fy-value-label">Total Assessed Value:</label>
                                        <input type="number" name="tyValue" step="0.01">
                                    </div>
                                    <div class="form-row">
                                        <label>VALUE INCREASE:</label>
                                        <input type="number" name="valueIncrease" step="0.01" readonly>
                                        <small style="color: #666; font-size: 0.8em;">Auto-calculated: FY (Selected Year) VALUE - Prior Year Value</small>
                                    </div>
                                    <div class="form-row" style="grid-column: 1 / -1;">
                                        <label>DESCRIPTION OF PROJECT AREA:</label>
                                        <textarea name="growthInAssessedValue"></textarea>
                                    </div>
                                </div>

                                <div class="section-title">Tax Entities</div>
                                <div class="form-grid">
                                    <div class="table-container" style="grid-column: 1 / -1;">
                                        <table class="table" id="tax-entities-table">
                                            <thead>
                                                <tr>
                                                    <th style="width: 20%;">Tax Entity</th>
                                                    <th style="width: 12%;">Participation Rate (%)</th>
                                                    <th style="width: 12%;">Remittance</th>
                                                    <th style="width: 12%;">Cap Amount</th>
                                                    <th style="width: 15%;" id="actual-revenue-header">(Selected Year) Increment Paid</th>
                                                    <th style="width: 12%;">Remaining Authorized</th>
                                                    <th style="width: 5%;">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tax-entities-tbody">
                                                <tr class="tax-entity-row">
                                                    <td>
                                                        <input type="text" name="taxEntityName_0" placeholder="Enter tax entity name" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;">
                                                    </td>
                                                    <td>
                                                        <input type="number" name="taxEntityParticipationRate_0" step="0.01" min="0" max="100" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTaxEntitiesTotal()">
                                                    </td>
                                                    <td>
                                                        <input type="number" name="taxEntityRemittance_0" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTaxEntitiesTotal()">
                                                    </td>
                                                    <td>
                                                        <input type="number" name="taxEntityCapAmount_0" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTaxEntitiesTotal()">
                                                    </td>
                                                    <td>
                                                        <input type="number" name="taxEntityIncrementPaid_0" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTaxEntitiesTotal()">
                                                    </td>
                                                    <td>
                                                        <input type="number" name="taxEntityRemainingAuthorized_0" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTaxEntitiesTotal()">
                                                    </td>
                                                    <td style="width: 60px;">
                                                        <button type="button" class="btn btn-secondary" onclick="removeTaxEntityRow(this)" style="padding: 4px 8px; font-size: 11px;">Remove</button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="form-row" style="grid-column: 1 / -1; margin-top: 4px;">
                                        <button type="button" id="add-tax-entity-btn" class="btn btn-primary">+ Add Tax Entity</button>
                                    </div>
                                </div>

                                <!-- 2025 SOURCES OF FUNDS Section -->
                                <div class="section-title">2025 SOURCES OF FUNDS (Internal data request)</div>
                                <div class="table-container" style="grid-column: 1 / -1;">
                                    <table class="table" id="sources-of-funds-table">
                                        <thead>
                                            <tr>
                                                <th>Description of Revenue source</th>
                                                <th>2025 actual</th>
                                                <th>2026 forecast</th>
                                                <th>2027 forecast</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="sources-of-funds-tbody">
                                            <!-- Default row -->
                                            <tr class="sources-of-funds-row">
                                                <td><input type="text" name="revenueSourceDescription_0" placeholder="Enter revenue source description" style="width: 100%; border: none; background: transparent; padding: 8px;"></td>
                                                <td><input type="number" name="revenueSource2025Actual_0" placeholder="0" step="0.01" style="width: 100%; border: none; background: transparent; padding: 8px; text-align: right;"></td>
                                                <td><input type="number" name="revenueSource2026Forecast_0" placeholder="0" step="0.01" style="width: 100%; border: none; background: transparent; padding: 8px; text-align: right;"></td>
                                                <td><input type="number" name="revenueSource2027Forecast_0" placeholder="0" step="0.01" style="width: 100%; border: none; background: transparent; padding: 8px; text-align: right;"></td>
                                                <td><button type="button" class="btn btn-danger btn-sm" onclick="removeSourcesOfFundsRow(this)" style="padding: 4px 8px; font-size: 12px;">Remove</button></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <button type="button" id="add-sources-of-funds-btn" class="btn btn-secondary" style="margin-top: 12px;">Add Revenue Source</button>
                                </div>

                                <div class="section-title">Totals</div>
                                <div class="form-grid">
                                    <div class="form-row">
                                        <label>TOTAL REMITTANCE:</label>
                                        <input type="number" name="totalRemittance" step="0.01" readonly>
                                    </div>
                                    <div class="form-row">
                                        <label>TOTAL CAP:</label>
                                        <input type="number" name="totalCap" step="0.01" readonly>
                                    </div>
                                    <div class="form-row">
                                        <label>TOTAL ACTUAL RECEIVED:</label>
                                        <input type="number" name="totalActualReceived" step="0.01" readonly>
                                    </div>
                                    <div class="form-row">
                                        <label>TOTAL REMAINING AUTHORIZED:</label>
                                        <input type="number" name="totalRemainingAuthorized" step="0.01" readonly>
                                    </div>

                                </div>

                                <div class="section-title">Revenue Information</div>
                                <div class="form-grid">
                                    <div class="form-row">
                                        <label id="fy-original-budget-label">FY (Selected Year) ORIGINAL BUDGET REVENUES:</label>
                                        <input type="number" name="tyOriginalBudgetRevenues" step="0.01">
                                    </div>
                                    <div class="form-row">
                                        <label id="fy-lifetime-revenues-label">ORIGINAL BUDGET LIFETIME REVENUES:</label>
                                        <input type="number" name="lifetimeRevenues" step="0.01">
                                    </div>
                                    <div class="form-row">
                                        <label id="fy-actual-revenue-label">FY (Selected Year) ACTUAL REVENUE:</label>
                                        <input type="number" name="tyActualRevenue" step="0.01">
                                    </div>
                                    <div class="form-row">
                                        <label>LIFETIME ACTUAL REVENUES:</label>
                                        <input type="number" name="lifetimeActualRevenues" step="0.01">
                                    </div>
                                    <div class="form-row">
                                        <label id="fy-base-year-revenue-label">FY (Selected Year) BASE YEAR REVENUE:</label>
                                        <input type="number" name="tyBaseYearRevenue" step="0.01">
                                    </div>
                                    <div class="form-row">
                                        <label>LIFETIME BASE YEAR REVENUES:</label>
                                        <input type="number" name="lifetimeBaseYearRevenues" step="0.01">
                                    </div>
                                </div>

                                <div class="section-title">Financial Analysis</div>
                                <div class="form-grid">
                                    <div class="form-row">
                                        <label>ADMINISTRATIVE PERCENTAGE:</label>
                                        <input type="number" name="administrativePercentage" step="0.01">
                                    </div>
                                    <div class="form-row">
                                        <label>DISCOUNT RATE (%):</label>
                                        <input type="number" name="discountRate" step="0.01" min="0" max="100">
                                    </div>
                                    <div class="form-row">
                                        <label>AGGREGATE REMAINING REVENUE:</label>
                                        <input type="number" name="aggregateRemainingRevenue" step="0.01">
                                    </div>
                                    <div class="form-row">
                                        <label>DISCOUNTED AGGREGATE REMAINING REVENUE:</label>
                                        <input type="number" name="discountedAggregateRemainingRevenue" step="0.01">
                                    </div>
                                    <div class="form-row">
                                        <label>TOTAL AGGREGATE EXPENSE:</label>
                                        <input type="number" name="totalAggregateExpense" step="0.01">
                                    </div>
                                    <div class="form-row">
                                        <label>TOTAL AGGREGATE EXPENSE AT NPV:</label>
                                        <input type="number" name="totalAggregateExpenseAtNpv" step="0.01">
                                    </div>
                                </div>

                                <div class="section-title">Total Expenses</div>
                                <div class="form-grid">
                                    <div class="table-container" style="grid-column: 1 / -1;">
                                        <table class="table" id="total-expenses-table">
                                            <thead>
                                                <tr>
                                                    <th style="width: 50%;">Expense Description</th>
                                                    <th style="width: 20%;">Amount</th>
                                                    <th style="width: 20%;">NPV</th>
                                                    <th style="width: 10%;">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="total-expenses-tbody">
                                                <tr class="total-expense-row">
                                                    <td>
                                                        <input type="text" name="totalExpenseDescription_0" placeholder="Enter expense description" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;">
                                                    </td>
                                                    <td>
                                                        <input type="number" name="totalExpenseAmount_0" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTotalUsesOfFunds()">
                                                    </td>
                                                    <td>
                                                        <input type="number" name="totalExpenseNpv_0" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTotalUsesOfFunds()">
                                                    </td>
                                                    <td style="width: 60px;">
                                                        <button type="button" class="btn btn-secondary" onclick="removeTotalExpenseRow(this)" style="padding: 4px 8px; font-size: 11px;">Remove</button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="form-row" style="grid-column: 1 / -1; margin-top: 4px;">
                                        <button type="button" id="add-total-expense-btn" class="btn btn-primary">+ Add Expense</button>
                                    </div>
                                    <div class="form-row">
                                        <label>TOTAL USES OF FUNDS:</label>
                                        <input type="number" name="totalUsesOfFunds" step="0.01" readonly>
                                    </div>
                                </div>



                                <div class="section-title">Additional Information</div>
                                <div class="form-row" style="grid-column: 1 / -1;">
                                    <label>DESCRIPTION OF BENEFITS TO TAXING ENTITIES:</label>
                                    <textarea name="descriptionOfBenefitsToTaxingEntities"></textarea>
                                </div>

                                <!-- Governing Board of Trustees Section -->
                                <div class="section-title">Governing Board of Trustees</div>
                                <div id="governing-board-container">
                                    <div class="governing-board-row" style="display: flex; gap: 16px; margin-bottom: 16px; align-items: end;">
                                        <div class="form-row" style="flex: 1;">
                                            <label>Name:</label>
                                            <input type="text" name="governingBoardName_0" placeholder="Board Member Name">
                                        </div>
                                        <div class="form-row" style="flex: 1;">
                                            <label>Title:</label>
                                            <input type="text" name="governingBoardTitle_0" placeholder="Board Member Title">
                                        </div>
                                        <button type="button" class="btn btn-secondary" onclick="removeGoverningBoardRow(this)" style="padding: 6px 12px; font-size: 12px; margin-bottom: 0;">Remove</button>
                                    </div>
                                </div>
                                <button type="button" id="add-governing-board-btn" class="btn btn-secondary" style="margin-bottom: 24px;">Add Board Member</button>

                                <!-- Agency Staff Section -->
                                <div class="section-title">Agency Staff</div>
                                <div id="agency-staff-container">
                                    <div class="agency-staff-row" style="display: flex; gap: 16px; margin-bottom: 16px; align-items: end;">
                                        <div class="form-row" style="flex: 1;">
                                            <label>Name:</label>
                                            <input type="text" name="agencyStaffName_0" placeholder="Staff Member Name">
                                        </div>
                                        <div class="form-row" style="flex: 1;">
                                            <label>Title:</label>
                                            <input type="text" name="agencyStaffTitle_0" placeholder="Staff Member Title">
                                        </div>
                                        <button type="button" class="btn btn-secondary" onclick="removeAgencyStaffRow(this)" style="padding: 6px 12px; font-size: 12px; margin-bottom: 0;">Remove</button>
                                    </div>
                                </div>
                                <button type="button" id="add-agency-staff-btn" class="btn btn-secondary" style="margin-bottom: 24px;">Add Staff Member</button>

                                <!-- Increment Distribution Section -->
                                <div class="section-title">Increment Distribution</div>
                                <div id="increment-distribution-container">
                                    <div class="increment-distribution-row" style="display: flex; gap: 16px; margin-bottom: 16px; align-items: end;">
                                        <div class="form-row" style="flex: 1;">
                                            <label>Entity Description:</label>
                                            <input type="text" name="incrementEntity_0" placeholder="Taxing Entity Name">
                                        </div>
                                        <div class="form-row" style="flex: 1;">
                                            <label>Actual Received:</label>
                                            <input type="number" name="incrementActual_0" step="0.01" placeholder="0.00">
                                        </div>
                                        <div class="form-row" style="flex: 1;">
                                            <label>Amount Remaining Authorized:</label>
                                            <input type="number" name="incrementRemaining_0" step="0.01" placeholder="0.00">
                                        </div>
                                        <button type="button" class="btn btn-secondary" onclick="removeIncrementDistributionRow(this)" style="padding: 6px 12px; font-size: 12px; margin-bottom: 0;">Remove</button>
                                    </div>
                                </div>
                                <button type="button" id="add-increment-distribution-btn" class="btn btn-secondary" style="margin-bottom: 24px;">Add Entity</button>

                                <button type="submit" class="add-btn" style="width:100%;margin-top:24px;">Submit Data Request</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="internal-password-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <img src="Pictures/lrb_public_finance_advisors_logo.jpg" alt="LRB" style="width:36px; height:36px; border-radius:50%; object-fit:cover;">
                    <h3 class="modal-title" style="margin:0;">Internal Access</h3>
                </div>
                <button class="modal-close" id="internal-password-cancel">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="internal-email-input">Email:</label>
                    <input type="email" id="internal-email-input" class="form-control" placeholder="your.email@example.com" required>
                </div>
                <div class="form-group">
                    <label for="internal-password-input">Password:</label>
                    <input type="password" id="internal-password-input" class="form-control password-input" placeholder="Enter password" required>
                </div>
                <div id="internal-password-error" class="hidden" style="color: var(--error-red); margin-bottom: 16px;"></div>
                <div style="display: flex; justify-content: center;">
                    <button id="internal-password-submit" class="btn btn-primary modal-login-btn">Login</button>
                </div>
            </div>
        </div>
    </div>

    <div id="external-password-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <img src="Pictures/lrb_public_finance_advisors_logo.jpg" alt="LRB" style="width:36px; height:36px; border-radius:50%; object-fit:cover;">
                    <h3 class="modal-title" style="margin:0;">Client Portal Access</h3>
                </div>
                <button class="modal-close" id="external-password-cancel">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Toggle between Login and Signup -->
                <div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid var(--border-gray);">
                    <button type="button" id="external-login-tab" class="btn btn-secondary" style="flex: 1; border-radius: 0; border-bottom: 2px solid var(--primary-blue); background: transparent; color: var(--primary-blue);">Login</button>
                    <button type="button" id="external-signup-tab" class="btn btn-secondary" style="flex: 1; border-radius: 0; border-bottom: none; background: transparent; color: var(--text-secondary);">Sign Up</button>
                </div>
                
                <!-- Login Form -->
                <div id="external-login-form">
                    <div class="form-group">
                        <label for="external-email-input">Email:</label>
                        <input type="email" id="external-email-input" class="form-control" placeholder="your.email@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="external-password-input">Password:</label>
                        <input type="password" id="external-password-input" class="form-control password-input" placeholder="Enter password" required>
                    </div>
                    <div id="external-password-error" class="hidden" style="color: var(--error-red); margin-bottom: 16px; font-size: 14px;"></div>
                    <div style="display: flex; justify-content: center; gap: 12px;">
                        <button id="external-password-submit" class="btn btn-primary modal-login-btn">Login</button>
                    </div>
                    <div style="text-align: center; margin-top: 12px;">
                        <button type="button" id="external-forgot-password" class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px; background: transparent; border: none; color: var(--primary-blue); text-decoration: underline;">Forgot Password?</button>
                    </div>
                </div>
                
                <!-- Signup Form -->
                <div id="external-signup-form" style="display: none;">
                    <div class="form-group">
                        <label for="external-signup-email">Email:</label>
                        <input type="email" id="external-signup-email" class="form-control" placeholder="your.email@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="external-signup-password">Password:</label>
                        <input type="password" id="external-signup-password" class="form-control" placeholder="Create a password" required minlength="8">
                        <small style="color: var(--text-muted); font-size: 12px;">Must be at least 8 characters</small>
                    </div>
                    <div class="form-group">
                        <label for="external-signup-org-code">Organization Code:</label>
                        <input type="text" id="external-signup-org-code" class="form-control" placeholder="Ask your administrator for this code" required>
                        <small style="color: var(--text-muted); font-size: 12px;">Required to create an account</small>
                    </div>
                    <div id="external-signup-error" class="hidden" style="color: var(--error-red); margin-bottom: 16px; font-size: 14px;"></div>
                    <div style="display: flex; justify-content: center;">
                        <button id="external-signup-submit" class="btn btn-primary modal-login-btn">Create Account</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">New submission received!</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script>
        // Global jsPDF reference - handle different loading scenarios
        window.jsPDF = window.jsPDF || window.jspdf?.jsPDF;
        
        // Ensure jsPDF is loaded when page is ready
        window.addEventListener('load', function() {
            console.log('Page loaded, checking jsPDF availability...');
            console.log('window.jsPDF:', typeof window.jsPDF);
            console.log('window.jspdf:', typeof window.jspdf);
            
            if (typeof window.jsPDF !== 'undefined') {
                console.log('jsPDF is available');
            } else if (typeof window.jspdf !== 'undefined' && window.jspdf.jsPDF) {
                console.log('jsPDF available via window.jspdf');
                window.jsPDF = window.jspdf.jsPDF;
            } else {
                console.log('jsPDF not available, loading fallback...');
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js';
                script.onload = function() {
                    console.log('jsPDF fallback loaded successfully');
                    // Try to set global reference again
                    window.jsPDF = window.jsPDF || window.jspdf?.jsPDF;
                    // Test if it works
                    setTimeout(() => testJsPDF(), 100);
                };
                script.onerror = function() {
                    console.error('Failed to load jsPDF fallback');
                };
                document.head.appendChild(script);
            }
            
            // Test jsPDF after a short delay
            setTimeout(() => testJsPDF(), 1000);
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script>
        // Global variables
        let allSubmissions = JSON.parse(localStorage.getItem('allSubmissions') || '[]');
        let currentSubmission = {};
        const internalDbSortConfig = {
            column: 'clients',
            direction: 'asc'
        };
        
        // Test function to verify jsPDF is working
        function testJsPDF() {
            console.log('Testing jsPDF availability...');
            console.log('window.jsPDF:', typeof window.jsPDF);
            console.log('window.jspdf:', typeof window.jspdf);
            console.log('jsPDF global:', typeof jsPDF);
            
            if (typeof window.jsPDF !== 'undefined') {
                try {
                    const doc = new window.jsPDF();
                    console.log('jsPDF test successful!');
                    return true;
                } catch (e) {
                    console.error('jsPDF test failed:', e);
                    return false;
                }
            }
            return false;
        }
        let logoDataUrl = null; // cached base64 for PDF logo
        let logoWidth = 0; // store logo dimensions
        let logoHeight = 0;

        // Preload horizontal logo for PDF cover page
        async function loadLogo() {
            try {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                const src = 'Pictures/horz_names (1).png';
                
                console.log('Attempting to load logo from:', src);
                
                await new Promise((resolve, reject) => {
                    img.onload = () => {
                        console.log('Logo image loaded successfully. Size:', img.width, 'x', img.height);
                        resolve();
                    };
                    img.onerror = (e) => {
                        console.error('Failed to load logo image:', e);
                        reject(e);
                    };
                    img.src = src;
                });
                
                // Store original dimensions
                logoWidth = img.naturalWidth;
                logoHeight = img.naturalHeight;
                
                // Create a canvas with the image's actual dimensions (no cropping for horizontal logo)
                const canvas = document.createElement('canvas');
                canvas.width = logoWidth;
                canvas.height = logoHeight;
                const ctx = canvas.getContext('2d');
                
                // Draw the full horizontal logo
                ctx.drawImage(img, 0, 0);
                
                // Export as PNG to preserve transparency
                logoDataUrl = canvas.toDataURL('image/png');
                console.log('‚úì Horizontal logo loaded and cached for PDF. Size:', logoWidth, 'x', logoHeight, 'Data URL length:', logoDataUrl.length);
            } catch (e) {
                console.error('ERROR loading horizontal logo for PDF:', e);
                logoDataUrl = null;
                logoWidth = 0;
                logoHeight = 0;
            }
        }

        // Replace the page favicon with a circular, transparent PNG
        function setCircularFavicon(dataUrl) {
            try {
                // Respect a pre-defined static favicon if present
                if (document.querySelector('link[rel="icon"][data-static="true"]')) return;
                // Resize to a crisp 32x32 for favicon
                const baseImg = new Image();
                baseImg.onload = () => {
                    const c = document.createElement('canvas');
                    c.width = 32; c.height = 32;
                    const ctx = c.getContext('2d');
                    ctx.clearRect(0,0,32,32);
                    ctx.drawImage(baseImg, 0, 0, 32, 32);
                    const faviconDataUrl = c.toDataURL('image/png');

                    let link = document.querySelector('link[rel="icon"]');
                    if (!link) {
                        link = document.createElement('link');
                        link.rel = 'icon';
                        document.head.appendChild(link);
                    }
                    link.type = 'image/png';
                    link.href = faviconDataUrl;
                };
                baseImg.src = dataUrl;
            } catch (err) {
                console.warn('Unable to set circular favicon:', err);
            }
        }

        // DOM Content Loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Initializing application');
            // Preload the logo for PDF report headers
            loadLogo();
            // If a static favicon is present, prefer it over dynamic one
            const staticFavicon = document.querySelector('link[rel="icon"][data-static="true"]');
            if (staticFavicon) {
                // Ensure PNG is used; do nothing else
            } else {
                // Fallback: keep dynamic circular favicon setup
            }
            
            try {
                // Clear any saved current submission so we always start blank
                try { localStorage.removeItem('currentSubmission'); } catch (e) {}
                
                // Initialize year dropdowns
                populateYearDropdown('external-year-select');
                populateYearDropdown('internal-year-select');
                populateYearDropdown('internal-db-filter-year');
                console.log('Year dropdowns initialized');

            // Landing page button handlers
            const externalRoleBtn = document.getElementById('external-role-btn');
            const internalRoleBtn = document.getElementById('internal-role-btn');

            if (externalRoleBtn) {
                externalRoleBtn.onclick = function() {
                    document.getElementById('external-password-modal').classList.remove('hidden');
                };
            }

            if (internalRoleBtn) {
                internalRoleBtn.onclick = function() {
                    document.getElementById('internal-password-modal').classList.remove('hidden');
                };
            }

            // Password modal handlers
            setupPasswordModals();

            // Tab switching
            setupTabSwitching();

                // Form submissions
                setupFormSubmissions();
                console.log('Form submissions setup');

                // Internal database functionality
                setupInternalDatabase();
                console.log('Internal database setup');

                // Setup number formatting with commas
                setupNumberFormatting();
                console.log('Number formatting setup');

                // Setup percentage formatting
                setupPercentageFormatting();
                console.log('Percentage formatting setup');
                
                console.log('Application initialization complete');
                
                // Test form submission setup
                setTimeout(() => {
                    testFormSubmission();
                    
                    // Additional debugging - check if forms are visible
                    const externalForm = document.getElementById('project-form');
                    const internalForm = document.getElementById('internal-data-request-form');
                    
                    if (externalForm) {
                        console.log('External form display style:', window.getComputedStyle(externalForm).display);
                        console.log('External form visibility:', window.getComputedStyle(externalForm).visibility);
                        console.log('External form parent display:', window.getComputedStyle(externalForm.parentElement).display);
                    }
                    
                    if (internalForm) {
                        console.log('Internal form display style:', window.getComputedStyle(internalForm).display);
                        console.log('Internal form visibility:', window.getComputedStyle(internalForm).visibility);
                        console.log('Internal form parent display:', window.getComputedStyle(internalForm.parentElement).display);
                    }
                }, 1000);
            } catch (error) {
                console.error('Error during initialization:', error);
            }

            // Disable auto-restore and ensure blank start
            window.onbeforeunload = function() {
                try { localStorage.removeItem('currentSubmission'); } catch (e) {}
            };
            
            // Force blank table on load
            currentSubmission = {};
            const projectTable = document.getElementById('project-table');
            const submitAllBtnOnLoad = document.getElementById('external-submit-all-btn');
            if (projectTable) projectTable.style.display = 'none';
            if (submitAllBtnOnLoad) submitAllBtnOnLoad.style.display = 'none';
        });

        function setupPasswordModals() {
            // Internal password modal
            const internalPasswordModal = document.getElementById('internal-password-modal');
            const internalPasswordInput = document.getElementById('internal-password-input');
            const internalEmailInput = document.getElementById('internal-email-input');
            const internalPasswordSubmit = document.getElementById('internal-password-submit');
            const internalPasswordCancel = document.getElementById('internal-password-cancel');
            const internalPasswordError = document.getElementById('internal-password-error');

            internalPasswordSubmit.onclick = function() {
                const email = (internalEmailInput?.value || '').trim();
                const password = internalPasswordInput.value;
                
                if (!email || !password) {
                    internalPasswordError.textContent = 'Please enter both email and password';
                    internalPasswordError.classList.remove('hidden');
                    return;
                }
                
                // Local Build: Keep old password check for reference
                if (password === 'Lrb2017!') {
                    internalPasswordModal.classList.add('hidden');
                    internalPasswordInput.value = '';
                    if (internalEmailInput) internalEmailInput.value = '';
                    internalPasswordError.classList.add('hidden');
                    
                    // Show all tabs for internal users
                    document.getElementById('internal-tab-btn').style.display = 'inline-block';
                    document.getElementById('internal-data-tab-btn').style.display = 'inline-block';
                    
                    // Show internal database
                    document.getElementById('landing-container').classList.add('hidden');
                    document.getElementById('tab-bar').classList.remove('hidden');
                    document.getElementById('internal-container').classList.remove('hidden');
                    document.getElementById('internal-tab-btn').classList.add('active');
                    
                    // Render internal database
                    renderInternalDBCityList();
                } else {
                    internalPasswordError.textContent = 'Incorrect email or password';
                    internalPasswordError.classList.remove('hidden');
                }
            };

            // Add Enter key support for internal login
            if (internalPasswordInput) {
                internalPasswordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        internalPasswordSubmit.click();
                    }
                });
            }
            
            if (internalEmailInput) {
                internalEmailInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        internalPasswordSubmit.click();
                    }
                });
            }

            internalPasswordCancel.onclick = function() {
                internalPasswordModal.classList.add('hidden');
                internalPasswordInput.value = '';
                if (internalEmailInput) internalEmailInput.value = '';
                internalPasswordError.classList.add('hidden');
            };

            // External password modal
            const externalPasswordModal = document.getElementById('external-password-modal');
            const externalPasswordInput = document.getElementById('external-password-input');
            const externalEmailInput = document.getElementById('external-email-input');
            const externalPasswordSubmit = document.getElementById('external-password-submit');
            const externalPasswordCancel = document.getElementById('external-password-cancel');
            const externalPasswordError = document.getElementById('external-password-error');
            
            // Signup form elements
            const externalSignupEmail = document.getElementById('external-signup-email');
            const externalSignupPassword = document.getElementById('external-signup-password');
            const externalSignupOrgCode = document.getElementById('external-signup-org-code');
            const externalSignupSubmit = document.getElementById('external-signup-submit');
            const externalSignupError = document.getElementById('external-signup-error');
            
            // Tab switching
            const externalLoginTab = document.getElementById('external-login-tab');
            const externalSignupTab = document.getElementById('external-signup-tab');
            const externalLoginForm = document.getElementById('external-login-form');
            const externalSignupForm = document.getElementById('external-signup-form');
            
            // Switch to login tab
            if (externalLoginTab) {
                externalLoginTab.onclick = function() {
                    externalLoginForm.style.display = 'block';
                    externalSignupForm.style.display = 'none';
                    externalLoginTab.style.borderBottom = '2px solid var(--primary-blue)';
                    externalLoginTab.style.color = 'var(--primary-blue)';
                    externalSignupTab.style.borderBottom = 'none';
                    externalSignupTab.style.color = 'var(--text-secondary)';
                    externalPasswordError.classList.add('hidden');
                    externalSignupError.classList.add('hidden');
                };
            }
            
            // Switch to signup tab
            if (externalSignupTab) {
                externalSignupTab.onclick = function() {
                    externalLoginForm.style.display = 'none';
                    externalSignupForm.style.display = 'block';
                    externalSignupTab.style.borderBottom = '2px solid var(--primary-blue)';
                    externalSignupTab.style.color = 'var(--primary-blue)';
                    externalLoginTab.style.borderBottom = 'none';
                    externalLoginTab.style.color = 'var(--text-secondary)';
                    externalPasswordError.classList.add('hidden');
                    externalSignupError.classList.add('hidden');
                };
            }

            // Local Build: External login (keep old password check for reference)
            externalPasswordSubmit.onclick = function() {
                const email = (externalEmailInput?.value || '').trim();
                const password = externalPasswordInput.value;
                
                if (!email || !password) {
                    externalPasswordError.textContent = 'Please enter both email and password';
                    externalPasswordError.classList.remove('hidden');
                    return;
                }
                
                // Local Build: Keep old password check
                if (password === 'june30!') {
                    externalPasswordModal.classList.add('hidden');
                    externalPasswordInput.value = '';
                    if (externalEmailInput) externalEmailInput.value = '';
                    externalPasswordError.classList.add('hidden');
                    
                    // Hide all tabs except logout for external users
                    document.getElementById('external-tab-btn').style.display = 'none';
                    document.getElementById('internal-tab-btn').style.display = 'none';
                    document.getElementById('internal-data-tab-btn').style.display = 'none';
                    
                    // Show external data request
                    document.getElementById('landing-container').classList.add('hidden');
                    document.getElementById('tab-bar').classList.remove('hidden');
                    document.getElementById('main-container').classList.remove('hidden');
                } else {
                    externalPasswordError.textContent = 'Incorrect email or password';
                    externalPasswordError.classList.remove('hidden');
                }
            };

            // Local Build: Signup handler (placeholder - not connected to API in Local Build)
            if (externalSignupSubmit) {
                externalSignupSubmit.onclick = function() {
                    const email = (externalSignupEmail?.value || '').trim();
                    const password = externalSignupPassword?.value || '';
                    const orgCode = (externalSignupOrgCode?.value || '').trim();
                    
                    if (!email || !password || !orgCode) {
                        externalSignupError.textContent = 'Please fill in all fields';
                        externalSignupError.classList.remove('hidden');
                        return;
                    }
                    
                    if (password.length < 8) {
                        externalSignupError.textContent = 'Password must be at least 8 characters';
                        externalSignupError.classList.remove('hidden');
                        return;
                    }
                    
                    // Local Build: Signup not implemented (would require API)
                    externalSignupError.textContent = 'Signup requires API connection. This is the Local Build reference.';
                    externalSignupError.classList.remove('hidden');
                };
            }

            // Add Enter key support for external login
            if (externalPasswordInput) {
                externalPasswordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        externalPasswordSubmit.click();
                    }
                });
            }
            
            if (externalEmailInput) {
                externalEmailInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        externalPasswordSubmit.click();
                    }
                });
            }
            
            // Add Enter key support for external signup
            if (externalSignupPassword) {
                externalSignupPassword.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        externalSignupSubmit?.click();
                    }
                });
            }
            
            if (externalSignupOrgCode) {
                externalSignupOrgCode.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        externalSignupSubmit?.click();
                    }
                });
            }

            externalPasswordCancel.onclick = function() {
                externalPasswordModal.classList.add('hidden');
                externalPasswordInput.value = '';
                if (externalEmailInput) externalEmailInput.value = '';
                externalPasswordError.classList.add('hidden');
                externalSignupError.classList.add('hidden');
                // Reset to login tab
                if (externalLoginTab) externalLoginTab.click();
            };
        }

        function setupTabSwitching() {
            const externalTabBtn = document.getElementById('external-tab-btn');
            const internalTabBtn = document.getElementById('internal-tab-btn');
            const internalDataTabBtn = document.getElementById('internal-data-tab-btn');
            const logoutBtn = document.getElementById('logout-btn');

            // Tab button event listeners are now handled by addEventListener above

            // Logout button event listener is now handled by addEventListener above
        }

        function showTab(tabName) {
            // Hide all containers
            document.getElementById('main-container').classList.add('hidden');
            document.getElementById('internal-container').classList.add('hidden');
            document.getElementById('internal-data-request-container').classList.add('hidden');
            document.getElementById('external-thankyou').classList.add('hidden');

            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));

            // Show selected container and activate tab
            if (tabName === 'external') {
                document.getElementById('main-container').classList.remove('hidden');
                document.getElementById('external-tab-btn').classList.add('active');
            } else if (tabName === 'internal') {
                document.getElementById('internal-container').classList.remove('hidden');
                document.getElementById('internal-tab-btn').classList.add('active');
                renderInternalDBCityList();
            } else if (tabName === 'internal-data') {
                document.getElementById('internal-data-request-container').classList.remove('hidden');
                document.getElementById('internal-data-tab-btn').classList.add('active');
            }
        }

        function setupFormSubmissions() {
            // External form submission
            const projectForm = document.getElementById('project-form');
            if (projectForm) {
                console.log('Setting up external form submission handler');
                projectForm.onsubmit = function(e) {
                    console.log('External form submit triggered');
                    e.preventDefault();
                    
                    // Check form validity
                    if (!projectForm.checkValidity()) {
                        console.log('Form validation failed');
                        projectForm.reportValidity();
                        return false;
                    }
                    
                    console.log('Form validation passed, processing submission');
                    const formData = new FormData(projectForm);
                    const submission = {};
                    
                    // Capture all form data
                    for (let [key, value] of formData.entries()) {
                        submission[key] = value;
                    }
                    
                    // Capture all dynamic expense data
                    const expenseRows = document.querySelectorAll('.expense-row');
                    expenseRows.forEach((row, index) => {
                        const expenseTitle = row.querySelector(`input[name="expenseTitle_${index}"]`)?.value;
                        const tyExpense = row.querySelector(`input[name="tyExpense_${index}"]`)?.value;
                        const cyExpense = row.querySelector(`input[name="cyExpense_${index}"]`)?.value;
                        const nyExpense = row.querySelector(`input[name="nyExpense_${index}"]`)?.value;
                        
                        if (expenseTitle || tyExpense || cyExpense || nyExpense) {
                            submission[`expenseTitle_${index}`] = expenseTitle;
                            submission[`tyExpense_${index}`] = tyExpense;
                            submission[`cyExpense_${index}`] = cyExpense;
                            submission[`nyExpense_${index}`] = nyExpense;
                        }
                    });
                    
                    // Also keep the expenses array for compatibility
                    const expenses = [];
                    expenseRows.forEach((row, index) => {
                        const expenseTitle = row.querySelector(`input[name="expenseTitle_${index}"]`)?.value;
                        const tyExpense = row.querySelector(`input[name="tyExpense_${index}"]`)?.value;
                        const cyExpense = row.querySelector(`input[name="cyExpense_${index}"]`)?.value;
                        const nyExpense = row.querySelector(`input[name="nyExpense_${index}"]`)?.value;
                        
                        if (expenseTitle || tyExpense || cyExpense || nyExpense) {
                            expenses.push({
                                title: expenseTitle,
                                tyExpense: tyExpense,
                                cyExpense: cyExpense,
                                nyExpense: nyExpense
                            });
                        }
                    });
                    
                    submission.expenses = expenses;
                    
                    // Capture PDF data
                    submission.projectAreaMaps = uploadedPDFs;
                    
                    submission.timestamp = new Date().toISOString();
                    
                    // Add to current submission
                    if (!currentSubmission.projectAreas) {
                        currentSubmission.projectAreas = [];
                    }
                    currentSubmission.projectAreas.push(submission);
                    console.log('Project area added to currentSubmission:', submission);
                    console.log('Total project areas now:', currentSubmission.projectAreas.length);
                    
                    // Clear form
                    projectForm.reset();
                    
                    // Clear uploaded PDFs
                    uploadedPDFs = [];
                    updateUploadedMapsList();
                    
                    // Clear expense rows and add default
                    const expenseContainer = document.getElementById('expense-container');
                    if (expenseContainer) {
                        expenseContainer.innerHTML = '';
                        // Add back the default expense row
                        addExpenseRow();
                    }
                    
                    // Show table
                    try {
                        renderTable();
                        console.log('Table rendered successfully');
                    } catch (error) {
                        console.error('Error rendering table:', error);
                    }
                    
                    // Show notification
                    try {
                        showNotification('Project area added successfully!');
                    } catch (error) {
                        console.error('Error showing notification:', error);
                        alert('Project area added successfully!');
                    }
                    
                    console.log('Project area added:', submission);
                };
            } else {
                console.error('External form not found!');
            }

            // Setup remaining life calculation
            const expirationYearInput = document.querySelector('input[name="expirationYear"]');
            if (expirationYearInput) {
                expirationYearInput.addEventListener('input', calculateRemainingLife);
                expirationYearInput.addEventListener('change', calculateRemainingLife);
            }

            // Internal form submission
            const internalForm = document.getElementById('internal-data-request-form');
            if (internalForm) {
                console.log('Setting up internal form submission handler');
                internalForm.onsubmit = function(e) {
                    console.log('Internal form submit triggered');
                    e.preventDefault();
                    
                    // Skip all validation - allow submission with any data
                    console.log('Processing internal form submission (no validation)');
                    const formData = new FormData(internalForm);
                    const submission = {};
                    
                    // Capture all form data
                    for (let [key, value] of formData.entries()) {
                        submission[key] = value;
                    }
                    
                    // Capture expense data
                    const expenseRows = document.querySelectorAll('.expense-row');
                    const expenses = [];
                    expenseRows.forEach((row, index) => {
                        const expenseTitle = row.querySelector(`input[name="expenseTitle_${index}"]`)?.value;
                        const tyExpense = row.querySelector(`input[name="tyExpense_${index}"]`)?.value;
                        const cyExpense = row.querySelector(`input[name="cyExpense_${index}"]`)?.value;
                        const nyExpense = row.querySelector(`input[name="nyExpense_${index}"]`)?.value;
                        
                        if (expenseTitle || tyExpense || cyExpense || nyExpense) {
                            expenses.push({
                                title: expenseTitle,
                                tyExpense: tyExpense,
                                cyExpense: cyExpense,
                                nyExpense: nyExpense
                            });
                        }
                    });
                    
                    submission.expenses = expenses;
                    
                    // Capture all dynamic tax entity data
                    const taxEntityRows = document.querySelectorAll('.tax-entity-row');
                    taxEntityRows.forEach((row, index) => {
                        const taxEntityName = row.querySelector(`input[name="taxEntityName_${index}"]`)?.value;
                        const participationRate = row.querySelector(`input[name="taxEntityParticipationRate_${index}"]`)?.value;
                        const remittance = row.querySelector(`input[name="taxEntityRemittance_${index}"]`)?.value;
                        const capAmount = row.querySelector(`input[name="taxEntityCapAmount_${index}"]`)?.value;
                        const incrementPaid = row.querySelector(`input[name="taxEntityIncrementPaid_${index}"]`)?.value;
                        const remainingAuthorized = row.querySelector(`input[name="taxEntityRemainingAuthorized_${index}"]`)?.value;
                        const percentOfTotal = row.querySelector(`input[name="taxEntityPercentOfTotal_${index}"]`)?.value;
                        
                        if (taxEntityName || participationRate || remittance || capAmount || incrementPaid || remainingAuthorized || percentOfTotal) {
                            submission[`taxEntityName_${index}`] = taxEntityName;
                            submission[`taxEntityParticipationRate_${index}`] = participationRate;
                            submission[`taxEntityRemittance_${index}`] = remittance;
                            submission[`taxEntityCapAmount_${index}`] = capAmount;
                            submission[`taxEntityIncrementPaid_${index}`] = incrementPaid;
                            submission[`taxEntityRemainingAuthorized_${index}`] = remainingAuthorized;
                            submission[`taxEntityPercentOfTotal_${index}`] = percentOfTotal;
                        }
                    });
                    
                    // Capture all dynamic total expense data
                    const totalExpenseRows = document.querySelectorAll('.total-expense-row');
                    totalExpenseRows.forEach((row, index) => {
                        const description = row.querySelector(`input[name="totalExpenseDescription_${index}"]`)?.value;
                        const amount = row.querySelector(`input[name="totalExpenseAmount_${index}"]`)?.value;
                        const npv = row.querySelector(`input[name="totalExpenseNpv_${index}"]`)?.value;
                        
                        if (description || amount || npv) {
                            submission[`totalExpenseDescription_${index}`] = description;
                            submission[`totalExpenseAmount_${index}`] = amount;
                            submission[`totalExpenseNpv_${index}`] = npv;
                        }
                    });
                    
                    // Capture Governing Board data
                    const governingBoardRows = document.querySelectorAll('.governing-board-row');
                    governingBoardRows.forEach((row, index) => {
                        const name = row.querySelector(`input[name="governingBoardName_${index}"]`)?.value;
                        const title = row.querySelector(`input[name="governingBoardTitle_${index}"]`)?.value;
                        
                        if (name || title) {
                            submission[`governingBoardName_${index}`] = name;
                            submission[`governingBoardTitle_${index}`] = title;
                        }
                    });
                    
                    // Capture Agency Staff data
                    const agencyStaffRows = document.querySelectorAll('.agency-staff-row');
                    agencyStaffRows.forEach((row, index) => {
                        const name = row.querySelector(`input[name="agencyStaffName_${index}"]`)?.value;
                        const title = row.querySelector(`input[name="agencyStaffTitle_${index}"]`)?.value;
                        
                        if (name || title) {
                            submission[`agencyStaffName_${index}`] = name;
                            submission[`agencyStaffTitle_${index}`] = title;
                        }
                    });
                    
                    // Capture Increment Distribution data
                    const incrementDistributionRows = document.querySelectorAll('.increment-distribution-row');
                    incrementDistributionRows.forEach((row, index) => {
                        const entity = row.querySelector(`input[name="incrementEntity_${index}"]`)?.value;
                        const actual = row.querySelector(`input[name="incrementActual_${index}"]`)?.value;
                        const remaining = row.querySelector(`input[name="incrementRemaining_${index}"]`)?.value;
                        
                        if (entity || actual || remaining) {
                            submission[`incrementEntity_${index}`] = entity;
                            submission[`incrementActual_${index}`] = actual;
                            submission[`incrementRemaining_${index}`] = remaining;
                        }
                    });
                    
                    // Capture Sources of Funds data
                    const sourcesOfFundsRows = document.querySelectorAll('.sources-of-funds-row');
                    sourcesOfFundsRows.forEach((row, index) => {
                        const description = row.querySelector(`input[name="revenueSourceDescription_${index}"]`)?.value;
                        const actual2025 = row.querySelector(`input[name="revenueSource2025Actual_${index}"]`)?.value;
                        const forecast2026 = row.querySelector(`input[name="revenueSource2026Forecast_${index}"]`)?.value;
                        const forecast2027 = row.querySelector(`input[name="revenueSource2027Forecast_${index}"]`)?.value;
                        
                        if (description || actual2025 || forecast2026 || forecast2027) {
                            submission[`revenueSourceDescription_${index}`] = description;
                            submission[`revenueSource2025Actual_${index}`] = actual2025;
                            submission[`revenueSource2026Forecast_${index}`] = forecast2026;
                            submission[`revenueSource2027Forecast_${index}`] = forecast2027;
                        }
                    });
                    
                    // Add timestamp
                    submission.timestamp = new Date().toISOString();
                    
                    // Find the matching submission by client, project area, AND year
                    const matchingSubmission = allSubmissions.find(sub => {
                        const externalClient = sub.submitterName || sub.cityCounty;
                        const externalProject = sub.projectAreaName || sub.projectArea;
                        const externalYear = sub.fy || sub.year;
                        const internalClient = submission.cityCounty;
                        const internalProject = submission.projectArea;
                        const internalYear = submission.fy;
                        return externalClient === internalClient && externalProject === internalProject && externalYear === internalYear;
                    });
                    
                    if (matchingSubmission) {
                        // Merge internal data with external data
                        Object.assign(matchingSubmission, submission);
                        console.log('Internal data merged with external submission:', matchingSubmission);
                    } else {
                        // If no matching external submission, add as new submission
                        allSubmissions.push(submission);
                        console.log('New internal submission added:', submission);
                    }
                    
                    localStorage.setItem('allSubmissions', JSON.stringify(allSubmissions));
                    renderInternalDBCityList();
                    
                    // Clear form
                    internalForm.reset();
                    
                    // Clear expense rows
                    try {
                        const expenseContainer = document.getElementById('expense-container');
                        if (expenseContainer) {
                            expenseContainer.innerHTML = '';
                            // Add back the default expense row
                            addExpenseRow();
                        }
                        console.log('Expense rows cleared and reset');
                    } catch (error) {
                        console.error('Error clearing expense rows:', error);
                    }
                    
                    // Clear Governing Board and Agency Staff sections
                    try {
                        const governingBoardContainer = document.getElementById('governing-board-container');
                        const agencyStaffContainer = document.getElementById('agency-staff-container');
                        
                        if (governingBoardContainer) {
                            governingBoardContainer.innerHTML = `
                                <div class="governing-board-row" style="display: flex; gap: 16px; margin-bottom: 16px; align-items: end;">
                                    <div class="form-row" style="flex: 1;">
                                        <label>Name:</label>
                                        <input type="text" name="governingBoardName_0" placeholder="Board Member Name">
                                    </div>
                                    <div class="form-row" style="flex: 1;">
                                        <label>Title:</label>
                                        <input type="text" name="governingBoardTitle_0" placeholder="Board Member Title">
                                    </div>
                                    <button type="button" class="btn btn-secondary" onclick="removeGoverningBoardRow(this)" style="padding: 6px 12px; font-size: 12px; margin-bottom: 0;">Remove</button>
                                </div>
                            `;
                        }
                        
                        if (agencyStaffContainer) {
                            agencyStaffContainer.innerHTML = `
                                <div class="agency-staff-row" style="display: flex; gap: 16px; margin-bottom: 16px; align-items: end;">
                                    <div class="form-row" style="flex: 1;">
                                        <label>Name:</label>
                                        <input type="text" name="agencyStaffName_0" placeholder="Staff Member Name">
                                    </div>
                                    <div class="form-row" style="flex: 1;">
                                        <label>Title:</label>
                                        <input type="text" name="agencyStaffTitle_0" placeholder="Staff Member Title">
                                    </div>
                                    <button type="button" class="btn btn-secondary" onclick="removeAgencyStaffRow(this)" style="padding: 6px 12px; font-size: 12px; margin-bottom: 0;">Remove</button>
                                </div>
                            `;
                        }
                        
                        console.log('Governing Board and Agency Staff sections cleared and reset');
                    } catch (error) {
                        console.error('Error clearing Governing Board and Agency Staff sections:', error);
                    }
                    
                    // Clear Increment Distribution section
                    try {
                        const incrementDistributionContainer = document.getElementById('increment-distribution-container');
                        if (incrementDistributionContainer) {
                            incrementDistributionContainer.innerHTML = `
                                <div class="increment-distribution-row" style="display: flex; gap: 16px; margin-bottom: 16px; align-items: end;">
                                    <div class="form-row" style="flex: 1;">
                                        <label>Entity Description:</label>
                                        <input type="text" name="incrementEntity_0" placeholder="Taxing Entity Name">
                                    </div>
                                    <div class="form-row" style="flex: 1;">
                                        <label>Actual Received:</label>
                                        <input type="number" name="incrementActual_0" step="0.01" placeholder="0.00">
                                    </div>
                                    <div class="form-row" style="flex: 1;">
                                        <label>Amount Remaining Authorized:</label>
                                        <input type="number" name="incrementRemaining_0" step="0.01" placeholder="0.00">
                                    </div>
                                    <button type="button" class="btn btn-secondary" onclick="removeIncrementDistributionRow(this)" style="padding: 6px 12px; font-size: 12px; margin-bottom: 0;">Remove</button>
                                </div>
                            `;
                        }
                        console.log('Increment Distribution section cleared and reset');
                    } catch (error) {
                        console.error('Error clearing Increment Distribution section:', error);
                    }
                    
                    // Show notification
                    try {
                        showNotification('Internal data submitted successfully!');
                    } catch (error) {
                        console.error('Error showing notification:', error);
                        alert('Internal data submitted successfully!');
                    }
                    
                    // Switch to internal database view to show the new submission
                    try {
                        showTab('internal');
                    } catch (error) {
                        console.error('Error switching to internal tab:', error);
                    }
                    
                    console.log('Submission saved:', submission);
                };
            } else {
                console.error('Internal form not found!');
            }

            // Submit all button
            const submitAllBtn = document.getElementById('external-submit-all-btn');
            if (submitAllBtn) {
                submitAllBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    console.log('Submit All clicked');
                    try {
                        // Ensure allSubmissions is an array
                        if (!Array.isArray(allSubmissions)) {
                            console.warn('allSubmissions was not an array. Resetting to empty array.');
                            allSubmissions = [];
                        }

                        if (currentSubmission && Array.isArray(currentSubmission.projectAreas) && currentSubmission.projectAreas.length > 0) {
                            const submittedCount = currentSubmission.projectAreas.length;
                            console.log('Project areas to submit:', submittedCount);
                            currentSubmission.projectAreas.forEach((projectArea, idx) => {
                                console.log('Adding project area', idx, projectArea);
                                allSubmissions.push(projectArea);
                            });

                            try {
                                const serialized = JSON.stringify(allSubmissions);
                                console.log('Serialized allSubmissions length:', serialized.length);
                                localStorage.setItem('allSubmissions', serialized);
                                console.log('Saved to allSubmissions:', allSubmissions.length, 'items');
                                renderInternalDBCityList();
                            } catch (storageError) {
                                console.error('localStorage setItem failed:', storageError);
                                throw storageError;
                            }
                            
                            // Success toast
                            try { showNotification(`Submitted ${submittedCount} project area${submittedCount > 1 ? 's' : ''} successfully!`); } catch (_) {}
                            
                            // Reset working state and UI
                            currentSubmission = {};
                            const table = document.getElementById('project-table');
                            const submitAllBtnEl = document.getElementById('external-submit-all-btn');
                            if (table) table.style.display = 'none';
                            if (submitAllBtnEl) submitAllBtnEl.style.display = 'none';
                            
                            // Show thank you page (only if elements exist)
                            const mainContainer = document.getElementById('main-container');
                            const thankYou = document.getElementById('external-thankyou');
                            if (mainContainer && thankYou) {
                                mainContainer.classList.add('hidden');
                                thankYou.classList.remove('hidden');
                            } else {
                                // Fallback: notify success
                                try { showNotification('Submission saved successfully.'); } catch (_) { alert('Submission saved successfully.'); }
                            }
                        } else {
                            console.log('No project areas to submit');
                            try { showNotification('Add at least one project area before submitting.'); } catch (_) {}
                        }
                    } catch (error) {
                        console.error('Error during Submit All:', error && (error.stack || error.message || error));
                        alert('There was an error submitting: ' + (error && (error.message || String(error))));
                    }
                });
            }

            // New submission button
            const newSubmissionBtn = document.getElementById('external-new-submission-btn');
            if (newSubmissionBtn) {
                newSubmissionBtn.onclick = function() {
                    document.getElementById('external-thankyou').classList.add('hidden');
                    document.getElementById('main-container').classList.remove('hidden');
                    document.getElementById('project-form').reset();
                    document.getElementById('project-table').style.display = 'none';
                    document.getElementById('external-submit-all-btn').style.display = 'none';
                    currentSubmission = {};
                };
            }

            // Add Expense button functionality
            const addExpenseBtn = document.getElementById('add-expense-btn');
            if (addExpenseBtn) {
                addExpenseBtn.onclick = function() {
                    addExpenseRow();
                };
            }

            // Add Governing Board button functionality
            const addGoverningBoardBtn = document.getElementById('add-governing-board-btn');
            if (addGoverningBoardBtn) {
                addGoverningBoardBtn.onclick = function() {
                    addGoverningBoardRow();
                };
            }

            // Add Agency Staff button functionality
            const addAgencyStaffBtn = document.getElementById('add-agency-staff-btn');
            if (addAgencyStaffBtn) {
                addAgencyStaffBtn.onclick = function() {
                    addAgencyStaffRow();
                };
            }

            // Add Increment Distribution button functionality
            const addIncrementDistributionBtn = document.getElementById('add-increment-distribution-btn');
            if (addIncrementDistributionBtn) {
                addIncrementDistributionBtn.onclick = function() {
                    addIncrementDistributionRow();
                };
            }

            // Add Sources of Funds button functionality
            const addSourcesOfFundsBtn = document.getElementById('add-sources-of-funds-btn');
            if (addSourcesOfFundsBtn) {
                addSourcesOfFundsBtn.onclick = function() {
                    addSourcesOfFundsRow();
                };
            }

            // PDF Upload functionality
            const pdfUploadInput = document.getElementById('project-area-map-upload');
            const pdfUploadZone = document.getElementById('pdf-upload-zone');
            
            if (pdfUploadInput) {
                pdfUploadInput.addEventListener('change', handlePDFUpload);
            }
            
            if (pdfUploadZone) {
                // Drag and drop functionality
                pdfUploadZone.addEventListener('dragover', handleDragOver);
                pdfUploadZone.addEventListener('dragleave', handleDragLeave);
                pdfUploadZone.addEventListener('drop', handleDrop);
                pdfUploadZone.addEventListener('click', () => pdfUploadInput.click());
            }
            
            // Debug: Check if submit buttons are found
            const externalSubmitBtn = projectForm?.querySelector('button[type="submit"]');
            const internalSubmitBtn = internalForm?.querySelector('button[type="submit"]');
            
            console.log('External submit button found:', !!externalSubmitBtn);
            console.log('Internal submit button found:', !!internalSubmitBtn);
            
            if (externalSubmitBtn) {
                console.log('External submit button text:', externalSubmitBtn.textContent);
            }
            if (internalSubmitBtn) {
                console.log('Internal submit button text:', internalSubmitBtn.textContent);
            }
        }

        function setupInternalDatabase() {
            // Search functionality
            const searchInput = document.getElementById('internal-db-search');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    renderInternalDBCityList();
                });
            }

            // Year filter
            const yearFilter = document.getElementById('internal-db-filter-year');
            if (yearFilter) {
                yearFilter.addEventListener('change', function() {
                    renderInternalDBCityList();
                });
            }

            // External year select - update expense labels
            const externalYearSelect = document.getElementById('external-year-select');
            if (externalYearSelect) {
                externalYearSelect.addEventListener('change', function() {
                    updateExpenseLabels();
                });
            }

            // Internal year select - update FY/TY labels
            const internalYearSelect = document.getElementById('internal-year-select');
            if (internalYearSelect) {
                internalYearSelect.addEventListener('change', function() {
                    updateInternalYearLabels();
                    updateExpenseLabels();
                });
            }

            // Populate internal form dropdowns when internal data tab is shown
            // Set up event listeners for tab buttons
            const externalTabBtn = document.getElementById('external-tab-btn');
            if (externalTabBtn) {
                externalTabBtn.addEventListener('click', function() {
                    showTab('external');
                });
            }

            const internalTabBtn = document.getElementById('internal-tab-btn');
            if (internalTabBtn) {
                internalTabBtn.addEventListener('click', function() {
                    showTab('internal');
                });
            }

            const internalDataTabBtn = document.getElementById('internal-data-tab-btn');
            if (internalDataTabBtn) {
                internalDataTabBtn.addEventListener('click', function() {
                    showTab('internal-data');
                    populateClientDropdown();
                    setupInternalFormButtons();
                });
            }

            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    // Reset to landing page
                    document.getElementById('landing-container').classList.remove('hidden');
                    document.getElementById('tab-bar').classList.add('hidden');
                    document.getElementById('main-container').classList.add('hidden');
                    document.getElementById('internal-container').classList.add('hidden');
                    document.getElementById('internal-data-request-container').classList.add('hidden');
                    document.getElementById('external-thankyou').classList.add('hidden');
                    
                    // Reset tab states
                    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                });
            }

            // Status filter
            const statusFilter = document.getElementById('internal-db-filter-status');
            if (statusFilter) {
                statusFilter.addEventListener('change', function() {
                    renderInternalDBCityList();
                });
            }

            // Total Expenses functionality
            const addTotalExpenseBtn = document.getElementById('add-total-expense-btn');
            if (addTotalExpenseBtn) {
                addTotalExpenseBtn.addEventListener('click', addTotalExpenseRow);
            }

            // Total Expenses NPV functionality
            const addTotalExpenseNpvBtn = document.getElementById('add-total-expense-npv-btn');
            if (addTotalExpenseNpvBtn) {
                addTotalExpenseNpvBtn.addEventListener('click', addTotalExpenseNpvRow);
            }

            // Tax Entities functionality
            const addTaxEntityBtn = document.getElementById('add-tax-entity-btn');
            if (addTaxEntityBtn) {
                addTaxEntityBtn.addEventListener('click', addTaxEntityRow);
            }

            // Auto-calculations
            const residentialAcreageInput = document.querySelector('input[name="residentialAcreage"]');
            const totalAcreageInput = document.querySelector('input[name="acreage"]');
            if (residentialAcreageInput) {
                residentialAcreageInput.addEventListener('input', calculatePercentResidential);
            }
            if (totalAcreageInput) {
                totalAcreageInput.addEventListener('input', calculatePercentResidential);
            }

            // Update year headers when year changes
            if (internalYearSelect) {
                internalYearSelect.addEventListener('change', updateYearHeaders);
            }
        }

        function populateYearDropdown(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;

            // Clear existing options except the first one
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }

            // Add years 2020-2060
            for (let year = 2020; year <= 2060; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                select.appendChild(option);
            }
        }

        function renderTable() {
            console.log('renderTable() called');
            const table = document.getElementById('project-table');
            const tbody = table.querySelector('tbody');
            const submitAllBtn = document.getElementById('external-submit-all-btn');
            
            console.log('Current submission project areas:', currentSubmission.projectAreas);
            console.log('Project areas length:', currentSubmission.projectAreas ? currentSubmission.projectAreas.length : 0);
            
            if (!currentSubmission.projectAreas || currentSubmission.projectAreas.length === 0) {
                console.log('No project areas, hiding table and submit button');
                table.style.display = 'none';
                submitAllBtn.style.display = 'none';
                return;
            }

            console.log('Showing table and submit button');
            table.style.display = 'table';
            submitAllBtn.style.display = 'block';
            
            tbody.innerHTML = '';
            
            currentSubmission.projectAreas.forEach((area, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${area.submitterName || ''}</td>
                    <td>${area.projectAreaName || ''}</td>
                    <td>${area.acreage || ''}</td>
                    <td>${area.creationYear || ''}</td>
                    <td>${area.baseYear || ''}</td>
                    <td>${area.termLength || ''}</td>
                    <td>${area.startYear || ''}</td>
                    <td>${area.expirationYear || ''}</td>
                    <td>${area.baseValue || ''}</td>
                    <td>${area.fyIncrement || ''}</td>
                    <td>${area.remainingLife || ''}</td>
                    <td>${area.fundBalance || ''}</td>
                    <td>${area.tyActualSpentTotal || ''}</td>
                    <td>${area.developedAcreage || ''}</td>
                    <td>${area.undevelopedAcreage || ''}</td>
                    <td>${area.residentialAcreage || ''}</td>
                    <td>${area.percentResidential || ''}</td>
                    <td>${area.totalAuthorizedHousingUnits || ''}</td>
                    <td>
                        <button onclick="editRow(${index})" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; margin-right: 5px;">Edit</button>
                        <button onclick="deleteRowFromTable(${index})" class="btn btn-delete" style="padding: 6px 12px; font-size: 12px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function editRow(index) {
            // Implementation for editing rows
            console.log('Edit row:', index);
        }

        function deleteRowFromTable(index) {
            if (confirm('Are you sure you want to delete this project area from the internal database?')) {
                // Remove from current session's project areas
                if (currentSubmission.projectAreas && currentSubmission.projectAreas[index]) {
                    const deletedArea = currentSubmission.projectAreas[index];
                    currentSubmission.projectAreas.splice(index, 1);
                    
                    // Remove from allSubmissions (the database)
                    const submitterName = deletedArea.submitterName;
                    const projectAreaName = deletedArea.projectAreaName;
                    const fy = deletedArea.fy;
                    
                    allSubmissions = allSubmissions.filter(sub => {
                        const matchesClient = (sub.submitterName || sub.cityCounty) === submitterName;
                        const matchesProject = (sub.projectAreaName || sub.projectArea) === projectAreaName;
                        const matchesYear = (sub.fy || sub.year) === fy;
                        return !(matchesClient && matchesProject && matchesYear);
                    });
                    
                    localStorage.setItem('allSubmissions', JSON.stringify(allSubmissions));
                    renderInternalDBCityList();
                    renderTable();
                    showNotification('Project area deleted from internal database.');
                }
            }
        }

        function getProjectAreaStatus(projectArea) {
            const externalData = allSubmissions.filter(sub => 
                sub.projectAreas && sub.projectAreas.some(pa => pa.projectAreaName === projectArea)
            );
            
            const internalData = allSubmissions.filter(sub => 
                sub.projectArea === projectArea
            );

            if (externalData.length > 1 || internalData.length > 1) {
                return 'Multiple Submissions';
            } else if (externalData.length === 1 && internalData.length === 1) {
                return 'Ready';
            } else if (externalData.length === 1 && internalData.length === 0) {
                return 'Internal Data Needed';
            } else {
                return 'None';
            }
        }

        function isExternalSubmission(submission = {}) {
            return Boolean(
                submission.submitterName ||
                submission.projectAreaName ||
                submission.projectAreas ||
                submission.agencySubmitter ||
                submission.baseYear
            );
        }

        function isInternalSubmission(submission = {}) {
            return Boolean(
                submission.cityCounty ||
                submission.projectArea ||
                submission.type ||
                submission.fy ||
                submission.taxRate
            );
        }

        function determineClientStatus(hasExternal, hasInternal) {
            if (hasExternal && hasInternal) return 'Ready';
            if (hasExternal) return 'Internal Data Needed';
            if (hasInternal) return 'External Data Needed';
            return 'Unknown';
        }

        function setInternalDbSort(column) {
            if (!column) return;
            if (internalDbSortConfig.column === column) {
                internalDbSortConfig.direction = internalDbSortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                internalDbSortConfig.column = column;
                internalDbSortConfig.direction = column === 'year' ? 'desc' : 'asc';
            }
            renderInternalDBCityList();
        }

        function getSortIndicator(column) {
            if (internalDbSortConfig.column !== column) return '‚Üï';
            return internalDbSortConfig.direction === 'asc' ? '‚ñ≤' : '‚ñº';
        }

        function renderInternalDBCityList() {
            const container = document.getElementById('internal-db-table-container');
            if (!container) return;

            if (!Array.isArray(allSubmissions)) {
                allSubmissions = [];
            }

            const searchTerm = (document.getElementById('internal-db-search')?.value || '').trim().toLowerCase();
            const selectedYear = document.getElementById('internal-db-filter-year')?.value || '';
            const selectedStatus = document.getElementById('internal-db-filter-status')?.value || '';

            const rowMap = new Map();
            const escapeForJsString = (value) => (value || '')
                .toString()
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'");

            allSubmissions.forEach((submission) => {
                if (!submission) return;
                const rawYear = (submission.year || submission.fy || '').toString().trim();
                const year = rawYear || 'Unknown';
                const rawClient = (
                    submission.cityCounty ||
                    submission.submitterName ||
                    submission.projectArea ||
                    'Unknown'
                ).toString().trim();
                const client = rawClient || 'Unknown';
                const key = `${year}||${client}`;

                if (!rowMap.has(key)) {
                    rowMap.set(key, {
                        year,
                        client,
                        projectCount: 0,
                        projectAreas: new Set(),
                        hasExternal: false,
                        hasInternal: false
                    });
                }

                const entry = rowMap.get(key);
                entry.projectCount += 1;

                const projectAreaName = (submission.projectArea || submission.projectAreaName || '').toString().trim();
                if (projectAreaName) {
                    entry.projectAreas.add(projectAreaName);
                }

                if (isExternalSubmission(submission)) entry.hasExternal = true;
                if (isInternalSubmission(submission)) entry.hasInternal = true;
            });

            let rows = Array.from(rowMap.values()).map((entry) => ({
                year: entry.year,
                client: entry.client,
                projectCount: entry.projectCount,
                projectAreas: Array.from(entry.projectAreas),
                status: determineClientStatus(entry.hasExternal, entry.hasInternal)
            }));

            rows = rows.filter((row) => {
                if (selectedYear && row.year !== selectedYear) return false;
                if (selectedStatus && row.status !== selectedStatus) return false;
                if (searchTerm) {
                    const haystack = `${row.client} ${row.year} ${row.status} ${row.projectAreas.join(' ')}`.toLowerCase();
                    if (!haystack.includes(searchTerm)) return false;
                }
                return true;
            });

            rows.sort((a, b) => {
                const { column, direction } = internalDbSortConfig;
                let comparison = 0;
                if (column === 'clients') {
                    comparison = a.client.localeCompare(b.client, undefined, { sensitivity: 'base' });
                } else if (column === 'year') {
                    const yearA = parseInt(a.year, 10) || 0;
                    const yearB = parseInt(b.year, 10) || 0;
                    comparison = yearA - yearB;
                } else if (column === 'projects') {
                    comparison = a.projectCount - b.projectCount;
                }

                if (comparison === 0) {
                    comparison = a.client.localeCompare(b.client, undefined, { sensitivity: 'base' });
                }

                return direction === 'asc' ? comparison : -comparison;
            });

            if (rows.length === 0) {
                container.innerHTML = `
                    <div class="table-container">
                        <div style="padding: 32px; text-align: center; color: var(--text-muted);">
                            No submissions match the current filters.
                        </div>
                    </div>
                `;
                return;
            }

            const buildSortHeader = (label, columnKey) => `
                <button type="button" class="table-sort-btn ${internalDbSortConfig.column === columnKey ? 'active' : ''}" data-column="${columnKey}">
                    <span>${label}</span>
                    <span class="sort-indicator">${getSortIndicator(columnKey)}</span>
                </button>
            `;

            let html = '<div class="table-container">';
            html += '<div style="max-height: 600px; overflow-y: auto;">';
            html += '<table class="table">';
            html += `<thead>
                        <tr>
                            <th>${buildSortHeader('Year', 'year')}</th>
                            <th>${buildSortHeader('Clients', 'clients')}</th>
                            <th>${buildSortHeader('Project Areas', 'projects')}</th>
                            <th>Actions</th>
                        </tr>
                    </thead><tbody>`;

            rows.forEach((row, index) => {
                const safeClient = escapeForJsString(row.client);
                const safeYear = escapeForJsString(row.year);
                const projectCountLabel = `${row.projectCount} project area${row.projectCount !== 1 ? 's' : ''}`;

                html += `<tr onclick="viewClientDetailsByYear('${safeClient}', '${safeYear}')" style="cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor=''">
                    <td><strong>${row.year}</strong></td>
                    <td>
                        <div style="display:flex; flex-direction:column;">
                            <strong>${row.client}</strong>
                            <span style="font-size:12px; color: var(--text-muted); text-transform:none;">${row.status}</span>
                        </div>
                    </td>
                    <td>${projectCountLabel}</td>
                    <td>
                        <div style="position: relative; display: inline-block;" onclick="event.stopPropagation();">
                            <button onclick="event.stopPropagation(); toggleDropdown('client-dropdown-${index}');" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 2px 6px;">‚ãØ</button>
                            <div id="client-dropdown-${index}" class="dropdown-content" style="display: none; position: absolute; right: 0; top: 100%; background-color: white; min-width: 150px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 10000; border-radius: 4px; border: 1px solid #ddd;">
                                <a href="#" onclick="event.preventDefault(); editClientName('${safeClient}', '${safeYear}'); toggleDropdown('client-dropdown-${index}');" style="display: block; padding: 10px 16px; text-decoration: none; color: #28a745; font-size: 12px;">Edit</a>
                                <a href="#" onclick="event.preventDefault(); deleteClientByYear('${safeClient}', '${safeYear}'); toggleDropdown('client-dropdown-${index}');" style="display: block; padding: 10px 16px; text-decoration: none; color: #dc3545; font-size: 12px;">Delete</a>
                            </div>
                        </div>
                    </td>
                </tr>`;
            });

            html += '</tbody></table></div></div>';
            container.innerHTML = html;

            container.querySelectorAll('.table-sort-btn').forEach((btn) => {
                btn.addEventListener('click', (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    setInternalDbSort(btn.dataset.column);
                });
            });
        }

        function viewClientDetailsByYear(city, year) {
            const container = document.getElementById('internal-db-table-container');
            const cityYearSubmissions = allSubmissions.filter(submission => {
                const submissionCity = submission.cityCounty || 
                                     submission.submitterName || 
                                     submission.projectArea || 
                                     'Unknown';
                const submissionYear = submission.year || submission.fy || 'Unknown';
                return submissionCity === city && submissionYear === year;
            });

            let html = '<div class="table-container">';
            html += `<div style="margin-bottom: 20px; display: flex; align-items: center; gap: 16px;">`;
            html += `<button onclick="renderInternalDBCityList()" class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px;">‚Üê Back to Clients</button>`;
            html += `<h3 style="margin: 0; color: var(--primary-blue);">${city} - ${year} Project Areas</h3>`;
            html += `<button onclick="generatePDFReport('${city}', '${year}')" class="btn btn-success" style="margin-left: auto; margin-right: 8px;">Generate Report</button>`;
            html += `<button onclick="downloadExcelForClient('${city}')" class="btn btn-primary">Download Excel</button>`;
            html += `</div>`;
            html += '<div style="max-height: 600px; overflow-y: auto;">';
            html += '<table class="table">';
            html += '<thead><tr><th>Project Area</th><th>Type</th><th>Purpose</th><th>Status</th><th>Total Project Areas</th><th>Governing Board</th><th>Agency Staff</th><th>Actions</th></tr></thead><tbody>';

            // Calculate total project areas for this city/year
            const totalProjectAreas = cityYearSubmissions.length;
            
            // Group submissions by project area to show separate entries
            const projectGroups = {};
            cityYearSubmissions.forEach(submission => {
                const projectArea = submission.projectArea || submission.projectAreaName || 'N/A';
                
                if (!projectGroups[projectArea]) {
                    projectGroups[projectArea] = submission;
                } else {
                    // Merge data if we have both external and internal data for same project
                    Object.assign(projectGroups[projectArea], submission);
                }
            });

            Object.values(projectGroups).forEach((submission, idx) => {
                const projectArea = submission.projectArea || submission.projectAreaName || 'N/A';
                const type = submission.type || 'N/A';
                const purpose = submission.purpose || 'N/A';
                
                // Determine status based on data completeness
                const hasExternalData = submission.submitterName || submission.projectAreaName;
                const hasInternalData = submission.cityCounty || submission.fy || submission.ty;
                let status, statusClass;
                
                if (hasExternalData && hasInternalData) {
                    status = 'Ready';
                    statusClass = 'status-ready';
                } else if (hasExternalData) {
                    status = 'Internal Data Needed';
                    statusClass = 'status-internal-needed';
                } else {
                    status = 'External Data Needed';
                    statusClass = 'status-external-needed';
                }

                // Get Governing Board and Agency Staff data
                const governingBoardMembers = [];
                const agencyStaffMembers = [];
                
                for (let i = 0; i < 10; i++) {
                    const boardName = submission[`governingBoardName_${i}`];
                    const boardTitle = submission[`governingBoardTitle_${i}`];
                    if (boardName || boardTitle) {
                        governingBoardMembers.push(`${boardName || ''}${boardTitle ? ` (${boardTitle})` : ''}`);
                    }
                    
                    const staffName = submission[`agencyStaffName_${i}`];
                    const staffTitle = submission[`agencyStaffTitle_${i}`];
                    if (staffName || staffTitle) {
                        agencyStaffMembers.push(`${staffName || ''}${staffTitle ? ` (${staffTitle})` : ''}`);
                    }
                }
                
                const governingBoardText = governingBoardMembers.length > 0 ? governingBoardMembers.join(', ') : 'N/A';
                const agencyStaffText = agencyStaffMembers.length > 0 ? agencyStaffMembers.join(', ') : 'N/A';
                
                html += `<tr onclick="viewProjectDetails('${city}', '${projectArea}', '${year}')" style="cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor=''">
                    <td><strong>${projectArea}</strong></td>
                    <td>${type}</td>
                    <td>${purpose}</td>
                    <td><span class="status-badge ${statusClass}">${status}</span></td>
                    <td><strong>${totalProjectAreas}</strong></td>
                    <td style="font-size: 12px; max-width: 200px;">${governingBoardText}</td>
                    <td style="font-size: 12px; max-width: 200px;">${agencyStaffText}</td>
                    <td>
                        <div style="position: relative; display: inline-block;" onclick="event.stopPropagation();">
                            <button onclick="toggleDropdown('dropdown-${idx}')" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 2px 6px;">‚ãØ</button>
                            <div id="dropdown-${idx}" class="dropdown-content" style="display: none; position: absolute; right: 0; top: 100%; background-color: white; min-width: 150px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 10000; border-radius: 4px; border: 1px solid #ddd;">
                                <a href="#" onclick="event.preventDefault(); viewProjectDetails('${city}', '${projectArea}', '${year}'); toggleDropdown('dropdown-${idx}');" style="display: block; padding: 10px 16px; text-decoration: none; color: #007bff; font-size: 12px;">View Details</a>
                                <a href="#" onclick="event.preventDefault(); editProjectAreaName('${city}', '${projectArea}', '${year}', ${idx}); toggleDropdown('dropdown-${idx}');" style="display: block; padding: 10px 16px; text-decoration: none; color: #28a745; font-size: 12px;">Edit</a>
                                <a href="#" onclick="event.preventDefault(); deleteFromInternalDB('${city}', '${projectArea}', '${year}'); toggleDropdown('dropdown-${idx}');" style="display: block; padding: 10px 16px; text-decoration: none; color: #dc3545; font-size: 12px;">Delete</a>
                            </div>
                        </div>
                    </td>
                </tr>`;
            });

            html += '</tbody></table></div></div>';
            container.innerHTML = html;
        }

        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (dropdown) {
                // Close all other dropdowns
                document.querySelectorAll('.dropdown-content').forEach(menu => {
                    if (menu.id !== dropdownId) {
                        menu.style.display = 'none';
                    }
                });
                
                // Toggle current dropdown
                if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                    dropdown.style.display = 'block';
                    
                    // Get button position to calculate dropdown position
                    const button = dropdown.previousElementSibling;
                    if (button) {
                        const rect = button.getBoundingClientRect();
                        const dropdownHeight = dropdown.offsetHeight || 80; // approximate height
                        const spaceBelow = window.innerHeight - rect.bottom;
                        const spaceAbove = rect.top;
                        
                        // Use fixed positioning to escape the scroll container
                        dropdown.style.position = 'fixed';
                        dropdown.style.zIndex = '10000';
                        
                        // Calculate position
                        let topPos, bottomPos;
                        if (spaceBelow < dropdownHeight && spaceAbove > spaceBelow) {
                            // Show above
                            bottomPos = window.innerHeight - rect.top;
                            dropdown.style.bottom = bottomPos + 'px';
                            dropdown.style.top = 'auto';
                        } else {
                            // Show below
                            topPos = rect.bottom;
                            dropdown.style.top = topPos + 'px';
                            dropdown.style.bottom = 'auto';
                        }
                        
                        // Position right edge
                        dropdown.style.right = (window.innerWidth - rect.right) + 'px';
                    }
                } else {
                    dropdown.style.display = 'none';
                }
            }
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('[onclick*="toggleDropdown"]')) {
                document.querySelectorAll('.dropdown-content').forEach(menu => {
                    menu.style.display = 'none';
                });
            }
        });

        function deleteFromInternalDB(city, projectArea, year) {
            if (confirm('Are you sure you want to delete this project area from the internal database?')) {
                // Find all submissions that match this city, project area, and year
                const submissionsToDelete = allSubmissions.filter(sub => {
                    const submissionCity = sub.cityCounty || sub.submitterName || sub.projectArea || 'Unknown';
                    const submissionProjectArea = sub.projectArea || sub.projectAreaName || 'N/A';
                    const submissionYear = sub.year || sub.fy || 'Unknown';
                    
                    return submissionCity === city && submissionProjectArea === projectArea && submissionYear === year;
                });
                
                // Remove them from allSubmissions
                allSubmissions = allSubmissions.filter(sub => {
                    const submissionCity = sub.cityCounty || sub.submitterName || sub.projectArea || 'Unknown';
                    const submissionProjectArea = sub.projectArea || sub.projectAreaName || 'N/A';
                    const submissionYear = sub.year || sub.fy || 'Unknown';
                    
                    return !(submissionCity === city && submissionProjectArea === projectArea && submissionYear === year);
                });
                
                // Save to localStorage
                localStorage.setItem('allSubmissions', JSON.stringify(allSubmissions));
                
                // Refresh the view
                viewClientDetailsByYear(city, year);
                
                // Show notification
                showNotification('Project area deleted from internal database.');
            }
        }

        function editProjectAreaName(city, projectArea, year, rowIndex) {
            const submission = allSubmissions.find(sub => {
                const submissionCity = sub.cityCounty || sub.submitterName || sub.projectArea || 'Unknown';
                const submissionProjectArea = sub.projectArea || sub.projectAreaName || 'N/A';
                const submissionYear = sub.year || sub.fy || 'Unknown';
                return submissionCity === city && submissionProjectArea === projectArea && submissionYear === year;
            });

            if (!submission) return;

            const currentClientName = submission.cityCounty || submission.submitterName || 'Unknown';
            const currentProjectAreaName = submission.projectArea || submission.projectAreaName || 'N/A';

            const newClientName = prompt('Edit Client/Submitter Name:', currentClientName);
            if (newClientName === null) return;

            const newProjectAreaName = prompt('Edit Project Area Name:', currentProjectAreaName);
            if (newProjectAreaName === null) return;

            // Update the submission
            submission.cityCounty = newClientName;
            submission.submitterName = newClientName;
            submission.projectArea = newProjectAreaName;
            submission.projectAreaName = newProjectAreaName;

            // Save to localStorage
            localStorage.setItem('allSubmissions', JSON.stringify(allSubmissions));

            // Refresh the view
            viewClientDetailsByYear(city, year);

            // Show notification
            showNotification('Client and project area names updated successfully.');
        }

        function editClientName(city, year) {
            const cityYearSubmissions = allSubmissions.filter(submission => {
                const submissionCity = submission.cityCounty || 
                                     submission.submitterName || 
                                     submission.projectArea || 
                                     'Unknown';
                const submissionYear = submission.year || submission.fy || 'Unknown';
                return submissionCity === city && submissionYear === year;
            });

            if (cityYearSubmissions.length === 0) return;

            const newClientName = prompt('Edit Client Name:', city);
            if (newClientName === null || newClientName === '') return;

            // Update all submissions for this client and year
            cityYearSubmissions.forEach(submission => {
                submission.cityCounty = newClientName;
                submission.submitterName = newClientName;
            });

            // Save to localStorage
            localStorage.setItem('allSubmissions', JSON.stringify(allSubmissions));

            // Refresh the view
            renderInternalDBCityList();

            // Show notification
            showNotification('Client name updated successfully.');
        }

        function deleteClientByYear(city, year) {
            if (confirm('Are you sure you want to delete all project areas for this client and year from the internal database?')) {
                // Remove all submissions that match this city and year
                allSubmissions = allSubmissions.filter(sub => {
                    const submissionCity = sub.cityCounty || sub.submitterName || sub.projectArea || 'Unknown';
                    const submissionYear = sub.year || sub.fy || 'Unknown';
                    
                    return !(submissionCity === city && submissionYear === year);
                });
                
                // Save to localStorage
                localStorage.setItem('allSubmissions', JSON.stringify(allSubmissions));
                
                // Refresh the view
                renderInternalDBCityList();
                
                // Show notification
                showNotification('Client data deleted from internal database.');
            }
        }

        function viewClientDetails(city) {
            const container = document.getElementById('internal-db-table-container');
            const citySubmissions = allSubmissions.filter(submission => {
                const submissionCity = submission.cityCounty || 
                                     submission.submitterName || 
                                     submission.projectArea || 
                                     'Unknown';
                return submissionCity === city;
            });

            let html = '<div class="table-container">';
            html += `<div style="margin-bottom: 20px; display: flex; align-items: center; gap: 16px;">`;
            html += `<button onclick="renderInternalDBCityList()" class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px;">‚Üê Back to Clients</button>`;
            html += `<h3 style="margin: 0; color: var(--primary-blue);">${city} - Project Areas</h3>`;
            html += `<button onclick="generatePDFReport('${city}', null)" class="btn btn-success" style="margin-left: auto; margin-right: 8px;">Generate Report</button>`;
            html += `<button onclick="downloadExcelForClient('${city}')" class="btn btn-primary">Download Excel</button>`;
            html += `</div>`;
            html += '<table class="table">';
            html += '<thead><tr><th>Project Area</th><th>Year</th><th>Type</th><th>Purpose</th><th>Status</th><th>Total Project Areas</th><th>Governing Board</th><th>Agency Staff</th><th>Actions</th></tr></thead><tbody>';

            // Calculate total project areas for this city (across all years)
            const totalProjectAreas = citySubmissions.length;
            
            // Group submissions by project area and year to show separate entries
            const projectYearGroups = {};
            citySubmissions.forEach(submission => {
                const projectArea = submission.projectArea || submission.projectAreaName || 'N/A';
                const year = submission.year || submission.fy || 'N/A';
                const key = `${projectArea}-${year}`;
                
                if (!projectYearGroups[key]) {
                    projectYearGroups[key] = {
                        projectArea: projectArea,
                        year: year,
                        submission: submission
                    };
                } else {
                    // Merge data if we have both external and internal data for same project/year
                    Object.assign(projectYearGroups[key].submission, submission);
                }
            });

            Object.values(projectYearGroups).forEach(group => {
                const submission = group.submission;
                const projectArea = group.projectArea;
                const year = group.year;
                const type = submission.type || 'N/A';
                const purpose = submission.purpose || 'N/A';
                
                // Determine status based on data completeness
                const hasExternalData = submission.submitterName || submission.projectAreaName;
                const hasInternalData = submission.cityCounty || submission.fy || submission.ty;
                let status, statusClass;
                
                if (hasExternalData && hasInternalData) {
                    status = 'Ready';
                    statusClass = 'status-ready';
                } else if (hasExternalData) {
                    status = 'Internal Data Needed';
                    statusClass = 'status-internal-needed';
                } else {
                    status = 'External Data Needed';
                    statusClass = 'status-external-needed';
                }

                // Get Governing Board and Agency Staff data
                const governingBoardMembers = [];
                const agencyStaffMembers = [];
                
                for (let i = 0; i < 10; i++) {
                    const boardName = submission[`governingBoardName_${i}`];
                    const boardTitle = submission[`governingBoardTitle_${i}`];
                    if (boardName || boardTitle) {
                        governingBoardMembers.push(`${boardName || ''}${boardTitle ? ` (${boardTitle})` : ''}`);
                    }
                    
                    const staffName = submission[`agencyStaffName_${i}`];
                    const staffTitle = submission[`agencyStaffTitle_${i}`];
                    if (staffName || staffTitle) {
                        agencyStaffMembers.push(`${staffName || ''}${staffTitle ? ` (${staffTitle})` : ''}`);
                    }
                }
                
                const governingBoardText = governingBoardMembers.length > 0 ? governingBoardMembers.join(', ') : 'N/A';
                const agencyStaffText = agencyStaffMembers.length > 0 ? agencyStaffMembers.join(', ') : 'N/A';
                
                html += `<tr>
                    <td><strong>${projectArea}</strong></td>
                    <td>${year}</td>
                    <td>${type}</td>
                    <td>${purpose}</td>
                    <td><span class="status-badge ${statusClass}">${status}</span></td>
                    <td><strong>${totalProjectAreas}</strong></td>
                    <td style="font-size: 12px; max-width: 200px;">${governingBoardText}</td>
                    <td style="font-size: 12px; max-width: 200px;">${agencyStaffText}</td>
                    <td><button onclick="viewProjectDetails('${city}', '${projectArea}', '${year}')" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;">View Details</button></td>
                </tr>`;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function viewProjectDetails(city, projectArea, year) {
            const container = document.getElementById('internal-db-table-container');
            const submission = allSubmissions.find(sub => {
                const submissionCity = sub.cityCounty || sub.submitterName || sub.projectArea || 'Unknown';
                const submissionProject = sub.projectArea || sub.projectAreaName || 'N/A';
                const submissionYear = sub.year || sub.fy || 'N/A';
                return submissionCity === city && submissionProject === projectArea && submissionYear === year;
            });

            if (!submission) {
                container.innerHTML = '<div class="card"><div class="card-body"><p>Project details not found.</p></div></div>';
                return;
            }

            let html = '<div class="card">';
            html += `<div class=\"card-header\" style=\"display: flex; align-items: center; gap: 16px;\">`;
            html += `<button onclick=\"viewClientDetails('${city}')\" class=\"btn btn-secondary\" style=\"padding: 8px 16px; font-size: 12px;\">‚Üê Back to ${city}</button>`;
            html += `<h3 style=\"margin: 0;\">${projectArea} - ${year}</h3>`;
            html += `<div style=\"margin-left: auto; display:flex; gap:8px;\">`;
            html += `<button id=\"edit-detail-btn\" class=\"btn btn-primary\">Edit</button>`;
            html += `<button id=\"save-detail-btn\" class=\"btn btn-success\" style=\"display:none;\">Save</button>`;
            html += `<button id=\"cancel-detail-btn\" class=\"btn btn-secondary\" style=\"display:none;\">Cancel</button>`;
            html += `</div>`;
            html += `</div>`;
            html += '<div class="card-body">';
            
            // Basic Information
            html += '<div class="section-title" style="display:flex; align-items:center; gap:8px;">Basic Information<div style="margin-left:auto; display:flex; gap:8px;">'
                + '<button class="btn btn-primary section-edit" data-section="basic" style="padding:4px 10px; font-size:12px;">Edit</button>'
                + '<button class="btn btn-success section-save" data-section="basic" style="padding:4px 10px; font-size:12px; display:none;">Save</button>'
                + '<button class="btn btn-secondary section-cancel" data-section="basic" style="padding:4px 10px; font-size:12px; display:none;">Cancel</button>'
                + '</div></div>';
            html += '<div class="form-grid editable-section" data-section="basic">';
            html += `<div class=\"form-row\"><label>Agency/Submitter:</label><span data-key=\"submitterName|cityCounty\">${submission.submitterName || submission.cityCounty || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\"><label>Project Area:</label><span data-key=\"projectArea|projectAreaName\">${submission.projectArea || submission.projectAreaName || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\"><label>Year:</label><span data-key=\"year|fy\">${submission.year || submission.fy || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\"><label>FY:</label><span data-key=\"fy\">${submission.fy || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\"><label>TY:</label><span data-key=\"ty\">${submission.ty || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\"><label>Type:</label><span data-key=\"type\">${submission.type || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\"><label>Purpose:</label><span data-key=\"purpose\">${submission.purpose || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\"><label>Taxing District:</label><span data-key=\"taxingDistrict\">${submission.taxingDistrict || 'N/A'}</span></div>`;
            html += `<div class=\"form-row\"><label>Tax Rate:</label><span data-key=\"taxRate\">${submission.taxRate || 'N/A'}</span></div>`;
            html += '</div>';

            // Project Area Information (External Form)
            if (submission.acreage || submission.creationYear || submission.baseYear || submission.termLength || submission.startYear || submission.expirationYear || submission.baseValue || submission.fyIncrement || submission.remainingLife || submission.fundBalance) {
                html += '<div class="section-title" style="display:flex; align-items:center; gap:8px;">Project Area Information<div style="margin-left:auto; display:flex; gap:8px;">'
                    + '<button class="btn btn-primary section-edit" data-section="project" style="padding:4px 10px; font-size:12px;">Edit</button>'
                    + '<button class="btn btn-success section-save" data-section="project" style="padding:4px 10px; font-size:12px; display:none;">Save</button>'
                    + '<button class="btn btn-secondary section-cancel" data-section="project" style="padding:4px 10px; font-size:12px; display:none;">Cancel</button>'
                    + '</div></div>';
                html += '<div class="form-grid editable-section" data-section="project">';
                html += `<div class=\"form-row\"><label>ACREAGE:</label><span data-key=\"acreage\">${submission.acreage || 'N/A'}</span></div>`;
                html += `<div class=\"form-row\"><label>CREATION YEAR:</label><span data-key=\"creationYear\">${submission.creationYear || 'N/A'}</span></div>`;
                html += `<div class=\"form-row\"><label>BASE YEAR:</label><span data-key=\"baseYear\">${submission.baseYear || 'N/A'}</span></div>`;
                html += `<div class=\"form-row\"><label>TERM LENGTH:</label><span data-key=\"termLength\">${submission.termLength || 'N/A'}</span></div>`;
                html += `<div class=\"form-row\"><label>START YEAR:</label><span data-key=\"startYear\">${submission.startYear || 'N/A'}</span></div>`;
                html += `<div class=\"form-row\"><label>EXPIRATION YEAR:</label><span data-key=\"expirationYear\">${submission.expirationYear || 'N/A'}</span></div>`;
                html += `<div class=\"form-row\"><label>BASE VALUE:</label><span data-key=\"baseValue\">${submission.baseValue || 'N/A'}</span></div>`;
                html += `<div class=\"form-row\"><label>FY INCREMENT:</label><span data-key=\"fyIncrement\">${submission.fyIncrement || 'N/A'}</span></div>`;
                html += `<div class=\"form-row\"><label>REMAINING LIFE:</label><span data-key=\"remainingLife\">${submission.remainingLife || 'N/A'}</span></div>`;
                html += `<div class=\"form-row\"><label>FUND BALANCE:</label><span data-key=\"fundBalance\">${submission.fundBalance || 'N/A'}</span></div>`;
                html += '</div>';
            }

            // Value Information
            if (submission.tyValue || submission.valueIncrease) {
            html += '<div class="section-title" style="display:flex; align-items:center; gap:8px;">Value Information<div style="margin-left:auto; display:flex; gap:8px;">'
                + '<button class="btn btn-primary section-edit" data-section="value" style="padding:4px 10px; font-size:12px;">Edit</button>'
                + '<button class="btn btn-success section-save" data-section="value" style="padding:4px 10px; font-size:12px; display:none;">Save</button>'
                + '<button class="btn btn-secondary section-cancel" data-section="value" style="padding:4px 10px; font-size:12px; display:none;">Cancel</button>'
                + '</div></div>';
            html += '<div class="form-grid editable-section" data-section="value">';
                html += `<div class=\"form-row\"><label>TY Value:</label><span data-key=\"tyValue\">${submission.tyValue || ''}</span></div>`;
                html += `<div class=\"form-row\"><label>Value Increase:</label><span data-key=\"valueIncrease\">${submission.valueIncrease || ''}</span></div>`;
                if (submission.growthInAssessedValue) {
                    html += `<div class=\"form-row\" style=\"grid-column: 1 / -1;\"><label>Growth in Assessed Value:</label><span data-key=\"growthInAssessedValue\">${submission.growthInAssessedValue}</span></div>`;
                }
                html += '</div>';
            }

            // Development Information (External Form)
            if (submission.developedAcreage || submission.undevelopedAcreage || submission.residentialAcreage || submission.percentResidential || submission.totalAuthorizedHousingUnits) {
            html += '<div class="section-title" style="display:flex; align-items:center; gap:8px;">Development Information<div style="margin-left:auto; display:flex; gap:8px;">'
                + '<button class="btn btn-primary section-edit" data-section="development" style="padding:4px 10px; font-size:12px;">Edit</button>'
                + '<button class="btn btn-success section-save" data-section="development" style="padding:4px 10px; font-size:12px; display:none;">Save</button>'
                + '<button class="btn btn-secondary section-cancel" data-section="development" style="padding:4px 10px; font-size:12px; display:none;">Cancel</button>'
                + '</div></div>';
            html += '<div class="form-grid editable-section" data-section="development">';
                html += `<div class="form-row"><label>DEVELOPED ACREAGE:</label><span data-key="developedAcreage">${submission.developedAcreage || ''}</span></div>`;
                html += `<div class="form-row"><label>UNDEVELOPED ACREAGE:</label><span data-key="undevelopedAcreage">${submission.undevelopedAcreage || ''}</span></div>`;
                html += `<div class="form-row"><label>RESIDENTIAL ACREAGE:</label><span data-key="residentialAcreage">${submission.residentialAcreage || ''}</span></div>`;
                html += `<div class="form-row"><label>% RESIDENTIAL:</label><span data-key="percentResidential">${submission.percentResidential || ''}</span></div>`;
                html += `<div class="form-row"><label>TOTAL AUTHORIZED HOUSING UNITS:</label><span data-key="totalAuthorizedHousingUnits">${submission.totalAuthorizedHousingUnits || ''}</span></div>`;
                html += '</div>';
            }

            // Descriptions (External Form)
            if (submission.descriptionSignificantDevelopment || submission.descriptionPlanFurthered || submission.descriptionOtherIssues) {
            html += '<div class="section-title" style="display:flex; align-items:center; gap:8px;">Descriptions<div style="margin-left:auto; display:flex; gap:8px;">'
                + '<button class="btn btn-primary section-edit" data-section="descriptions" style="padding:4px 10px; font-size:12px;">Edit</button>'
                + '<button class="btn btn-success section-save" data-section="descriptions" style="padding:4px 10px; font-size:12px; display:none;">Save</button>'
                + '<button class="btn btn-secondary section-cancel" data-section="descriptions" style="padding:4px 10px; font-size:12px; display:none;">Cancel</button>'
                + '</div></div>';
                html += '<div class="form-grid editable-section" data-section="descriptions">';
                if (submission.descriptionSignificantDevelopment) {
                    html += `<div class="form-row" style="grid-column: 1 / -1;"><label>DESCRIPTION OF SIGNIFICANT DEVELOPMENT:</label><span data-key="descriptionSignificantDevelopment">${submission.descriptionSignificantDevelopment}</span></div>`;
                }
                if (submission.descriptionPlanFurthered) {
                    html += `<div class="form-row" style="grid-column: 1 / -1;"><label>DESCRIPTION OF HOW THE PLAN HAS BEEN FURTHERED:</label><span data-key="descriptionPlanFurthered">${submission.descriptionPlanFurthered}</span></div>`;
                }
                if (submission.descriptionOtherIssues) {
                    html += `<div class="form-row" style="grid-column: 1 / -1;"><label>DESCRIPTION OF OTHER ISSUES WORTH NOTING:</label><span data-key="descriptionOtherIssues">${submission.descriptionOtherIssues}</span></div>`;
                }
                html += '</div>';
            }

            // Expenses (editable)
            if (submission.expenses && submission.expenses.length > 0) {
                html += '<div class="section-title" style="display:flex; align-items:center; gap:8px;">Expenses<div style="margin-left:auto; display:flex; gap:8px;">'
                    + '<button class="btn btn-primary section-edit" data-section="expenses" style="padding:4px 10px; font-size:12px;">Edit</button>'
                    + '<button class="btn btn-success section-save" data-section="expenses" style="padding:4px 10px; font-size:12px; display:none;">Save</button>'
                    + '<button class="btn btn-secondary section-cancel" data-section="expenses" style="padding:4px 10px; font-size:12px; display:none;">Cancel</button>'
                    + '</div></div>';
                html += '<div class="table-container editable-section" data-section="expenses">';
                html += '<table class="table">';
                html += '<thead><tr><th>Expense Title</th><th>TY Expense</th><th>CY Expense</th><th>NY Expense</th></tr></thead><tbody>';
                
                submission.expenses.forEach((expense, i) => {
                    html += `<tr>
                        <td data-key="expenses.${i}.title">${expense.title || ''}</td>
                        <td data-key="expenses.${i}.tyExpense">${expense.tyExpense || ''}</td>
                        <td data-key="expenses.${i}.cyExpense">${expense.cyExpense || ''}</td>
                        <td data-key="expenses.${i}.nyExpense">${expense.nyExpense || ''}</td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
            }

            // Tax Entities (editable)
            if (submission.taxEntities && submission.taxEntities.length > 0) {
                html += '<div class="section-title" style="display:flex; align-items:center; gap:8px;">Tax Entities<div style="margin-left:auto; display:flex; gap:8px;">'
                    + '<button class="btn btn-primary section-edit" data-section="taxentities" style="padding:4px 10px; font-size:12px;">Edit</button>'
                    + '<button class="btn btn-success section-save" data-section="taxentities" style="padding:4px 10px; font-size:12px; display:none;">Save</button>'
                    + '<button class="btn btn-secondary section-cancel" data-section="taxentities" style="padding:4px 10px; font-size:12px; display:none;">Cancel</button>'
                    + '</div></div>';
                html += '<div class="table-container editable-section" data-section="taxentities">';
                html += '<table class="table">';
                html += '<thead><tr><th>Tax Entity</th><th>Tax Rate</th><th>Tax Revenue</th></tr></thead><tbody>';
                
                submission.taxEntities.forEach((entity, i) => {
                    html += `<tr>
                        <td data-key="taxEntities.${i}.name">${entity.name || ''}</td>
                        <td data-key="taxEntities.${i}.rate">${entity.rate || ''}</td>
                        <td data-key="taxEntities.${i}.revenue">${entity.revenue || ''}</td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
            }

            // Additional Internal Form Fields (editable)
            if (submission.totalAggregateExpense || submission.totalAggregateExpenseAtNpv || submission.totalUsesOfFundsNpv || submission.descriptionOfBenefitsToTaxingEntities) {
                html += '<div class="section-title" style="display:flex; align-items:center; gap:8px;">Additional Internal Information<div style="margin-left:auto; display:flex; gap:8px;">'
                    + '<button class="btn btn-primary section-edit" data-section="additional" style="padding:4px 10px; font-size:12px;">Edit</button>'
                    + '<button class="btn btn-success section-save" data-section="additional" style="padding:4px 10px; font-size:12px; display:none;">Save</button>'
                    + '<button class="btn btn-secondary section-cancel" data-section="additional" style="padding:4px 10px; font-size:12px; display:none;">Cancel</button>'
                    + '</div></div>';
                html += '<div class="form-grid editable-section" data-section="additional">';
                if (submission.totalAggregateExpense) {
                    html += `<div class="form-row"><label>TOTAL AGGREGATE EXPENSE:</label><span data-key="totalAggregateExpense">${submission.totalAggregateExpense}</span></div>`;
                }
                if (submission.totalAggregateExpenseAtNpv) {
                    html += `<div class="form-row"><label>TOTAL AGGREGATE EXPENSE AT NPV:</label><span data-key="totalAggregateExpenseAtNpv">${submission.totalAggregateExpenseAtNpv}</span></div>`;
                }
                if (submission.totalUsesOfFundsNpv) {
                    html += `<div class="form-row"><label>TOTAL USES OF FUNDS NPV:</label><span data-key="totalUsesOfFundsNpv">${submission.totalUsesOfFundsNpv}</span></div>`;
                }
                if (submission.descriptionOfBenefitsToTaxingEntities) {
                    html += `<div class="form-row" style="grid-column: 1 / -1;"><label>DESCRIPTION OF BENEFITS TO TAXING ENTITIES:</label><span data-key="descriptionOfBenefitsToTaxingEntities">${submission.descriptionOfBenefitsToTaxingEntities}</span></div>`;
                }
                html += '</div>';
            }

            // Governing Board (from indexed fields)
            const boardRows = [];
            for (let i = 0; i < 50; i++) {
                const name = submission[`governingBoardName_${i}`];
                const title = submission[`governingBoardTitle_${i}`];
                if (name || title) boardRows.push({ name, title });
            }
            if (boardRows.length > 0) {
                html += '<div class="section-title" style="display:flex; align-items:center; gap:8px;">Governing Board of Trustees<div style="margin-left:auto; display:flex; gap:8px;">'
                    + '<button class="btn btn-primary section-edit" data-section="board" style="padding:4px 10px; font-size:12px;">Edit</button>'
                    + '<button class="btn btn-success section-save" data-section="board" style="padding:4px 10px; font-size:12px; display:none;">Save</button>'
                    + '<button class="btn btn-secondary section-cancel" data-section="board" style="padding:4px 10px; font-size:12px; display:none;">Cancel</button>'
                    + '</div></div>';
                html += '<div class="table-container editable-section" data-section="board">';
                html += '<table class="table">';
                html += '<thead><tr><th>Name</th><th>Title</th></tr></thead><tbody>';
                for (let i = 0; i < 50; i++) {
                    const name = submission[`governingBoardName_${i}`];
                    const title = submission[`governingBoardTitle_${i}`];
                    if (name || title) {
                        html += `<tr><td data-key="governingBoardName_${i}">${name || ''}</td><td data-key="governingBoardTitle_${i}">${title || ''}</td></tr>`;
                    }
                }
                html += '</tbody></table></div>';
            }

            // Agency Staff (from indexed fields)
            const staffRows = [];
            for (let i = 0; i < 50; i++) {
                const name = submission[`agencyStaffName_${i}`];
                const title = submission[`agencyStaffTitle_${i}`];
                if (name || title) staffRows.push({ name, title });
            }
            if (staffRows.length > 0) {
                html += '<div class="section-title" style="display:flex; align-items:center; gap:8px;">Agency Staff<div style="margin-left:auto; display:flex; gap:8px;">'
                    + '<button class="btn btn-primary section-edit" data-section="staff" style="padding:4px 10px; font-size:12px;">Edit</button>'
                    + '<button class="btn btn-success section-save" data-section="staff" style="padding:4px 10px; font-size:12px; display:none;">Save</button>'
                    + '<button class="btn btn-secondary section-cancel" data-section="staff" style="padding:4px 10px; font-size:12px; display:none;">Cancel</button>'
                    + '</div></div>';
                html += '<div class="table-container editable-section" data-section="staff">';
                html += '<table class="table">';
                html += '<thead><tr><th>Name</th><th>Title</th></tr></thead><tbody>';
                for (let i = 0; i < 50; i++) {
                    const name = submission[`agencyStaffName_${i}`];
                    const title = submission[`agencyStaffTitle_${i}`];
                    if (name || title) {
                        html += `<tr><td data-key="agencyStaffName_${i}">${name || ''}</td><td data-key="agencyStaffTitle_${i}">${title || ''}</td></tr>`;
                    }
                }
                html += '</tbody></table></div>';
            }

            // Combined Tax Increment Budget
            html += '<div class="section-title">Combined Tax Increment Budget</div>';
            html += generateCombinedTaxIncrementBudget(city, year);
            
            // Combined Acreage Overview
            html += '<div class="section-title">Combined Acreage Overview</div>';
            html += generateCombinedAcreageOverview(city, year);
            
            // Increment Distribution
            if (submission.incrementEntity_0 || submission.incrementActual_0 || submission.incrementRemaining_0) {
                html += '<div class="section-title">Increment Distribution</div>';
                html += '<div class="table-container">';
                html += '<table class="table">';
                html += '<thead><tr><th>Entity Description</th><th>Actual Received</th><th>Amount Remaining Authorized</th></tr></thead><tbody>';
                
                // Show up to 10 increment distribution entries
                for (let i = 0; i < 10; i++) {
                    const entity = submission[`incrementEntity_${i}`];
                    const actual = submission[`incrementActual_${i}`];
                    const remaining = submission[`incrementRemaining_${i}`];
                    
                    if (entity || actual || remaining) {
                        html += `<tr>
                            <td>${entity || 'N/A'}</td>
                            <td>$${parseFloat(actual || 0).toLocaleString()}</td>
                            <td>$${parseFloat(remaining || 0).toLocaleString()}</td>
                        </tr>`;
                    }
                }
                
                html += '</tbody></table></div>';
            }

            // Project Area Maps
            if (submission.projectAreaMaps && submission.projectAreaMaps.length > 0) {
                html += '<div class="section-title">Project Area Maps</div>';
                html += '<div style="display: grid; gap: 12px; margin-top: 16px;">';
                
                submission.projectAreaMaps.forEach((map, index) => {
                    html += `<div style="
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%);
                        border: 1px solid #e3f2fd;
                        border-radius: 12px;
                        padding: 16px 20px;
                        transition: all 0.3s ease;
                        box-shadow: 0 2px 8px rgba(0,123,255,0.1);
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 16px rgba(0,123,255,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,123,255,0.1)'">
                        <div style="display: flex; align-items: center; gap: 16px; flex: 1;">
                            <div style="
                                width: 48px;
                                height: 48px;
                                background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                                border-radius: 12px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-size: 20px;
                                font-weight: bold;
                                box-shadow: 0 2px 8px rgba(220,53,69,0.3);
                            ">PDF</div>
                            <div>
                                <div style="font-weight: 600; color: #333; margin-bottom: 4px; font-size: 16px;">${map.name}</div>
                                <div style="font-size: 13px; color: #666; display: flex; align-items: center; gap: 8px;">
                                    <span>üìä</span>
                                    <span>${(map.size / 1024).toFixed(1)} KB</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="downloadPDF('${map.name}', '${map.data}')" style="
                            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
                            color: white;
                            border: none;
                            border-radius: 8px;
                            padding: 10px 16px;
                            font-size: 14px;
                            font-weight: 500;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            box-shadow: 0 2px 8px rgba(0,123,255,0.3);
                        " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 16px rgba(0,123,255,0.4)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(0,123,255,0.3)'">
                            <span>‚¨áÔ∏è</span>
                            <span>Download</span>
                        </button>
                    </div>`;
                });
                
                html += '</div>';
            }
            
            html += '</div></div>';
            container.innerHTML = html;

            // Wire up inline edit controls
            const editBtn = document.getElementById('edit-detail-btn');
            const saveBtn = document.getElementById('save-detail-btn');
            const cancelBtn = document.getElementById('cancel-detail-btn');

            let snapshot = null;

            function setEditable(isEditable) {
                const spans = container.querySelectorAll('[data-key]');
                spans.forEach(el => {
                    el.contentEditable = isEditable ? 'true' : 'false';
                    el.style.outline = isEditable ? '1px dashed var(--border-gray)' : '';
                    el.style.background = isEditable ? 'var(--bg-secondary)' : '';
                });
                if (editBtn) editBtn.style.display = isEditable ? 'none' : '';
                if (saveBtn) saveBtn.style.display = isEditable ? '' : 'none';
                if (cancelBtn) cancelBtn.style.display = isEditable ? '' : 'none';
            }

            if (editBtn) {
                editBtn.onclick = function() {
                    snapshot = {};
                    container.querySelectorAll('[data-key]').forEach(el => {
                        snapshot[el.getAttribute('data-key')] = el.textContent;
                    });
                    setEditable(true);
                };
            }
            if (cancelBtn) {
                cancelBtn.onclick = function() {
                    if (snapshot) {
                        container.querySelectorAll('[data-key]').forEach(el => {
                            const key = el.getAttribute('data-key');
                            if (snapshot[key] !== undefined) el.textContent = snapshot[key];
                        });
                    }
                    setEditable(false);
                };
            }
            if (saveBtn) {
                saveBtn.onclick = function() {
                    const target = allSubmissions.find(sub => {
                        const subCity = sub.cityCounty || sub.submitterName || sub.projectArea || 'Unknown';
                        const subYear = sub.year || sub.fy || 'Unknown';
                        const subProject = sub.projectArea || sub.projectAreaName || 'Unknown';
                        return subCity === city && subYear === year && subProject === (projectArea || 'Unknown');
                    });
                    if (target) {
                        container.querySelectorAll('[data-key]').forEach(el => {
                            const spec = el.getAttribute('data-key');
                            const keys = spec.split('|');
                            const value = el.textContent.trim();
                            for (const k of keys) {
                                if (k) { target[k] = value; break; }
                            }
                        });
                        localStorage.setItem('allSubmissions', JSON.stringify(allSubmissions));
                        showNotification('Changes saved.');
                        setEditable(false);
                    }
                };
            }

            // Per-section edit handlers
            const sectionSnapshots = {};

            function setSectionEditable(section, isEditable) {
                const wrapper = container.querySelector(`.editable-section[data-section="${section}"]`);
                if (!wrapper) return;
                const spans = wrapper.querySelectorAll('[data-key]');
                spans.forEach(el => {
                    el.contentEditable = isEditable ? 'true' : 'false';
                    el.style.outline = isEditable ? '1px dashed var(--border-gray)' : '';
                    el.style.background = isEditable ? 'var(--bg-secondary)' : '';
                });
                const edit = container.querySelector(`.section-edit[data-section="${section}"]`);
                const save = container.querySelector(`.section-save[data-section="${section}"]`);
                const cancel = container.querySelector(`.section-cancel[data-section="${section}"]`);
                if (edit) edit.style.display = isEditable ? 'none' : '';
                if (save) save.style.display = isEditable ? '' : 'none';
                if (cancel) cancel.style.display = isEditable ? '' : 'none';
            }

            container.querySelectorAll('.section-edit').forEach(btn => {
                btn.addEventListener('click', () => {
                    const section = btn.getAttribute('data-section');
                    const wrapper = container.querySelector(`.editable-section[data-section="${section}"]`);
                    const snap = {};
                    wrapper.querySelectorAll('[data-key]').forEach(el => {
                        snap[el.getAttribute('data-key')] = el.textContent;
                    });
                    sectionSnapshots[section] = snap;
                    setSectionEditable(section, true);
                });
            });

            container.querySelectorAll('.section-cancel').forEach(btn => {
                btn.addEventListener('click', () => {
                    const section = btn.getAttribute('data-section');
                    const wrapper = container.querySelector(`.editable-section[data-section="${section}"]`);
                    const snap = sectionSnapshots[section] || {};
                    wrapper.querySelectorAll('[data-key]').forEach(el => {
                        const key = el.getAttribute('data-key');
                        if (snap[key] !== undefined) el.textContent = snap[key];
                    });
                    setSectionEditable(section, false);
                });
            });

            container.querySelectorAll('.section-save').forEach(btn => {
                btn.addEventListener('click', () => {
                    const section = btn.getAttribute('data-section');
                    const wrapper = container.querySelector(`.editable-section[data-section="${section}"]`);
                    const target = allSubmissions.find(sub => {
                        const subCity = sub.cityCounty || sub.submitterName || sub.projectArea || 'Unknown';
                        const subYear = sub.year || sub.fy || 'Unknown';
                        const subProject = sub.projectArea || sub.projectAreaName || 'Unknown';
                        return subCity === city && subYear === year && subProject === (projectArea || 'Unknown');
                    });
                    if (target) {
                        wrapper.querySelectorAll('[data-key]').forEach(el => {
                            const spec = el.getAttribute('data-key');
                            const value = el.textContent.trim();
                            if (spec.includes('.')) {
                                // nested path like expenses.0.title or taxEntities.2.name
                                const parts = spec.split('.');
                                let ref = target;
                                for (let i = 0; i < parts.length - 1; i++) {
                                    const p = parts[i];
                                    if (ref[p] === undefined) ref[p] = isNaN(Number(parts[i+1])) ? {} : [];
                                    ref = ref[p];
                                }
                                ref[parts[parts.length - 1]] = value;
                            } else {
                                const keys = spec.split('|');
                                for (const k of keys) { if (k) { target[k] = value; break; } }
                            }
                        });
                        localStorage.setItem('allSubmissions', JSON.stringify(allSubmissions));
                        showNotification('Section saved.');
                    }
                    setSectionEditable(section, false);
                });
            });
        }

        function generateCombinedTaxIncrementBudget(city, year) {
            // Get all submissions for this city and year
            const cityYearSubmissions = allSubmissions.filter(submission => {
                const submissionCity = submission.cityCounty || submission.submitterName;
                const submissionYear = submission.year || submission.fy;
                return submissionCity === city && parseInt(submissionYear) === parseInt(year);
            });

            if (cityYearSubmissions.length === 0) {
                return '<div class="table-container"><p>No data available for this city and year.</p></div>';
            }

            let html = '<div class="table-container">';
            html += '<table class="table" style="margin-bottom: 32px;">';
            
            // Revenue Section Header
            html += '<thead><tr style="background-color: #f8f9fa; font-weight: bold;">';
            html += '<th colspan="5" style="text-align: center; background-color: #e9ecef;">COMBINED TAX REVENUE</th>';
            html += '</tr>';
            html += '<tr><th>Description</th><th>Current Year</th><th>Next Year Projected</th><th>Next Year+1 Projected</th><th>Authorized Amount Remaining</th></tr></thead>';
            html += '<tbody>';

            // Revenue rows - one for each project area
            let totalCurrentYear = 0;
            let totalNextYear = 0;
            let totalNextYearPlus1 = 0;
            let totalAuthorizedRemaining = 0;

            cityYearSubmissions.forEach(submission => {
                const projectArea = submission.projectArea || submission.projectAreaName || 'N/A';
                const fyIncrement = parseFloat(submission.fyIncrement) || 0;
                const authorizedRemaining = parseFloat(submission.remainingAuthorized) || 0;

                totalCurrentYear += fyIncrement;
                totalNextYear += fyIncrement;
                totalNextYearPlus1 += fyIncrement;
                totalAuthorizedRemaining += authorizedRemaining;

                html += `<tr>
                    <td><strong>${projectArea} - Revenue</strong></td>
                    <td>$${fyIncrement.toLocaleString()}</td>
                    <td>$${fyIncrement.toLocaleString()}</td>
                    <td>$${fyIncrement.toLocaleString()}</td>
                    <td>$${authorizedRemaining.toLocaleString()}</td>
                </tr>`;
            });

            // Revenue totals row
            html += `<tr style="background-color: #e9ecef; font-weight: bold;">
                <td><strong>TOTAL REVENUE</strong></td>
                <td><strong>$${totalCurrentYear.toLocaleString()}</strong></td>
                <td><strong>$${totalNextYear.toLocaleString()}</strong></td>
                <td><strong>$${totalNextYearPlus1.toLocaleString()}</strong></td>
                <td><strong>$${totalAuthorizedRemaining.toLocaleString()}</strong></td>
            </tr>`;

            html += '</tbody></table>';

            // Expenses Section
            html += '<table class="table">';
            html += '<thead><tr style="background-color: #f8f9fa; font-weight: bold;">';
            html += '<th colspan="5" style="text-align: center; background-color: #e9ecef;">COMBINED EXPENSES</th>';
            html += '</tr>';
            html += '<tr><th>Description</th><th>Current Year</th><th>Next Year Projected</th><th>Next Year+1 Projected</th><th>Authorized Amount Remaining</th></tr></thead>';
            html += '<tbody>';

            // Collect all unique expense types across all project areas
            const expenseTypes = new Map();
            
            cityYearSubmissions.forEach(submission => {
                if (submission.expenses && submission.expenses.length > 0) {
                    submission.expenses.forEach(expense => {
                        const expenseTitle = expense.title || 'Unnamed Expense';
                        if (!expenseTypes.has(expenseTitle)) {
                            expenseTypes.set(expenseTitle, {
                                tyExpense: 0,
                                cyExpense: 0,
                                nyExpense: 0,
                                authorizedRemaining: 0
                            });
                        }
                        
                        const expenseData = expenseTypes.get(expenseTitle);
                        expenseData.tyExpense += parseFloat(expense.tyExpense) || 0;
                        expenseData.cyExpense += parseFloat(expense.cyExpense) || 0;
                        expenseData.nyExpense += parseFloat(expense.nyExpense) || 0;
                    });
                }
            });

            // Expense rows - one for each expense type
            let totalExpenseCurrentYear = 0;
            let totalExpenseNextYear = 0;
            let totalExpenseNextYearPlus1 = 0;
            let totalExpenseAuthorizedRemaining = 0;

            expenseTypes.forEach((expenseData, expenseTitle) => {
                totalExpenseCurrentYear += expenseData.tyExpense;
                totalExpenseNextYear += expenseData.cyExpense;
                totalExpenseNextYearPlus1 += expenseData.nyExpense;
                totalExpenseAuthorizedRemaining += expenseData.authorizedRemaining;

                html += `<tr>
                    <td><strong>${expenseTitle}</strong></td>
                    <td>$${expenseData.tyExpense.toLocaleString()}</td>
                    <td>$${expenseData.cyExpense.toLocaleString()}</td>
                    <td>$${expenseData.nyExpense.toLocaleString()}</td>
                    <td>$${expenseData.authorizedRemaining.toLocaleString()}</td>
                </tr>`;
            });

            // Expense totals row
            html += `<tr style="background-color: #e9ecef; font-weight: bold;">
                <td><strong>TOTAL EXPENSES</strong></td>
                <td><strong>$${totalExpenseCurrentYear.toLocaleString()}</strong></td>
                <td><strong>$${totalExpenseNextYear.toLocaleString()}</strong></td>
                <td><strong>$${totalExpenseNextYearPlus1.toLocaleString()}</strong></td>
                <td><strong>$${totalExpenseAuthorizedRemaining.toLocaleString()}</strong></td>
            </tr>`;

            html += '</tbody></table></div>';
            return html;
        }

        function generateCombinedAcreageOverview(city, year) {
            // Get all submissions for this city and year
            const cityYearSubmissions = allSubmissions.filter(submission => {
                const submissionCity = submission.cityCounty || submission.submitterName;
                const submissionYear = submission.year || submission.fy;
                return submissionCity === city && parseInt(submissionYear) === parseInt(year);
            });

            if (cityYearSubmissions.length === 0) {
                return '<div class="table-container"><p>No data available for this city and year.</p></div>';
            }

            let html = '<div class="table-container">';
            html += '<table class="table">';
            
            // Table Header
            html += '<thead><tr>';
            html += '<th>Project Area</th>';
            html += '<th>Developed</th>';
            html += '<th>Undeveloped</th>';
            html += '<th>Residential</th>';
            html += '<th>% Residential</th>';
            html += '<th># of Authorized Housing Units</th>';
            html += '</tr></thead>';
            html += '<tbody>';

            // Data rows - one for each project area
            let totalDeveloped = 0;
            let totalUndeveloped = 0;
            let totalResidential = 0;
            let totalHousingUnits = 0;

            cityYearSubmissions.forEach(submission => {
                const projectArea = submission.projectArea || submission.projectAreaName || 'N/A';
                const developed = parseFloat(submission.developedAcreage) || 0;
                const undeveloped = parseFloat(submission.undevelopedAcreage) || 0;
                const residential = parseFloat(submission.residentialAcreage) || 0;
                const percentResidential = parseFloat(submission.percentResidential) || 0;
                const housingUnits = parseFloat(submission.totalAuthorizedHousingUnits) || 0;

                totalDeveloped += developed;
                totalUndeveloped += undeveloped;
                totalResidential += residential;
                totalHousingUnits += housingUnits;

                html += `<tr>
                    <td><strong>${projectArea}</strong></td>
                    <td>${developed.toLocaleString()} acres</td>
                    <td>${undeveloped.toLocaleString()} acres</td>
                    <td>${residential.toLocaleString()} acres</td>
                    <td>${percentResidential.toFixed(1)}%</td>
                    <td>${housingUnits.toLocaleString()}</td>
                </tr>`;
            });

            // Totals row
            html += `<tr style="background-color: #e9ecef; font-weight: bold;">
                <td><strong>TOTAL</strong></td>
                <td><strong>${totalDeveloped.toLocaleString()} acres</strong></td>
                <td><strong>${totalUndeveloped.toLocaleString()} acres</strong></td>
                <td><strong>${totalResidential.toLocaleString()} acres</strong></td>
                <td><strong>${totalResidential > 0 ? ((totalResidential / (totalDeveloped + totalUndeveloped)) * 100).toFixed(1) : 0}%</strong></td>
                <td><strong>${totalHousingUnits.toLocaleString()}</strong></td>
            </tr>`;

            html += '</tbody></table></div>';
            return html;
        }

        function addExpenseRow() {
            const expenseContainer = document.getElementById('expense-container');
            const expenseIndex = expenseContainer.children.length;
            
            const expenseRow = document.createElement('div');
            expenseRow.className = 'expense-row';
            expenseRow.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 12px; align-items: end; margin-bottom: 12px; padding: 16px; background: var(--bg-secondary); border-radius: var(--border-radius); border: 1px solid var(--border-gray);';
            
            const selectedYear = document.getElementById('external-year-select').value || new Date().getFullYear();
            
            expenseRow.innerHTML = `
                <div class="form-row">
                    <label>Expense Title:</label>
                    <input type="text" name="expenseTitle_${expenseIndex}" required>
                </div>
                <div class="form-row">
                    <label id="fy-label-${expenseIndex}">FY (${selectedYear}) Expense:</label>
                    <input type="number" name="tyExpense_${expenseIndex}" step="0.01" required onchange="calculateExpenseTotal(${expenseIndex})">
                </div>
                <div class="form-row">
                    <label id="cy-label-${expenseIndex}">${parseInt(selectedYear) + 1} Expense:</label>
                    <input type="number" name="cyExpense_${expenseIndex}" step="0.01" required onchange="calculateExpenseTotal(${expenseIndex})">
                </div>
                <div class="form-row">
                    <label id="ny-label-${expenseIndex}">${parseInt(selectedYear) + 2} Expense:</label>
                    <input type="number" name="nyExpense_${expenseIndex}" step="0.01" required onchange="calculateExpenseTotal(${expenseIndex})">
                </div>
                <button type="button" class="btn btn-secondary" onclick="removeExpenseRow(this)" style="padding: 6px 12px; font-size: 12px;">Remove</button>
            `;
            
            expenseContainer.appendChild(expenseRow);
            updateTotalExpenses();
        }

        function removeExpenseRow(button) {
            button.closest('.expense-row').remove();
            updateTotalExpenses();
        }

        function addGoverningBoardRow() {
            const container = document.getElementById('governing-board-container');
            const index = container.children.length;
            
            const row = document.createElement('div');
            row.className = 'governing-board-row';
            row.style.cssText = 'display: flex; gap: 16px; margin-bottom: 16px; align-items: end;';
            
            row.innerHTML = `
                <div class="form-row" style="flex: 1;">
                    <label>Name:</label>
                    <input type="text" name="governingBoardName_${index}" placeholder="Board Member Name">
                </div>
                <div class="form-row" style="flex: 1;">
                    <label>Title:</label>
                    <input type="text" name="governingBoardTitle_${index}" placeholder="Board Member Title">
                </div>
                <button type="button" class="btn btn-secondary" onclick="removeGoverningBoardRow(this)" style="padding: 6px 12px; font-size: 12px; margin-bottom: 0;">Remove</button>
            `;
            
            container.appendChild(row);
        }

        function removeGoverningBoardRow(button) {
            const container = document.getElementById('governing-board-container');
            if (container.children.length > 1) {
                button.parentElement.remove();
            }
        }

        function addAgencyStaffRow() {
            const container = document.getElementById('agency-staff-container');
            const index = container.children.length;
            
            const row = document.createElement('div');
            row.className = 'agency-staff-row';
            row.style.cssText = 'display: flex; gap: 16px; margin-bottom: 16px; align-items: end;';
            
            row.innerHTML = `
                <div class="form-row" style="flex: 1;">
                    <label>Name:</label>
                    <input type="text" name="agencyStaffName_${index}" placeholder="Staff Member Name">
                </div>
                <div class="form-row" style="flex: 1;">
                    <label>Title:</label>
                    <input type="text" name="agencyStaffTitle_${index}" placeholder="Staff Member Title">
                </div>
                <button type="button" class="btn btn-secondary" onclick="removeAgencyStaffRow(this)" style="padding: 6px 12px; font-size: 12px; margin-bottom: 0;">Remove</button>
            `;
            
            container.appendChild(row);
        }

        function removeAgencyStaffRow(button) {
            const container = document.getElementById('agency-staff-container');
            if (container.children.length > 1) {
                button.parentElement.remove();
            }
        }

        function addIncrementDistributionRow() {
            const container = document.getElementById('increment-distribution-container');
            const index = container.children.length;
            
            const row = document.createElement('div');
            row.className = 'increment-distribution-row';
            row.style.cssText = 'display: flex; gap: 16px; margin-bottom: 16px; align-items: end;';
            
            row.innerHTML = `
                <div class="form-row" style="flex: 1;">
                    <label>Entity Description:</label>
                    <input type="text" name="incrementEntity_${index}" placeholder="Taxing Entity Name">
                </div>
                <div class="form-row" style="flex: 1;">
                    <label>Actual Received:</label>
                    <input type="number" name="incrementActual_${index}" step="0.01" placeholder="0.00">
                </div>
                <div class="form-row" style="flex: 1;">
                    <label>Amount Remaining Authorized:</label>
                    <input type="number" name="incrementRemaining_${index}" step="0.01" placeholder="0.00">
                </div>
                <button type="button" class="btn btn-secondary" onclick="removeIncrementDistributionRow(this)" style="padding: 6px 12px; font-size: 12px; margin-bottom: 0;">Remove</button>
            `;
            
            container.appendChild(row);
        }

        function removeIncrementDistributionRow(button) {
            const container = document.getElementById('increment-distribution-container');
            if (container.children.length > 1) {
                button.parentElement.remove();
            }
        }

        function addSourcesOfFundsRow() {
            const tbody = document.getElementById('sources-of-funds-tbody');
            const index = tbody.children.length;
            
            const row = document.createElement('tr');
            row.className = 'sources-of-funds-row';
            
            row.innerHTML = `
                <td><input type="text" name="revenueSourceDescription_${index}" placeholder="Enter revenue source description" style="width: 100%; border: none; background: transparent; padding: 8px;"></td>
                <td><input type="number" name="revenueSource2025Actual_${index}" placeholder="0" step="0.01" style="width: 100%; border: none; background: transparent; padding: 8px; text-align: right;"></td>
                <td><input type="number" name="revenueSource2026Forecast_${index}" placeholder="0" step="0.01" style="width: 100%; border: none; background: transparent; padding: 8px; text-align: right;"></td>
                <td><input type="number" name="revenueSource2027Forecast_${index}" placeholder="0" step="0.01" style="width: 100%; border: none; background: transparent; padding: 8px; text-align: right;"></td>
                <td><button type="button" class="btn btn-danger btn-sm" onclick="removeSourcesOfFundsRow(this)" style="padding: 4px 8px; font-size: 12px;">Remove</button></td>
            `;
            
            tbody.appendChild(row);
        }

        function removeSourcesOfFundsRow(button) {
            const tbody = document.getElementById('sources-of-funds-tbody');
            if (tbody.children.length > 1) {
                button.closest('tr').remove();
            }
        }

        function autoFillGoverningBoardAndStaff() {
            const currentYear = document.getElementById('internal-year-select').value;
            const currentClient = document.getElementById('internal-city-dropdown').value;
            
            if (!currentYear || !currentClient) return;
            
            const previousYear = parseInt(currentYear) - 1;
            
            // Find previous year data for this client
            const previousYearData = allSubmissions.filter(submission => {
                const submissionClient = submission.cityCounty || submission.submitterName;
                const submissionYear = submission.year || submission.fy;
                return submissionClient === currentClient && parseInt(submissionYear) === previousYear;
            });
            
            if (previousYearData.length === 0) return;
            
            // Get the most recent submission from previous year
            const latestSubmission = previousYearData[previousYearData.length - 1];
            
            // Auto-fill Governing Board data
            const governingBoardData = [];
            for (let i = 0; i < 10; i++) { // Check up to 10 board members
                const name = latestSubmission[`governingBoardName_${i}`];
                const title = latestSubmission[`governingBoardTitle_${i}`];
                if (name || title) {
                    governingBoardData.push({ name, title });
                }
            }
            
            // Auto-fill Agency Staff data
            const agencyStaffData = [];
            for (let i = 0; i < 10; i++) { // Check up to 10 staff members
                const name = latestSubmission[`agencyStaffName_${i}`];
                const title = latestSubmission[`agencyStaffTitle_${i}`];
                if (name || title) {
                    agencyStaffData.push({ name, title });
                }
            }
            
            // Show prompts if data exists
            if (governingBoardData.length > 0) {
                const confirmed = confirm(`Found ${governingBoardData.length} Governing Board member(s) from ${previousYear}. Has this data changed in the past year? Click OK to keep the data, Cancel to clear.`);
                if (confirmed) {
                    populateGoverningBoardData(governingBoardData);
                }
            }
            
            if (agencyStaffData.length > 0) {
                const confirmed = confirm(`Found ${agencyStaffData.length} Agency Staff member(s) from ${previousYear}. Has this data changed in the past year? Click OK to keep the data, Cancel to clear.`);
                if (confirmed) {
                    populateAgencyStaffData(agencyStaffData);
                }
            }
        }

        function populateGoverningBoardData(data) {
            const container = document.getElementById('governing-board-container');
            container.innerHTML = '';
            
            data.forEach((member, index) => {
                const row = document.createElement('div');
                row.className = 'governing-board-row';
                row.style.cssText = 'display: flex; gap: 16px; margin-bottom: 16px; align-items: end;';
                
                row.innerHTML = `
                    <div class="form-row" style="flex: 1;">
                        <label>Name:</label>
                        <input type="text" name="governingBoardName_${index}" value="${member.name || ''}" placeholder="Board Member Name">
                    </div>
                    <div class="form-row" style="flex: 1;">
                        <label>Title:</label>
                        <input type="text" name="governingBoardTitle_${index}" value="${member.title || ''}" placeholder="Board Member Title">
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="removeGoverningBoardRow(this)" style="padding: 6px 12px; font-size: 12px; margin-bottom: 0;">Remove</button>
                `;
                
                container.appendChild(row);
            });
        }

        function populateAgencyStaffData(data) {
            const container = document.getElementById('agency-staff-container');
            container.innerHTML = '';
            
            data.forEach((member, index) => {
                const row = document.createElement('div');
                row.className = 'agency-staff-row';
                row.style.cssText = 'display: flex; gap: 16px; margin-bottom: 16px; align-items: end;';
                
                row.innerHTML = `
                    <div class="form-row" style="flex: 1;">
                        <label>Name:</label>
                        <input type="text" name="agencyStaffName_${index}" value="${member.name || ''}" placeholder="Staff Member Name">
                    </div>
                    <div class="form-row" style="flex: 1;">
                        <label>Title:</label>
                        <input type="text" name="agencyStaffTitle_${index}" value="${member.title || ''}" placeholder="Staff Member Title">
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="removeAgencyStaffRow(this)" style="padding: 6px 12px; font-size: 12px; margin-bottom: 0;">Remove</button>
                `;
                
                container.appendChild(row);
            });
        }

        function calculateExpenseTotal(index) {
            const tyExpense = parseFloat(document.querySelector(`input[name="tyExpense_${index}"]`)?.value) || 0;
            const cyExpense = parseFloat(document.querySelector(`input[name="cyExpense_${index}"]`)?.value) || 0;
            const nyExpense = parseFloat(document.querySelector(`input[name="nyExpense_${index}"]`)?.value) || 0;
            
            // Update the main total field
            updateTotalExpenses();
        }

        function updateExpenseLabels() {
            const selectedYear = document.getElementById('external-year-select')?.value || document.getElementById('internal-year-select')?.value;
            if (!selectedYear) return;
            
            const expenseRows = document.querySelectorAll('.expense-row');
            expenseRows.forEach((row, index) => {
                const fyLabel = row.querySelector(`#fy-label-${index}`);
                if (fyLabel) {
                    fyLabel.textContent = `FY (${selectedYear}) Expense:`;
                }
            });
            
            // Update other FY labels
            const fyActualSpentLabel = document.getElementById('fy-actual-spent-label');
            const fyActualSpentHeader = document.getElementById('fy-actual-spent-header');
            const fyOriginalBudgetLabel = document.getElementById('fy-original-budget-label');
            const fyLifetimeRevenuesLabel = document.getElementById('fy-lifetime-revenues-label');
            const fyActualRevenueLabel = document.getElementById('fy-actual-revenue-label');
            const fyBaseYearRevenueLabel = document.getElementById('fy-base-year-revenue-label');
            const fyValueLabel = document.getElementById('fy-value-label');
            
            if (fyActualSpentLabel) {
                fyActualSpentLabel.textContent = `FY (${selectedYear}) ACTUAL SPENT TOTAL:`;
            }
            if (fyActualSpentHeader) {
                fyActualSpentHeader.textContent = `FY (${selectedYear}) ACTUAL SPENT TOTAL`;
            }
            if (fyOriginalBudgetLabel) {
                fyOriginalBudgetLabel.textContent = `FY (${selectedYear}) ORIGINAL BUDGET REVENUES:`;
            }

            if (fyActualRevenueLabel) {
                fyActualRevenueLabel.textContent = `FY (${selectedYear}) ACTUAL REVENUE:`;
            }
            if (fyBaseYearRevenueLabel) {
                fyBaseYearRevenueLabel.textContent = `FY (${selectedYear}) BASE YEAR REVENUE:`;
            }
            if (fyValueLabel) {
                fyValueLabel.textContent = `FY (${selectedYear}) VALUE:`;
            }
        }

        function populateClientDropdown() {
            const clientDropdown = document.getElementById('internal-city-dropdown');
            if (!clientDropdown) return;
            
            // Get unique clients from external submissions
            const clients = new Set();
            allSubmissions.forEach(submission => {
                const clientName = submission.submitterName || submission.cityCounty;
                if (clientName) {
                    clients.add(clientName);
                }
            });
            
            // Clear existing options except the first one
            clientDropdown.innerHTML = '<option value="">Select Client</option>';
            
            // Add client options
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client;
                option.textContent = client;
                clientDropdown.appendChild(option);
            });
        }

        function populateProjectDropdown() {
            const clientDropdown = document.getElementById('internal-city-dropdown');
            const projectDropdown = document.getElementById('internal-project-dropdown');
            if (!clientDropdown || !projectDropdown) return;
            
            const selectedClient = clientDropdown.value;
            if (!selectedClient) {
                projectDropdown.innerHTML = '<option value="">Select Project Area</option>';
                return;
            }
            
            // Get project areas for the selected client
            const projectAreas = new Set();
            allSubmissions.forEach(submission => {
                const clientName = submission.submitterName || submission.cityCounty;
                const projectArea = submission.projectAreaName || submission.projectArea;
                if (clientName === selectedClient && projectArea) {
                    projectAreas.add(projectArea);
                }
            });
            
            // Clear existing options except the first one
            projectDropdown.innerHTML = '<option value="">Select Project Area</option>';
            
            // Add project area options
            projectAreas.forEach(projectArea => {
                const option = document.createElement('option');
                option.value = projectArea;
                option.textContent = projectArea;
                projectDropdown.appendChild(option);
            });
            
            // Auto-fill Governing Board and Agency Staff data
            setTimeout(() => {
                autoFillGoverningBoardAndStaff();
            }, 100);
        }

        function updateInternalYearLabels() {
            const selectedYear = document.getElementById('internal-year-select').value;
            if (!selectedYear) return;
            
            const fiscalYear = selectedYear;
            const taxYear = parseInt(selectedYear) - 1;
            
            // Update the labels
            const fyLabel = document.getElementById('fy-label');
            const tyLabel = document.getElementById('ty-label');
            
            if (fyLabel) {
                fyLabel.textContent = `Fiscal Year (${fiscalYear}):`;
            }
            if (tyLabel) {
                tyLabel.textContent = `Tax Year (${taxYear}):`;
            }
            
            // Auto-fill the input fields
            const fyInput = document.querySelector('input[name="fy"]');
            const tyInput = document.querySelector('input[name="ty"]');
            
            if (fyInput) {
                fyInput.value = fiscalYear;
            }
            if (tyInput) {
                tyInput.value = taxYear;
            }
        }

        function addTotalExpenseRow() {
            const tbody = document.getElementById('total-expenses-tbody');
            const rowIndex = tbody.children.length;
            
            const row = document.createElement('tr');
            row.className = 'total-expense-row';
            row.innerHTML = `
                <td>
                    <input type="text" name="totalExpenseDescription_${rowIndex}" placeholder="Enter expense description" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;">
                </td>
                <td>
                    <input type="number" name="totalExpenseAmount_${rowIndex}" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTotalUsesOfFunds()">
                </td>
                <td>
                    <input type="number" name="totalExpenseNpv_${rowIndex}" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTotalUsesOfFunds()">
                </td>
                <td style="width: 60px;">
                    <button type="button" class="btn btn-secondary" onclick="removeTotalExpenseRow(this)" style="padding: 4px 8px; font-size: 11px;">Remove</button>
                </td>
            `;
            
            tbody.appendChild(row);
            updateTotalUsesOfFunds();
        }

        function removeTotalExpenseRow(button) {
            button.closest('tr').remove();
            updateTotalUsesOfFunds();
        }

        function updateTotalUsesOfFunds() {
            const totalInput = document.querySelector('input[name="totalUsesOfFunds"]');
            const expenseRows = document.querySelectorAll('.total-expense-row');
            let total = 0;
            
            expenseRows.forEach(row => {
                const amount = parseFloat(row.querySelector('input[name*="totalExpenseAmount_"]')?.value) || 0;
                total += amount;
            });
            
            if (totalInput) {
                totalInput.value = total.toFixed(2);
            }
        }

        function addTotalExpenseNpvRow() {
            const tbody = document.getElementById('total-expenses-npv-tbody');
            const rowIndex = tbody.children.length;
            
            const row = document.createElement('tr');
            row.className = 'total-expense-npv-row';
            row.innerHTML = `
                <td>
                    <input type="text" name="totalExpenseNpvDescription_${rowIndex}" placeholder="Enter expense description" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;">
                </td>
                <td>
                    <input type="number" name="totalExpenseNpvAmount_${rowIndex}" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTotalUsesOfFundsNpv()">
                </td>
                <td style="width: 60px;">
                    <button type="button" class="btn btn-secondary" onclick="removeTotalExpenseNpvRow(this)" style="padding: 4px 8px; font-size: 11px;">Remove</button>
                </td>
            `;
            
            tbody.appendChild(row);
            updateTotalUsesOfFundsNpv();
        }

        function removeTotalExpenseNpvRow(button) {
            button.closest('tr').remove();
            updateTotalUsesOfFundsNpv();
        }

        function updateTotalUsesOfFundsNpv() {
            const totalInput = document.querySelector('input[name="totalUsesOfFundsNpv"]');
            const expenseRows = document.querySelectorAll('.total-expense-npv-row');
            let total = 0;
            
            expenseRows.forEach(row => {
                const amount = parseFloat(row.querySelector('input[name*="totalExpenseNpvAmount_"]')?.value) || 0;
                total += amount;
            });
            
            if (totalInput) {
                totalInput.value = total.toFixed(2);
            }
        }

        function addTaxEntityRow() {
            const tbody = document.getElementById('tax-entities-tbody');
            const rowIndex = tbody.children.length;
            
            const row = document.createElement('tr');
            row.className = 'tax-entity-row';
            row.innerHTML = `
                <td>
                    <input type="text" name="taxEntityName_${rowIndex}" placeholder="Enter tax entity name" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;">
                </td>
                <td>
                    <input type="number" name="taxEntityParticipationRate_${rowIndex}" step="0.01" min="0" max="100" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTaxEntitiesTotal()">
                </td>
                <td>
                    <input type="number" name="taxEntityRemittance_${rowIndex}" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTaxEntitiesTotal()">
                </td>
                <td>
                    <input type="number" name="taxEntityCapAmount_${rowIndex}" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTaxEntitiesTotal()">
                </td>
                <td>
                    <input type="number" name="taxEntityIncrementPaid_${rowIndex}" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTaxEntitiesTotal()">
                </td>
                <td>
                    <input type="number" name="taxEntityRemainingAuthorized_${rowIndex}" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px;" onchange="updateTaxEntitiesTotal()">
                </td>
                <td style="width: 60px;">
                    <button type="button" class="btn btn-secondary" onclick="removeTaxEntityRow(this)" style="padding: 4px 8px; font-size: 11px;">Remove</button>
                </td>
            `;
            
            tbody.appendChild(row);
            updateTaxEntitiesTotal();
        }

        function removeTaxEntityRow(button) {
            button.closest('tr').remove();
            updateTaxEntitiesTotal();
        }

        function updateTaxEntitiesTotal() {
            const taxEntityRows = document.querySelectorAll('.tax-entity-row');
            let totalParticipationRate = 0;
            let totalRemittance = 0;
            let totalCapAmount = 0;
            let totalIncrementPaid = 0;
            let totalRemainingAuthorized = 0;
            
            taxEntityRows.forEach(row => {
                const participationRate = parseFloat(row.querySelector('input[name*="taxEntityParticipationRate_"]')?.value) || 0;
                const remittance = parseFloat(row.querySelector('input[name*="taxEntityRemittance_"]')?.value) || 0;
                const capAmount = parseFloat(row.querySelector('input[name*="taxEntityCapAmount_"]')?.value) || 0;
                const incrementPaid = parseFloat(row.querySelector('input[name*="taxEntityIncrementPaid_"]')?.value) || 0;
                const remainingAuthorized = parseFloat(row.querySelector('input[name*="taxEntityRemainingAuthorized_"]')?.value) || 0;
                
                totalParticipationRate += participationRate;
                totalRemittance += remittance;
                totalCapAmount += capAmount;
                totalIncrementPaid += incrementPaid;
                totalRemainingAuthorized += remainingAuthorized;
            });
            
            // Update the totals fields in real-time
            const totalRemittanceInput = document.querySelector('input[name="totalRemittance"]');
            const totalCapInput = document.querySelector('input[name="totalCap"]');
            const totalActualReceivedInput = document.querySelector('input[name="totalActualReceived"]');
            const totalRemainingAuthorizedInput = document.querySelector('input[name="totalRemainingAuthorized"]');
            
            if (totalRemittanceInput) {
                totalRemittanceInput.value = totalRemittance.toFixed(2);
            }
            if (totalCapInput) {
                totalCapInput.value = totalCapAmount.toFixed(2);
            }
            if (totalActualReceivedInput) {
                totalActualReceivedInput.value = totalIncrementPaid.toFixed(2);
            }
            if (totalRemainingAuthorizedInput) {
                totalRemainingAuthorizedInput.value = totalRemainingAuthorized.toFixed(2);
            }
            
            // Console logging for debugging
            console.log('Total Participation Rate:', totalParticipationRate);
            console.log('Total Remittance:', totalRemittance);
            console.log('Total Cap Amount:', totalCapAmount);
            console.log('Total Increment Paid:', totalIncrementPaid);
            console.log('Total Remaining Authorized:', totalRemainingAuthorized);
        }

        function updateTotalExpenses() {
            const totalInput = document.querySelector('input[name="tyActualSpentTotal"]');
            const expenseRows = document.querySelectorAll('.expense-row');
            let total = 0;
            
            expenseRows.forEach(row => {
                const tyExpense = parseFloat(row.querySelector('input[name*="tyExpense_"]')?.value) || 0;
                
                            // Only sum the FY (Fiscal Year) expenses
            total += tyExpense;
            });
            
            if (totalInput) {
                totalInput.value = total.toFixed(2);
            }
        }

        function calculatePercentResidential() {
            const residentialAcreage = parseFloat(document.querySelector('input[name="residentialAcreage"]')?.value) || 0;
            const totalAcreage = parseFloat(document.querySelector('input[name="acreage"]')?.value) || 0;
            const percentResidentialInput = document.querySelector('input[name="percentResidential"]');
            
            if (percentResidentialInput && totalAcreage > 0) {
                const percentResidential = (residentialAcreage / totalAcreage) * 100;
                percentResidentialInput.value = percentResidential.toFixed(2);
            } else if (percentResidentialInput) {
                percentResidentialInput.value = '0.00';
            }
        }

        function calculateRemainingLife() {
            const expirationYearInput = document.querySelector('input[name="expirationYear"]');
            const remainingLifeInput = document.querySelector('input[name="remainingLife"]');
            
            if (expirationYearInput && remainingLifeInput) {
                const expirationYear = parseInt(expirationYearInput.value) || 0;
                const currentYear = 2025; // Current year
                
                if (expirationYear > 0) {
                    const remainingLife = expirationYear - currentYear;
                    remainingLifeInput.value = remainingLife;
                } else {
                    remainingLifeInput.value = '';
                }
            }
        }

        function calculateAdminPercentage() {
            const adminExpenseInput = document.querySelector('input[name="administrativeExpense"]');
            const totalExpensesInput = document.querySelector('input[name="tyActualSpentTotal"]');
            const adminPercentageInput = document.querySelector('input[name="administrativePercentage"]');
            
            if (adminExpenseInput && totalExpensesInput && adminPercentageInput) {
                const adminExpense = parseFloat(adminExpenseInput.value) || 0;
                const totalExpenses = parseFloat(totalExpensesInput.value) || 0;
                
                if (totalExpenses > 0) {
                    const adminPercentage = (adminExpense / totalExpenses) * 100;
                    adminPercentageInput.value = adminPercentage.toFixed(2);
                } else {
                    adminPercentageInput.value = '0.00';
                }
            }
        }

        function updateYearHeaders() {
            const selectedYear = document.getElementById('internal-year-select')?.value;
            const actualRevenueHeader = document.getElementById('actual-revenue-header');
            
            if (selectedYear && actualRevenueHeader) {
                actualRevenueHeader.textContent = `(${selectedYear}) Increment Paid`;
            }
            
            // Also update external request labels
            updateExpenseLabels();
        }

        function getCombinedRevenueTotal(submissions, period) {
            let total = 0;
            submissions.forEach(submission => {
                const fyIncrement = parseFloat(submission.fyIncrement) || 0;
                const authorizedRemaining = parseFloat(submission.remainingAuthorized) || 0;
                
                switch(period) {
                    case 'current':
                    case 'next':
                    case 'nextPlus1':
                        total += fyIncrement;
                        break;
                    case 'authorized':
                        total += authorizedRemaining;
                        break;
                }
            });
            return total;
        }

        function getCombinedExpensesTotal(submissions, period) {
            let total = 0;
            const expenseTypes = new Map();
            
            // Collect all expenses by type
            submissions.forEach(submission => {
                if (submission.expenses && submission.expenses.length > 0) {
                    submission.expenses.forEach(expense => {
                        const expenseTitle = expense.title || 'Unnamed Expense';
                        if (!expenseTypes.has(expenseTitle)) {
                            expenseTypes.set(expenseTitle, {
                                tyExpense: 0,
                                cyExpense: 0,
                                nyExpense: 0,
                                authorizedRemaining: 0
                            });
                        }
                        
                        const expenseData = expenseTypes.get(expenseTitle);
                        expenseData.tyExpense += parseFloat(expense.tyExpense) || 0;
                        expenseData.cyExpense += parseFloat(expense.cyExpense) || 0;
                        expenseData.nyExpense += parseFloat(expense.nyExpense) || 0;
                    });
                }
            });
            
            // Sum up totals based on period
            expenseTypes.forEach(expenseData => {
                switch(period) {
                    case 'current':
                        total += expenseData.tyExpense;
                        break;
                    case 'next':
                        total += expenseData.cyExpense;
                        break;
                    case 'nextPlus1':
                        total += expenseData.nyExpense;
                        break;
                    case 'authorized':
                        total += expenseData.authorizedRemaining;
                        break;
                }
            });
            
            return total;
        }

        function getCombinedAcreageTotal(submissions, type) {
            let total = 0;
            let totalDeveloped = 0;
            let totalUndeveloped = 0;
            let totalResidential = 0;

            submissions.forEach(submission => {
                const developed = parseFloat(submission.developedAcreage) || 0;
                const undeveloped = parseFloat(submission.undevelopedAcreage) || 0;
                const residential = parseFloat(submission.residentialAcreage) || 0;
                const housingUnits = parseFloat(submission.totalAuthorizedHousingUnits) || 0;

                totalDeveloped += developed;
                totalUndeveloped += undeveloped;
                totalResidential += residential;

                switch(type) {
                    case 'developed':
                        total += developed;
                        break;
                    case 'undeveloped':
                        total += undeveloped;
                        break;
                    case 'residential':
                        total += residential;
                        break;
                    case 'housingUnits':
                        total += housingUnits;
                        break;
                    case 'percentResidential':
                        // This will be calculated after the loop
                        break;
                }
            });

            if (type === 'percentResidential') {
                const totalAcreage = totalDeveloped + totalUndeveloped;
                return totalAcreage > 0 ? ((totalResidential / totalAcreage) * 100).toFixed(1) + '%' : '0%';
            }

            return total;
        }

        // PDF Upload Functions
        let uploadedPDFs = [];

        function handlePDFUpload(event) {
            const files = Array.from(event.target.files);
            handlePDFFiles(files);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            const zone = document.getElementById('pdf-upload-zone');
            zone.style.borderColor = '#0056b3';
            zone.style.background = 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)';
            zone.style.transform = 'scale(1.02)';
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            const zone = document.getElementById('pdf-upload-zone');
            zone.style.borderColor = '#007bff';
            zone.style.background = 'linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%)';
            zone.style.transform = 'scale(1)';
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            const zone = document.getElementById('pdf-upload-zone');
            zone.style.borderColor = '#007bff';
            zone.style.background = 'linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%)';
            zone.style.transform = 'scale(1)';
            
            const files = Array.from(e.dataTransfer.files);
            handlePDFFiles(files);
        }

        function handlePDFFiles(files) {
            const pdfFiles = files.filter(file => file.type === 'application/pdf');
            
            if (pdfFiles.length !== files.length) {
                alert('Only PDF files are allowed. Please select only PDF files.');
                return;
            }
            
            pdfFiles.forEach(file => {
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    alert(`File "${file.name}" is too large. Please keep files under 5MB.`);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64 = e.target.result;
                    uploadedPDFs.push({
                        name: file.name,
                        data: base64,
                        size: file.size
                    });
                    updateUploadedMapsList();
                };
                reader.readAsDataURL(file);
            });
        }

        function updateUploadedMapsList() {
            const listContainer = document.getElementById('uploaded-maps-list');
            if (!listContainer) return;
            
            if (uploadedPDFs.length === 0) {
                listContainer.innerHTML = '';
                return;
            }
            
            let html = '<div style="margin-top: 16px;">';
            html += '<h5 style="margin: 0 0 12px 0; color: #333; font-weight: 600; display: flex; align-items: center; gap: 8px;">';
            html += '<span>üìÑ</span><span>Uploaded Maps (' + uploadedPDFs.length + ')</span></h5>';
            html += '<div style="display: grid; gap: 8px;">';
            
            uploadedPDFs.forEach((pdf, index) => {
                html += `<div style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    background: #f8f9fa;
                    border: 1px solid #e9ecef;
                    border-radius: 8px;
                    padding: 12px 16px;
                    transition: all 0.2s ease;
                " onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                    <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                        <div style="
                            width: 40px;
                            height: 40px;
                            background: #dc3545;
                            border-radius: 8px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 18px;
                            font-weight: bold;
                        ">PDF</div>
                        <div>
                            <div style="font-weight: 500; color: #333; margin-bottom: 2px;">${pdf.name}</div>
                            <div style="font-size: 12px; color: #666;">${(pdf.size / 1024).toFixed(1)} KB</div>
                        </div>
                    </div>
                    <button type="button" onclick="removePDF(${index})" style="
                        background: #dc3545;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        padding: 6px 12px;
                        font-size: 12px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        display: flex;
                        align-items: center;
                        gap: 4px;
                    " onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                        <span>üóëÔ∏è</span>
                        <span>Remove</span>
                    </button>
                </div>`;
            });
            
            html += '</div></div>';
            listContainer.innerHTML = html;
        }

        function removePDF(index) {
            uploadedPDFs.splice(index, 1);
            updateUploadedMapsList();
        }

        function downloadPDF(filename, base64Data) {
            try {
                // Convert base64 to blob
                const byteCharacters = atob(base64Data.split(',')[1]);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'application/pdf' });
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error downloading PDF:', error);
                alert('Error downloading PDF file.');
            }
        }

        function downloadExcelForClient(clientName) {
            // Get ALL submissions for the client (not just complete ones)
            const clientSubmissions = allSubmissions.filter(submission => {
                const submissionClient = submission.submitterName || submission.cityCounty;
                return submissionClient === clientName;
            });
            
            // Group by project area and year to ensure we get all years
            const groupedSubmissions = {};
            clientSubmissions.forEach(submission => {
                const projectArea = submission.projectArea || submission.projectAreaName || 'N/A';
                const year = submission.year || submission.fy || 'N/A';
                const key = `${projectArea}-${year}`;
                
                if (!groupedSubmissions[key]) {
                    groupedSubmissions[key] = submission;
                } else {
                    // Merge data if we have both external and internal data for same project/year
                    Object.assign(groupedSubmissions[key], submission);
                }
            });
            
            const finalSubmissions = Object.values(groupedSubmissions);
            
            if (finalSubmissions.length === 0) {
                showNotification(`No submissions found for ${clientName}.`);
                return;
            }
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Prepare data for Excel - Include ALL possible fields with blank values
            const excelData = finalSubmissions.map(submission => {
                return {
                    // External Request - Project Area Information
                    'Agency/Submitter Name': submission.submitterName || '',
                    'Project Area Name': submission.projectAreaName || '',
                    'Total Acreage': submission.acreage || '',
                    'Creation Year': submission.creationYear || '',
                    'Base Year': submission.baseYear || '',
                    'Term Length': submission.termLength || '',
                    'Start Year': submission.startYear || '',
                    'Expiration Year': submission.expirationYear || '',
                    'Base Value': submission.baseValue || '',
                    'FY Increment': submission.fyIncrement || '',
                    'Remaining Life': submission.remainingLife || '',
                    
                    // External Request - Assessed Value & Financial Information
                    'Description of Growth in Assessed Value': submission.descriptionGrowthAssessedValue || '',
                    'Fund Balance': submission.fundBalance || '',
                    'Planned Uses for Fund Balance': submission.plannedUsesForFundBalance || '',
                    
                    // External Request - Development Information
                    'Developed Acreage': submission.developedAcreage || '',
                    'Undeveloped Acreage': submission.undevelopedAcreage || '',
                    'Residential Acreage': submission.residentialAcreage || '',
                    '% Residential': submission.percentResidential || '',
                    'Total Authorized Housing Units': submission.totalAuthorizedHousingUnits || '',
                    'Description of Significant Development': submission.descriptionSignificantDevelopment || '',
                    'Description of How Plan Has Been Furthered': submission.descriptionPlanFurthered || '',
                    'Description of Other Issues': submission.descriptionOtherIssues || '',
                    
                    // Internal Request - Basic Information
                    'Client (Agency/Submitter)': submission.cityCounty || '',
                    'Project Area': submission.projectArea || '',
                    'Fiscal Year': submission.fy || '',
                    'Tax Year': submission.ty || '',
                    'Type': submission.type || '',
                    'Purpose': submission.purpose || '',
                    'Total Project Areas': clientSubmissions.length || '',
                    
                    // Governing Board of Trustees
                    'Governing Board Member 1': submission.governingBoardName_0 || '',
                    'Governing Board Title 1': submission.governingBoardTitle_0 || '',
                    'Governing Board Member 2': submission.governingBoardName_1 || '',
                    'Governing Board Title 2': submission.governingBoardTitle_1 || '',
                    'Governing Board Member 3': submission.governingBoardName_2 || '',
                    'Governing Board Title 3': submission.governingBoardTitle_2 || '',
                    'Governing Board Member 4': submission.governingBoardName_3 || '',
                    'Governing Board Title 4': submission.governingBoardTitle_3 || '',
                    'Governing Board Member 5': submission.governingBoardName_4 || '',
                    'Governing Board Title 5': submission.governingBoardTitle_4 || '',
                    
                    // Agency Staff
                    'Agency Staff Member 1': submission.agencyStaffName_0 || '',
                    'Agency Staff Title 1': submission.agencyStaffTitle_0 || '',
                    'Agency Staff Member 2': submission.agencyStaffName_1 || '',
                    'Agency Staff Title 2': submission.agencyStaffTitle_1 || '',
                    'Agency Staff Member 3': submission.agencyStaffName_2 || '',
                    'Agency Staff Title 3': submission.agencyStaffTitle_2 || '',
                    'Agency Staff Member 4': submission.agencyStaffName_3 || '',
                    'Agency Staff Title 4': submission.agencyStaffTitle_3 || '',
                    'Agency Staff Member 5': submission.agencyStaffName_4 || '',
                    'Agency Staff Title 5': submission.agencyStaffTitle_4 || '',
                    
                    // Combined Tax Increment Budget - Revenue
                    'Combined Revenue Current Year': getCombinedRevenueTotal(clientSubmissions, 'current'),
                    'Combined Revenue Next Year': getCombinedRevenueTotal(clientSubmissions, 'next'),
                    'Combined Revenue Next Year+1': getCombinedRevenueTotal(clientSubmissions, 'nextPlus1'),
                    'Combined Revenue Authorized Remaining': getCombinedRevenueTotal(clientSubmissions, 'authorized'),
                    
                    // Combined Tax Increment Budget - Expenses
                    'Combined Expenses Current Year': getCombinedExpensesTotal(clientSubmissions, 'current'),
                    'Combined Expenses Next Year': getCombinedExpensesTotal(clientSubmissions, 'next'),
                    'Combined Expenses Next Year+1': getCombinedExpensesTotal(clientSubmissions, 'nextPlus1'),
                    'Combined Expenses Authorized Remaining': getCombinedExpensesTotal(clientSubmissions, 'authorized'),
                    
                    // Combined Acreage Overview
                    'Combined Total Developed Acres': getCombinedAcreageTotal(clientSubmissions, 'developed'),
                    'Combined Total Undeveloped Acres': getCombinedAcreageTotal(clientSubmissions, 'undeveloped'),
                    'Combined Total Residential Acres': getCombinedAcreageTotal(clientSubmissions, 'residential'),
                    'Combined Total Housing Units': getCombinedAcreageTotal(clientSubmissions, 'housingUnits'),
                    'Combined % Residential': getCombinedAcreageTotal(clientSubmissions, 'percentResidential'),
                    
                    // Increment Distribution
                    'Increment Entity 1': submission.incrementEntity_0 || '',
                    'Increment Actual 1': submission.incrementActual_0 || '',
                    'Increment Remaining 1': submission.incrementRemaining_0 || '',
                    'Increment Entity 2': submission.incrementEntity_1 || '',
                    'Increment Actual 2': submission.incrementActual_1 || '',
                    'Increment Remaining 2': submission.incrementRemaining_1 || '',
                    'Increment Entity 3': submission.incrementEntity_2 || '',
                    'Increment Actual 3': submission.incrementActual_2 || '',
                    'Increment Remaining 3': submission.incrementRemaining_2 || '',
                    'Increment Entity 4': submission.incrementEntity_3 || '',
                    'Increment Actual 4': submission.incrementActual_3 || '',
                    'Increment Remaining 4': submission.incrementRemaining_3 || '',
                    'Increment Entity 5': submission.incrementEntity_4 || '',
                    'Increment Actual 5': submission.incrementActual_4 || '',
                    'Increment Remaining 5': submission.incrementRemaining_4 || '',
                    
                    // 2025 Sources of Funds (Internal data request)
                    'Revenue Source Description 1': submission.revenueSourceDescription_0 || '',
                    'Revenue Source 2025 Actual 1': submission.revenueSource2025Actual_0 || '',
                    'Revenue Source 2026 Forecast 1': submission.revenueSource2026Forecast_0 || '',
                    'Revenue Source 2027 Forecast 1': submission.revenueSource2027Forecast_0 || '',
                    'Revenue Source Description 2': submission.revenueSourceDescription_1 || '',
                    'Revenue Source 2025 Actual 2': submission.revenueSource2025Actual_1 || '',
                    'Revenue Source 2026 Forecast 2': submission.revenueSource2026Forecast_1 || '',
                    'Revenue Source 2027 Forecast 2': submission.revenueSource2027Forecast_1 || '',
                    'Revenue Source Description 3': submission.revenueSourceDescription_2 || '',
                    'Revenue Source 2025 Actual 3': submission.revenueSource2025Actual_2 || '',
                    'Revenue Source 2026 Forecast 3': submission.revenueSource2026Forecast_2 || '',
                    'Revenue Source 2027 Forecast 3': submission.revenueSource2027Forecast_2 || '',
                    'Revenue Source Description 4': submission.revenueSourceDescription_3 || '',
                    'Revenue Source 2025 Actual 4': submission.revenueSource2025Actual_3 || '',
                    'Revenue Source 2026 Forecast 4': submission.revenueSource2026Forecast_3 || '',
                    'Revenue Source 2027 Forecast 4': submission.revenueSource2027Forecast_3 || '',
                    'Revenue Source Description 5': submission.revenueSourceDescription_4 || '',
                    'Revenue Source 2025 Actual 5': submission.revenueSource2025Actual_4 || '',
                    'Revenue Source 2026 Forecast 5': submission.revenueSource2026Forecast_4 || '',
                    'Revenue Source 2027 Forecast 5': submission.revenueSource2027Forecast_4 || '',
                    
                    // Project Area Maps
                    'Project Area Maps': submission.projectAreaMaps ? submission.projectAreaMaps.map(map => map.name).join('; ') : '',
                    'Number of Maps': submission.projectAreaMaps ? submission.projectAreaMaps.length : 0,
                    
                    'Taxing District': submission.taxingDistrict || '',
                    'Tax Rate': submission.taxRate || '',
                    'Total Assessed Value': submission.tyValue || '',
                    'Value Increase': submission.valueIncrease || '',
                    'Description of Project Area': submission.growthInAssessedValue || '',
                    
                    // Internal Request - Tax Entities (All 10 possible entities)
                    'Tax Entity 1': submission.taxEntityName_0 || '',
                    'Participation Rate 1': submission.taxEntityParticipationRate_0 || '',
                    'Remittance 1': submission.taxEntityRemittance_0 || '',
                    'Cap Amount 1': submission.taxEntityCapAmount_0 || '',
                    'Increment Paid 1': submission.taxEntityIncrementPaid_0 || '',
                    'Remaining Authorized 1': submission.taxEntityRemainingAuthorized_0 || '',
                    'Tax Entity 2': submission.taxEntityName_1 || '',
                    'Participation Rate 2': submission.taxEntityParticipationRate_1 || '',
                    'Remittance 2': submission.taxEntityRemittance_1 || '',
                    'Cap Amount 2': submission.taxEntityCapAmount_1 || '',
                    'Increment Paid 2': submission.taxEntityIncrementPaid_1 || '',
                    'Remaining Authorized 2': submission.taxEntityRemainingAuthorized_1 || '',
                    'Tax Entity 3': submission.taxEntityName_2 || '',
                    'Participation Rate 3': submission.taxEntityParticipationRate_2 || '',
                    'Remittance 3': submission.taxEntityRemittance_2 || '',
                    'Cap Amount 3': submission.taxEntityCapAmount_2 || '',
                    'Increment Paid 3': submission.taxEntityIncrementPaid_2 || '',
                    'Remaining Authorized 3': submission.taxEntityRemainingAuthorized_2 || '',
                    'Tax Entity 4': submission.taxEntityName_3 || '',
                    'Participation Rate 4': submission.taxEntityParticipationRate_3 || '',
                    'Remittance 4': submission.taxEntityRemittance_3 || '',
                    'Cap Amount 4': submission.taxEntityCapAmount_3 || '',
                    'Increment Paid 4': submission.taxEntityIncrementPaid_3 || '',
                    'Remaining Authorized 4': submission.taxEntityRemainingAuthorized_3 || '',
                    'Tax Entity 5': submission.taxEntityName_4 || '',
                    'Participation Rate 5': submission.taxEntityParticipationRate_4 || '',
                    'Remittance 5': submission.taxEntityRemittance_4 || '',
                    'Cap Amount 5': submission.taxEntityCapAmount_4 || '',
                    'Increment Paid 5': submission.taxEntityIncrementPaid_4 || '',
                    'Remaining Authorized 5': submission.taxEntityRemainingAuthorized_4 || '',
                    'Tax Entity 6': submission.taxEntityName_5 || '',
                    'Participation Rate 6': submission.taxEntityParticipationRate_5 || '',
                    'Remittance 6': submission.taxEntityRemittance_5 || '',
                    'Cap Amount 6': submission.taxEntityCapAmount_5 || '',
                    'Increment Paid 6': submission.taxEntityIncrementPaid_5 || '',
                    'Remaining Authorized 6': submission.taxEntityRemainingAuthorized_5 || '',
                    'Tax Entity 7': submission.taxEntityName_6 || '',
                    'Participation Rate 7': submission.taxEntityParticipationRate_6 || '',
                    'Remittance 7': submission.taxEntityRemittance_6 || '',
                    'Cap Amount 7': submission.taxEntityCapAmount_6 || '',
                    'Increment Paid 7': submission.taxEntityIncrementPaid_6 || '',
                    'Remaining Authorized 7': submission.taxEntityRemainingAuthorized_6 || '',
                    'Tax Entity 8': submission.taxEntityName_7 || '',
                    'Participation Rate 8': submission.taxEntityParticipationRate_7 || '',
                    'Remittance 8': submission.taxEntityRemittance_7 || '',
                    'Cap Amount 8': submission.taxEntityCapAmount_7 || '',
                    'Increment Paid 8': submission.taxEntityIncrementPaid_7 || '',
                    'Remaining Authorized 8': submission.taxEntityRemainingAuthorized_7 || '',
                    'Tax Entity 9': submission.taxEntityName_8 || '',
                    'Participation Rate 9': submission.taxEntityParticipationRate_8 || '',
                    'Remittance 9': submission.taxEntityRemittance_8 || '',
                    'Cap Amount 9': submission.taxEntityCapAmount_8 || '',
                    'Increment Paid 9': submission.taxEntityIncrementPaid_8 || '',
                    'Remaining Authorized 9': submission.taxEntityRemainingAuthorized_8 || '',
                    'Tax Entity 10': submission.taxEntityName_9 || '',
                    'Participation Rate 10': submission.taxEntityParticipationRate_9 || '',
                    'Remittance 10': submission.taxEntityRemittance_9 || '',
                    'Cap Amount 10': submission.taxEntityCapAmount_9 || '',
                    'Increment Paid 10': submission.taxEntityIncrementPaid_9 || '',
                    'Remaining Authorized 10': submission.taxEntityRemainingAuthorized_9 || '',
                    
                    // Internal Request - Totals
                    'Total Remittance': submission.totalRemittance || '',
                    'Total Cap': submission.totalCap || '',
                    'Total Actual Received': submission.totalActualReceived || '',
                    'Total Remaining Authorized': submission.totalRemainingAuthorized || '',
                    
                    // Internal Request - Revenue Information
                    'FY Original Budget Revenues': submission.tyOriginalBudgetRevenues || '',
                    'Original Budget Lifetime Revenues': submission.lifetimeRevenues || '',
                    'FY Actual Revenue': submission.tyActualRevenue || '',
                    'Lifetime Actual Revenues': submission.lifetimeActualRevenues || '',
                    'FY Base Year Revenue': submission.tyBaseYearRevenue || '',
                    'Lifetime Base Year Revenues': submission.lifetimeBaseYearRevenues || '',
                    
                    // Internal Request - Financial Analysis
                    'Administrative Percentage': submission.administrativePercentage || '',
                    'Discount Rate': submission.discountRate || '',
                    'Aggregate Remaining Revenue': submission.aggregateRemainingRevenue || '',
                    'Discounted Aggregate Remaining Revenue': submission.discountedAggregateRemainingRevenue || '',
                    'Total Aggregate Expense': submission.totalAggregateExpense || '',
                    'Total Aggregate Expense at NPV': submission.totalAggregateExpenseAtNpv || '',
                    
                    // Internal Request - Total Expenses (All 10 possible expenses)
                    'Total Expense Description 1': submission.totalExpenseDescription_0 || '',
                    'Total Expense Amount 1': submission.totalExpenseAmount_0 || '',
                    'Total Expense NPV 1': submission.totalExpenseNpv_0 || '',
                    'Total Expense Description 2': submission.totalExpenseDescription_1 || '',
                    'Total Expense Amount 2': submission.totalExpenseAmount_1 || '',
                    'Total Expense NPV 2': submission.totalExpenseNpv_1 || '',
                    'Total Expense Description 3': submission.totalExpenseDescription_2 || '',
                    'Total Expense Amount 3': submission.totalExpenseAmount_2 || '',
                    'Total Expense NPV 3': submission.totalExpenseNpv_2 || '',
                    'Total Expense Description 4': submission.totalExpenseDescription_3 || '',
                    'Total Expense Amount 4': submission.totalExpenseAmount_3 || '',
                    'Total Expense NPV 4': submission.totalExpenseNpv_3 || '',
                    'Total Expense Description 5': submission.totalExpenseDescription_4 || '',
                    'Total Expense Amount 5': submission.totalExpenseAmount_4 || '',
                    'Total Expense NPV 5': submission.totalExpenseNpv_4 || '',
                    'Total Expense Description 6': submission.totalExpenseDescription_5 || '',
                    'Total Expense Amount 6': submission.totalExpenseAmount_5 || '',
                    'Total Expense NPV 6': submission.totalExpenseNpv_5 || '',
                    'Total Expense Description 7': submission.totalExpenseDescription_6 || '',
                    'Total Expense Amount 7': submission.totalExpenseAmount_6 || '',
                    'Total Expense NPV 7': submission.totalExpenseNpv_6 || '',
                    'Total Expense Description 8': submission.totalExpenseDescription_7 || '',
                    'Total Expense Amount 8': submission.totalExpenseAmount_7 || '',
                    'Total Expense NPV 8': submission.totalExpenseNpv_7 || '',
                    'Total Expense Description 9': submission.totalExpenseDescription_8 || '',
                    'Total Expense Amount 9': submission.totalExpenseAmount_8 || '',
                    'Total Expense NPV 9': submission.totalExpenseNpv_8 || '',
                    'Total Expense Description 10': submission.totalExpenseDescription_9 || '',
                    'Total Expense Amount 10': submission.totalExpenseAmount_9 || '',
                    'Total Expense NPV 10': submission.totalExpenseNpv_9 || '',
                    
                    // External Request - Expenses (All 10 possible expenses)
                    'Expense Title 1': submission.expenseTitle_0 || '',
                    'FY Expense 1': submission.tyExpense_0 || '',
                    '2025 Expense 1': submission.cyExpense_0 || '',
                    '2026 Expense 1': submission.nyExpense_0 || '',
                    'Expense Title 2': submission.expenseTitle_1 || '',
                    'FY Expense 2': submission.tyExpense_1 || '',
                    '2025 Expense 2': submission.cyExpense_1 || '',
                    '2026 Expense 2': submission.nyExpense_1 || '',
                    'Expense Title 3': submission.expenseTitle_2 || '',
                    'FY Expense 3': submission.tyExpense_2 || '',
                    '2025 Expense 3': submission.cyExpense_2 || '',
                    '2026 Expense 3': submission.nyExpense_2 || '',
                    'Expense Title 4': submission.expenseTitle_3 || '',
                    'FY Expense 4': submission.tyExpense_3 || '',
                    '2025 Expense 4': submission.cyExpense_3 || '',
                    '2026 Expense 4': submission.nyExpense_3 || '',
                    'Expense Title 5': submission.expenseTitle_4 || '',
                    'FY Expense 5': submission.tyExpense_4 || '',
                    '2025 Expense 5': submission.cyExpense_4 || '',
                    '2026 Expense 5': submission.nyExpense_4 || '',
                    'Expense Title 6': submission.expenseTitle_5 || '',
                    'FY Expense 6': submission.tyExpense_5 || '',
                    '2025 Expense 6': submission.cyExpense_5 || '',
                    '2026 Expense 6': submission.nyExpense_5 || '',
                    'Expense Title 7': submission.expenseTitle_6 || '',
                    'FY Expense 7': submission.tyExpense_6 || '',
                    '2025 Expense 7': submission.cyExpense_6 || '',
                    '2026 Expense 7': submission.nyExpense_6 || '',
                    'Expense Title 8': submission.expenseTitle_7 || '',
                    'FY Expense 8': submission.tyExpense_7 || '',
                    '2025 Expense 8': submission.cyExpense_7 || '',
                    '2026 Expense 8': submission.nyExpense_7 || '',
                    'Expense Title 9': submission.expenseTitle_8 || '',
                    'FY Expense 9': submission.tyExpense_8 || '',
                    '2025 Expense 9': submission.cyExpense_8 || '',
                    '2026 Expense 9': submission.nyExpense_8 || '',
                    'Expense Title 10': submission.expenseTitle_9 || '',
                    'FY Expense 10': submission.tyExpense_9 || '',
                    '2025 Expense 10': submission.cyExpense_9 || '',
                    '2026 Expense 10': submission.nyExpense_9 || '',
                    
                    // Metadata
                    'Timestamp': submission.timestamp || '',
                    'Submission Type': submission.submitterName ? 'External' : 'Internal'
                };
            });
            
            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, `${clientName} Data`);
            
            // Generate Excel file
            XLSX.writeFile(wb, `${clientName}_LRB_Compliance_Data_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            showNotification(`Excel file downloaded successfully for ${clientName}!`);
        }

        function generatePDFReport(city, year) {
            try {
                console.log('Starting jsPDF generation for:', city, year);
                
                // Wait for jsPDF to load if it's not available yet
                const waitForJsPDF = (attempts = 0) => {
                    // Check multiple possible locations for jsPDF
                    const jsPDFClass = window.jsPDF || window.jspdf?.jsPDF || jsPDF;
                    
                    if (typeof jsPDFClass !== 'undefined') {
                        console.log('jsPDF is available, proceeding with generation');
                        generatePDFReportInternal(city, year, jsPDFClass);
                    } else if (attempts < 10) {
                        console.log(`Waiting for jsPDF... attempt ${attempts + 1}`);
                        setTimeout(() => waitForJsPDF(attempts + 1), 500);
                    } else {
                        console.error('jsPDF library not loaded after waiting');
                        console.log('Available globals:', Object.keys(window).filter(k => k.toLowerCase().includes('pdf')));
                        showNotification('PDF library not loaded. Please refresh the page and try again.');
                    }
                };
                
                waitForJsPDF();
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showNotification(`Error generating PDF report: ${error.message}. Please try again.`);
            }
        }
        
        function generatePDFReportInternal(city, year, jsPDFClass) {
            try {
                // Get submissions for this city/year
                const cityYearSubmissions = allSubmissions.filter(submission => {
                    const submissionCity = submission.cityCounty || submission.submitterName || submission.projectArea || 'Unknown';
                    const submissionYear = submission.year || submission.fy || 'N/A';
                    return submissionCity === city && (year === null || submissionYear === year);
                });

                console.log('Found submissions:', cityYearSubmissions.length);

                if (cityYearSubmissions.length === 0) {
                    showNotification(`No data found for ${city}${year ? ` - ${year}` : ''}.`);
                    return;
                }

                // Create new PDF document using the provided jsPDF class
                const doc = new jsPDFClass();
                
                // Add cover page
                addCoverPage(doc, city, year);
                
                // Add table of contents (as page 2)
                addTableOfContents(doc, cityYearSubmissions);
                
                // Add executive summary intro page
                addExecutiveSummaryIntro(doc);
                
                // Add executive summary
                addExecutiveSummary(doc, city, cityYearSubmissions);
                
                // Add governing board section
                addGoverningBoardSection(doc, cityYearSubmissions);
                
                // Add combined budget section
                addCombinedBudgetSection(doc, cityYearSubmissions);
                
                // Add acreage overview section
                addAcreageOverviewSection(doc, cityYearSubmissions);
                
                // Add individual project sections
                addIndividualProjectSections(doc, cityYearSubmissions);
                
                // Save the PDF
                const filename = `LRB_Annual_Report_${city}_${year || 'all'}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
                
                showNotification(`PDF report generated successfully for ${city}${year ? ` - ${year}` : ''}!`);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showNotification(`Error generating PDF report: ${error.message}. Please try again.`);
            }
        }

        function generateHTMLReport(city, year, submissions) {
            let html = '';
            
            // Cover Page
            html += generateHTMLCoverPage(city, year);
            
            // Table of Contents
            html += generateHTMLTableOfContents(submissions);
            
            // Executive Summary Intro Page
            html += generateHTMLExecutiveSummaryIntro();
            
            // Executive Summary
            html += generateHTMLExecutiveSummary(city, submissions);
            
            // Governing Board Section
            html += generateHTMLGoverningBoardSection(submissions);
            
            // Combined Budget Section
            html += generateHTMLCombinedBudgetSection(submissions);
            
            // Individual Project Sections
            html += generateHTMLIndividualProjectSections(submissions);
            
            return html;
        }

        function generateHTMLExecutiveSummaryIntro() {
            return `
                <div style="page-break-after: always; background: #000000; color: white; min-height: 11in; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <h1 style="font-size: 48px; font-weight: bold; text-align: center; margin: 0; color: #0ea5e9; font-family: sans-serif;">EXECUTIVE SUMMARY</h1>
                    <div style="width: 80%; height: 2px; background-color: #d3d3d3; margin-top: 20px;"></div>
                </div>
            `;
        }

        function generateHTMLCoverPage(city, year) {
            return `
                <div style="page-break-after: always; padding: 20px; text-align: center; min-height: 11in; display: flex; flex-direction: column; justify-content: center;">
                    <img src="Pictures/lrb_public_finance_advisors_logo.jpg" alt="LRB Logo" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin: 0 auto 20px;">
                    <div style="font-size: 12px; margin-bottom: 10px;">MULTI-YEAR BUDGET</div>
                    <div style="font-size: 12px; margin-bottom: auto;">[${city.toUpperCase()} AGENCY]</div>
                </div>
            `;
        }

        function generateHTMLTableOfContents(submissions) {
            return `
                <div style="page-break-after: always; padding: 20px;">
                    <div style="background: #0ea5e9; color: white; padding: 10px; margin: -20px -20px 20px -20px; text-align: center; font-weight: bold;">TABLE OF CONTENTS</div>
                    <div style="margin-bottom: 10px;"><strong>EXECUTIVE SUMMARY</strong> ........................................................ 3</div>
                    <div style="margin-bottom: 10px;"><strong>INTRODUCTION</strong> .......................................................... 3</div>
                    <div style="margin-bottom: 10px;"><strong>SUMMARY OF 17C-1-603. REPORTING REQUIREMENTS</strong> ........ 4</div>
                    <div style="margin-bottom: 10px;"><strong>GOVERNING BOARD OF TRUSTEES AND STAFF</strong> ............... 5</div>
                    <div style="margin-bottom: 10px;"><strong>SUMMARY OF TAX INCREMENT REVENUES AND EXPENDITURES</strong> . 6</div>
                    <div style="margin-bottom: 10px;"><strong>TABLE E.3 ‚Äì COMBINED AGENCY BUDGET</strong> .................... 6</div>
                    ${submissions.map((submission, index) => {
                        const projectNumber = index + 1;
                        const projectArea = submission.projectAreaName || submission.projectArea || submission.submitterName || `Project Area ${projectNumber}`;
                        return `<div style="margin-bottom: 10px;"><strong>PROJECT AREA ${projectNumber}: ${projectArea}</strong> ............... ${7 + index}</div>`;
                    }).join('')}
                </div>
            `;
        }

        function generateHTMLExecutiveSummary(city, submissions) {
            const projectAreas = submissions.map(submission => {
                const projectArea = submission.projectAreaName || submission.projectArea || submission.submitterName || 'Unknown Project';
                return `‚Ä¢ ${projectArea}`;
            }).join('<br>');

            return `
                <div style="page-break-after: always; padding: 20px;">
                    <div style="background: #0ea5e9; color: white; padding: 10px; margin: -20px -20px 20px -20px; text-align: center; font-weight: bold;"></div>
                    
                    <h2 style="margin: 10px 0 15px 0; transform: translateY(-3mm);">EXECUTIVE SUMMARY</h2>
                    <div style="width: 100%; height: 0.5mm; background-color: #000000; margin: -5mm 0 20px 0;"></div>
                    
                    <h3 style="color: #0ea5e9; margin: 15px 0 10px 0;">INTRODUCTION</h3>
                    <p>LRB Public Finance Advisors, Inc ("LRB") has been retained by the ${city} Agency of ${city}, Utah (the "Agency") to assist with the management and reporting requirements of the Agency's ${submissions.length} project areas:</p>
                    <div style="margin: 10px 0 20px 20px;">
                        ${projectAreas}
                    </div>
                    
                    <h3 style="color: #0ea5e9; margin: 15px 0 10px 0;">OVERVIEW OF AGENCY</h3>
                    <p>The ${city} Community Reinvestment Agency is a public entity established under Utah Code Title 17C, Chapter 1, Community Reinvestment Agency Act. Community Reinvestment Agencies (CRAs) are authorized to create and manage project areas to promote economic development, job creation, and community improvement through the use of tax increment financing.</p>
                    
                    <p>CRAs have the authority to acquire, develop, and dispose of real property; enter into agreements with developers and other entities; and utilize tax increment revenues to fund public improvements and development activities within designated project areas. The agency operates under the oversight of local government and in accordance with state statutory requirements.</p>
                    
                    <h3 style="color: #0ea5e9; margin: 15px 0 10px 0;">SUMMARY OF AGENCY POWERS</h3>
                    <p>Under Utah Code 17C-1-301, Community Reinvestment Agencies possess the following powers and authorities:</p>
                    <ul style="margin: 10px 0 20px 20px;">
                        <li>To acquire, hold, and dispose of real and personal property within project areas</li>
                        <li>To enter into contracts and agreements with public and private entities</li>
                        <li>To plan, design, and implement public improvements and infrastructure</li>
                        <li>To provide financial assistance to private development through loans, grants, and other mechanisms</li>
                        <li>To utilize tax increment revenues for project area development and administration</li>
                        <li>To issue bonds and other debt instruments for project financing</li>
                        <li>To exercise eminent domain powers within project areas when necessary</li>
                        <li>To coordinate with local governments and taxing entities on development activities</li>
                    </ul>
                    
                    <p>The purpose of this report, in part, is to fulfill the requirements of Utah Code section 17C-1-603 ‚Äì Reporting requirements ‚Äì Governor's Office of Economic Opportunity to maintain a database and related reports. As new reporting requirements were adopted in legislation and became effective in 2011 and again revised and updated in 2016, 2019, 2022, and 2025, this report facilitates the Agency's compliance with the current state code, providing the data necessary to fulfill the Agency report requirements. The Agency has submitted all required information into the GOEO database and is providing this Annual Report for further transparency to the public and taxing entities, and to update the Agency Board on the status and activities within each project area. This annual report is for informational purposes only and does not alter the amount of project area funds that the Agency is authorized to receive from each Project Area. This report is intended to provide an overview of each Project Area that lies within the boundaries of the Agency, including descriptions of each Project Area, significant activities, project timelines, actual and estimated tax increment collections, and any other information pertinent to the taxing entities.</p>
                    
                    <h3 style="color: #0ea5e9; margin: 20px 0 10px 0;">SUMMARY OF 17C-1-603. REPORTING REQUIREMENTS ‚Äì GOVERNOR'S OFFICE OF ECONOMIC OPPORTUNITY TO MAINTAIN A DATABASE.</h3>
                    <p>Utah State Code 17C-1-603 sets out the annual reporting requirements for community reinvestment agencies. Under this section:</p>
                    <ul style="margin: 10px 0 20px 20px;">
                        <li>Agencies must submit annual reports by June 30 for each active project area, providing detailed financial and project information, such as:</li>
                        <li>Amounts and estimates of project area funds received and to be received.</li>
                        <li>Project budgets and analyses of receipts and expenditures.</li>
                        <li>Maps of the project area and descriptions of progress toward project goals.</li>
                        <li>Agencies with no active project areas must still submit a report confirming their status until the agency is dissolved.</li>
                        <li>The Governor's Office of Economic Opportunity must maintain a public database of the submitted data and prepare an annual report for legislative review.</li>
                        <li>Noncompliance can lead to financial penalties, including withholding a portion of the agency's tax increment funds.</li>
                        <li>The report is informational and does not alter the total funds the agency is entitled to collect.</li>
                    </ul>
                </div>
            `;
        }

        function generateHTMLGoverningBoardSection(submissions) {
            // Get governing board data from submissions
            const boardMembers = [];
            for (let i = 1; i <= 10; i++) {
                const name = submissions[0]?.[`governingBoardName_${i}`];
                const title = submissions[0]?.[`governingBoardTitle_${i}`];
                if (name && name.trim()) {
                    boardMembers.push({ name: name.trim(), title: title?.trim() || '' });
                }
            }

            // Get agency staff data from submissions
            const staffMembers = [];
            for (let i = 1; i <= 10; i++) {
                const name = submissions[0]?.[`agencyStaffName_${i}`];
                const title = submissions[0]?.[`agencyStaffTitle_${i}`];
                if (name && name.trim()) {
                    staffMembers.push({ name: name.trim(), title: title?.trim() || '' });
                }
            }

            const boardRows = boardMembers.map(member => 
                `<tr><td style="padding: 8px; border: 1px solid #ddd;">${member.name}</td><td style="padding: 8px; border: 1px solid #ddd;">${member.title}</td></tr>`
            ).join('');

            const staffRows = staffMembers.map(member => 
                `<tr><td style="padding: 8px; border: 1px solid #ddd;">${member.name}</td><td style="padding: 8px; border: 1px solid #ddd;">${member.title}</td></tr>`
            ).join('');

            return `
                <div style="page-break-after: always; padding: 20px;">
                    <h2 style="margin: 20px 0 15px 0; color: #0ea5e9;">GOVERNING BOARD OF TRUSTEES AND STAFF</h2>
                    
                    <h3 style="color: #0ea5e9; margin: 15px 0 10px 0;">GOVERNING BOARD OF TRUSTEES</h3>
                    <p>The governing board of the Agency consists of the following members:</p>
                    
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: bold;">Name</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: bold;">Title/Position</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${boardRows || '<tr><td colspan="2" style="padding: 8px; border: 1px solid #ddd; text-align: center; font-style: italic;">No governing board members data available</td></tr>'}
                        </tbody>
                    </table>

                    <h3 style="color: #0ea5e9; margin: 25px 0 10px 0;">AGENCY STAFF</h3>
                    <p>The agency staff consists of the following members:</p>
                    
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: bold;">Name</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: bold;">Title/Position</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${staffRows || '<tr><td colspan="2" style="padding: 8px; border: 1px solid #ddd; text-align: center; font-style: italic;">No agency staff data available</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function generateHTMLCombinedBudgetSection(submissions) {
            // Calculate combined financial data (using same logic as original jsPDF function)
            const combinedData = {
                totalRevenues: 0,
                totalExpenditures: 0,
                projectAreas: []
            };

            // Revenue categories
            const revenueCategories = [
                'taxIncrementRevenue',
                'bondProceeds',
                'grants',
                'developerContributions',
                'otherRevenue'
            ];

            // Expenditure categories  
            const expenditureCategories = [
                'administrativeCosts',
                'publicImprovements',
                'infrastructure',
                'landAcquisition',
                'bondPayments',
                'otherExpenditures'
            ];

            // Aggregate data from all submissions
            submissions.forEach(submission => {
                const projectArea = submission.projectAreaName || submission.projectArea || submission.submitterName || 'Unknown';
                
                let projectRevenues = 0;
                let projectExpenditures = 0;

                // Calculate revenues
                revenueCategories.forEach(category => {
                    const amount = parseFloat(submission[category]) || 0;
                    projectRevenues += amount;
                });

                // Calculate expenditures
                expenditureCategories.forEach(category => {
                    const amount = parseFloat(submission[category]) || 0;
                    projectExpenditures += amount;
                });

                combinedData.projectAreas.push({
                    name: projectArea,
                    revenues: projectRevenues,
                    expenditures: projectExpenditures
                });

                combinedData.totalRevenues += projectRevenues;
                combinedData.totalExpenditures += projectExpenditures;
            });

            // Generate revenue table rows
            const revenueRows = revenueCategories.map(category => {
                const totalAmount = submissions.reduce((sum, submission) => {
                    return sum + (parseFloat(submission[category]) || 0);
                }, 0);
                return `<tr><td style="padding: 8px; border: 1px solid #ddd;">${category.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${totalAmount.toLocaleString()}</td></tr>`;
            }).join('');

            // Generate expenditure table rows
            const expenditureRows = expenditureCategories.map(category => {
                const totalAmount = submissions.reduce((sum, submission) => {
                    return sum + (parseFloat(submission[category]) || 0);
                }, 0);
                return `<tr><td style="padding: 8px; border: 1px solid #ddd;">${category.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${totalAmount.toLocaleString()}</td></tr>`;
            }).join('');

            // Generate acreage overview table
            const acreageRows = combinedData.projectAreas.map(project => {
                const submission = submissions.find(s => 
                    (s.projectAreaName || s.projectArea || s.submitterName) === project.name
                );
                const totalAcreage = parseFloat(submission?.totalAcreage) || 0;
                const developedAcreage = parseFloat(submission?.developedAcreage) || 0;
                const remainingAcreage = totalAcreage - developedAcreage;
                
                return `<tr>
                    <td style="padding: 8px; border: 1px solid #ddd;">${project.name}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${totalAcreage.toLocaleString()}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${developedAcreage.toLocaleString()}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${remainingAcreage.toLocaleString()}</td>
                </tr>`;
            }).join('');

            const totalAcreage = combinedData.projectAreas.reduce((sum, project) => {
                const submission = submissions.find(s => 
                    (s.projectAreaName || s.projectArea || s.submitterName) === project.name
                );
                return sum + (parseFloat(submission?.totalAcreage) || 0);
            }, 0);

            const totalDevelopedAcreage = combinedData.projectAreas.reduce((sum, project) => {
                const submission = submissions.find(s => 
                    (s.projectAreaName || s.projectArea || s.submitterName) === project.name
                );
                return sum + (parseFloat(submission?.developedAcreage) || 0);
            }, 0);

            const totalRemainingAcreage = totalAcreage - totalDevelopedAcreage;

            return `
                <div style="page-break-after: always; padding: 20px;">
                    <h2 style="margin: 20px 0 15px 0; color: #0ea5e9;">SUMMARY OF TAX INCREMENT REVENUES AND EXPENDITURES</h2>
                    
                    <h3 style="color: #0ea5e9; margin: 15px 0 10px 0;">TABLE E.3 ‚Äì COMBINED AGENCY BUDGET</h3>
                    <p><strong>COMBINED TAX INCREMENT BUDGET ‚Äì AGENCY</strong></p>
                    
                    <h4 style="margin: 20px 0 10px 0;">REVENUES</h4>
                    <table style="width: 100%; border-collapse: collapse; margin: 10px 0 30px 0;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: bold;">Revenue Source</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: bold;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${revenueRows}
                            <tr style="background: #f0f8ff; font-weight: bold;">
                                <td style="padding: 12px; border: 1px solid #ddd;">TOTAL REVENUES</td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">$${combinedData.totalRevenues.toLocaleString()}</td>
                            </tr>
                        </tbody>
                    </table>

                    <h4 style="margin: 20px 0 10px 0;">EXPENDITURES</h4>
                    <table style="width: 100%; border-collapse: collapse; margin: 10px 0 30px 0;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: bold;">Expenditure Category</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: bold;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${expenditureRows}
                            <tr style="background: #f0f8ff; font-weight: bold;">
                                <td style="padding: 12px; border: 1px solid #ddd;">TOTAL EXPENDITURES</td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">$${combinedData.totalExpenditures.toLocaleString()}</td>
                            </tr>
                        </tbody>
                    </table>

                    <h4 style="margin: 20px 0 10px 0;">COMBINED ACREAGE OVERVIEW</h4>
                    <table style="width: 100%; border-collapse: collapse; margin: 10px 0 30px 0;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: bold;">Project Area</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: bold;">Total Acreage</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: bold;">Developed Acreage</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: right; font-weight: bold;">Remaining Acreage</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${acreageRows}
                            <tr style="background: #f0f8ff; font-weight: bold;">
                                <td style="padding: 12px; border: 1px solid #ddd;">TOTAL</td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${totalAcreage.toLocaleString()}</td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${totalDevelopedAcreage.toLocaleString()}</td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${totalRemainingAcreage.toLocaleString()}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        function generateHTMLIndividualProjectSections(submissions) {
            let html = '';
            
            submissions.forEach((submission, index) => {
                const projectNumber = index + 1;
                const projectArea = submission.projectAreaName || submission.projectArea || submission.submitterName || `Project Area ${projectNumber}`;
                
                // Financial data
                const revenues = {
                    taxIncrement: parseFloat(submission.taxIncrementRevenue) || 0,
                    bondProceeds: parseFloat(submission.bondProceeds) || 0,
                    grants: parseFloat(submission.grants) || 0,
                    developerContributions: parseFloat(submission.developerContributions) || 0,
                    otherRevenue: parseFloat(submission.otherRevenue) || 0
                };
                const totalRevenues = Object.values(revenues).reduce((sum, val) => sum + val, 0);

                const expenditures = {
                    administrativeCosts: parseFloat(submission.administrativeCosts) || 0,
                    publicImprovements: parseFloat(submission.publicImprovements) || 0,
                    infrastructure: parseFloat(submission.infrastructure) || 0,
                    landAcquisition: parseFloat(submission.landAcquisition) || 0,
                    bondPayments: parseFloat(submission.bondPayments) || 0,
                    otherExpenditures: parseFloat(submission.otherExpenditures) || 0
                };
                const totalExpenditures = Object.values(expenditures).reduce((sum, val) => sum + val, 0);

                // Acreage data
                const totalAcreage = parseFloat(submission.totalAcreage) || 0;
                const developedAcreage = parseFloat(submission.developedAcreage) || 0;
                const remainingAcreage = totalAcreage - developedAcreage;

                html += `
                    <div style="page-break-after: always; background: #000000; color: white; min-height: 11in; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <h1 style="font-size: 48px; font-weight: bold; text-align: center; margin: 0; color: #0ea5e9; font-family: sans-serif;">${projectArea.toUpperCase()}</h1>
                        <div style="width: 80%; height: 2px; background-color: #d3d3d3; margin-top: 20px;"></div>
                    </div>
                    
                    <div style="page-break-after: always; padding: 20px;">
                        <div style="background: #0ea5e9; color: white; padding: 10px; margin: -20px -20px 20px -20px; text-align: center; font-weight: bold;"></div>
                        
                        <h2 style="margin: 10px 0 15px 0; transform: translateY(-3mm);">${projectArea.toUpperCase()}</h2>
                        <div style="width: 100%; height: 0.5mm; background-color: #000000; margin: -5mm 0 20px 0;"></div>
                        
                        <div style="margin: 15px 0;">
                            <h3 style="color: #0ea5e9; margin: 15px 0 10px 0;">PROJECT INFORMATION</h3>
                            <p><strong>Project Area:</strong> ${projectArea}</p>
                            <p><strong>Type:</strong> ${submission.type || 'N/A'}</p>
                            <p><strong>Purpose:</strong> ${submission.purpose || 'N/A'}</p>
                            <p><strong>Year:</strong> ${submission.year || submission.fy || 'N/A'}</p>
                            ${submission.submitterName ? `<p><strong>Submitter:</strong> ${submission.submitterName}</p>` : ''}
                            ${submission.submitterEmail ? `<p><strong>Email:</strong> ${submission.submitterEmail}</p>` : ''}
                            ${submission.submitterPhone ? `<p><strong>Phone:</strong> ${submission.submitterPhone}</p>` : ''}
                            ${submission.timestamp ? `<p><strong>Submitted:</strong> ${new Date(submission.timestamp).toLocaleDateString()}</p>` : ''}
                        </div>

                        <h3 style="color: #0ea5e9; margin: 20px 0 10px 0;">FINANCIAL SUMMARY</h3>
                        
                        <h4 style="margin: 10px 0 5px 0; color: #888888; font-size: 12px; font-weight: bold;">TABLE 1 ‚Äì OVERVIEW OF PROJECT AREA</h4>
                        <h4 style="margin: 15px 0 8px 0;">REVENUES</h4>
                        <table style="width: 100%; border-collapse: collapse; margin: 10px 0 20px 0;">
                            <tbody>
                                <tr><td style="padding: 6px; border: 1px solid #ddd;">Tax Increment Revenue</td><td style="padding: 6px; border: 1px solid #ddd; text-align: right;">$${revenues.taxIncrement.toLocaleString()}</td></tr>
                                <tr><td style="padding: 6px; border: 1px solid #ddd;">Bond Proceeds</td><td style="padding: 6px; border: 1px solid #ddd; text-align: right;">$${revenues.bondProceeds.toLocaleString()}</td></tr>
                                <tr><td style="padding: 6px; border: 1px solid #ddd;">Grants</td><td style="padding: 6px; border: 1px solid #ddd; text-align: right;">$${revenues.grants.toLocaleString()}</td></tr>
                                <tr><td style="padding: 6px; border: 1px solid #ddd;">Developer Contributions</td><td style="padding: 6px; border: 1px solid #ddd; text-align: right;">$${revenues.developerContributions.toLocaleString()}</td></tr>
                                <tr><td style="padding: 6px; border: 1px solid #ddd;">Other Revenue</td><td style="padding: 6px; border: 1px solid #ddd; text-align: right;">$${revenues.otherRevenue.toLocaleString()}</td></tr>
                                <tr style="background: #f0f8ff; font-weight: bold;"><td style="padding: 8px; border: 1px solid #ddd;">TOTAL REVENUES</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${totalRevenues.toLocaleString()}</td></tr>
                            </tbody>
                        </table>

                        <h4 style="margin: 15px 0 8px 0;">EXPENDITURES</h4>
                        <table style="width: 100%; border-collapse: collapse; margin: 10px 0 20px 0;">
                            <tbody>
                                <tr><td style="padding: 6px; border: 1px solid #ddd;">Administrative Costs</td><td style="padding: 6px; border: 1px solid #ddd; text-align: right;">$${expenditures.administrativeCosts.toLocaleString()}</td></tr>
                                <tr><td style="padding: 6px; border: 1px solid #ddd;">Public Improvements</td><td style="padding: 6px; border: 1px solid #ddd; text-align: right;">$${expenditures.publicImprovements.toLocaleString()}</td></tr>
                                <tr><td style="padding: 6px; border: 1px solid #ddd;">Infrastructure</td><td style="padding: 6px; border: 1px solid #ddd; text-align: right;">$${expenditures.infrastructure.toLocaleString()}</td></tr>
                                <tr><td style="padding: 6px; border: 1px solid #ddd;">Land Acquisition</td><td style="padding: 6px; border: 1px solid #ddd; text-align: right;">$${expenditures.landAcquisition.toLocaleString()}</td></tr>
                                <tr><td style="padding: 6px; border: 1px solid #ddd;">Bond Payments</td><td style="padding: 6px; border: 1px solid #ddd; text-align: right;">$${expenditures.bondPayments.toLocaleString()}</td></tr>
                                <tr><td style="padding: 6px; border: 1px solid #ddd;">Other Expenditures</td><td style="padding: 6px; border: 1px solid #ddd; text-align: right;">$${expenditures.otherExpenditures.toLocaleString()}</td></tr>
                                <tr style="background: #f0f8ff; font-weight: bold;"><td style="padding: 8px; border: 1px solid #ddd;">TOTAL EXPENDITURES</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${totalExpenditures.toLocaleString()}</td></tr>
                            </tbody>
                        </table>

                        <h3 style="color: #0ea5e9; margin: 20px 0 10px 0;">ACREAGE OVERVIEW</h3>
                        <h4 style="margin: 10px 0 5px 0; color: #888888; font-size: 12px; font-weight: bold;">TABLE 8 ‚Äì ACREAGE</h4>
                        <table style="width: 100%; border-collapse: collapse; margin: 10px 0 20px 0;">
                            <tbody>
                                <tr><td style="padding: 8px; border: 1px solid #ddd;">Total Acreage</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${totalAcreage.toLocaleString()} acres</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #ddd;">Developed Acreage</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${developedAcreage.toLocaleString()} acres</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #ddd;">Remaining Acreage</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${remainingAcreage.toLocaleString()} acres</td></tr>
                            </tbody>
                        </table>

                        <h3 style="color: #0ea5e9; margin: 20px 0 10px 0;">ADDITIONAL DETAILS</h3>
                        ${submission.description ? `<p><strong>Description:</strong> ${submission.description}</p>` : ''}
                        ${submission.status ? `<p><strong>Status:</strong> ${submission.status}</p>` : ''}
                        ${submission.timeline ? `<p><strong>Timeline:</strong> ${submission.timeline}</p>` : ''}
                        ${submission.notes ? `<p><strong>Notes:</strong> ${submission.notes}</p>` : ''}
                    </div>
                `;
            });
            
            return html;
        }

        function addCoverPage(doc, city, year) {
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            
            console.log('Adding cover page. logoDataUrl exists:', !!logoDataUrl, 'Logo dimensions:', logoWidth, 'x', logoHeight);
            
            // Add horizontal logo at top middle (1/5 of page width, 25mm from top)
            if (logoDataUrl && logoWidth > 0 && logoHeight > 0) {
                try {
                    // Calculate aspect ratio from stored dimensions
                    const aspectRatio = logoWidth / logoHeight;
                    
                    console.log('Logo aspect ratio:', aspectRatio);
                    
                    // Logo width: 4/5 of page width (210mm * 0.8 = 168mm) - 4x bigger
                    const pdfLogoWidth = pageWidth * 0.8;
                    const pdfLogoHeight = pdfLogoWidth / aspectRatio;
                    
                    // Position: center horizontally, 25mm from top
                    const logoX = (pageWidth - pdfLogoWidth) / 2;
                    const logoY = 25;
                    
                    // Add black background rectangle (full page width, from top to 10mm below logo)
                    doc.setFillColor(0, 0, 0); // Black
                    const bgX = 0; // Full page width, starts at left edge
                    const bgY = 0; // Starts at top of page
                    const bgWidth = pageWidth; // Full page width
                    const bgHeight = logoY + pdfLogoHeight + 10; // From top to logo bottom + 10mm
                    doc.rect(bgX, bgY, bgWidth, bgHeight, 'F'); // 'F' = filled rectangle
                    
                    console.log('‚úì Black background added:', bgX, bgY, bgWidth, 'x', bgHeight);
                    
                    // Add logo on top of black background
                    console.log('Adding logo to cover page at:', logoX, logoY, 'size:', pdfLogoWidth, 'x', pdfLogoHeight);
                    doc.addImage(logoDataUrl, 'PNG', logoX, logoY, pdfLogoWidth, pdfLogoHeight);
                    console.log('‚úì Logo added to cover page');
                    
                    // Add "REDEVELOPMENT AGENCY OF [CITY]" text on left side
                    // Right-aligned at middle of page (50%), vertically centered with last line at center
                    const middleOfPage = pageWidth / 2; // Middle of page
                    
                    // Calculate vertical center between black section and bottom of page
                    const remainingSpace = pageHeight - bgHeight;
                    const verticalCenter = bgHeight + (remainingSpace / 2);
                    
                    // Set text properties
                    doc.setTextColor(14, 165, 233); // Blue color (#0ea5e9)
                    doc.setFontSize(28);
                    // Use jsPDF default font (no setFont call)
                    
                    // Line spacing (28pt font = ~9.9mm, normal spacing adds ~20% = ~12mm between lines)
                    const lineHeight = 12;
                    
                    // Last line (city name) should be at vertical center
                    // So work backwards from that position
                    const line3Y = verticalCenter; // City name at center
                    const line2Y = line3Y - lineHeight; // "AGENCY OF"
                    const line1Y = line2Y - lineHeight; // "REDEVELOPMENT"
                    
                    // Add vertical divider line at 50% mark + 2mm - 10mm + 1mm (shifted left then right 1mm)
                    const lineX = middleOfPage + 2 - 10 + 1; // 2mm to the right of center, then 10mm left, then 1mm right
                    const lineStartY = bgHeight + 65; // 65mm below black section
                    const lineEndY = pageHeight - 30; // 30mm from bottom
                    doc.setDrawColor(153, 153, 153); // Medium-light gray (#999999)
                    doc.setLineWidth(0.5); // 0.5mm thick
                    doc.line(lineX, lineStartY, lineX, lineEndY);
                    
                    // Draw three lines of text, right-aligned 5mm LEFT of divider line
                    const leftTextX = lineX - 5; // 5mm left of divider line
                    doc.text('REDEVELOPMENT', leftTextX, line1Y, { align: 'right' });
                    doc.text('AGENCY OF', leftTextX, line2Y, { align: 'right' });
                    doc.text(city.toUpperCase(), leftTextX, line3Y, { align: 'right' });
                    
                    // Add date below city name - 20mm gap
                    const dateY = line3Y + 20;
                    doc.setFontSize(24);
                    doc.setTextColor(153, 153, 153); // Medium-light gray (#999999)
                    doc.text(`June 30, ${year}`, leftTextX, dateY, { align: 'right' });
                    
                    // Add "ANNUAL RDA REPORT" and "2025" on right side
                    // Left-aligned 5mm RIGHT of divider line, same Y as REDEVELOPMENT
                    const rightTextX = lineX + 5; // 5mm right of divider line
                    doc.setFontSize(24); // 24pt font
                    doc.setTextColor(170, 170, 170); // Medium-light gray (#AAAAAA)
                    doc.text('ANNUAL RDA REPORT', rightTextX, line1Y, { align: 'left' });
                    doc.text('2025', rightTextX, line1Y + 12, { align: 'left' }); // 12mm below first line
                    
                    // Add "PREPARED BY:" section
                    const preparedByY = line1Y + 12 + 15 + 15; // 15mm below "2025" + 15mm down
                    doc.setFontSize(16); // Increased to 16pt
                    doc.setFont(undefined, 'bold'); // Make it bold
                    doc.setTextColor(100, 100, 100); // Dark gray
                    doc.text('PREPARED BY:', rightTextX, preparedByY, { align: 'left' });
                    
                    // Add second line with company name as hyperlink
                    const companyY = preparedByY + 15; // 15mm below "PREPARED BY:"
                    doc.setFontSize(16); // Increased to 16pt
                    doc.setFont(undefined, 'bold'); // Make it bold
                    doc.setTextColor(14, 165, 233); // Blue color (#0ea5e9)
                    doc.textWithLink('LRB PUBLIC FINANCE ADVISORS', rightTextX, companyY, { 
                        align: 'left',
                        url: 'https://lrbfinance.com/'
                    });
                    
                    console.log('‚úì Agency text, date, divider line, and right side text added');
                } catch (e) {
                    console.error('ERROR adding logo to cover page:', e);
                }
            } else {
                console.warn('‚ö† logoDataUrl is null or dimensions invalid - logo not loaded properly');
            }
        }

        function addTableOfContents(doc, submissions) {
            doc.addPage();
            
            const margin = 20;
            const pageWidth = doc.internal.pageSize.getWidth();
            let yPosition = 30;
            
            // Add header background
            doc.setFillColor(14, 165, 233);
            doc.rect(0, 0, pageWidth, 40, 'F');
            
            // Title with enhanced styling
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            // Use jsPDF default font
            doc.text('TABLE OF CONTENTS', pageWidth / 2, 25, { align: 'center' });
            
            // Reset text color
            doc.setTextColor(0, 0, 0);
            yPosition = 60;
            
            // Table of Contents Items with enhanced styling
            const tocItems = [
                { title: 'EXECUTIVE SUMMARY', page: '3' },
                { title: 'INTRODUCTION', page: '3' },
                { title: 'SUMMARY OF 17C-1-603 REPORTING REQUIREMENTS', page: '4' },
                { title: 'OVERVIEW OF AGENCY (CRA/CDRA/RDA)', page: '4' },
                { title: 'SUMMARY OF 17C-1-202 AGENCY POWERS', page: '5' },
                { title: 'GOVERNING BOARD OF TRUSTEES AND STAFF', page: '6' },
                { title: 'SUMMARY OF TAX INCREMENT REVENUES AND EXPENDITURES', page: '7' },
                { title: 'GENERAL OVERVIEW OF PROJECT AREAS AND ACREAGE', page: '8' }
            ];
            
            // Add individual project area sections with actual names
            submissions.forEach((submission, index) => {
                // Use the most descriptive name available - prioritize actual project area names
                let projectArea = submission.projectAreaName || submission.projectArea;
                
                // If no project area name, use submitter name (like "Redhawks CDA")
                if (!projectArea) {
                    projectArea = submission.submitterName || submission.cityCounty;
                }
                
                // Only use generic name as absolute last resort
                if (!projectArea) {
                    projectArea = `Project Area #${index + 1}`;
                }
                
                tocItems.push({ title: projectArea.toUpperCase(), page: `${8 + index + 1}` });
            });
            
            doc.setFontSize(12);
            // Use jsPDF default font
            
            tocItems.forEach((item, index) => {
                // Add alternating row colors
                if (index % 2 === 0) {
                    doc.setFillColor(248, 249, 250);
                    doc.rect(margin - 5, yPosition - 5, pageWidth - (margin * 2) + 10, 12, 'F');
                }
                
                doc.setTextColor(14, 165, 233);
                doc.setFont(undefined, 'bold');
                doc.text(item.title, margin, yPosition);
                
                doc.setTextColor(100, 100, 100);
                doc.setFont(undefined, 'normal');
                doc.text(`Page ${item.page}`, pageWidth - margin - 20, yPosition, { align: 'right' });
                
                yPosition += 18;
            });
            
            // Add footer line
            doc.setDrawColor(14, 165, 233);
            doc.setLineWidth(1);
            doc.line(margin, yPosition + 10, pageWidth - margin, yPosition + 10);
        }

        function addExecutiveSummaryIntro(doc) {
            doc.addPage();
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            
            // Black background
            doc.setFillColor(0, 0, 0);
            doc.rect(0, 0, pageWidth, pageHeight, 'F');
            
            // Blue text centered
            doc.setTextColor(14, 165, 233);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('EXECUTIVE SUMMARY', pageWidth / 2, pageHeight / 2 - 10, { align: 'center' });
            
            // Gray underline
            doc.setDrawColor(211, 211, 211);
            doc.setLineWidth(2);
            const lineWidth = pageWidth * 0.8;
            const lineX = (pageWidth - lineWidth) / 2;
            const lineY = pageHeight / 2 + 15;
            doc.line(lineX, lineY, lineX + lineWidth, lineY);
        }

        function addExecutiveSummary(doc, city, submissions) {
            doc.addPage();
            
            const margin = 20;
            const pageWidth = doc.internal.pageSize.getWidth();
            let yPosition = 30;
            
            // Add header
            addReportHeader(doc, 'ANNUAL JUNE 30TH COMPLIANCE REPORT');
            
            // EXECUTIVE SUMMARY Title, moved up by 3mm (approximately 8 points)
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('EXECUTIVE SUMMARY', margin, yPosition - 8);
            yPosition -= 6; // Move line up by 5mm (approximately 14 points)
            
            // Add black horizontal line under the title (0.5mm thick)
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.5);
            doc.line(margin, yPosition, pageWidth - margin, yPosition);
            yPosition += 14; // Space after line
            
            // Helper function to add text with automatic page breaks using global utility
            const addTextWithPageBreaks = (text, fontSize, color, isBold = false) => {
                doc.setFontSize(fontSize);
                doc.setFont(undefined, isBold ? 'bold' : 'normal');
                // Keep blue for section headings, force black for regular paragraphs
                if (isBold && fontSize === 14) {
                    doc.setTextColor(color[0], color[1], color[2]); // Blue for section headings
                } else {
                    doc.setTextColor(0, 0, 0); // Black for regular paragraphs
                }
                
                const splitText = doc.splitTextToSize(text, pageWidth - (margin * 2));
                const requiredSpace = splitText.length * (fontSize * 0.4) + 10;
                
                // Use global autoPageBreak utility
                const { yPosition: newY } = autoPageBreak(doc, yPosition, requiredSpace);
                yPosition = newY;
                
                doc.text(splitText, margin, yPosition);
                yPosition += splitText.length * (fontSize * 0.4) + 10;
            };
            
            // Helper function to add bullet points with automatic page breaks - FORCE BLACK TEXT
            const addBulletPoints = (items, fontSize, color, indent = 10) => {
                doc.setFontSize(fontSize);
                // FORCE BLACK TEXT for all bullet points
                doc.setTextColor(0, 0, 0);
                
                items.forEach(item => {
                    // Use global autoPageBreak utility
                    const { yPosition: newY } = autoPageBreak(doc, yPosition, 10);
                    yPosition = newY;
                    
                    doc.text(`‚Ä¢ ${item}`, margin + indent, yPosition);
                    yPosition += 8;
                });
            };
            
            // INTRODUCTION Section
            addTextWithPageBreaks('INTRODUCTION', 14, [14, 165, 233], true);
            
            // Get project area names dynamically
            const projectAreaNames = submissions.map((submission, index) => {
                let projectArea = submission.projectAreaName || submission.projectArea;
                if (!projectArea) {
                    projectArea = submission.submitterName || submission.cityCounty;
                }
                if (!projectArea) {
                    projectArea = `Project Area #${index + 1}`;
                }
                return projectArea;
            });
            
            // Introduction paragraph
            const introText = `LRB Public Finance Advisors, Inc ("LRB") has been retained by the ${city} Agency of ${city}, Utah (the "Agency") to assist with the management and reporting requirements of the Agency's ${submissions.length} project areas:`;
            addTextWithPageBreaks(introText, 11, [0, 0, 0]);
            
            // List project areas
            addBulletPoints(projectAreaNames, 10, [14, 165, 233], 10);
            
            // Purpose paragraph
            const purposeText = `The purpose of this report, in part, is to fulfill the requirements of Utah Code section 17C-1-603 ‚Äì Reporting requirements ‚Äì Governor's Office of Economic Opportunity to maintain a database and related reports. As new reporting requirements were adopted in legislation and became effective in 2011 and again revised and updated in 2016, 2019, 2022, and 2025, this report facilitates the Agency's compliance with the current state code, providing the data necessary to fulfill the Agency report requirements. The Agency has submitted all required information into the GOEO database and is providing this Annual Report for further transparency to the public and taxing entities, and to update the Agency Board on the status and activities within each project area.`;
            addTextWithPageBreaks(purposeText, 11, [0, 0, 0]);
            
            const purposeText2 = `This annual report is for informational purposes only and does not alter the amount of project area funds that the Agency is authorized to receive from each Project Area. This report is intended to provide an overview of each Project Area that lies within the boundaries of the Agency, including descriptions of each Project Area, significant activities, project timelines, actual and estimated tax increment collections, and any other information pertinent to the taxing entities.`;
            addTextWithPageBreaks(purposeText2, 11, [0, 0, 0]);
            
            // SUMMARY OF 17C-1-603 REPORTING REQUIREMENTS Section - with proper page breaks
            const pageHeight = doc.internal.pageSize.getHeight();
            const availableWidth = pageWidth - (margin * 2);
            
            // Helper function to add text with guaranteed page breaks and proper wrapping
            const addTextWithGuaranteedBreaks = (text, fontSize, color, isBold = false, indent = 0, isBullet = false) => {
                doc.setFontSize(fontSize);
                doc.setFont(undefined, isBold ? 'bold' : 'normal');
                doc.setTextColor(color[0], color[1], color[2]);
                
                // Calculate available width for text (accounting for bullet symbol if needed)
                const bulletWidth = isBullet ? doc.getTextWidth('‚Ä¢ ') : 0;
                const textWidth = availableWidth - indent - bulletWidth;
                
                const splitText = doc.splitTextToSize(text, textWidth);
                const lineHeight = fontSize * 0.4;
                const requiredHeight = splitText.length * lineHeight + 5;
                
                // Use global autoPageBreak utility
                const { yPosition: newY } = autoPageBreak(doc, yPosition, requiredHeight);
                yPosition = newY;
                
                // Add text line by line with proper bullet handling
                if (isBullet && splitText.length > 0) {
                    // First line with bullet
                    doc.text('‚Ä¢ ' + splitText[0], margin + indent, yPosition);
                    yPosition += lineHeight;
                    
                    // Remaining lines without bullet (indented)
                    for (let i = 1; i < splitText.length; i++) {
                        doc.text(splitText[i], margin + indent + bulletWidth, yPosition);
                        yPosition += lineHeight;
                    }
                } else {
                    // Regular text without bullet
                    doc.text(splitText, margin + indent, yPosition);
                    yPosition += requiredHeight;
                }
            };
            
            // Section heading
            addTextWithGuaranteedBreaks('SUMMARY OF 17C-1-603. REPORTING REQUIREMENTS ‚Äì GOVERNOR\'S OFFICE OF ECONOMIC OPPORTUNITY TO MAINTAIN A DATABASE.', 14, [14, 165, 233], true);
            
            // Introduction paragraph
            addTextWithGuaranteedBreaks(`Utah State Code 17C-1-603 sets out the annual reporting requirements for community reinvestment agencies. Under this section:`, 11, [0, 0, 0]);
            
            // Bullet points for reporting requirements
            const requirements = [
                'Agencies must submit annual reports by June 30 for each active project area, providing detailed financial and project information, such as:',
                'Amounts and estimates of project area funds received and to be received.',
                'Project budgets and analyses of receipts and expenditures.',
                'Maps of the project area and descriptions of progress toward project goals.',
                'Agencies with no active project areas must still submit a report confirming their status until the agency is dissolved.',
                'The Governor\'s Office of Economic Opportunity must maintain a public database of the submitted data and prepare an annual report for legislative review.',
                'Noncompliance can lead to financial penalties, including withholding a portion of the agency\'s tax increment funds.',
                'The report is informational and does not alter the total funds the agency is entitled to collect.'
            ];
            
            requirements.forEach(requirement => {
                addTextWithGuaranteedBreaks(requirement, 10, [0, 0, 0], false, 10, true);
            });
            
            // OVERVIEW OF AGENCY Section
            addTextWithPageBreaks('OVERVIEW OF AGENCY (CRA/CDRA/RDA)', 14, [14, 165, 233], true);
            
            const agencyText = `A Community Reinvestment Agency (CRA), Community Development and Renewal Agency (CDRA), or Redevelopment Agency (RDA) is a special local government entity established under state law (Title 17C of the Utah Code) to help communities revitalize underused, blighted, or deteriorating areas. The main goals of these agencies are to:`;
            addTextWithPageBreaks(agencyText, 11, [0, 0, 0]);
            
            // Agency goals bullet points
            const goals = [
                'Encourage private and public investment in areas that have declined or are not thriving.',
                'Eliminate blight and improve infrastructure, housing, and economic opportunities within specific project areas.',
                'Promote economic development by supporting businesses, creating jobs, and expanding the local tax base.',
                'Increase the amount and variety of affordable housing in the community.'
            ];
            
            addBulletPoints(goals, 10, [14, 165, 233], 10);
            
            const overviewText = `CRAs, CDRAs, or RDAs can use tools such as tax increment financing to fund and incentivize improvements and development. They are typically governed by the local city council or county commission, serving as the agency's board. These agencies play a key role in assembling land, improving public works (like roads and utilities), and stimulating private investment to bring new life to designated neighborhoods or business districts.`;
            addTextWithPageBreaks(overviewText, 11, [0, 0, 0]);
            
            // SUMMARY OF 17C-1-202 AGENCY POWERS Section - with proper wrapping
            addTextWithGuaranteedBreaks('SUMMARY OF 17C-1-202. AGENCY POWERS.', 14, [14, 165, 233], true);
            
            const powersIntroText = `Utah State Code 17C-1-202 outlines the powers and authorities of CRAs, CDRAs, or RDAs. This section gives agencies the following key powers:`;
            addTextWithGuaranteedBreaks(powersIntroText, 11, [0, 0, 0]);
            
            // Agency powers bullet points - with proper wrapping
            const powers = [
                'Sue and be sued, enter into contracts, and acquire or dispose of real and personal property.',
                'Undertake actions for urban renewal, economic development, or community development, such as receiving tax increment funds and financing projects within designated areas.',
                'Issue bonds for project financing and other agency purposes, including repaying advances or refunding previously issued bonds.',
                'Pay impact fees and other costs associated with land development.',
                'Enter into development agreements with individuals or entities specifying project details, funding amounts, and performance expectations; these agreements must be approved by the agency\'s board and must align with the goals of the project area plan.'
            ];
            
            powers.forEach(power => {
                addTextWithGuaranteedBreaks(power, 10, [0, 0, 0], false, 10, true);
            });
            
            // Concluding paragraph - direct approach with page breaks
            yPosition += 15; // Add space after bullet points
            
            const concludingText = `The section also allows agencies to accept financial assistance from various sources, retain controls over developed land consistent with project plans, and transact any business necessary to fulfill their mission. If acquiring property outside a project area, the agency's board must find that it benefits an existing project area. All major agreements and decisions require adoption by resolution with clear findings.`;
            
            // Check if we need a new page before adding the text
            const splitConcludingText = doc.splitTextToSize(concludingText, pageWidth - (margin * 2));
            const requiredSpace = splitConcludingText.length * 4.5 + 10;
            
            if (yPosition + requiredSpace > doc.internal.pageSize.getHeight() - 30) {
                doc.addPage();
                addReportHeader(doc, 'ANNUAL JUNE 30TH COMPLIANCE REPORT');
                addReportFooter(doc);
                yPosition = 40; // Start below header
            }
            
            // Direct text rendering - bypass all helper functions
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0, 0, 0);
            
            doc.text(splitConcludingText, margin, yPosition);
            yPosition += splitConcludingText.length * 4.5 + 10;
            
            // Add footer
            addReportFooter(doc);
        }

        function addDataSummary(doc, city, submissions, margin, startY) {
            let yPosition = startY;
            
            // Data Summary Section
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(14, 165, 233);
            doc.text('COMPREHENSIVE DATA SUMMARY', margin, yPosition);
            yPosition += 15;
            
            // Add decorative line
            doc.setDrawColor(14, 165, 233);
            doc.setLineWidth(1);
            doc.line(margin, yPosition - 5, margin + 150, yPosition - 5);
            yPosition += 10;
            
            // Calculate comprehensive statistics
            const totalAcreage = submissions.reduce((sum, s) => sum + parseFloat(s.developedAcreage || 0) + parseFloat(s.undevelopedAcreage || 0), 0);
            const totalDeveloped = submissions.reduce((sum, s) => sum + parseFloat(s.developedAcreage || 0), 0);
            const totalUndeveloped = submissions.reduce((sum, s) => sum + parseFloat(s.undevelopedAcreage || 0), 0);
            const totalResidential = submissions.reduce((sum, s) => sum + parseFloat(s.residentialAcreage || 0), 0);
            const totalHousingUnits = submissions.reduce((sum, s) => sum + parseFloat(s.authorizedHousingUnits || 0), 0);
            const totalRevenue = submissions.reduce((sum, s) => sum + parseFloat(s.currentYearRevenue || 0), 0);
            const totalExpenses = submissions.reduce((sum, s) => sum + parseFloat(s.currentYearExpense || 0), 0);
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            
            // Create summary table
            const summaryData = [
                ['Metric', 'Value'],
                ['Total Project Areas', submissions.length.toString()],
                ['Total Acreage', `${totalAcreage.toFixed(2)} acres`],
                ['Developed Acreage', `${totalDeveloped.toFixed(2)} acres`],
                ['Undeveloped Acreage', `${totalUndeveloped.toFixed(2)} acres`],
                ['Residential Acreage', `${totalResidential.toFixed(2)} acres`],
                ['Authorized Housing Units', totalHousingUnits.toString()],
                ['Current Year Revenue', `$${totalRevenue.toLocaleString()}`],
                ['Current Year Expenses', `$${totalExpenses.toLocaleString()}`],
                ['Net Revenue', `$${(totalRevenue - totalExpenses).toLocaleString()}`]
            ];
            
            try {
                doc.autoTable({
                    startY: yPosition,
                    head: [summaryData[0]],
                    body: summaryData.slice(1),
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [14, 165, 233],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    bodyStyles: { textColor: [0, 0, 0] },
                    alternateRowStyles: { fillColor: [243, 244, 246] },
                    margin: { left: margin, right: margin }
                });
            } catch (error) {
                // Fallback to text if table fails
                summaryData.slice(1).forEach(row => {
                    doc.text(`${row[0]}: ${row[1]}`, margin, yPosition);
                    yPosition += 8;
                });
            }
        }

        function addGoverningBoardSection(doc, submissions) {
            doc.addPage();
            
            const margin = 20;
            let yPosition = 30;
            
            // Add header
            addReportHeader(doc, 'ANNUAL JUNE 30TH COMPLIANCE REPORT');
            
            // GOVERNING BOARD OF TRUSTEES AND STAFF Title
            doc.setTextColor(14, 165, 233);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('GOVERNING BOARD OF TRUSTEES AND STAFF', margin, yPosition);
            yPosition += 20;
            
            // TABLE E.1 ‚Äì AGENCY GOVERNING BOARD
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(14, 165, 233);
            doc.text('TABLE E.1 ‚Äì AGENCY GOVERNING BOARD', margin, yPosition);
            yPosition += 15;
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('GOVERNING BOARD OF TRUSTEES', margin, yPosition);
            yPosition += 10;
            
            // Create comprehensive governing board table
            const boardData = [];
            boardData.push(['Name', 'Title']);
            
            // Collect governing board entries from indexed fields across submissions
            const firstSubmission = submissions[0];
            const maxRows = 50;
            for (let i = 0; i < maxRows; i++) {
                let name = '';
                let title = '';
                // Prefer the first non-empty across submissions
                for (const s of submissions) {
                    if (!name && s[`governingBoardName_${i}`]) name = s[`governingBoardName_${i}`];
                    if (!title && s[`governingBoardTitle_${i}`]) title = s[`governingBoardTitle_${i}`];
                    if (name && title) break;
                }
                if (name || title) {
                    boardData.push([name || '‚Äî', title || '‚Äî']);
                }
            }
            
            if (boardData.length > 1) {
                try {
                    doc.autoTable({
                        startY: yPosition,
                        head: [boardData[0]],
                        body: boardData.slice(1),
                        theme: 'grid',
                        headStyles: { 
                            fillColor: [14, 165, 233],
                            textColor: [255, 255, 255],
                            fontStyle: 'bold'
                        },
                        bodyStyles: { textColor: [0, 0, 0] },
                        alternateRowStyles: { fillColor: [243, 244, 246] },
                        margin: { left: margin, right: margin }
                    });
                    yPosition = doc.lastAutoTable.finalY + 20;
                } catch (error) {
                    doc.text('Governing board data not available', margin, yPosition);
                    yPosition += 20;
                }
            } else {
                doc.text('Governing board data not available', margin, yPosition);
                yPosition += 20;
            }
            
            // TABLE E.2 ‚Äì AGENCY STAFF
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(14, 165, 233);
            doc.text('TABLE E.2 ‚Äì AGENCY STAFF', margin, yPosition);
            yPosition += 15;
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('STAFF MEMBERS', margin, yPosition);
            yPosition += 10;
            
            // Create comprehensive staff table
            const staffData = [];
            staffData.push(['Name', 'Title']);
            
            // Collect staff entries from indexed fields across submissions
            for (let i = 0; i < 50; i++) {
                let name = '';
                let title = '';
                for (const s of submissions) {
                    if (!name && s[`agencyStaffName_${i}`]) name = s[`agencyStaffName_${i}`];
                    if (!title && s[`agencyStaffTitle_${i}`]) title = s[`agencyStaffTitle_${i}`];
                    if (name && title) break;
                }
                if (name || title) {
                    staffData.push([name || '‚Äî', title || '‚Äî']);
                }
            }
            
            if (staffData.length > 1) {
                try {
                doc.autoTable({
                        startY: yPosition,
                        head: [staffData[0]],
                        body: staffData.slice(1),
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [14, 165, 233],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    bodyStyles: { textColor: [0, 0, 0] },
                    alternateRowStyles: { fillColor: [243, 244, 246] },
                        margin: { left: margin, right: margin }
                    });
                    yPosition = doc.lastAutoTable.finalY + 20;
                } catch (error) {
                    doc.text('Staff data not available', margin, yPosition);
                    yPosition += 20;
                }
            } else {
                doc.text('Staff data not available', margin, yPosition);
                yPosition += 20;
            }
            
            // Add footer
            addReportFooter(doc);
        }

        function addCombinedBudgetSection(doc, submissions) {
            doc.addPage();
            
            const margin = 20;
            let yPosition = 30;
            
            // Add header
            addReportHeader(doc, 'ANNUAL JUNE 30TH COMPLIANCE REPORT');
            
            // SUMMARY OF TAX INCREMENT REVENUES AND EXPENDITURES Title
            doc.setTextColor(14, 165, 233);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('SUMMARY OF TAX INCREMENT REVENUES AND EXPENDITURES', margin, yPosition);
            yPosition += 20;
            
            // TABLE E.3 ‚Äì COMBINED AGENCY BUDGET
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(14, 165, 233);
            doc.text('TABLE E.3 ‚Äì COMBINED AGENCY BUDGET', margin, yPosition);
            yPosition += 15;
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('COMBINED TAX INCREMENT BUDGET ‚Äì AGENCY', margin, yPosition);
            yPosition += 15;
            
            // Create COMBINED TAX REVENUE table
            const revenueData = [];
            revenueData.push(['DESCRIPTION', 'CURRENT YEAR', 'NEXT YEAR PROJECTED', 'NEXT YEAR+1 PROJECTED', 'AUTHORIZED AMOUNT REMAINING']);
            
            // Add individual project area revenues
            let totalCurrent = 0, totalNext = 0, totalFollowing = 0, totalRemaining = 0;
            
            submissions.forEach((submission, index) => {
                // Use the most descriptive name available - prioritize actual project area names
                let projectArea = submission.projectAreaName || submission.projectArea;
                
                // If no project area name, use submitter name (like "Redhawks CDA")
                if (!projectArea) {
                    projectArea = submission.submitterName || submission.cityCounty;
                }
                
                // Only use generic name as absolute last resort
                if (!projectArea) {
                    projectArea = `Project Area #${index + 1}`;
                }
                
                // Get revenue data from the actual form fields
                let current = 0, next = 0, following = 0, remaining = 0;
                
                // Sum up all revenue sources for this project area
                for (let i = 0; i < 20; i++) {
                    const actual2025 = parseFloat(submission[`revenueSource2025Actual_${i}`] || 0);
                    const forecast2026 = parseFloat(submission[`revenueSource2026Forecast_${i}`] || 0);
                    const forecast2027 = parseFloat(submission[`revenueSource2027Forecast_${i}`] || 0);
                    
                    current += actual2025;
                    next += forecast2026;
                    following += forecast2027;
                }
                
                // Get remaining revenue
                remaining = parseFloat(submission.aggregateRemainingRevenue || 0);
                
                totalCurrent += current;
                totalNext += next;
                totalFollowing += following;
                totalRemaining += remaining;
                
                revenueData.push([
                    `${projectArea} - Revenue`,
                    `$${current.toLocaleString()}`,
                    `$${next.toLocaleString()}`,
                    `$${following.toLocaleString()}`,
                    `$${remaining.toLocaleString()}`
                ]);
            });
            
            // Add total revenue row
            revenueData.push([
                'TOTAL REVENUE',
                `$${totalCurrent.toLocaleString()}`,
                `$${totalNext.toLocaleString()}`,
                `$${totalFollowing.toLocaleString()}`,
                `$${totalRemaining.toLocaleString()}`
            ]);
            
            try {
                doc.autoTable({
                    startY: yPosition,
                    head: [revenueData[0]],
                    body: revenueData.slice(1),
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [14, 165, 233],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    bodyStyles: { textColor: [0, 0, 0] },
                    alternateRowStyles: { fillColor: [243, 244, 246] },
                    margin: { left: margin, right: margin }
                });
                yPosition = doc.lastAutoTable.finalY + 20;
            } catch (error) {
                doc.text('Revenue data not available', margin, yPosition);
                yPosition += 20;
            }
            
            // Add COMBINED EXPENSES table
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('COMBINED EXPENSES', margin, yPosition);
            yPosition += 15;
            
            const expenseData = [];
            expenseData.push(['DESCRIPTION', 'CURRENT YEAR', 'NEXT YEAR PROJECTED', 'NEXT YEAR+1 PROJECTED', 'AUTHORIZED AMOUNT REMAINING']);
            
            // Collect all expense types across all project areas
            const expenseTypes = new Map();
            console.log('Generating expense table for submissions:', submissions.length);
            
            submissions.forEach(submission => {
                // Get all expense fields using the actual field names
                for (let i = 0; i < 20; i++) {
                    const expenseDesc = submission[`expenseTitle_${i}`];
                    const expenseCurrent = parseFloat(submission[`tyExpense_${i}`] || 0);
                    const expenseNext = parseFloat(submission[`cyExpense_${i}`] || 0);
                    const expenseFollowing = parseFloat(submission[`nyExpense_${i}`] || 0);
                    
                    if (expenseDesc && (expenseCurrent > 0 || expenseNext > 0 || expenseFollowing > 0)) {
                        if (!expenseTypes.has(expenseDesc)) {
                            expenseTypes.set(expenseDesc, { current: 0, next: 0, following: 0, remaining: 0 });
                        }
                        const current = expenseTypes.get(expenseDesc);
                        current.current += expenseCurrent;
                        current.next += expenseNext;
                        current.following += expenseFollowing;
                    }
                }
                
                // Also get total expenses
                const totalExpense = parseFloat(submission.totalAggregateExpense || 0);
                if (totalExpense > 0) {
                    if (!expenseTypes.has('Total Expenses')) {
                        expenseTypes.set('Total Expenses', { current: 0, next: 0, following: 0, remaining: 0 });
                    }
                    const current = expenseTypes.get('Total Expenses');
                    current.current += totalExpense;
                }
            });
            
            // Add expense types to table
            expenseTypes.forEach((values, expense) => {
                expenseData.push([
                    expense,
                    `$${values.current.toLocaleString()}`,
                    `$${values.next.toLocaleString()}`,
                    `$${values.following.toLocaleString()}`,
                    `$${values.remaining.toLocaleString()}`
                ]);
            });
            
            // Add expense totals
            const totalExpenseCurrent = Array.from(expenseTypes.values()).reduce((sum, v) => sum + v.current, 0);
            const totalExpenseNext = Array.from(expenseTypes.values()).reduce((sum, v) => sum + v.next, 0);
            const totalExpenseFollowing = Array.from(expenseTypes.values()).reduce((sum, v) => sum + v.following, 0);
            const totalExpenseRemaining = Array.from(expenseTypes.values()).reduce((sum, v) => sum + v.remaining, 0);
            
            expenseData.push([
                'TOTAL EXPENSES',
                `$${totalExpenseCurrent.toLocaleString()}`,
                `$${totalExpenseNext.toLocaleString()}`,
                `$${totalExpenseFollowing.toLocaleString()}`,
                `$${totalExpenseRemaining.toLocaleString()}`
            ]);
            
            try {
                doc.autoTable({
                    startY: yPosition,
                    head: [expenseData[0]],
                    body: expenseData.slice(1),
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [14, 165, 233],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    bodyStyles: { textColor: [0, 0, 0] },
                    alternateRowStyles: { fillColor: [243, 244, 246] },
                    margin: { left: margin, right: margin }
                });
                yPosition = doc.lastAutoTable.finalY + 20;
            } catch (error) {
                doc.text('Expense data not available', margin, yPosition);
                yPosition += 20;
            }
            
            // Acreage overview section is handled separately in addAcreageOverviewSection
            
            
            // Add footer
            addReportFooter(doc);
        }

        function addAcreageOverviewSection(doc, submissions) {
            doc.addPage();
            
            const margin = 20;
            let yPosition = 30;
            
            // Title
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('GENERAL OVERVIEW OF PROJECT AREAS AND ACREAGE', margin, yPosition);
            yPosition += 20;
            
            // Acreage Table
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('TABLE E.4 ‚Äì ACREAGE (DEVELOPED, UNDEVELOPED, AND RESIDENTIAL)', margin, yPosition);
            yPosition += 10;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('ACREAGE (DEVELOPED, UNDEVELOPED, AND RESIDENTIAL)', margin, yPosition);
            yPosition += 10;
            
            // Create acreage table
            const acreageData = [];
            acreageData.push(['PROJECT AREA', 'DEVELOPED', 'UNDEVELOPED', 'RESIDENTIAL', '% RESIDENTIAL', 'AUTHORIZED HOUSING UNITS #']);
            
            let totalDeveloped = 0, totalUndeveloped = 0, totalResidential = 0, totalHousingUnits = 0;
            
            submissions.forEach((submission, index) => {
                // Use the most descriptive name available - prioritize actual project area names
                let projectArea = submission.projectAreaName || submission.projectArea;
                
                // If no project area name, use submitter name (like "Redhawks CDA")
                if (!projectArea) {
                    projectArea = submission.submitterName || submission.cityCounty;
                }
                
                // Only use generic name as absolute last resort
                if (!projectArea) {
                    projectArea = `Project Area #${index + 1}`;
                }
                const developed = parseFloat(submission.developedAcreage || 0);
                const undeveloped = parseFloat(submission.undevelopedAcreage || 0);
                const residential = parseFloat(submission.residentialAcreage || 0);
                const housingUnits = parseFloat(submission.authorizedHousingUnits || 0);
                
                const totalAcreage = developed + undeveloped;
                const residentialPercentage = totalAcreage > 0 ? ((residential / totalAcreage) * 100).toFixed(1) : '0.0';
                
                acreageData.push([
                    projectArea,
                    developed.toFixed(2),
                    undeveloped.toFixed(2),
                    residential.toFixed(2),
                    `${residentialPercentage}%`,
                    housingUnits.toString()
                ]);
                
                totalDeveloped += developed;
                totalUndeveloped += undeveloped;
                totalResidential += residential;
                totalHousingUnits += housingUnits;
            });
            
            // Add totals
            const totalAcreage = totalDeveloped + totalUndeveloped;
            const totalResidentialPercentage = totalAcreage > 0 ? ((totalResidential / totalAcreage) * 100).toFixed(1) : '0.0';
            
            acreageData.push([
                'Total',
                totalDeveloped.toFixed(2),
                totalUndeveloped.toFixed(2),
                totalResidential.toFixed(2),
                `${totalResidentialPercentage}%`,
                totalHousingUnits.toString()
            ]);
            
            try {
                doc.autoTable({
                    startY: yPosition,
                    head: [acreageData[0]],
                    body: acreageData.slice(1),
                    theme: 'grid',
                    headStyles: { fillColor: [14, 165, 233], textColor: [255,255,255] },
                    bodyStyles: { textColor: [0, 0, 0] },
                    margin: { left: margin, right: margin }
                });
            } catch (error) {
                doc.text('Acreage data not available', margin, yPosition);
            }
        }

        function addIndividualProjectSections(doc, submissions) {
            submissions.forEach((submission, index) => {
                const projectNumber = index + 1;
                
                // PROJECT AREA HEADER PAGE
                addProjectAreaHeader(doc, projectNumber, submission);
                
                // PROJECT AREA OVERVIEW PAGE
                addProjectAreaOverview(doc, submission, projectNumber);
                
                // FUND ACCOUNTABILITY PAGE
                addFundAccountability(doc, submission, projectNumber);
                
                // PROJECT AREA DEVELOPMENT PAGE
                addProjectAreaDevelopment(doc, submission, projectNumber);
                
                // PROJECT AREA MAP PAGE
                addProjectAreaMap(doc, projectNumber);
            });
        }

        function addProjectAreaHeader(doc, projectNumber, submission) {
            doc.addPage();
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            
            // Black background
            doc.setFillColor(0, 0, 0);
            doc.rect(0, 0, pageWidth, pageHeight, 'F');
            
            // Get the actual project area name
            let projectArea = submission.projectAreaName || submission.projectArea;
            
            // If no project area name, use submitter name (like "Redhawks CDA")
            if (!projectArea) {
                projectArea = submission.submitterName || submission.cityCounty;
            }
            
            // Only use generic name as absolute last resort
            if (!projectArea) {
                projectArea = `Project Area #${projectNumber}`;
            }
            
            // Blue text centered
            doc.setTextColor(14, 165, 233);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text(projectArea.toUpperCase(), pageWidth / 2, pageHeight / 2 - 10, { align: 'center' });
            
            // Gray underline
            doc.setDrawColor(211, 211, 211);
            doc.setLineWidth(2);
            const lineWidth = pageWidth * 0.8;
            const lineX = (pageWidth - lineWidth) / 2;
            const lineY = pageHeight / 2 + 15;
            doc.line(lineX, lineY, lineX + lineWidth, lineY);
        }

        function addProjectAreaOverview(doc, submission, projectNumber) {
            doc.addPage();
            
            const margin = 20;
            const pageWidth = doc.internal.pageSize.getWidth();
            let yPosition = 30;
            
            // Add header
            addReportHeader(doc, 'ANNUAL JUNE 30TH COMPLIANCE REPORT');
            
            // Main title - use actual project area name
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            
            // Get the actual project area name
            let projectArea = submission.projectAreaName || submission.projectArea;
            
            // If no project area name, use submitter name (like "Redhawks CDA")
            if (!projectArea) {
                projectArea = submission.submitterName || submission.cityCounty;
            }
            
            // Only use generic name as absolute last resort
            if (!projectArea) {
                projectArea = `Project Area #${projectNumber}`;
            }
            
            doc.text(projectArea.toUpperCase(), margin, yPosition - 8);
            yPosition -= 6; // Move line up by 5mm
            
            // Add black horizontal line under the title (0.5mm thick)
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.5);
            doc.line(margin, yPosition, pageWidth - margin, yPosition);
            yPosition += 14; // Space after line
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('OVERVIEW OF PROJECT AREA', margin, yPosition + 5); // Move down 5mm
            yPosition += 25; // Increased spacing to account for the move
            
            // TABLE 1 - OVERVIEW OF PROJECT AREA
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(136, 136, 136); // Medium light gray
            doc.text('TABLE 1 ‚Äì OVERVIEW OF PROJECT AREA', margin, yPosition + 5); // Move 5mm down
            yPosition += 10; // Reduced spacing
            
            // Reset text color to black for table content
            doc.setTextColor(0, 0, 0);
            
            // Create comprehensive overview table
            const overviewData = [];
            
            // Section 1: General Info
            overviewData.push(['TYPE', 'ACREAGE', 'OVERVIEW PURPOSE', 'TAXING DISTRICT', 'TAX RATE 2024']);
            const type = submission.projectType || 'RDA';
            const acreage = parseFloat(submission.developedAcreage || 0) + parseFloat(submission.undevelopedAcreage || 0);
            const purpose = submission.projectPurpose || 'Commercial Development';
            const taxingDistrict = submission.taxingDistrict || '55A';
            const taxRate = submission.taxRate2024 || '0.008925';
            
            overviewData.push([type, acreage.toFixed(2), purpose, taxingDistrict, taxRate]);
            
            // Section 2: Project Area Funds Collection Period
            overviewData.push(['PROJECT AREA FUNDS COLLECTION PERIOD', '', '', '', '']);
            overviewData.push(['CREATION YEAR', 'BASE YEAR', 'TERM', 'START YEAR', 'EXPIRATION YEAR']);
            const creationYear = submission.creationYear || '1989';
            const baseYear = submission.baseYear || '1989';
            const term = submission.term || '32 Years';
            const startYear = submission.startYear || 'FY 1994';
            const expirationYear = submission.expirationYear || 'FY 2025';
            
            overviewData.push([creationYear, baseYear, term, startYear, expirationYear]);
            
            // Section 3: Financial Metrics
            overviewData.push(['BASE TAXABLE VALUE', 'CURRENT TAXABLE VALUE', 'ASSESSED VALUE INCREASE (%)', 'CURRENT YEAR TAX INCREMENT', 'REMAINING LIFE']);
            const baseValue = parseFloat(submission.baseTaxableValue || 609648);
            const currentValue = parseFloat(submission.currentTaxableValue || 138913478);
            const increasePercent = ((currentValue - baseValue) / baseValue * 100).toFixed(0);
            const currentIncrement = parseFloat(submission.currentYearRevenue || 623751);
            const remainingLife = submission.remainingLife || '0 Years';
            
            overviewData.push([
                `$${baseValue.toLocaleString()}`,
                `$${currentValue.toLocaleString()}`,
                `${increasePercent}%`,
                `$${currentIncrement.toLocaleString()}`,
                remainingLife
            ]);
            
            try {
                doc.autoTable({
                    startY: yPosition,
                    head: [overviewData[0]],
                    body: overviewData.slice(1),
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [14, 165, 233],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    bodyStyles: { textColor: [0, 0, 0] },
                    alternateRowStyles: { fillColor: [243, 244, 246] },
                    margin: { left: margin, right: margin }
                });
                yPosition = doc.lastAutoTable.finalY + 20;
            } catch (error) {
                doc.text('Overview data not available', margin, yPosition);
                yPosition += 20;
            }
            
            // Add narrative text
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const narrativeText = `The "CRA" was created in ${creationYear} with a base year of "${baseYear}", with a value of "$${baseValue.toLocaleString()}". Since that time, the assessed value of the project area has increased to "$${currentValue.toLocaleString()}". This has been a growth of over "${increasePercent}%" in assessed value. The growth is thanks to developments in a new tech headquarters...`;
            
            const splitText = doc.splitTextToSize(narrativeText, 170);
            doc.text(splitText, margin, yPosition);
            yPosition += splitText.length * 5 + 15;
            
            // Add bullet points
            const bulletPoints = [
                'Including: Number of residential units, amount of sqft of commercial, industrial, and institutional development, number of jobs, and any other economic strength indicators within the project area.',
                'Named recent developments (developments that have made progress)',
                'THIS SECTION SHOULD BE A BRIEF OVERVIEW OF THE REPORT.'
            ];
            
            bulletPoints.forEach(point => {
                doc.text(`‚Ä¢ ${point}`, margin + 10, yPosition);
                yPosition += 8;
            });
            
            yPosition += 15;
            
            // Add interlocal agreements text
            const interlocalText = 'Interlocal Cooperation Agreements or Interlocal Agreements are agreements made between the Agency and taxing entities, which permit the Agency to collect all or a portion of the property tax increment generated by the project area. Table 2 below summarizes the terms and conditions of each interlocal agreement.';
            
            const splitInterlocalText = doc.splitTextToSize(interlocalText, 170);
            doc.text(splitInterlocalText, margin, yPosition);
            yPosition += splitInterlocalText.length * 5 + 15;
            
            // TABLE 2 - SUMMARY OF INTERLOCAL AGREEMENTS
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(136, 136, 136); // Medium light gray
            doc.text('TABLE 2 ‚Äì SUMMARY OF INTERLOCAL AGREEMENTS', margin, yPosition + 5); // Move 5mm down
            yPosition += 10; // Reduced spacing
            
            // Reset text color to black for table content
            doc.setTextColor(0, 0, 0);
            
            const interlocalData = [];
            interlocalData.push(['INTERLOCAL AGREEMENT SUMMARY', '', '', '', '']);
            interlocalData.push(['ENTITY', '% OF TAX INCREMENT', 'REMITTANCE', 'CAP AMOUNTS', 'LENGTH']);
            
            // Add interlocal agreement data
            const entities = [
                { name: 'Salt Lake County', percent: '70%', remittance: '-%', cap: '$-', length: '12 Years' },
                { name: 'Canyons School District', percent: '75%', remittance: '-', cap: '-', length: '12 Years' },
                { name: 'Draper City', percent: '75%', remittance: '-', cap: '-', length: '' },
                { name: 'South Salt Lake Mosquito Abatement District', percent: '75%', remittance: '-', cap: '-', length: '' },
                { name: 'Jordan Valley Water Conservancy District', percent: '75%', remittance: '-', cap: '-', length: '' },
                { name: 'South Valley Sewer District', percent: '75%', remittance: '-', cap: '-', length: '' },
                { name: 'Central Utah Water Conservancy District', percent: '70%', remittance: '-', cap: '-', length: '' },
                { name: 'Salt Lake County Library', percent: '70%', remittance: '-', cap: '-', length: '' }
            ];
            
            entities.forEach(entity => {
                interlocalData.push([entity.name, entity.percent, entity.remittance, entity.cap, entity.length]);
            });
            
            interlocalData.push(['Total', '-%', '$-', '', '']);
            
            try {
                doc.autoTable({
                    startY: yPosition,
                    head: [interlocalData[0]],
                    body: interlocalData.slice(1),
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [14, 165, 233],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    bodyStyles: { textColor: [0, 0, 0] },
                    alternateRowStyles: { fillColor: [243, 244, 246] },
                    margin: { left: margin, right: margin }
                });
            } catch (error) {
                doc.text('Interlocal agreement data not available', margin, yPosition);
            }
            
            // Add footer
            addReportFooter(doc);
        }

        function addFundAccountability(doc, submission, projectNumber) {
            doc.addPage();
            
            const margin = 20;
            let yPosition = 45; // Moved down 15mm from 30
            
            // Add header
            addReportHeader(doc, 'ANNUAL JUNE 30TH COMPLIANCE REPORT');
            
            // TABLE 3 - SOURCES OF FUNDS
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(136, 136, 136); // Medium light gray
            doc.text('TABLE 3 ‚Äì SOURCES OF FUNDS', margin, yPosition + 5); // Move 5mm down
            
            // FUND ACCOUNTABILITY - positioned 5mm above TABLE 3
            doc.text('FUND ACCOUNTABILITY', margin, yPosition - 5); // 5mm above TABLE 3
            yPosition += 10; // Reduced spacing
            
            // Reset text color to black for table content
            doc.setTextColor(0, 0, 0);
            
            const sourcesData = [];
            sourcesData.push(['2025 SOURCES OF FUNDS', '2026 FORECASTED', '2027 FORECASTED']);
            sourcesData.push(['2025 ACTUAL', '2026 FORECASTED', '2027 FORECASTED']);
            
            const propTax2025 = parseFloat(submission.propertyTax2025 || submission.currentYearRevenue || 4116081);
            const propTax2026 = parseFloat(submission.propertyTax2026 || submission.nextYearRevenue || 4200000);
            const propTax2027 = parseFloat(submission.propertyTax2027 || submission.followingYearRevenue || 4400000);
            
            sourcesData.push([
                `$${propTax2025.toLocaleString()}`,
                `$${propTax2026.toLocaleString()}`,
                `$${propTax2027.toLocaleString()}`
            ]);
            sourcesData.push(['Property Tax Increment', '', '']);
            sourcesData.push([
                `$${propTax2025.toLocaleString()}`,
                '',
                ''
            ]);
            sourcesData.push(['Total Sources of Funds', '', '']);
            
            try {
                doc.autoTable({
                    startY: yPosition,
                    head: [sourcesData[0]],
                    body: sourcesData.slice(1),
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [14, 165, 233],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    bodyStyles: { textColor: [0, 0, 0] },
                    alternateRowStyles: { fillColor: [243, 244, 246] },
                    margin: { left: margin, right: margin }
                });
                yPosition = doc.lastAutoTable.finalY + 20;
            } catch (error) {
                doc.text('Sources of funds data not available', margin, yPosition);
                yPosition += 20;
            }
            
            // Add footer
            addReportFooter(doc);
        }

        function addProjectAreaDevelopment(doc, submission, projectNumber) {
            doc.addPage();
            
            const margin = 20;
            let yPosition = 40; // Moved down 10mm from 30
            
            // Add header
            addReportHeader(doc, 'ANNUAL JUNE 30TH COMPLIANCE REPORT');
            
            // Main title
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('PROJECT AREA DEVELOPMENT', margin, yPosition);
            yPosition += 15;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('Mentioning of development of the project area. Acreage both developed and undeveloped, etc.', margin, yPosition);
            yPosition += 20;
            
            // TABLE 8 - ACREAGE
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(136, 136, 136); // Medium light gray
            doc.text('TABLE 8 ‚Äì ACREAGE', margin, yPosition + 5); // Move 5mm down
            yPosition += 10; // Reduced spacing
            
            // Reset text color to black for table content
            doc.setTextColor(0, 0, 0);
            
            const acreageData = [];
            acreageData.push(['ACREAGE (DEVELOPED, UNDEVELOPED, AND RESIDENTIAL)', '', '', '', '']);
            acreageData.push(['DEVELOPED', 'UNDEVELOPED', 'RESIDENTIAL', '% RESIDENTIAL', 'AUTHORIZED HOUSING UNITS #']);
            
            const developed = parseFloat(submission.developedAcreage || 232.08);
            const undeveloped = parseFloat(submission.undevelopedAcreage || 67.05);
            const residential = parseFloat(submission.residentialAcreage || 39.67);
            const housingUnits = parseFloat(submission.authorizedHousingUnits || 400);
            const totalAcreage = developed + undeveloped;
            const residentialPercent = totalAcreage > 0 ? ((residential / totalAcreage) * 100).toFixed(1) : '0.0';
            
            acreageData.push([
                developed.toFixed(2),
                undeveloped.toFixed(2),
                residential.toFixed(2),
                `${residentialPercent}%`,
                housingUnits.toString()
            ]);
            
            try {
                doc.autoTable({
                    startY: yPosition,
                    head: [acreageData[0]],
                    body: acreageData.slice(1),
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [14, 165, 233],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    bodyStyles: { textColor: [0, 0, 0] },
                    alternateRowStyles: { fillColor: [243, 244, 246] },
                    margin: { left: margin, right: margin }
                });
                yPosition = doc.lastAutoTable.finalY + 20;
            } catch (error) {
                doc.text('Acreage data not available', margin, yPosition);
                yPosition += 20;
            }
            
            // Add development narrative
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('This project area has had 20,000 square feet of commercial development. In addition to this, the following businesses have opened:', margin, yPosition);
            yPosition += 15;
            
            const businesses = ['Jimmy John\'s', 'Johnny Jim\'s', 'Jersey Mikes', 'Mikey Jerse\'s'];
            businesses.forEach(business => {
                doc.text(`‚Ä¢ ${business}`, margin + 10, yPosition);
                yPosition += 8;
            });
            
            yPosition += 20;
            
            // PROGRESS PURSUANT TO PLAN
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('PROGRESS PURSUANT TO PLAN', margin, yPosition);
            yPosition += 15;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('The plan outlined the.... The plan has been furthered through the...', margin, yPosition);
            yPosition += 20;
            
            // OTHER ISSUES
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('OTHER ISSUES', margin, yPosition);
            yPosition += 15;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('Any other issues worth mentioning...', margin, yPosition);
            
            // Add footer
            addReportFooter(doc);
        }

        function addProjectAreaMap(doc, projectNumber) {
            doc.addPage();
            
            const margin = 20;
            let yPosition = 30;
            
            // Add header
            addReportHeader(doc, 'ANNUAL JUNE 30TH COMPLIANCE REPORT');
            
            // Main title
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('PROJECT AREA MAP', margin, yPosition);
            yPosition += 20;
            
            // Add placeholder text
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('[Project Area Map Placeholder]', margin, yPosition);
            
            // Add footer
            addReportFooter(doc);
        }

        function addReportHeader(doc, title) {
            const pageWidth = doc.internal.pageSize.getWidth();
            
            // Add header background (site blue)
            doc.setFillColor(14, 165, 233);
            doc.rect(0, 0, pageWidth, 30, 'F');
            
            // No text in header - just the blue bar
        }

        function addReportFooter(doc) {
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            
            // Add footer background
            doc.setFillColor(14, 165, 233);
            doc.rect(0, pageHeight - 30, pageWidth, 30, 'F');
            
            // Add footer content
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            
            // Page number
            doc.text(`Page ${doc.internal.getNumberOfPages()}`, 20, pageHeight - 10);
            
            // Company info
            doc.text('LRB PUBLIC FINANCE ADVISORS | 41 NORTH RIO GRANDE, SUITE 101 | SALT LAKE CITY, UT 84101', pageWidth / 2, pageHeight - 10, { align: 'center' });

            // Logo only appears on cover page (removed from footer)
        }

        /**
         * Automatic page break utility function
         * Checks if content will fit on current page, adds new page if needed
         * @param {jsPDF} doc - The jsPDF document instance
         * @param {number} yPosition - Current Y position
         * @param {number} requiredSpace - Space needed for the content in mm/points
         * @param {number} bottomMargin - Bottom margin to maintain (default: 30)
         * @param {boolean} addHeaderFooter - Whether to add header/footer on new page (default: true)
         * @param {string} headerText - Optional header text for continuation pages
         * @returns {object} - Returns object with {yPosition, pageAdded}
         */
        function autoPageBreak(doc, yPosition, requiredSpace, bottomMargin = 30, addHeaderFooter = true, headerText = 'ANNUAL JUNE 30TH COMPLIANCE REPORT') {
            const pageHeight = doc.internal.pageSize.getHeight();
            let pageAdded = false;
            
            // Check if we need a new page
            if (yPosition + requiredSpace > pageHeight - bottomMargin) {
                doc.addPage();
                pageAdded = true;
                
                if (addHeaderFooter) {
                    addReportHeader(doc, headerText);
                    addReportFooter(doc);
                }
                
                // Reset y position below header (header takes ~30-40 units)
                yPosition = 40;
            }
            
            return { yPosition, pageAdded };
        }

        /**
         * Add text with automatic page breaks
         * @param {jsPDF} doc - The jsPDF document instance
         * @param {string} text - Text to add
         * @param {number} fontSize - Font size
         * @param {number} x - X position
         * @param {number} yPosition - Current Y position
         * @param {object} options - Options object
         * @returns {number} - New Y position after text
         */
        function addTextAutoBreak(doc, text, fontSize, x, yPosition, options = {}) {
            const {
                maxWidth = doc.internal.pageSize.getWidth() - (x * 2),
                lineHeight = fontSize * 0.4,
                color = [0, 0, 0],
                isBold = false,
                bottomMargin = 30,
                headerText = 'ANNUAL JUNE 30TH COMPLIANCE REPORT'
            } = options;
            
            doc.setFontSize(fontSize);
            doc.setFont(undefined, isBold ? 'bold' : 'normal');
            doc.setTextColor(color[0], color[1], color[2]);
            
            // Split text to fit width
            const splitText = doc.splitTextToSize(text, maxWidth);
            const requiredHeight = splitText.length * lineHeight + 10;
            
            // Check for page break
            const { yPosition: currentY } = autoPageBreak(doc, yPosition, requiredHeight, bottomMargin, true, headerText);
            
            // Add text
            doc.text(splitText, x, currentY);
            
            // Update y position
            return currentY + splitText.length * lineHeight + 10;
        }

        function generateTaxIncrementTableData(submissions) {
            const data = [];
            let totalCurrent = 0, totalNext = 0, totalFollowing = 0, totalAuthorized = 0;

            submissions.forEach(submission => {
                const projectArea = submission.projectArea || submission.projectAreaName || 'N/A';
                
                // Revenue data
                const currentRevenue = parseFloat(submission.currentYearRevenue || 0);
                const nextRevenue = parseFloat(submission.nextYearRevenue || 0);
                const followingRevenue = parseFloat(submission.followingYearRevenue || 0);
                const authorizedRevenue = parseFloat(submission.authorizedRevenueRemaining || 0);
                
                if (currentRevenue > 0 || nextRevenue > 0 || followingRevenue > 0 || authorizedRevenue > 0) {
                    data.push([
                        `${projectArea} - Revenue`,
                        `$${currentRevenue.toLocaleString()}`,
                        `$${nextRevenue.toLocaleString()}`,
                        `$${followingRevenue.toLocaleString()}`,
                        `$${authorizedRevenue.toLocaleString()}`
                    ]);
                    totalCurrent += currentRevenue;
                    totalNext += nextRevenue;
                    totalFollowing += followingRevenue;
                    totalAuthorized += authorizedRevenue;
                }

                // Expense data
                const currentExpense = parseFloat(submission.currentYearExpense || 0);
                const nextExpense = parseFloat(submission.nextYearExpense || 0);
                const followingExpense = parseFloat(submission.followingYearExpense || 0);
                const authorizedExpense = parseFloat(submission.authorizedExpenseRemaining || 0);
                
                if (currentExpense > 0 || nextExpense > 0 || followingExpense > 0 || authorizedExpense > 0) {
                    data.push([
                        `${projectArea} - Expenses`,
                        `$${currentExpense.toLocaleString()}`,
                        `$${nextExpense.toLocaleString()}`,
                        `$${followingExpense.toLocaleString()}`,
                        `$${authorizedExpense.toLocaleString()}`
                    ]);
                    totalCurrent += currentExpense;
                    totalNext += nextExpense;
                    totalFollowing += followingExpense;
                    totalAuthorized += authorizedExpense;
                }
            });

            // Add totals row
            if (data.length > 0) {
                data.push([
                    'TOTAL',
                    `$${totalCurrent.toLocaleString()}`,
                    `$${totalNext.toLocaleString()}`,
                    `$${totalFollowing.toLocaleString()}`,
                    `$${totalAuthorized.toLocaleString()}`
                ]);
            }

            return data;
        }

        function generateAcreageTableData(submissions) {
            const data = [];
            let totalDeveloped = 0, totalUndeveloped = 0, totalResidential = 0, totalHousingUnits = 0;

            submissions.forEach(submission => {
                const projectArea = submission.projectArea || submission.projectAreaName || 'N/A';
                const developed = parseFloat(submission.developedAcreage || 0);
                const undeveloped = parseFloat(submission.undevelopedAcreage || 0);
                const residential = parseFloat(submission.residentialAcreage || 0);
                const housingUnits = parseFloat(submission.authorizedHousingUnits || 0);
                
                const totalAcreage = developed + undeveloped;
                const residentialPercentage = totalAcreage > 0 ? ((residential / totalAcreage) * 100).toFixed(1) : '0.0';

                data.push([
                    projectArea,
                    developed.toFixed(2),
                    undeveloped.toFixed(2),
                    residential.toFixed(2),
                    `${residentialPercentage}%`,
                    housingUnits.toString()
                ]);

                totalDeveloped += developed;
                totalUndeveloped += undeveloped;
                totalResidential += residential;
                totalHousingUnits += housingUnits;
            });

            // Add totals row
            if (data.length > 0) {
                const totalAcreage = totalDeveloped + totalUndeveloped;
                const totalResidentialPercentage = totalAcreage > 0 ? ((totalResidential / totalAcreage) * 100).toFixed(1) : '0.0';
                
                data.push([
                    'TOTAL',
                    totalDeveloped.toFixed(2),
                    totalUndeveloped.toFixed(2),
                    totalResidential.toFixed(2),
                    `${totalResidentialPercentage}%`,
                    totalHousingUnits.toString()
                ]);
            }

            return data;
        }

        function generateRevenueTableData(submissions) {
            const data = [];
            const revenueSources = new Map();

            submissions.forEach(submission => {
                // Collect revenue sources from various fields
                const sources = [
                    { name: 'Property Tax', actual: submission.propertyTax2025, forecast2026: submission.propertyTax2026, forecast2027: submission.propertyTax2027 },
                    { name: 'Sales Tax', actual: submission.salesTax2025, forecast2026: submission.salesTax2026, forecast2027: submission.salesTax2027 },
                    { name: 'Income Tax', actual: submission.incomeTax2025, forecast2026: submission.incomeTax2026, forecast2027: submission.incomeTax2027 },
                    { name: 'Other Revenue', actual: submission.otherRevenue2025, forecast2026: submission.otherRevenue2026, forecast2027: submission.otherRevenue2027 }
                ];

                sources.forEach(source => {
                    if (source.actual || source.forecast2026 || source.forecast2027) {
                        if (!revenueSources.has(source.name)) {
                            revenueSources.set(source.name, { actual: 0, forecast2026: 0, forecast2027: 0 });
                        }
                        const current = revenueSources.get(source.name);
                        current.actual += parseFloat(source.actual || 0);
                        current.forecast2026 += parseFloat(source.forecast2026 || 0);
                        current.forecast2027 += parseFloat(source.forecast2027 || 0);
                    }
                });
            });

            // Convert to array format
            revenueSources.forEach((values, name) => {
                if (values.actual > 0 || values.forecast2026 > 0 || values.forecast2027 > 0) {
                    data.push([
                        name,
                        `$${values.actual.toLocaleString()}`,
                        `$${values.forecast2026.toLocaleString()}`,
                        `$${values.forecast2027.toLocaleString()}`
                    ]);
                }
            });

            return data;
        }

        function showNotification(message) {
            try {
                const notification = document.getElementById('notification');
                if (notification) {
                    notification.textContent = message;
                    notification.style.display = 'block';
                    setTimeout(() => {
                        notification.style.display = 'none';
                    }, 3000);
                } else {
                    console.warn('Notification element not found, using alert instead');
                    alert(message);
                }
            } catch (error) {
                console.error('Error showing notification:', error);
                alert(message);
            }
        }
        
        // Test function to verify forms are working
        function testFormSubmission() {
            console.log('Testing form submission...');
            const externalForm = document.getElementById('project-form');
            const internalForm = document.getElementById('internal-data-request-form');
            
            console.log('External form found:', !!externalForm);
            console.log('Internal form found:', !!internalForm);
            
            if (externalForm) {
                console.log('External form submit handler:', typeof externalForm.onsubmit);
                const externalSubmitBtn = externalForm.querySelector('button[type="submit"]');
                console.log('External submit button found:', !!externalSubmitBtn);
                if (externalSubmitBtn) {
                    console.log('External submit button text:', externalSubmitBtn.textContent);
                    console.log('External submit button disabled:', externalSubmitBtn.disabled);
                }
            }
            if (internalForm) {
                console.log('Internal form submit handler:', typeof internalForm.onsubmit);
                const internalSubmitBtn = internalForm.querySelector('button[type="submit"]');
                console.log('Internal submit button found:', !!internalSubmitBtn);
                if (internalSubmitBtn) {
                    console.log('Internal submit button text:', internalSubmitBtn.textContent);
                    console.log('Internal submit button disabled:', internalSubmitBtn.disabled);
                }
            }
        }
        
        // Manual test function - call this from console to test
        function manualTestSubmit() {
            console.log('Manual test: triggering external form submit');
            const externalForm = document.getElementById('project-form');
            if (externalForm) {
                externalForm.dispatchEvent(new Event('submit'));
            }
        }

        function formatNumberWithCommas(input) {
            // Only format if there's actually a number
            if (!input.value || input.value.trim() === '') return;
            
            // Get the raw value without commas
            let rawValue = input.value.replace(/,/g, '');
            
            // Only proceed if it's a valid number
            if (isNaN(parseFloat(rawValue))) return;
            
            // Format with commas - simple approach
            const num = parseFloat(rawValue);
            const formatted = num.toLocaleString('en-US');
            
            // Only update if the formatting is different
            if (formatted !== input.value) {
                input.value = formatted;
            }
        }

        function removeCommas(input) {
            // Remove commas when user clicks in to edit
            if (input.value && input.value.includes(',')) {
                input.value = input.value.replace(/,/g, '');
            }
        }

        function setupNumberFormatting() {
            // Select all number inputs that should have comma formatting
            // Exclude year fields and percentage fields
            const numberInputs = document.querySelectorAll('input[type="number"]:not([name*="year"]):not([name*="Year"]):not([name*="percentage"]):not([name*="Percentage"]):not([name*="rate"]):not([name*="Rate"]):not([min="0"][max="100"])');
            
            numberInputs.forEach(input => {
                // Change input type to text to avoid browser interference
                input.type = 'text';
                input.pattern = '[0-9,]*';
                
                // Format on blur (when user clicks out)
                input.addEventListener('blur', function() {
                    formatNumberWithCommas(this);
                });
                
                // Remove commas on focus (when user clicks in)
                input.addEventListener('focus', function() {
                    removeCommas(this);
                });
            });
        }

        function setupPercentageFormatting() {
            // Select all percentage inputs
            const percentageInputs = document.querySelectorAll('input[type="number"][name*="percentage"], input[type="number"][name*="Percentage"], input[type="number"][name*="rate"], input[type="number"][name*="Rate"], input[type="number"][min="0"][max="100"]');
            
            percentageInputs.forEach(input => {
                // Change input type to text to avoid browser interference
                input.type = 'text';
                input.pattern = '[0-9.]*';
                // Format on blur (when user clicks out)
                input.addEventListener('blur', function() {
                    formatPercentage(this);
                });
                
                // Remove % on focus (when user clicks in)
                input.addEventListener('focus', function() {
                    removePercentage(this);
                });
            });
        }

        function formatPercentage(input) {
            if (!input.value || input.value.trim() === '') return;
            
            // Remove any existing % and get the raw number
            let rawValue = input.value.replace(/%/g, '');
            
            // Only proceed if it's a valid number
            if (isNaN(parseFloat(rawValue))) return;
            
            // Add % symbol
            const num = parseFloat(rawValue);
            const formatted = num + '%';
            
            // Only update if the formatting is different
            if (formatted !== input.value) {
                input.value = formatted;
            }
        }

        function removePercentage(input) {
            // Remove % symbol when user clicks in
            if (input.value && input.value.includes('%')) {
                input.value = input.value.replace(/%/g, '');
            }
        }
    </script>
</body>
</html> 